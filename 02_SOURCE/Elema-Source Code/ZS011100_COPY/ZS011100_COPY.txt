************************************************************************
* [ƒvƒƒOƒ‰ƒ€–¼]
*   ZS011100    ”„ã‘e—˜—\ZÀÑ—\’è•\
*
* [ˆ—ŠT—v]
*   ”„ã‘e—˜‚Ì—\ZÀÑŠÇ—‚ğs‚¤B
*   w’è‚³‚ê‚½ˆ—”NŒ‚ÆŠú‰Œ‚©‚ç‚Ì—İŒv‚Ì”„ãA‘e—˜‚Ì—\ZAÀÑA—\’è‚ğ
*   ’ •[o—Í‚·‚éB
*
* [‰ü’è—š—ğ]
*@YYYY/MM/DD   Programar         Description
*  2001/12/18   PSD k.igarashi    V‹KŠJ”­@
*  2002/01/08   PSD k.igarashi    d—l•ÏX
*  2002/02/06   PSD M.Arai        ‡ŒvŒë·C³‘Î‰
*  2002/03/19   PSD T.SAITOH      ALVƒXƒe[ƒ^ƒXˆóü‹‘”Ûİ’è
*  2002/06/20   PSD T.SAITOH      ÄˆÚ‘—
*  2002/08/10   PSD T.SAITOH
*                        255‚ğ“Ë”j‚µ‚Ä‚¢‚é‚½‚ß³í‚Éˆóü‚Å‚«‚È‚¢ƒoƒOC³
*  2002/09/14   PSD T.SAITOH      ”„ã—\ZA”„ã—\’èA‘e—˜—\ZA‘e—˜—\’è
*                               ‚ÍŸŒ‚ğ•\¦‚·‚éyTDd—l•ÏXz
*  2004/10/13   DMC murata      Êß×Ò°À‚ÉÊŞ°¼Ş®İ‚ğ’Ç‰Á
************************************************************************
report  zs011100.

************************************************************************
* TYPES
************************************************************************
type-pools slis.

* ‡@ ‚k‚h‚r“à•”‚s‚a‚kŒ^
types: begin of typ_lis,
vrsio      type s901-vrsio,                        "ƒo[ƒWƒ‡ƒ“
spmon      type s901-spmon,                            "•ªÍŒ
vkbur      type s901-vkbur,                            "‰c‹ÆŠ
netwr      type s901-netwr,                            "³–¡Šz
zzaraigaku type s901-zzaraigaku,                     "‘e—˜‹àŠz
end of typ_lis.

* ‡A ‰c‹ÆŠ“à•”‚s‚a‚kŒ^
types: begin of typ_eigyousho,
vkbur type tvkbt-vkbur,                               "‰c‹ÆŠ
bezei type tvkbt-bezei,                              "ƒeƒLƒXƒg
end of typ_eigyousho.

************************************************************************
* DATA
************************************************************************
* ‡@ ‚k‚h‚r“à•”‚s‚a‚k
data: gf_lis type typ_lis,
gt_lis like table of gf_lis.
* ‡A ‰c‹ÆŠ“à•”‚s‚a‚k
data: gf_eigyousho type typ_eigyousho,
gt_eigyousho like table of gf_eigyousho.
* ‡B ’ •[o—Í—p“à•”‚s‚a‚k
data: gf_write like zslist_v12,
gt_write like table of gf_write.

*--- DATA
data: g_yosanver like s901-vrsio,                   "—\Zg—pƒo[ƒWƒ‡ƒ“
g_yoteiver like s901-vrsio,                   "—\’èg—pƒo[ƒWƒ‡ƒ“
g_kishogetsu(6) type n,                                   "Šú‰Œ
g_vkbur    like gf_lis-vkbur.                             "‰c‹ÆŠ
* ÀÑ
data: g_turijsk(13) type p decimals 2,                      "”„ã(“–Œ)
g_tarajsk(13) type p decimals 2,                      "‘e—˜(“–Œ)
g_rurijsk(13) type p decimals 2,                      "”„ã(—İŒv)
g_rarajsk(13) type p decimals 2.                      "”„ã(—İŒv)
* —\Z
data: g_turiysn(13) type p decimals 2,                      "”„ã(“–Œ)
g_taraysn(13) type p decimals 2,                      "‘e—˜(“–Œ)
g_ruriysn(13) type p decimals 2,                      "”„ã(—İŒv)
g_raraysn(13) type p decimals 2.                      "”„ã(—İŒv)
*---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
* ”„ãiŸŒj
data: g_budget_next(13) type p decimals 2,"”„ãiŸŒj
g_profit_next(13) type p decimals 2."‘e—˜iŸŒj
*---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*
* —\’è
data: g_uriyti(13) type p decimals 2,                             "”„ã
g_arayti(13) type p decimals 2.                             "‘e—˜

*---APPEND START PSD T.SAITOH 2002/09/14 ---------------------------*
* +1ƒ–Œ‚µ‚½”NŒ@Ši”[—p
data: g_spmon like s901-spmon.
*---APPEND END   PSD T.SAITOH 2002/09/14 ---------------------------*

************************************************************************
* ƒŠƒXƒgƒrƒ…[ƒAŠÖ˜A
************************************************************************
data: g_repid     like sy-repid,                            "ƒŒƒ|[ƒgID
gf_layout   type slis_layout_alv,                 "ƒŒƒCƒAƒEƒg\‘¢
gf_fildcat type slis_fieldcat_alv.        "ƒtƒB[ƒ‹ƒhƒJƒ^ƒƒO\‘¢

* REUSE_ALV_COMMENTARY_WRITE
data: gf_head_alv   type slis_listheader,                   "ƒwƒbƒ_\‘¢
gt_t_head_alv type slis_t_listheader.            "ƒwƒbƒ_—p“à•”TBL

* ABAPƒŠƒXƒgƒrƒ…[ƒAƒwƒbƒ_ƒf[ƒ^•Û
data: gf_header_data like gf_write.                    "ƒwƒbƒ_•\¦î•ñ

* REUSE_ALV_LIST_DISPLAY
data: top_of_page type slis_formname value 'TOP_OF_PAGE'.

* REUSE_ALV_EVENT
data: gt_event type slis_t_event,                  "ƒCƒxƒ“ƒgî•ñ“à•”TBL
gs_event like line of gt_event.                 "ƒCƒxƒ“ƒgî•ñ\‘¢

* «APPEND 2002/02/06 PSD M.Arai ‡ŒvŒë·C³‘Î‰
************************************************************************
* ALV ‡ŒvŒë·‘Î‰ŠÖ˜A
************************************************************************
data: wk_pos        type p value 1,
ctr_total_num type i,
ctr_total     type i,
wk_value      type p,
wk_sum(16)    type p,
wk_avg(16)    type p,
wk_max(16)    type p,
wk_min(16)    type p,
g_line        type sy-linno,
g_tabline     type i.

data: g_zuriysn(12)   type p,  "”„ã—\Z
g_zurijsk(12)   type p,  "”„ãÀÑ
g_zaraysn(12)   type p,  "‘e—˜—\Z
g_zarajsk(12)   type p,  "‘e—˜ÀÑ
g_zuriyti(12)   type p,  "”„ã—\’è
g_zarayti(12)   type p,  "‘e—˜—\’è
g_zuruiysn(12)  type p,  "”„ã—İŒv—\Z
g_zuruijsk(12)  type p,  "”„ã—İŒvÀÑ
g_zaruiysn(12)  type p,  "‘e—˜—İŒv—\Z
g_zaruijsk(12)  type p.  "‘e—˜—İŒvÀÑ

data: wk_layout                    type slis_layout_alv,
wk_fieldcat                  type slis_t_fieldcat_alv,
h_fieldcat                   like line of wk_fieldcat,
wk_sort                      type slis_t_sortinfo_alv,
h_sort                       like line of wk_sort,
wk_filter                    type slis_t_filter_alv,
wk_list_scrooll              type slis_list_scroll,
wk_variant                   like disvariant,
wk_width                     type int4,
wk_marked_columns            type slis_t_fieldcat_alv,
wk_filtered_entries          type slis_t_filtered_entries,
wk_filtered_entries_header   type slis_t_filtered_entries,
wk_filtered_entries_item     type slis_t_filtered_entries
.
* ªAPPEND 2002/02/06 PSD M.Arai ‡ŒvŒë·C³‘Î‰
*---APPEND START PSD T.SAITOH 2002/03/19 ALVƒXƒe[ƒ^ƒXˆóü‹‘”Ûİ’è----*
data: gf_print      type slis_print_alv.
*---APPEND END   PSD T.SAITOH 2002/03/19 ---------------------------*
************************************************************************
* CONSTANTS
************************************************************************
constants: cns_001(3) type n value '001',
cns_002(3) type n value '901',
cns_003(1) type c value 'J',
cns_004(4) type c value '1000',
cns_005(3) type c value '000',
cns_006(5) type c value 'Page:'.
constants: cns_tbl_001(5) type c value 'TVKBT',
cns_tbl_002(4) type c value 'S901'.
constants: cns_top(11) type c value 'TOP_OF_PAGE',
cns_frm_top(15) type c value 'FRM_TOP_OF_PAGE'.
************************************************************************
* ‘I‘ğ‰æ–Ê
************************************************************************
selection-screen begin of line.
selection-screen comment (10) text-006.
* ƒ‰ƒWƒIƒ{ƒ^ƒ“(”NŠÔ)
selection-screen position 22.
parameters r_nenkan radiobutton group rd_1.
selection-screen comment (4) text-007.
* ƒ‰ƒWƒIƒ{ƒ^ƒ“(ŠúŠÔ)
selection-screen position 32.
parameters r_kikan radiobutton group rd_1.
selection-screen comment (4) text-008.
selection-screen end of line.

*----------------------------------------------------------------------*
* 2002/01/08  d—l•ÏX(ˆ—”NŒQÆƒf[ƒ^Œ^•ÏX) k.igarashi start
*----------------------------------------------------------------------*
** ˆ—”NŒ
*SELECTION-SCREEN BEGIN OF LINE.
*  SELECTION-SCREEN COMMENT (8) text-001.
*  SELECTION-SCREEN POSITION 22.
*  PARAMETERS P_DATUM(6) TYPE N DEFAULT SY-DATUM+0(6).
*SELECTION-SCREEN END OF LINE.

* ˆ—”NŒ
selection-screen begin of line.
selection-screen comment (8) text-001.
selection-screen position 22.
parameters p_datum like s901-spmon default sy-datum+0(6).
selection-screen end of line.

* 2004/10/13 mod>>
parameters : p_vrsio  like s901-vrsio obligatory.    "ÊŞ°¼Ş®İ
* 2004/10/13 mod<<

*----------------------------------------------------------------------*
* 2002/01/08  d—l•ÏX(ˆ—”NŒQÆƒf[ƒ^Œ^•ÏX) k.igarashi end
*----------------------------------------------------------------------*

************************************************************************
* AT SELECTION-SCREEN
************************************************************************
at selection-screen.

* “ü—ÍŒãˆ—
perform frm_check_date.

************************************************************************
* START-OF-SELECTION
************************************************************************
start-of-selection.

* “ü—ÍŒãˆ—
perform frm_check_date.
* 2-2 ‘ÎÛƒf[ƒ^’Šoˆ—
perform frm_sel_data.
* 2-3 ’ •[o—Í—p“à•”‚s‚a‚kì¬ˆ—
perform frm_make_table.
* 2-4 ’ •[o—Íˆ—
perform frm_write_table.

*&---------------------------------------------------------------------*
*&      Form  frm_check_date
*&---------------------------------------------------------------------*
*       “ü—ÍŒãˆ—
*----------------------------------------------------------------------*
form frm_check_date.

* ‡@ ˆ—”NŒƒGƒ‰[ˆ—
if ( p_datum+4(2) > 0 ) and ( p_datum+4(2) < 13 ).
else.
message e009(z1) with text-001.
endif.

* ‡A Šú‰Œ‚Ìİ’è
g_kishogetsu = p_datum.

case 'X'.
when r_nenkan.
if ( 4 =< p_datum+4(2) and p_datum+4(2) =< 12 ).
g_kishogetsu+4(2) = 4.
elseif ( 1 =< p_datum+4(2) and p_datum+4(2) =< 3 ).
g_kishogetsu+0(4) = g_kishogetsu+0(4) - 1.
g_kishogetsu+4(2) = 4.
endif.
when r_kikan.
if ( 4 =< p_datum+4(2) and p_datum+4(2) =< 9 ).
g_kishogetsu+4(2) = 4.
elseif ( 10 =< p_datum+4(2) and p_datum+4(2) =< 12 ).
g_kishogetsu+4(2) = 10.
elseif ( 1 =< p_datum+4(2) and p_datum+4(2) =< 3 ).
g_kishogetsu+0(4) = g_kishogetsu+0(4) - 1.
g_kishogetsu+4(2) = 10.
endif.
endcase.

* ‡B —\ZA—\’èg—pƒo[ƒWƒ‡ƒ“‚Ìİ’è
g_yosanver = cns_001.
g_yoteiver = cns_002.

endform.                    " frm_check_date
*&---------------------------------------------------------------------*
*&      Form  frm_sel_data
*&---------------------------------------------------------------------*
*       2-2 ‘ÎÛƒf[ƒ^’Šoˆ—
*----------------------------------------------------------------------*
form frm_sel_data.

* ‡@ ‰c‹ÆŠ’Šoˆ—
perform frm_sel_eigyousho.

* ‡A ‚k‚h‚rî•ñ(—\Z¥ÀÑ¥—\’è)
perform frm_sel_lis.

* ‡B ƒ\[ƒgˆ—
sort gt_lis ascending by vkbur.

endform.                    " frm_sel_data
*&---------------------------------------------------------------------*
*&      Form  frm_make_table
*&---------------------------------------------------------------------*
*       2-3 ’ •[o—Í—p“à•”‚s‚a‚kì¬ˆ—
*----------------------------------------------------------------------*
form frm_make_table.

* ‚k‚h‚r“à•”‚s‚a‚kƒ‹[ƒvŠJn
loop at gt_lis into gf_lis.

* ˆês–Ú‚Ìê‡
case sy-tabix.
when 1.
g_vkbur = gf_lis-vkbur.
endcase.

* ‘O‰ñƒ‹[ƒvˆ—s‚ÆŒ»s‚Æ‚Ì”äŠr
*--- ‡@ ’ •[o—Í“à•”‚s‚a‚kƒŒƒR[ƒh’Ç‰Áˆ—
if gf_lis-vkbur <> g_vkbur.
perform frm_set_data.
endif.

case gf_lis-vrsio.
*--- ‡A ÀÑƒf[ƒ^İ’è
when cns_005." = '000'
perform frm_set_jisseki.
*--- ‡B —\Zƒf[ƒ^İ’è
* 2004/10/13 mod>>
when p_vrsio.                               " ‘I‘ğ‰æ–Ê‚ÌÊŞ°¼Ş®İ‚ğİ
*    when cns_001." = '001'
* 2004/10/13 mod<<
perform frm_set_yosan.
*--- ‡C —\’èƒf[ƒ^İ’è
when cns_002." = '901'
perform frm_set_yotei.
endcase.

* Ÿ‰ñƒ‹[ƒv”äŠr—p‰c‹ÆŠ
g_vkbur = gf_lis-vkbur.

endloop.

* ƒ‹[ƒvI—¹Œã‚Ì’Ç‰Áˆ—
perform frm_set_data.

endform.                    " frm_make_table
*&---------------------------------------------------------------------*
*&      Form  frm_write_table
*&---------------------------------------------------------------------*
*       2-4 ’ •[o—Íˆ—
*----------------------------------------------------------------------*
form frm_write_table.

* ‚`‚k‚u‰üƒy[ƒWŠÖ˜Aˆ—
perform frm_alv_page_next.

* ‰Šúİ’è
g_repid = sy-repid.

* ƒy[ƒWØ‚è‘Ö‚¦İ’è
gf_layout-group_change_edit = 'X'.

*----------------------------------------------------------------------*
* 2002/01/10 C³(‡Œvs‚Ìs–¼ÌC³)  PSD k.igarashi  start
*----------------------------------------------------------------------*
gf_layout-totals_text = '‘SĞ‡Œv'.
*----------------------------------------------------------------------*
* 2002/01/10 C³(‡Œvs‚Ìs–¼ÌC³)  PSD k.igarashi  end
*----------------------------------------------------------------------*
*---APPEND START PSD T.SAITOH 2002/03/19 ALVƒXƒe[ƒ^ƒXˆóü‹‘”Ûİ’è---*
gf_print-no_print_listinfos = 'X'.
*---APPEND END   PSD T.SAITOH 2002/03/19 ---------------------------*

* ƒŠƒXƒg‚Ìo—Í
call function 'REUSE_ALV_LIST_DISPLAY'
exporting
i_callback_program             = g_repid               "ƒŒƒ|[ƒgID
i_structure_name               = 'ZSLIST_V12'                "\‘¢
is_layout                      = gf_layout         "ƒŒƒCƒAƒEƒgİ’è
*     IT_FIELDCAT                    = GF_FILDCAT    "ƒtƒB[ƒ‹ƒhƒJƒ^ƒƒO
i_save                         = 'A'               "ƒŒƒCƒAƒEƒg•Û‘¶
it_events                      = gt_event[]          "ƒCƒxƒ“ƒgİ’è
*---APPEND START PSD T.SAITOH 2002/03/19 ALVƒXƒe[ƒ^ƒXˆóü‹‘”Ûİ’è---*
is_print                       = gf_print      "ˆóüİ’è
*---APPEND END   PSD T.SAITOH 2002/03/19 ---------------------------*
tables
t_outtab                       = gt_write.

endform.                    " frm_write_table
*&---------------------------------------------------------------------*
*&      Form  frm_sel_eigyousho
*&---------------------------------------------------------------------*
*       2-2-‡@ ‰c‹ÆŠ’Šoˆ—
*----------------------------------------------------------------------*
form frm_sel_eigyousho.

select * from tvkbt
into corresponding fields of table gt_eigyousho
where spras = cns_003.

case sy-subrc.
when 0.
when 4.
message s600(z1) with text-002.
stop.
when 8.
message a603(z1) with sy-repid cns_tbl_001 sy-subrc.
endcase.

endform.                    " frm_sel_eigyousho
*&---------------------------------------------------------------------*
*&      Form  frm_sel_lis
*&---------------------------------------------------------------------*
*       2-2-‡A ‚k‚h‚rî•ñ(—\Z¥ÀÑ¥—\’è)
*----------------------------------------------------------------------*
form frm_sel_lis.

*---MODIFY START PSD T.SAITOH 2002/09/14 ---------------------------*
* SELECT * FROM S901
*   INTO CORRESPONDING FIELDS OF TABLE GT_LIS
** MODIFY PSD K.ARAI 2002/05/29
*   WHERE ( VRSIO  = CNS_005    OR
*           VRSIO  = G_YOSANVER OR
*           VRSIO  = G_YOTEIVER )
*    AND  SPMON >= G_KISHOGETSU
*    AND  SPMON <= P_DATUM
*    AND  VKORG  = CNS_004.

* {‚Pƒ–Œ‚µ‚½”NŒ‚ğZo
perform frm_mon_plus_one using p_datum
changing g_spmon.

select * from s901
into corresponding fields of table gt_lis
where ( vrsio  = '000'
and  spmon >= g_kishogetsu
and  spmon <= p_datum
and  vkorg  = '1000' )
* 2004/10/13 mod>>
or  ( vrsio  in (p_vrsio,'901') "ŸŒ‚Ìî•ñ‚Ü‚Åİ’è
*     or  ( vrsio  in ('001','901') "ŸŒ‚Ìî•ñ‚Ü‚Åİ’è
* 2004/10/13 mod<<
and  spmon >= g_kishogetsu
and  spmon <= g_spmon
and  vkorg  = '1000' )
.

*---MODIFY END   PSD T.SAITOH 2002/09/14 ---------------------------*


* ªb’èğŒB
* «SSOUR ‚ªŒÅ’è‚ÅƒXƒy[ƒX‚ÌŠm”F‚ª‚Æ‚ê‚½‚ç‚±‚Á‚¿‚ÉC³‚·‚é
*@ÅVƒ\[ƒXi—\’èj
*   WHERE SSOUR    = SPACE
*    AND  ( VRSIO  = CNS_005    OR
*           VRSIO  = G_YOSANVER OR
*           VRSIO  = G_YOTEIVER )
*    AND  SPMON >= G_KISHOGETSU
*    AND  SPMON <= P_DATUM
*    AND  VKORG  = CNS_004.
* «ƒpƒtƒH[ƒ}ƒ“ƒX‚ğl—¶‚µ‚ÄíœBğŒ‚ğƒL[‡‚É‚·‚é
*  Œ³‚Ìƒ\[ƒX‚Å‚·
*   WHERE SPMON >= G_KISHOGETSU
*    AND  SPMON <= P_DATUM
*    AND  VKORG  = CNS_004
*    AND  ( VRSIO  = CNS_005    OR
*           VRSIO  = G_YOSANVER OR
*           VRSIO  = G_YOTEIVER ).
* MODIFY END

case sy-subrc.
when 0.
when 4.
message s600(z1) with text-003.
stop.
when 8.
message a603(z1) with sy-repid cns_tbl_002 sy-subrc.
endcase.

endform.                    " frm_sel_lis
*&---------------------------------------------------------------------*
*&      Form  frm_set_data
*&---------------------------------------------------------------------*
*       2-3-‡@ ’ •[o—Í“à•”‚s‚a‚kƒŒƒR[ƒh’Ç‰Áˆ—
*----------------------------------------------------------------------*
form frm_set_data.

* a) ‰c‹ÆŠ–¼İ’èˆ—
read table gt_eigyousho with key vkbur = g_vkbur
into gf_eigyousho.

case sy-subrc.
when 0.
gf_write-vkbur = gf_eigyousho-vkbur.
gf_write-bezei = gf_eigyousho-bezei.
when 4.
gf_write-vkbur = gf_eigyousho-vkbur.
gf_write-bezei = ' '.
endcase.

* b) ÀÑA—\ZA—\’è‚Ì”„ãŠzA‘e—˜Šz‚Ìİ’è
gf_write-zuriysn = g_turiysn / 10.                         "”„ã—\Z
gf_write-zurijsk = g_turijsk / 10.                         "”„ãÀÑ
gf_write-zaraysn = g_taraysn / 10.                         "‘e—˜—\Z
gf_write-zarajsk = g_tarajsk / 10.                         "‘e—˜ÀÑ
*---MODIFY START PSD T.SAITOH 2002/09/17 ---------------------------*
* GF_WRITE-ZURIYSN2 = G_TURIYSN / 10.                       "”„ã—\Z
gf_write-zuriysn2 = g_budget_next / 10.             "”„ã—\ZiŸŒj
*---MODIFY END   PSD T.SAITOH 2002/09/17 ---------------------------*
gf_write-zuriyti  = g_uriyti / 10.                         "”„ã—\’è
*---MODIFY START PSD T.SAITOH 2002/09/17 ---------------------------*
* GF_WRITE-ZARAYSN2 = G_TARAYSN / 10.                        "‘e—˜—\Z
gf_write-zaraysn2 = g_profit_next / 10.             "‘e—˜—\ZiŸŒj
*---MODIFY END   PSD T.SAITOH 2002/09/17 ---------------------------*
gf_write-zarayti  = g_arayti / 10.                         "‘e—˜—\’è
gf_write-zuruiysn = g_ruriysn / 10.                    "”„ã—İŒv—\Z
gf_write-zuruijsk = g_rurijsk / 10.                    "”„ã—İŒvÀÑ
gf_write-zaruiysn = g_raraysn / 10.                    "‘e—˜—İŒv—\Z
gf_write-zaruijsk = g_rarajsk / 10.                    "‘e—˜—İŒvÀÑ

* «APPEND 2002/01/18 PSD M.Arai ‡Œvs‘Î‰
gf_write-zuriysn_r  = g_turiysn * 100.         "”„ã—\Z(Àƒf[ƒ^)
gf_write-zurijsk_r  = g_turijsk * 100.         "”„ã—\Z(Àƒf[ƒ^)
gf_write-zaraysn_r  = g_taraysn * 100.         "‘e—˜—\Z(Àƒf[ƒ^)
gf_write-zarajsk_r  = g_tarajsk * 100.         "‘e—˜ÀÑ(Àƒf[ƒ^)
gf_write-zuriyti_r  = g_uriyti  * 100.         "”„ã—\’è(Àƒf[ƒ^)
gf_write-zarayti_r  = g_arayti  * 100.         "‘e—˜—\’è(Àƒf[ƒ^)
gf_write-zuruiysn_r = g_ruriysn * 100.         "”„ã—İŒv—\Z(Àƒf[ƒ^)
gf_write-zuruijsk_r = g_rurijsk * 100.         "”„ã—İŒvÀÑ(Àƒf[ƒ^)
gf_write-zaruiysn_r = g_raraysn * 100.         "‘e—˜—İŒv—\Z
gf_write-zaruijsk_r = g_rarajsk * 100.         "‘e—˜—İŒvÀÑ
* ªAPPEND 2002/01/18 PSD M.Arai ‡Œvs‘Î‰
*---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
* ”„ã—\ZA‘e—˜—\ZiŸŒjÀƒf[ƒ^
gf_write-budget_next_r = g_budget_next * 100.
gf_write-profit_next_r = g_profit_next * 100.
*---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*

* c) ’B¬—¦(”„ã)‚Ìİ’è
if g_turiysn = 0.
gf_write-zuriper = 0.
elseif g_turiysn <> 0.
gf_write-zuriper = ( g_turijsk / g_turiysn ) * 100.
endif.

* d) ‘e—˜—¦(—\Z¥‘e—˜—\Z”ä)‚Ìİ’è
if g_turiysn = 0.
gf_write-zaysnper = 0.
elseif g_turiysn <> 0.
gf_write-zaysnper = ( g_taraysn / g_turiysn ) * 100.
endif.

* e) ‘e—˜—¦(ÀÑ)‚Ìİ’è
if g_turijsk = 0.
gf_write-zajskper = 0.
elseif g_turijsk <> 0.
gf_write-zajskper = ( g_tarajsk / g_turijsk ) * 100.
endif.

* f) ”„ã—İŒv’B¬—¦‚Ìİ’è
if g_ruriysn = 0.
gf_write-zuritassei = 0.
elseif g_ruriysn <> 0.
gf_write-zuritassei = ( g_rurijsk / g_ruriysn ) * 100.
endif.

* g) ‘e—˜—İŒv’B¬—¦‚Ìİ’è
if g_raraysn = 0.
gf_write-zaratassei = 0.
elseif g_raraysn <> 0.
gf_write-zaratassei = ( g_rarajsk / g_raraysn ) * 100.
endif.

* h) ”„ã—\Z”ä‚Ìİ’è
if g_turiysn = 0.
gf_write-zuriysnhi = 0.
elseif g_turiysn <> 0.
gf_write-zuriysnhi = ( g_uriyti / g_turiysn ) * 100.
endif.

*----------------------------------------------------------------------*
* 2002/01/08 d—l•ÏX(‚OœZƒ`ƒFƒbƒN’Ç‰Á) K.Igarashi start
*----------------------------------------------------------------------*
** i) —\’è‘e—˜—¦‚Ìİ’è
* GF_WRITE-ZAYTIPER = ( G_ARAYTI / G_URIYTI ) * 100.

** j) ‘e—˜—\Z”ä‚Ìİ’è
* GF_WRITE-ZARAYSNHI = ( G_ARAYTI / G_TARAYSN ) * 100.

* i) —\’è‘e—˜—¦‚Ìİ’è
if g_uriyti = 0.
gf_write-zaytiper = 0.
elseif g_uriyti <> 0.
gf_write-zaytiper = ( g_arayti / g_uriyti ) * 100.
endif.

* j) ‘e—˜—\Z”ä‚Ìİ’è
if g_taraysn = 0.
gf_write-zaraysnhi = 0.
elseif g_taraysn <> 0.
gf_write-zaraysnhi = ( g_arayti / g_taraysn ) * 100.
endif.
*----------------------------------------------------------------------*
* 2002/01/08 d—l•ÏX(‚OœZƒ`ƒFƒbƒN’Ç‰Á) K.Igarashi end
*----------------------------------------------------------------------*

* ƒŒƒR[ƒh’Ç‰Áˆ—
append gf_write to gt_write.

* ‰Šú‰»ˆ—
clear gf_write.
clear: g_turijsk, g_tarajsk, g_rurijsk, g_rarajsk, g_turiysn,
g_taraysn, g_ruriysn, g_raraysn, g_uriyti, g_arayti.
*---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
* ’Ç‰Á‚µ‚½•Ï”‚Ì‰Šú‰»
clear: g_budget_next, g_profit_next.
*---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*

endform.                    " frm_set_data
*&---------------------------------------------------------------------*
*&      Form  frm_set_jisseki
*&---------------------------------------------------------------------*
*       2-3-‡A ÀÑƒf[ƒ^İ’è
*----------------------------------------------------------------------*
form frm_set_jisseki.

* a) “–Œî•ñ‚Ìİ’èˆ—
if gf_lis-spmon = p_datum.
*--- ±) ”„ãÀÑ(“–Œ)‚Ìİ’è
g_turijsk = g_turijsk + gf_lis-netwr.
*--- ²) ‘e—˜ÀÑ(“–Œ)‚Ìİ’è
g_tarajsk = g_tarajsk + gf_lis-zzaraigaku.
endif.

*---APPEND START PSD T.SAITOH 2002/09/14 ---------------------------*
* ŸŒ‚Í—İŒv‚µ‚È‚¢
if gf_lis-spmon = g_spmon.
exit.
endif.
*---APPEND END   PSD T.SAITOH 2002/09/14 ---------------------------*

* b) —İŒvî•ñ‚Ìİ’èˆ—
*--- ±) ”„ãÀÑ(—İŒv)‚Ìİ’è
g_rurijsk = g_rurijsk + gf_lis-netwr.
*--- ²) ‘e—˜ÀÑ(—İŒv)‚Ìİ’è
g_rarajsk = g_rarajsk + gf_lis-zzaraigaku.

endform.                    " frm_set_jisseki
*&---------------------------------------------------------------------*
*&      Form  frm_set_yosan
*&---------------------------------------------------------------------*
*       2-3-‡B —\Zƒf[ƒ^İ’è
*----------------------------------------------------------------------*
form frm_set_yosan.

* a) “–Œî•ñ‚Ìİ’è
if gf_lis-spmon = p_datum.
*--- ±) ”„ã—\Z(“–Œ)‚Ìİ’è
g_turiysn = g_turiysn + gf_lis-netwr.
*--- ²) ‘e—˜—\Z(“–Œ)‚Ìİ’è
g_taraysn = g_taraysn + gf_lis-zzaraigaku.
endif.

*---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
*   ŸŒî•ñ‚Ìİ’è
if gf_lis-spmon = g_spmon.
g_budget_next = g_budget_next + gf_lis-netwr.     "”„ã—\ZiŸŒj
g_profit_next = g_profit_next + gf_lis-zzaraigaku."‘e—˜—\ZiŸŒj
endif.
*---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*



*---APPEND START PSD T.SAITOH 2002/09/14 ---------------------------*
* ŸŒ‚Í—İŒv‚µ‚È‚¢
if gf_lis-spmon = g_spmon.
exit.
endif.
*---APPEND END   PSD T.SAITOH 2002/09/14 ---------------------------*

* b) —İŒvî•ñ‚Ìİ’è
*--- ±) ”„ã—\Z(—İŒv)‚Ìİ’è
g_ruriysn = g_ruriysn + gf_lis-netwr.
*--- ²) ‘e—˜—\Z(—İŒv)‚Ìİ’è
g_raraysn = g_raraysn + gf_lis-zzaraigaku.

endform.                    " frm_set_yosan
*&---------------------------------------------------------------------*
*&      Form  frm_set_yotei
*&---------------------------------------------------------------------*
*       2-3-‡C —\’èƒf[ƒ^İ’è
*----------------------------------------------------------------------*
form frm_set_yotei.

*---MODIFY START PSD T.SAITOH 2002/09/14 ---------------------------*
* a) “–Œî•ñ‚Ìİ’è¨d—l•ÏX¨ŸŒî•ñ‚Ìİ’è
* IF GF_LIS-SPMON = P_DATUM.
if gf_lis-spmon = g_spmon.
*---MODIFY END   PSD T.SAITOH 2002/09/14 ---------------------------*
*--- ±) ”„ã—\’è‚Ìİ’è
g_uriyti = g_uriyti + gf_lis-netwr.
*--- ²) ‘e—˜—\’è‚Ìİ’è
g_arayti = g_arayti + gf_lis-zzaraigaku.
endif.

endform.                    " frm_set_yotei
*&---------------------------------------------------------------------*
*&      Form  frm_alv_page_next
*&---------------------------------------------------------------------*
*       ‚`‚k‚u‰üƒy[ƒWŠÖ˜Aˆ—
*----------------------------------------------------------------------*
form frm_alv_page_next.

* g—p‰Â”\ƒCƒxƒ“ƒg‚Ìƒ`ƒFƒbƒN
call function 'REUSE_ALV_EVENTS_GET'
exporting
i_list_type           = 0
importing
et_events             = gt_event          "g—p‰Â”\‚ÈƒCƒxƒ“ƒgæ“¾
exceptions
list_type_wrong       = 1
others                = 2.

if sy-subrc <> 0.
*  MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*          WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
endif.

* g—pƒCƒxƒ“ƒg‚ÉÀs‚·‚éƒTƒuƒ‹[ƒ`ƒ“–¼‚ğİ’è
loop at gt_event into gs_event.
case gs_event-name.
when cns_top.
gs_event-form = cns_frm_top.                     "FRM_TOP_OF_PAGE
modify gt_event from gs_event.
* ŒÂ•ÊGUIƒXƒe[ƒ^ƒXg—p‚ÍƒRƒƒ“ƒgƒAƒEƒg‚·‚é‚±‚Æ
*     WHEN 'PF_STATUS_SET'.
*       GS_EVENT-FORM = 'FRM_SET_STATUS'.
*       MODIFY GT_EVENT FROM GS_EVENT.
when 'END_OF_LIST'.
gs_event-form = 'FRM_END_OF_LIST'.
modify gt_event from gs_event.
endcase.
endloop.

endform.                    " frm_alv_page_next
*&---------------------------------------------------------------------*
*&      Form  TOP_OF_PAGE
*&---------------------------------------------------------------------*
form frm_top_of_page.

data: l_shorinengetu(10) type c,
l_sy_datum(8) type c,
l_version(4) type c.

* ’ •[ƒo[ƒWƒ‡ƒ“‚Ìİ’è
case 'X'.
when r_nenkan.
l_version = text-007.
when r_kikan.
if ( 4 =< p_datum+4(2) and p_datum+4(2) =< 9 ).
l_version = text-009.
elseif ( 1 =< p_datum+4(2) and p_datum+4(2) =< 3 ).
l_version = text-010.
elseif ( 10 =< p_datum+4(2) and p_datum+4(2) =< 12 ).
l_version = text-010.
endif.
endcase.

* ˆ—”NŒ‚Ì•ÒW
concatenate p_datum+2(2)
'”N'
p_datum+4(2)
'Œ'
into l_shorinengetu.

* ƒVƒXƒeƒ€“ú•t‚Ì•ÒW
concatenate sy-datum+2(2)
'/'
sy-datum+4(2)
'/'
sy-datum+6(2)
into l_sy_datum.

*----------------------------------------------------------------------*
* 2002/01/08  d—l•ÏX(ƒy[ƒW”Ô†’Ç‰Á)  k.igarashi start
*----------------------------------------------------------------------*
** ƒwƒbƒ_‘‚«o‚µˆ—
* WRITE: 70 L_VERSION,
*        80 L_SHORINENGETU,
*        95 text-004,
*        240 L_SY_DATUM,
*        /260 text-005.

* ƒwƒbƒ_‘‚«o‚µˆ—
write: 70 l_version,
80 l_shorinengetu,
95 text-004,
*---MODIFY START PSD T.SAITOH 2002/08/10 ---------------------------*
* 255‚ğ“Ë”j‚µ‚Ä‚¢‚é‚½‚ß³í‚Éˆóü‚Å‚«‚È‚¢ƒoƒOC³
*        250 L_SY_DATUM,
*        260 CNS_006,
*        265 SY-PAGNO,
*        /260 text-005.
245 l_sy_datum,
/245 text-005.
*---MODIFY END   PSD T.SAITOH 2002/08/10 ---------------------------*
*----------------------------------------------------------------------*
* 2002/01/08  d—l•ÏX(ƒy[ƒW”Ô†’Ç‰Á)  k.igarashi  end
*----------------------------------------------------------------------*

endform.

* «APPEND 2002/02/06 PSD.M.Arai ‡ŒvŒë·C³‘Î‰
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_STATUS
*&---------------------------------------------------------------------*
*       ALVŒÂ•ÊGUIƒXƒe[ƒ^ƒXİ’è(–¢g—p)
*----------------------------------------------------------------------*
*FORM FRM_SET_STATUS USING rt_extab TYPE slis_t_extab.
*DATA: WK_UCOMM   TYPE SY-UCOMM,
*      ITAB_UCOMM LIKE TABLE OF WK_UCOMM.
*
*  SET PF-STATUS 'ZS011100_TEST' EXCLUDING ITAB_UCOMM.
*ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  FRM_END_OF_LIST
*&---------------------------------------------------------------------*
*       ‡Œvsİ’èˆ—
*----------------------------------------------------------------------*
form frm_end_of_list.

* ‡Œvso—Í‰Šú‰»ˆ—
perform frm_init_total.

* ALVİ’è“à—eæ“¾
call function 'REUSE_ALV_LIST_LAYOUT_INFO_GET'
importing
es_layout                        = wk_layout
et_fieldcat                      = wk_fieldcat
et_sort                          = wk_sort
et_filter                        = wk_filter
es_list_scroll                   = wk_list_scrooll
es_variant                       = wk_variant
e_width                          = wk_width
et_marked_columns                = wk_marked_columns
et_filtered_entries              = wk_filtered_entries
et_filtered_entries_header       = wk_filtered_entries_header
et_filtered_entries_item         = wk_filtered_entries_item
exceptions
no_infos                         = 1
program_error                    = 2
others                           = 3
.
if sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
endif.

* ‡Œv€–Ú‚ÌWŒv
loop at gt_write into gf_write.
g_zuriysn  = g_zuriysn  + gf_write-zuriysn_r.  "”„ã—\Z
g_zurijsk  = g_zurijsk  + gf_write-zurijsk_r.  "”„ãÀÑ
g_zaraysn  = g_zaraysn  + gf_write-zaraysn_r.  "‘e—˜—\Z
g_zarajsk  = g_zarajsk  + gf_write-zarajsk_r.  "‘e—˜ÀÑ
g_zuriyti  = g_zuriyti  + gf_write-zuriyti_r.  "”„ã—\’è
g_zarayti  = g_zarayti  + gf_write-zarayti_r.  "‘e—˜—\’è
g_zuruiysn = g_zuruiysn + gf_write-zuruiysn_r. "”„ã—İŒv—\Z
g_zuruijsk = g_zuruijsk + gf_write-zuruijsk_r. "”„ã—İŒvÀÑ
g_zaruiysn = g_zaruiysn + gf_write-zaruiysn_r. "‘e—˜—İŒv—\Z
g_zaruijsk = g_zaruijsk + gf_write-zaruijsk_r. "‘e—˜—İŒvÀÑ
*---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
*   ”„ã—\ZA‘e—˜—\ZiŸŒj
g_budget_next = g_budget_next + gf_write-budget_next_r.
g_profit_next = g_profit_next + gf_write-profit_next_r.
*---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*
endloop .

* o—Í“à•”TBL‚ÌƒŒƒR[ƒhæ“¾
describe table gt_write lines g_tabline.

* ‘‡Œvs‚Ì—L–³ƒ`ƒFƒbƒN
loop at wk_fieldcat into h_fieldcat
where do_sum = 'X'      "‡Œv
or    do_sum = 'C'      "•½‹Ï
or    do_sum = 'A'      "Å‘å
or    do_sum = 'B'.     "Å¬

ctr_total     = 1.
ctr_total_num = ctr_total.

* ¬Œvs”‚Ìæ“¾
loop at wk_sort into h_sort
where subtot = 'X'.
ctr_total_num = ctr_total_num + 1.
endloop.

exit.

endloop.

format color col_total on.

* ‡Œv•\¦İ’è‚Ì‚İ•\¦
if ctr_total <= 0.
exit.
endif.

* æ“ª—ñ”‚Ìİ’è
g_line = sy-linno - 1.
skip to line g_line.

wk_pos = wk_pos + 1.
do ctr_total_num times.
wk_pos = wk_pos + 1.
enddo.

* •\¦€–Ú‚Ì‚İˆ—
loop at wk_fieldcat into h_fieldcat
where no_out <> 'X'.

clear wk_value.
case h_fieldcat-fieldname.
when 'ZURIYSN'  or
'ZURIJSK'  or
'ZARAYSN'  or
'ZARAJSK'  or
'ZURUIJSK' or
'ZARUIJSK' or
'ZURIYTI'  or
'ZARAYTI'  or
'ZURUIYSN' or
'ZARUIYSN'
**---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
*           OR 'ZURIYSN2'
*           OR 'ZARAYSN2'
**---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*
.
perform frm_alv_total using h_fieldcat-fieldname
''.
when 'ZURIYSN2'.

*---MODIFY START PSD T.SAITOH 2002/09/17 ---------------------------*
*        PERFORM FRM_ALV_TOTAL USING H_FIELDCAT-FIELDNAME
*                                    'ZURIYSN'.
perform frm_alv_total using  'BUDGET_NEXT'
''.
*---MODIFY END   PSD T.SAITOH 2002/09/17 ---------------------------*
when 'ZARAYSN2'.
*---MODIFY START PSD T.SAITOH 2002/09/17 ---------------------------*
*        PERFORM FRM_ALV_TOTAL USING H_FIELDCAT-FIELDNAME
*                                    'ZARAYSN'.
perform frm_alv_total using 'PROFIT_NEXT'
''.
*---MODIFY END   PSD T.SAITOH 2002/09/17 ---------------------------*

when others.
wk_pos = wk_pos + h_fieldcat-outputlen.
wk_pos = wk_pos + 1.

endcase.

endloop.

format color off.

endform.
*&---------------------------------------------------------------------*
*&      Form  FRM_ALV_TOTAL
*&---------------------------------------------------------------------*
*       ‡Œvo—Í
*----------------------------------------------------------------------*
form frm_alv_total using value(p_name)
value(p_name2).

data: l_name(128) type c.
field-symbols <fs_name>.

* €–Ú–¼İ’è
if h_fieldcat-do_sum = 'A' or
h_fieldcat-do_sum = 'B'.
concatenate 'GF_WRITE-'
p_name
into      l_name.
else.
if p_name2 is initial.
concatenate 'G_'
p_name
into      l_name.
else.
concatenate 'G_'
p_name2
into      l_name.
endif.
endif.

assign (l_name) to <fs_name>.

case h_fieldcat-do_sum.
when 'A'.    " Å‘å
sort gt_write descending by (p_name).
read table gt_write into gf_write index 1.
wk_max = <fs_name>.
write at: wk_pos(h_fieldcat-outputlen) wk_max.

when 'B'.    " Å¬
sort gt_write ascending by (p_name).
read table gt_write into gf_write index 1.
wk_min = <fs_name>.
write at: wk_pos(h_fieldcat-outputlen) wk_min.

when 'X'.    " ‡Œv
wk_sum = <fs_name> / 1000.
write at: wk_pos(h_fieldcat-outputlen) wk_sum.

when 'C'.    " •½‹Ï
wk_avg = ( <fs_name> / g_tabline ) / 1000.
write at: wk_pos(h_fieldcat-outputlen) wk_avg.

when others.
endcase.

wk_pos = wk_pos + h_fieldcat-outputlen.
wk_pos = wk_pos + 1.

endform.                    " FRM_ALV_TOTAL
*&---------------------------------------------------------------------*
*&      Form  FRM_INIT_TOTAL
*&---------------------------------------------------------------------*
*       ‡Œvso—Í‰Šú‰»ˆ—
*----------------------------------------------------------------------*
form frm_init_total.

* İ’è—ñ”‰Šú‰»
wk_pos = 1.

* ‡Œv€–Ú‚Ì‰Šú‰»
clear: g_zuriysn,
g_zurijsk,
g_zaraysn,
g_zarajsk,
g_zuriyti,
g_zarayti,
g_zuruiysn,
g_zuruijsk,
g_zaruiysn,
g_zaruijsk.
*---APPEND START PSD T.SAITOH 2002/09/17 ---------------------------*
clear: g_budget_next,"”„ã—\ZiŸŒj
g_profit_next."‘e—˜—\ZiŸŒj
*---APPEND END   PSD T.SAITOH 2002/09/17 ---------------------------*

* ƒtƒB[ƒ‹ƒhƒJƒ^ƒƒOƒwƒbƒ_‰Šú‰»
clear h_fieldcat.
endform.                    " FRM_INIT_TOTAL
* ªAPPEND 2002/02/06 PSD.M.Arai ‡ŒvŒë·C³‘Î‰

*---APPEND START PSD T.SAITOH 2002/09/14 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  frm_mon_plus_one
*&---------------------------------------------------------------------*
*       ”NŒ‚Ìƒvƒ‰ƒX‚Pƒ–Œ
*----------------------------------------------------------------------*
*      -->P_PR_SPMON  text
*      <--P_G_SPMON  text
*----------------------------------------------------------------------*
form frm_mon_plus_one using    p_pr_spmon
changing p_g_spmon.

case p_pr_spmon+4(2).
when 12.
p_g_spmon+0(4) = p_pr_spmon+0(4) + 1.
p_g_spmon+4(2) = '01'.
when others.
p_g_spmon = p_pr_spmon + 1.
endcase.

endform.                    " frm_mon_plus_one
*---APPEND END   PSD T.SAITOH 2002/09/14 ---------------------------*
