***********************************************************************
* [プログラム名]：月末残高合計表
*   PROGRAM ID :ZM011200
*
* [処理概要]
*   CONTENTS:月末時点におけるプラント別の商品残高の在庫種類別内訳を示す
*
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2002/07/04   PSD T.SAITOH      新規開発
*  2002/09/05   PSD T.SAITOH      パフォーマンス対応【MSKA(H)】
*  2002/09/20   PSD H.HARUKI      出力日時を表示
*  2002/09/21   PSD T.SAITOH      出力項目ヘッダ名称変更
*  2002/10/31   PSD K.ARAI        販売明細番号抽出先にMSKAHを追加
*  2009/02/02   NDSC R.SHINAMI　　在庫数量から在庫評価額０に変更
*  2016/09/05   ISID YeXiaoyu　　     ロット対応
*  2016/09/26   ISID YeXiaoyu　　     差額を最大の列に調整するように改修
***********************************************************************
* --- サイズ及びフッタなどの設定をここでする。
REPORT ZM011200
LINE-SIZE 153
LINE-COUNT 58(8) "()の中の数値ははフッタ割当行数
NO STANDARD PAGE HEADING.
*---------------------------------------------------------------------*
* データ宣言(グローバル)
*---------------------------------------------------------------------*
*--- 定数項目
CONSTANTS:
CNS_MAX_LFMON(2) TYPE N VALUE 12."月の最大値

CONSTANTS:
CNS_T001(4)    TYPE C VALUE 'T001',
CNS_T001K(5)   TYPE C VALUE 'T001K',
CNS_T001W(5)   TYPE C VALUE 'T001W',
CNS_T001L(5)   TYPE C VALUE 'T001L',
CNS_MARA(4)    TYPE C VALUE 'MARA',
CNS_KNA1(4)    TYPE C VALUE 'KNA1',
CNS_LFA1(4)    TYPE C VALUE 'LFA1',
CNS_MAKT(4)    TYPE C VALUE 'MAKT',
CNS_MBEW(4)    TYPE C VALUE 'MBEW',
CNS_MSLB(4)    TYPE C VALUE 'MSLB',
CNS_MARC(4)    TYPE C VALUE 'MARC',
CNS_MSKA(4)    TYPE C VALUE 'MSKA',
CNS_MARD(4)    TYPE C VALUE 'MARD',
CNS_MSKU(4)    TYPE C VALUE 'MSKU',
CNS_MBEWH(5)   TYPE C VALUE 'MBEWH',
CNS_MSLBH(5)   TYPE C VALUE 'MSLBH',
CNS_MARCH(5)   TYPE C VALUE 'MARCH',
CNS_MSKAH(5)   TYPE C VALUE 'MSKAH',
CNS_MARDH(5)   TYPE C VALUE 'MARDH',
CNS_MSKUH(5)   TYPE C VALUE 'MSKUH',
CNS_X          TYPE C VALUE 'X',
CNS_E          TYPE C VALUE 'E',
CNS_O          TYPE C VALUE 'O',
CNS_W          TYPE C VALUE 'W',
CNS_MSLB_SEG(1)  TYPE C VALUE '5',
CNS_MARC_SEG(1)  TYPE C VALUE '3',
CNS_MSKA_SEG(1)  TYPE C VALUE '1',
CNS_MARD_SEG(1)  TYPE C VALUE '2',
CNS_MSKU_SEG(1)  TYPE C VALUE '4'.

*  構造宣言
TYPES: BEGIN OF TYP_ZM011200,
BUKRS     TYPE T001K-BUKRS,"会社コード
BWKEY     TYPE MBEW-BWKEY, "プラント
MATNR     TYPE MARA-MATNR, "品目コード
* MATERIAL PATTERN
MPTRN(10) TYPE C,          "在庫分類
LGORT(10) TYPE C,          "保管場所
LFGJA     TYPE MBEW-LFGJA, "会計年度
LFMON     TYPE MBEW-LFMON, "会計期間
MAKTX     TYPE MAKT-MAKTX, "品目名
BUTXT     TYPE T001-BUTXT, "会社名
PNAME     TYPE T001W-NAME1,"プラント名
LNAME(70) TYPE C,          "保管場所名
LGPBE(10) TYPE C,          "棚番
NUM(8)    TYPE P DECIMALS 2,"数量
MEINS     TYPE MARA-MEINS, "単位
UNTCT(8)  TYPE P DECIMALS 2,"単価
SALK3(8)  TYPE P,          "在庫金額
*  LBKUM     TYPE MBEW-LBKUM, "在庫合計
LBKUM     TYPE P DECIMALS 2,"在庫合計
TOTAL(9)  TYPE P,          "総合計
WAERS     TYPE T001-WAERS, "通貨コード
END OF TYP_ZM011200.

* DATA宣言（処理用）
DATA: GT_EXEC  TYPE TABLE OF TYP_ZM011200,"処理用
GF_EXEC  TYPE          TYP_ZM011200,"処理用構造
GF_EXEC_TMP  TYPE TYP_ZM011200,     "現レコード退避用
GF_EXEC_BEF  TYPE TYP_ZM011200.     "前レコード格納用

*  構造宣言
TYPES: BEGIN OF TYP_ZM011200_WRITE,
BUKRS     TYPE T001K-BUKRS,"会社コード
BWKEY     TYPE MBEW-BWKEY, "プラント
LFGJA     TYPE MBEW-LFGJA, "会計年度
LFMON     TYPE MBEW-LFMON, "会計期間
BUTXT     TYPE T001-BUTXT, "会社名
PNAME     TYPE T001W-NAME1,"プラント名
MSKA(9)   TYPE P,          "出荷準備品
MARD(9)   TYPE P,          "支店在庫品
MARC(9)   TYPE P,          "転送中在庫品
MSKU(9)   TYPE P,          "預託先在庫品
MSLB(9)   TYPE P,          "支給在在庫品
SALK3(9)  TYPE P,          "在庫金額
END OF TYP_ZM011200_WRITE.

DATA: GT_OUTPUT TYPE TABLE OF TYP_ZM011200_WRITE,"出力用
GF_OUTPUT TYPE          TYP_ZM011200_WRITE."

DATA: GF_TOTAL  TYPE          TYP_ZM011200_WRITE."総合計

* 会社コードマスタ構造
TYPES: BEGIN OF TYP_T001,
BUKRS TYPE T001-BUKRS,
BUTXT TYPE T001-BUTXT,
WAERS TYPE T001-WAERS, "通貨コード
END OF TYP_T001.

DATA: GT_T001 TYPE TABLE OF TYP_T001,
GF_T001 TYPE TYP_T001.

* 評価レベルマスタ構造
TYPES: BEGIN OF TYP_T001K,
BWKEY TYPE T001K-BWKEY,
BUKRS TYPE T001K-BUKRS,
END OF TYP_T001K.

DATA: GT_T001K TYPE TABLE OF TYP_T001K,
GF_T001K TYPE TYP_T001K.

* プラントマスタ構造
TYPES: BEGIN OF TYP_T001W,
WERKS TYPE T001W-WERKS,
NAME1 TYPE T001W-NAME1,
END OF TYP_T001W.

DATA: GT_T001W TYPE TABLE OF TYP_T001W,
GF_T001W TYPE TYP_T001W.

* 品目テキスト構造
TYPES: BEGIN OF TYP_MAKT,
MATNR TYPE MAKT-MATNR,
MAKTX TYPE MAKT-MAKTX,
END OF TYP_MAKT.

DATA: GT_MAKT TYPE TABLE OF TYP_MAKT,
GF_MAKT TYPE TYP_MAKT.

* 保管場所構造
TYPES: BEGIN OF TYP_T001L,
WERKS TYPE T001L-WERKS,
LGORT TYPE T001L-LGORT,
LGOBE TYPE T001L-LGOBE,
END OF TYP_T001L.

DATA: GF_T001L TYPE TYP_T001.

* 一般品目データ構造
TYPES: BEGIN OF TYP_MARA,
MATNR TYPE MARA-MATNR,
MEINS TYPE MARA-MEINS,
END OF TYP_MARA.

DATA: GF_MARA TYPE TYP_MARA.

* 得意先マスタ構造
TYPES: BEGIN OF TYP_KNA1,
KUNNR TYPE KNA1-KUNNR,
NAME1 TYPE KNA1-NAME1,
END OF TYP_KNA1.

DATA: GF_KNA1 TYPE TYP_KNA1.

* 仕入先マスタ構造
TYPES: BEGIN OF TYP_LFA1,
LIFNR TYPE LFA1-LIFNR,
NAME1 TYPE LFA1-NAME1,
END OF TYP_LFA1.

DATA: GF_LFA1 TYPE TYP_LFA1.

* 評価在庫構造
TYPES: BEGIN OF TYP_MBEW,
BUKRS TYPE T001-BUKRS,
BWKEY TYPE MBEW-BWKEY,
MATNR TYPE MBEW-MATNR,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
LBKUM TYPE MBEW-LBKUM,
SALK3 TYPE MBEW-SALK3,
VERPR TYPE MBEW-VERPR,
PEINH TYPE MBEW-PEINH,
END OF TYP_MBEW.

DATA: GT_MBEW TYPE TABLE OF TYP_MBEW,
GF_MBEW TYPE TYP_MBEW,
GT_MBEW_BEF TYPE TABLE OF TYP_MBEW, "前レコード
GF_MBEW_BEF TYPE TYP_MBEW,          "前レコード
GT_MBEW_EXEC TYPE TABLE OF TYP_MBEW,"処理用
GF_MBEW_EXEC TYPE TYP_MBEW.         "処理用

* MARD構造
TYPES: BEGIN OF TYP_MARD,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LGORT TYPE MARD-LGORT,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
LABST TYPE MARD-LABST,"自社在庫：保管場所
LGPBE TYPE MARD-LGPBE,"棚番
END OF TYP_MARD.

DATA: GT_MARD TYPE TABLE OF TYP_MARD,
GF_MARD TYPE TYP_MARD.
* ↓実際はグローバル
DATA: LT_MARD TYPE TABLE OF TYP_MARD,"ローカル用内部テーブル
LF_MARD LIKE GF_MARD.

* MSKA構造
TYPES: BEGIN OF TYP_MSKA,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LGORT TYPE MARD-LGORT,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
SOBKZ TYPE MSKA-SOBKZ,"特殊在庫
KALAB TYPE MSKA-KALAB,"自社在庫：受注在庫
END OF TYP_MSKA.

*DATA: GT_MSKA TYPE TABLE OF TYP_MSKA,
DATA: GF_MSKA TYPE TYP_MSKA.
* ↓実際はグローバル
DATA: LT_MSKA TYPE TABLE OF TYP_MSKA,"ローカル用内部テーブル
LF_MSKA LIKE GF_MSKA.

* MSKU構造
TYPES: BEGIN OF TYP_MSKU,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
KUNNR TYPE MSKU-KUNNR,"得意先
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
SOBKZ TYPE MSKU-SOBKZ,"特殊在庫
KULAB TYPE MSKU-KULAB,"預託在庫
END OF TYP_MSKU.

DATA: GT_MSKU TYPE TABLE OF TYP_MSKU,
GF_MSKU TYPE TYP_MSKU.
* ↓実際はグローバル
DATA: LT_MSKU TYPE TABLE OF TYP_MSKU,"ローカル用内部テーブル
LF_MSKU TYPE TYP_MSKU.

* MSLB構造
TYPES: BEGIN OF TYP_MSLB,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LIFNR TYPE MSLB-LIFNR,"仕入先
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
SOBKZ TYPE MSLB-SOBKZ,"特殊在庫
LBLAB TYPE MSLB-LBLAB,"支給在庫
END OF TYP_MSLB.

DATA: GT_MSLB TYPE TABLE OF TYP_MSLB,
GF_MSLB TYPE TYP_MSLB.
* ↓実際はグローバル
DATA: LT_MSLB TYPE TABLE OF TYP_MSLB,"ローカル用内部テーブル
LF_MSLB LIKE GF_MSLB.

* MARC構造
TYPES: BEGIN OF TYP_MARC,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
TRAME TYPE MARC-TRAME,"転送中在庫
END OF TYP_MARC.

DATA: GT_MARC TYPE TABLE OF TYP_MARC,
GF_MARC TYPE TYP_MARC.
DATA: LT_MARC TYPE TABLE OF TYP_MARC,"ローカル用内部テーブル
LF_MARC LIKE GF_MARC.

DATA: GW_NUM(8)    TYPE P DECIMALS 2,     "作業用自社在庫数量
GW_LGPBE(10) TYPE C,                "作業用棚番
GW_TOTAL(10) TYPE P.                "作業用総合計

DATA: GF_LIFNR_TMP  TYPE TYP_LFA1,    "仕入先テンポラリ
GF_KUNNR_TMP  TYPE TYP_KNA1.    "得意先テンポラリ

* MSKA(H)を統合　ＤＢの内容すべて格納する内部ＴＢＬ
TYPES: BEGIN OF TYP_MSKA_HS,
MATNR TYPE MARD-MATNR,
WERKS TYPE MARD-WERKS,
LGORT TYPE MARD-LGORT,
***** 2016/9/5 ISID18 INS START *****
CHARG TYPE MSKA-CHARG,  "ロット
***** 2016/9/5 ISID18 INS END *****
SOBKZ TYPE MSKA-SOBKZ,"特殊在庫
VBELN TYPE MSKA-VBELN,
POSNR TYPE MSKA-POSNR,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
KALAB TYPE MSKA-KALAB,"自社在庫：受注在庫
END OF TYP_MSKA_HS.

DATA: GT_MSKA_DB TYPE HASHED TABLE OF TYP_MSKA_HS
WITH UNIQUE KEY MATNR
WERKS
LGORT
**************** 2016/9/5 ISID18 INS START *****
CHARG
**************** 2016/9/5 ISID18 INS END *****
SOBKZ
VBELN
POSNR
LFGJA
LFMON,
GF_MSKA_DB TYPE TYP_MSKA_HS.
* 伝票番号専用MSKA(H)テーブル
DATA: GT_MSKA_NUMBERS TYPE TABLE OF TYP_MSKA_HS,
GF_MSKA_NUMBERS TYPE TYP_MSKA_HS.

*  DATA: G_FLG_MATNR TYPE C."品目コード

DATA: G_YEAR  TYPE MBEW-LFGJA,"カレンダー年
G_MONTH TYPE MBEW-LFMON."カレンダー月

*---------------------------------------------------------------------*
* 選択画面
*---------------------------------------------------------------------*
* 選択画面 *----------------------------------------------------*
PARAMETERS: PR_LFGJA   TYPE  MBEW-LFGJA OBLIGATORY
DEFAULT SY-DATUM+0(4).
PARAMETERS: PR_LFMON   TYPE  MBEW-LFMON OBLIGATORY
DEFAULT SY-DATUM+4(2).
PARAMETERS: PR_BUKRS   TYPE  T001-BUKRS  MEMORY ID BUK OBLIGATORY.
SELECT-OPTIONS:S_WERKS FOR GF_T001W-WERKS MEMORY ID WRK OBLIGATORY.

* オプション設定
SELECTION-SCREEN BEGIN OF BLOCK BKOP
WITH FRAME TITLE TEXT-070.
PARAMETERS: PR_PAGE AS CHECKBOX DEFAULT 'X'."ページ表示
PARAMETERS: PR_COLR AS CHECKBOX DEFAULT 'X'."色表示
SELECTION-SCREEN END   OF BLOCK BKOP.

*--------------------------------------------------------------*
* INITIALIZATION
*--------------------------------------------------------------*
INITIALIZATION.

*---------------------------------------------------------------------
* at selection-screen
*---------------------------------------------------------------------
AT SELECTION-SCREEN.

G_YEAR  = PR_LFGJA."カレンダー年
G_MONTH = PR_LFMON."カレンダー月

IF SY-UCOMM+0(1) <> '%'.
PERFORM FRM_CHECK_YEAR USING PR_LFGJA.
PERFORM FRM_CHECK_MON  USING PR_LFMON.
PERFORM FRM_CHECK_BUKRS.
PERFORM FRM_CHECK_WERKS.
ENDIF.

*---------------------------------------------------------------------
* TOP-OF-PAGE
*---------------------------------------------------------------------
TOP-OF-PAGE.
* ---------------------------------------------------------------------*
* デバッグ用
*   PERFORM FRM_TEST_HEAD_WRITE.
* ---------------------------------------------------------------------*
PERFORM FRM_TOP_OF_PAGE.

*&---------------------------------------------------------------------*
*&      Form  FRM_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*       改ページ処理
*----------------------------------------------------------------------*
FORM FRM_TOP_OF_PAGE.
DATA: L_TITLE TYPE SY-TITLE."帳票タイトル
* 会計数値違い明確化文章
WRITE:/0 TEXT-072.
* 色設定
IF PR_COLR = CNS_X.
*   MAIN HEADER
CONCATENATE '**' SY-TITLE '**' INTO L_TITLE.
WRITE:70(18) L_TITLE.           "帳票タイトル
WRITE : 114 '処理日付' ,
sy-datum ,
137 '処理時刻' ,
sy-uzeit .

*   PAGE DISPLAY ON
ENDIF.
IF PR_PAGE = CNS_X.
WRITE:/145(2) SY-PAGNO,         "ページ数
148(6) TEXT-069.         "ページ（テキスト）
ENDIF.

SKIP 1.
WRITE: /0(10) TEXT-050,         "会社コード（テキスト）
12(10)  GF_EXEC_TMP-BUKRS,"会社コード
18(25) GF_EXEC_TMP-BUTXT,"会社名
136(4) G_YEAR,           "会計年度
141(4) TEXT-053,         "年（テキスト）
147(2) G_MONTH,          "月
150(4) TEXT-054.         "月（テキスト）
SKIP 1.
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (BLUE)
FORMAT COLOR COL_HEADING ON INTENSIFIED.
* ITEM HEADER （テキスト）
ENDIF.
WRITE: /00(8)   TEXT-055,"プラント
*---MODIFY START PSD T.SAITOH 2002/09/21 ---------------------------*
*          46(10)  TEXT-056,"出荷準備品
*          68(8)   TEXT-057,"支店在庫
42(14)  TEXT-056,"個別購買品在庫
66(10)   TEXT-057,"在庫品在庫
*---MODIFY END   PSD T.SAITOH 2002/09/21 ---------------------------*
85(10)  TEXT-058,"積送中在庫
104(10)  TEXT-059,"預託品在庫
123(10)  TEXT-060,"支給品在庫
141(12)  TEXT-061,"合計在庫金額
153(1)  SPACE,   "スペース
/01(153) SY-ULINE."下線
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SETING BLUE
FORMAT COLOR OFF.
ENDIF.

ENDFORM.                    " FRM_TOP_OF_PAGE
*---------------------------------------------------------------------
* START-OF-SELECTION
*---------------------------------------------------------------------
START-OF-SELECTION.
* カレンダー日付を会計年月に変換
PERFORM FRM_CHANGED_CLYEAR_AND_MONTH.
* 初期処理
PERFORM FRM_SELECT_T001K.
PERFORM FRM_SELECT_T001.
PERFORM FRM_SELECT_T001W.
* 抽出処理
PERFORM FRM_EXTRACTION_MBEW.
* 各在庫のデータ選定
PERFORM FRM_EXTRACTIONS.
* 集計処理
PERFORM FRM_COMPUTE.
***** 2016/9/26 isid18 ins start *****
*  差額調整処理
PERFORM FRM_ADJUST.
***** 2016/9/26 isid18 ins end *****
* 帳票出力
PERFORM FRM_OUTPUT.

*&---------------------------------------------------------------------*
*&      Form  FRM_extraction_MBEW
*&---------------------------------------------------------------------*
*       MBEW 品目評価：抽出処理
*----------------------------------------------------------------------*
FORM  FRM_EXTRACTION_MBEW.
DATA:L_CNT_MBEW TYPE I."MBEW取得件数
* 抽出
PERFORM FRM_SELECT_MBEW.
PERFORM FRM_SELECT_MBEWH.

* 取得件数
DESCRIBE TABLE GT_MBEW LINES L_CNT_MBEW.
IF L_CNT_MBEW = 0.
MESSAGE S616(Z1).
STOP.
ENDIF.

* 対象外プラントを削除する
DELETE GT_MBEW WHERE BUKRS <> PR_BUKRS.

* 会社コード／プラント／品目コードを昇順
* 会計年度／会計期間を降順　ソート
SORT GT_MBEW  BY BUKRS ASCENDING
BWKEY ASCENDING
MATNR ASCENDING
LFGJA DESCENDING
LFMON DESCENDING.

CLEAR: GF_MBEW_BEF.
* 当月末在庫に該当するレコード特定処理ループ
LOOP AT GT_MBEW INTO GF_MBEW.
*   在庫合計金額が０のものは対象外とする
IF GF_MBEW-SALK3 <= 0.
*     現レコードを前レコードをとして格納
GF_MBEW_BEF = GF_MBEW.
CONTINUE.
ENDIF.
*   会社コード／プラント／品目コード  ブレイクごとに処理
IF NOT ( GF_MBEW-BUKRS  = GF_MBEW_BEF-BUKRS  AND
GF_MBEW-BWKEY  = GF_MBEW_BEF-BWKEY  AND
GF_MBEW-MATNR  = GF_MBEW_BEF-MATNR ).
*     当月末在庫に該当するレコード検索
PERFORM FRM_SPECIFIC_MBEW.
ENDIF.
*   現レコードを前レコードをとして格納
GF_MBEW_BEF = GF_MBEW.
ENDLOOP.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FRM_CHANGE_CLTOFI
*&---------------------------------------------------------------------*
*       カレンダー年月→会計年月　変換処理
*----------------------------------------------------------------------*
*  -->  p1        カレンダー年
*  <--  p2        カレンダー月
*----------------------------------------------------------------------*
FORM FRM_CHANGE_CLTOFI USING VALUE(PR_YEAR)
VALUE(PR_MON)
CHANGING PR_FI_YEAR
PR_FI_MON.
*--- カレンダー月の判断（１～３）
IF PR_MON >= 1 AND PR_MON <= 3.
PR_FI_YEAR = PR_YEAR - 1.
PR_FI_MON  = PR_MON + 9.
*--- カレンダー月の判断（４～１２）
ELSEIF PR_MON >= 4 AND PR_MON <= 12.
PR_FI_YEAR = PR_YEAR.
PR_FI_MON  = PR_MON - 3.
ELSE.
*--- カレンダー月（例外処理）
ENDIF.

ENDFORM.                    " FRM_CHANGE_CLTOFI
*&===入力チェック======================================================*
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_YEAR
*&---------------------------------------------------------------------*
*       入力チェック：年度
*----------------------------------------------------------------------*
FORM FRM_CHECK_YEAR USING P_YEAR.
* --- 年度に０が入力された場合
IF P_YEAR = 0.
*   "会計年度に[0]は指定できません
MESSAGE S601(Z1) WITH TEXT-002
TEXT-004.
STOP.
ENDIF.
ENDFORM.                    " FRM_CHECK_YEAR
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_MON
*&---------------------------------------------------------------------*
*       入力チェック：月
*----------------------------------------------------------------------*
FORM FRM_CHECK_MON USING P_MON.
* ---期間が０の時
IF P_MON = 0.
*   "会計期間に[0]は指定できません
MESSAGE E601(Z1) WITH TEXT-003
TEXT-004.
STOP.
ENDIF.
* ---期間が範囲外の時
IF NOT ( P_MON >= 1 AND P_MON <= CNS_MAX_LFMON ).
*   "会計期間には１～１２を指定してください。
MESSAGE E700(Z1) WITH TEXT-003
TEXT-005.
STOP.
ENDIF.
ENDFORM.                    " FRM_CHECK_MON

*&---------------------------------------------------------------------*
*&      CHECK_BUKRS
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_BUKRS
*&---------------------------------------------------------------------*
*       会社コード存在チェック
*----------------------------------------------------------------------*
FORM FRM_CHECK_BUKRS.
DATA:LT_DUMMY TYPE TABLE OF TYP_T001.

SELECT BUKRS
FROM T001
INTO CORRESPONDING FIELDS OF TABLE LT_DUMMY
WHERE BUKRS =  PR_BUKRS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE E606(Z1) WITH TEXT-006.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001 SY-SUBRC.
ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      CHECK_WERKS
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_WERKS
*&---------------------------------------------------------------------*
*       プラントコード存在チェック
*----------------------------------------------------------------------*
FORM FRM_CHECK_WERKS.
DATA:LT_DUMMY TYPE TABLE OF TYP_T001W.

SELECT WERKS
FROM T001W
INTO CORRESPONDING FIELDS OF TABLE LT_DUMMY
WHERE WERKS IN S_WERKS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE E606(Z1) WITH TEXT-007.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001W SY-SUBRC.
ENDCASE.

ENDFORM.

*&---------------------------------------------------------------------*
*&      SELECT NUMBER 01
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_T001K
*&---------------------------------------------------------------------*
*       プラントコードから会社コードを取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_T001K.

SELECT BWKEY
BUKRS
FROM T001K
INTO CORRESPONDING FIELDS OF TABLE GT_T001K
WHERE BWKEY IN S_WERKS
AND BUKRS = PR_BUKRS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001K SY-SUBRC.
ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 02
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_T001
*&---------------------------------------------------------------------*
*       会社コードから会社名を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_T001.

SELECT BUKRS
BUTXT
WAERS
FROM T001
INTO CORRESPONDING FIELDS OF TABLE GT_T001
WHERE BUKRS =  PR_BUKRS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001 SY-SUBRC.
ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 03
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_T001W
*&---------------------------------------------------------------------*
*       プラントコードからプラント名を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_T001W.

SELECT WERKS
NAME1
FROM T001W
INTO CORRESPONDING FIELDS OF TABLE GT_T001W
WHERE WERKS IN S_WERKS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001W SY-SUBRC.
ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 04
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MBEW
*&---------------------------------------------------------------------*
*       評価在庫情報を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_MBEW.

SELECT BWKEY "プラント
MATNR "品目コード
LFGJA "会計年度
LFMON "会計期間
LBKUM "在庫合計数量
SALK3 "在庫合計金額
VERPR "移動平均原価
PEINH "価格単位
FROM MBEW
*    INTO CORRESPONDING FIELDS OF GF_MBEW
INTO CORRESPONDING FIELDS OF TABLE GT_MBEW
WHERE BWKEY IN S_WERKS
AND ( LFGJA <  PR_LFGJA
OR   (
LFGJA = PR_LFGJA AND
LFMON <= PR_LFMON
)
)
AND SALK3 > 0.
**   会社コードを埋め込む
*    READ TABLE GT_T001K INTO GF_T001K
*                       WITH KEY BWKEY = GF_MBEW-BWKEY.
*    GF_MBEW-BUKRS = GF_T001K-BUKRS.
*    APPEND GF_MBEW TO GT_MBEW.
*  ENDSELECT.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*     MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MBEW SY-SUBRC.
ENDCASE.

ENDFORM.
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 05
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MBEWH
*&---------------------------------------------------------------------*
*       評価在庫履歴情報を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_MBEWH.

SELECT BWKEY "プラント
MATNR "品目コード
LFGJA "会計年度
LFMON "会計期間
LBKUM "在庫合計数量
SALK3 "在庫合計金額
VERPR "移動平均原価
PEINH "価格単位
FROM MBEWH
*    INTO CORRESPONDING FIELDS OF GF_MBEW
APPENDING CORRESPONDING FIELDS OF TABLE GT_MBEW
WHERE BWKEY IN S_WERKS
*---MODIFY START PSD K.ARAI   2002/10/24 ---------------------------*
*** 履歴テーブルは「入力値以降」でデータ検索を行う
AND ( lfgja >  pr_lfgja
OR   (
lfgja = pr_lfgja AND
lfmon >= pr_lfmon
*     AND ( LFGJA <  PR_LFGJA
*      OR   (
*             LFGJA = PR_LFGJA AND
*             LFMON <= PR_LFMON
*---MODIFY END   PSD K.ARAI   2002/10/24 ---------------------------*
)
)
AND SALK3 > 0.
**   会社コードを埋め込む
*    READ TABLE GT_T001K INTO GF_T001K
*                       WITH KEY BWKEY = GF_MBEW-BWKEY.
*    GF_MBEW-BUKRS = GF_T001K-BUKRS.
*    APPEND GF_MBEW TO GT_MBEW.
*  ENDSELECT.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MBEW SY-SUBRC.
ENDCASE.

FIELD-SYMBOLS <FS_MBEW> LIKE GF_MBEW.

LOOP AT GT_MBEW ASSIGNING <FS_MBEW>.
READ TABLE GT_T001K INTO GF_T001K
WITH KEY BWKEY = <FS_MBEW>-BWKEY.
<FS_MBEW>-BUKRS = GF_T001K-BUKRS.
ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 42
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MAKT
*&---------------------------------------------------------------------*
*       品目テキストの取得
*----------------------------------------------------------------------*
*  -->  P_MATNR        品目コード
*  <--  P_MAKTX        品目名
*----------------------------------------------------------------------*
FORM FRM_SELECT_MAKT USING    P_MATNR
CHANGING P_MAKTX.

SELECT SINGLE
MAKTX
FROM MAKT
INTO (P_MAKTX)
WHERE MATNR = P_MATNR
AND SPRAS = 'J'.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MAKT SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SELECT_MAKT
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 44
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MARA
*&---------------------------------------------------------------------*
*       基本数量単位を取得する
*----------------------------------------------------------------------*
*      -->P_MATNR  品目コード
*      <--P_MEINS  基本数量単位
*----------------------------------------------------------------------*
FORM FRM_SELECT_MARA USING    P_MATNR
CHANGING P_MEINS.
SELECT SINGLE
MEINS
FROM MARA
INTO (P_MEINS)
WHERE MATNR = P_MATNR.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MARA SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SELECT_MARA
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MBEW
*&---------------------------------------------------------------------*
*       当月末在庫特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MBEW.
DATA:LT_MBEW    TYPE TABLE OF TYP_MBEW,"ローカル内部テーブル
LF_MBEW    LIKE GF_MBEW.

* ①A指定会計期間でMBEWを検索 select number 6
SELECT SINGLE
BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEW
INTO CORRESPONDING FIELDS OF LF_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*     処理用内部へ格納する
APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMBEWHを検索 select number 7
SELECT SINGLE
BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEWH
INTO CORRESPONDING FIELDS OF LF_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*     処理用内部へ格納する
APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMBEWHから検索
* select number 8
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEWH
INTO CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMBEWから検索
* select number 9
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEW
APPENDING CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MBEW IS INITIAL ).
*     ソート
SORT LT_MBEW BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MBEW INTO LF_MBEW.
*       会社コード挿入
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*       処理用内部へ格納する
APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMBEWHから検索
* select number 10
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEWH
INTO CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMBEWから検索
* select number 11
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEW
APPENDING CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MBEW IS INITIAL ).
*     ソート
SORT LT_MBEW BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MBEW INTO LF_MBEW.
*       会社コード挿入
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*       処理用内部へ格納する
APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

ENDFORM.                    " FRM_SPECIFIC_MBEW
*&---------------------------------------------------------------------*
*&      Form  FRM_EXTRACTIONS
*&---------------------------------------------------------------------*
*       各在庫の選定処理
*----------------------------------------------------------------------*
FORM FRM_EXTRACTIONS.
DATA:L_CNT_MBEW_EXEC TYPE I."EXEC取得件数
* 取得件数
DESCRIBE TABLE GT_MBEW_EXEC LINES L_CNT_MBEW_EXEC.
IF L_CNT_MBEW_EXEC = 0.
MESSAGE S616(Z1).
STOP.
ENDIF.

* 受注在庫（販売明細番号取得）
PERFORM FRM_SPECIFIC_MSKA_BEFORE.
* 受注在庫（MSKA全データ取得）
PERFORM FRM_SPECIFIC_MSKA_ALL.

LOOP AT GT_MBEW_EXEC INTO GF_MBEW_EXEC.
PERFORM FRM_SPECIFIC_MSKA_UP.
PERFORM FRM_SPECIFIC_MARD.
PERFORM FRM_SPECIFIC_MSKU_READY.
PERFORM FRM_SPECIFIC_MSLB_READY.
PERFORM FRM_SPECIFIC_MARC.
ENDLOOP.

ENDFORM.                    " FRM_EXTRACTIONS
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MBEW
*&---------------------------------------------------------------------*
*       ＭＢＥＷ共通項目セット
*----------------------------------------------------------------------*
FORM FRM_SET_MBEW.
DATA: LF_T001  TYPE TYP_T001,
LF_T001K TYPE TYP_T001K,
LF_T001W TYPE TYP_T001W.
DATA: L_VERPR(9) TYPE P DECIMALS 2,"移動平均原価作業用
L_SALK3(9) TYPE P DECIMALS 2."在庫合計金額

CLEAR:GF_EXEC.
*  MOVE-CORRESPONDING FIELDS OF GF_MBEW_EXEC GF_EXEC.
GF_EXEC-BUKRS = GF_MBEW_EXEC-BUKRS .
GF_EXEC-BWKEY = GF_MBEW_EXEC-BWKEY .
GF_EXEC-MATNR = GF_MBEW_EXEC-MATNR .
*  保管場所、仕入先、得意先、転送中（テキスト）
*  GF_EXEC-LGORT = GF_MBEW_EXEC-LGORT ."保管場所　後ほど設定
*  GF_EXEC-MPTRN = GF_MBEW_EXEC-MPTRN ."保管場所種別　後ほど設定
GF_EXEC-LFGJA = GF_MBEW_EXEC-LFGJA .
GF_EXEC-LFMON = GF_MBEW_EXEC-LFMON .
*  GF_EXEC-MAKTX = GF_MBEW_EXEC-MAKTX ."品目名
*  PERFORM FRM_SELECT_MAKT USING    GF_MBEW_EXEC-MATNR
*                          CHANGING GF_EXEC-MAKTX.

*  GF_EXEC-BUTXT = GF_MBEW_EXEC-BUTXT ."会社名
READ TABLE GT_T001 INTO LF_T001
WITH KEY BUKRS = GF_MBEW_EXEC-BUKRS.
GF_EXEC-BUTXT = LF_T001-BUTXT.

*  GF_EXEC-PNAME = GF_MBEW_EXEC-PNAME ."プラント名
READ TABLE GT_T001W INTO LF_T001W
WITH KEY WERKS = GF_MBEW_EXEC-BWKEY.
GF_EXEC-PNAME = LF_T001W-NAME1.

*  GF_EXEC-LNAME = GF_MBEW_EXEC-LNAME ."保管所名  後ほど設定
*  GF_EXEC-LGPBE = GF_MBEW_EXEC-LGPBE ."棚番　　　後ほど設定
*  GF_EXEC-NUM = GF_MBEW_EXEC- .       "数量　　　後ほど設定

*  GF_EXEC-MEINS = GF_MBEW_EXEC- .      "単位
PERFORM FRM_SELECT_MARA USING    GF_MBEW_EXEC-MATNR
CHANGING GF_EXEC-MEINS.
*  GF_EXEC-UNTCT = GF_MBEW_EXEC- .     "単価
* 移動平均原価を価格変換する
PERFORM FRM_CURRENCY_AMOUNT USING    LF_T001-WAERS
GF_MBEW_EXEC-VERPR
CHANGING L_VERPR.
* ０で除算を回避
IF GF_MBEW_EXEC-PEINH <> 0.
GF_EXEC-UNTCT = L_VERPR / GF_MBEW_EXEC-PEINH.
ELSE.
GF_EXEC-UNTCT = 0.
ENDIF.

* 合計金額を価格変換する
PERFORM FRM_CURRENCY_AMOUNT USING    LF_T001-WAERS
GF_MBEW_EXEC-SALK3
CHANGING L_SALK3.

GF_EXEC-SALK3 = L_SALK3 . "合計金額


GF_EXEC-LBKUM = GF_MBEW_EXEC-LBKUM . "合計数量


ENDFORM.                    " FRM_SET_MBEW
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA_BEFORE
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理_前処理伝票番号全件取得
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA_BEFORE.

* 伝票番号パターンを抽出
SELECT DISTINCT
MATNR
WERKS
LGORT
SOBKZ
VBELN
POSNR
LFGJA
LFMON
INTO CORRESPONDING FIELDS OF TABLE GT_MSKA_NUMBERS
FROM MSKA
FOR ALL ENTRIES IN GT_MBEW_EXEC
WHERE  MATNR = GT_MBEW_EXEC-MATNR
AND  WERKS IN S_WERKS
AND  KALAB <> 0
AND  (
( LFGJA   =  PR_LFGJA AND
LFMON   <= PR_LFMON
)
OR
(
LFGJA   <  PR_LFGJA
)
)
.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

*---APPEND START PSD K.ARAI   2002/10/17 ---------------------------*
* MSKAH より伝票番号パターンを抽出
SELECT DISTINCT
matnr
werks
lgort
sobkz
vbeln
posnr
lfgja
lfmon
APPENDING CORRESPONDING FIELDS OF TABLE gt_mska_numbers
FROM mskah
FOR ALL ENTRIES IN gt_mbew_exec
WHERE  matnr = gt_mbew_exec-matnr
AND  werks IN s_werks
AND  kalab <> 0
AND  (
( lfgja   =  pr_lfgja AND
lfmon   >= pr_lfmon
)
OR
(
lfgja   >  pr_lfgja
)
)
.

* --- エラーチェック
CASE sy-subrc.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE a603(z1) WITH sy-repid
cns_mska
sy-subrc.
ENDCASE.
*---APPEND END   PSD K.ARAI   2002/10/17 ---------------------------*
ENDFORM.  " FRM_SPECIFIC_MSKA_BEFORE.
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA_ALL
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理_前処理全データ取得
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA_ALL.
DATA: L_RECNUM TYPE I."レコード件数

DESCRIBE TABLE GT_MSKA_NUMBERS LINES L_RECNUM.
* 対象なしの場合は下記のセレクトを行なわない
IF L_RECNUM = 0.
EXIT.
ENDIF.

* MSKA(H)より全データ格納
SELECT MATNR
WERKS
LGORT
***** 2016/9/5 ISID18 INS START *****
CHARG
***** 2016/9/5 ISID18 INS END *****
SOBKZ
VBELN
POSNR
LFGJA
LFMON
KALAB
INTO CORRESPONDING FIELDS OF TABLE GT_MSKA_DB
FROM MSKA
FOR ALL ENTRIES IN GT_MSKA_NUMBERS
WHERE MATNR = GT_MSKA_NUMBERS-MATNR
AND WERKS = GT_MSKA_NUMBERS-WERKS
AND LGORT = GT_MSKA_NUMBERS-LGORT
AND SOBKZ = GT_MSKA_NUMBERS-SOBKZ
AND VBELN = GT_MSKA_NUMBERS-VBELN
AND POSNR = GT_MSKA_NUMBERS-POSNR
.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

* MSKA(H)より全データ格納
SELECT MATNR
WERKS
LGORT
***** 2016/9/5 ISID18 INS START *****
CHARG
***** 2016/9/5 ISID18 INS END *****
SOBKZ
VBELN
POSNR
LFGJA
LFMON
KALAB
APPENDING CORRESPONDING FIELDS OF TABLE GT_MSKA_DB
FROM MSKAH
FOR ALL ENTRIES IN GT_MSKA_NUMBERS
WHERE MATNR = GT_MSKA_NUMBERS-MATNR
AND WERKS = GT_MSKA_NUMBERS-WERKS
AND LGORT = GT_MSKA_NUMBERS-LGORT
AND SOBKZ = GT_MSKA_NUMBERS-SOBKZ
AND VBELN = GT_MSKA_NUMBERS-VBELN
AND POSNR = GT_MSKA_NUMBERS-POSNR
.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.


ENDFORM.  " FRM_SPECIFIC_MSKA_ALL.
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA_UP
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理_上階層
*        販売伝票番号＋明細番号
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA_UP.

*---MODIFY START PSD T.SAITOH 2002/09/05 ---------------------------*
* パフォーマンス対応
*  LOOP AT GT_MSKA_NUMBERS INTO GF_MSKA_NUMBERS.
LOOP AT GT_MSKA_NUMBERS INTO GF_MSKA_NUMBERS
where matnr = GF_MBEW_EXEC-matnr
and WERKS = GF_MBEW_EXEC-BWKEY.

*---MODIFY END   PSD T.SAITOH 2002/09/05 ---------------------------*
PERFORM FRM_SPECIFIC_MSKA USING GF_MSKA_NUMBERS-VBELN
GF_MSKA_NUMBERS-POSNR
GF_MSKA_NUMBERS-LGORT.
ENDLOOP.

ENDFORM.  " FRM_SPECIFIC_MSKA_BEFORE.
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理
*----------------------------------------------------------------------*
* --> P_VBELN 販売伝票番号
* --> P_POSNR 明細番号
* --> P_LGORT 保管場所
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA USING P_VBELN P_POSNR P_LGORT.

FIELD-SYMBOLS <FS_MSKA> LIKE GT_MSKA_DB.
FIELD-SYMBOLS <FSF_MSKA> LIKE GF_MSKA_DB.

ASSIGN GT_MSKA_DB TO <FS_MSKA>.
ASSIGN GF_MSKA_DB TO <FSF_MSKA>.
CLEAR: LT_MSKA,LF_MSKA.

* ①A指定会計期間でMSKAを検索
* select number 12

**************** 2016/9/5 ISID18 DEL START *****
*   READ TABLE <FS_MSKA> INTO <FSF_MSKA>
*                        WITH TABLE KEY
*                        MATNR   = GF_MBEW_EXEC-MATNR
*                        WERKS   = GF_MBEW_EXEC-BWKEY
*                        LGORT   = P_LGORT
*                        SOBKZ   = CNS_E
*                        VBELN   = P_VBELN
*                        POSNR   = P_POSNR
*                        LFGJA   = PR_LFGJA
*                        LFMON   = PR_LFMON.
**************** 2016/9/5 ISID18 DEL END *****
**************** 2016/9/5 ISID18 INS START *****
LOOP AT <FS_MSKA> INTO <FSF_MSKA>
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND                 WERKS   = GF_MBEW_EXEC-BWKEY
AND                 LGORT   = P_LGORT
AND                 SOBKZ   = CNS_E
AND                VBELN   = P_VBELN
AND                 POSNR   = P_POSNR
AND                 LFGJA   = PR_LFGJA
AND                 LFMON   = PR_LFMON.

MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKA.
APPEND GF_EXEC TO GT_EXEC.
ENDLOOP.
EXIT.
**************** 2016/9/5 ISID18 INS END *****

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
**************** 2016/9/5 ISID18 DEL START *****
*      MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
**     MBEW項目設定
*      PERFORM FRM_SET_MBEW.
**     詳細設定
*      PERFORM FRM_SET_MSKA.
*      APPEND GF_EXEC TO GT_EXEC.
*      EXIT.
**************** 2016/9/5 ISID18 DEL END *****
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMSKAHから検索
* select number 14
*  FIELD-SYMBOLS <FS_MSKA> LIKE GF_MSKA_DB.
LOOP AT GT_MSKA_DB ASSIGNING <FSF_MSKA>
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_E
AND  VBELN   = P_VBELN
AND  POSNR   = P_POSNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
APPEND LF_MSKA TO LT_MSKA.

ENDLOOP.


* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.


IF NOT ( LT_MSKA IS INITIAL ).
*     ソート
SORT LT_MSKA BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKA INTO LF_MSKA.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKA.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMSKAHから検索
* select number 16

LOOP AT GT_MSKA_DB ASSIGNING <FSF_MSKA>
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_E
AND  VBELN   = P_VBELN
AND  POSNR   = P_POSNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.

MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
APPEND LF_MSKA TO LT_MSKA.

ENDLOOP.

** --- エラーチェック
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH SY-REPID
*                            CNS_MSKA
*                            SY-SUBRC.
*  ENDCASE.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSKA IS INITIAL ).
*     ソート
SORT LT_MSKA BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKA INTO LF_MSKA.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKA.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MSKA
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MSKA
*&---------------------------------------------------------------------*
*       １－①MSKA詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MSKA.
* 保管場所
GF_EXEC-LGORT = LF_MSKA-LGORT.
* 保管場所種別
GF_EXEC-MPTRN = CNS_MSKA_SEG.
* 保管場所名
** select number 43
*  SELECT SINGLE
*         LGOBE
*         FROM T001L
*         INTO (GF_EXEC-LNAME)
*         WHERE WERKS = LF_MSKA-WERKS
*           AND LGORT = LF_MSKA-LGORT.
** --- エラーチェック
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH SY-REPID CNS_T001L SY-SUBRC.
*  ENDCASE.

* 棚番 --- 未設定

* 数量
GF_EXEC-NUM = LF_MSKA-KALAB.

ENDFORM.                    " FRM_SET_MSKA
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MARD
*&---------------------------------------------------------------------*
*       １－②自社保管場所在庫の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MARD.

CLEAR: LT_MARD,LF_MARD.
* ①A指定会計期間でMARDを検索
* select number 18
SELECT SINGLE
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
LGPBE
*         SOBKZ
FROM   MARD
INTO CORRESPONDING FIELDS OF LF_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMARDHを検索
* select number 19
SELECT SINGLE
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
*         LGPBE
*         SOBKZ
FROM   MARDH
INTO CORRESPONDING FIELDS OF LF_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMARDHから検索
* select number 20
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
*         LGPBE
*         SOBKZ
FROM   MARDH
INTO CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMARDから検索
* select number 21
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
LGPBE
*         SOBKZ
FROM   MARD
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARD IS INITIAL ).
*     ソート
SORT LT_MARD BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARD INTO LF_MARD.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMARDHから検索
* select number 22
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
*         LGPBE
*         SOBKZ
FROM   MARDH
INTO CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMARDから検索
* select number 23
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
LGPBE
*         SOBKZ
FROM   MARD
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARD IS INITIAL ).
*     ソート
SORT LT_MARD BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARD INTO LF_MARD.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MARD

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MARD
*&---------------------------------------------------------------------*
*       １－②MARD詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MARD.
* 保管場所
GF_EXEC-LGORT = LF_MARD-LGORT.
* 保管場所種別
GF_EXEC-MPTRN = CNS_MARD_SEG.
* 保管場所名
* select number 43
SELECT SINGLE
LGOBE
FROM T001L
INTO (GF_EXEC-LNAME)
WHERE WERKS = LF_MARD-WERKS
AND LGORT = LF_MARD-LGORT.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001L SY-SUBRC.
ENDCASE.

* 棚番
GF_EXEC-LGPBE = LF_MARD-LGPBE.
* 数量
GF_EXEC-NUM = LF_MARD-LABST.

ENDFORM.                    " FRM_SET_MSKA
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKU_ready
*&---------------------------------------------------------------------*
*     ２  MSKU設定　前処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKU_ready.

DATA:  LT_KUNNR TYPE TABLE OF TYP_KNA1,"取得用
LF_KUNNR TYPE TYP_KNA1.         "取得用構造

* 得意先取得--現テーブル SELECT NUMBER 47
SELECT KUNNR
FROM   MSKU
INTO CORRESPONDING FIELDS OF TABLE LT_KUNNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
GROUP BY KUNNR.

* 得意先取得--履歴テーブル SELECT NUMBER 48
SELECT KUNNR
FROM   MSKUH
APPENDING CORRESPONDING FIELDS OF TABLE LT_KUNNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
GROUP BY KUNNR.

* 得意先コードでソート
SORT LT_KUNNR BY KUNNR ASCENDING.

* 得意先ごとに期末在庫を求めるようにする
LOOP AT LT_KUNNR INTO LF_KUNNR.
GF_KUNNR_TMP = LF_KUNNR.
AT NEW KUNNR.
*     得意先特殊在庫当月末在庫設定
PERFORM FRM_SPECIFIC_MSKU.
ENDAT.
ENDLOOP.

ENDFORM.                    " FRM_SPECIFIC_MSKU_ready
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKU
*&---------------------------------------------------------------------*
*       ２　得意先特殊在庫（預託在庫）の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKU.

CLEAR: LT_MSKU,LF_MSKU.

* ①A指定会計期間でMSKUを検索
* select number 24
SELECT SINGLE
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKU
INTO CORRESPONDING FIELDS OF LF_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMSKUHを検索
* select number 25
SELECT SINGLE
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKUH
INTO CORRESPONDING FIELDS OF LF_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMSKUHから検索
* select number 26
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKUH
INTO CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMSKUから検索
* select number 27
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKU
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSKU IS INITIAL ).
*     ソート
SORT LT_MSKU BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKU INTO LF_MSKU.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMSKUHから検索
* select number 28
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKUH
INTO CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMSKUから検索
* select number 29
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKU
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSKU IS INITIAL ).
*     ソート
SORT LT_MSKU BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKU INTO LF_MSKU.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MSKU

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MSKU
*&---------------------------------------------------------------------*
*       MSKU詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MSKU.
* 保管場所
GF_EXEC-LGORT = LF_MSKU-KUNNR.
* 保管場所種別
GF_EXEC-MPTRN = CNS_MSKU_SEG.
* 保管場所名
* select number 45
*  SELECT SINGLE
*         NAME1
*         FROM KNA1
*         INTO (GF_EXEC-LNAME)
*         WHERE KUNNR = LF_MSKU-KUNNR.
*
** --- エラーチェック
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH SY-REPID CNS_KNA1 SY-SUBRC.
*  ENDCASE.

* 棚番(BLANK)
GF_EXEC-LGPBE = SPACE.
* 数量
GF_EXEC-NUM = LF_MSKU-KULAB.

ENDFORM.                    " FRM_SET_MSKU
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSLB_ready
*&---------------------------------------------------------------------*
*       MSLB設定　前処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSLB_ready.

DATA:  LT_LIFNR TYPE TABLE OF TYP_LFA1,"取得用
LF_LIFNR TYPE TYP_LFA1.         "取得用構造

* 仕入先取得--現テーブル SELECT NUMBER 49
SELECT LIFNR
FROM   MSLB
INTO CORRESPONDING FIELDS OF TABLE LT_LIFNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
GROUP BY LIFNR.

* 仕入先取得--履歴テーブル SELECT NUMBER 50
SELECT LIFNR
FROM   MSLBH
APPENDING CORRESPONDING FIELDS OF TABLE LT_LIFNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
GROUP BY LIFNR.

* 仕入先でソート
SORT LT_LIFNR BY LIFNR ASCENDING.

* 仕入先ごとに期末在庫を求めるようにする
LOOP AT LT_LIFNR INTO LF_LIFNR.
GF_LIFNR_TMP = LF_LIFNR.
AT NEW LIFNR.
*     仕入先特殊在庫設定
PERFORM FRM_SPECIFIC_MSLB.
ENDAT.
ENDLOOP.

ENDFORM.                    " FRM_SPECIFIC_MSLB_ready
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSLB
*&---------------------------------------------------------------------*
*       ３仕入先特殊在庫（支給品）の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSLB.

CLEAR: LT_MSLB,LF_MSLB.
* ①A指定会計期間でMSLBを検索
* select number 30
SELECT SINGLE
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLB
INTO CORRESPONDING FIELDS OF LF_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMSLBHを検索
* select number 31
SELECT SINGLE
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLBH
INTO CORRESPONDING FIELDS OF LF_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMSLBHから検索
* select number 32
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLBH
INTO CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMSLBから検索
* select number 33
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLB
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSLB IS INITIAL ).
*     ソート
SORT LT_MSLB BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSLB INTO LF_MSLB.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMSLBHから検索
* select number 34
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLBH
INTO CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMSLBから検索
* select number 35
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLB
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSLB IS INITIAL ).
*     ソート
SORT LT_MSLB BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSLB INTO LF_MSLB.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MSLB

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MSLB
*&---------------------------------------------------------------------*
*       MSLB詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MSLB.
* 保管場所
GF_EXEC-LGORT = LF_MSLB-LIFNR.
* 保管場所種別
GF_EXEC-MPTRN = CNS_MSLB_SEG.
* 保管場所名
** select number 46
*  SELECT SINGLE
*         NAME1
*         FROM LFA1
*         INTO (GF_EXEC-LNAME)
*         WHERE LIFNR = LF_MSLB-LIFNR.
*
** --- エラーチェック
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH SY-REPID CNS_LFA1 SY-SUBRC.
*  ENDCASE.

* 棚番(BLANK)
GF_EXEC-LGPBE = SPACE.
* 数量
GF_EXEC-NUM = LF_MSLB-LBLAB.

ENDFORM.                    " FRM_SET_MSLB
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MARC
*&---------------------------------------------------------------------*
*       ４転送中在庫の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MARC.

CLEAR: LT_MARC,LF_MARC.
* ①A指定会計期間でMARCを検索
* select number 36
SELECT SINGLE
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARC
INTO CORRESPONDING FIELDS OF LF_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMARCHを検索
* select number 37
SELECT SINGLE
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARCH
INTO CORRESPONDING FIELDS OF LF_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMARCHから検索
* select number 38
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARCH
INTO CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMARCから検索
* select number 39
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARC
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARC IS INITIAL ).
*     ソート
SORT LT_MARC BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARC INTO LF_MARC.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMARCHから検索
* select number 40
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARCH
INTO CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMARCから検索
* select number 41
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARC
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARC IS INITIAL ).
*     ソート
SORT LT_MARC BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARC INTO LF_MARC.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MARC

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MARC
*&---------------------------------------------------------------------*
*       MARC詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MARC.
* 保管場所(BLANK)
GF_EXEC-LGORT = SPACE.
* 保管場所種別
GF_EXEC-MPTRN = CNS_MARC_SEG.
* 保管場所名(転送中)
GF_EXEC-LNAME = TEXT-071.
* 棚番(BLANK)
GF_EXEC-LGPBE = SPACE.
* 数量
GF_EXEC-NUM = LF_MARC-TRAME.

ENDFORM.                    " FRM_SET_MARC
*&---------------------------------------------------------------------*
*&      Form  FRM_COMPUTE
*&---------------------------------------------------------------------*
*       集計処理
*----------------------------------------------------------------------*
FORM FRM_COMPUTE.
DATA: LF_MATNR_BREAK TYPE C."品目コードブレイクフラグ
DATA: L_CNT_EXEC TYPE I."EXEC取得件数

SORT GT_EXEC BY BUKRS ASCENDING  "会社コード
BWKEY ASCENDING  "プラントコード
MATNR ASCENDING  "品目コード
MPTRN ASCENDING  "保管場所種別
LGORT ASCENDING  "保管場所コード
LGPBE DESCENDING."棚番

*---MODIFY START NDSC R.SHINAMI 2009/02/02 ---------------------------*
* 在庫数量０ははじく
* DELETE GT_EXEC WHERE NUM = 0.
* 在庫評価額０に変更
DELETE GT_EXEC WHERE SALK3 = 0.
*---MODIFY END NDSC R.SHINAMI 2009/02/02 ---------------------------*

* 総合計初期化
CLEAR GW_TOTAL.

* 取得件数(0件チェック)
DESCRIBE TABLE GT_EXEC LINES L_CNT_EXEC.
IF L_CNT_EXEC = 0.
MESSAGE S616(Z1).
STOP.
ENDIF.

* 処理用ループ（集計処理）
LOOP AT GT_EXEC INTO GF_EXEC.
*   一時退避
GF_EXEC_TMP = GF_EXEC.
*   プラントブレイクごとに主要項目設定
AT NEW BWKEY.
PERFORM FRM_KEY_SET.
ENDAT.
*   在庫集計
PERFORM FRM_COMPUTE_MATERIAL.
*   在庫合計集計(品目ごとに集計)
AT END OF MATNR.
PERFORM FRM_SALK3.
ENDAT.
*   出力用内部ＴＢＬに追加
AT END OF BWKEY.
APPEND GF_OUTPUT TO GT_OUTPUT.
*     --------------------------------------------------------------*
*     デバッグ用
*      PERFORM FRM_TEST_WRITE_MAIN.
*     --------------------------------------------------------------*
*     初期化処理
CLEAR GF_OUTPUT.
ENDAT.
*   ----------------------------------------------------------------*
*   デバッグ用
*   PERFORM FRM_TEST_WRITE.
*   ----------------------------------------------------------------*
ENDLOOP.

* ------------------------------------------------------------------*
* デバッグ用合計行
*  PERFORM FRM_TEST_TOTAL.
* ------------------------------------------------------------------*

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  FRM_CURRENCY_AMOUNT
*&---------------------------------------------------------------------*
*       金額変換処理
*----------------------------------------------------------------------*
*      -->P_WAERS    通貨コード
*      -->P_BEFORE   変換前金額
*      <--P_AFTER    変換後金額
*----------------------------------------------------------------------*
FORM FRM_CURRENCY_AMOUNT             USING    P_WAERS
P_BEFORE
CHANGING P_AFTER.
DATA L_IDOC_AMOUNT(255) TYPE C.
*--- 汎用モジュール金額変換モジュール
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = P_WAERS
SAP_AMOUNT  = P_BEFORE
IMPORTING
IDOC_AMOUNT = L_IDOC_AMOUNT
EXCEPTIONS
OTHERS      = 1.
IF SY-SUBRC <> 1.
P_AFTER = L_IDOC_AMOUNT.
ENDIF.

ENDFORM.                    " FRM_CURRENCY_AMOUNT
*&---------------------------------------------------------------------*
*&      Form  FRM_KEY_SET
*&---------------------------------------------------------------------*
*       主要項目設定（会社コード／プラント　ごと）
*----------------------------------------------------------------------*
FORM FRM_KEY_SET.

GF_OUTPUT-BUKRS = GF_EXEC_TMP-BUKRS.
GF_OUTPUT-BWKEY = GF_EXEC_TMP-BWKEY.
GF_OUTPUT-LFGJA = GF_EXEC_TMP-LFGJA.
GF_OUTPUT-LFMON = GF_EXEC_TMP-LFMON.
GF_OUTPUT-BUTXT = GF_EXEC_TMP-BUTXT.
GF_OUTPUT-PNAME = GF_EXEC_TMP-PNAME.

ENDFORM.                    " FRM_KEY_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_COMPUTE_MATERIAL
*&---------------------------------------------------------------------*
*      在庫集計
*----------------------------------------------------------------------*
FORM FRM_COMPUTE_MATERIAL.
DATA:L_COST(9) TYPE P.

L_COST = GF_EXEC_TMP-UNTCT * GF_EXEC_TMP-NUM.

CASE GF_EXEC-MPTRN.
WHEN '1'."出荷準備品
GF_OUTPUT-MSKA = GF_OUTPUT-MSKA + L_COST.
GF_TOTAL-MSKA  = GF_TOTAL-MSKA  + L_COST.
WHEN '2'."支店在庫品
GF_OUTPUT-MARD = GF_OUTPUT-MARD + L_COST.
GF_TOTAL-MARD  = GF_TOTAL-MARD  + L_COST.
WHEN '3'."転送中在庫品
GF_OUTPUT-MARC = GF_OUTPUT-MARC + L_COST.
GF_TOTAL-MARC  = GF_TOTAL-MARC  + L_COST.
WHEN '4'."預託先在庫品
GF_OUTPUT-MSKU = GF_OUTPUT-MSKU + L_COST.
GF_TOTAL-MSKU  = GF_TOTAL-MSKU  + L_COST.
WHEN '5'."支給品在庫品
GF_OUTPUT-MSLB = GF_OUTPUT-MSLB + L_COST.
GF_TOTAL-MSLB  = GF_TOTAL-MSLB  + L_COST.
ENDCASE.

ENDFORM.                    " FRM_COMPUTE_MATERIAL
*&---------------------------------------------------------------------*
*&      Form  FRM_SALK3
*&---------------------------------------------------------------------*
*       在庫金額
*----------------------------------------------------------------------*
FORM FRM_SALK3.

GF_OUTPUT-SALK3 = GF_OUTPUT-SALK3 + GF_EXEC_TMP-SALK3.
GF_TOTAL-SALK3  = GF_TOTAL-SALK3  + GF_EXEC_TMP-SALK3.

ENDFORM.                    " FRM_SALK3
*&---------------------------------------------------------------------*
*&      Form  FRM_OUTPUT
*&---------------------------------------------------------------------*
*       帳票出力処理
*----------------------------------------------------------------------*
FORM FRM_OUTPUT.

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (SKY BLUE)
FORMAT COLOR COL_NORMAL ON INTENSIFIED.
* ITEM HEADER （テキスト）
ENDIF.

LOOP AT GT_OUTPUT INTO GF_OUTPUT.
WRITE:  /0 GF_OUTPUT-BWKEY,
7 GF_OUTPUT-PNAME,
39 GF_OUTPUT-MSKA,
59 GF_OUTPUT-MARD,
78 GF_OUTPUT-MARC,
97 GF_OUTPUT-MSKU,
116 GF_OUTPUT-MSLB,
136 GF_OUTPUT-SALK3.
ENDLOOP.

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SETING BLUE
FORMAT COLOR OFF.
ENDIF.

* 総合計出力
PERFORM FRM_OUTPUT_TOTAL.

ENDFORM.                    " FRM_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  FRM_OUTPUT_TOTAL
*&---------------------------------------------------------------------*
*       総合計の出力
*----------------------------------------------------------------------*
FORM FRM_OUTPUT_TOTAL.
* 線を引く
ULINE.
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (yellow)
FORMAT COLOR COL_TOTAL ON INTENSIFIED.
* ITEM HEADER （テキスト）
ENDIF.

WRITE: /07  TEXT-073,"総合計
39  GF_TOTAL-MSKA,
59  GF_TOTAL-MARD,
78  GF_TOTAL-MARC,
97  GF_TOTAL-MSKU,
116 GF_TOTAL-MSLB,
136 GF_TOTAL-SALK3,
153 SPACE.

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SETING BLUE
FORMAT COLOR OFF.
ENDIF.

ENDFORM.                    " FRM_OUTPUT_TOTAL
*&---------------------------------------------------------------------*
*&      Form  FRM_CHANGED_CLYEAR_AND_MONTH
*&---------------------------------------------------------------------*
*       指定計上年月→会計期間に変換
*----------------------------------------------------------------------*
FORM FRM_CHANGED_CLYEAR_AND_MONTH.
* 指定計上年月→会計期間に変換

PERFORM FRM_CHANGE_CLTOFI USING    PR_LFGJA
PR_LFMON
CHANGING PR_LFGJA
PR_LFMON.

ENDFORM.                    " FRM_CHANGED_CLYEAR_AND_MONTH
*&---------------------------------------------------------------------*
*&      Form  FRM_TEST_TOTAL
*&---------------------------------------------------------------------*
*       テスト出力（合計)（デバッグ）
*----------------------------------------------------------------------*
FORM FRM_TEST_TOTAL.

WRITE:/ GF_TOTAL-MSKA,
GF_TOTAL-MARD,
GF_TOTAL-MARC,
GF_TOTAL-MSKU,
GF_TOTAL-MSLB,
GF_TOTAL-SALK3.

ENDFORM.                    " FRM_TEST_TOTAL
*&---------------------------------------------------------------------*
*&      Form  FRM_TEST_WRITE
*&---------------------------------------------------------------------*
*       テスト出力(デバッグ)
*----------------------------------------------------------------------*
FORM FRM_TEST_HEAD_WRITE.

WRITE: /0 '会社',
6 'プラント ',
12 '品目 ',
24 '保管場所',
36 '在庫区分',
44 '会計年',
52 '会計月',
*           GF_EXEC-BUTXT,' ',
*           GF_EXEC-PNAME,' ',
60 '数量',
75 '単位',
90 '単価',
105 '在庫合計数量',
120 '在庫合計金額'.

ENDFORM.                    " FRM_TEST_WRITE
*&---------------------------------------------------------------------*
*&      Form  FRM_TEST_WRITE
*&---------------------------------------------------------------------*
*       テスト出力(デバッグ)
*----------------------------------------------------------------------*
FORM FRM_TEST_WRITE.

WRITE: /0 GF_EXEC-BUKRS,' ',
6 GF_EXEC-BWKEY,' ',
12 GF_EXEC-MATNR,' ',
24 GF_EXEC-LGORT,' ',
36 GF_EXEC-MPTRN,' ',
44 GF_EXEC-LFGJA,' ',
52 GF_EXEC-LFMON,' ',
*           GF_EXEC-BUTXT,' ',
*           GF_EXEC-PNAME,' ',
60 GF_EXEC-NUM  ,' ',
78 GF_EXEC-MEINS,' ',
90 GF_EXEC-UNTCT,' ',
107 GF_EXEC-LBKUM,' ',
122 GF_EXEC-SALK3.

ENDFORM.                    " FRM_TEST_WRITE
*&---------------------------------------------------------------------*
*&      Form  FRM_TEST_WRITE_MAIN
*&---------------------------------------------------------------------*
*       テスト出力(デバッグ)
*----------------------------------------------------------------------*
FORM FRM_TEST_WRITE_MAIN.

WRITE:  /0 GF_OUTPUT-BUKRS,
6 GF_OUTPUT-BWKEY,
20 GF_OUTPUT-MSKA,
35 GF_OUTPUT-MARD,
50 GF_OUTPUT-MARC,
65 GF_OUTPUT-MSLB,
90 GF_OUTPUT-SALK3.

ENDFORM.                    " FRM_TEST_WRITE
***** 2016/9/26 isid18 ins start *****
*&---------------------------------------------------------------------*
*&      Form  FRM_ADJUST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_ADJUST .

TYPES:
BEGIN OF TY_SORT,
MONEY(9) TYPE P,
END OF TY_SORT.

DATA:
LTB_SORT TYPE STANDARD TABLE OF TY_SORT,
LST_SORT TYPE TY_SORT,
LW_SORT(9) TYPE P,
LW_ADJUST(9)   TYPE P.          "出荷準備品

FIELD-SYMBOLS: <FS_OUTPUT> TYPE TYP_ZM011200_WRITE.

CLEAR:
GF_TOTAL-MSKA,
GF_TOTAL-MARD,
GF_TOTAL-MARC,
GF_TOTAL-MSKU,
GF_TOTAL-MSLB.

LOOP AT GT_OUTPUT ASSIGNING <FS_OUTPUT>.

*    差額計算
LW_ADJUST = <FS_OUTPUT>-SALK3 - <FS_OUTPUT>-MSKA
- <FS_OUTPUT>-MARD - <FS_OUTPUT>-MARC
- <FS_OUTPUT>-MSKU - <FS_OUTPUT>-MSLB.

CLEAR:
LST_SORT,
LTB_SORT.

*    最大値探し
LST_SORT-MONEY = <FS_OUTPUT>-MSKA.
APPEND LST_SORT TO LTB_SORT.
LST_SORT-MONEY = <FS_OUTPUT>-MARD.
APPEND LST_SORT TO LTB_SORT.
LST_SORT-MONEY = <FS_OUTPUT>-MARC.
APPEND LST_SORT TO LTB_SORT.
LST_SORT-MONEY = <FS_OUTPUT>-MSKU.
APPEND LST_SORT TO LTB_SORT.
LST_SORT-MONEY = <FS_OUTPUT>-MSLB.
APPEND LST_SORT TO LTB_SORT.

SORT LTB_SORT BY MONEY DESCENDING.
READ TABLE LTB_SORT INTO LST_SORT INDEX 1.
LW_SORT = LST_SORT-MONEY.

*    差額調整
CASE LW_SORT.
WHEN <FS_OUTPUT>-MSKA.
<FS_OUTPUT>-MSKA = <FS_OUTPUT>-MSKA + LW_ADJUST.
WHEN <FS_OUTPUT>-MARD.
<FS_OUTPUT>-MARD = <FS_OUTPUT>-MARD + LW_ADJUST.
WHEN <FS_OUTPUT>-MARC.
<FS_OUTPUT>-MARC = <FS_OUTPUT>-MARC + LW_ADJUST.
WHEN <FS_OUTPUT>-MSKU.
<FS_OUTPUT>-MSKU = <FS_OUTPUT>-MSKU + LW_ADJUST.
WHEN <FS_OUTPUT>-MSLB.
<FS_OUTPUT>-MSLB = <FS_OUTPUT>-MSLB + LW_ADJUST.
ENDCASE.

*    合計行再計算
GF_TOTAL-MSKA = GF_TOTAL-MSKA + <FS_OUTPUT>-MSKA.
GF_TOTAL-MARD = GF_TOTAL-MARD + <FS_OUTPUT>-MARD.
GF_TOTAL-MARC = GF_TOTAL-MARC + <FS_OUTPUT>-MARC.
GF_TOTAL-MSKU = GF_TOTAL-MSKU + <FS_OUTPUT>-MSKU.
GF_TOTAL-MSLB = GF_TOTAL-MSLB + <FS_OUTPUT>-MSLB.
ENDLOOP.

ENDFORM.                    " FRM_ADJUST
***** 2016/9/26 isid18 ins end *****
