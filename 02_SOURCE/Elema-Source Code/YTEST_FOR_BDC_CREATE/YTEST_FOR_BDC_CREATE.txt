*&---------------------------------------------------------------------*
*& Report  YTEST_FOR_BDC_CREATE
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  YTEST_FOR_BDC_CREATE
MESSAGE-ID 00 LINE-SIZE 200
NO STANDARD PAGE HEADING.

* ### 01 00 YR990003
* ### 02 00 2003/08/27
* ### 03 00 YourSoft
* ### 04 01 トランザクションを記録し、バッチインプットインターフェース
* ### 04 02 を作成する
* ### 05 01 S DD03L
* ### 05 02 S DD04T
* ### 05 03 S TSTC

* ### 90 00 2007/05/16
* ### 90 01 Yoursoft-27031
* ### 90 02 B/I実行オプションの記録漏れ(CATTモード)
* ### 90 03 B/I実行オプションの出力位置桁ずれ

* ### 91 00 2008/11/10
* ### 91 01 Yoursoft-A0135
* ### 91 02 ドライブ変換フラグの判断追加

* ### 92 00 2009/03/31
* ### 92 01 Yoursoft-93354
* ### 92 02 テキストエレメント修正（英語・日本語）

* ### 93 00 2009/10/06
* ### 93 01 Yoursoft-77031
* ### 93 02 ダウンロードファイル名を小文字に統一

* ### 94 00 2010/07/05
* ### 94 01 Yoursoft11
* ### 94 02 Y_WS_DOWNLOADでCODEPAGEを再取得しているため、引数をコメント

* ### 95 00 2012/11/14
* ### 95 01 Yoursoft-A0161
* ### 95 02 拡張プログラムチェック対応

***** REALMODEL Excel連携ツール利用の場合******************************
* 以下のコメントが入っているところを変更して下さい
* "<-- Update1：PC内の作業ﾃﾞｨﾚｸﾄﾘ
***********************************************************************

*-----------------------------------------------------------------------
*     テーブルの定義
*-----------------------------------------------------------------------
TABLES: DD03L,
DD04T,
TSTC.

*-----------------------------------------------------------------------
*     画面パラメータの設定
*-----------------------------------------------------------------------
PARAMETERS: P_TRAN LIKE TSTC-TCODE.

SELECTION-SCREEN SKIP 1.

SELECTION-SCREEN BEGIN OF BLOCK SB1
WITH FRAME TITLE TEXT-001.
PARAMETERS: P_CURSOR AS   CHECKBOX DEFAULT 'X',
P_EXCEL  AS   CHECKBOX DEFAULT 'X',
P_SIYOU  AS   CHECKBOX DEFAULT 'X',
P_PCDIR(128) TYPE C
DEFAULT
'\r3local\'  "<-- Update1：PC内の作業ﾃﾞｨﾚｸﾄﾘ
LOWER CASE OBLIGATORY.
PARAMETERS: P_CYOFU AS   CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN END OF BLOCK SB1.

SELECTION-SCREEN BEGIN OF BLOCK SB2
WITH FRAME TITLE TEXT-002.
PARAMETERS: P_NOBINP LIKE CTU_PARAMS-NOBINPT, "DEFAULT 'X',
P_DEFSIZ LIKE CTU_PARAMS-DEFSIZE, "DEFAULT 'X',
P_RACOMM LIKE CTU_PARAMS-RACOMMIT,
P_NOBIEN LIKE CTU_PARAMS-NOBIEND,
P_CATT   LIKE CTU_PARAMS-CATTMODE.
SELECTION-SCREEN END OF BLOCK SB2.

*-----------------------------------------------------------------------
*     グローバル変数
*-----------------------------------------------------------------------
DATA: BEGIN OF BDCDATA OCCURS 0.
INCLUDE STRUCTURE BDCDATA.
DATA: END OF BDCDATA.

DATA: BEGIN OF OUT_REC OCCURS 0,
W_SIKIBETU(1),
W_MSG_FLG(1),
W_FNAM(35),
W_FVAL(100),
END OF OUT_REC.

DATA: BEGIN OF XLS_REC OCCURS 0,
XLS_ROW(2000),
END OF XLS_REC.

DATA: W_OPTIONS LIKE CTU_PARAMS.

DATA: BEGIN OF HEADER_REC OCCURS 0,
W_HEADER(30),
END OF HEADER_REC.

* ### 91 START ###
DATA: FLG_DRIVE TYPE C.                "ドライブフラグ
* ### 91 END ###

*-----------------------------------------------------------------------
*     start-of-selection
*-----------------------------------------------------------------------
START-OF-SELECTION.
PERFORM GAMEN_CHECK.
PERFORM TRAN_RECORDING.
PERFORM BI_EDIT.
PERFORM BI_DOWNLOAD.
PERFORM XLS_EDIT.
PERFORM XLS_DOWNLOAD.

*-----------------------------------------------------------------------
*     gamen_check
*-----------------------------------------------------------------------
FORM GAMEN_CHECK.

SELECT SINGLE * FROM TSTC
WHERE TCODE = P_TRAN.
IF SY-SUBRC <> 0.
* ### 95 START ###
*    MESSAGE S398 WITH TEXT-E01.
MESSAGE S398 WITH TEXT-E01 SPACE SPACE SPACE.
* ### 95 END   ###
"未定義のトランザクションを指定しています
STOP.
ENDIF.

ENDFORM.                    "GAMEN_CHECK

*-----------------------------------------------------------------------
*     tran_recording
*-----------------------------------------------------------------------
FORM TRAN_RECORDING.

W_OPTIONS-DISMODE  = 'A'.
W_OPTIONS-UPDMODE  = 'A'.
W_OPTIONS-NOBINPT  = P_NOBINP.
W_OPTIONS-DEFSIZE  = P_DEFSIZ.
W_OPTIONS-RACOMMIT = P_RACOMM.
W_OPTIONS-NOBIEND  = P_NOBIEN.
W_OPTIONS-CATTMODE = P_CATT.

CALL FUNCTION 'BDC_RECORD_TRANSACTION'
EXPORTING
TCODE               = P_TRAN
AUTHORITY_CHECK     = 'X'
OPTIONS             = W_OPTIONS
*           MODE                = 'A'
*           UPDATE              = 'A'
TABLES
DYNPROTAB           = BDCDATA
EXCEPTIONS
* ### 95 START ###
*            SYSTEM_FAILURE      = 1
*            INVALID_TRANSACTION = 2
*            INVALID_MODE        = 3
*            INVALID_UPDATE      = 4
*            OTHERS              = 5.
OTHERS              = 0.
* ### 95 END   ###

ENDFORM.                    "TRAN_RECORDING

*-----------------------------------------------------------------------
*     bi_edit
*-----------------------------------------------------------------------
FORM BI_EDIT.

DATA: W_BDC_OKCODE(73),
W_HBDC_CHECK(5).

REFRESH OUT_REC.

IF P_NOBINP = 'X'. "手入力モードがONの場合は｢H｣を設定
CONCATENATE 'H' W_HBDC_CHECK INTO W_HBDC_CHECK.
ENDIF.

IF P_DEFSIZ = 'X'. "デフォルト　DynproサイズがONの場合は｢D｣を設定
CONCATENATE 'D' W_HBDC_CHECK INTO W_HBDC_CHECK.
ENDIF.

IF P_RACOMM = 'X'. "COMMIT WORKで終了しないがONの場合は｢C｣を設定
CONCATENATE 'C' W_HBDC_CHECK INTO W_HBDC_CHECK.
ENDIF.

IF P_NOBIEN = 'X'. "BDCデータ後はB/IモードなしがONの場合は｢B｣を設定
CONCATENATE 'B' W_HBDC_CHECK INTO W_HBDC_CHECK.
ENDIF.

IF NOT P_CATT IS INITIAL.   "CATTモードの指定がある場合は指定値を設定
CONCATENATE P_CATT W_HBDC_CHECK INTO W_HBDC_CHECK.
ENDIF.

LOOP AT BDCDATA.

CHECK BDCDATA-FNAM <> 'BDC_SUBSCR'.

CLEAR OUT_REC.

CASE BDCDATA-DYNBEGIN.
WHEN 'T'.
OUT_REC-W_SIKIBETU = '0'.
OUT_REC-W_FNAM     = BDCDATA-FNAM.
OUT_REC-W_FVAL     = W_HBDC_CHECK.
APPEND OUT_REC.
WHEN 'X'.
IF NOT W_BDC_OKCODE IS INITIAL.
OUT_REC-W_SIKIBETU = '2'.
OUT_REC-W_FNAM     = 'BDC_OKCODE'.
OUT_REC-W_FVAL     = W_BDC_OKCODE.
APPEND OUT_REC.
ENDIF.
OUT_REC-W_SIKIBETU = '1'.
OUT_REC-W_FNAM     = BDCDATA-PROGRAM.
OUT_REC-W_FVAL     = BDCDATA-DYNPRO.
APPEND OUT_REC.
WHEN SPACE.
IF BDCDATA-FNAM = 'BDC_OKCODE'.
W_BDC_OKCODE = BDCDATA-FVAL.
ELSE.
IF P_CURSOR = 'X' AND BDCDATA-FNAM = 'BDC_CURSOR'.
ELSE.
OUT_REC-W_SIKIBETU = '2'.
OUT_REC-W_FNAM     = BDCDATA-FNAM.
OUT_REC-W_FVAL     = BDCDATA-FVAL.
APPEND OUT_REC.
ENDIF.
ENDIF.
ENDCASE.

ENDLOOP.

IF NOT W_BDC_OKCODE IS INITIAL.
CLEAR OUT_REC.
OUT_REC-W_SIKIBETU = '2'.
OUT_REC-W_FNAM     = 'BDC_OKCODE'.
OUT_REC-W_FVAL     = W_BDC_OKCODE.
APPEND OUT_REC.
ENDIF.

CLEAR OUT_REC.
OUT_REC-W_SIKIBETU = '3'.
APPEND OUT_REC.

DATA: BEGIN OF CYOUFUKU_CHECK OCCURS 0,
W_PROGRAM(35),
W_DYNPRO(73),
W_FNAM(35),
W_FVAL(73),
END OF CYOUFUKU_CHECK.
DATA: X_PROGRAM(35),
X_DYNPRO(73),
W_CYOUFUKU(1).

LOOP AT OUT_REC WHERE W_SIKIBETU = '1' OR
W_SIKIBETU = '2'.
IF OUT_REC-W_SIKIBETU = '1'.
X_PROGRAM = OUT_REC-W_FNAM.
X_DYNPRO  = OUT_REC-W_FVAL.
ENDIF.

IF OUT_REC-W_SIKIBETU = '2' AND
OUT_REC-W_FNAM <> 'BDC_OKCODE'.

CLEAR W_CYOUFUKU.
LOOP AT CYOUFUKU_CHECK.
IF CYOUFUKU_CHECK-W_PROGRAM = X_PROGRAM AND
CYOUFUKU_CHECK-W_DYNPRO  = X_DYNPRO  AND
CYOUFUKU_CHECK-W_FNAM    = OUT_REC-W_FNAM.
W_CYOUFUKU = 'Y'.
EXIT.
ENDIF.
ENDLOOP.

CLEAR CYOUFUKU_CHECK.
CYOUFUKU_CHECK-W_PROGRAM = X_PROGRAM.
CYOUFUKU_CHECK-W_DYNPRO  = X_DYNPRO.
CYOUFUKU_CHECK-W_FNAM    = OUT_REC-W_FNAM.
CYOUFUKU_CHECK-W_FVAL    = OUT_REC-W_FVAL.
APPEND CYOUFUKU_CHECK.

IF W_CYOUFUKU = 'Y' AND P_CYOFU = 'X'.
DELETE OUT_REC.
ENDIF.
ENDIF.

ENDLOOP.

ENDFORM.                    "BI_EDIT

*-----------------------------------------------------------------------
*     data_download_header
*-----------------------------------------------------------------------
* ### 95 START ###
*FORM DATA_DOWNLOAD_HEADER USING P_HEADER.
FORM DATA_DOWNLOAD_HEADER USING P_HEADER TYPE ANY.
* ### 95 END   ###
CLEAR HEADER_REC.
HEADER_REC-W_HEADER = P_HEADER.
CONDENSE HEADER_REC-W_HEADER.
APPEND HEADER_REC.
ENDFORM.                    "DATA_DOWNLOAD_HEADER

*-----------------------------------------------------------------------
*     bi_download
*-----------------------------------------------------------------------
FORM BI_DOWNLOAD.

DATA: BEGIN OF SIYOUSYO_REC OCCURS 0,
W_SIKIBETU(1),
W_MSG_FLG(1),
W_FNAM(35),
W_FVAL(73),
W_DDTEXT   LIKE DD04T-DDTEXT,
W_INTTYPE  LIKE DD03L-INTTYPE,
W_LENG(6),
W_DECIMALS(6),
END OF SIYOUSYO_REC.

DATA: OLENGTH    TYPE I,
OFILE(128) TYPE C.

CHECK P_SIYOU = 'X'.

LOOP AT OUT_REC.
CLEAR SIYOUSYO_REC.
MOVE-CORRESPONDING OUT_REC TO SIYOUSYO_REC.
IF OUT_REC-W_SIKIBETU  = '2'          AND
OUT_REC-W_FNAM     <> 'BDC_OKCODE' AND
OUT_REC-W_FNAM     <> 'BDC_CURSOR'.
PERFORM GET_FIELD_INFO USING OUT_REC-W_FNAM
SIYOUSYO_REC-W_DDTEXT
SIYOUSYO_REC-W_INTTYPE
SIYOUSYO_REC-W_LENG
SIYOUSYO_REC-W_DECIMALS.
IF SIYOUSYO_REC-W_DECIMALS = '000000'.
SIYOUSYO_REC-W_DECIMALS = SPACE.
ENDIF.
ENDIF.
APPEND SIYOUSYO_REC.
ENDLOOP.

PERFORM DATA_DOWNLOAD_HEADER USING:
TEXT-H01, TEXT-H02, TEXT-H03, TEXT-H04,
TEXT-H05, TEXT-H06, TEXT-H07, TEXT-H08.

CONCATENATE P_PCDIR P_TRAN '_BI.TXT' INTO OFILE.
* ### 93 START ###
TRANSLATE OFILE TO LOWER CASE.
* ### 93 END ###

IF OFILE+1(1) = ':'.
TRANSLATE OFILE+2(126) USING '/~:~?~<~>~'.
ELSE.
TRANSLATE OFILE USING '/~:~?~<~>~'.
ENDIF.

* ### 91 START ###
"ドライブフラグの取得
IF OFILE+1(1) = ':'.
FLG_DRIVE = 'X'.
ELSE.
CLEAR FLG_DRIVE.
ENDIF.
* ### 91 END ###

CALL FUNCTION 'Y_WS_DOWNLOAD'
EXPORTING
* ### 94 START ###A
*      CODEPAGE            = 'IBM'
* ### 94 END ###A
FILENAME            = OFILE
FILETYPE            = 'DAT'
* ### 91 START ###
NOT_DRIVE_CHANGE    = FLG_DRIVE
* ### 91 END ###
IMPORTING
FILELENGTH          = OLENGTH
TABLES
DATA_TAB            = SIYOUSYO_REC
FIELDNAMES          = HEADER_REC
EXCEPTIONS
* ### 95 START ###
*      FILE_OPEN_ERROR     = 1
*      FILE_WRITE_ERROR    = 2
*      INVALID_FILESIZE    = 3
*      INVALID_TABLE_WIDTH = 4
*      INVALID_TYPE        = 5
*      NO_BATCH            = 6
*      UNKNOWN_ERROR       = 7
*      OTHERS              = 8.
FILE_WRITE_ERROR         = 1
NO_BATCH                 = 2
GUI_REFUSE_FILETRANSFER  = 3
INVALID_TYPE             = 4
NO_AUTHORITY             = 5
UNKNOWN_ERROR            = 6
HEADER_NOT_ALLOWED       = 7
SEPARATOR_NOT_ALLOWED    = 8
FILESIZE_NOT_ALLOWED     = 9
HEADER_TOO_LONG          = 10
DP_ERROR_CREATE          = 11
DP_ERROR_SEND            = 12
DP_ERROR_WRITE           = 13
UNKNOWN_DP_ERROR         = 14
ACCESS_DENIED            = 15
DP_OUT_OF_MEMORY         = 16
DISK_FULL                = 17
DP_TIMEOUT               = 18
FILE_NOT_FOUND           = 19
DATAPROVIDER_EXCEPTION   = 20
CONTROL_FLUSH_ERROR      = 21
OTHERS                   = 22.
* ### 95 END   ###

IF SY-SUBRC <> 0.
* ### 95 START ###
*    MESSAGE S398 WITH OFILE TEXT-E02.
MESSAGE S398 WITH OFILE TEXT-E02 SPACE SPACE.
* ### 95 END   ###
"をダウンロード出来ません
STOP.
ENDIF.

ENDFORM.                    "BI_DOWNLOAD

*-----------------------------------------------------------------------
*     xls_edit
*-----------------------------------------------------------------------
FORM XLS_EDIT.

CLASS CL_ABAP_CHAR_UTILITIES DEFINITION LOAD.
DATA: XLS_ROW_0(2000),
XLS_ROW_1(2000),
XLS_ROW_2(2000),
XLS_ROW_3(2000),
XLS_ROW_4(2000),
XLS_ROW_5(2000),
XLS_ROW_6(2000),
XLS_ROW_7(2000),
XLS_ROW_8(2000),
TAB_ICHIAWASE(2000),
DATA_ARI(1),
TAB TYPE C VALUE CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB,
W_DDTEXT   LIKE DD04T-DDTEXT,
W_INTTYPE  LIKE DD03L-INTTYPE,
W_LENG     LIKE DD03L-LENG,
W_DECIMALS LIKE DD03L-DECIMALS.

LOOP AT OUT_REC.
CASE OUT_REC-W_SIKIBETU.
WHEN '0'.
XLS_ROW_1+0(35) = OUT_REC-W_FNAM.
XLS_ROW_1+35(5) = OUT_REC-W_FVAL.
WHEN '1'.
CONCATENATE XLS_ROW_2 OUT_REC-W_FNAM INTO XLS_ROW_2.
CONCATENATE XLS_ROW_3 OUT_REC-W_FVAL INTO XLS_ROW_3.
CLEAR DATA_ARI.
WHEN '2'.
IF OUT_REC-W_FNAM = 'BDC_OKCODE'.
IF DATA_ARI = 'Y'.
CONCATENATE XLS_ROW_2 TAB_ICHIAWASE INTO XLS_ROW_2.
CONCATENATE XLS_ROW_3 TAB_ICHIAWASE INTO XLS_ROW_3.
CONCATENATE XLS_ROW_4 OUT_REC-W_FVAL
TAB_ICHIAWASE INTO XLS_ROW_4.
ELSE.
CONCATENATE XLS_ROW_0 TAB INTO XLS_ROW_0.
CONCATENATE XLS_ROW_2 TAB INTO XLS_ROW_2.
CONCATENATE XLS_ROW_3 TAB INTO XLS_ROW_3.
CONCATENATE XLS_ROW_4 OUT_REC-W_FVAL TAB INTO XLS_ROW_4.
CONCATENATE XLS_ROW_5 TAB INTO XLS_ROW_5.
CONCATENATE XLS_ROW_6 TAB INTO XLS_ROW_6.
CONCATENATE XLS_ROW_7 TAB INTO XLS_ROW_7.
ENDIF.
CLEAR TAB_ICHIAWASE.
ELSE.  "BDC_OKCODE でないデータの場合
DATA_ARI = 'Y'.
CONCATENATE XLS_ROW_5 OUT_REC-W_FNAM TAB INTO XLS_ROW_5.

PERFORM GET_FIELD_INFO USING OUT_REC-W_FNAM
W_DDTEXT
W_INTTYPE
W_LENG
W_DECIMALS.

CONCATENATE XLS_ROW_6 W_DDTEXT TAB INTO XLS_ROW_6.
CASE W_INTTYPE.
WHEN 'I' OR 'b' OR 's' OR 'P' OR 'F'.
CONCATENATE XLS_ROW_0 W_DECIMALS TAB INTO XLS_ROW_0.
WHEN OTHERS.
CONCATENATE XLS_ROW_0 'S' TAB INTO XLS_ROW_0.
ENDCASE.

CONCATENATE XLS_ROW_7 OUT_REC-W_FVAL TAB INTO XLS_ROW_7.

CONCATENATE TAB_ICHIAWASE TAB INTO TAB_ICHIAWASE.
ENDIF.
WHEN '3'.
CONCATENATE XLS_ROW_5 'end' INTO XLS_ROW_5.
XLS_ROW_8 = 'eof'.
ENDCASE.
ENDLOOP.

APPEND: XLS_ROW_0 TO XLS_REC,
XLS_ROW_1 TO XLS_REC,
XLS_ROW_2 TO XLS_REC,
XLS_ROW_3 TO XLS_REC,
XLS_ROW_4 TO XLS_REC,
XLS_ROW_5 TO XLS_REC,
XLS_ROW_6 TO XLS_REC,
XLS_ROW_7 TO XLS_REC,
XLS_ROW_8 TO XLS_REC.

ENDFORM.                    "XLS_EDIT

*-----------------------------------------------------------------------
*     get_field_info
*-----------------------------------------------------------------------
FORM GET_FIELD_INFO
* ### 95 START ###
*     USING H_FNAM H_DDTEXT H_INTTYPE H_LENG H_DECIMALS.
USING H_FNAM     TYPE ANY
H_DDTEXT   TYPE ANY
H_INTTYPE  TYPE ANY
H_LENG     TYPE ANY
H_DECIMALS TYPE ANY.
* ### 95 END   ###

DATA: W_TABNAME   LIKE DD03L-TABNAME,
W_FIELDNAME LIKE DD03L-FIELDNAME,
W_DUMMY(1).

CLEAR: H_DDTEXT, H_INTTYPE, H_LENG, H_DECIMALS.

SPLIT H_FNAM AT '-' INTO W_TABNAME W_FIELDNAME.
SPLIT W_FIELDNAME    AT '(' INTO W_FIELDNAME W_DUMMY.
* ### 95 START ###
*  SELECT SINGLE * FROM DD03L
SELECT * FROM DD03L
UP TO 1 ROWS
* ### 95 END   ###
WHERE TABNAME   = W_TABNAME
AND FIELDNAME = W_FIELDNAME
AND AS4LOCAL  = 'A'
AND AS4VERS   = '0000'.
* ### 95 START ###
ENDSELECT.
* ### 95 END   ###
IF SY-SUBRC = 0.
CLEAR DD04T.
SELECT SINGLE * FROM DD04T
WHERE ROLLNAME = DD03L-ROLLNAME
AND DDLANGUAGE = SY-LANGU
AND AS4LOCAL = 'A'
AND AS4VERS = '0000'.
IF SY-SUBRC <> 0.  "ログオン言語テキストがなかったら
SELECT SINGLE * FROM DD04T
WHERE ROLLNAME = DD03L-ROLLNAME
AND DDLANGUAGE = 'E'
AND AS4LOCAL = 'A'
AND AS4VERS = '0000'.
ENDIF.
H_DDTEXT   = DD04T-DDTEXT.
H_INTTYPE  = DD03L-INTTYPE.
H_LENG     = DD03L-LENG.
H_DECIMALS = DD03L-DECIMALS.
ELSE.
H_DDTEXT    = '??????????'.
ENDIF.

ENDFORM.                    "GET_FIELD_INFO

*-----------------------------------------------------------------------
*     xls_download
*-----------------------------------------------------------------------
FORM XLS_DOWNLOAD.

DATA: OLENGTH    TYPE I,
OFILE(128) TYPE C.

CONCATENATE P_PCDIR 'bi_macro_data.txt' INTO OFILE.
* ### 93 START ###
TRANSLATE OFILE TO LOWER CASE.
* ### 93 END ###


* ### 91 START ###
"ドライブフラグの取得
IF OFILE+1(1) = ':'.
FLG_DRIVE = 'X'.
ELSE.
CLEAR FLG_DRIVE.
ENDIF.
* ### 91 END ###

CALL FUNCTION 'Y_WS_DOWNLOAD'
EXPORTING
* ### 94 START ###A
*      CODEPAGE            = 'IBM'
* ### 94 END ###A
FILENAME            = OFILE
FILETYPE            = 'ASC'
* ### 91 START ###
NOT_DRIVE_CHANGE    = FLG_DRIVE
* ### 91 END ###
IMPORTING
FILELENGTH          = OLENGTH
TABLES
DATA_TAB            = XLS_REC
EXCEPTIONS
* ### 95 START ###
*      FILE_OPEN_ERROR     = 1
*      FILE_WRITE_ERROR    = 2
*      INVALID_FILESIZE    = 3
*      INVALID_TABLE_WIDTH = 4
*      INVALID_TYPE        = 5
*      NO_BATCH            = 6
*      UNKNOWN_ERROR       = 7
*      OTHERS              = 8.
FILE_WRITE_ERROR         = 1
NO_BATCH                 = 2
GUI_REFUSE_FILETRANSFER  = 3
INVALID_TYPE             = 4
NO_AUTHORITY             = 5
UNKNOWN_ERROR            = 6
HEADER_NOT_ALLOWED       = 7
SEPARATOR_NOT_ALLOWED    = 8
FILESIZE_NOT_ALLOWED     = 9
HEADER_TOO_LONG          = 10
DP_ERROR_CREATE          = 11
DP_ERROR_SEND            = 12
DP_ERROR_WRITE           = 13
UNKNOWN_DP_ERROR         = 14
ACCESS_DENIED            = 15
DP_OUT_OF_MEMORY         = 16
DISK_FULL                = 17
DP_TIMEOUT               = 18
FILE_NOT_FOUND           = 19
DATAPROVIDER_EXCEPTION   = 20
CONTROL_FLUSH_ERROR      = 21
OTHERS                   = 22.
* ### 95 END   ###

IF SY-SUBRC <> 0.
* ### 95 START ###
*    MESSAGE S398 WITH OFILE TEXT-E02.
MESSAGE S398 WITH OFILE TEXT-E02 SPACE SPACE.
* ### 95 END   ###
"をダウンロード出来ません
STOP.
ENDIF.

IF P_EXCEL = 'X'.
CONCATENATE P_PCDIR 'bi_macro.xls' INTO OFILE.
*   ### 93 START ###
TRANSLATE OFILE TO LOWER CASE.
*   ### 93 END ###


* ### 91 START ###
"ドライブフラグの取得
IF OFILE+1(1) = ':'.
FLG_DRIVE = 'X'.
ELSE.
CLEAR FLG_DRIVE.
ENDIF.
* ### 91 END ###

CALL FUNCTION 'Y_R0003'
EXPORTING
COMMANDLINE    = OFILE
PROGRAM        = ''
* ### 91 START ###
NOT_DRIVE_CHANGE = FLG_DRIVE
* ### 91 END ###
EXCEPTIONS
* ### 95 START ###
*        FRONTEND_ERROR = 1
*        NO_BATCH       = 2
*        PROG_NOT_FOUND = 3
*        ILLEGAL_OPTION = 4
*        OTHERS         = 5.
CNTL_ERROR              = 1
ERROR_NO_GUI            = 2
BAD_PARAMETER           = 3
FILE_NOT_FOUND          = 4
PATH_NOT_FOUND          = 5
FILE_EXTENSION_UNKNOWN  = 6
ERROR_EXECUTE_FAILED    = 7
SYNCHRONOUS_FAILED      = 8
NOT_SUPPORTED_BY_GUI    = 9
OTHERS                  = 10.
* ### 95 END   ###

IF SY-SUBRC <> 0.
* ### 95 START ###
*      MESSAGE S398 WITH TEXT-E03.
MESSAGE S398 WITH TEXT-E03 SPACE SPACE SPACE.
* ### 95 END   ###
"EXCELを起動出来ません
STOP.
ENDIF.

ENDIF.

ENDFORM.                    "XLS_DOWNLOAD
