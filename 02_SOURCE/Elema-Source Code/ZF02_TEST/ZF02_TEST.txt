REPORT ZF02_TEST MESSAGE-ID  Y1
NO STANDARD PAGE HEADING.
************************************************************************
* プログラムID  :ZF
* プログラム名  :支払状況削除処理
* 作成日        :2008/03/26
* 作成者        :DMC
* 変更履歴      :
************************************************************************
*----------------------------------------------------------------------*
*     宣言部
*----------------------------------------------------------------------*
TABLES:     LFA1,                "仕入先マスタ (一般セクション)
ZF2020.              "支払状況テーブル
*----------------------------------------------------------------------*
*       テーブル定義                                                   *
*----------------------------------------------------------------------*
DATA: GT_ZF2020 TYPE TABLE OF ZF2020,
GW_ZF2020 TYPE ZF2020.
*----------------------------------------------------------------------*
*       変数定義                                                       *
*----------------------------------------------------------------------*
DATA:
W_DEL_CNT     TYPE I.              "削除件数カウント
*----------------------------------------------------------------------*
*     入力画面定義
*----------------------------------------------------------------------*
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-B01.
*仕入先
SELECT-OPTIONS: S_LIFNR FOR LFA1-LIFNR.
*支払依頼計上日
SELECT-OPTIONS: S_DATUM FOR SY-DATUM.
SELECTION-SCREEN END OF BLOCK B1.
*----------------------------------------------------------------------*
INITIALIZATION.
*----------------------------------------------------------------------*
PERFORM INT_SEC.                   "初期化処理
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
START-OF-SELECTION.
*----------------------------------------------------------------------*
PERFORM GET_DATA.               "削除依頼データ取得
PERFORM DEL_DATA.               "削除依頼データ削除処理
PERFORM DISPLAY_MESSAGE.        "終了処理
*----------------------------------------------------------------------*
END-OF-SELECTION.
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  INT_SEC
*&---------------------------------------------------------------------*
*       初期化処理
*----------------------------------------------------------------------*
FORM INT_SEC.

CLEAR:   W_DEL_CNT,GW_ZF2020.
REFRESH: GT_ZF2020.

ENDFORM.                    " INT_SEC
*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*       削除依頼データ取得
*----------------------------------------------------------------------*
FORM GET_DATA.

DATA:  L_ANSWER(1) TYPE C.
CLEAR: L_ANSWER.

* 支払状況TBLの検索
SELECT *
FROM ZF2020                "支払状況TBL
INTO TABLE GT_ZF2020
WHERE ZFBDT IN S_DATUM
AND LIFNR IN S_LIFNR.

IF SY-SUBRC <> 0.
"処理対象データがありません
MESSAGE S204.
STOP.
ELSE.
CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TITLEBAR                    = TEXT-M01
TEXT_QUESTION               = TEXT-M02
TEXT_BUTTON_1               = TEXT-M03
TEXT_BUTTON_2               = TEXT-M04
IMPORTING
ANSWER                      = L_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND              = 1
OTHERS                      = 2.
*  【いええ】/【中止】が選択された場合
IF L_ANSWER <> '1'.
*     処理終了、元の画面に戻す
STOP.
ENDIF.
ENDIF.

ENDFORM.                    " GET_DATA
*&---------------------------------------------------------------------*
*&      Form  DEL_DATA
*&---------------------------------------------------------------------*
*       削除依頼データ削除処理
*----------------------------------------------------------------------*
FORM DEL_DATA.

CLEAR:GW_ZF2020.
LOOP AT GT_ZF2020 INTO GW_ZF2020.
DELETE FROM ZF2020 WHERE BUKRS    = GW_ZF2020-BUKRS
AND LIFNR    = GW_ZF2020-LIFNR
AND ZFBDT    = GW_ZF2020-ZFBDT
AND BELNR_O  = GW_ZF2020-BELNR_O
AND BUZEI_O  = GW_ZF2020-BUZEI_O
AND GJAHR_O  = GW_ZF2020-GJAHR_O
AND SEQ_NO   = GW_ZF2020-SEQ_NO.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
"支払状況テーブル削除に失敗しました
MESSAGE S604 WITH '支払状況テーブル削除'.
STOP.
ELSE.
W_DEL_CNT = W_DEL_CNT + 1.
CLEAR:GW_ZF2020.
ENDIF.
ENDLOOP.

ENDFORM.                    " DEL_DATA
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_MESSAGE
*&---------------------------------------------------------------------*
*       終了処理
*----------------------------------------------------------------------*
FORM DISPLAY_MESSAGE.

COMMIT WORK.
* メッセージ出力
MESSAGE S309 WITH '削除件数 = '
W_DEL_CNT
'件'.

ENDFORM.                    " DISPLAY_MESSAGE
