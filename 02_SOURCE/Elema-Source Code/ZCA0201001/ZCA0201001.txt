*----------------------------------------------------------------------*
*  プログラムＩＤ：  ZCA0201001
*  プログラム名称：  得意先マスタアップロード
*                    選択画面で指定されたファイルからデータを読み込み、
*                    得意先マスタの登録/変更を行う。登録/変更の制御は、
*                    制御コードにより行う
*  作    成    者：  IMGジャパン　末永
*  作    成    日：  2010/01/13
*----------------------------------------------------------------------*
*  変　更　番　号：  変更管理№1
*  変　　更　　者：  IMGジャパン　末永
*  変　　更　　日：  2010/01/13
*  変　更　内　容：　流用元PGM … ZRLFIR9030(Fusion)
*----------------------------------------------------------------------*
*  変　更　番　号：  変更管理№2
*  変　　更　　者：  IMGジャパン　末永
*  変　　更　　日：  2010/03/31
*  変　更　内　容：　入力ファイルヘッダ行判断ロジック変更
*----------------------------------------------------------------------*
*  変　更　番　号：  変更管理№3
*  変　　更　　者：  アグニコンサルティング　吉崎
*  変　　更　　日：  2010/06/22
*  変　更　内　容：　項目削除
*----------------------------------------------------------------------*
*  変　更　番　号：  変更管理№4  (#004)
*  変　　更　　者：  SISCO 朝生（ISID114）
*  変　　更　　日：  2011/02/07
*  変　更　内　容：　権限チェック追加、多言語対応
*&---------------------------------------------------------------------*
*  変　更　番　号：  変更管理№5  (#005)
*  変　　更　　者：  SISCO 朝生（ISID114）
*  変　　更　　日：  2011/02/17
*  変　更　内　容：　販売エリア更新判定追加
*&---------------------------------------------------------------------*
*  変　更　番　号：  変更管理№6  (#006)
*  変　　更　　者：  アグニコンサルティング　吉崎
*  変　　更　　日：  2011/03/29
*  変　更　内　容：　支払処理画面処理と源泉徴収税画面処理復活
*&---------------------------------------------------------------------*
*  変　更　番　号：  変更管理№7  (#007)
*  変　　更　　者：  NCS 粂谷
*  変　　更　　日：  2014/09/09
*  変　更　内　容：　権限チェック不具合対応
*&---------------------------------------------------------------------*
*  変　更　番　号：  変更管理№8  (#008)
*  変　　更　　者：  ISID18
*  変　　更　　日：  2014/09/29
*  変　更　内　容：　BDC修正
*&---------------------------------------------------------------------*
REPORT ZCA0201001 NO STANDARD PAGE HEADING
LINE-SIZE  65
LINE-COUNT 80
MESSAGE-ID 00.

*&---------------------------------------------------------------------*
*&  内部テーブル定義
*&---------------------------------------------------------------------*
*-構造(TYPES)
TYPES:
BEGIN OF GTT_BDCDATA,      " バッチインプット用
PROGRAM   TYPE BDCDATA-PROGRAM,    " BDC モジュールプール
DYNPRO    TYPE BDCDATA-DYNPRO,     " BDC Dynpro 番号
DYNBEGIN  TYPE BDCDATA-DYNBEGIN,   " BDC Dynpro 開始
FNAM      TYPE BDCDATA-FNAM,       " 項目名
FVAL      TYPE BDCDATA-FVAL,       " BDC 項目値
END OF GTT_BDCDATA,
BEGIN OF GTT_REC,          " タブ区切りファイルからのデータを格納
FLAG(01)  TYPE C,                  " 制御コード
KUNNR     TYPE RF02D-KUNNR,        " 得意先コード
BUKRS     TYPE RF02D-BUKRS,        " 会社コード
VKORG     TYPE RF02D-VKORG,        " 販売組織
VTWEG     TYPE RF02D-VTWEG,        " 流通チャネル
SPART     TYPE RF02D-SPART,        " 製品部門
KTOKD     TYPE RF02D-KTOKD,        " 勘定グループ
SORTL     TYPE  KNA1-SORTL,        " 検索条件
SORTL2    TYPE  KNA1-SORTL,        " 検索条件2             "2010/01/20 INSERT
ANRED     TYPE  KNA1-ANRED,        " タイトル
NAME1     TYPE  KNA1-NAME1,        " 名称１
NAME2     TYPE  KNA1-NAME2,        " 名称２
*--------------------------------------------- 2010/01/20 DELETE START
*    NAME3     TYPE  KNA1-NAME3,        " 名称３
*    NAME4     TYPE  KNA1-NAME4,        " 名称４
*--------------------------------------------- 2010/01/20 DELETE END
STRAS     TYPE  KNA1-STRAS,        " 都道府県名 ⇒ 地名/番地-号
*--------------------------------------------- 2010/01/20 INSERT START
HOUSE_NUM1 TYPE ADRC-HOUSE_NUM1,   " 番地・号
HOUSE_NUM2 TYPE ADRC-HOUSE_NUM2,   " 補足
*--------------------------------------------- 2010/01/20 INSERT END
*    PFACH     TYPE  KNA1-PFACH,        " 私書箱              "2010/01/13 DELETE
ORT01     TYPE  KNA1-ORT01,        " 市区町村名
PSTLZ     TYPE  KNA1-PSTLZ,        " 郵便番号
*--------------------------------------------- 2010/01/13 DELETE START
*    ORT02     TYPE  KNA1-ORT02,        " 所在地
*    PFORT     TYPE  KNA1-PFORT,        " 私書箱所在地
*    PSTL2     TYPE  KNA1-PSTL2,        " 私書箱番号
*--------------------------------------------- 2010/01/13 DELETE END
LAND1     TYPE  KNA1-LAND1,        " 国コード
REGIO     TYPE  KNA1-REGIO,        " 地域 ⇒ 地域コード
*--------------------------------------------- 2010/01/20 INSERT START
TIME_ZONE  TYPE ADRC-TIME_ZONE,    " タイムゾーン
TRANSPZONE TYPE ADRC-TRANSPZONE,   " 納入区域
*--------------------------------------------- 2010/01/20 INSERT END
SPRAS     TYPE  KNA1-SPRAS,        " 言語選択
TELF1     TYPE  KNA1-TELF1,        " 電話番号１
*--------------------------------------------- 2010/01/20 INSERT START
TEL_EXTENS  TYPE ADRC-TEL_EXTENS,          " 内線(電話)
TMOB_NUMBER TYPE SZA1_D0100-MOB_NUMBER,   " 携帯電話
*--------------------------------------------- 2010/01/20 INSERT END
TELFX     TYPE  KNA1-TELFX,        " ファックス番号
FAX_EXTENS  TYPE ADRC-FAX_EXTENS,  " 内線(電話)          "2010/01/20 INSERT
SMTP(241) TYPE C,                  " 電子メール
LIFNR     TYPE  KNA1-LIFNR,        " 仕入先コード
VBUND     TYPE  KNA1-VBUND,        " 取引会社
KONZS     TYPE  KNA1-KONZS,        " グループキー
STCEG     TYPE  KNA1-STCEG,        " 消費税登録No        "2010/01/13 INSERT
KTOCD     TYPE  KNA1-KTOCD,        " 参照勘定グループワンタイム用
AKONT     TYPE  KNB1-AKONT,        " 統制勘定コード
ZUAWA     TYPE  KNB1-ZUAWA,        " ソートキー
*--------------------------------------------- 2010/06/22 DELETE START
*    KNRZE     TYPE  KNB1-KNRZE,        " 本店勘定コード
*--------------------------------------------- 2010/06/22 DELETE END
FDGRV     TYPE  KNB1-FDGRV,        " 計画グループ
*--------------------------------------------- 2010/01/13 UPDATE START
ALTKN     TYPE  KNB1-ALTKN,        " 旧勘定コード
*    ZTERM     TYPE  KNB1-ZTERM,        " 支払条件
ZTERM_F   TYPE  KNB1-ZTERM,        " 支払条件
*--------------------------------------------- 2010/01/13 UPDATE END
*--------------------------------------------- 2010/01/26 INSERT START
TOGRU     TYPE KNB1-TOGRU,         " 許容グループ
GUZTE     TYPE KNB1-GUZTE,         " クレジットメモ支払条件
*--------------------------------------------- 2010/01/26 INSERT END
XZVER     TYPE  KNB1-XZVER,        " 支払履歴記録
ZWELS     TYPE  KNB1-ZWELS,        " 支払方法
ZAHLS     TYPE  KNB1-ZAHLS,        " 支払保留キー
*    KNRZB     TYPE  KNB1-KNRZB,        " 代理支払人勘定         "2010/01/13 DELETE START
HBKID     TYPE  KNB1-HBKID,        " 取引銀行ID
*--------------------------------------------- 2010/01/26 INSERT START
ZGRUP     TYPE KNB1-ZGRUP,         " グループキー
XPORE     TYPE KNB1-XPORE,         " 個別支払
*--------------------------------------------- 2010/01/26 INSERT END
*--------------------------------------------- 2010/01/13 DELETE START
*    XVERR     TYPE  KNB1-XVERR,        " 仕入先との相殺
*    MAHNA     TYPE  KNB5-MAHNA,        " 督促処理
*--------------------------------------------- 2010/01/13 DELETE END
BUSAB     TYPE  KNB1-BUSAB,        " 記帳担当者
*--------------------------------------------- 2010/01/19 UPDATE START
*    EIKTO     TYPE  KNB1-EIKTO,        " 得意先自社勘定
EIKTO_B   TYPE  KNB1-EIKTO,        " 得意先自社勘定
*--------------------------------------------- 2010/01/19 UPDATE END
ZSABE     TYPE  KNB1-ZSABE,        " 得意先担当者
TLFNS     TYPE  KNB1-TLFNS,        " 記帳担当電話No.      "2010/01/13 INSERT
TLFXS     TYPE  KNB1-TLFXS,        " 経理担当者Fax
INTAD     TYPE  KNB1-INTAD,        " 担当者インターネット
KVERM     TYPE  KNB1-KVERM,        " コメント
*--------------------------------------------- 2010/01/13 INSERT START
BZIRK     TYPE  KNVV-BZIRK,        " 販売地域
VKBUR     TYPE  KNVV-VKBUR,        " 営業所
VKGRP     TYPE  KNVV-VKGRP,        " 営業グループ
*--------------------------------------------- 2010/06/22 DELETE START
*    VSORT     TYPE  KNVV-VSORT,        " 明細提案
*--------------------------------------------- 2010/06/22 DELETE END
KDGRP     TYPE  KNVV-KDGRP,        " 得意先グループ
EIKTO_V   TYPE  KNVV-EIKTO,        " 得意先自社勘定
**** START ADD 2014/09/29 ISID18 ****
VERSG     TYPE  KNVV-VERSG,        "Cus統計グループ
**** END ADD 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/06/22 DELETE START
*    KLABC     TYPE  KNVV-KLABC,        " ABC　分類
*--------------------------------------------- 2010/06/22 DELETE END
WAERS     TYPE  KNVV-WAERS,        " 通貨コード
KURST     TYPE  KNVV-KURST,        " 換算 Ｒａｔｅタイプ
RDOFF     TYPE  KNVV-RDOFF,        " 丸め解除
KONDA     TYPE  KNVV-KONDA,        " 価格グループ
KALKS     TYPE  KNVV-KALKS,        " 得意先価格決定
PLTYP     TYPE  KNVV-PLTYP,        " 価格表
LPRIO     TYPE  KNVV-LPRIO,        " 出荷優先順位
VSBED     TYPE  KNVV-VSBED,        " 出荷条件
VWERK     TYPE  KNVV-VWERK,        " 出荷プラント
AUTLF     TYPE  KNVV-AUTLF,        " 一括納入
KZTLF     TYPE  KNVV-KZTLF,        " 分割納入(明細別)
ANTLF(2)  TYPE  C,                 " 分割納入(最大)
UEBTK     TYPE  KNVV-UEBTK,        " 無制限許容
UNTTO(4)  TYPE  C,                 " 不足納入許容範囲
UEBTO(4)  TYPE  C,                 " 過剰納入許容範囲
MRNKZ     TYPE  KNVV-MRNKZ,        " 請求伝票継続処理
*--------------------------------------------- 2010/06/22 DELETE START
*    BOKRE     TYPE  KNVV-BOKRE,        " リベート
*    PRFRE     TYPE  KNVV-PRFRE,        " 価格決定
*    PERFK     TYPE  KNVV-PERFK,        " 請求書日付
*    PERRL     TYPE  KNVV-PERRL,        " 請求書一覧日付
*--------------------------------------------- 2010/06/22 DELETE END
INCO1     TYPE  KNVV-INCO1,        " インコタームズ１
INCO2     TYPE  KNVV-INCO2,        " インコタームズ２
ZTERM_V   TYPE  KNB1-ZTERM,        " 支払条件
KTGRD     TYPE  KNVV-KTGRD,        " 勘定設定グループ
TAXKD     TYPE  KNVI-TAXKD,        " 税分類
KUNN2_BP  TYPE  KNVP-KUNN2,        " 請求先
KUNN2_PY  TYPE  KNVP-KUNN2,        " 支払人
KUNN2_SH1 TYPE  KNVP-KUNN2,        " 出荷先１
KUNN2_SH2 TYPE  KNVP-KUNN2,        " 出荷先２
KUNN2_SH3 TYPE  KNVP-KUNN2,        " 出荷先３
KUNN2_SH4 TYPE  KNVP-KUNN2,        " 出荷先４
KUNN2_SH5 TYPE  KNVP-KUNN2,        " 出荷先５
KUNN2_CR  TYPE  KNVP-KUNN2,        " 海貨業者
KUNN2_PE  TYPE  KNVP-KUNN2,        " 営業員
*--------------------------------------------- 2010/01/13 INSERT END
END OF GTT_REC,
*--------------------------------------------- 2010/01/19 INSERT START
BEGIN OF GTT_ZCAT_MA001,
NAME      TYPE ZCAT_MA001-NAME,    " アドオン変数名
KEY01     TYPE ZCAT_MA001-KEY01,   " 検索キー１
LOW       TYPE ZCAT_MA001-LOW,     " ABAP: 選択値 (LOW)
END OF GTT_ZCAT_MA001.
*--------------------------------------------- 2010/01/19 INSERT END

DATA:
*-内部テーブル
* バッチインプット用内部テーブル
GDT_BDC    TYPE STANDARD TABLE OF GTT_BDCDATA,
* タブ区切りファイルからのデータを格納する内部テーブル
GDT_REC    TYPE STANDARD TABLE OF GTT_REC,
*-ヘッダ行
GDS_BDC       LIKE LINE OF GDT_BDC,
GDS_REC       LIKE LINE OF GDT_REC,
*--------------------------------------------- 2010/01/19 INSERT START
*-アドオン変数管理テーブル情報格納用
GDT_ZCAT_MA001 TYPE STANDARD TABLE OF GTT_ZCAT_MA001,
GDS_ZCAT_MA001 TYPE GTT_ZCAT_MA001.
*--------------------------------------------- 2010/01/19 INSERT END

*&---------------------------------------------------------------------*
*&  項目定義
*&---------------------------------------------------------------------*
DATA:
*-変数
WA_TCODE         TYPE SY-TCODE,               " トランザクションコード
WA_SPLIT         TYPE C,                      " 区切りコード
WA_KUNNR         TYPE KUNNR,
*--------------------------------------------- 2010/01/19 INSERT START
WA_KTOKD_SH      TYPE KNA1-KTOKD,            " 出荷先勘定グループ
WA_KTOKD_FI      TYPE KNA1-KTOKD,            " FI用勘定グループ
*--------------------------------------------- 2010/01/19 INSERT END
*-フラグ
FLG_DATA(01)     TYPE C,                      " データがあるなしのフラグ
FLG_ERR(01)      TYPE C,                      " エラーフラグ
*-カウンタ
CNT_INDEX        TYPE I,                      " 処理件数
*  CNT_LINE         TYPE I VALUE '3',            " ヘッダ2行スキップ用      "2010/03/31 DELETE
CNT_RECORD(2)    TYPE N.                      " 新規登録行      "2010/01/19 INSERT
*-構造
*-定数
CONSTANTS:
GCF_CHK(01)      TYPE C VALUE 'X',             " チェック
GCF_SPC(01)      TYPE C VALUE ' ',             " スペース
GCF_TYPE(10)     TYPE C VALUE 'ASC',           " タブ区切りFILE
GCF_CTRU(01)     TYPE C VALUE 'U',             " 制御コード(Ｕ=変更)
GCF_CTRN(01)     TYPE C VALUE 'N',             " 制御コード(Ｎ=登録)
GCF_XD01(04)     TYPE C VALUE 'XD01',          " 得意先コード登録
GCF_XD02(04)     TYPE C VALUE 'XD02',          " 得意先コード変更
GCF_LVL1(01)     TYPE C VALUE '1',             " 登録レベル(登録済)
GCF_LVL2(01)     TYPE C VALUE '2',             " 登録レベル(未登録)
GCF_PGM(08)      TYPE C VALUE 'SAPMF02D',      " プログラムID
GCF_0100(04)     TYPE C VALUE '0100',          " 画面番号(第一画面/登録)
GCF_0101(04)     TYPE C VALUE '0101',          " 画面番号(第一画面/変更)
GCF_0111(04)     TYPE C VALUE '0111',          " 画面番号(住所)
GCF_0120(04)     TYPE C VALUE '0120',          " 画面番号(管理)
*--------------------------------------------- 2010/01/19 DELETE START
**** START ADD 2014/09/29 ISID18 ****
GCF_0125(04)     TYPE C VALUE '0125',          " 画面番号(マーケティング)
**** END ADD 2014/09/29 ISID18 ****
GCF_0130(04)     TYPE C VALUE '0130',          " 画面番号(支払処理) "2011/03/29 mod
*--------------------------------------------- 2010/01/19 DELETE END
GCF_0210(04)     TYPE C VALUE '0210',          " 画面番号(会計情報)
GCF_0215(04)     TYPE C VALUE '0215',          " 画面番号(支払処理)
GCF_0220(04)     TYPE C VALUE '0220',          " 画面番号(連絡文書)
*  GCF_0230(04)     TYPE C VALUE '0230',          " 画面番号(保険)      "2010/01/19 DELETE
GCF_0340(04)     TYPE C VALUE '0340',          " 画面番号(荷渡ポイント)
GCF_0360(04)     TYPE C VALUE '0360',          " 画面番号(取引先担当者)
*  GCF_0370(04)     TYPE C VALUE '0370',          " 画面番号(貿易)      "2010/01/19 DELETE
*  GCF_0610(04)     TYPE C VALUE '0610',          " 画面番号(源泉徴収)
*--------------------------------------------- 2010/01/13 INSERT START
*->販売エリアデータ
GCF_0310(04)     TYPE C VALUE '0310',          " 画面番号(受注)
GCF_0315(04)     TYPE C VALUE '0315',          " 画面番号(出荷管理)
GCF_0320(04)     TYPE C VALUE '0320',          " 画面番号(請求伝票)
GCF_1350(04)     TYPE C VALUE '1350',          " 画面番号(請求伝票)
GCF_0324(04)     TYPE C VALUE '0324',          " 画面番号(取引先機能)
**** START ADD 2014/09/29 ISID18 ****
GCF_0326(04)     TYPE C VALUE '0326',
**** END ADD 2014/09/29 ISID18 ****
GCF_NEXT(3)      TYPE C VALUE '/00',           " OKコード(ENTER)
*--------------------------------------------- 2010/01/13 INSERT END
GCF_ENTR(04)     TYPE C VALUE 'ENTR',          " OKコード(ENTER)
*  GCF_10C(04)      TYPE C VALUE '$1OC',          " 名称枠の拡張        "2010/01/20 DELETE
GCF_20C(04)      TYPE C VALUE '$2OC',          " 住所枠の拡張
*  GCF_30C(04)      TYPE C VALUE '$3OC',          " 私書箱アドレス枠の拡張  "2010/01/20 DELETE
GCF_VW(02)       TYPE C VALUE 'VW',            " OKコード(次画面)
GCF_UPDA(05)     TYPE C VALUE '=UPDA',         " OKコード(保存)
* #004 DEL 20110207 ISID144 START
*  GCF_LA_J(01)     TYPE C VALUE 'J',             " 言語キー(日本語)
*  GCF_LA_1(01)     TYPE C VALUE '1',             " 言語キー(中国語)
*  GCF_LA_E(01)     TYPE C VALUE 'E',             " 言語キー(英語)
*
*  GCF_TITLE_1      TYPE SYTITLE                  " タイトル(中国語)
*                   VALUE '客#主数据上#',
*  GCF_TITLE_E      TYPE SYTITLE                  " タイトル(英語)
*                   VALUE 'Upload the customer master records', "#EC NOTEXT
*  GCF_JTXT         TYPE STRING
*                   VALUE 'ファイルの保存場所を選択してください',
*  GCF_CTXT(20)     TYPE C VALUE '###文件所在的位置',
*  GCF_ETXT(28)     TYPE C VALUE 'Select the location for file', "#EC NOTEXT
*  GCF_TXT1J(10)    TYPE C VALUE 'ファイル名',
*  GCF_TXT1C(06)    TYPE C VALUE '文件名',
*  GCF_TXT1E(09)    TYPE C VALUE 'File Name',                "#EC NOTEXT
*  GCF_TXT2J(6)     TYPE C VALUE 'サーバ',
*  GCF_TXT2C(6)     TYPE C VALUE '服#器',
*  GCF_TXT2E(6)     TYPE C VALUE 'Server',                   "#EC NOTEXT
*  GCF_TXT3J(8)     TYPE C VALUE 'ローカル',
*  GCF_TXT3C(4)     TYPE C VALUE '本地',
*  GCF_TXT3E(5)     TYPE C VALUE 'Local',                    "#EC NOTEXT
*  GCF_TXT4J(24)    TYPE C VALUE 'ファイルが存在しません。',
*  GCF_TXT4C(10)    TYPE C VALUE '文件不存在',
*  GCF_TXT4E(20)    TYPE C VALUE 'File does not exist.',     "#EC NOTEXT
*  GCF_TXT5J(28)    TYPE C VALUE 'FILE OPEN 異常終了    例外：',
*  GCF_TXT5C(28)    TYPE C VALUE 'FILE OPEN #生##    代#：',
*  GCF_TXT5E(45)    TYPE C
*          VALUE 'Error during file open processing. Exception:', "#EC NOTEXT
*  GCF_TXT6J(40)    TYPE C VALUE 'タブ区切りファイルにデータが存在しません',
*  GCF_TXT6C(25)    TYPE C VALUE 'TAB#隔文本文件中没有数据',
*  GCF_TXT6E(18)    TYPE C VALUE 'TAB file is empty.',       "#EC NOTEXT
*  GCF_TXT7J(25)    TYPE C VALUE 'UPLOAD 異常終了    例外：',
*  GCF_TXT7C(25)    TYPE C VALUE 'UPLOAD #生##    代#：',
*  GCF_TXT7E(42)    TYPE C
*          VALUE 'Error during upload processing. Exception:', "#EC NOTEXT
*  GCF_TXT8J(25)    TYPE C VALUE 'BDC_OPEN 異常終了　例外：',
*  GCF_TXT8C(25)    TYPE C VALUE 'BDC_OPEN #生##  代#：',
*  GCF_TXT8E(44)    TYPE C
*          VALUE 'Error during BDC_OPEN processing. Exception:', "#EC NOTEXT
*  GCF_TXT9J(27)    TYPE C VALUE 'BDC_INSERT 異常終了　例外：',
*  GCF_TXT9C(27)    TYPE C VALUE 'BDC_INSERT #生##  代#：',
*  GCF_TXT9E(46)    TYPE C
*          VALUE 'Error during BDC_INSERT processing. Exception:', "#EC NOTEXT
*  GCF_TXT10J(26)    TYPE C VALUE 'BDC_CLOSE 異常終了　例外：',
*  GCF_TXT10C(26)    TYPE C VALUE 'BDC_CLOSE #生##  代#：',
*  GCF_TXT10E(45)    TYPE C
*          VALUE 'Error during BDC_CLOSE processing. Exception:', "#EC NOTEXT
*  GCF_TXT11J(32)    TYPE C VALUE 'セッションログを確認してください',
*  GCF_TXT11C(24)    TYPE C VALUE '###批#入会##理##',
*  GCF_TXT11E(26)    TYPE C VALUE 'Check the logs of session.', "#EC NOTEXT
* #004 DEL 20110207 ISID144 END
*--------------------------------------------- 2010/01/19 INSERT START
GCF_KTOKD(5)      TYPE C VALUE 'KTOKD',
GCF_SH(2)         TYPE C VALUE 'SH',
GCF_CR(2)         TYPE C VALUE 'CR',
GCF_PE(2)         TYPE C VALUE 'PE',
GCF_FI(2)         TYPE C VALUE 'FI'.
*--------------------------------------------- 2010/01/19 INSERT END

*----------------------------------------------------------------------*
*&  入力パラメータ
*&---------------------------------------------------------------------*
* ファイル名
SELECTION-SCREEN BEGIN OF LINE.
* #006 MOD 20110207 ISID144 START
*SELECTION-SCREEN COMMENT 1(20) NAME_F FOR FIELD P_FILENM.
SELECTION-SCREEN COMMENT 1(20) TEXT-002 FOR FIELD P_FILENM.
* #006 MOD 20110207 ISID144 END
PARAMETERS:
P_FILENM TYPE RLGRAP-FILENAME OBLIGATORY.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN SKIP 1.
* ファイルの保存場所を選択
* #006 MOD 20110207 ISID144 START
*SELECTION-SCREEN BEGIN OF BLOCK SAVE WITH FRAME TITLE TEXT_1.
SELECTION-SCREEN BEGIN OF BLOCK SAVE WITH FRAME TITLE TEXT-001.
* #006 MOD 20110207 ISID144 END
* サーバ
SELECTION-SCREEN BEGIN OF LINE.
* #006 MOD 20110207 ISID144 START
*SELECTION-SCREEN COMMENT 1(10) NAME_S FOR FIELD P_SERVER.
SELECTION-SCREEN COMMENT 1(10) TEXT-003 FOR FIELD P_SERVER.
* #006 MOD 20110207 ISID144 END
SELECTION-SCREEN POSITION 20.
PARAMETERS:
P_SERVER RADIOBUTTON GROUP SAVE.
SELECTION-SCREEN END OF LINE.
* ローカル
SELECTION-SCREEN BEGIN OF LINE.
* #006 MOD 20110207 ISID144 START
*SELECTION-SCREEN COMMENT 1(10) NAME_L FOR FIELD P_LOCAL.
SELECTION-SCREEN COMMENT 1(10) TEXT-004 FOR FIELD P_LOCAL.
* #006 MOD 20110207 ISID144 END
SELECTION-SCREEN POSITION 20.
PARAMETERS:
P_LOCAL RADIOBUTTON GROUP SAVE DEFAULT 'X'.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK SAVE.

*&---------------------------------------------------------------------*
*&  初期処理
*&---------------------------------------------------------------------*
INITIALIZATION.

* #004 DEL 20110207 ISID144 START
** プログラム表題の設定
*  PERFORM FRM_SET_TITLE.
*
** 選択テキストの設定
*  CASE SY-LANGU.
*    WHEN GCF_LA_J.                     " 日本語
*      TEXT_1 = GCF_JTXT.               "'ファイルの保存場所を選択してください'
*      NAME_F = GCF_TXT1J.              "'ファイル名'
*      NAME_S = GCF_TXT2J.              "'サーバ'
*      NAME_L = GCF_TXT3J.              "'ローカル'
*    WHEN GCF_LA_1.                     " 中国語
*      TEXT_1 = GCF_CTXT.               "'###文件所在的位置'
*      NAME_F = GCF_TXT1C.              "'文件名'
*      NAME_S = GCF_TXT2C.              "'服#器'
*      NAME_L = GCF_TXT3C.              "'本地'
*    WHEN GCF_LA_E.                     " 英語
*      TEXT_1 = GCF_ETXT.               "'Select the location for file'
*      NAME_F = GCF_TXT1E.              "'File Name'
*      NAME_S = GCF_TXT2E.              "'Server'
*      NAME_L = GCF_TXT3E.              "'Local'
*  ENDCASE.
* #004 DEL 20110207 ISID144 END
*&---------------------------------------------------------------------*
*&  入力チェック処理
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_FILENM.  " ファイル名の取得
PERFORM FRM_FILENAME_GET CHANGING P_FILENM.

AT SELECTION-SCREEN.                   " ファイルの存在をチェック
PERFORM FRM_PATGDS_CHK USING P_FILENM.

*&---------------------------------------------------------------------*
*&  メイン処理
*&---------------------------------------------------------------------*
START-OF-SELECTION.
PERFORM: FRM_INIT_ALL,                      " 作業領域初期化
FRM_UPLOAD_DATA,                   " ファイルアップロード
FRM_CHECK_DATA,                    " 件数チェック
* #004 ADD 20110207 ISID144 START
FRM_INPUT_CHECK,                   " 入力チェック
* #004 ADD 20110207 ISID144 END
*--------------------------------------------- 2010/01/19 INSERT START
FRM_SELECT_ZCAT_MA001,             " アドオン変数管理テーブル検索
*--------------------------------------------- 2010/01/19 INSERT END
FRM_BDC_OPEN.                      " BDCセッションを開く

CLEAR:CNT_INDEX.
*--------------------------------------------- 2010/03/31 UPDATE START
*  LOOP AT GDT_REC INTO GDS_REC FROM CNT_LINE.
LOOP AT GDT_REC INTO GDS_REC
WHERE FLAG = GCF_CTRN   " N
OR FLAG = GCF_CTRU . " U
*--------------------------------------------- 2010/03/31 UPDATE END
CLEAR:GDT_BDC,FLG_DATA,FLG_ERR,WA_TCODE,
WA_KTOKD_SH, WA_KTOKD_FI, CNT_RECORD. "2010/01/19 MODIFY
PERFORM:
FRM_SET_BDCDATA,                 " BDCデータのセット
FRM_BDC_INSERT.                  " データをBDCセッションに挿入
ENDLOOP.
PERFORM:
FRM_BDC_CLOSE,                     " セッションを閉じる
FRM_CALL_RSBDCSUB.                 " セッションの自動処理

*&---------------------------------------------------------------------*
*&  終了処理
*&---------------------------------------------------------------------*
END-OF-SELECTION.

* #004 MOD 20110207 ISID144 START
** プログラム表題の設定
*  PERFORM FRM_SET_TITLE.
*
***--処理件数出力
*  CASE SY-LANGU.
*    WHEN GCF_LA_J.        " 日本語
*      WRITE:
*        / '**************** < 得意先マスタ取り込み > ****************',
*        / '*  処理件数                     ＝ ' ,  CNT_INDEX,
*        / '**********************************************************'.
*
*    WHEN GCF_LA_1.        " 中国語
*      WRITE:
*        / '******************* < 客#主数据#取 > *******************',
*        / '*  #理件数                     ＝ ' ,  CNT_INDEX,
*        / '**********************************************************'.
*
*    WHEN GCF_LA_E.        " 英語
*      WRITE:
*        / '************ < Take the customer in master > *************',
*        / '*  The number of processes      ＝ ' ,  CNT_INDEX,
*        / '**********************************************************'.
*  ENDCASE.

* プログラム処理件数表示
PERFORM FRM_WRITE_RESULT.
* #004 MOD 20110207 ISID144 END
*&---------------------------------------------------------------------*
*&      Form  FRM_PATGDS_CHK
*&---------------------------------------------------------------------*
*       ファイルの存在をチェック
*----------------------------------------------------------------------*
*      -->P_IPATH   入力ファイル名
*----------------------------------------------------------------------*
FORM FRM_PATGDS_CHK USING    P_IPATH.
CHECK P_LOCAL = GCF_CHK.        " ローカルファイルのときのみ実行する
DATA:LDF_FILE      TYPE STRING,      " ファイル名
LDF_RESULT    TYPE C.           " 結果
*       LDF_MSGV1(50) TYPE C.           " メッセージ変数１ "#004 DEL

LDF_FILE = P_IPATH.
CALL METHOD CL_GUI_FRONTEND_SERVICES=>FILE_EXIST
EXPORTING
FILE                 = LDF_FILE
RECEIVING
RESULT               = LDF_RESULT
EXCEPTIONS
CNTL_ERROR           = 1
ERROR_NO_GUI         = 2
WRONG_PARAMETER      = 3
NOT_SUPPORTED_BY_GUI = 4
OTHERS               = 5.
CASE SY-SUBRC.
WHEN 0.
* ファイルが存在する＝X／存在しない＝スペース
IF LDF_RESULT = GCF_SPC.
* #004 MOD 20110207 ISID144 START
**       メッセージ変数のセット
*        CASE SY-LANGU.
*          WHEN GCF_LA_J.                     " 日本語
*            LDF_MSGV1 = GCF_TXT4J.           "'ファイルが存在しません。'
*          WHEN GCF_LA_1.                     " 中国語
*            LDF_MSGV1 = GCF_TXT4C.           "'文件不存在'
*          WHEN GCF_LA_E.                     " 英語
*            LDF_MSGV1 = GCF_TXT4E.           "'File does not exist.'
*        ENDCASE.
*        MESSAGE E398 WITH LDF_MSGV1 SPACE SPACE SPACE.
MESSAGE E014(ZFI001).
* #004 MOD 20110207 ISID144 END
ENDIF.
WHEN OTHERS.
ENDCASE.
ENDFORM.                    " FRM_PATGDS_CHK

*&---------------------------------------------------------------------*
*&      Form  FRM_FILENAME_GET
*&---------------------------------------------------------------------*
*       ファイル名の取得
*----------------------------------------------------------------------*
*      <--P_IOPATH  ファイル名
*----------------------------------------------------------------------*
FORM FRM_FILENAME_GET  CHANGING P_IOPATH.

DATA:LDF_FILE  TYPE FILETABLE,       " ファイル名一覧格納
LDF_HFILE LIKE LINE OF LDF_FILE," ヘッダ
LDF_RC    TYPE I,               " 結果
LDF_TITLE TYPE STRING.          " WINDOW TITLE

* #004 MOD 20110207 ISID144 START
* WINDOW_TITLEの設定
*  CASE SY-LANGU.
*    WHEN GCF_LA_J.                     " 日本語
*      LDF_TITLE = GCF_TXT1J.           "'ファイル名'
*    WHEN GCF_LA_1.                     " 中国語
*      LDF_TITLE = GCF_TXT1C.           "'文件名'
*    WHEN GCF_LA_E.                     " 英語
*      LDF_TITLE = GCF_TXT1E.           "'File Name'
*  ENDCASE.
LDF_TITLE = TEXT-002.
* #004 MOD 20110207 ISID144 END
CALL METHOD CL_GUI_FRONTEND_SERVICES=>FILE_OPEN_DIALOG
EXPORTING
WINDOW_TITLE            = LDF_TITLE
CHANGING
FILE_TABLE              = LDF_FILE
RC                      = LDF_RC
EXCEPTIONS
FILE_OPEN_DIALOG_FAILED = 1
CNTL_ERROR              = 2
ERROR_NO_GUI            = 3
NOT_SUPPORTED_BY_GUI    = 4
OTHERS                  = 5.
CASE SY-SUBRC.
WHEN 0.
IF LDF_RC < 0.
ELSE.
READ TABLE LDF_FILE INTO LDF_HFILE INDEX 1.
P_IOPATH = LDF_HFILE-FILENAME.
ENDIF.
WHEN OTHERS.
ENDCASE.

ENDFORM.                    " FRM_FILENAME_GET

*&---------------------------------------------------------------------*
*&      Form  FRM_INIT_ALL
*&---------------------------------------------------------------------*
*       作業領域初期化
*----------------------------------------------------------------------*
FORM FRM_INIT_ALL .
CLEAR:
GDT_BDC,GDS_BDC,
GDT_REC,GDS_REC,
WA_TCODE,FLG_ERR,CNT_INDEX.
ENDFORM.                    " FRM_INIT_ALL

*&---------------------------------------------------------------------*
*&      Form  FRM_UPLOAD_DATA
*&---------------------------------------------------------------------*
*       ファイルのアップロード
*----------------------------------------------------------------------*
FORM FRM_UPLOAD_DATA.
* ファイルの保存場所によってアップロード方法を変える
IF P_SERVER = GCF_CHK.
PERFORM:
FRM_UPLOAD_SERVER_DATA.          " サーバからデータをUL
ELSEIF P_LOCAL = GCF_CHK.
PERFORM:
FRM_UPLOAD_LOCAL_DATA.           " ローカルからデータをUL
ENDIF.
ENDFORM.                    " FRM_UPLOAD_DATA

*&---------------------------------------------------------------------*
*&      Form  FRM_UPLOAD_SERVER_DATA
*&---------------------------------------------------------------------*
*       入力ファイルデータをアップロードする(サーバ)
*----------------------------------------------------------------------*
FORM FRM_UPLOAD_SERVER_DATA .
DATA:LDF_CNT        TYPE I,                  " データ件数
LDF_DATA(1000) TYPE C.
*       LDF_MSGV1(50)  TYPE C.                  " メッセージ変数１ "#004 DEL

* 区切りコードにTABを設定
WA_SPLIT = CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.

* ファイルオープン(UNIX FILE)
OPEN DATASET P_FILENM FOR INPUT IN TEXT MODE ENCODING DEFAULT.  " ENT
CASE SY-SUBRC.
WHEN 0.
WHEN 8.
* #004 MOD 20110207 ISID144 START
**     メッセージ変数のセット
*      CASE SY-LANGU.
*        WHEN GCF_LA_J.                     " 日本語
*          LDF_MSGV1 = GCF_TXT5J.           "'FILE OPEN 異常終了    例外：'
*        WHEN GCF_LA_1.                     " 中国語
*          LDF_MSGV1 = GCF_TXT5C.           "'FILE OPEN #生##    代#：'
*        WHEN GCF_LA_E.                     " 英語
*          LDF_MSGV1 = GCF_TXT5E.
*          "'Error during file open processing. Exception:'
*      ENDCASE.
*      MESSAGE E398 WITH LDF_MSGV1 SY-SUBRC SPACE SPACE.
MESSAGE S052(ZFI001)
WITH SY-SUBRC
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDCASE.
* 入力ファイル読込
DO.
CLEAR:GDS_REC,LDF_DATA.
READ DATASET P_FILENM INTO LDF_DATA.
IF SY-SUBRC <> 0.
EXIT.
ENDIF.
SPLIT LDF_DATA AT WA_SPLIT INTO
GDS_REC-FLAG
GDS_REC-KUNNR
GDS_REC-BUKRS
GDS_REC-VKORG
GDS_REC-VTWEG
GDS_REC-SPART
GDS_REC-KTOKD
GDS_REC-SORTL
GDS_REC-SORTL2                      "2010/01/26 INSERT
GDS_REC-ANRED
GDS_REC-NAME1
GDS_REC-NAME2
*--------------------------------------------- 2010/01/20 DELETE START
*          GDS_REC-NAME3
*          GDS_REC-NAME4
*--------------------------------------------- 2010/01/20 DELETE END
GDS_REC-STRAS
*--------------------------------------------- 2010/01/26 INSERT START
GDS_REC-HOUSE_NUM1
GDS_REC-HOUSE_NUM2
*--------------------------------------------- 2010/01/26 INSERT END
*          GDS_REC-PFACH                      "2010/01/13 DELETE
GDS_REC-ORT01
GDS_REC-PSTLZ
*--------------------------------------------- 2010/01/13 DELETE START
*          GDS_REC-ORT02
*          GDS_REC-PFORT
*          GDS_REC-PSTL2
*--------------------------------------------- 2010/01/13 DELETE END
GDS_REC-LAND1
GDS_REC-REGIO
*--------------------------------------------- 2010/01/26 INSERT START
GDS_REC-TIME_ZONE
GDS_REC-TRANSPZONE
*--------------------------------------------- 2010/01/26 INSERT END
GDS_REC-SPRAS
GDS_REC-TELF1
*--------------------------------------------- 2010/01/26 INSERT START
GDS_REC-TEL_EXTENS
GDS_REC-TMOB_NUMBER
*--------------------------------------------- 2010/01/26 INSERT END
GDS_REC-TELFX
GDS_REC-FAX_EXTENS                  "2010/01/26 INSERT
GDS_REC-SMTP
GDS_REC-LIFNR
GDS_REC-VBUND
GDS_REC-KONZS
GDS_REC-STCEG                       "2010/01/19 INSERT
GDS_REC-KTOCD
GDS_REC-AKONT
GDS_REC-ZUAWA
*--------------------------------------------- 2010/06/22 DELETE START
*          GDS_REC-KNRZE
*--------------------------------------------- 2010/06/22 DELETE END
GDS_REC-FDGRV
*--------------------------------------------- 2010/01/13 UPDATE START
GDS_REC-ALTKN
*          GDS_REC-ZTERM
GDS_REC-ZTERM_F
*--------------------------------------------- 2010/01/13 UPDATE END
*--------------------------------------------- 2010/01/26 INSERT START
GDS_REC-TOGRU
GDS_REC-GUZTE
*--------------------------------------------- 2010/01/26 INSERT END
GDS_REC-XZVER
GDS_REC-ZWELS
GDS_REC-ZAHLS
*          GDS_REC-KNRZB                      "2010/01/13 DELETE
GDS_REC-HBKID
*--------------------------------------------- 2010/01/13 DELETE START
*          GDS_REC-XVERR
*          GDS_REC-MAHNA
*--------------------------------------------- 2010/01/13 DELETE END
*--------------------------------------------- 2010/01/26 INSERT START
GDS_REC-ZGRUP
GDS_REC-XPORE
*--------------------------------------------- 2010/01/26 INSERT END
GDS_REC-BUSAB
GDS_REC-EIKTO_B
GDS_REC-ZSABE
GDS_REC-TLFNS                       "2010/01/13 INSERT
GDS_REC-TLFXS
GDS_REC-INTAD
GDS_REC-KVERM
*--------------------------------------------- 2010/01/13 INSERT START
GDS_REC-BZIRK
GDS_REC-VKBUR
GDS_REC-VKGRP
*--------------------------------------------- 2010/06/22 DELETE START
*          GDS_REC-VSORT
*--------------------------------------------- 2010/06/22 DELETE END
GDS_REC-KDGRP
GDS_REC-EIKTO_V
**** START ADD 2014/09/29 ISID18 ****
GDS_REC-VERSG
**** END ADD 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/06/22 DELETE START
*          GDS_REC-KLABC
*--------------------------------------------- 2010/06/22 DELETE END
GDS_REC-WAERS
GDS_REC-KURST
GDS_REC-RDOFF
GDS_REC-KONDA
GDS_REC-KALKS
GDS_REC-PLTYP
GDS_REC-LPRIO
GDS_REC-VSBED
GDS_REC-VWERK
GDS_REC-AUTLF
GDS_REC-KZTLF
GDS_REC-ANTLF
GDS_REC-UEBTK
GDS_REC-UNTTO
GDS_REC-UEBTO
GDS_REC-MRNKZ
*--------------------------------------------- 2010/06/22 DELETE START
*          GDS_REC-BOKRE
*          GDS_REC-PRFRE
*          GDS_REC-PERFK
*          GDS_REC-PERRL
*--------------------------------------------- 2010/06/22 DELETE END
GDS_REC-INCO1
GDS_REC-INCO2
GDS_REC-ZTERM_V
GDS_REC-KTGRD
GDS_REC-TAXKD
GDS_REC-KUNN2_BP
GDS_REC-KUNN2_PY
GDS_REC-KUNN2_SH1
GDS_REC-KUNN2_SH2
GDS_REC-KUNN2_SH3
GDS_REC-KUNN2_SH4
GDS_REC-KUNN2_SH5
GDS_REC-KUNN2_CR
GDS_REC-KUNN2_PE.
*--------------------------------------------- 2010/01/13 INSERT END
APPEND GDS_REC TO GDT_REC.
ENDDO.
* データ件数チェック
DESCRIBE TABLE GDT_REC LINES LDF_CNT.
IF LDF_CNT = 0  .
* #004 MOD 20110207 ISID144 START
**   メッセージ変数のセット
*    CASE SY-LANGU.
*      WHEN GCF_LA_J.                     " 日本語
*        LDF_MSGV1 = GCF_TXT6J.           "'タブ区切りファイルにデータが存在しません'
*      WHEN GCF_LA_1.                     " 中国語
*        LDF_MSGV1 = GCF_TXT6C.           "'TAB#隔文本文件中没有数据'
*      WHEN GCF_LA_E.                     " 英語
*        LDF_MSGV1 = GCF_TXT6E.           "'TAB file is empty.'
*    ENDCASE.
*    MESSAGE E398 WITH LDF_MSGV1 SPACE SPACE SPACE.
MESSAGE S015(ZFI001) DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDIF.
*   ファイルクローズ(UNIX FILE)
CLOSE DATASET P_FILENM.
ENDFORM.                    " FRM_UPLOAD_SERVER_DATA

*&---------------------------------------------------------------------*
*&      Form  FRM_UPLOAD_LOCAL_DATA
*&---------------------------------------------------------------------*
*       入力ファイルデータをアップロードする(ローカル)
*----------------------------------------------------------------------*
FORM FRM_UPLOAD_LOCAL_DATA.
DATA:LDF_LENGTH TYPE I.                   " ファイルの長
DATA:LDF_FNAME     TYPE STRING.          " ファイル名
*       LDF_MSGV1(50) TYPE C.               " メッセージ変数１

LDF_FNAME = P_FILENM.
CALL FUNCTION 'GUI_UPLOAD'
EXPORTING
FILENAME                = LDF_FNAME
FILETYPE                = GCF_TYPE
HAS_FIELD_SEPARATOR     = GCF_CHK
IMPORTING
FILELENGTH              = LDF_LENGTH
TABLES
DATA_TAB                = GDT_REC
EXCEPTIONS
FILE_OPEN_ERROR         = 1
FILE_READ_ERROR         = 2
NO_BATCH                = 3
GUI_REFUSE_FILETRANSFER = 4
INVALID_TYPE            = 5
NO_AUTHORITY            = 6
UNKNOWN_ERROR           = 7
BAD_DATA_FORMAT         = 8
HEADER_NOT_ALLOWED      = 9
SEPARATOR_NOT_ALLOWED   = 10
HEADER_TOO_LONG         = 11
UNKNOWN_DP_ERROR        = 12
ACCESS_DENIED           = 13
DP_OUT_OF_MEMORY        = 14
DISK_FULL               = 15
DP_TIMEOUT              = 16
OTHERS                  = 17.
CASE SY-SUBRC.
WHEN 0.
IF LDF_LENGTH <= 0.
* #004 MOD 20110207 ISID144 START
**       メッセージ変数のセット
*        CASE SY-LANGU.
*          WHEN GCF_LA_J.                     " 日本語
*            LDF_MSGV1 = GCF_TXT6J.           "'タブ区切りファイルにデータが存在しません'
*          WHEN GCF_LA_1.                     " 中国語
*            LDF_MSGV1 = GCF_TXT6C.           "'TAB#隔文本文件中没有数据'
*          WHEN GCF_LA_E.                     " 英語
*            LDF_MSGV1 = GCF_TXT6E.           "'TAB file is empty.'
*        ENDCASE.
*        MESSAGE E398 WITH LDF_MSGV1 SPACE SPACE SPACE.
MESSAGE S015(ZFI001) DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDIF.
WHEN OTHERS.
* #004 MOD 20110207 ISID144 START
**     メッセージ変数のセット
*      CASE SY-LANGU.
*        WHEN GCF_LA_J.                       " 日本語
*          LDF_MSGV1 = GCF_TXT7J.             "'UPLOAD 異常終了    例外：'
*        WHEN GCF_LA_1.                       " 中国語
*          LDF_MSGV1 = GCF_TXT7C.             "'UPLOAD #生##    代#：'
*        WHEN GCF_LA_E.                       " 英語
*          LDF_MSGV1 = GCF_TXT7E.
*          "'Error during upload processing. Exception:'
*      ENDCASE.
*      MESSAGE E398 WITH LDF_MSGV1 SY-SUBRC SPACE SPACE.
MESSAGE S052(ZFI001)
WITH SY-SUBRC
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDCASE.
ENDFORM.                    " FRM_UPLOAD_LOCAL_DATA

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_BDCDATA
*&---------------------------------------------------------------------*
*       BDCデータのセット
*----------------------------------------------------------------------*
FORM FRM_SET_BDCDATA .

* 項目のアルファ変換
PERFORM:
FRM_ALPHA_INSERT USING    GDS_REC-KUNNR         " 得意先コードの変換
CHANGING WA_KUNNR.

* (制御コード項目が登録(N)/変更(U)以外のときは読み飛ばす)
IF NOT ( GDS_REC-FLAG = GCF_CTRN OR GDS_REC-FLAG = GCF_CTRU ).
PERFORM:
FRM_N_U_SET.          " 制御コード項目の登録(N)/変更(U)設定
ENDIF.
*--------------------------------------------- 2010/01/19 INSERT START
* 勘定グループ取得
*->出荷先勘定グループ
PERFORM FRM_READ_ZCAT_MA001 USING    GCF_SH        " 取引先機能
CHANGING WA_KTOKD_SH.  " 勘定グループ
*->FI用勘定グループ
PERFORM FRM_READ_ZCAT_MA001 USING    GCF_FI        " 取引先機能
CHANGING WA_KTOKD_FI.  " 勘定グループ

* 取引先機能行の初期化
CNT_RECORD = 4.
*--------------------------------------------- 2010/01/19 INSERT END
* 処理件数のカウント
CNT_INDEX = CNT_INDEX + 1.
* バッチインプットテーブルにデータをセット
* 制御コードによって処理を分ける
CASE GDS_REC-FLAG.
WHEN GCF_CTRN.                     " 制御コードがN(新規登録)のとき
WA_TCODE = GCF_XD01.             " T-CD設定(登録)
PERFORM:
FRM_KNA1_CHECK,                " データの存在チェック
FRM_SET_XD01.                  " 登録用BDCデータセット
WHEN GCF_CTRU.                     " 制御コードがU(更新)のとき
WA_TCODE = GCF_XD02.             " T-CD設定(変更)
PERFORM:
FRM_SET_XD02.                  " 変更用BDCデータセット
ENDCASE.
ENDFORM.                    " FRM_SET_BDCDATA

*&---------------------------------------------------------------------*
*&      Form  FRM_KNB1_CHECK
*&---------------------------------------------------------------------*
*       データの存在チェック
*----------------------------------------------------------------------*
FORM FRM_KNA1_CHECK .
DATA:LDF_KUNNR TYPE KNA1-KUNNR.
CLEAR:FLG_DATA.
* 得意先コードの存在チェック
SELECT SINGLE KUNNR                  " 得意先コード
INTO LDF_KUNNR
FROM KNA1                          " 得意先マスタ: 一般データ
WHERE KUNNR = GDS_REC-KUNNR.        " 得意先コード
CASE SY-SUBRC.
WHEN 0.
FLG_DATA = GCF_LVL1.             " 登録済(会社CDデータのみ登録)
WHEN OTHERS.
FLG_DATA = GCF_LVL2.             " 未登録
ENDCASE.
ENDFORM.                    " FRM_KNA1_CHECK

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_XD01
*&---------------------------------------------------------------------*
*       登録用BDCデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_XD01 .
PERFORM:
FRM_SET_0100.                      " 第一画面
IF FLG_DATA = GCF_LVL2.              " 得意先コードが存在しないデータ
PERFORM:                           " 一般データ
FRM_SET_0111,                    " 住所
FRM_SET_0120,                    " 管理
FRM_SET_0125.                    " マーケティング他
ENDIF.
*--------------------------------------------- 2010/01/19 INSERT START
*-▼ 勘定グループが出荷先以外の場合、会社コードデータセット
IF WA_KTOKD_SH IS INITIAL.
*--------------------------------------------- 2010/01/19 INSERT END
PERFORM:                             " 会社コードデータ
FRM_SET_0210,                      " 会計情報
FRM_SET_0215,                      " 支払処理
FRM_SET_0220.                      " 連絡文書
ENDIF.                                                       "2010/01/19 INSERT
*--------------------------------------------- 2010/01/13 DELETE START
*    FRM_SET_0230,                      " 保険
*    FRM_SET_0610.                      " 源泉徴収税
*--------------------------------------------- 2010/01/13 DELETE END
*--------------------------------------------- 2010/01/13 INSERT START
*-▼ 勘定グループがFI用以外の場合、販売エリアデータセット
IF WA_KTOKD_FI IS INITIAL.
PERFORM:                             " 販売エリアデータ
FRM_SET_0310,                      " 受注
FRM_SET_0315,                      " 出荷管理
FRM_SET_0320_1350,                 " 請求伝票
FRM_SET_0324.                      " 取引先機能
ENDIF.
*--------------------------------------------- 2010/01/13 INSERT END
ENDFORM.                               " FRM_SET_XD01

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0100
*&---------------------------------------------------------------------*
*       第一画面にデータセット(登録)
*----------------------------------------------------------------------*
FORM FRM_SET_0100 .
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM       GCF_0100,         " 画面設定
GCF_SPC 'BDC_OKCODE'  GCF_ENTR,         " OKコード(ENTER)
GCF_SPC 'RF02D-KTOKD' GDS_REC-KTOKD,    " 勘定グループ
GCF_SPC 'RF02D-KUNNR' GDS_REC-KUNNR,    " 得意先コード
GCF_SPC 'RF02D-BUKRS' GDS_REC-BUKRS,    " 会社コード
GCF_SPC 'RF02D-VKORG' GDS_REC-VKORG,    " 販売組織
GCF_SPC 'RF02D-VTWEG' GDS_REC-VTWEG,    " 流通チャネル
GCF_SPC 'RF02D-SPART' GDS_REC-SPART,    " 製品部門
GCF_SPC 'USE_ZAV'     GCF_CHK.          " 共通アドレス管理使用
ENDFORM.                    " FRM_SET_0100

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0111
*&---------------------------------------------------------------------*
*       住所画面にデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0111 .
**** START DEL 2014/09/29 ISID18
*  IF GDS_REC-TELF1 IS INITIAL.
*    GDS_REC-TELF1 = '00-0000-0000'.      " 電話番号１
*  ENDIF.
*  IF GDS_REC-TELFX IS INITIAL.
*    GDS_REC-TELFX = '00-0000-0000'.      " ファックス番号
*  ENDIF.
*  IF GDS_REC-SMTP IS INITIAL.
*    GDS_REC-SMTP = 'XXX@XXX.XXX'.        " 電子メール
*  ENDIF.
**** END DEL 2014/09/29 ISID18 ****
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM       GCF_0111,                   " 画面設定
*      GCF_SPC 'BDC_OKCODE'  GCF_10C,                    " OKコード(名称枠の拡張)      "2010/01/20 DELETE
**** START UPD 2014/09/29 ISID18 ****
*      GCF_SPC 'ADDR1_DATA-SORT1'      GDS_REC-SORTL,    " 検索条件
*      GCF_SPC 'SZA1_D0100-TITLE_MEDI' GDS_REC-ANRED,    " タイトル
GCF_SPC 'ADDR1_DATA-SORT1'      GDS_REC-SORTL.    " 検索条件
IF GDS_REC-ANRED IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-TITLE_MEDI' GDS_REC-ANRED.    " タイトル
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
**** END UPD 2014/09/29 ISID18 ****
GCF_SPC 'ADDR1_DATA-NAME1'      GDS_REC-NAME1,    " 名称１
**** START UPD 2014/09/29 ISID18 ****
*      GCF_SPC 'ADDR1_DATA-NAME2'      GDS_REC-NAME2,    " 名称２
*      GCF_SPC 'ADDR1_DATA-SORT2'      GDS_REC-SORTL2,   " 検索条件2                 "2010/01/20 INSERT
GCF_SPC 'ADDR1_DATA-NAME2'      GDS_REC-NAME2.    " 名称２
IF GDS_REC-SORTL2 IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'ADDR1_DATA-SORT2'      GDS_REC-SORTL2.   " 検索条件2                 "2010/01/20 INSERT
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
**** END UPD 2014/09/29 ISID18 ****
GCF_SPC 'ADDR1_DATA-CITY1'      GDS_REC-ORT01,    " 市区町村名
GCF_SPC 'ADDR1_DATA-COUNTRY'    GDS_REC-LAND1,    " 国コード
*--------------------------------------------- 2010/01/20 DELETE START
*      GCF_CHK GCF_PGM       GCF_0111,                   " 画面設定
*      GCF_SPC 'BDC_OKCODE'  GCF_20C,                    " OKコード(住所枠の拡張)
*      GCF_CHK GCF_PGM       GCF_0111,                   " 画面設定
*      GCF_SPC 'BDC_OKCODE'  GCF_30C,                    " OKコード(私書箱枠の拡張)
*      GCF_CHK GCF_PGM       GCF_0111,                   " 画面設定
*      GCF_SPC 'BDC_OKCODE'  GCF_VW,                     " OKコード(次画面)
*      GCF_SPC 'SZA1_D0100-TITLE_MEDI' GDS_REC-ANRED,    " タイトル
*      GCF_SPC 'ADDR1_DATA-NAME3'      GDS_REC-NAME3,    " 名称３
*      GCF_SPC 'ADDR1_DATA-NAME4'      GDS_REC-NAME4,    " 名称４
*--------------------------------------------- 2010/01/20 DELETE END
GCF_SPC 'ADDR1_DATA-STREET'     GDS_REC-STRAS,    " 都道府県名 ⇒ 地名/番地-号
*      GCF_SPC 'ADDR1_DATA-PO_BOX'     GDS_REC-PFACH,    " 私書箱       "2010/01/13 DELETE
GCF_SPC 'ADDR1_DATA-POST_CODE1' GDS_REC-PSTLZ,    " 郵便番号
*      GCF_SPC 'ADDR1_DATA-CITY2'      GDS_REC-ORT02,    " 所在地       "2010/01/26 DELETE
GCF_SPC 'ADDR1_DATA-REGION'     GDS_REC-REGIO,    " 地域 ⇒ 地域コード
*--------------------------------------------- 2010/01/20 INSERT START
GCF_SPC 'ADDR1_DATA-HOUSE_NUM1' GDS_REC-HOUSE_NUM1,    " 番地・号
**** START UPD 2014/09/29 ISID18 ****
*      GCF_SPC 'ADDR1_DATA-HOUSE_NUM2' GDS_REC-HOUSE_NUM2,    " 補足
*      GCF_SPC 'ADDR1_DATA-TIME_ZONE' GDS_REC-TIME_ZONE,    " タイムゾーン
GCF_SPC 'ADDR1_DATA-HOUSE_NUM2' GDS_REC-HOUSE_NUM2.    " 補足
IF GDS_REC-TIME_ZONE IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'ADDR1_DATA-TIME_ZONE' GDS_REC-TIME_ZONE.    " タイムゾーン
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
**** END UPD 2014/09/29 ISID18 ****
GCF_SPC 'ADDR1_DATA-TRANSPZONE' GDS_REC-TRANSPZONE,  " 納入区域
*--------------------------------------------- 2010/01/20 INSERT END
**** START UPD 2014/09/29 ISID18 ****
*      GCF_SPC 'ADDR1_DATA-LANGU'      GDS_REC-SPRAS,    " 言語選択
*      GCF_SPC 'SZA1_D0100-TEL_NUMBER' GDS_REC-TELF1,    " 電話番号１
*--------------------------------------------- 2010/01/20 INSERT START
*      GCF_SPC 'SZA1_D0100-TEL_EXTENS' GDS_REC-TEL_EXTENS,  " 内線(電話)
*      GCF_SPC 'SZA1_D0100-MOB_NUMBER' GDS_REC-TMOB_NUMBER, " 携帯電話
*--------------------------------------------- 2010/01/20 INSERT END
*      GCF_SPC 'SZA1_D0100-FAX_NUMBER' GDS_REC-TELFX,    " ファックス番号
*      GCF_SPC 'SZA1_D0100-FAX_EXTENS' GDS_REC-FAX_EXTENS,  " 内線(FAX)   "2010/01/20 INSERT
*      GCF_SPC 'SZA1_D0100-SMTP_ADDR'  GDS_REC-SMTP,     " 電子メール
GCF_SPC 'ADDR1_DATA-LANGU'      GDS_REC-SPRAS.    " 言語選択
IF GDS_REC-TELF1 IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-TEL_NUMBER' GDS_REC-TELF1.    " 電話番号１
ENDIF.
IF GDS_REC-TEL_EXTENS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-TEL_EXTENS' GDS_REC-TEL_EXTENS.  " 内線(電話)
ENDIF.
IF GDS_REC-TMOB_NUMBER IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-MOB_NUMBER' GDS_REC-TMOB_NUMBER. " 携帯電話
ENDIF.
IF GDS_REC-TELFX IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-FAX_NUMBER' GDS_REC-TELFX.    " ファックス番号
ENDIF.
IF GDS_REC-FAX_EXTENS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-FAX_EXTENS' GDS_REC-FAX_EXTENS.  " 内線(FAX)   "2010/01/20 INSERT
ENDIF.
IF GDS_REC-SMTP IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'SZA1_D0100-SMTP_ADDR'  GDS_REC-SMTP.     " 電子メール
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
**** END UPD 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/01/13 DELETE START
*      GCF_SPC 'ADDR1_DATA-PO_BOX_LOC' GDS_REC-PFORT,    " 私書箱所在地
*      GCF_SPC 'SZA1_D0100-POSTCODE2C' GDS_REC-PSTL2.    " 私書箱番号
*--------------------------------------------- 2010/01/13 DELETE END
GCF_SPC 'BDC_OKCODE'            GCF_VW.              " OKコード(次画面)  "2010/01/26 INSERT
ENDFORM.                    " FRM_SET_0111

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0120
*&---------------------------------------------------------------------*
*       管理画面にデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0120 .
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM      GCF_0120,          " 画面設定
**** START UPD 2014/09/29 ISID18 ****
*      GCF_SPC 'BDC_OKCODE' GCF_VW,            " OKコード(次画面)
*      GCF_SPC 'KNA1-LIFNR' GDS_REC-LIFNR,     " 仕入先コード
*      GCF_SPC 'KNA1-VBUND' GDS_REC-VBUND,     " 取引会社
*      GCF_SPC 'KNA1-KONZS' GDS_REC-KONZS,     " グループキー
*      GCF_SPC 'KNA1-STCEG' GDS_REC-STCEG.     " 消費税登録No    "2010/01/19 INSERT
GCF_SPC 'BDC_OKCODE' GCF_VW.            " OKコード(次画面)
IF GDS_REC-LIFNR IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNA1-LIFNR' GDS_REC-LIFNR.     " 仕入先コード
ENDIF.
IF GDS_REC-VBUND IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNA1-VBUND' GDS_REC-VBUND.     " 取引会社
ENDIF.
IF GDS_REC-KONZS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNA1-KONZS' GDS_REC-KONZS.     " グループキー
ENDIF.
IF GDS_REC-STCEG IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNA1-STCEG' GDS_REC-STCEG.     " 消費税登録No    "2010/01/19 INSERT
ENDIF.
**** END UPD 2014/09/29 ISID18 ****
ENDFORM.                    " FRM_SET_0120

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0125
*&---------------------------------------------------------------------*
*       マーケティング他画面にデータセット(画面遷移)
*----------------------------------------------------------------------*
FORM FRM_SET_0125 .
PERFORM
FRM_BDCDATA_SET USING:
*--------------------------------------------- 2010/01/19 DELETE START
**** START ADD 2014/09/29 ISID18 ****
GCF_CHK GCF_PGM      GCF_0125,        " マーケッティング画面設定
GCF_SPC 'BDC_OKCODE' GCF_VW,          " OKコード(次画面)
**** END ADD 2014/09/29 ISID18 ****
GCF_CHK GCF_PGM      GCF_0130,        " 支払処理画面設定
GCF_SPC 'BDC_OKCODE' GCF_VW,          " OKコード(次画面)　"2011/03/29 mod
**** START ADD 2014/09/29 ISID18 ****
GCF_CHK GCF_PGM      GCF_0360,        " 取引先担当者画面設定
GCF_SPC 'BDC_OKCODE' GCF_VW.          " OKコード(次画面)
**** END ADD 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/01/19 DELETE END
**** START DEL 2014/09/29 ISID18****
*      GCF_CHK GCF_PGM      GCF_0340,        " 荷渡ポイント画面設定
*      GCF_SPC 'BDC_OKCODE' GCF_VW.          " OKコード(次画面)
**** END DEL 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/01/19 DELETE START
*      GCF_CHK GCF_PGM      GCF_0370,        " 貿易管理画面設定
*      GCF_SPC 'BDC_OKCODE' GCF_VW,          " OKコード(次画面)
*--------------------------------------------- 2010/01/19 DELETE END
**** START DEL 2014/09/29 ISID18****
*      GCF_CHK GCF_PGM      GCF_0360,        " 取引先担当者画面設定
*      GCF_SPC 'BDC_OKCODE' GCF_VW.          " OKコード(次画面)
**** END DEL 2014/09/29 ISID18 ****
ENDFORM.                    " FRM_SET_0125

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0210
*&---------------------------------------------------------------------*
*       会計情報画面にデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0210 .
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM      GCF_0210,          " 画面設定
**** START UPD 2014/09/29 ISID18 ****
GCF_SPC 'BDC_OKCODE' GCF_VW.
IF GDS_REC-ZUAWA IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ZUAWA' GDS_REC-ZUAWA.     " ソートキー
ENDIF.
IF GDS_REC-FDGRV IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-FDGRV' GDS_REC-FDGRV.     " 計画グループ
ENDIF.
IF GDS_REC-ALTKN IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ALTKN' GDS_REC-ALTKN.     " 旧勘定コード       "2010/01/19 INSERT
ENDIF.
*      GCF_SPC 'BDC_OKCODE' GCF_VW,            " OKコード(次画面)
*      GCF_SPC 'KNB1-ZUAWA' GDS_REC-ZUAWA,     " ソートキー
*--------------------------------------------- 2010/06/22 DELETE START
*      GCF_SPC 'KNB1-KNRZE' GDS_REC-KNRZE,     " 本店勘定コード
*--------------------------------------------- 2010/06/22 DELETE END
*      GCF_SPC 'KNB1-FDGRV' GDS_REC-FDGRV,     " 計画グループ
*      GCF_SPC 'KNB1-ALTKN' GDS_REC-ALTKN.     " 旧勘定コード       "2010/01/19 INSERT
**** END UPD 2014/09/29 ISID18 ****
IF WA_TCODE = GCF_XD01.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-AKONT' GDS_REC-AKONT.   " 統制勘定コード
ENDIF.
ENDFORM.                    " FRM_SET_0210

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0215
*&---------------------------------------------------------------------*
*       支払処理画面にデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0215 .
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM      GCF_0215,          " 画面設定
**** START UPD 2014/09/29 ISID18 ****
GCF_SPC 'BDC_OKCODE' GCF_VW.
IF GDS_REC-ZTERM_F IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ZTERM' GDS_REC-ZTERM_F.    " 支払条件
ENDIF.
IF GDS_REC-TOGRU IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-TOGRU' GDS_REC-TOGRU.     " 許容グループ
ENDIF.
IF GDS_REC-GUZTE IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-GUZTE' GDS_REC-GUZTE.     " クレジットメモ支払条件
ENDIF.
IF GDS_REC-XZVER IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-XZVER' GDS_REC-XZVER.     " 支払履歴記録
ENDIF.
IF GDS_REC-ZWELS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ZWELS' GDS_REC-ZWELS.     " 支払方法
ENDIF.
IF GDS_REC-ZAHLS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ZAHLS' GDS_REC-ZAHLS.     " 支払保留キー
ENDIF.
IF GDS_REC-HBKID IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-HBKID' GDS_REC-HBKID.     " 取引銀行ID
ENDIF.
IF GDS_REC-ZGRUP IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ZGRUP' GDS_REC-ZGRUP.     " グループキー
ENDIF.
IF GDS_REC-XPORE IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-XPORE' GDS_REC-XPORE.     " 個別支払
ENDIF.
*      GCF_SPC 'BDC_OKCODE' GCF_VW,            " OKコード(次画面)
**--------------------------------------------- 2010/01/13 UPDATE START
**      GCF_SPC 'KNB1-ZTERM' GDS_REC-ZTERM,     " 支払条件
*      GCF_SPC 'KNB1-ZTERM' GDS_REC-ZTERM_F,    " 支払条件
**--------------------------------------------- 2010/01/13 UPDATE END
**--------------------------------------------- 2010/01/26 INSERT START
*      GCF_SPC 'KNB1-TOGRU' GDS_REC-TOGRU,     " 許容グループ
*      GCF_SPC 'KNB1-GUZTE' GDS_REC-GUZTE,     " クレジットメモ支払条件
**--------------------------------------------- 2010/01/28 INSERT END
*      GCF_SPC 'KNB1-XZVER' GDS_REC-XZVER,     " 支払履歴記録
*      GCF_SPC 'KNB1-ZWELS' GDS_REC-ZWELS,     " 支払方法
*      GCF_SPC 'KNB1-ZAHLS' GDS_REC-ZAHLS,     " 支払保留キー
**      GCF_SPC 'KNB1-KNRZB' GDS_REC-KNRZB,     " 代理支払人勘定   "2010/01/13 DELETE
*      GCF_SPC 'KNB1-HBKID' GDS_REC-HBKID,     " 取引銀行ID
**--------------------------------------------- 2010/01/26 INSERT START
*      GCF_SPC 'KNB1-ZGRUP' GDS_REC-ZGRUP,     " グループキー
*      GCF_SPC 'KNB1-XPORE' GDS_REC-XPORE.     " 個別支払
**** END UPD 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/01/28 INSERT END
*--------------------------------------------- 2010/01/13 DELETE START
*  IF NOT GDS_REC-LIFNR IS INITIAL AND
*         GDS_REC-XVERR = GCF_CHK.
*    PERFORM
*      FRM_BDCDATA_SET USING:
*        GCF_SPC 'KNB1-XVERR' GDS_REC-XVERR.   " 仕入先との相殺
*  ENDIF.
*--------------------------------------------- 2010/01/13 DELETE END
ENDFORM.                    " FRM_SET_0215

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0220
*&---------------------------------------------------------------------*
*       連絡文書画面にデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0220 .
PERFORM
FRM_BDCDATA_SET USING:
**** START UPD 2014/09/29 ISID18 ****
*      GCF_CHK GCF_PGM      GCF_0220,          " 画面設定
*      GCF_SPC 'BDC_OKCODE' GCF_VW,            " OKコード(次画面)     "2010/01/26 DELETE
*      GCF_SPC 'KNB1-BUSAB' GDS_REC-BUSAB,     " 記帳担当者
*      GCF_SPC 'KNB1-EIKTO' GDS_REC-EIKTO_B,   " 得意先自社勘定
*      GCF_SPC 'KNB1-ZSABE' GDS_REC-ZSABE,     " 得意先担当者
*      GCF_SPC 'KNB1-TLFNS' GDS_REC-TLFNS,     " 記帳担当電話No.       "2010/01/13 INSERT
*      GCF_SPC 'KNB1-TLFXS' GDS_REC-TLFXS,     " 経理担当者Fax
*      GCF_SPC 'KNB1-INTAD' GDS_REC-INTAD,     " 担当者インターネット
*      GCF_SPC 'KNB1-KVERM' GDS_REC-KVERM.     " コメント
GCF_CHK GCF_PGM      GCF_0220.          " 画面設定
IF GDS_REC-BUSAB IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-BUSAB' GDS_REC-BUSAB.     " 記帳担当者
ENDIF.
IF GDS_REC-EIKTO_B IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-EIKTO' GDS_REC-EIKTO_B.   " 得意先自社勘定
ENDIF.
IF GDS_REC-ZSABE IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-ZSABE' GDS_REC-ZSABE.     " 得意先担当者
ENDIF.
IF GDS_REC-TLFNS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-TLFNS' GDS_REC-TLFNS.     " 記帳担当電話No.       "2010/01/13 INSERT
ENDIF.
IF GDS_REC-TLFXS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-TLFXS' GDS_REC-TLFXS.     " 経理担当者Fax
ENDIF.
IF GDS_REC-INTAD IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-INTAD' GDS_REC-INTAD.     " 担当者インターネット
ENDIF.
IF GDS_REC-KVERM IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNB1-KVERM' GDS_REC-KVERM.     " コメント
ENDIF.
**** END UPD 2014/09/29 ISID18 ****

*-▼ 勘定グループがFI用以外の場合、販売エリアデータセット
IF WA_KTOKD_FI IS INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'BDC_OKCODE' GCF_VW.            " OKコード(次画面)
*-▼ 勘定グループがFI用の場合、保存
ELSE.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'BDC_OKCODE' GCF_UPDA.          " OKコード(保存)
ENDIF.
ENDFORM.                    " FRM_SET_0220
*--------------------------------------------- 2010/01/13 DELETE START
**&---------------------------------------------------------------------*
**&      Form  FRM_SET_0230
**&---------------------------------------------------------------------*
**       保険画面にデータセット
**----------------------------------------------------------------------*
*FORM FRM_SET_0230 .
*  PERFORM
*    FRM_BDCDATA_SET USING:
*      GCF_CHK GCF_PGM      GCF_0230,        " 画面設定
*      GCF_SPC 'BDC_OKCODE' GCF_VW.          " OKコード(次画面)
*ENDFORM.                    " FRM_SET_0230

**&---------------------------------------------------------------------*
**&      Form  FRM_SET_0610
**&---------------------------------------------------------------------*
**       源泉徴収税画面にデータセット
**----------------------------------------------------------------------*
*FORM FRM_SET_0610 .
*  PERFORM
*    FRM_BDCDATA_SET USING:
*      GCF_CHK GCF_PGM      GCF_0610,        " 画面設定
*      GCF_SPC 'BDC_OKCODE' GCF_UPDA.        " OKコード(保存)
*ENDFORM.                    " FRM_SET_0610
*--------------------------------------------- 2010/01/13 DELETE END

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_XD02
*&---------------------------------------------------------------------*
*       変更用BDCデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_XD02 .
PERFORM:                             " 一般データ
FRM_SET_0101,                      " 第一画面
FRM_SET_0111,                      " 住所
FRM_SET_0120,                      " 管理
FRM_SET_0125.                      " マーケティング他
*--------------------------------------------- 2010/01/19 INSERT START
*-▼ 勘定グループが出荷先以外の場合、会社コードデータセット
IF WA_KTOKD_SH IS INITIAL.
PERFORM:                             " 会社コードデータ
*--------------------------------------------- 2010/01/19 INSERT END
FRM_SET_0210,                      " 会計情報
FRM_SET_0215,                      " 支払処理
FRM_SET_0220.                      " 連絡文書
*      FRM_SET_0230.                      " 保険          "2010/01/19 DELETE
ENDIF.                                                  "2010/01/19 INSERT
*--------------------------------------------- 2010/01/13 INSERT START
*-▼ 勘定グループがFI用以外の場合、販売エリアデータセット
IF WA_KTOKD_FI IS INITIAL.
PERFORM:                             " 販売エリアデータ
FRM_SET_0310,                      " 受注
FRM_SET_0315,                      " 出荷管理
FRM_SET_0320_1350.                 " 請求伝票
ENDIF.
*--------------------------------------------- 2010/01/13 INSERT END
ENDFORM.                               " FRM_SET_XD02

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0101
*&---------------------------------------------------------------------*
*       第一画面にデータセット(変更)
*----------------------------------------------------------------------*
FORM FRM_SET_0101 .
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM       GCF_0101,         " 画面設定
GCF_SPC 'BDC_OKCODE'  GCF_ENTR,         " OKコード(ENTER)
GCF_SPC 'RF02D-KUNNR' GDS_REC-KUNNR,    " 得意先コード
GCF_SPC 'RF02D-BUKRS' GDS_REC-BUKRS,    " 会社コード
GCF_SPC 'RF02D-VKORG' GDS_REC-VKORG,    " 販売組織
GCF_SPC 'RF02D-VTWEG' GDS_REC-VTWEG,    " 流通チャネル
GCF_SPC 'RF02D-SPART' GDS_REC-SPART,    " 製品部門
GCF_SPC 'USE_ZAV'     GCF_CHK,          " 共通アドレス管理使用
GCF_SPC 'RF02D-D0110' GCF_CHK,          " アドレス
GCF_SPC 'RF02D-D0120' GCF_CHK,          " 管理データ
*--------------------------------------------- 2010/01/26 DELETE START
GCF_SPC 'RF02D-D0125' GCF_CHK,          " マーケティング
GCF_SPC 'RF02D-D0130' GCF_CHK,          " 支払い処理           "2011/03/29 mod
*--------------------------------------------- 2010/01/26 DELETE END
GCF_SPC 'RF02D-D0340' GCF_CHK,          " 荷渡ポイント
*      GCF_SPC 'RF02D-D0370' GCF_CHK,          " 貿易                "2010/01/26 DELETE
GCF_SPC 'RF02D-D0360' GCF_CHK,          " 取引先担当者
GCF_SPC 'RF02D-D0210' GCF_CHK,          " 会計情報
GCF_SPC 'RF02D-D0215' GCF_CHK,          " 支払処理
GCF_SPC 'RF02D-D0220' GCF_CHK.          " 連絡先
*      GCF_SPC 'RF02D-D0230' GCF_CHK,          " 保険                "2010/01/26 DELETE
*--------------------------------------------- 2010/01/13 INSERT START
* #005 MOD 20110217 ISID144 START
*      GCF_SPC 'RF02D-D0310' GCF_CHK,          " 受注
*      GCF_SPC 'RF02D-D0315' GCF_CHK,          " 出荷
*      GCF_SPC 'RF02D-D0320' GCF_CHK.          " 請求処理
IF WA_KTOKD_FI IS INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'RF02D-D0310' GCF_CHK,        " 受注
GCF_SPC 'RF02D-D0315' GCF_CHK,        " 出荷
GCF_SPC 'RF02D-D0320' GCF_CHK.        " 請求処理
ENDIF.
* #005 MOD 20110217 ISID144 END
*--------------------------------------------- 2010/01/13 INSERT END
ENDFORM.                    " FRM_SET_0101

*&---------------------------------------------------------------------*
*&      Form  FRM_BDCDATA_SET
*&---------------------------------------------------------------------*
*       BDCテーブルにデータをセット
*----------------------------------------------------------------------*
*      -->P_IDYNBGN  フラグ
*      -->P_INAME    プログラム名　or　項目名
*      -->P_IVALUE   DYNPRO番号　or　項目値
*----------------------------------------------------------------------*
FORM FRM_BDCDATA_SET USING    VALUE(P_IDYNBGN)
VALUE(P_INAME)
VALUE(P_IVALUE).
CLEAR GDS_BDC.
IF P_IDYNBGN = GCF_CHK.
GDS_BDC-PROGRAM  = P_INAME.          " プログラム番号
GDS_BDC-DYNPRO   = P_IVALUE.         " DYNPRO番号
GDS_BDC-DYNBEGIN = GCF_CHK.          " DYNPRO開始区分
ELSE.
GDS_BDC-FNAM = P_INAME.              " 項目名
GDS_BDC-FVAL = P_IVALUE.             " 項目値
ENDIF.
APPEND GDS_BDC TO GDT_BDC.
ENDFORM.                    " FRM_BDCDATA_SET

*&---------------------------------------------------------------------*
*&      Form  FRM_BDC_OPEN
*&---------------------------------------------------------------------*
*       バッチインプットセッションのオープン処理
*----------------------------------------------------------------------*
FORM FRM_BDC_OPEN.

*  DATA: LDF_MSGV1(50) TYPE C.             " メッセージ変数１ "#004 DEL

* セッションを開く
CALL FUNCTION 'BDC_OPEN_GROUP'
EXPORTING
CLIENT              = SY-MANDT      " クライアント
GROUP               = SY-UNAME      " セッション名称
KEEP                = GCF_CHK       " 保存
USER                = SY-UNAME      " 実行ユーザ名
EXCEPTIONS
CLIENT_INVALID      = 1
DESTINATION_INVALID = 2
GROUP_INVALID       = 3
GROUP_IS_LOCKED     = 4
HOLDDATE_INVALID    = 5
INTERNAL_ERROR      = 6
QUEUE_ERROR         = 7
RUNNING             = 8
SYSTEM_LOCK_ERROR   = 9
USER_INVALID        = 10
OTHERS              = 11.
CASE SY-SUBRC.
WHEN 0.
WHEN OTHERS.
* #004 MOD 20110207 ISID144 START
**     メッセージ変数のセット
*      CASE SY-LANGU.
*        WHEN GCF_LA_J.                     " 日本語
*          LDF_MSGV1 = GCF_TXT8J.           "'BDC_OPEN 異常終了　例外：'
*        WHEN GCF_LA_1.                     " 中国語
*          LDF_MSGV1 = GCF_TXT8C.           "'BDC_OPEN #生##  代#：'
*        WHEN GCF_LA_E.                     " 英語
*          LDF_MSGV1 = GCF_TXT8E.
*          "'Error during BDC_OPEN processing. Exception:'
*      ENDCASE.
*      MESSAGE E398 WITH LDF_MSGV1 SY-SUBRC SPACE SPACE.
MESSAGE S018(ZFI001)
WITH SY-SUBRC
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDCASE.
ENDFORM.                    " FRM_BDC_OPEN

*&---------------------------------------------------------------------*
*&      Form  FRM_BDC_INSERT
*&---------------------------------------------------------------------*
*       バッチインプットセッションへのトランザクション用データ挿入処理
*----------------------------------------------------------------------*
FORM FRM_BDC_INSERT.

*  DATA: LDF_MSGV1(50) TYPE C.         " メッセージ変数１ "#004 DEL

CHECK FLG_ERR = SPACE.
* BDCテーブルのデータをセッションにセット
CALL FUNCTION 'BDC_INSERT'
EXPORTING
TCODE            = WA_TCODE     " トランザクションコード
TABLES
DYNPROTAB        = GDT_BDC      " BDCテーブル
EXCEPTIONS
INTERNAL_ERROR   = 1
NOT_OPEN         = 2
QUEUE_ERROR      = 3
TCODE_INVALID    = 4
PRINTING_INVALID = 5
POSTING_INVALID  = 6
OTHERS           = 7.
CASE SY-SUBRC.
WHEN 0.
WHEN OTHERS.
* #004 MOD 20110207 ISID144 START
**     メッセージ変数のセット
*      CASE SY-LANGU.
*        WHEN GCF_LA_J.                     " 日本語
*          LDF_MSGV1 = GCF_TXT9J.           "'BDC_INSERT 異常終了　例外：'
*        WHEN GCF_LA_1.                     " 中国語
*          LDF_MSGV1 = GCF_TXT9C.           "'BDC_INSERT #生##  代#：'
*        WHEN GCF_LA_E.                     " 英語
*          LDF_MSGV1 = GCF_TXT9E.
*          "'Error during BDC_INSERT processing. Exception:'
*      ENDCASE.
*      MESSAGE E398 WITH LDF_MSGV1 SY-SUBRC SPACE SPACE.
MESSAGE S039(ZFI001)
WITH SY-SUBRC
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDCASE.
ENDFORM.                    " FRM_BDC_INSERT

*&---------------------------------------------------------------------*
*&      Form  FRM_BDC_CLOSE
*&---------------------------------------------------------------------*
*       バッチインプットセッションのクローズ処理
*----------------------------------------------------------------------*
FORM FRM_BDC_CLOSE.

*  DATA: LDF_MSGV1(50) TYPE C.              " メッセージ変数１ "#004 DEL

* セッションを閉じる
CALL FUNCTION 'BDC_CLOSE_GROUP'
EXCEPTIONS
NOT_OPEN    = 1
QUEUE_ERROR = 2
OTHERS      = 3.
CASE SY-SUBRC.
WHEN 0.
WHEN OTHERS.
* #004 MOD 20110207 ISID144 START
**     メッセージ変数のセット
*      CASE SY-LANGU.
*        WHEN GCF_LA_J.                     " 日本語
*          LDF_MSGV1 = GCF_TXT10J.          "'BDC_CLOSE 異常終了　例外：'
*        WHEN GCF_LA_1.                     " 中国語
*          LDF_MSGV1 = GCF_TXT10C.          "'BDC_CLOSE #生##  代#：'
*        WHEN GCF_LA_E.                     " 英語
*          LDF_MSGV1 = GCF_TXT10E.
*          "'Error during BDC_CLOSE processing. Exception:'
*      ENDCASE.
*      MESSAGE E398 WITH LDF_MSGV1 SY-SUBRC SPACE SPACE.
MESSAGE S040(ZFI001)
WITH SY-SUBRC
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END
ENDCASE.
ENDFORM.                    " FRM_BDC_CLOSE

*&---------------------------------------------------------------------*
*&      Form  FRM_CALL_RSBDCSUB
*&---------------------------------------------------------------------*
*       セッションの自動処理
*----------------------------------------------------------------------*
FORM FRM_CALL_RSBDCSUB.

*  DATA: LDF_MSGV1(50) TYPE C.         " メッセージ変数１ "#004 DEL

* セッションを処理
SUBMIT RSBDCSUB                 " バッチインプット: 全セッション処理
WITH MAPPE    = SY-UNAME           " セッション
WITH Z_VERARB = GCF_CHK            " 新規
WITH FEHLER   = ' '                " エラー
AND RETURN.

* #004 MOD 20110207 ISID144 START
** メッセージ変数のセット
*  CASE SY-LANGU.
*    WHEN GCF_LA_J.                     " 日本語
*      LDF_MSGV1 = GCF_TXT11J.          "'セッションログを確認してください'
*    WHEN GCF_LA_1.                     " 中国語
*      LDF_MSGV1 = GCF_TXT11C.          "'###批#入会##理##'
*    WHEN GCF_LA_E.                     " 英語
*      LDF_MSGV1 = GCF_TXT11E.          "'Check the logs of session.'
*  ENDCASE.
*  MESSAGE I398 WITH SY-UNAME LDF_MSGV1 SPACE SPACE.
MESSAGE I083(ZFI001) WITH SY-UNAME.
* #004 MOD 20110207 ISID144 END

ENDFORM.                    " FRM_CALL_RSBDCSUB
* #004 DEL 20110207 ISID144 START
**&---------------------------------------------------------------------*
**&      Form  FRM_SET_TITLE
**&---------------------------------------------------------------------*
**       プログラム表題の設定
**----------------------------------------------------------------------*
*FORM FRM_SET_TITLE .
*
*  CASE SY-LANGU.
*    WHEN GCF_LA_J.                     " 日本語
**    初期値のまま
*    WHEN GCF_LA_1.                     " 中国語
*      SY-TITLE = GCF_TITLE_1.          "'客#主数据上#'
*    WHEN GCF_LA_E.                     " 英語
*      SY-TITLE = GCF_TITLE_E.          "'Upload the G/L Account master records'
*  ENDCASE.
*
*ENDFORM.                    " FRM_SET_TITLE
* #004 DEL 20110207 ISID144 END
*&---------------------------------------------------------------------*
*&      Form  FRM_N_U_SET
*&---------------------------------------------------------------------*
*       制御コード項目の登録(N)/変更(U)設定
*----------------------------------------------------------------------*
FORM FRM_N_U_SET .
DATA:LDF_KUNNR TYPE KNA1-KUNNR.
* 得意先マスタ（一般）の存在チェック
SELECT SINGLE KUNNR                      " 得意先コード
INTO LDF_KUNNR
FROM KNA1                              " 得意先マスタ：一般データ
WHERE KUNNR = WA_KUNNR.                 " 得意先コード
CASE SY-SUBRC.
WHEN 0.
* 得意先マスタ（一般）の存在チェック
SELECT SINGLE KUNNR                    " 得意先コード
INTO LDF_KUNNR
FROM KNB1                            " 得意先マスタ：一般データ
WHERE KUNNR = WA_KUNNR    AND        " 得意先コード
BUKRS = GDS_REC-BUKRS.         " 会社コード
CASE SY-SUBRC.
WHEN 0.
GDS_REC-FLAG = GCF_CTRU.          " 変更(U)設定
WHEN OTHERS.
GDS_REC-FLAG = GCF_CTRN.          " 登録(N)設定
ENDCASE.
WHEN OTHERS.
GDS_REC-FLAG = GCF_CTRN.              " 登録(N)設定
ENDCASE.
ENDFORM.                                    " FRM_N_U_SET

*&---------------------------------------------------------------------*
*&      Form  FRM_ALPHA_INSERT
*&---------------------------------------------------------------------*
*       アルファ変換
*----------------------------------------------------------------------*
*      -->P_IDATA   変換前文字列
*      <--P_ODATA   変換後文字列
*----------------------------------------------------------------------*
FORM FRM_ALPHA_INSERT USING     P_IDATA
CHANGING  P_ODATA.
CLEAR P_ODATA.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = P_IDATA          " 変換前文字列
IMPORTING
OUTPUT = P_ODATA.         " 変換後文字列
ENDFORM.                    " FRM_ALPHA_INSERT

*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_CHECK_DATA .

*  DATA:LDF_MSGV1(50) TYPE C.           " メッセージ変数１ "#004 DEL

* ファイルのループ処理（対象は、N:新規 U:更新フラグを持つもののみ)
LOOP AT GDT_REC INTO GDS_REC WHERE FLAG = GCF_CTRN   " N
OR    FLAG = GCF_CTRU . " U
EXIT.

ENDLOOP.

* 処理件数のカウント
CHECK SY-SUBRC <> 0.
* #004 MOD 20110207 ISID144 START
**   メッセージ変数のセット
*  CASE SY-LANGU.
*    WHEN GCF_LA_J.                                     " 日本語
*      LDF_MSGV1 = GCF_TXT6J.                           " 'タブ区切りファイルにデータが存在しません'
*    WHEN GCF_LA_1.                                     " 中国語
*      LDF_MSGV1 = GCF_TXT6C.                           " 'TAB#隔文本文件中没有数据'
*    WHEN GCF_LA_E.                                     " 英語
*      LDF_MSGV1 = GCF_TXT6E.                           " 'TAB file is empty.'
*  ENDCASE.
*  MESSAGE E398 WITH LDF_MSGV1 SPACE SPACE SPACE.
MESSAGE S015(ZFI001) DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
* #004 MOD 20110207 ISID144 END

ENDFORM.                    " FRM_CHECK_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0310
*&---------------------------------------------------------------------*
*       販売エリアデータ受注タブにデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0310 .

PERFORM
FRM_BDCDATA_SET USING:
**** START UPD 2014/09/29 ISID18 ****
GCF_CHK GCF_PGM      GCF_0310.             " 画面設定
IF GDS_REC-BZIRK IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-BZIRK' GDS_REC-BZIRK.        " 販売地域
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
*      GCF_CHK GCF_PGM      GCF_0310,             " 画面設定
*      GCF_SPC 'KNVV-BZIRK' GDS_REC-BZIRK,        " 販売地域
GCF_SPC 'KNVV-VKBUR' GDS_REC-VKBUR,        " 営業所
GCF_SPC 'KNVV-VKGRP' GDS_REC-VKGRP,        " 営業グループ
*--------------------------------------------- 2010/06/22 DELETE START
*      GCF_SPC 'KNVV-VSORT' GDS_REC-VSORT,        " 明細提案
*--------------------------------------------- 2010/06/22 DELETE END
GCF_SPC 'KNVV-KDGRP' GDS_REC-KDGRP,        " 得意先グループ
GCF_SPC 'KNVV-EIKTO' GDS_REC-EIKTO_V,      " 得意先自社勘定
GCF_SPC 'KNVV-VERSG' GDS_REC-VERSG,        " Cus統計グループ
**** END UPD 2014/09/29 ISID18 ****
*--------------------------------------------- 2010/06/22 DELETE START
*      GCF_SPC 'KNVV-KLABC' GDS_REC-KLABC,        " ABC　分類
*--------------------------------------------- 2010/06/22 DELETE END
**** START UPD 2014/09/29 ISID18 ****
GCF_SPC 'KNVV-WAERS' GDS_REC-WAERS.        " 通貨コード
IF GDS_REC-KURST IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-KURST' GDS_REC-KURST.        " 換算 Ｒａｔｅタイプ
ENDIF.
IF GDS_REC-RDOFF IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-RDOFF' GDS_REC-RDOFF.        " 丸め解除
ENDIF.
IF GDS_REC-KONDA IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-KONDA' GDS_REC-KONDA.        " 価格グループ
ENDIF.
IF GDS_REC-KALKS IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-KALKS' GDS_REC-KALKS.        " 得意先価格決定
ENDIF.
IF GDS_REC-PLTYP IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-PLTYP' GDS_REC-PLTYP.        " 価格表
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
*      GCF_SPC 'KNVV-WAERS' GDS_REC-WAERS,        " 通貨コード
*      GCF_SPC 'KNVV-KURST' GDS_REC-KURST,        " 換算 Ｒａｔｅタイプ
*      GCF_SPC 'KNVV-RDOFF' GDS_REC-RDOFF,        " 丸め解除
*      GCF_SPC 'KNVV-KONDA' GDS_REC-KONDA,        " 価格グループ
*      GCF_SPC 'KNVV-KALKS' GDS_REC-KALKS,        " 得意先価格決定
*      GCF_SPC 'KNVV-PLTYP' GDS_REC-PLTYP,        " 価格表
**** START UPD 2014/09/29 ISID18 ****
GCF_SPC 'BDC_OKCODE' GCF_NEXT.             " OKコード(次画面)

ENDFORM.                    " FRM_SET_0310
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0315
*&---------------------------------------------------------------------*
*       販売エリアデータ出荷管理タブにデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0315 .

PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM      GCF_0315.             " 画面設定
*--------------------------------------------- 2010/03/17 INSERT START
IF GDS_REC-LPRIO IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
*--------------------------------------------- 2010/03/17 INSERT END
GCF_SPC 'KNVV-LPRIO' GDS_REC-LPRIO.        " 出荷優先順位
*--------------------------------------------- 2010/03/17 INSERT START
ENDIF.

PERFORM
FRM_BDCDATA_SET USING:
*--------------------------------------------- 2010/03/17 INSERT END
GCF_SPC 'KNVV-VSBED' GDS_REC-VSBED,        " 出荷条件
GCF_SPC 'KNVV-VWERK' GDS_REC-VWERK,        " 出荷プラント
GCF_SPC 'KNVV-AUTLF' GDS_REC-AUTLF,        " 一括納入
GCF_SPC 'KNVV-KZTLF' GDS_REC-KZTLF,        " 分割納入(明細別)
GCF_SPC 'KNVV-ANTLF' GDS_REC-ANTLF,        " 分割納入(最大)
GCF_SPC 'KNVV-UEBTK' GDS_REC-UEBTK,        " 無制限許容
GCF_SPC 'KNVV-UNTTO' GDS_REC-UNTTO,        " 不足納入許容範囲
GCF_SPC 'KNVV-UEBTO' GDS_REC-UEBTO,        " 過剰納入許容範囲
GCF_SPC 'BDC_OKCODE' GCF_NEXT.             " OKコード(次画面)

ENDFORM.                    " FRM_SET_0315
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0320_1350
*&---------------------------------------------------------------------*
*       販売エリアデータ請求伝票タブにデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0320_1350 .

PERFORM
FRM_BDCDATA_SET USING:
**** START UPD 2014/09/29 ISID18 ****
GCF_CHK GCF_PGM          GCF_0320.         " 画面設定
IF GDS_REC-MRNKZ IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-MRNKZ'     GDS_REC-MRNKZ.    " 請求伝票継続処理
ENDIF.
IF GDS_REC-INCO1 IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-INCO1'     GDS_REC-INCO1.    " インコタームズ１
ENDIF.
IF GDS_REC-INCO2 IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'KNVV-INCO2'     GDS_REC-INCO2.    " インコタームズ２
ENDIF.
PERFORM
FRM_BDCDATA_SET USING:
*      GCF_CHK GCF_PGM          GCF_0320,         " 画面設定
*      GCF_SPC 'KNVV-MRNKZ'     GDS_REC-MRNKZ,    " 請求伝票継続処理
*--------------------------------------------- 2010/06/22 DELETE START
**      GCF_SPC 'KNVV-BOKRE'     GDS_REC-BOKRE,    " リベート
**      GCF_SPC 'KNVV-PRFRE'     GDS_REC-PRFRE,    " 価格決定
**      GCF_SPC 'KNVV-PERFK'     GDS_REC-PERFK,    " 請求書日付
**      GCF_SPC 'KNVV-PERRL'     GDS_REC-PERRL,    " 請求書一覧日付
*--------------------------------------------- 2010/06/22 DELETE END
*      GCF_SPC 'KNVV-INCO1'     GDS_REC-INCO1,    " インコタームズ１
*      GCF_SPC 'KNVV-INCO2'     GDS_REC-INCO2,    " インコタームズ２
**** END UPD 2014/09/29 ISID18 ****
GCF_SPC 'KNVV-ZTERM'     GDS_REC-ZTERM_V,  " 支払条件
GCF_SPC 'KNVV-KTGRD'     GDS_REC-KTGRD,    " 勘定設定グループ
GCF_SPC 'BDC_OKCODE'     GCF_NEXT,         " OKコード(次画面)
GCF_CHK GCF_PGM          GCF_1350,         " 画面設定
GCF_SPC 'KNVI-TAXKD(01)' GDS_REC-TAXKD,    " 税分類
GCF_SPC 'BDC_OKCODE'     GCF_ENTR,         " OKコード(次画面)
GCF_CHK GCF_PGM          GCF_1350.         " 画面設定

*--- OKコードセット ---*
*-▼ 制御コード判断
CASE GDS_REC-FLAG.
*---▼ 新規登録(N)の場合
WHEN GCF_CTRN.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'BDC_OKCODE' GCF_ENTR.         " OKコード(次画面)
**** START ADD 2014/09/29 ISID18 ****
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM      GCF_0326,         " 画面設定
GCF_SPC 'BDC_OKCODE' GCF_ENTR.         " OKコード(次画面)
**** END ADD 2014/09/29 ISID18 ****
*---▼ 更新(U)の場合
WHEN GCF_CTRU.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'BDC_OKCODE' GCF_UPDA.         " OKコード(保存)
ENDCASE.

ENDFORM.                    " FRM_SET_0320_1350
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_0324
*&---------------------------------------------------------------------*
*       販売エリアデータ取引先機能タブにデータセット
*----------------------------------------------------------------------*
FORM FRM_SET_0324 .

*--- 画面設定 ---*
PERFORM
FRM_BDCDATA_SET USING:
GCF_CHK GCF_PGM GCF_0324.

*--- 請求先 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_BP IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'RF02D-KTONR(02)' GDS_REC-KUNN2_BP.
ENDIF.

*--- 支払人 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_PY IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'RF02D-KTONR(03)' GDS_REC-KUNN2_PY.
ENDIF.

*--- 出荷先1 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_SH1 IS NOT INITIAL.
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'RF02D-KTONR(04)' GDS_REC-KUNN2_SH1.
ENDIF.

*--- 出荷先2 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_SH2 IS NOT INITIAL.
PERFORM FRM_SET_KTONR_DATA USING GCF_SH              " 取引先機能
GDS_REC-KUNN2_SH2.  " 取引先番号
ENDIF.

*--- 出荷先3 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_SH3 IS NOT INITIAL.
PERFORM FRM_SET_KTONR_DATA USING GCF_SH              " 取引先機能
GDS_REC-KUNN2_SH3.  " 取引先番号
ENDIF.

*--- 出荷先4 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_SH4 IS NOT INITIAL.
PERFORM FRM_SET_KTONR_DATA USING GCF_SH              " 取引先機能
GDS_REC-KUNN2_SH4.  " 取引先番号
ENDIF.

*--- 出荷先5 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_SH5 IS NOT INITIAL.
PERFORM FRM_SET_KTONR_DATA USING GCF_SH              " 取引先機能
GDS_REC-KUNN2_SH5.  " 取引先番号
ENDIF.

*--- 海貨業者 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_CR IS NOT INITIAL.
PERFORM FRM_SET_KTONR_DATA USING GCF_CR              " 取引先機能
GDS_REC-KUNN2_CR.   " 取引先番号
ENDIF.

*--- 営業員 ---*
*-▼ 項目値がセットされている場合、設定
IF GDS_REC-KUNN2_PE IS NOT INITIAL.
PERFORM FRM_SET_KTONR_DATA USING GCF_PE              " 取引先機能
GDS_REC-KUNN2_PE.   " 取引先番号
ENDIF.

*--- OKコード ---*
PERFORM
FRM_BDCDATA_SET USING:
GCF_SPC 'BDC_OKCODE' GCF_UPDA.         " OKコード(次画面)

ENDFORM.                    " FRM_SET_0324
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_ZCAT_MA001
*&---------------------------------------------------------------------*
*       アドオン変数管理テーブル検索
*----------------------------------------------------------------------*
FORM FRM_SELECT_ZCAT_MA001 .

SELECT NAME KEY01 LOW
INTO CORRESPONDING FIELDS OF TABLE GDT_ZCAT_MA001
FROM ZCAT_MA001
WHERE NAME  = GCF_KTOKD        " アドオン変数名
AND PRGNM = SY-CPROG.        " プログラムID

ENDFORM.                    " FRM_SELECT_ZCAT_MA001
*&---------------------------------------------------------------------*
*&      Form  FRM_READ_ZCAT_MA001
*&---------------------------------------------------------------------*
*       勘定グループ取得
*----------------------------------------------------------------------*
*      -->PU_PARVW      取引先機能
*      <--PU_KTOKD      勘定グループ
*----------------------------------------------------------------------*
FORM FRM_READ_ZCAT_MA001 USING    PU_PARVW
CHANGING PU_KTOKD.

CLEAR : GDS_ZCAT_MA001.
READ TABLE GDT_ZCAT_MA001 INTO GDS_ZCAT_MA001
WITH KEY NAME  = GCF_KTOKD      " アドオン変数名
KEY01 = PU_PARVW       " 検索キー1
LOW   = GDS_REC-KTOKD. " 勘定グループ

*-▼ 取得できた場合、勘定グループセット
CHECK SY-SUBRC = 0.
PU_KTOKD = GDS_ZCAT_MA001-LOW.

ENDFORM.                    " FRM_READ_ZCAT_MA001
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_KTONR_DATA
*&---------------------------------------------------------------------*
*       取引先機能データセット
*----------------------------------------------------------------------*
*      -->PU_PARVW      取引先機能
*      -->PU_KTONR      取引先番号
*----------------------------------------------------------------------*
FORM FRM_SET_KTONR_DATA  USING PU_PARVW
PU_KTONR.

DATA : LDF_FNAM TYPE BDCDATA-FNAM.       " 項目名

*--- 新規登録行取得 ---*
IF CNT_RECORD IS INITIAL.
CNT_RECORD = 5.
ELSE.
CNT_RECORD = CNT_RECORD + 1.
ENDIF.

*--- 取引先機能BDCデータセット ---*
CLEAR : LDF_FNAM.
CONCATENATE 'KNVP-PARVW(' CNT_RECORD ')'
INTO LDF_FNAM.
PERFORM FRM_BDCDATA_SET USING GCF_SPC
LDF_FNAM
PU_PARVW.

*--- 取引先番号BDCデータセット ---*
CLEAR : LDF_FNAM.
CONCATENATE 'RF02D-KTONR(' CNT_RECORD ')'
INTO LDF_FNAM.
PERFORM FRM_BDCDATA_SET USING GCF_SPC
LDF_FNAM
PU_KTONR.

ENDFORM.                    " FRM_SET_KTONR_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_RESULT
*&---------------------------------------------------------------------*
*       プログラム処理件数表示
*----------------------------------------------------------------------*
FORM FRM_WRITE_RESULT .

DATA:
LDF_LINE01(100)  TYPE C,
LDF_LINE02(50)   TYPE C,
LDF_INDEX(5)     TYPE C.

LDF_INDEX = CNT_INDEX.

CONCATENATE '**************<' SY-TITLE '>**************' INTO LDF_LINE01 SEPARATED BY SPACE.
CONCATENATE '*   ' TEXT-005 '      ='  LDF_INDEX       INTO LDF_LINE02 SEPARATED BY SPACE.
WRITE:
/ LDF_LINE01,
/ LDF_LINE02.

ENDFORM.                    " FRM_WRITE_RESULT
*&---------------------------------------------------------------------*
*&      Form  FRM_INPUT_CHECK
*&---------------------------------------------------------------------*
*       入力チェック                                           "#004 ADD
*----------------------------------------------------------------------*
FORM FRM_INPUT_CHECK .

DATA:
LDT_REC    TYPE STANDARD TABLE OF GTT_REC.

* 会社コードの権限チェック
LDT_REC[] = GDT_REC[].
* #007 ADD 20140909 ISID156 START
DELETE LDT_REC WHERE FLAG <> GCF_CTRN   " N
AND FLAG <> GCF_CTRU . " U
* #007 ADD 20140909 ISID156 END
SORT LDT_REC BY BUKRS.
DELETE ADJACENT DUPLICATES FROM LDT_REC
COMPARING BUKRS.
LOOP AT LDT_REC INTO GDS_REC.

AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD GDS_REC-BUKRS
ID 'ACTVT'  FIELD '01'.

IF SY-SUBRC <> 0.
MESSAGE S012(ZFI001)
WITH GDS_REC-BUKRS
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.
ENDLOOP.

ENDFORM.                    " FRM_INPUT_CHECK
*Text symbol text・
*001:Select the location for file
*002:File name
*003:Server
*004:Local
*005:The number of processes
