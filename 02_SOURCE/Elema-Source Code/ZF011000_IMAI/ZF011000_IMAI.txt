************************************************************************
* [プログラム名]
*   ZF011000      入金実績表作成
*
* [処理概要]
*   指定した得意先の入金実績を金種別に表示し、売上高も表示する。
*
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2002/01/24   PSD T.KAWAHARA    新規開発　
*  2002/02/14   PSD T.SAITOH    TPR001 バグ対応開始
*    〜
*  2002/02/23   PSD T.SAITOH    TPR001 バグ対応（確認バグ数：77）
*  2002/02/22   PSD T.SAITOH    SCR001 受手決済の抽出条件変更
*  2002/02/22   PSD T.SAITOH    SCR002 手形入金の抽出ＴＢＬを追加
*  2002/02/23   PSD T.SAITOH    SCR003 売上の抽出ＴＢＬを変更
*  2002/03/11   PSD T.SAITOH           親勘定に振替処理を追加
*  2002/03/26   PSD T.SAITOH           受注残高変更・追加
*  2002/03/28   PSD T.SAITOH           親勘定に振替処理を廃止
*  2002/03/28   PSD T.SAITOH           SELECT NUMBER 19,20,21を廃止
*  2002/03/29   PSD T.SAITOH           Select number 10,16を変更
*  2002/03/29   PSD T.SAITOH           親勘定に振替処理を復活
*  2002/03/29   PSD T.SAITOH           Select number 16関連変更
*  2002/03/29   PSD T.SAITOH           親子識別条件追加
*  2002/03/29   PSD T.SAITOH           SELECT 20,21 条件　親→子へ変更
*  2002/04/11   PSD T.SAITOH           レイアウト変更
*  2002/04/19   PSD T.SAITOH           終了メッセージ不具合対応
*  2002/04/19   PSD T.SAITOH           売掛金残高／売掛金入金予定を
*                                      前月締め分を加算し累計表示対応
*  2002/06/20   PSD T.SAITOH           再移送
*  2002/08/23   PSD T.SAITOH           明細が複数ある時金額が数倍となる
*                                      バグを修正
*  2002/08/29   psd Imai               ・8/23修正のデグレ
*　　　　　　　　　　　　　　　　　　　（明細削除するためのキー未取得）
*　　　　　　　　　　　　　　　　　　　・入金日を締め日を取得していた
*　　　　　　　　　　　　　　　　　　　・得意先マスタの親コード取得ミス
*　　　　　　　　　　　　　　　　　　　（RE→Y3に変更）
*　2002/08/31 psd Imai                 バグ修正
*　　　　　　　　　　　　　　　　　　　・与信残高
*　　　　　　　　　　　　　　　　　　　・外貨取引（売上高）
*  2002/09/03 PSD IMAI                 ・親子振替の抽出日付を支払基準日
*                                      から転記日付に変更
*  2002/09/04 PSD IMAI                 他入金を算出するように変更
*  2002/09/12 PSD IMAI                 売掛金残高、他入金の抽出変更
*                                      変更箇所[*09/05,*09/06]
************************************************************************
*---MODIFY START PSD T.SAITOH 2002/02/14 TPR001---------------------*
*REPORT  ZF010800 NO STANDARD PAGE HEADING
REPORT  ZF011000 NO STANDARD PAGE HEADING
*---MODIFY END   PSD T.SAITOH 2002/02/14 TPR001---------------------*
LINE-SIZE  120
LINE-COUNT 44(0)
MESSAGE-ID Z1.

************************************************************************
*                          TABLES                                      *
************************************************************************
TABLES:  T001,  SKB1,  KNA1,  KNB1, KNC3,  KNVV,  KNKK,  T052, T052U,
S067,  VBRK,  BSEG,  BSID, BSAD.
*---APPEND START PSD T.SAITOH 2002/03/26 ---------------------------*
tables:  s066.
*---APPEND END   PSD T.SAITOH 2002/03/26 ---------------------------*
************************************************************************
*                          DATA                                        *
*　　　　　　　 　　　グローバル変数定義　　　　　　　 　　
************************************************************************
*---APPEND START PSD T.SAITOH 2002/02/19 TPR001---------------------*
* G_E_FLG(1) がクリアのみであやしい
*---APPEND END   PSD T.SAITOH 2002/02/19 TPR001---------------------*
DATA : G_E_FLG(1)      TYPE C           ."EXITフラグ"★★★★★★★★
************************************************************************
*                        CONSTANTS                                     *
*　　　　　　　 　　　定数項目定義      　　　　　　　 　　　　　　　
************************************************************************
CONSTANTS:
C_REPTITLE(10) TYPE C VALUE '入金実績表',
C_BUKRS(10)    TYPE C VALUE '会社コード',
C_KNA1(28)     TYPE C VALUE '得意先マスタ（一般データ）',
C_KNVV(30)     TYPE C VALUE '得意先マスタ（販売データ）',
C_SKB1(10)     TYPE C VALUE '勘定コード',
C_TBL_001(4)   TYPE C VALUE 'T001',
C_TBL_002(4)   TYPE C VALUE 'KNA1',
C_TBL_003(4)   TYPE C VALUE 'SKB1',
C_TBL_004(4)   TYPE C VALUE 'KNVV',
C_TBL_005(5)   TYPE C VALUE 'T052U',
C_TBL_006(4)   TYPE C VALUE 'T052',
C_TBL_007(4)   TYPE C VALUE 'S067',
*---APPEND START PSD T.SAITOH 2002/03/26 ---------------------------*
C_TBL_S067(4)   TYPE C VALUE 'S067',
*---APPEND END   PSD T.SAITOH 2002/03/26 ---------------------------*
C_TBL_008(4)   TYPE C VALUE 'KNC3',
C_TBL_009(4)   TYPE C VALUE 'KNKK',
C_TBL_010(4)   TYPE C VALUE 'BSID',
C_TBL_011(4)   TYPE C VALUE 'BSAD',
C_TBL_012(4)   TYPE C VALUE 'BSEG',
C_TBL_013(4)   TYPE C VALUE 'VBRK',
C_TBL_014(4)   TYPE C VALUE 'VBRP'.

*8/31 START
CONSTANTS:  C_JPY(3)        TYPE C VALUE 'JPY'.
CONSTANTS:  C_YOTEI(10)     TYPE C VALUE '0002102004'.
*8/31 END
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
CONSTANTS:  C_TBL_KNVP(4)   TYPE C VALUE 'KNVP'.
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/02/20 TPR001---------------------*
CONSTANTS:CNS_MSG(64) TYPE C VALUE '存在する月以外'.
*---APPEND END   PSD T.SAITOH 2002/02/20 TPR001---------------------*
*---APPEND START PSD T.SAITOH 2002/02/23 SCR003---------------------*
CONSTANTS: CNS_A(1)       TYPE C VALUE 'A',
CNS_N(1)       TYPE C VALUE 'N',
CNS_H(1)       TYPE C VALUE 'H',
*           CNS_I(1)       TYPE C VALUE 'I',
CNS_K(1)       TYPE C VALUE 'K',
CNS_L(1)       TYPE C VALUE 'L',
CNS_M(1)       TYPE C VALUE 'M',
CNS_O(1)       TYPE C VALUE 'O',
CNS_C(1)       TYPE C VALUE 'C',
CNS_J(1)       TYPE C VALUE 'J',
CNS_S(1)       TYPE C VALUE 'S',
CNS_X(1)       TYPE C VALUE 'X',
CNS_P(1)       TYPE C VALUE 'P',
CNS_PY(2)      TYPE C VALUE 'PY',
CNS_AG(2)      TYPE C VALUE 'AG',
CNS_F2(2)      TYPE C VALUE 'F2',
CNS_KA(2)      TYPE C VALUE 'KA',
CNS_KB(2)      TYPE C VALUE 'KB',
CNS_L2(2)      TYPE C VALUE 'L2',
CNS_G2(2)      TYPE C VALUE 'G2',
CNS_SP(2)      TYPE C VALUE 'SP',
CNS_S1(2)      TYPE C VALUE 'S1',
CNS_S2(2)      TYPE C VALUE 'S2',
CNS_PE(2)      TYPE C VALUE 'PE',
CNS_RE(2)      TYPE C VALUE 'RE'.

*---APPEND END   PSD T.SAITOH 2002/02/23 SCR003---------------------*
************************************************************************
*                      TYPES / DATA         　　  　                   *
*　　　　　　　　　　  　構造定義　　　　　                            *
*　　　　　　　　　　　内部テーブル定義                          　　　*
************************************************************************
* 各列用
TYPES: BEGIN OF TYPES_LIST,
SIME_1 TYPE BSEG-DMBTR,"先々月締め
SIME_2 TYPE BSEG-DMBTR,"先月締め
SIME_3 TYPE BSEG-DMBTR,"指定年月締め
SIME_4 TYPE BSEG-DMBTR,"翌月締め
END OF TYPES_LIST.
* 他の支払条件
TYPES: BEGIN OF TYPES_ZTERM,
SONOTA1 TYPE KNVV-ZTERM,
SONOTA2 TYPE KNVV-ZTERM,
SONOTA3 TYPE KNVV-ZTERM,
SONOTA4 TYPE KNVV-ZTERM,
SONOTA5 TYPE KNVV-ZTERM,
END OF TYPES_ZTERM.

*09/04 START
DATA G_ETC       LIKE KNKK-KLIMK. "他入金計算用
DATA G_ETC_2     LIKE KNKK-KLIMK. "出力判定用
DATA G_ETC_3     LIKE KNKK-KLIMK. "出力判定用
DATA G_SOUSAI    LIKE KNKK-KLIMK. "相殺計算用
DATA G_YOTEI     LIKE KNKK-KLIMK. "相殺計算用
DATA G_SOUSAI_1  LIKE KNKK-KLIMK. "相殺計算用（仕入先別合計）
DATA G_YOTEI_1   LIKE KNKK-KLIMK. "相殺計算用（仕入先別合計）
DATA G_AUGDT     TYPE BSEG-AUGDT. "決済日付退避用

*09/04 END

* 締め月日
TYPES: BEGIN OF TYPES_SIMEMD,
MM(2) TYPE C,
DD(2) TYPE C,
END   OF TYPES_SIMEMD.
* 請求タイプ
TYPES: BEGIN OF TYPES_FKART,
FTYPE TYPE VBRK-FKART,
END   OF TYPES_FKART.
* 期間
TYPES: BEGIN OF KIKAN,
SIGN(1)   TYPE C,
OPTION(2) TYPE C,
LOW       TYPE D,
HIGH      TYPE D,
END   OF KIKAN.

DATA G_ZTERM     TYPE TYPES_ZTERM."支払条件
DATA G_FKART     TYPE TYPES_FKART."請求タイプ
DATA G_GENZAN    LIKE S067-OLIKW. "現在受注残
DATA G_TEGATAZAN LIKE KNC3-SALDV. "手形決済残
DATA G_YOSINZAN  LIKE KNKK-KLIMK. "与信残高額
DATA G_URITOTAL  LIKE KNKK-KLIMK. "売掛金合計
DATA G_YOSINMAX  LIKE KNKK-KLIMK. "与信限度額
* 締め月日（ヘッダ）
DATA G_SIMEMD1   TYPE TYPES_SIMEMD.
DATA G_SIMEMD2   TYPE TYPES_SIMEMD.
DATA G_SIMEMD3   TYPE TYPES_SIMEMD.
DATA G_SIMEMD4   TYPE TYPES_SIMEMD.
* 請求タイプ
DATA G_TAB_FKART LIKE STANDARD TABLE OF G_FKART.
* 期間用
DATA G_ZFBDT     TYPE KIKAN VALUE IS INITIAL.
DATA G_ZFBDT1    TYPE KIKAN VALUE IS INITIAL.
DATA G_ZFBDT2    TYPE KIKAN VALUE IS INITIAL.
DATA G_ZFBDT3    TYPE KIKAN VALUE IS INITIAL.
DATA G_ZFBDT4    TYPE KIKAN VALUE IS INITIAL.
DATA: S_ZFBDT      LIKE STANDARD TABLE OF G_ZFBDT,
S_ZFBDT2     LIKE STANDARD TABLE OF G_ZFBDT.

DATA:
*---DELETE START PSD T.SAITOH 2002/02/19 ---------------------------*
*     WA_KNA1      TYPE KNA1  VALUE IS INITIAL,
*---DELETE END   PSD T.SAITOH 2002/02/19 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     WA_KNVV      TYPE KNVV  VALUE IS INITIAL,
*     WA_TMP_KNVV  TYPE KNVV  VALUE IS INITIAL,
WA_KNVV      TYPE ZF011000_TYP_KNVV  VALUE IS INITIAL,
WA_TMP_KNVV  TYPE ZF011000_TYP_KNVV  VALUE IS INITIAL,
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/19 ---------------------------*
*     WA_KNKK      TYPE KNKK  VALUE IS INITIAL,
*     WA_KNC3      TYPE KNC3  VALUE IS INITIAL,
*---DELETE END   PSD T.SAITOH 2002/02/19 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     WA_T052U     TYPE T052U VALUE IS INITIAL,
WA_T052U     TYPE ZF011000_TYP_T052U VALUE IS INITIAL,
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/19 ---------------------------*
*     WA_T052      TYPE T052  VALUE IS INITIAL,
*     WA_S067      TYPE S067  VALUE IS INITIAL,
*---DELETE END   PSD T.SAITOH 2002/02/19 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     WA_BSEG      TYPE BSEG  VALUE IS INITIAL,
*     TMP_BSEG     TYPE BSEG  VALUE IS INITIAL,
WA_BSEG      TYPE ZF011000_TYP_BSEG  VALUE IS INITIAL,
TMP_BSEG     TYPE ZF011000_TYP_BSEG  VALUE IS INITIAL,
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     WA_BSID      TYPE BSID  VALUE IS INITIAL,
*     TMP_BSID     TYPE BSID  VALUE IS INITIAL,
*     WA_BSAD      TYPE BSAD  VALUE IS INITIAL,
*     TMP_BSAD     TYPE BSAD  VALUE IS INITIAL,
*     WA_VBRK      TYPE VBRK  VALUE IS INITIAL,
*     TMP_VBRK     TYPE VBRK  VALUE IS INITIAL,
WA_BSID      TYPE ZF011000_TYP_BSID  VALUE IS INITIAL,
TMP_BSID     TYPE ZF011000_TYP_BSID  VALUE IS INITIAL,
WA_BSAD      TYPE ZF011000_TYP_BSAD  VALUE IS INITIAL,
TMP_BSAD     TYPE ZF011000_TYP_BSAD  VALUE IS INITIAL,
WA_VBRK      TYPE ZF011000_TYP_VBRK  VALUE IS INITIAL,
TMP_VBRK     TYPE ZF011000_TYP_VBRK  VALUE IS INITIAL,
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---REMAKE START PSD T.SAITOH 2002/02/18 ---------------------------*
WA_VBRP      TYPE ZF011000_TYP_VBRP  VALUE IS INITIAL,
WA_VBRP1     TYPE ZF011000_TYP_VBRP  VALUE IS INITIAL,
WA_VBRP2     TYPE ZF011000_TYP_VBRP  VALUE IS INITIAL,
WA_VBRP3     TYPE ZF011000_TYP_VBRP  VALUE IS INITIAL,
WA_VBRP4     TYPE ZF011000_TYP_VBRP  VALUE IS INITIAL,
*---REMAKE END   PSD T.SAITOH 2002/02/18 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/19 ---------------------------*
*    ↓G_TAB_KNKK 使用されていない、リフレッシュのみであやしい
*---APPEND END   PSD T.SAITOH 2002/02/19 ---------------------------*
G_TAB_KNKK   LIKE STANDARD TABLE OF KNKK,"★★★★★★★★★★★
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     G_TAB_KNVV   LIKE STANDARD TABLE OF KNVV,
G_TAB_KNVV   LIKE STANDARD TABLE OF ZF011000_TYP_KNVV,
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/19 ---------------------------*
*    ↓G_TAB_KNA1 使用されていない、リフレッシュのみであやしい
*---APPEND END   PSD T.SAITOH 2002/02/19 ---------------------------*
G_TAB_KNA1   LIKE STANDARD TABLE OF KNA1,"★★★★★★★★★★★
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*    G_TAB_BSEG   LIKE STANDARD TABLE OF BSEG,
*    G_TAB_BSEG2  LIKE STANDARD TABLE OF BSEG,
G_TAB_BSEG   LIKE STANDARD TABLE OF ZF011000_TYP_BSEG,
*---APPEND START PSD T.SAITOH 2002/02/19 ---------------------------*
*    ↓G_TAB_BSEG2 使用されていない、リフレッシュのみであやしい
*---APPEND END   PSD T.SAITOH 2002/02/19 ---------------------------*
G_TAB_BSEG2  LIKE STANDARD TABLE OF ZF011000_TYP_BSEG,"★★★★★
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     G_TAB_BSID   LIKE STANDARD TABLE OF BSID,
*     G_TAB_BSID2  LIKE STANDARD TABLE OF BSID,
G_TAB_BSID   LIKE STANDARD TABLE OF ZF011000_TYP_BSID,
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
G_TAB_BSID_P LIKE STANDARD TABLE OF ZF011000_TYP_BSID,
G_TAB_BSAD_P LIKE STANDARD TABLE OF ZF011000_TYP_BSAD,
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/19 ---------------------------*
*    ↓G_TAB_BSID2 使用されていない、リフレッシュのみであやしい
*---APPEND END   PSD T.SAITOH 2002/02/19 ---------------------------*
G_TAB_BSID2  LIKE STANDARD TABLE OF ZF011000_TYP_BSID,"★★★★
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19---------------------------*
*     G_TAB_BSAD   LIKE STANDARD TABLE OF BSAD,
*     G_TAB_VBRK   LIKE STANDARD TABLE OF VBRK,
*     G_TAB_VBRK   LIKE STANDARD TABLE OF VBRK,
G_TAB_BSAD   LIKE STANDARD TABLE OF ZF011000_TYP_BSAD,
G_TAB_VBRK   LIKE STANDARD TABLE OF ZF011000_TYP_VBRK,
*---MODIFY END   PSD T.SAITOH 2002/02/19---------------------------*
*10/03
G_TAB_BSAD_SOSAI   LIKE STANDARD TABLE OF ZF011000_TYP_BSAD,
*     G_TAB_BSEG_SOSAI   LIKE STANDARD TABLE OF ZF011000_TYP_BSEG,
*10/03
*---REMAKE START PSD T.SAITOH 2002/02/18 ---------------------------*
G_TAB_VBRP   TYPE STANDARD TABLE OF ZF011000_TYP_VBRP,
G_TAB_VBRP2  LIKE STANDARD TABLE OF ZF011000_TYP_VBRP.
*---REMAKE END   PSD T.SAITOH 2002/02/18 ---------------------------*


* 請求タイプ
G_FKART-FTYPE = 'RE'.
APPEND G_FKART TO G_TAB_FKART.
G_FKART-FTYPE = 'G2'.
APPEND G_FKART TO G_TAB_FKART.
G_FKART-FTYPE = 'L2'.
APPEND G_FKART TO G_TAB_FKART.
G_FKART-FTYPE = 'S1'.
APPEND G_FKART TO G_TAB_FKART.
G_FKART-FTYPE = 'S2'.
APPEND G_FKART TO G_TAB_FKART.
* 明細用
DATA:
G_LIST_01  TYPE TYPES_LIST VALUE IS INITIAL,"売上
G_LIST_02  TYPE TYPES_LIST VALUE IS INITIAL,"返品
G_LIST_03  TYPE TYPES_LIST VALUE IS INITIAL,"値引き
G_LIST_04  TYPE TYPES_LIST VALUE IS INITIAL,"値増し
G_LIST_05  TYPE TYPES_LIST VALUE IS INITIAL,"請求取消
G_LIST_06  TYPE TYPES_LIST VALUE IS INITIAL,"クレジットメモ取消
G_LIST_07  TYPE TYPES_LIST VALUE IS INITIAL,"売上計
G_LIST_08  TYPE TYPES_LIST VALUE IS INITIAL,"消費税
G_LIST_09  TYPE TYPES_LIST VALUE IS INITIAL,"税込計
G_LIST_10  TYPE TYPES_LIST VALUE IS INITIAL,"粗利
G_LIST_11  TYPE TYPES_LIST VALUE IS INITIAL,"現金入金
G_LIST_12  TYPE TYPES_LIST VALUE IS INITIAL,"手形入金
G_LIST_13  TYPE TYPES_LIST VALUE IS INITIAL,"相殺入金
G_LIST_14  TYPE TYPES_LIST VALUE IS INITIAL,"他入金
G_LIST_15  TYPE TYPES_LIST VALUE IS INITIAL,"入金計
G_LIST_16  TYPE TYPES_LIST VALUE IS INITIAL,"受手決済
G_LIST_17  TYPE TYPES_LIST VALUE IS INITIAL,"売掛金残高
G_LIST_18  TYPE TYPES_LIST VALUE IS INITIAL."売掛金入金予定
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
DATA: G_LIST_19  TYPE TYPES_LIST,"親会社に振替
G_PARENTAGE LIKE KNA1-KUNNR."得意先コード（親）
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*
*10/03
DATA: G_LIST_20  TYPE TYPES_LIST VALUE IS INITIAL."他調整
*10/03 end
*---APPEND START PSD T.SAITOH 2002/04/19 累計に仕様変更------------*
* 前々月締め日範囲より１日前の日付（過去を指定するため）
DATA: G_ZFBDT0 TYPE KIKAN VALUE IS INITIAL.
* 過去の範囲を含む基準日設定
DATA: S_ZFBDT_past LIKE STANDARD TABLE OF G_ZFBDT.
* 全売掛金残高：前々月より前の金額合計
DATA: G_LIST_17_SIME_0  TYPE BSEG-DMBTR.
* 全売掛金入金予定：前々月より前の金額合計
DATA: G_LIST_18_SIME_0  TYPE BSEG-DMBTR.
*---APPEND END   PSD T.SAITOH 2002/04/19 累計に仕様変更------------*

************************************************************************
*                         画面定義　                                   *
*                                                                      *
************************************************************************
* 会社コード
PARAMETERS:  P_BUKRS LIKE T001-BUKRS
MEMORY ID BUK OBLIGATORY.
* 指定年月
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN: COMMENT (33) TEXT-001.
PARAMETERS P_YEAR(4)  TYPE N DEFAULT SY-DATUM(4)  OBLIGATORY .
SELECTION-SCREEN:COMMENT 40(2) TEXT-002,
POSITION 43.
*---MODIFY START PSD T.SAITOH 2002/02/20 ---------------------------*
*PARAMETERS P_MONTH(2) TYPE N  DEFAULT SY-DATUM+4(2) OBLIGATORY.
PARAMETERS P_MONTH TYPE MONTH  DEFAULT SY-DATUM+4(2) OBLIGATORY.
*---MODIFY END   PSD T.SAITOH 2002/02/20 ---------------------------*
SELECTION-SCREEN: COMMENT 46(2) TEXT-003,
POSITION 50.
SELECTION-SCREEN END OF LINE.
* 得意先コード
PARAMETERS:  P_KUNNR LIKE KNA1-KUNNR OBLIGATORY.
* 販売組織
PARAMETERS:  P_VKORG LIKE KNVV-VKORG OBLIGATORY.
* 流通チャンネル
PARAMETERS:  P_VTWEG LIKE KNVV-VTWEG OBLIGATORY.
* 製品部門
PARAMETERS:  P_SPART LIKE KNVV-SPART OBLIGATORY.
*---DELETE START PSD T.SAITOH 2002/02/20 ---------------------------*
* 伝票タイプ
*SELECT-OPTIONS S_BLART  FOR BSAD-BLART OBLIGATORY.
*---DELETE END   PSD T.SAITOH 2002/02/20 ---------------------------*

SELECTION-SCREEN SKIP.
* 債権債務勘定
SELECTION-SCREEN: BEGIN OF BLOCK BLOCK1
WITH FRAME TITLE TEXT-004.
* 売掛金
SELECT-OPTIONS S_URI      FOR SKB1-SAKNR OBLIGATORY.
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
SELECT-OPTIONS S_BLRTAR  FOR BSAD-BLART OBLIGATORY.
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*

* 売掛金入金予定
SELECT-OPTIONS S_UYOTEI   FOR SKB1-SAKNR OBLIGATORY.
*---APPEND START PSD T.SAITOH 2002/02/20 ---------------------------*
SELECT-OPTIONS S_BLART  FOR BSAD-BLART OBLIGATORY.
*---APPEND END   PSD T.SAITOH 2002/02/20 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/03/28 転記キー-------------------*
SELECT-OPTIONS S_BSCHL  FOR BSAD-BSCHL  OBLIGATORY. "転記キー
*---APPEND END   PSD T.SAITOH 2002/03/28 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/23 SCR003---------------------*
* 売上
*SELECT-OPTIONS S_URIAGE   FOR SKB1-SAKNR OBLIGATORY.
*---DELETE END   PSD T.SAITOH 2002/02/23 SCR003---------------------*
SELECTION-SCREEN END OF BLOCK BLOCK1.



SELECTION-SCREEN SKIP.
* 入金金種
SELECTION-SCREEN: BEGIN OF BLOCK BLOCK2
WITH FRAME TITLE TEXT-005.
* 現金勘定
SELECT-OPTIONS S_GENKIN   FOR SKB1-SAKNR OBLIGATORY.
* 受取手形
SELECT-OPTIONS S_TEGATA   FOR SKB1-SAKNR OBLIGATORY.
* 相殺
SELECT-OPTIONS S_SOUSAI   FOR SKB1-SAKNR OBLIGATORY.
* 他入金
SELECT-OPTIONS S_TANYU    FOR SKB1-SAKNR OBLIGATORY.
* 受手決済
SELECT-OPTIONS S_UKETE    FOR SKB1-SAKNR OBLIGATORY.
*---APPEND START PSD T.SAITOH 2002/02/22 ---------------------------*
* 受手決済伝票タイプ
SELECT-OPTIONS S_BLRTAC  FOR BSAD-BLART OBLIGATORY.
*---APPEND END   PSD T.SAITOH 2002/02/22 ---------------------------*
SELECTION-SCREEN END OF BLOCK BLOCK2.

************************************************************************
*                        INITIALIZATION                                *
************************************************************************
INITIALIZATION.
*初期化処理
REFRESH : G_TAB_KNA1 , G_TAB_KNKK , G_TAB_KNVV , G_TAB_BSEG,
G_TAB_BSEG2, G_TAB_BSID , G_TAB_BSID2, G_TAB_BSAD,
G_TAB_VBRK , G_TAB_VBRP , G_TAB_VBRP2.
CLEAR   : G_E_FLG.
************************************************************************
*                        AT SELECTION-SCREEN                           *
************************************************************************
AT SELECTION-SCREEN.
*---APPEND START PSD T.SAITOH 2002/02/20 ---------------------------*
* 月の入力チェック
PERFORM F_CHECK_MONTH.
*---APPEND END   PSD T.SAITOH 2002/02/20 ---------------------------*
* 会社コード存在チェック
PERFORM F_CHECK_BUK.
* 得意先コード存在チェック
PERFORM F_CHECK_KUNNR.
* 勘定コード存在チェック
PERFORM F_CHECK_HKONT.
************************************************************************
*                        START-OF-SELECTION                            *
************************************************************************
START-OF-SELECTION.
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
PERFORM F_GET_KNVP.
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*
*-----対象データ抽出処理
* 支払条件取得処理
PERFORM F_GET_ZTERM.
* 支払条件テキスト取得処理
PERFORM F_GET_TEXT1.
* 固定日取得処理
PERFORM F_GET_ZFAEL.
* 現在受注残取得処理
PERFORM F_GET_OLIKW.
* 手形決済残取得処理
PERFORM F_GET_TEGATAZAN.
* 与信関連金額取得処理
PERFORM F_GET_YOSIN.
* 売上関連集計処理
PERFORM F_SUMURIKANREN.
*---UNDELETE START PSD T.SAITOH 2002/03/28 親勘定に振替処理廃止→中止-*
* 2002/03/29
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
IF P_KUNNR <> G_PARENTAGE.
PERFORM F_PARENT_BSID.
PERFORM F_PARENT_BSAD.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*
*---UNDELETE END   PSD T.SAITOH 2002/03/28 ---------------------------*

* 入金関連集計処理
*---DELETE START PSD T.SAITOH 2002/03/28 ---------------------------*
**---APPEND START PSD T.SAITOH 2002/02/22 SCR002---------------------*
*  PERFORM F_SUM_MONEY_REC_BSID.
**---APPEND END   PSD T.SAITOH 2002/02/22 SCR002---------------------*
*---DELETE END   PSD T.SAITOH 2002/03/28 ---------------------------*
PERFORM F_SUMNYUKIN.
PERFORM F_SUM_MONEY_RECEIVED.
* 受手決済集計処理
PERFORM F_SUM_UKETE.
* 売掛金入金予定集計処理
PERFORM F_SUM_URIYOTEI.
*-----帳票出力処理
PERFORM F_LIST_OUT.
*---APPEND START PSD T.SAITOH 2002/04/19 終了メッセージ不具合対応---*
* 正常終了メッセージ
MESSAGE S856.
*---APPEND END   PSD T.SAITOH 2002/04/19 ---------------------------*
************************************************************************
*
*                        END-OF-SELECTION                              *
************************************************************************
END-OF-SELECTION.
*---DELETE START PSD T.SAITOH 2002/04/19 終了メッセージ不具合対応---*
** 終了メッセージ
*  MESSAGE S856.
*---DELETE END   PSD T.SAITOH 2002/04/19 ---------------------------*

************************************************************************
*                        TOP-OF-PAGE                                   *
************************************************************************
TOP-OF-PAGE .
WRITE : /081  '出力日時:' ,
090  SY-DATUM    ,
101  SY-UZEIT    ,
110  'PAGE:'     ,
115  SY-PAGNO    .
WRITE : /050 '入金実績表'.
WRITE : /002 '会社コード：', 018 P_BUKRS, 024 T001-BUTXT.
WRITE : /002 '指定年月：',   018 P_YEAR, 023 '年',026 P_MONTH,
029 '月締め'.
WRITE : /002 '得意先コード：',   018 P_KUNNR, 030 KNA1-NAME1.
WRITE : /002 '支払条件：',   018 WA_KNVV-ZTERM,
*---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
*           024  T052U-TEXT1,
024  WA_T052U-TEXT1,
*---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
078 '他の支払条件：', 093 G_ZTERM-SONOTA1,
098 G_ZTERM-SONOTA2,  104 G_ZTERM-SONOTA3,
110 G_ZTERM-SONOTA4,  116 G_ZTERM-SONOTA5.
*---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
*  WRITE : /002 '販売組織：', 018 P_VKORG, 024 '流通チャンネル',
WRITE : /002 '販売組織：', 018 P_VKORG, 024 '流通チャネル',
*---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
042 P_VTWEG, 046 '製品部門', 058 P_SPART.
*---MODIFY START PSD T.SAITOH 2002/02/14 ---------------------------*
*  WRITE : /002 '現在受注残：', 018 G_GENZAN    CURRENCY T001-WAERS,
*           034 '手形決済残：', 046 G_TEGATAZAN CURRENCY T001-WAERS,
*           061 '与信残高額：', 073 G_YOSINZAN  CURRENCY T001-WAERS.
WRITE : /002 '現在受注残：', 015(19) G_GENZAN    CURRENCY T001-WAERS,
034 '手形決済残：', 046(19) G_TEGATAZAN CURRENCY T001-WAERS,
065 '与信残高額：', 077 G_YOSINZAN  CURRENCY T001-WAERS.
*---MODIFY END   PSD T.SAITOH 2002/02/14 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/14 ---------------------------*
*  WRITE : /002 '売掛金合計：', 018 G_URITOTAL  CURRENCY T001-WAERS,
*           061 '与信限度額：', 073 G_YOSINMAX  CURRENCY T001-WAERS.
WRITE : /002 '売掛金合計：', 014 G_URITOTAL  CURRENCY T001-WAERS,
065 '与信限度額：', 077 G_YOSINMAX  CURRENCY T001-WAERS.
*---MODIFY END   PSD T.SAITOH 2002/02/14 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
*  SKIP.
FORMAT COLOR COL_HEADING ON.
PERFORM FRM_SY_ULINE.
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
WRITE :  002 '取 引',
*  WRITE : /002 '取 引',
*---MODIFY END   PSD T.SAITOH 2002/04/11 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
*           028 G_SIMEMD1-MM, 031 '月', 034 G_SIMEMD1-DD, 037 '日締',
*           046 G_SIMEMD2-MM, 049 '月', 052 G_SIMEMD2-DD, 055 '日締',
*           064 G_SIMEMD3-MM, 067 '月', 070 G_SIMEMD3-DD, 073 '日締',
*           084 G_SIMEMD4-MM, 087 '月', 090 G_SIMEMD4-DD, 093 '日締'.
031 G_SIMEMD1-MM, 034 '月', 037 G_SIMEMD1-DD, 040 '日締',
051 G_SIMEMD2-MM, 054 '月', 057 G_SIMEMD2-DD, 060 '日締',
071 G_SIMEMD3-MM, 074 '月', 077 G_SIMEMD3-DD, 080 '日締',
091 G_SIMEMD4-MM, 094 '月', 097 G_SIMEMD4-DD, 100 '日締'.
*---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
FORMAT COLOR OFF.
PERFORM FRM_SY_ULINE.
**---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
*  WRITE : /002 SY-ULINE(23), 031 SY-ULINE(15), 051 SY-ULINE(15),
*           071 SY-ULINE(15), 091 SY-ULINE(15).
**---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/04/11 ---------------------------*
************************************************************************
*                        サブルーチン                                  *
************************************************************************
*&---------------------------------------------------------------------*
*&      Form  f_check_buk
*&---------------------------------------------------------------------*
*       会社コード存在チェック
*----------------------------------------------------------------------*
FORM F_CHECK_BUK.
*-- 会社コード名称、通貨コードの取得
SELECT SINGLE BUTXT WAERS SPRAS
FROM T001
INTO (T001-BUTXT,T001-WAERS,T001-SPRAS)
WHERE BUKRS = P_BUKRS.
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
IF SY-SUBRC <> 0.
MESSAGE S600 WITH C_BUKRS.
SET CURSOR FIELD P_BUKRS.
STOP.
ENDIF.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_001 SY-SUBRC.
ENDCASE.
ENDFORM.                    " f_check_buk
*&---------------------------------------------------------------------*
*&      Form  f_check_kunnr
*&---------------------------------------------------------------------*
*       得意先コード存在チェック
*----------------------------------------------------------------------*
FORM F_CHECK_KUNNR.
* 得意先名称取得
SELECT SINGLE NAME1   FROM KNA1
INTO KNA1-NAME1
WHERE KUNNR = P_KUNNR.
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
IF SY-SUBRC <> 0.
MESSAGE S600 WITH C_KNA1.
SET CURSOR FIELD P_KUNNR.
STOP.
ENDIF.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_002 SY-SUBRC.
ENDCASE.
ENDFORM.                    " f_check_kunnr
*&---------------------------------------------------------------------*
*&      Form  f_check_hkont
*&---------------------------------------------------------------------*
*       勘定コード存在チェック
*----------------------------------------------------------------------*
FORM F_CHECK_HKONT.

*--- 売掛金チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_URI.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
STOP.
ENDCASE.
* --- 売掛金入金予定チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_UYOTEI.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
ENDCASE.

*---DELETE START PSD T.SAITOH 2002/02/23 ---------------------------*
** --- 売上チェック
*  SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
*         WHERE BUKRS = P_BUKRS AND
*               SAKNR IN S_URIAGE.
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*      MESSAGE S600(Z1) WITH C_SKB1.
*      STOP.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
*  ENDCASE.
*---DELETE END   PSD T.SAITOH 2002/02/23 ---------------------------*

* --- 現金勘定チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_GENKIN.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
ENDCASE.
* --- 受取手形チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_TEGATA.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
ENDCASE.
* --- 相殺チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_SOUSAI.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
ENDCASE.
* --- 他入金チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_TANYU.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
ENDCASE.
* --- 受手決済チェック
SELECT SINGLE BUKRS FROM SKB1 INTO SKB1-BUKRS
WHERE BUKRS = P_BUKRS AND
SAKNR IN S_UKETE.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH C_SKB1.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID C_TBL_003 SY-SUBRC.
ENDCASE.

ENDFORM.                    " f_check_hkont
*&---------------------------------------------------------------------*
*&      Form  f_get_zterm
*&---------------------------------------------------------------------*
*       支払条件取得処理
*----------------------------------------------------------------------*
FORM F_GET_ZTERM.
SELECT KUNNR VKORG VTWEG SPART ZTERM FROM KNVV
INTO CORRESPONDING FIELDS OF TABLE  G_TAB_KNVV
WHERE KUNNR = P_KUNNR."得意先コード
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knvv.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_004 SY-SUBRC.
ENDCASE.
* 対象支払条件取得
READ TABLE G_TAB_KNVV WITH KEY KUNNR  = P_KUNNR
VKORG  = P_VKORG
VTWEG  = P_VTWEG
SPART  = P_SPART
INTO WA_KNVV.
IF SY-SUBRC = 0.
DELETE  G_TAB_KNVV WHERE KUNNR  = P_KUNNR
AND VKORG  = P_VKORG
AND VTWEG  = P_VTWEG
AND SPART  = P_SPART.
ELSE.
MESSAGE S600 WITH C_KNVV.
STOP.
ENDIF.

* 他の支払条件セット
LOOP AT G_TAB_KNVV INTO WA_TMP_KNVV.
CASE SY-TABIX.
WHEN 1.
G_ZTERM-SONOTA1 = WA_TMP_KNVV-ZTERM.
WHEN 2.
G_ZTERM-SONOTA2 = WA_TMP_KNVV-ZTERM.
WHEN 3.
G_ZTERM-SONOTA3 = WA_TMP_KNVV-ZTERM.
WHEN 4.
G_ZTERM-SONOTA4 = WA_TMP_KNVV-ZTERM.
WHEN 5.
G_ZTERM-SONOTA5 = WA_TMP_KNVV-ZTERM.
WHEN OTHERS.
EXIT.
ENDCASE.
ENDLOOP.
ENDFORM.                    " f_get_zterm
*&---------------------------------------------------------------------*
*&      Form  f_get_text1
*&---------------------------------------------------------------------*
*       支払条件テキスト取得処理
*----------------------------------------------------------------------*
FORM F_GET_TEXT1.
*---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
*  SELECT SINGLE ZTERM FROM T052U
SELECT SINGLE ZTERM TEXT1 FROM T052U
*---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
INTO CORRESPONDING FIELDS OF  WA_T052U
WHERE SPRAS = 'J'           "言語
AND ZTERM = WA_KNVV-ZTERM "支払条件
AND ZTAGG = '31'.         "期限
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_t052u.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_005 SY-SUBRC.
ENDCASE.

ENDFORM.                    " f_get_text1
*&---------------------------------------------------------------------*
*&      Form  f_get_zfael
*&---------------------------------------------------------------------*
*       固定日取得処理
*----------------------------------------------------------------------*
FORM F_GET_ZFAEL.
DATA : L_ZFAEL LIKE T052-ZFAEL, "固定日
L_YEAR(4)  TYPE N,
L_MONTH(2) TYPE N.

* 固定日の取得処理
SELECT SINGLE ZFAEL FROM T052
INTO  T052-ZFAEL
WHERE ZTERM = WA_KNVV-ZTERM "支払条件
AND ZTAGG = '31'.         "期限
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_t052.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_006 SY-SUBRC.
ENDCASE.
* 締年月セット
*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
*  g_simemd1-mm = p_year - 2.
*  g_simemd1-dd = t052-zfael.
*  g_simemd2-mm = p_year - 1.
*  g_simemd2-dd = t052-zfael.
*  g_simemd3-mm = p_year.
*  g_simemd3-dd = t052-zfael.
*  g_simemd4-mm = p_year + 1.
*  g_simemd4-dd = t052-zfael.
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
PERFORM FRM_DATA_FOR_PERIOD_CLOSING.
*---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
** 対象期間のセット
** 末日対応
** 29〜99はすべて末日締め処理とする
*  IF t052-zfael >= 29.
*    t052-zfael = 31.
*  ELSEIF t052-zfael = 00.
*    t052-zfael = 31.
*  ENDIF.
*
*  IF t052-zfael = 31."末日締め
** 当月期間
*    l_month = p_month + 1.
*    CONCATENATE p_year l_month '01' INTO  g_zfbdt3-high.
*    g_zfbdt3-high = g_zfbdt3-high - 1.
*    CONCATENATE p_year p_month '01' INTO  g_zfbdt3-low.
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/19 ---------------------------*
*---APPEND END   PSD T.SAITOH 2002/04/19 ---------------------------*
* 売掛金残高／入金予定　累計対応
* 過去を対象とする場合の対応
G_ZFBDT0-HIGH   =  G_ZFBDT1-LOW. "前々月対象範囲より１日前の日付
G_ZFBDT0-SIGN   = 'I'.
G_ZFBDT0-OPTION = 'BT'.
APPEND G_ZFBDT0 TO  S_ZFBDT_PAST."前々月より前
*---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
G_ZFBDT1-LOW    =  G_ZFBDT1-LOW  + 1."前々月対象範囲（LOW）
G_ZFBDT2-LOW    =  G_ZFBDT1-HIGH + 1."前月対象範囲（LOW）
G_ZFBDT3-LOW    =  G_ZFBDT2-HIGH + 1."当月対象範囲（LOW）
G_ZFBDT4-LOW    =  G_ZFBDT3-HIGH + 1."次月対象範囲（LOW）

G_SIMEMD1-MM = G_ZFBDT1-HIGH+4(2).   "前々月
G_SIMEMD1-DD = G_ZFBDT1-HIGH+6(2).   "前々月の日
G_SIMEMD2-MM = G_ZFBDT2-HIGH+4(2).   "前月
G_SIMEMD2-DD = G_ZFBDT2-HIGH+6(2).   "前月の日
G_SIMEMD3-MM = G_ZFBDT3-HIGH+4(2).   "当月
G_SIMEMD3-DD = G_ZFBDT3-HIGH+6(2).   "当月の日
G_SIMEMD4-MM = G_ZFBDT4-HIGH+4(2).   "次月
G_SIMEMD4-DD = G_ZFBDT4-HIGH+6(2).   "次月の日

*---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*
G_ZFBDT3-SIGN   = 'I'.
G_ZFBDT3-OPTION = 'BT'.
APPEND G_ZFBDT3 TO  S_ZFBDT.

*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
** 先月期間
*    g_zfbdt2-high = g_zfbdt3-high - g_zfbdt3-high+6(2).
*    g_zfbdt2-low  = g_zfbdt2-high.
*    MOVE  '01' TO g_zfbdt2-low+6(2).
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
G_ZFBDT2-SIGN   = 'I'.
G_ZFBDT2-OPTION = 'BT'.
APPEND G_ZFBDT2 TO  S_ZFBDT.

*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
** 先々月期間
*    g_zfbdt1-high = g_zfbdt2-high - g_zfbdt2-high+6(2).
*    g_zfbdt1-low  = g_zfbdt1-high.
*    MOVE  '01' TO g_zfbdt1-low+6(2).
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
G_ZFBDT1-SIGN   = 'I'.
G_ZFBDT1-OPTION = 'BT'.
APPEND G_ZFBDT1 TO  S_ZFBDT.

*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
*  ELSE.                                                 "01〜28締め
** 当月期間算出
*    CONCATENATE p_year l_month t052-zfael INTO  g_zfbdt3-high.
*    g_zfbdt3-low = g_zfbdt3-high - t052-zfael.
*    l_zfael = t052-zfael - 1.
*    g_zfbdt2-high = g_zfbdt3-high - g_zfbdt3-high+6(2).
*    MOVE  l_zfael TO g_zfbdt3-low+6(2).
*    g_zfbdt3-sign   = 'I'.
*    g_zfbdt3-option = 'BT'.
*    APPEND g_zfbdt3 TO  s_zfbdt.
** 先月期間算出
*    g_zfbdt2-high = g_zfbdt3-high - g_zfbdt3-high+6(2).
*    MOVE  t052-zfael TO g_zfbdt2-high+6(2).
*    g_zfbdt2-low = g_zfbdt3-high - t052-zfael.
*    MOVE  l_zfael TO g_zfbdt2-low+6(2).
*    g_zfbdt2-sign   = 'I'.
*    g_zfbdt2-option = 'BT'.
*    APPEND g_zfbdt2 TO  s_zfbdt.
** 先々月期間算出
*    g_zfbdt1-high = g_zfbdt2-high - g_zfbdt2-high+6(2).
*    MOVE  t052-zfael TO g_zfbdt1-high+6(2).
*    g_zfbdt1-low = g_zfbdt2-high - t052-zfael.
*    MOVE  l_zfael TO g_zfbdt1-low+6(2).
*    g_zfbdt1-sign   = 'I'.
*    g_zfbdt1-option = 'BT'.
*    APPEND g_zfbdt1 TO  s_zfbdt.
*  ENDIF.
** 翌月期間算出処理
*  PERFORM f_next_natum.
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
G_ZFBDT4-SIGN   = 'I'.
G_ZFBDT4-OPTION = 'BT'.
APPEND G_ZFBDT4 TO  S_ZFBDT.

* 締め日期間を昇順ソート
SORT S_ZFBDT ASCENDING BY LOW.
* 締め日期間を設定
READ TABLE S_ZFBDT INTO G_ZFBDT1 INDEX 1.
READ TABLE S_ZFBDT INTO G_ZFBDT2 INDEX 2.
READ TABLE S_ZFBDT INTO G_ZFBDT3 INDEX 3.
READ TABLE S_ZFBDT INTO G_ZFBDT4 INDEX 4.
*---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/19 ---------------------------*
* 売掛金残高／入金予定　累計対応
* 過去を対象とする場合の対応
APPEND G_ZFBDT1 TO  S_ZFBDT_PAST."前々月
APPEND G_ZFBDT2 TO  S_ZFBDT_PAST."前月
APPEND G_ZFBDT3 TO  S_ZFBDT_PAST."当月
APPEND G_ZFBDT4 TO  S_ZFBDT_PAST."翌月
* 締め日期間を昇順ソート
SORT S_ZFBDT_PAST ASCENDING BY LOW.
* 締め日期間を設定
READ TABLE S_ZFBDT_PAST INTO G_ZFBDT0 INDEX 1.
*---APPEND END   PSD T.SAITOH 2002/04/19 ---------------------------*

ENDFORM.                    " f_get_zfael
*&---------------------------------------------------------------------*
*&      Form  f_get_olikw
*&---------------------------------------------------------------------*
*       現在受注残取得処理
*----------------------------------------------------------------------*
FORM F_GET_OLIKW.
*---DELETE START PSD T.SAITOH 2002/03/26 ---------------------------*
** ユーザパラメータより与信管理領域を取得
**---MODIFY START PSD T.SAITOH 2002/03/26 ---------------------------*
**  GET PARAMETER ID 'CAC' FIELD S067-KKBER.
*  GET PARAMETER ID 'KKB' FIELD S067-KKBER.
**---MODIFY END   PSD T.SAITOH 2002/03/26 ---------------------------*
*
*  SELECT SINGLE OLIKW FROM S067
*                  INTO  S067-OLIKW
*                  WHERE KKBER = S067-KKBER "与信管理領域
**---APPEND START PSD T.SAITOH 2002/03/26 ---------------------------*
*                    and VRSIO = '000'
**---APPEND END   PSD T.SAITOH 2002/03/26 ---------------------------*
*                    AND KNKLI = P_KUNNR.   "与信得意先コード
*  CASE SY-SUBRC.
*    WHEN 0.
**---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
**     現在受注残の設定処理
*      G_GENZAN = S067-OLIKW.
**---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*
*    WHEN 4."対象データなし
**      MESSAGE s600 WITH c_s067.
**      STOP.
*    WHEN OTHERS.
*      MESSAGE A603 WITH SY-REPID C_TBL_007 SY-SUBRC.
*  ENDCASE.
*---DELETE END   PSD T.SAITOH 2002/03/26 ---------------------------*


*---APPEND START PSD T.SAITOH 2002/03/26 ---------------------------*
clear g_genzan.
GET PARAMETER ID 'KKB' FIELD S067-KKBER.

SELECT OLIKW FROM S067
INTO  S067-OLIKW
WHERE KKBER = S067-KKBER "与信管理領域
and VRSIO = '000'
AND KNKLI = P_KUNNR.   "与信得意先コード

G_GENZAN = G_GENZAN + S067-OLIKW.

endselect.

CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_s067.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_007 SY-SUBRC.
ENDCASE.


GET PARAMETER ID 'KKB' FIELD S066-KKBER.
SELECT OEIKW FROM S066
INTO  S066-OEIKW
WHERE KKBER = S066-KKBER "与信管理領域
and VRSIO = '000'
AND KNKLI = P_KUNNR.   "与信得意先コード
*     現在受注残の設定処理
G_GENZAN = G_GENZAN + S066-OEIKW.

endselect.

CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_s067.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_S067 SY-SUBRC.
ENDCASE.

*---APPEND END   PSD T.SAITOH 2002/03/26 ---------------------------*

ENDFORM.                    " f_get_olikw
*&---------------------------------------------------------------------*
*&      Form  f_get_tegatazan
*&---------------------------------------------------------------------*
*       手形決済残取得処理
*----------------------------------------------------------------------*
FORM F_GET_TEGATAZAN.
SELECT SINGLE SALDV SOLLL HABNL FROM KNC3
INTO  (KNC3-SALDV,KNC3-SOLLL,KNC3-HABNL)
WHERE KUNNR = P_KUNNR   "得意先コード
AND BUKRS = P_BUKRS   "会社コード
AND SHBKZ = 'W'.      "特殊仕訳コード
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knc3.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_008 SY-SUBRC.
ENDCASE.
* 手形決済残取得
*---MODIFY START PSD T.SAITOH 2002/02/23 TPR001---------------------*
* G_TEGATAZAN = KNC3-SALDV + KNC3-SOLLL - KNC3-SOLLL.
* 手形決済残  = 繰越残高 + 年度借方転記合計額 - 今年度貸方転記合計
G_TEGATAZAN = KNC3-SALDV + KNC3-SOLLL - KNC3-HABNL.
*---MODIFY END   PSD T.SAITOH 2002/02/23 TPR001---------------------*


ENDFORM.                    " f_get_tegatazan
*&---------------------------------------------------------------------*
*&      Form  f_get_yosin
*&---------------------------------------------------------------------*
*       与信関連金額取得処理
*----------------------------------------------------------------------*
FORM F_GET_YOSIN.
SELECT SINGLE KLIMK SKFOR SSOBL FROM KNKK
INTO  (KNKK-KLIMK,KNKK-SKFOR,KNKK-SSOBL)
WHERE KUNNR = P_KUNNR     "得意先コード
AND KKBER = S067-KKBER. "与信管理領域
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_009 SY-SUBRC.
ENDCASE.
G_URITOTAL = KNKK-SKFOR.
G_YOSINMAX = KNKK-KLIMK.
*8/31 START
* G_YOSINZAN = KNKK-KLIMK - KNKK-SKFOR - KNKK-SSOBL.
G_YOSINZAN = KNKK-KLIMK - KNKK-SKFOR - KNKK-SSOBL - G_GENZAN.
*8/31 END

ENDFORM.                    " f_get_yosin
*&---------------------------------------------------------------------*
*&      Form  f_sumurikanren
*&---------------------------------------------------------------------*
*       売上関連集計処理
*----------------------------------------------------------------------*
FORM F_SUMURIKANREN.
* 売掛金残高集計処理
PERFORM F_SUM_URIZAN.

* 請求伝票関連集計処理
PERFORM F_SUM_SEIKYU.

* その他集計処理
PERFORM F_SUM_ETC.

ENDFORM.                    " f_sumurikanren
*&---------------------------------------------------------------------*
*&      Form  f_sumnyukin
*&---------------------------------------------------------------------*
*       入金関連集計処理
*----------------------------------------------------------------------*
FORM F_SUMNYUKIN.
*---APPEND START PSD T.SAITOH 2002/03/28 ---------------------------*
*** COMMENT ADD *** SELECT NUMBER 14
*---APPEND END   PSD T.SAITOH 2002/03/28 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
*  SELECT  gjahr belnr shkzg dmbtr hkont zfbdt FROM bsad
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
SELECT  BUDAT GJAHR AUGBL AUGDT SHKZG DMBTR HKONT ZFBDT FROM BSAD
*---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSAD
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
AND BLART IN S_BLART       "伝票タイプ
AND HKONT IN S_UYOTEI      "売掛金入金予定
AND BUDAT IN S_ZFBDT     "支払基準日と転記日
*                        AND XREF3 IN S_ZFBDT       "支払基準日
*---APPEND START PSD T.SAITOH 2002/03/28 転記キー-------------------*
AND BSCHL IN S_BSCHL       "転記キー
*---APPEND END   PSD T.SAITOH 2002/03/28 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
*                        AND zterm = wa_knvv-zterm. "支払条件
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
.
*---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*

CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
*---APPEND START PSD T.SAITOH 2002/02/19 ---------------------------*
EXIT.
*---APPEND END   PSD T.SAITOH 2002/02/19 ---------------------------*
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_011 SY-SUBRC.
ENDCASE.

* 会計伝票抽出処理
*---MODIFY START PSD T.SAITOH 2002/02/20 ---------------------------*
LOOP AT G_TAB_BSAD INTO WA_BSAD.
SELECT GJAHR BUZEI BELNR SHKZG HKONT DMBTR ZFBDT FROM BSEG
INTO CORRESPONDING FIELDS OF WA_BSEG
WHERE BUKRS = P_BUKRS       "会社コード
AND BELNR = WA_BSAD-AUGBL  "決済伝票番号
AND GJAHR = WA_BSAD-GJAHR  "会計年度
AND ( HKONT IN S_GENKIN    "現金勘定
OR HKONT IN S_TEGATA    "手形勘定
*                           OR HKONT IN S_SOUSAI    "相殺勘定
OR HKONT IN S_TANYU )   "他入金勘定
.
WA_BSEG-AUGDT = WA_BSAD-AUGDT.
APPEND WA_BSEG TO G_TAB_BSEG.
ENDSELECT.
ENDLOOP.
*10/03
*相殺処理を行った会計伝票番号を取得
LOOP AT G_TAB_BSAD INTO WA_BSAD.
SELECT GJAHR BUZEI BELNR SHKZG HKONT DMBTR ZFBDT FROM BSEG
INTO CORRESPONDING FIELDS OF WA_BSEG
WHERE BUKRS = P_BUKRS       "会社コード
AND BELNR = WA_BSAD-AUGBL  "決済伝票番号
AND GJAHR = WA_BSAD-GJAHR  "会計年度
AND HKONT IN S_SOUSAI    "相殺勘定
.
APPEND WA_BSAD TO G_TAB_BSAD_SOSAI.
ENDSELECT.
ENDLOOP.
*相殺処理を行った会計伝票の明細を取得する
DATA: G_TAB_BSEG_SOSAI TYPE SORTED TABLE OF ZF011000_TYP_BSEG
WITH UNIQUE KEY BELNR
GJAHR
BUZEI.
LOOP AT G_TAB_BSAD_SOSAI INTO WA_BSAD.
SELECT GJAHR BUZEI BELNR SHKZG HKONT DMBTR ZFBDT FROM BSEG
INTO CORRESPONDING FIELDS OF WA_BSEG
WHERE BUKRS = P_BUKRS       "会社コード
AND KUNNR = P_KUNNR        "得意先コード
AND BELNR = WA_BSAD-AUGBL  "伝票番号
AND GJAHR = WA_BSAD-GJAHR  "会計年度
AND ( HKONT IN S_SOUSAI    "相殺勘定
OR HKONT IN S_UYOTEI )   "売掛勘定
.
WA_BSEG-AUGDT = WA_BSAD-BUDAT.
INSERT WA_BSEG INTO TABLE G_TAB_BSEG_SOSAI.
*      APPEND WA_BSEG TO G_TAB_BSEG_SOSAI.
ENDSELECT.
ENDLOOP.
*相殺金額の集計
*10/28 START
G_SOUSAI_1 = 0.
G_YOTEI_1  = 0.
LOOP AT G_TAB_BSEG_SOSAI INTO WA_BSEG.
AT NEW BELNR.
G_SOUSAI = 0.
G_YOTEI  = 0.
ENDAT.
G_AUGDT = WA_BSEG-AUGDT.
IF WA_BSEG-SHKZG = 'H'.
WA_BSEG-DMBTR = WA_BSEG-DMBTR * -1.
ENDIF.
IF WA_BSEG-HKONT IN S_SOUSAI.
G_SOUSAI = G_SOUSAI + WA_BSEG-DMBTR.
ENDIF.
IF WA_BSEG-HKONT IN S_UYOTEI.
G_YOTEI = G_YOTEI + WA_BSEG-DMBTR.
ENDIF.
AT END OF BELNR.
G_SOUSAI_1 = G_SOUSAI_1 + G_SOUSAI.
G_YOTEI_1 = G_YOTEI_1 + G_YOTEI.
ENDAT.
ENDLOOP.
*得意先毎の合計から実相殺額を求める.
IF G_SOUSAI_1 < 0.
G_SOUSAI_1 = G_SOUSAI_1 * -1.
ENDIF.
IF G_YOTEI_1 < 0.
G_YOTEI_1  = G_YOTEI_1 * -1.
ENDIF.
WA_BSEG-HKONT = C_YOTEI.
IF G_SOUSAI > G_YOTEI.
WA_BSEG-DMBTR = G_YOTEI.
ELSE.
WA_BSEG-DMBTR = G_SOUSAI.
ENDIF.
WA_BSEG-AUGDT = G_AUGDT.
*相殺額を抽出し構造テーブルに出力する
APPEND WA_BSEG TO G_TAB_BSEG.
*10/28 END
*10/03

*---MODIFY END   PSD T.SAITOH 2002/02/20 ---------------------------*
****---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
****  SELECT  SHKZG HKONT DMBTR FROM BSEG
***  SELECT BELNR SHKZG HKONT DMBTR ZFBDT FROM BSEG
****---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
****---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
****                    INTO CORRESPONDING FIELDS OF TABLE g_tab_bsad
****---DELETE   END PSD T.SAITOH 2002/02/13 ---------------------------*
***                     INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSEG
***                      FOR ALL ENTRIES IN G_TAB_BSAD
***                     WHERE BUKRS = P_BUKRS           "会社コード
****---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
****                       AND belnr = g_tab_bsad-belnr  "会計伝票番号
****---DELETE   END PSD T.SAITOH 2002/02/13 ---------------------------*
****---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
***                       AND BELNR = G_TAB_BSAD-AUGBL  "決済伝票番号
****---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*
***                       AND GJAHR = G_TAB_BSAD-GJAHR  "会計年度
****---MODIFY START PSD T.SAITOH 2002/02/19 ---------------------------*
****                      AND HKONT IN (S_GENKIN,S_TEGATA,S_SOUSAI,
**S_TANYU)
***                       AND ( HKONT IN S_GENKIN
***                          OR HKONT IN S_TEGATA
***                          OR HKONT IN S_SOUSAI
***                          OR HKONT IN S_TANYU )
***                                                     "入金勘定
****---MODIFY END   PSD T.SAITOH 2002/02/19 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
*                       AND zterm = wa_knvv-zterm     "支払条件
*                       AND KUNNR = P_KUNNR ".         "得意先コード
*---DELETE   END PSD T.SAITOH 2002/02/13 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/02/13 ---------------------------*
.
*---APPEND END   PSD T.SAITOH 2002/02/13 ---------------------------*

CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_012 SY-SUBRC.
ENDCASE.


ENDFORM.                    " f_sumnyukin
*&---------------------------------------------------------------------*
*&      Form  f_sum_urizan
*&---------------------------------------------------------------------*
*       売掛金残高集計処理
*----------------------------------------------------------------------*
FORM F_SUM_URIZAN.
*---APPEND START PSD T.SAITOH 2002/03/29 ---------------------------*
* select number 10
*---APPEND END   PSD T.SAITOH 2002/03/29 ---------------------------*
*09/04 START
*  SELECT  GJAHR BELNR SHKZG DMBTR HKONT ZFBDT FROM BSID
SELECT  BUDAT GJAHR BELNR SHKZG DMBTR HKONT ZFBDT FROM BSID
*09/04 END
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSID
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
*---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
*                       AND blart IN s_blart       "伝票タイプ
*---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
AND HKONT IN S_URI         "売掛金勘定
*---MODIFY START PSD T.SAITOH 2002/04/19 ---------------------------*
* 売掛金残高／入金予定　累計対応
*                        AND ZFBDT IN S_ZFBDT       "支払基準日
*09/04 START
*                        AND ZFBDT IN S_ZFBDT_PAST   "支払基準日以前
AND BUDAT IN S_ZFBDT_PAST   "転記日以前
*09/04 END
*---MODIFY END   PSD T.SAITOH 2002/04/19 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/03/29 ---------------------------*
*                       AND ZTERM = WA_KNVV-ZTERM  "支払条件
.
*---DELETE END   PSD T.SAITOH 2002/03/29 ---------------------------*
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.

*10/28 START
SELECT  BUDAT GJAHR BELNR SHKZG DMBTR HKONT ZFBDT FROM BSAD
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSAD
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
*                        AND blart IN s_blart      "伝票タイプ
AND HKONT IN S_URI         "売掛金勘定
AND BUDAT IN S_ZFBDT_PAST   "転記日以前
.
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.
*10/28 END

* 期間別に売上残高集計処理
*---APPEND START PSD T.SAITOH 2002/04/19 ---------------------------*
* 売掛金残高／入金予定　累計対応
* 先々月よりも過去のデータすべて
CLEAR :WA_BSID,TMP_BSID,WA_BSAD,TMP_BSAD.
REFRESH  S_ZFBDT2."作業用でも変数名に番号振るのはよくない
APPEND G_ZFBDT0 TO S_ZFBDT2.
*09/04  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17_SIME_0 = TMP_BSID-DMBTR.

*10/28 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17_SIME_0 = G_LIST_17_SIME_0 + TMP_BSAD-DMBTR.
*10/28 END

*---APPEND END   PSD T.SAITOH 2002/04/19 ---------------------------*

* 先々月
CLEAR :WA_BSID,TMP_BSID,WA_BSAD,TMP_BSAD.
*09/06  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT1 TO S_ZFBDT2.
*09/04  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_1 = TMP_BSID-DMBTR.

*10/28 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_1 = G_LIST_17-SIME_1 + TMP_BSAD-DMBTR.
*10/28 END

* 先月
CLEAR :WA_BSID,TMP_BSID,WA_BSAD,TMP_BSAD.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT2 TO S_ZFBDT2.
*09/04  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_2 = TMP_BSID-DMBTR.

*10/28 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_2 = G_LIST_17-SIME_2 + TMP_BSAD-DMBTR.
*10/28 END


* 当月
CLEAR :WA_BSID,TMP_BSID,WA_BSAD,TMP_BSAD.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT3 TO S_ZFBDT2.
*09/04  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_3 = TMP_BSID-DMBTR.

*10/28 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_3 = G_LIST_17-SIME_3 + TMP_BSAD-DMBTR.
*10/28 END

* 翌月
CLEAR :WA_BSID,TMP_BSID,WA_BSAD,TMP_BSAD.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT4 TO S_ZFBDT2.
*09/04  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_4 = TMP_BSID-DMBTR.

*10/28 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_17-SIME_4 = G_LIST_17-SIME_4 + TMP_BSAD-DMBTR.
*10/28 END


CLEAR :WA_BSID,TMP_BSID.
REFRESH  S_ZFBDT2.

* 期間別に売上集計処理
*---DELETE START PSD T.SAITOH 2002/02/23 ---------------------------*
*  PERFORM F_SUM_URIAGE.
*---DELETE END   PSD T.SAITOH 2002/02/23 ---------------------------*

ENDFORM.                    " f_sum_urizan
*---DELETE START PSD T.SAITOH 2002/02/23 SCR003---------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_uriage
*&---------------------------------------------------------------------*
*       売上集計処理（期間別）
*----------------------------------------------------------------------*
*FORM F_SUM_URIAGE.
**---MODIFY START PSD T.SAITOH 2002/02/14 ---------------------------*
**  SELECT  SHKZG HKONT DMBTR FROM BSEG
*  SELECT  SHKZG HKONT DMBTR ZFBDT BELNR BUZEI GJAHR FROM BSEG
**---MODIFY END   PSD T.SAITOH 2002/02/14 ---------------------------*
*                    INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSEG
*                     FOR ALL ENTRIES IN G_TAB_BSID
*                    WHERE BUKRS = P_BUKRS           "会社コード
*                      AND BELNR = G_TAB_BSID-BELNR  "会計伝票番号
*                      AND GJAHR = G_TAB_BSID-GJAHR  "会計年度
*                      AND HKONT IN S_URIAGE         "売上勘定
**---DELETE START PSD T.SAITOH 2002/02/13 ---------------------------*
**                      AND zterm = wa_knvv-zterm     "支払条件
**                      AND kunnr = p_kunnr .         "得意先コード
**---DELETE END   PSD T.SAITOH 2002/02/13 ---------------------------*
*                      .
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4."対象データなし
**      MESSAGE s600 WITH c_knkk.
**      STOP.
*    WHEN OTHERS.
*      MESSAGE A603 WITH SY-REPID C_TBL_012 SY-SUBRC.
*  ENDCASE.
*
**---APPEND START PSD T.SAITOH 2002/02/14 ---------------------------*
** BSEG-ZFBDT(支払基準日)がないので、BSID-ZFBDTをセット
*  LOOP AT G_TAB_BSEG INTO WA_BSEG.
*    READ TABLE G_TAB_BSID INTO WA_BSID
*                          WITH KEY BELNR = WA_BSEG-BELNR
*                                   GJAHR = WA_BSEG-GJAHR.
*    IF SY-SUBRC = 0.
*      WA_BSEG-ZFBDT = WA_BSID-ZFBDT.
*      MODIFY G_TAB_BSEG FROM WA_BSEG
*                   TRANSPORTING  ZFBDT  WHERE BELNR = WA_BSEG-BELNR
*                                          AND GJAHR = WA_BSEG-GJAHR.
*    ENDIF.
*  ENDLOOP.
**---APPEND END   PSD T.SAITOH 2002/02/14 ---------------------------*
*
** 期間別に売上残高集計処理
** 先々月
*  CLEAR :WA_BSEG,TMP_BSEG.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT1 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_01-SIME_1 = TMP_BSEG-DMBTR.
*
**---APPEND START PSD T.SAITOH 2002/02/18 ---------------------------*
*  CLEAR:TMP_BSEG.
**---APPEND END   PSD T.SAITOH 2002/02/18 ---------------------------*
** 先月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT2 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_01-SIME_2 = TMP_BSEG-DMBTR.
*
**---APPEND START PSD T.SAITOH 2002/02/18 ---------------------------*
*  CLEAR:TMP_BSEG.
**---APPEND END   PSD T.SAITOH 2002/02/18 ---------------------------*
** 当月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT3 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_01-SIME_3 = TMP_BSEG-DMBTR.
*
**---APPEND START PSD T.SAITOH 2002/02/18 ---------------------------*
*  CLEAR:TMP_BSEG.
**---APPEND END   PSD T.SAITOH 2002/02/18 ---------------------------*
** 翌月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT4 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_01-SIME_4 = TMP_BSEG-DMBTR.
*  CLEAR :WA_BSEG,TMP_BSEG,S_ZFBDT2.
*  REFRESH  S_ZFBDT2.
*
*  FREE :G_TAB_BSID ,G_TAB_BSEG.
*
*ENDFORM.                    " f_sum_uriage
*---DELETE END   PSD T.SAITOH 2002/02/23 SCR003---------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_seikyu
*&---------------------------------------------------------------------*
*       請求伝票関連集計処理
*----------------------------------------------------------------------*
FORM F_SUM_SEIKYU.
* 請求伝票ヘッダ読込処理
*---MODIFY START PSD T.SAITOH 2002/02/23 ---------------------------*
*  SELECT  FKART FKDAT VBELN NETWR WAERK FROM VBRK
SELECT  FKART FKDAT VBELN WAERK VBTYP FROM VBRK
*---MODIFY END   PSD T.SAITOH 2002/02/23 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE G_TAB_VBRK
*---MODIFY START PSD T.SAITOH 2002/02/18 ---------------------------*
*                      FOR ALL ENTRIES IN G_TAB_FKART
*                      WHERE FKART = G_TAB_FKART-FTYPE "請求タイプ
WHERE FKDAT IN S_ZFBDT          "請求日
*---MODIFY END   PSD T.SAITOH 2002/02/18 ---------------------------*
AND BUKRS = P_BUKRS           "会社コード
*---MODIFY START PSD T.SAITOH 2002/02/23 ---------------------------*
*                        AND KNKLI = P_KUNNR .         "得意先コード
AND KUNRG = P_KUNNR          "得意先コード
AND ( ( FKART =  CNS_F2
AND     FKTYP =  CNS_L
AND     VBTYP =  CNS_M )
OR   ( FKART =  CNS_RE
AND     FKTYP =  CNS_L
AND     VBTYP =  CNS_O )
OR   ( FKART =  CNS_S2
AND     FKTYP =  CNS_A
AND     VBTYP =  CNS_S )
OR   ( FKART =  CNS_S2
AND     FKTYP =  CNS_L
AND     VBTYP =  CNS_S )
OR   ( FKART =  CNS_S1
AND     FKTYP =  CNS_A
AND     VBTYP =  CNS_N )
OR   ( FKART =  CNS_S1
AND     FKTYP =  CNS_L
AND     VBTYP =  CNS_N )
OR   ( FKART =  CNS_L2
AND     FKTYP =  CNS_A
AND     VBTYP =  CNS_P )
OR   ( FKART =  CNS_G2
AND     FKTYP =  CNS_A
AND     VBTYP =  CNS_O ) ).
*---MODIFY END   PSD T.SAITOH 2002/02/23 ---------------------------*
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*---APPEND START PSD T.SAITOH 2002/02/18 ---------------------------*
EXIT.
*---APPEND END   PSD T.SAITOH 2002/02/18 ---------------------------*
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_013 SY-SUBRC.
ENDCASE.

* 請求伝票明細読込処理
*---MODIFY START PSD T.SAITOH 2002/02/23 ---------------------------*
*  SELECT VBELN WAVWR MWSBP KURSK  FROM VBRP
*8/31 START
*  SELECT VBELN WAVWR MWSBP KURSK NETWR FROM VBRP
SELECT VBELN POSNR WAVWR MWSBP KURSK NETWR FROM VBRP
*8/31 END
*---MODIFY END   PSD T.SAITOH 2002/02/23 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE G_TAB_VBRP
FOR ALL ENTRIES IN G_TAB_VBRK
WHERE VBELN = G_TAB_VBRK-VBELN. "請求伝票番号
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_014 SY-SUBRC.
ENDCASE.
* 原価・税額集計処理
SORT G_TAB_VBRP BY VBELN ASCENDING.
LOOP AT G_TAB_VBRP INTO WA_VBRP.
WA_VBRP2 = WA_VBRP.
*---APPEND START PSD T.SAITOH 2002/02/15 ---------------------------*
WA_VBRP3-VBELN = WA_VBRP-VBELN.
*---APPEND END   PSD T.SAITOH 2002/02/15 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/15 2002/02/23-TPR001 SCR003---*
*   請求伝票通貨を取得
READ TABLE G_TAB_VBRK INTO WA_VBRK
WITH KEY VBELN = WA_VBRP-VBELN.
*   請求タイプを格納
WA_VBRP3-FKDAT = WA_VBRK-FKDAT.
*   請求日を格納
WA_VBRP3-FKART = WA_VBRK-FKART.
*   請求カテゴリを設定
WA_VBRP3-VBTYP = WA_VBRP-VBTYP.
*   正味額を格納
*8/31 START
*    WA_VBRP3-NETWR = WA_VBRP-NETWR + WA_VBRP3-NETWR.
WA_VBRP2-NETWR =  WA_VBRP-NETWR * WA_VBRP-KURSK.
*8/31 END
*   原価価格変換
*    PERFORM FRM_KINGAKU_HENKAN USING    WA_VBRK-WAERK
*                                        WA_VBRP2-WAVWR
*                               CHANGING WA_VBRP2-WAVWR.

*   税額価格変換
*    PERFORM FRM_KINGAKU_HENKAN USING    WA_VBRK-WAERK
*                                        WA_VBRP2-MWSBP
*                               CHANGING WA_VBRP2-MWSBP.
*   伝票カテゴリによる変換
IF WA_VBRK-VBTYP = CNS_N OR
WA_VBRK-VBTYP = CNS_O.
WA_VBRP2-WAVWR = WA_VBRP2-WAVWR * ( -1 ).
WA_VBRP2-MWSBP = WA_VBRP2-MWSBP * ( -1 ).
*8/31 START売上高レート換算
WA_VBRP2-NETWR = WA_VBRP2-NETWR * ( -1 ).
ENDIF.
*8/31 END

*   原価換算レート乗算
WA_VBRP2-WAVWR = WA_VBRP-KURSK * WA_VBRP2-WAVWR.
*   税額換算レート乗算
WA_VBRP2-MWSBP = WA_VBRP-KURSK * WA_VBRP2-MWSBP.

*---MODIFY END   PSD T.SAITOH 2002/02/15 2002/02/23 TPR001 SCR003---*
*8/31 START
*    WA_VBRP3-WAVWR = WA_VBRP3-WAVWR + WA_VBRP2-WAVWR.
*    WA_VBRP3-MWSBP = WA_VBRP3-MWSBP + WA_VBRP2-MWSBP.
IF WA_VBRK-WAERK = C_JPY.
WA_VBRP3-WAVWR = WA_VBRP3-WAVWR + WA_VBRP2-WAVWR.
WA_VBRP3-MWSBP = WA_VBRP3-MWSBP + WA_VBRP2-MWSBP.
WA_VBRP3-NETWR = WA_VBRP3-NETWR + WA_VBRP2-NETWR.
ELSE.
WA_VBRP3-WAVWR = WA_VBRP3-WAVWR + WA_VBRP2-WAVWR / 100.
WA_VBRP3-MWSBP = WA_VBRP3-MWSBP + WA_VBRP2-MWSBP / 100.
WA_VBRP3-NETWR = WA_VBRP3-NETWR + WA_VBRP2-NETWR / 100.
ENDIF.
*8/31 END
AT END OF VBELN.
*---MODIFY START PSD T.SAITOH 2002/02/14 2002/02/23 TPR001----------*
*     APPEND WA_VBRP3-WAVWR TO G_TAB_VBRP2.
APPEND WA_VBRP3 TO G_TAB_VBRP2.
CLEAR: WA_VBRP3,WA_VBRP2.
*---MODIFY END   PSD T.SAITOH 2002/02/14 2002/02/23 TPR001----------*
ENDAT.
ENDLOOP.
CLEAR: WA_VBRP,WA_VBRP2,WA_VBRP3.

*---REMAKE START PSD T.SAITOH 2002/02/18 TPR001---------------------*
* 各集計処理
CLEAR: S_ZFBDT2,WA_VBRK,WA_VBRP.
REFRESH  S_ZFBDT2.
***** 締め日期間を昇順ソート
****  SORT S_ZFBDT ASCENDING BY LOW.
***** 締め日期間を設定
****  READ TABLE S_ZFBDT INTO G_ZFBDT1 INDEX 1.
****  READ TABLE S_ZFBDT INTO G_ZFBDT2 INDEX 2.
****  READ TABLE S_ZFBDT INTO G_ZFBDT3 INDEX 3.
****  READ TABLE S_ZFBDT INTO G_ZFBDT4 INDEX 4.
* 請求伝票番号でループ
LOOP AT G_TAB_VBRP2 INTO WA_VBRP.
*   前々月の場合
IF    WA_VBRP-FKDAT >= G_ZFBDT1-LOW
AND WA_VBRP-FKDAT <= G_ZFBDT1-HIGH.
PERFORM FRM_MON_SUM_VBRP USING WA_VBRP
G_LIST_01-SIME_1
G_LIST_02-SIME_1
G_LIST_03-SIME_1
G_LIST_04-SIME_1
G_LIST_05-SIME_1
G_LIST_06-SIME_1
G_LIST_08-SIME_1
WA_VBRP1-WAVWR.
ENDIF.
*   前月の場合
IF    WA_VBRP-FKDAT >= G_ZFBDT2-LOW
AND WA_VBRP-FKDAT <= G_ZFBDT2-HIGH.
PERFORM FRM_MON_SUM_VBRP USING WA_VBRP
G_LIST_01-SIME_2
G_LIST_02-SIME_2
G_LIST_03-SIME_2
G_LIST_04-SIME_2
G_LIST_05-SIME_2
G_LIST_06-SIME_2
G_LIST_08-SIME_2
WA_VBRP2-WAVWR.
ENDIF.
*   当月の場合
IF    WA_VBRP-FKDAT >= G_ZFBDT3-LOW
AND WA_VBRP-FKDAT <= G_ZFBDT3-HIGH.
PERFORM FRM_MON_SUM_VBRP USING WA_VBRP
G_LIST_01-SIME_3
G_LIST_02-SIME_3
G_LIST_03-SIME_3
G_LIST_04-SIME_3
G_LIST_05-SIME_3
G_LIST_06-SIME_3
G_LIST_08-SIME_3
WA_VBRP3-WAVWR.
ENDIF.
*   次月の場合
IF    WA_VBRP-FKDAT >= G_ZFBDT4-LOW
AND WA_VBRP-FKDAT <= G_ZFBDT4-HIGH.
PERFORM FRM_MON_SUM_VBRP USING WA_VBRP
G_LIST_01-SIME_4
G_LIST_02-SIME_4
G_LIST_03-SIME_4
G_LIST_04-SIME_4
G_LIST_05-SIME_4
G_LIST_06-SIME_4
G_LIST_08-SIME_4
WA_VBRP4-WAVWR.
ENDIF.
ENDLOOP.
*---REMAKE END   PSD T.SAITOH 2002/02/18 TPR001---------------------*

ENDFORM.                    " f_sum_seikyu
*---APPEND START PSD T.SAITOH 2002/02/18 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  F_SUM_ETC
*&---------------------------------------------------------------------*
*       その他集計
*----------------------------------------------------------------------*
FORM F_SUM_ETC.
* 売上計計算
*09/06 START
*  G_LIST_07-SIME_1 = G_LIST_01-SIME_1 - G_LIST_02-SIME_1
*                   - G_LIST_03-SIME_1 + G_LIST_04-SIME_1
*                   - G_LIST_05-SIME_1 + G_LIST_06-SIME_1.
*  G_LIST_07-SIME_2 = G_LIST_01-SIME_2 - G_LIST_02-SIME_2
*                   - G_LIST_03-SIME_2 + G_LIST_04-SIME_2
*                   - G_LIST_05-SIME_2 + G_LIST_06-SIME_2.
*  G_LIST_07-SIME_3 = G_LIST_01-SIME_3 - G_LIST_02-SIME_3
*                   - G_LIST_03-SIME_3 + G_LIST_04-SIME_3
*                   - G_LIST_05-SIME_3 + G_LIST_06-SIME_3.
*  G_LIST_07-SIME_4 = G_LIST_01-SIME_4 - G_LIST_02-SIME_4
*                   - G_LIST_03-SIME_4 + G_LIST_04-SIME_4
*                   - G_LIST_05-SIME_4 + G_LIST_06-SIME_4.
G_LIST_07-SIME_1 = G_LIST_01-SIME_1 + G_LIST_02-SIME_1
+ G_LIST_03-SIME_1 + G_LIST_04-SIME_1
+ G_LIST_05-SIME_1 + G_LIST_06-SIME_1.
G_LIST_07-SIME_2 = G_LIST_01-SIME_2 + G_LIST_02-SIME_2
+ G_LIST_03-SIME_2 + G_LIST_04-SIME_2
+ G_LIST_05-SIME_2 + G_LIST_06-SIME_2.
G_LIST_07-SIME_3 = G_LIST_01-SIME_3 + G_LIST_02-SIME_3
+ G_LIST_03-SIME_3 + G_LIST_04-SIME_3
+ G_LIST_05-SIME_3 + G_LIST_06-SIME_3.
G_LIST_07-SIME_4 = G_LIST_01-SIME_4 + G_LIST_02-SIME_4
+ G_LIST_03-SIME_4 + G_LIST_04-SIME_4
+ G_LIST_05-SIME_4 + G_LIST_06-SIME_4.
*09/06 END
* 消費税計算
*---DELETE START PSD T.SAITOH 2002/02/13 TPR001---------------------*
*  G_LIST_08-SIME_1 = WA_VBRP1-MWSBP.
*  G_LIST_08-SIME_2 = WA_VBRP2-MWSBP.
*  G_LIST_08-SIME_3 = WA_VBRP3-MWSBP.
*  G_LIST_08-SIME_4 = WA_VBRP4-MWSBP.
*---DELETE END   PSD T.SAITOH 2002/02/13 TPR001---------------------*
* 税込計計算
G_LIST_09-SIME_1 = G_LIST_07-SIME_1 + G_LIST_08-SIME_1.
G_LIST_09-SIME_2 = G_LIST_07-SIME_2 + G_LIST_08-SIME_2.
G_LIST_09-SIME_3 = G_LIST_07-SIME_3 + G_LIST_08-SIME_3.
G_LIST_09-SIME_4 = G_LIST_07-SIME_4 + G_LIST_08-SIME_4.
* 粗利計算
*---MODIFY START PSD T.SAITOH 2002/02/23 TPR001-SCR003--------------*
G_LIST_10-SIME_1 = ( G_LIST_07-SIME_1 - WA_VBRP1-WAVWR ).
G_LIST_10-SIME_2 = ( G_LIST_07-SIME_2 - WA_VBRP2-WAVWR ).
G_LIST_10-SIME_3 = ( G_LIST_07-SIME_3 - WA_VBRP3-WAVWR ).
G_LIST_10-SIME_4 = ( G_LIST_07-SIME_4 - WA_VBRP4-WAVWR ).
*  G_LIST_10-SIME_1 = ( G_LIST_02-SIME_1 + G_LIST_03-SIME_1
*                   + G_LIST_04-SIME_1 + G_LIST_05-SIME_1
**                  + G_LIST_06-SIME_1 - WA_VBRP1-WAVWR ) * 100.
*                   + G_LIST_06-SIME_1 - WA_VBRP1-WAVWR ).
*
*  G_LIST_10-SIME_2 = ( G_LIST_02-SIME_2 + G_LIST_03-SIME_2
*                   + G_LIST_04-SIME_2 + G_LIST_05-SIME_2
**                  + G_LIST_06-SIME_2 - WA_VBRP2-WAVWR ) * 100.
*                   + G_LIST_06-SIME_2 - WA_VBRP2-WAVWR ).
*
*  G_LIST_10-SIME_3 =  ( G_LIST_02-SIME_3 + G_LIST_03-SIME_3
*                   + G_LIST_04-SIME_3 + G_LIST_05-SIME_3
**                   + G_LIST_06-SIME_3 - WA_VBRP3-WAVWR ) * 100.
*                   + G_LIST_06-SIME_3 - WA_VBRP3-WAVWR ).
*
*  G_LIST_10-SIME_4 = ( G_LIST_02-SIME_4 + G_LIST_03-SIME_4
*                   + G_LIST_04-SIME_4 + G_LIST_05-SIME_4
**                  + G_LIST_06-SIME_4 - WA_VBRP4-WAVWR ) * 100.
*                   + G_LIST_06-SIME_4 - WA_VBRP4-WAVWR ).
*---MODIFY END   PSD T.SAITOH 2002/02/23 TPR001 SCR003--------------*

ENDFORM.                    " F_SUM_ETC
*---APPEND END   PSD T.SAITOH 2002/02/18 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  f_next_natum
*&---------------------------------------------------------------------*
*       翌月期間算出処理
*----------------------------------------------------------------------*
*---DELETE START PSD T.SAITOH 2002/02/14 ---------------------------*
*FORM f_next_natum.
*  IF t052-zfael = 31."末日締め
*    g_zfbdt4-high = g_zfbdt3-high.
*    g_zfbdt4-low  = g_zfbdt3-high + 1.
*    MOVE  '01' TO g_zfbdt4-high+6(2).
*    g_zfbdt4-high = g_zfbdt4-high + 1.
*    g_zfbdt4-high = g_zfbdt4-high + 31.
*    MOVE  '01' TO g_zfbdt4-high+6(2).
*    g_zfbdt4-high = g_zfbdt4-high - 1.
*
*  ELSE.                                                     "01〜28締め
*    g_zfbdt4-low  = g_zfbdt3-high + 1.
*    g_zfbdt4-high = g_zfbdt4-low.
*    MOVE  t052-zfael TO g_zfbdt4-high+6(2).
*  ENDIF.
*  g_zfbdt4-sign   = 'I'.
*  g_zfbdt4-option = 'BT'.
*  APPEND g_zfbdt4 TO  s_zfbdt.
*ENDFORM.                    " f_next_natum
*---DELETE END   PSD T.SAITOH 2002/02/14 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_genkin
*&---------------------------------------------------------------------*
*       現金入金集計処理
*----------------------------------------------------------------------*
FORM F_SUM_GENKIN.
*---APPEND START PSD T.SAITOH 2002/08/23 ---------------------------*
* 明細行が複数あると、金額が行数倍されているバグ修正
DATA: LT_BSEG TYPE SORTED TABLE OF ZF011000_TYP_BSEG
WITH UNIQUE KEY BELNR
GJAHR
BUZEI.
* 重複データ削除
LOOP AT G_TAB_BSEG INTO WA_BSEG.
*09/05
IF WA_BSEG-SHKZG = 'H'.
WA_BSEG-DMBTR = WA_BSEG-DMBTR * -1.
ENDIF.
*09/05
*10/03
INSERT WA_BSEG INTO TABLE LT_BSEG.
*     MODIFY LT_BSEG FROM WA_BSEG INDEX SY-TABIX .
*10/03
ENDLOOP.
G_TAB_BSEG = LT_BSEG.
*---APPEND END   PSD T.SAITOH 2002/08/23 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/02/19 TPR001---------------------*
* 期間別に売上残高集計処理
LOOP AT G_TAB_BSEG INTO WA_BSEG.
*   前々月の場合
IF    WA_BSEG-AUGDT >= G_ZFBDT1-LOW
AND WA_BSEG-AUGDT <= G_ZFBDT1-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_1
G_LIST_12-SIME_1
G_LIST_13-SIME_1
G_LIST_14-SIME_1
WA_BSEG-HKONT
WA_BSEG-DMBTR.
ENDIF.
*   前月の場合
IF    WA_BSEG-AUGDT >= G_ZFBDT2-LOW
AND WA_BSEG-AUGDT <= G_ZFBDT2-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_2
G_LIST_12-SIME_2
G_LIST_13-SIME_2
G_LIST_14-SIME_2
WA_BSEG-HKONT
WA_BSEG-DMBTR.
ENDIF.
*   当月の場合
IF    WA_BSEG-AUGDT >= G_ZFBDT3-LOW
AND WA_BSEG-AUGDT <= G_ZFBDT3-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_3
G_LIST_12-SIME_3
G_LIST_13-SIME_3
G_LIST_14-SIME_3
WA_BSEG-HKONT
WA_BSEG-DMBTR.
ENDIF.
*   次月の場合
IF    WA_BSEG-AUGDT >= G_ZFBDT4-LOW
AND WA_BSEG-AUGDT <= G_ZFBDT4-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_4
G_LIST_12-SIME_4
G_LIST_13-SIME_4
G_LIST_14-SIME_4
WA_BSEG-HKONT
WA_BSEG-DMBTR.
ENDIF.
ENDLOOP.
** 先々月
*  CLEAR :WA_BSEG,TMP_BSEG.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT1 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE HKONT IN S_GENKIN
*                                    AND ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_11-SIME_1 = TMP_BSEG-DMBTR.
** 先月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT2 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_GENKIN
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_11-SIME_2 = TMP_BSEG-DMBTR.
*
** 当月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT3 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_GENKIN
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_11-SIME_3 = TMP_BSEG-DMBTR.
*
** 翌月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT4 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_GENKIN
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_11-SIME_4 = TMP_BSEG-DMBTR.
*  CLEAR :WA_BSEG,TMP_BSEG,S_ZFBDT2.
*  REFRESH  S_ZFBDT2.
*---MODIFY END   PSD T.SAITOH 2002/02/19 TPR001---------------------*
ENDFORM.                    " f_sum_genkin
*---DELETE START PSD T.SAITOH 2002/02/19 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_tegata
*&---------------------------------------------------------------------*
*       手形入金集計処理
*----------------------------------------------------------------------*
*FORM F_SUM_TEGATA.
** 先々月
*  CLEAR :WA_BSEG,TMP_BSEG.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT1 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE HKONT IN S_TEGATA
*                                    AND ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_12-SIME_1 = TMP_BSEG-DMBTR.
** 先月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT2 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_TEGATA
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_12-SIME_2 = TMP_BSEG-DMBTR.
*
** 当月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT3 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_TEGATA
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_12-SIME_3 = TMP_BSEG-DMBTR.
*
** 翌月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT4 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_TEGATA
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_12-SIME_4 = TMP_BSEG-DMBTR.
*  CLEAR :WA_BSEG,TMP_BSEG,S_ZFBDT2.
*  REFRESH  S_ZFBDT2.
*
*ENDFORM.                    " f_sum_tegata
*---DELETE END   PSD T.SAITOH 2002/02/19 TPR001---------------------*
*---DELETE START PSD T.SAITOH 2002/02/19 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_sousai
*&---------------------------------------------------------------------*
*       相殺入金集計処理
*----------------------------------------------------------------------*
*FORM F_SUM_SOUSAI.
** 先々月
*  CLEAR :WA_BSEG,TMP_BSEG.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT1 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE HKONT IN S_SOUSAI
*                                    AND ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_13-SIME_1 = TMP_BSEG-DMBTR.
** 先月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT2 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_SOUSAI
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_13-SIME_2 = TMP_BSEG-DMBTR.
*
** 当月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT3 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_SOUSAI
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_13-SIME_3 = TMP_BSEG-DMBTR.
*
** 翌月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT4 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_SOUSAI
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_13-SIME_4 = TMP_BSEG-DMBTR.
*  CLEAR :WA_BSEG,TMP_BSEG,S_ZFBDT2.
*  REFRESH  S_ZFBDT2.
*
*ENDFORM.                    " f_sum_sousai
*---DELETE END   PSD T.SAITOH 2002/02/19 TPR001---------------------*
*---DELETE START PSD T.SAITOH 2002/02/19 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_tanyu
*&---------------------------------------------------------------------*
*       他入金集計処理
*----------------------------------------------------------------------*
*FORM F_SUM_TANYU.
** 先々月
*  CLEAR :WA_BSEG,TMP_BSEG.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT1 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE HKONT IN S_TANYU
*                                    AND ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_14-SIME_1 = TMP_BSEG-DMBTR.
** 先月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT2 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_TANYU
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_14-SIME_2 = TMP_BSEG-DMBTR.
*
** 当月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT3 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_TANYU
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_14-SIME_3 = TMP_BSEG-DMBTR.
*
** 翌月
*  CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
*  APPEND G_ZFBDT4 TO S_ZFBDT2.
*  LOOP AT G_TAB_BSEG INTO WA_BSEG WHERE  HKONT IN S_TANYU
*                                    AND  ZFBDT IN S_ZFBDT2.
*    TMP_BSEG-DMBTR = TMP_BSEG-DMBTR + WA_BSEG-DMBTR.
*  ENDLOOP.
*  G_LIST_14-SIME_4 = TMP_BSEG-DMBTR.
*  CLEAR :WA_BSEG,TMP_BSEG,S_ZFBDT2.
*  REFRESH  S_ZFBDT2.
*
*ENDFORM.                    " f_sum_tanyu
*---DELETE END   PSD T.SAITOH 2002/02/19 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  f_sum_ukete
*&---------------------------------------------------------------------*
*       受手決済集計処理
*----------------------------------------------------------------------*
FORM F_SUM_UKETE.
*---APPEND START PSD T.SAITOH 2002/02/22 SCR001---------------------*
* SELECT NUMBER 17
SELECT  ZFBDT GJAHR BELNR SHKZG DMBTR HKONT BUDAT FROM BSAD
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSAD
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
*10/04                          AND AUGDT IN S_ZFBDT       "決済日付
AND BUDAT IN S_ZFBDT       "転記日付
AND ZFBDT IN S_ZFBDT       "基準日
*10/04
AND UMSKZ = 'W'            "特殊仕分コード
AND BLART IN S_BLRTAC      "受手決済伝票タイプ
AND HKONT IN S_UKETE       "受手決済
.
*---APPEND END   PSD T.SAITOH 2002/02/22 SCR001---------------------*
*---DELETE START PSD T.SAITOH 2002/02/22 SCR001---------------------*
*  SELECT  GJAHR BELNR SHKZG DMBTR HKONT ZFBDT FROM BSAD
*                       INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSAD
*                       WHERE BUKRS = P_BUKRS        "会社コード
*                         AND KUNNR = P_KUNNR        "得意先コード
**---DELETE START PSD T.SAITOH 2002/02/20 ---------------------------*
**                        AND BLART IN S_BLART       "伝票タイプ
**---DELETE END   PSD T.SAITOH 2002/02/20 ---------------------------*
*                         AND HKONT IN S_UKETE       "受手決済
*                         AND XREF3 IN S_ZFBDT       "支払基準日
**---DELETE START PSD T.SAITOH 2002/02/20 ---------------------------*
**                         AND ZTERM = WA_KNVV-ZTERM. "支払条件
**---DELETE END   PSD T.SAITOH 2002/02/20 ---------------------------*
**---APPEND START PSD T.SAITOH 2002/02/20 ---------------------------*
*                         .
**---APPEND END   PSD T.SAITOH 2002/02/20 ---------------------------*
*---DELETE END   PSD T.SAITOH 2002/02/22 SCR001---------------------*

CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_011 SY-SUBRC.
ENDCASE.

* 期間別に集計処理
* 先々月
CLEAR :WA_BSAD,TMP_BSAD.
REFRESH  S_ZFBDT2.
APPEND G_ZFBDT1 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/02/22 TPR076-SCR001--------------*
*  LOOP AT G_TAB_BSAD INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSAD INTO WA_BSAD
WHERE BUDAT IN S_ZFBDT2
AND ZFBDT IN S_ZFBDT2.
*---MODIFY END   PSD T.SAITOH 2002/02/22 TPR076-SCR001--------------*
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.

ENDLOOP.
G_LIST_16-SIME_1 = TMP_BSAD-DMBTR.
* 先月
CLEAR :WA_BSAD,TMP_BSAD.
REFRESH  S_ZFBDT2.
APPEND G_ZFBDT2 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/02/22 TPR001---------------------*
*  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSAD INTO WA_BSAD
WHERE BUDAT IN S_ZFBDT2
AND ZFBDT IN S_ZFBDT2.
*---MODIFY END   PSD T.SAITOH 2002/02/22 TPR001---------------------*
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDLOOP.
G_LIST_16-SIME_2 = TMP_BSAD-DMBTR.
* 当月
CLEAR :WA_BSAD,TMP_BSAD.
REFRESH  S_ZFBDT2.
APPEND G_ZFBDT3 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/02/22 TPR001---------------------*
*  LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSAD INTO WA_BSAD
WHERE BUDAT IN S_ZFBDT2
AND ZFBDT IN S_ZFBDT2.
*---MODIFY END   PSD T.SAITOH 2002/02/22 TPR001---------------------*
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.

ENDLOOP.
G_LIST_16-SIME_3 = TMP_BSAD-DMBTR.
* 翌月
CLEAR :WA_BSAD,TMP_BSAD.
REFRESH  S_ZFBDT2.
APPEND G_ZFBDT4 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/02/22 TPR001---------------------*
*  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSAD INTO WA_BSAD
WHERE BUDAT IN S_ZFBDT2
AND ZFBDT IN S_ZFBDT2.
*---MODIFY END   PSD T.SAITOH 2002/02/22 TPR001---------------------*
TMP_BSAD-DMBTR = TMP_BSAD-DMBTR + WA_BSAD-DMBTR.
ENDLOOP.
G_LIST_16-SIME_4 = TMP_BSAD-DMBTR.
CLEAR :WA_BSAD,TMP_BSAD.
REFRESH  S_ZFBDT2.

ENDFORM.                    " f_sum_ukete
*&---------------------------------------------------------------------*
*&      Form  f_sum_uriyotei
*&---------------------------------------------------------------------*
*       売掛金入金予定集計処理
*----------------------------------------------------------------------*
FORM F_SUM_URIYOTEI.
*---MODIFY START PSD T.SAITOH 2002/03/29 ---------------------------*
* select number 16
*  SELECT  GJAHR BELNR SHKZG DMBTR HKONT ZFBDT FROM BSID
*09/05  SELECT  GJAHR BELNR SHKZG DMBTR HKONT ZFBDT XREF3 FROM BSID
SELECT  GJAHR BELNR SHKZG DMBTR HKONT ZFBDT BUDAT FROM BSID
*---MODIFY END   PSD T.SAITOH 2002/03/29 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSID
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
*09/06                         AND BLART IN S_BLART       "伝票タイプ
AND HKONT IN S_UYOTEI      "売掛金入金予定
*---MODIFY START PSD T.SAITOH 2002/03/29 ---------------------------*
*                        AND ZFBDT IN S_ZFBDT       "支払基準日
*---MODIFY START PSD T.SAITOH 2002/04/19 ---------------------------*
* 売掛金残高／入金予定　累計対応
*                         AND XREF3 IN S_ZFBDT       "支払基準日
*09/05                    AND XREF3 IN S_ZFBDT_PAST "支払基準日過去
AND BUDAT IN S_ZFBDT_PAST "転記日過去
*---MODIFY END   PSD T.SAITOH 2002/04/19 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/03/29 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/02/20 TPR001---------------------*
*                         AND ZTERM = WA_KNVV-ZTERM. "支払条件
*---APPEND END   PSD T.SAITOH 2002/02/20 TPR001---------------------*
*---APPEND START PSD T.SAITOH 2002/02/20 TPR001---------------------*
.
*---APPEND END   PSD T.SAITOH 2002/02/20 TPR001---------------------*
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.

*09/06 START
SELECT  GJAHR BELNR SHKZG DMBTR HKONT ZFBDT BUDAT FROM BSAD
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSAD
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
AND BLART IN S_BLART       "伝票タイプ
AND HKONT IN S_UYOTEI      "売掛金入金予定
*                         AND BSCHL IN S_BSCHL       "転記キー
AND BUDAT IN S_ZFBDT.      "転記日付
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.
*09/06 END
* 期間別に集計処理
*---APPEND START PSD T.SAITOH 2002/04/19 ---------------------------*
* 売掛金残高／入金予定　累計対応
* 先々月よりも前
CLEAR :WA_BSID,TMP_BSID.
REFRESH  S_ZFBDT2.
APPEND G_ZFBDT0 TO S_ZFBDT2.
*09/05  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
*09/06 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
*09/06 END
G_LIST_18_SIME_0 = TMP_BSID-DMBTR.
*---APPEND END   PSD T.SAITOH 2002/04/19 ---------------------------*
* 先々月
CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT1 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/03/29 ---------------------------*
*  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
*09/05  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
*---MODIFY end   PSD T.SAITOH 2002/03/29 ---------------------------*
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
*09/06 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
*09/06 END
G_LIST_18-SIME_1 = TMP_BSID-DMBTR.
* 先月
CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT2 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/03/29 ---------------------------*
*  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
*09/05  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
*---MODIFY end   PSD T.SAITOH 2002/03/29 ---------------------------*
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
*09/06 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
*09/06 END
G_LIST_18-SIME_2 = TMP_BSID-DMBTR.
* 当月
CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT3 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/03/29 ---------------------------*
*  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
*09/05  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
*---MODIFY end   PSD T.SAITOH 2002/03/29 ---------------------------*
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
*09/06 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_18-SIME_3 = TMP_BSID-DMBTR.
* 翌月
CLEAR :WA_BSID,TMP_BSID.
*  REFRESH  S_ZFBDT2.
APPEND G_ZFBDT4 TO S_ZFBDT2.
*---MODIFY START PSD T.SAITOH 2002/03/29 ---------------------------*
*  LOOP AT G_TAB_BSID INTO WA_BSID WHERE ZFBDT IN S_ZFBDT2.
*09/05  LOOP AT G_TAB_BSID INTO WA_BSID WHERE XREF3 IN S_ZFBDT2.
LOOP AT G_TAB_BSID INTO WA_BSID WHERE BUDAT IN S_ZFBDT2.
*---MODIFY END   PSD T.SAITOH 2002/03/29 ---------------------------*
IF WA_BSID-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSID-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.
*09/06 START
LOOP AT G_TAB_BSAD INTO WA_BSAD WHERE BUDAT IN S_ZFBDT2.
IF WA_BSAD-SHKZG = 'H'.
TMP_BSID-DMBTR = TMP_BSID-DMBTR - WA_BSAD-DMBTR.
ELSE.
TMP_BSID-DMBTR = TMP_BSID-DMBTR + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
G_LIST_18-SIME_4 = TMP_BSID-DMBTR.
CLEAR :WA_BSID,TMP_BSID.
REFRESH  S_ZFBDT2.

ENDFORM.                    " f_sum_uriyotei
*&---------------------------------------------------------------------*
*&      Form  f_list_out
*&---------------------------------------------------------------------*
*       帳票出力処理処理
*----------------------------------------------------------------------*
FORM F_LIST_OUT.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
FORMAT COLOR COL_NORMAL ON.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '売　　　　　　　　　上',
031  G_LIST_01-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_01-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_01-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_01-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '返　　　　　　　　　品',
031  G_LIST_02-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_02-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_02-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_02-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '値　　　　引　　　　き',
031  G_LIST_03-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_03-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_03-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_03-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '値　　　　増　　　　し',
031  G_LIST_04-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_04-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_04-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_04-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '請　求　取　り　消　し',
031  G_LIST_05-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_05-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_05-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_05-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 'クレジットメモ取り消し',
031  G_LIST_06-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_06-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_06-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_06-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
FORMAT COLOR OFF.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
FORMAT COLOR COL_TOTAL ON INTENSIFIED OFF.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
WRITE : 002 '売　　　　上　　　　計',
031  G_LIST_07-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_07-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_07-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_07-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '消　　　　費　　　　税',
031  G_LIST_08-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_08-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_08-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_08-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
FORMAT COLOR OFF.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
FORMAT COLOR COL_TOTAL ON INTENSIFIED.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
WRITE : 002 '税　　　　込　　　　計',
031  G_LIST_09-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_09-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_09-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_09-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
FORMAT COLOR OFF.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
FORMAT COLOR COL_NORMAL ON.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
WRITE : 002 '粗　　　　　　　　　利',
031  G_LIST_10-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_10-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_10-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_10-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_ULINE.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*  SKIP.
WRITE : 002 '現     金     入    金',
031  G_LIST_11-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_11-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_11-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_11-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '手     形     入    金',
031  G_LIST_12-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_12-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_12-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_12-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

WRITE : 002 '相     殺     入    金',
031  G_LIST_13-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_13-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_13-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_13-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

*09/04 START 他入金を再計算する（子勘定からの振替分対応）
PERFORM F_LIST_OUT_14.
*09/04 END

WRITE : 002 '他　　　　入　　　　金',
031  G_LIST_14-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_14-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_14-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_14-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*10/03
WRITE : 002 '他　　　　調　　　　整',
031  G_LIST_20-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_20-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_20-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_20-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*10/03 end
FORMAT COLOR OFF.

*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
FORMAT COLOR COL_TOTAL ON INTENSIFIED.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
WRITE : 002 '入　　　　金　　　　計',
031  G_LIST_15-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_15-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_15-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_15-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_ULINE.
PERFORM FRM_SY_VLINE_LEFT.
FORMAT COLOR OFF.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
FORMAT COLOR COL_NORMAL ON.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*  SKIP.
WRITE : 002 '受     手     決    済',
031  G_LIST_16-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_16-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_16-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_16-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*---UNDELETE START PSD T.SAITOH 2002/03/28 親勘定に振替処理廃止→中止-*
* 20002/03/29
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
WRITE : 002 '親  勘  定  に  振  替',
031  G_LIST_19-SIME_1 CURRENCY T001-WAERS,
051  G_LIST_19-SIME_2 CURRENCY T001-WAERS,
071  G_LIST_19-SIME_3 CURRENCY T001-WAERS,
091  G_LIST_19-SIME_4 CURRENCY T001-WAERS.
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*
*---UNDELETE END PSD T.SAITOH 2002/03/28 親勘定に振替処理廃止------*
*---MODIFY START PSD T.SAITOH 2002/04/19 累計に仕様変更------------*
* 売掛金残高／入金予定　累計対応
*  WRITE : 002 '売   掛   金   残   高',
*          031  G_LIST_17-SIME_1 CURRENCY T001-WAERS,
*          051  G_LIST_17-SIME_2 CURRENCY T001-WAERS,
*          071  G_LIST_17-SIME_3 CURRENCY T001-WAERS,
*          091  G_LIST_17-SIME_4 CURRENCY T001-WAERS.
* 累計に仕様変更
WRITE : 002 '売   掛   金   残   高'.
* 前々月より前の金額すべてを累計する。
*09/06  G_LIST_17-SIME_1 = G_LIST_17-SIME_1 + G_LIST_17_SIME_0.
WRITE : 031  G_LIST_17-SIME_1 CURRENCY T001-WAERS.
* 前々月の金額を累計する。
*09/06  G_LIST_17-SIME_2 = G_LIST_17-SIME_2 + G_LIST_17-SIME_1.
WRITE : 051  G_LIST_17-SIME_2 CURRENCY T001-WAERS.
* 前月の金額を累計する。
*09/06  G_LIST_17-SIME_3 = G_LIST_17-SIME_3 + G_LIST_17-SIME_2.
WRITE : 071  G_LIST_17-SIME_3 CURRENCY T001-WAERS.
* 当月の金額を累計する。
*09/06  G_LIST_17-SIME_4 = G_LIST_17-SIME_4 + G_LIST_17-SIME_3.
WRITE : 091  G_LIST_17-SIME_4 CURRENCY T001-WAERS.
*---MODIFY END   PSD T.SAITOH 2002/04/19 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*

*---MODIFY START PSD T.SAITOH 2002/04/19 累計に仕様変更------------*
* 売掛金残高／入金予定　累計対応
*  WRITE : 002 '売 掛 金   入 金 予 定',
*          031  G_LIST_18-SIME_1 CURRENCY T001-WAERS,
*          051  G_LIST_18-SIME_2 CURRENCY T001-WAERS,
*          071  G_LIST_18-SIME_3 CURRENCY T001-WAERS,
*          091  G_LIST_18-SIME_4 CURRENCY T001-WAERS.
* 累計に仕様変更
WRITE : 002 '売 掛 金   入 金 予 定'.
* 前々月より前の金額すべてを累計する。
*09/06  G_LIST_18-SIME_1 = G_LIST_18-SIME_1 + G_LIST_18_SIME_0.
WRITE : 031  G_LIST_18-SIME_1 CURRENCY T001-WAERS.
* 前々月の金額を累計する。
*09/06  G_LIST_18-SIME_2 = G_LIST_18-SIME_2 + G_LIST_18-SIME_1.
WRITE : 051  G_LIST_18-SIME_2 CURRENCY T001-WAERS.
* 前月の金額を累計する。
*09/06  G_LIST_18-SIME_3 = G_LIST_18-SIME_3 + G_LIST_18-SIME_2.
WRITE : 071  G_LIST_18-SIME_3 CURRENCY T001-WAERS.
* 当月の金額を累計する。
*09/06  G_LIST_18-SIME_4 = G_LIST_18-SIME_4 + G_LIST_18-SIME_3.
WRITE : 091  G_LIST_18-SIME_4 CURRENCY T001-WAERS.

*10/04 +++++++++++++++++++++++++
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
WRITE : 002 '    '.

G_LIST_18-SIME_1 = G_LIST_18-SIME_1 + G_LIST_17-SIME_1.
G_LIST_18-SIME_2 = G_LIST_18-SIME_2 + G_LIST_17-SIME_2.
G_LIST_18-SIME_3 = G_LIST_18-SIME_3 + G_LIST_17-SIME_3.
G_LIST_18-SIME_4 = G_LIST_18-SIME_4 + G_LIST_17-SIME_4.

PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_VLINE_LEFT.
FORMAT COLOR COL_TOTAL ON INTENSIFIED.
WRITE : 002 '　売 掛 金　合　計　'.
* 前々月より前の金額すべてを累計する。
*09/06  G_LIST_18-SIME_1 = G_LIST_18-SIME_1 + G_LIST_18_SIME_0.
WRITE : 031  G_LIST_18-SIME_1 CURRENCY T001-WAERS.
* 前々月の金額を累計する。
*09/06  G_LIST_18-SIME_2 = G_LIST_18-SIME_2 + G_LIST_18-SIME_1.
WRITE : 051  G_LIST_18-SIME_2 CURRENCY T001-WAERS.
* 前月の金額を累計する。
*09/06  G_LIST_18-SIME_3 = G_LIST_18-SIME_3 + G_LIST_18-SIME_2.
WRITE : 071  G_LIST_18-SIME_3 CURRENCY T001-WAERS.
* 当月の金額を累計する。
*09/06  G_LIST_18-SIME_4 = G_LIST_18-SIME_4 + G_LIST_18-SIME_3.
WRITE : 091  G_LIST_18-SIME_4 CURRENCY T001-WAERS.

*---MODIFY END   PSD T.SAITOH 2002/04/19 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/04/11 レイアウト調整--------------*
PERFORM FRM_SY_VLINE_RIGHT.
PERFORM FRM_SY_ULINE.
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
ENDFORM.                    " f_list_out

*---APPEND START PSD T.SAITOH 2002/02/14 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_DATA_FOR_PERIOD_CLOSING
*&---------------------------------------------------------------------*
*       締め日を算出する
*----------------------------------------------------------------------*
FORM FRM_DATA_FOR_PERIOD_CLOSING.

CALL FUNCTION 'Z_FDATA_FOR_PERIOD_CLOSING'
EXPORTING
YEAR              = P_YEAR
MON               = P_MONTH
DAY               = T052-ZFAEL
IMPORTING
THR_MONTHS_BEFORE = G_ZFBDT1-LOW
TWO_MONTHS_BEFORE = G_ZFBDT1-HIGH
ONE_MONTH_BEFORE  = G_ZFBDT2-HIGH
THIS_MONTH        = G_ZFBDT3-HIGH
NEXT_MONTH        = G_ZFBDT4-HIGH
EXCEPTIONS
MONTH_ERROR       = 1
OTHERS            = 2.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " FRM_DATA_FOR_PERIOD_CLOSING
*---APPEND END   PSD T.SAITOH 2002/02/14 TPR001---------------------*
*---APPEND START PSD T.SAITOH 2002/02/15 TPR001---------------------*
*&---------------------------------------------------------------------*
*       金額変換処理
*----------------------------------------------------------------------*
*      -->P_TSUKACD  通貨コード
*      -->P_KINGAKU  変換前金額
*      <--P_HENKAN   変換後金額
*----------------------------------------------------------------------*
FORM FRM_KINGAKU_HENKAN USING    P_TSUKACD
P_KINGAKU
CHANGING P_HENKAN.
DATA L_IDOC_AMOUNT(255) TYPE C.
*--- 汎用モジュール金額変換モジュール
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = P_TSUKACD
SAP_AMOUNT  = P_KINGAKU
IMPORTING
IDOC_AMOUNT = L_IDOC_AMOUNT
EXCEPTIONS
OTHERS      = 1.
IF SY-SUBRC <> 1.
P_HENKAN = L_IDOC_AMOUNT.
ENDIF.

ENDFORM.                    " FRM_KINGAKU_HENKAN
*---APPEND END     PSD T.SAITOH 2002/02/15 TPR001---------------------*
*---REMAKE START PSD T.SAITOH 2002/02/18 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_MON_SUM_VBRP
*&---------------------------------------------------------------------*
*       月の請求関連集計
*----------------------------------------------------------------------*
* --> PF_VBRP:請求伝票明細情報
* <-> P_LIST01:売上
* <-> P_LIST02:返品
* <-> P_LIST03:値引き
* <-> P_LIST04:値増し
* <-> P_LIST05:請求取消
* <-> P_LIST06:クレジットメモ取消
* <-> P_LIST08:消費税
* <-> P_WAVWR:原価
*----------------------------------------------------------------------*
FORM FRM_MON_SUM_VBRP USING PF_VBRP  LIKE WA_VBRP
P_LIST01
P_LIST02
P_LIST03
P_LIST04
P_LIST05
P_LIST06
P_LIST08
P_WAVWR.
* 請求タイプごとの集計
CASE PF_VBRP-FKART.
*   売上
WHEN 'F2'.
*     売上集計
P_LIST01 = P_LIST01 + PF_VBRP-NETWR.
*   返品
WHEN 'RE'.
*     返品集計
P_LIST02 = P_LIST02 + PF_VBRP-NETWR.
*   値引き
WHEN 'G2'.
*     値引集計
P_LIST03 = P_LIST03 + PF_VBRP-NETWR.
*   値増し
WHEN 'L2'.
*     値増集計
P_LIST04 = P_LIST04 + PF_VBRP-NETWR.
*   請求取消
WHEN 'S1'.
*     請求取消集計
P_LIST05 = P_LIST05 + PF_VBRP-NETWR.
*   クレジットメモ取消
WHEN 'S2'.
*     クレジットメモ取消集計
P_LIST06 = P_LIST06 + PF_VBRP-NETWR.
WHEN OTHERS.
ENDCASE.

*     消費税減額集計と原価集計
P_LIST08 = P_LIST08 + PF_VBRP-MWSBP.
P_WAVWR = P_WAVWR + PF_VBRP-WAVWR.

ENDFORM.                    " FRM_MON_SUM_VBRP
*---REMAKE END   PSD T.SAITOH 2002/02/18 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  frm_diff_account
*&---------------------------------------------------------------------*
*       金種別集計
*----------------------------------------------------------------------*
*      -->P_LIST11 帳票用変数：現金入金
*      -->P_LIST12 帳票用変数：手形入金
*      -->P_LIST13 帳票用変数：相殺入金
*      -->P_LIST14 帳票用変数：他入金
*      -->P_HKONT  Ｇ/Ｌ勘定
*      -->P_DMBTR  金額
*----------------------------------------------------------------------*
FORM FRM_DIFF_ACCOUNT USING    P_LIST11
P_LIST12
P_LIST13
P_LIST14
P_HKONT
P_DMBTR.
* 現金入金
IF P_HKONT IN S_GENKIN.
P_LIST11 = P_LIST11 + P_DMBTR.
ENDIF.
* 手形入金
IF P_HKONT IN S_TEGATA.
P_LIST12 = P_LIST12 + P_DMBTR.
ENDIF.
* 相殺入金
IF P_HKONT IN S_SOUSAI.
P_LIST13 = P_LIST13 + P_DMBTR.
ENDIF.
* 他入金
IF P_HKONT IN S_TANYU.
P_LIST14 = P_LIST14 + P_DMBTR.
ENDIF.

ENDFORM.                    " frm_diff_account
*&---------------------------------------------------------------------*
*&      Form  F_SUM_MONEY_RECEIVED
*&---------------------------------------------------------------------*
*       入金集計
*----------------------------------------------------------------------*
FORM F_SUM_MONEY_RECEIVED.
* 現金入金集計処理
PERFORM F_SUM_GENKIN.

*---DELETE START PSD T.SAITOH 2002/02/19 TPR001---------------------*
*** 手形入金集計処理
*  PERFORM F_SUM_TEGATA.
*** 相殺入金集計処理
*  PERFORM F_SUM_SOUSAI.
*** 他入金集計処理
*　 PERFORM F_SUM_TANYU.
*---DELETE END   PSD T.SAITOH 2002/02/19 TPR001---------------------*

FREE: G_TAB_BSEG,G_TAB_BSEG.
* 入金計計算
G_LIST_15-SIME_1 = G_LIST_11-SIME_1 + G_LIST_12-SIME_1
+ G_LIST_13-SIME_1 + G_LIST_14-SIME_1.
G_LIST_15-SIME_2 = G_LIST_11-SIME_2 + G_LIST_12-SIME_2
+ G_LIST_13-SIME_2 + G_LIST_14-SIME_2.
G_LIST_15-SIME_3 = G_LIST_11-SIME_3 + G_LIST_12-SIME_3
+ G_LIST_13-SIME_3 + G_LIST_14-SIME_3.
G_LIST_15-SIME_4 = G_LIST_11-SIME_4 + G_LIST_12-SIME_4
+ G_LIST_13-SIME_4 + G_LIST_14-SIME_4.

ENDFORM.                    " F_SUM_MONEY_RECEIVED
*---APPEND START PSD T.SAITOH 2002/02/20 TPR001---------------------*
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_MONTH
*&---------------------------------------------------------------------*
*       月の入力チェック
*----------------------------------------------------------------------*
FORM F_CHECK_MONTH.
IF NOT ( P_MONTH >= 1 AND P_MONTH <= 12 ).
*   &を指定することはできません
MESSAGE E615(Z1) WITH CNS_MSG.
ENDIF.
ENDFORM.                    " F_CHECK_MONTH
*---APPEND END   PSD T.SAITOH 2002/02/20 TPR001---------------------*
*---APPEND START PSD T.SAITOH 2002/02/22 SCR002---------------------*
*&---------------------------------------------------------------------*
*&      Form  F_SUM_MONEY_REC_BSID
*&---------------------------------------------------------------------*
*       BSIDから未決済明細を取得する SELECT NUMBER 19
*----------------------------------------------------------------------*
FORM F_SUM_MONEY_REC_BSID.
* SELECT NUMBER 19
SELECT  GJAHR BELNR BUDAT SHKZG DMBTR HKONT FROM BSID
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSID
WHERE BUKRS = P_BUKRS        "会社コード
AND KUNNR = P_KUNNR        "得意先コード
AND UMSKZ = 'W'            "特殊仕分コード
AND BUDAT IN S_ZFBDT       "決済日付
AND HKONT IN S_TEGATA      "受手入金
.
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.

* 期間別に未決済入金集計（手形入金）処理
LOOP AT G_TAB_BSID INTO WA_BSID.
*   前々月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT1-LOW
AND WA_BSID-BUDAT <= G_ZFBDT1-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_1
G_LIST_12-SIME_1
G_LIST_13-SIME_1
G_LIST_14-SIME_1
WA_BSID-HKONT
WA_BSID-DMBTR.
ENDIF.
*   前月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT2-LOW
AND WA_BSID-BUDAT <= G_ZFBDT2-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_2
G_LIST_12-SIME_2
G_LIST_13-SIME_2
G_LIST_14-SIME_2
WA_BSID-HKONT
WA_BSID-DMBTR.
ENDIF.
*   当月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT3-LOW
AND WA_BSID-BUDAT <= G_ZFBDT3-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_3
G_LIST_12-SIME_3
G_LIST_13-SIME_3
G_LIST_14-SIME_3
WA_BSID-HKONT
WA_BSID-DMBTR.
ENDIF.
*   次月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT4-LOW
AND WA_BSID-BUDAT <= G_ZFBDT4-HIGH.
PERFORM FRM_DIFF_ACCOUNT USING G_LIST_11-SIME_4
G_LIST_12-SIME_4
G_LIST_13-SIME_4
G_LIST_14-SIME_4
WA_BSID-HKONT
WA_BSID-DMBTR.
ENDIF.
ENDLOOP.




ENDFORM.                    " F_SUM_MONEY_REC_BSID
*---APPEND END   PSD T.SAITOH 2002/02/22 SCR002---------------------*
*---APPEND START PSD T.SAITOH 2002/03/11 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  F_GET_KNVP
*&---------------------------------------------------------------------*
*       親勘定取得
*----------------------------------------------------------------------*
* 指定得意先コードが親会社か子会社かを判断し親会社の得意先を取得する
*----------------------------------------------------------------------*
FORM F_GET_KNVP.

SELECT SINGLE KUNN2
FROM KNVP INTO (G_PARENTAGE)
WHERE KUNNR = P_KUNNR
*---APPEND START PSD T.SAITOH 2002/03/29 親子識別条件追加-----------*
AND VKORG = P_VKORG
AND VTWEG = P_VTWEG
AND SPART = P_SPART
AND PARVW = 'Y3'
*---APPEND END   PSD T.SAITOH 2002/03/29 ---------------------------*
.

CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_KNVP SY-SUBRC.
ENDCASE.

ENDFORM.                    " F_GET_KNVP
*&---------------------------------------------------------------------*
*&      Form  f_parent               SELECT NUMBER 20
*&---------------------------------------------------------------------*
*       親勘定に振り替えた金額を取得
*----------------------------------------------------------------------*
FORM F_PARENT_BSID.

SELECT  GJAHR BELNR BUDAT SHKZG DMBTR HKONT ZFBDT FROM BSID
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSID_P
WHERE BUKRS = P_BUKRS        "会社コード
*---MODIFY START PSD T.SAITOH 2002/03/29 子に変更-------------------*
*                        AND KUNNR = G_PARENTAGE    "得意先コード（親）
AND KUNNR = P_KUNNR    "得意先コード（子）
*---MODIFY END   PSD T.SAITOH 2002/03/29 ---------------------------*
AND BLART IN S_BLRTAR      "伝票タイプ売掛金
AND HKONT IN S_URI         "売掛金勘定
*09/03 START
AND BUDAT IN S_ZFBDT.      "転記日と支払基準日
*                        AND ZFBDT IN S_ZFBDT.      "支払基準日
*09/03 END
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.

* 期間別に親会社に振替処理
LOOP AT G_TAB_BSID_P INTO WA_BSID.
* 09/03 START
*  WA_BSID-ZFBDT --> WA_BSID-BUDAT へ変更
*   前々月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT1-LOW
AND WA_BSID-BUDAT <= G_ZFBDT1-HIGH.
G_LIST_19-SIME_1 = G_LIST_19-SIME_1 + WA_BSID-DMBTR.
ENDIF.
*   前月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT2-LOW
AND WA_BSID-BUDAT <= G_ZFBDT2-HIGH.
G_LIST_19-SIME_2 = G_LIST_19-SIME_2 + WA_BSID-DMBTR.
ENDIF.
*   当月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT3-LOW
AND WA_BSID-BUDAT <= G_ZFBDT3-HIGH.
G_LIST_19-SIME_3 = G_LIST_19-SIME_3 + WA_BSID-DMBTR.
ENDIF.
*   次月の場合
IF    WA_BSID-BUDAT >= G_ZFBDT4-LOW
AND WA_BSID-BUDAT <= G_ZFBDT4-HIGH.
G_LIST_19-SIME_4 = G_LIST_19-SIME_4 + WA_BSID-DMBTR.
ENDIF.
ENDLOOP.

ENDFORM.                    " f_parent
*&---------------------------------------------------------------------*
*&      Form  f_parent_bsad          SELECT NUMBER 21
*&---------------------------------------------------------------------*
*       親勘定に振り替えた金額を取得
*----------------------------------------------------------------------*
FORM F_PARENT_BSAD.

SELECT  GJAHR BELNR BUDAT SHKZG DMBTR HKONT ZFBDT FROM BSAD
INTO CORRESPONDING FIELDS OF TABLE G_TAB_BSAD_P
WHERE BUKRS = P_BUKRS        "会社コード
*---MODIFY START PSD T.SAITOH 2002/03/29 子に変更-------------------*
*                        AND KUNNR = G_PARENTAGE    "得意先コード（親）
AND KUNNR = P_KUNNR    "得意先コード（子）
*---MODIFY END   PSD T.SAITOH 2002/03/29 ---------------------------*
AND BLART IN S_BLRTAR      "伝票タイプ売掛金
AND HKONT IN S_URI         "売掛金勘定
*09/03 START
AND BUDAT IN S_ZFBDT.      "転記日と支払基準日
*                        AND ZFBDT IN S_ZFBDT.      "支払基準日
*09/03 END
CASE SY-SUBRC.
WHEN 0.
WHEN 4."対象データなし
*      MESSAGE s600 WITH c_knkk.
*      STOP.
WHEN OTHERS.
MESSAGE A603 WITH SY-REPID C_TBL_010 SY-SUBRC.
ENDCASE.

* 期間別に親会社に振替処理
LOOP AT G_TAB_BSAD_P INTO WA_BSAD.
* 09/03 START
*  WA_BSAD-ZFBDT --> WA_BSAD-BUDAT へ変更
*   前々月の場合
IF    WA_BSAD-BUDAT >= G_ZFBDT1-LOW
AND WA_BSAD-BUDAT <= G_ZFBDT1-HIGH.
G_LIST_19-SIME_1 = G_LIST_19-SIME_1 + WA_BSAD-DMBTR.
ENDIF.
*   前月の場合
IF    WA_BSAD-BUDAT >= G_ZFBDT2-LOW
AND WA_BSAD-BUDAT <= G_ZFBDT2-HIGH.
G_LIST_19-SIME_2 = G_LIST_19-SIME_2 + WA_BSAD-DMBTR.
ENDIF.
*   当月の場合
IF    WA_BSAD-BUDAT >= G_ZFBDT3-LOW
AND WA_BSAD-BUDAT <= G_ZFBDT3-HIGH.
G_LIST_19-SIME_3 = G_LIST_19-SIME_3 + WA_BSAD-DMBTR.
ENDIF.
*   次月の場合
IF    WA_BSAD-BUDAT >= G_ZFBDT4-LOW
AND WA_BSAD-BUDAT <= G_ZFBDT4-HIGH.
* 09/03 END
G_LIST_19-SIME_4 = G_LIST_19-SIME_4 + WA_BSAD-DMBTR.
ENDIF.
ENDLOOP.
ENDFORM.                    " f_parent_bsad
*---APPEND END   PSD T.SAITOH 2002/03/11 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/11 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SY_VLINE_RIGHT
*&---------------------------------------------------------------------*
*       右端の縦線を引く
*----------------------------------------------------------------------*
FORM FRM_SY_VLINE_RIGHT.
WRITE : 120(1) SY-VLINE.
ENDFORM.                    " FRM_SY_VLINE_RIGHT
*&---------------------------------------------------------------------*
*&      Form  FRM_SY_ULINE
*&---------------------------------------------------------------------*
*       下の横線を引く
*----------------------------------------------------------------------*
FORM FRM_SY_ULINE.
WRITE : /1(119) SY-ULINE,
120(1)   SY-VLINE.
ENDFORM.                    " FRM_SY_ULINE
*&---------------------------------------------------------------------*
*&      Form  FRM_SY_VLINE_LEFT
*&---------------------------------------------------------------------*
*       左端の縦線を引く
*----------------------------------------------------------------------*
FORM FRM_SY_VLINE_LEFT.
WRITE : /1(1) SY-VLINE.
ENDFORM.                    " FRM_SY_VLINE_LEFT
*---APPEND END   PSD T.SAITOH 2002/04/11 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  F_LIST_OUT_14.
*&---------------------------------------------------------------------*
*       他入金を再計算する
*----------------------------------------------------------------------*
FORM F_LIST_OUT_14.
*一列目の計算
G_ETC    = 0.
G_ETC_2  = 0.
G_ETC_3  = 0.
G_ETC    = G_LIST_17_SIME_0
+ G_LIST_18_SIME_0
+ G_LIST_09-SIME_1
- G_LIST_15-SIME_1
- G_LIST_17-SIME_1
- G_LIST_18-SIME_1.
G_ETC_2  = G_ETC + G_LIST_15-SIME_1.
G_ETC_3  = ( G_LIST_17-SIME_1 + G_LIST_18-SIME_1 ) * -1.
IF G_ETC <> G_ETC_3.
G_LIST_20-SIME_1 = G_LIST_20-SIME_1 + G_ETC.
G_LIST_15-SIME_1 = G_LIST_15-SIME_1 + G_ETC.
ENDIF.
*二列目の計算
G_ETC    = 0.
G_ETC_2  = 0.
G_ETC_3  = 0.
G_ETC    = G_LIST_17-SIME_1
+ G_LIST_18-SIME_1
+ G_LIST_09-SIME_2
- G_LIST_15-SIME_2
- G_LIST_17-SIME_2
- G_LIST_18-SIME_2.
G_ETC_2  = G_ETC + G_LIST_15-SIME_2.
G_ETC_3  = ( G_LIST_17-SIME_2 + G_LIST_18-SIME_2 ) * -1.
IF G_ETC <> G_ETC_3.
G_LIST_20-SIME_2 = G_LIST_20-SIME_2 + G_ETC.
G_LIST_15-SIME_2 = G_LIST_15-SIME_2 + G_ETC.
ENDIF.
*三列目の計算
G_ETC    = 0.
G_ETC_2  = 0.
G_ETC_3  = 0.
G_ETC    = G_LIST_17-SIME_2
+ G_LIST_18-SIME_2
+ G_LIST_09-SIME_3
- G_LIST_15-SIME_3
- G_LIST_17-SIME_3
- G_LIST_18-SIME_3.
G_ETC_2  = G_ETC + G_LIST_15-SIME_3.
G_ETC_3  = ( G_LIST_17-SIME_3 + G_LIST_18-SIME_3 ) * -1.
IF G_ETC <> G_ETC_3.
G_LIST_20-SIME_3 = G_LIST_20-SIME_3 + G_ETC.
G_LIST_15-SIME_3 = G_LIST_15-SIME_3 + G_ETC.
ENDIF.
*四列目の計算
G_ETC    = 0.
G_ETC_2  = 0.
G_ETC_3  = 0.
G_ETC    = G_LIST_17-SIME_3
+ G_LIST_18-SIME_3
+ G_LIST_09-SIME_4
- G_LIST_15-SIME_4
- G_LIST_17-SIME_4
- G_LIST_18-SIME_4.
G_ETC_2  = G_ETC + G_LIST_15-SIME_4.
G_ETC_3  = ( G_LIST_17-SIME_4 + G_LIST_18-SIME_4 ) * -1.
IF G_ETC <> G_ETC_3.
G_LIST_20-SIME_4 = G_LIST_20-SIME_4 + G_ETC.
G_LIST_15-SIME_4 = G_LIST_15-SIME_4 + G_ETC.
ENDIF.
ENDFORM.
