************************************************************************
* [プログラム名]
*   ZS010900        主要顧客予算達成率表
*
* [処理概要]
*   ・各営業単位の主要顧客と開発グループに対する売上・粗利の管理を行う
* [改定履歴]
*　YYYY/MM/DD  Programar         Description
*  2001/12/14  PSD K.Usami       新規開発
*  2002/05/29  PSD T.SAITOH      帳票修正
*  2002/06/17  PSD T.SAITOH      帳票修正
*  2002/06/20  PSD T.SAITOH      再移送
*  2002/06/27  PSD T.SAITOH      優先度対応
*  2002/06/27  PSD T.SAITOH      リニューアル（構造化/無駄な処理削除)
*  2002/06/27  PSD T.SAITOH      売上予算金額実績／粗利金額実績
*  2002/06/28  PSD T.SAITOH      会計年度（変換）追加ロジック用
*  2004/02/13  DMC R.Hata        前年度比計算時のZeroDivide修正
*  2004/10/13  DMC MURATA        ﾊﾞｰｼﾞｮﾝを選択画面に追加
*  2004/10/14  DMC MURATA        優先順位のﾊﾞｲﾄ数変更(ZSB003との整合)
************************************************************************
report  zs010900 no standard page heading
line-size  80
line-count 65.
************************************************************************
* TYPES
************************************************************************
* 顧客実績(当年度)型
types: begin of typ_tkokaku,
*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
year(4)     type n,              " 年
priority(2) type c,              " 優先度
*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*
vkbur      type s901-vkbur,      " 営業所
vkgrp      type s901-vkgrp,      " 営業グループ
pkunag      type s901-pkunag,    " 受注先コード
spmon      type s901-spmon,      " 分析月
netwr      type s901-netwr,      " 正味額
zzaraigaku type s901-zzaraigaku, " 粗利金額
end   of typ_tkokaku.

* 顧客実績(前年度)
types: begin of typ_zkokaku,
*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
year(4)     type n,              " 年
priority(2) type c,              " 優先度
*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*
vkbur      type s901-vkbur,      " 営業所
vkgrp      type s901-vkgrp,      " 営業グループ
pkunag      type s901-pkunag,      " 受注先コード
spmon      type s901-spmon,      " 分析月
netwr      type s901-netwr,      " 正味額
end   of typ_zkokaku.

* 顧客計画(当年度)型
types: begin of typ_kokeikaku,
*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
year(4)     type n,              " 年
priority(2) type c,              " 優先度
*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*
vkbur      type s901-vkbur,      " 営業所
vkgrp      type s901-vkgrp,      " 営業グループ
pkunag      type s901-pkunag,      " 受注先コード
spmon      type s901-spmon,      " 分析月
netwr      type s901-netwr,      " 正味額
end   of typ_kokeikaku.
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
** 開発実績(当年度)型
*TYPES: BEGIN OF TYP_TKAIHATU,
*         VKBUR      TYPE S901-VKBUR,      " 営業所
*         VKGRP      TYPE S901-VKGRP,      " 営業グループ
*         MVGR4      TYPE S904-MVGR4,      " 開発販売実績
*         SPMON      TYPE S901-SPMON,      " 分析月
*         NETWR      TYPE S901-NETWR,      " 正味額
*         ZZARAIGAKU TYPE S901-ZZARAIGAKU, " 粗利金額
*        END   OF TYP_TKAIHATU.
*
** 開発実績(前年度)型
*TYPES: BEGIN OF TYP_ZKAIHATU,
*         VKBUR      TYPE S901-VKBUR,      " 営業所
*         VKGRP      TYPE S901-VKGRP,      " 営業グループ
*         MVGR4      TYPE S904-MVGR4,      " 開発販売実績
*         SPMON      TYPE S901-SPMON,      " 分析月
*         NETWR      TYPE S901-NETWR,      " 正味額
*        END   OF TYP_ZKAIHATU.
*
** 開発計画(当年度)型
*TYPES: BEGIN OF TYP_KAIKEIKAKU,
*         VKBUR      TYPE S901-VKBUR,      " 営業所
*         VKGRP      TYPE S901-VKGRP,      " 営業グループ
*         MVGR4      TYPE S904-MVGR4,      " 開発販売実績
*         SPMON      TYPE S901-SPMON,      " 分析月
*         NETWR      TYPE S901-NETWR,      " 正味額
*
*        END   OF TYP_KAIKEIKAKU.
*
** 開発グループ型
*TYPES: BEGIN OF TYP_KAIGRP,
*         MVGR4      TYPE TVM4T-MVGR4,      " 開発販売実績
*         BEZEI      TYPE TVM4T-BEZEI,      " テキスト
*        END   OF TYP_KAIGRP.
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*


* 営業所型
types: begin of typ_eigyousyo,
vkbur     type tvkbt-vkbur,    " 営業所
bezei     type tvkbt-bezei,    " テキスト
end   of typ_eigyousyo.

* 営業グループ型
types: begin of typ_eigyougp,
vkgrp     type tvgrt-vkgrp,     " 営業所
bezei     type tvgrt-bezei,     " テキスト
end   of typ_eigyougp.

* 帳票出力型
types: begin of typ_write,
*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
year(4)        type n,               " 年
priority(2)    type c,               " 優先度
*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*
vkbur          type tvkbt-vkbur,     " 営業所コード
bezei          type tvkbt-bezei,     " 営業所名
vkgrp          type tvgrt-vkgrp,     " 営業グループコード
gbezei         type tvgrt-bezei,     " 営業グループ名
kflg(1)        type c,               " 顧客・開発フラグ
kunnr          type kna1-kunnr,      " 得意先・開発グループ
name1(40)      type c,               " 得意先・開発Grp名
rflg(1)        type c,               " 当月・累計フラグ
urijiseki(12)  type p,    " 売上実績
arariritu      type p decimals 1,    " 粗利率
konkiyosannhi  type p decimals 1,    " 今期予算比
zenendougetuhi type p decimals 1,    " 前年同月比
*---APPEND START PSD T.SAITOH 2002/06/27 ---------------------------*
budget_sum(12) type p,               " 予算金額／粗利金額
*---APPEND END   PSD T.SAITOH 2002/06/27 ---------------------------*
end   of typ_write.

***********************************************************************
* DATA
***********************************************************************
constants: cns_j type c value 'J',
cns_x type c value 'X'.
* 使用バージョン
data: yosanv like s901-vrsio,
kaihatuv like s904-vrsio.

* 顧客実績(当年度)内部テーブル
data: gf_tkokaku    type          typ_tkokaku,
gt_tkokaku    like table of gf_tkokaku.

* 顧客実績(前年度)内部テーブル
data: gf_zkokaku    type          typ_zkokaku,
gt_zkokaku    like table of gf_zkokaku.

* 顧客計画(当年度)内部テーブル
data: gf_kokeikaku   type          typ_kokeikaku,
gt_kokeikaku   like table of gf_kokeikaku.
data:tmp_kokeikaku like gf_kokeikaku.

*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
** 開発実績(当年度)内部テーブル
*DATA: GF_TKAIHATU    TYPE          TYP_TKAIHATU,
*      GT_TKAIHATU    LIKE TABLE OF GF_TKAIHATU.
*
** 開発実績(前年度)内部テーブル
*DATA: GF_ZKAIHATU    TYPE          TYP_ZKAIHATU,
*      GT_ZKAIHATU    LIKE TABLE OF GF_ZKAIHATU.
*
** 開発計画(当年度)内部テーブル
*DATA: GF_KAIKEIKAKU    TYPE          TYP_KAIKEIKAKU,
*      GT_KAIKEIKAKU    LIKE TABLE OF GF_KAIKEIKAKU.
*DATA:TMP_KAIKEIKAKU LIKE GF_KAIKEIKAKU.
*
** 開発グループ内部テーブル
*DATA: GF_KAIGRP    TYPE          TYP_KAIGRP,
*      GT_KAIGRP    LIKE TABLE OF GF_KAIGRP.
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*

* 営業所内部テーブル
data: gf_eigyousyo type typ_eigyousyo,
gt_eigyousyo  like table of gf_eigyousyo.

* 営業グループ内部テーブル
data: gf_eigyougp   type          typ_eigyougp,
gt_eigyougp   like table of gf_eigyougp.

* 帳票出力用内部テーブル
data: gf_write    type          typ_write,
gf_rwrite    type          typ_write,
gt_write    like table of gf_write.

* 処理期間指定用
data: t_syori(6) type c,  " 期初月
zt_syori(6) type c, " 期初月－１年
zp_syori(6) type c. " 画面入力された年月日－１年
* 合計用
data: ararikei like gf_tkokaku-zzaraigaku,
syoumikei like gf_tkokaku-netwr,
arariruikei like gf_tkokaku-zzaraigaku,
syoumiruikei like gf_tkokaku-netwr,
zsyoumikei like gf_tkokaku-netwr,
zsyoumiruikei like gf_tkokaku-netwr.
* 当月売上予算/累計売上予算
data: uriyosan(12)  type p decimals 2,
ruriyosan(12)  type p decimals 2,
kuriyosan(12)  type p decimals 2,
kruriyosan(12)  type p decimals 2.
* 営業コード範囲指定用
data: zp_eigyou like gf_eigyousyo-vkbur.

* 帳票出力用
data: tmp_write like gf_write,
cnt type i,
ko_cnt type i,
kai_cnt type i.

data:kaihatugrp like gf_write-kunnr.

*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
* 優先度対応（優先度情報）
types: begin of typ_tvarv_one_field,
low type tvarv-low,            " 固定長データ
end of typ_tvarv_one_field.

data:gt_tvarv_one_field type table of typ_tvarv_one_field,
gf_tvarv_one_field type typ_tvarv_one_field.

* 優先度情報を区分けし処理しやすくする
types: begin of typ_priority,
year(4)     type n,              " 年度
vkbur       type tvkbt-vkbur,    " 営業所コード
pkunag      type s901-pkunag,    " 得意先コード
priority(2) type c,              " 優先度
end of typ_priority.

data:gt_priority type table of typ_priority,
gf_priority type typ_priority.

* 変数名称（優先度情報）
data:g_priority_name type tvarv-name. " 優先度キー名称

*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*

***********************************************************************
* 選択画面定義
***********************************************************************
selection-screen begin of line.

selection-screen comment (33) text-024." 累積データ

parameters : r_nenkan radiobutton group rrad default 'X'." 年間
selection-screen comment 61(4) text-025
for field r_nenkan.

parameters :r_kikan radiobutton group rrad.
selection-screen comment 67(6) text-026
for field r_kikan." 期間

selection-screen end of line.

selection-screen begin of line.

selection-screen comment (33) text-001." 機能

parameters : r_zensya radiobutton group krad default 'X'." 全社
selection-screen comment 61(4) text-002
for field r_zensya.

parameters :r_eigyou radiobutton group krad.
selection-screen comment 67(6) text-003
for field r_eigyou." 営業所

selection-screen end of line.

* ↓DELETE 2002/01/15 PSD M.Arai 処理年月表示形式変更
*PARAMETERS: p_SYORI(6) TYPE c DEFAULT SY-DATUM+0(6),
* ↑
* ↓APPEND 2002/01/15 PSD M.Arai 処理年月表示形式変更
parameters: p_syori type typ_tkokaku-spmon default sy-datum+0(6),
* ↑APPEND 2
" 処理年月
p_eigyou like gf_eigyousyo-vkbur.        " 営業所
* 2004/10/13 ADD>>
parameters: p_vrsio  like s901-vrsio obligatory.     "ﾊﾞｰｼﾞｮﾝ
* 2004/10/13 ADD<<

************************************************************************
* AT SELECTION-SCREEN
************************************************************************
at selection-screen.
* 入力後処理
* ①ラジオボタン：営業所選択時
if r_eigyou = cns_x and p_eigyou = ' '.
message e006(z1) with text-003.
endif.
* ②処理年月
if p_syori = ' '.
message e006(z1) with text-019.
endif.
* ③期初月設定
* a) 年間選択時
if r_nenkan = cns_x.
if p_syori+4(2) >= '04' and p_syori+4(2) =< '12'.
t_syori+0(4) = p_syori+0(4).
t_syori+4(2) = '04'.
elseif p_syori+4(2) >= '01' and p_syori+4(2) =< '03'.
t_syori+0(4) = p_syori+0(4) - 1.
t_syori+4(2) = '04'.
endif.
* b) 期間選択時
elseif r_kikan = cns_x.
if p_syori+4(2) >= '04' and p_syori+4(2) =< '09'.
t_syori+0(4) = p_syori+0(4).
t_syori+4(2) = '04'.
elseif p_syori+4(2) >= '10' and p_syori+4(2) =< '12'.
t_syori+0(4) = p_syori+0(4).
t_syori+4(2) = '10'.
elseif p_syori+4(2) >= '01' and p_syori+4(2) =< '03'.
t_syori+0(4) = p_syori+0(4) - 1.
t_syori+4(2) = '10'.
endif.
endif.
* ---期初月－１年設定
zp_syori = p_syori.
zp_syori+0(4) = p_syori+0(4) - 1.
* ---画面入力された年月日－１年設定
zt_syori = t_syori.
zt_syori+0(4) = t_syori+0(4) - 1.

* 2004/10/13 mod>>  選択画面のﾊﾞｰｼﾞｮﾝをｾｯﾄ(ﾊﾞｰｼﾞｮﾝ'002'に対応)
* ④予算使用バージョン
yosanv = p_vrsio.
*  yosanv = '001'.
* 2004/10/13 mod<<

* ⑤開発使用バージョン
kaihatuv = '001'.
***********************************************************************
* START-OF-SELECTION
***********************************************************************
start-of-selection.
* 対象データ抽出処理
perform frm_get_data.
* 帳票出力用内部テーブル作成処理
perform frm_make_data.
* 帳票出力処理
perform frm_write_data.
************************************************************************
** Form
************************************************************************
*&---------------------------------------------------------------------
*&      Form  frm_get_data
*&---------------------------------------------------------------------
*       対象データ抽出処理
*----------------------------------------------------------------------
form frm_get_data.

* 営業所内部TBL設定処理
perform frm_set_eigyousyo.
* 営業グループ内部TBL設定処理
perform frm_set_eigyougp.
* 開発グループ内部TBL設定処理
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*  PERFORM FRM_SET_KAIGRP.
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
* 得意先優先度情報：内部TBL設定処理
perform frm_set_priority_from_tvarv.
*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*

* 顧客実績情報取得処理
*---a)顧客実績(当年度)内部TBL設定処理
perform frm_set_tkokaku.
*---b)ソート処理
perform frm_tkosort.
*---b)顧客実績(前年度)内部TBL設定処理
perform frm_set_zkokaku.
*---b)ソート処理
perform frm_zkosort.
* 顧客計画情報取得処理
*---a)顧客計画(当年度)内部TBL設定処理
perform frm_set_kokeikaku.
*---b)ソート処理
perform frm_kosort.

*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
* 開発実績情報取得処理
*---a)開発実績(当年度)内部TBL設定処理
*  PERFORM FRM_SET_TKAIHATU.
*---b)ソート処理
*  PERFORM FRM_TKAISORT.
*---b)開発実績(前年度)内部TBL設定処理
*  PERFORM FRM_SET_ZKAIHATU.
*---b)ソート処理
*  PERFORM FRM_ZKAISORT.
* 開発計画情報取得処理
*---a)開発計画(当年度)内部TBL設定処理
*  PERFORM FRM_SET_KAIKEIKAKU.
*---b)ソート処理
*  PERFORM FRM_KAISORT.
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*

* 対象データ取得エラー処理
*---MODIFY START PSD T.SAITOH 2002/06/27 ---------------------------*
*  IF GT_KOKEIKAKU IS INITIAL AND GT_KAIKEIKAKU IS INITIAL .
if gt_kokeikaku is initial.
*---MODIFY END   PSD T.SAITOH 2002/06/27 ---------------------------*
message s600(z1) with text-013." 予算達成率情報
stop.
endif.
endform.                    " frm_get_data
*&---------------------------------------------------------------------
*&      Form  frm_set_eigyousyo
*&---------------------------------------------------------------------
*       営業所内部TBL設定処理
*----------------------------------------------------------------------
form frm_set_eigyousyo.
*営業所コード/テキスト
if r_zensya = cns_x.
select
vkbur bezei
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*      INTO TABLE GT_EIGYOUSYO
into corresponding fields of table gt_eigyousyo
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from tvkbt
where spras = cns_j.
elseif r_eigyou = cns_x.
select
vkbur bezei
into table gt_eigyousyo
from tvkbt
where spras = cns_j
and   vkbur = p_eigyou.
endif.
* エラー処理
case sy-subrc.
when 0.
when 4.    " 対象データなし
message s600(z1) with text-003." 営業所
stop.
when 8.    " システムエラー
message a603(z1) with 'ZS010900' text-003 '8'.
endcase.

endform.                    " frm_set_eigyousyo
*&---------------------------------------------------------------------
*&      Form  frm_set_eigyougp
*&---------------------------------------------------------------------
*       営業グループ内部TBL設定処理
*----------------------------------------------------------------------
form frm_set_eigyougp.
*営業グループ/テキスト
select
vkgrp bezei
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*    INTO TABLE GT_EIGYOUGP
into corresponding fields of table gt_eigyougp
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from tvgrt
where spras = cns_j.

* エラー処理
case sy-subrc.
when 0.
when 4.    " 対象データなし
when 8.    " システムエラー
message a603(z1) with 'ZS010900' text-005 '8'.
endcase.

endform.                    " frm_set_eigyougp
*&---------------------------------------------------------------------
*&      Form  frm_set_kaigrp
*&---------------------------------------------------------------------
*       開発グループ内部TBL設定処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_SET_KAIGRP.
**開発販売実績/テキスト
*  SELECT
*    MVGR4 BEZEI
**---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
**    INTO TABLE GT_KAIGRP
*    INTO CORRESPONDING FIELDS OF TABLE GT_KAIGRP
**---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
*    FROM TVM4T
*    WHERE SPRAS = CNS_J.
*
**エラー処理
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.    " 対象データなし
*    WHEN 8.    " システムエラー
*      MESSAGE A603(Z1) WITH 'ZS010400' TEXT-006 '8'.
*  ENDCASE.
*
*ENDFORM.                    " frm_set_kaigrp
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_set_tkokaku
*&---------------------------------------------------------------------
*        顧客実績(当年度)内部TBL設定処理
*----------------------------------------------------------------------
form frm_set_tkokaku.
*営業所/営業グループ/受注先ｺｰﾄﾞ/分析月/正味額/粗利金額
if r_zensya = cns_x.
select
vkbur vkgrp pkunag spmon netwr zzaraigaku
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*      INTO TABLE GT_TKOKAKU
into corresponding fields of table gt_tkokaku
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from s901
where vkorg = '1000'
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vrsio = '000'.
elseif r_eigyou = cns_x.
select
vkbur vkgrp pkunag spmon netwr zzaraigaku
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*        INTO TABLE GT_TKOKAKU
into corresponding fields of table gt_tkokaku
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from s901
where vkorg = '1000'
and   vkbur = p_eigyou
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vrsio = '000'.
endif.

* エラー処理
case sy-subrc.
when 0.
when 4.
when 8.    " システムエラー
message a603(z1) with 'ZS010900' text-007 '8'." 当年度顧客実績
endcase.

endform.                    " frm_set_tkokaku
*&---------------------------------------------------------------------
*&      Form  frm_set_zkokaku
*&---------------------------------------------------------------------
*        顧客実績(前年度)内部TBL設定処理
*----------------------------------------------------------------------
form frm_set_zkokaku.

*営業所/営業グループ/受注先ｺｰﾄﾞ/分析月/正味額
if r_zensya = cns_x.
select
vkbur vkgrp pkunag spmon netwr
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*      INTO TABLE GT_ZKOKAKU
into corresponding fields of table gt_zkokaku
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from s901
where vkorg = '1000'
and   spmon  >= zt_syori+0(6)
and   spmon  <= zp_syori+0(6)
and   vrsio = '000'.
elseif r_eigyou = cns_x.
select
vkbur vkgrp pkunag spmon netwr
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*        INTO TABLE GT_ZKOKAKU
into corresponding fields of table gt_zkokaku
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from s901
where vkorg = '1000'
and   vkbur = p_eigyou
and   spmon  >= zt_syori+0(6)
and   spmon  <= zp_syori+0(6)
and   vrsio = '000'.
endif.

* エラー処理
case sy-subrc.
when 0.
when 4.    " 対象データなし
when 8.    " システムエラー
message a603(z1) with 'ZS010400' text-008 '8'." 前年度顧客実績
endcase.

endform.                    " frm_set_zkokaku
*&---------------------------------------------------------------------
*&      Form  frm_set_kokeikaku
*&---------------------------------------------------------------------
*        顧客計画(当年度)内部TBL設定処理
*----------------------------------------------------------------------
form frm_set_kokeikaku.

*営業所/営業グループ/受注先ｺｰﾄﾞ/分析月/正味額
if r_zensya = cns_x.
select
vkbur vkgrp pkunag spmon netwr
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*      INTO TABLE GT_KOKEIKAKU
into corresponding fields of table gt_kokeikaku
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from s901
where vkorg = '1000'
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vrsio = yosanv.                   "2004/10/13 変数に変更
elseif r_eigyou = cns_x.
select
vkbur vkgrp pkunag spmon netwr
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*        INTO TABLE GT_KOKEIKAKU
into corresponding fields of table gt_kokeikaku
*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
from s901
where vkorg = '1000'
and   vkbur = p_eigyou
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vrsio = yosanv.                  "2004/10/13 変数に変更
endif.
* エラー処理
case sy-subrc.
when 0.
when 4.    " 対象データなし
when 8.    " システムエラー
message a603(z1) with 'ZS010400' text-023 '8'." 当年度顧客計画
endcase.

endform.                    " frm_set_kokeikaku
*&---------------------------------------------------------------------
*&      Form  frm_tkosort
*&---------------------------------------------------------------------
*       ソート処理
*----------------------------------------------------------------------
form frm_tkosort.

if r_zensya = cns_x.
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*    SORT GT_TKOKAKU ASCENDING BY VKBUR    " 営業所
*                                   PKUNAG   " 受注先コード
*                                   SPMON.   " 分析月

* ここに優先度をセットする処理を記述
perform frm_priority_set_tkokaku tables gt_tkokaku.
sort gt_tkokaku ascending by year     " 年度
vkbur    " 営業所
priority " 優先度
pkunag   " 受注先コード
spmon.   " 分析月

*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
elseif r_eigyou = cns_x.
sort gt_tkokaku ascending by vkgrp    " 営業グループ
pkunag   " 受注先コード
spmon.   " 分析月
endif.

endform.                    " frm_tkosort
*&---------------------------------------------------------------------
*&      Form  frm_zkosort
*&---------------------------------------------------------------------
*       ソート処理
*----------------------------------------------------------------------
form frm_zkosort.

if r_zensya = cns_x.
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*    SORT GT_ZKOKAKU ASCENDING BY VKBUR    " 営業所
*                                   PKUNAG   " 受注先コード
*                                   SPMON.   " 分析月

* ここに優先度をセットする処理を記述
perform frm_priority_set_zkokaku tables gt_zkokaku.
sort gt_zkokaku ascending by   year     " 年度
vkbur    " 営業所
priority " 優先度
pkunag   " 受注先コード
spmon.   " 分析月

*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
elseif r_eigyou = cns_x.
sort gt_zkokaku ascending by vkgrp    " 営業グループ
pkunag   " 受注先コード
spmon.   " 分析月
endif.

endform.                    " frm_zkosort

*&---------------------------------------------------------------------
*&      Form  frm_kosort
*&---------------------------------------------------------------------
*       ソート処理
*----------------------------------------------------------------------
form frm_kosort.

if r_zensya = cns_x.
*---MODIFY START PSD T.SAITOH 2002/06/26 ---------------------------*
*    SORT GT_KOKEIKAKU ASCENDING BY VKBUR    " 営業所
*                                   PKUNAG   " 受注先コード
*                                   SPMON.   " 分析月
* ここに優先度をセットする処理を記述
perform frm_priority_set_kokeikaku tables gt_kokeikaku.
sort gt_kokeikaku ascending by year     " 年度
vkbur    " 営業所
priority " 優先度
pkunag   " 受注先コード
spmon.   " 分析月

*---MODIFY END   PSD T.SAITOH 2002/06/26 ---------------------------*
elseif r_eigyou = cns_x.
sort gt_kokeikaku ascending by vkgrp    " 営業グループ
pkunag   " 受注先コード
spmon.   " 分析月
endif.

endform.                    " frm_kosort
*&---------------------------------------------------------------------
*        開発実績(当年度)内部TBL設定処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_SET_TKAIHATU.
**営業所/営業グループ/開発グループ販売実績/分析月/正味額/粗利金額
*  IF R_ZENSYA = CNS_X.
*    SELECT
*      VKBUR VKGRP MVGR4 SPMON NETWR ZZARAIGAKU
*      INTO TABLE GT_TKAIHATU
*      FROM S904
*      WHERE VKORG = '1000'
*      AND   SPMON  >= T_SYORI+0(6)
*      AND   SPMON  <= P_SYORI+0(6)
*      AND   VRSIO = '000'.
*  ELSEIF R_EIGYOU = CNS_X.
*    SELECT
*        VKBUR VKGRP MVGR4 SPMON NETWR ZZARAIGAKU
*        INTO TABLE  GT_TKAIHATU
*        FROM S904
*        WHERE VKORG = '1000'
*        AND   VKBUR = P_EIGYOU
*        AND   SPMON  >= T_SYORI+0(6)
*        AND   SPMON  <= P_SYORI+0(6)
*        AND   VRSIO = '000'.
*  ENDIF.
** エラー処理
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.    " 対象データなし
*    WHEN 8.    " システムエラー
*      MESSAGE A603(Z1) WITH 'ZS010400' TEXT-010 '8'." 当年度開発実績
*  ENDCASE.
*
*ENDFORM.                    " frm_set_tkaihatu
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_set_zkaihatu
*&---------------------------------------------------------------------
*        開発実績(前年度)内部TBL設定処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_SET_ZKAIHATU.
**営業所/営業グループ/開発グループ販売実績/分析月/正味額
*  IF R_ZENSYA = CNS_X.
*    SELECT
*      VKBUR VKGRP MVGR4 SPMON NETWR
*       INTO TABLE GT_ZKAIHATU
*      FROM S904
*      WHERE VKORG = '1000'
*      AND   SPMON  >= ZT_SYORI+0(6)
*      AND   SPMON  <= ZP_SYORI+0(6)
*      AND   VRSIO = '000'.
*  ELSEIF R_EIGYOU = CNS_X.
*    SELECT
*        VKBUR VKGRP MVGR4 SPMON NETWR
*        INTO TABLE GT_ZKAIHATU
*        FROM S904
*        WHERE VKORG = '1000'
*        AND   VKBUR = P_EIGYOU
*        AND   SPMON  >= ZT_SYORI+0(6)
*        AND   SPMON  <= ZP_SYORI+0(6)
*        AND   VRSIO = '000'.
*  ENDIF.
** エラー処理
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.    " 対象データなし
*    WHEN 8.    " システムエラー
*      MESSAGE A603(Z1) WITH 'ZS010400' TEXT-011 '8'." 前年度開発実績
*  ENDCASE.
*
*ENDFORM.                    " frm_set_zkaihatu
*&---------------------------------------------------------------------
*&      Form  frm_set_kaikeikaku
*&---------------------------------------------------------------------
*        開発計画(当年度)内部TBL設定処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_SET_KAIKEIKAKU.
*
**営業所/営業グループ/開発グループ販売実績/分析月/正味額
*  IF R_ZENSYA = CNS_X.
*    SELECT
*      VKBUR VKGRP MVGR4 SPMON NETWR
*      INTO TABLE GT_KAIKEIKAKU
*      FROM S904
*      WHERE VKORG = '1000'
*      AND   SPMON  >= T_SYORI+0(6)
*      AND   SPMON  <= P_SYORI+0(6)
*      AND   VRSIO = KAIHATUV.
*  ELSEIF R_EIGYOU = CNS_X.
*    SELECT
*        VKBUR VKGRP MVGR4 SPMON NETWR
*        INTO TABLE GT_KAIKEIKAKU
*        FROM S904
*        WHERE VKORG = '1000'
*        AND   VKBUR = P_EIGYOU
*        AND   SPMON  >= T_SYORI+0(6)
*        AND   SPMON  <= P_SYORI+0(6)
*        AND   VRSIO = KAIHATUV.
*  ENDIF.
** エラー処理
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.    " 対象データなし
*    WHEN 8.    " システムエラー
*      MESSAGE A603(Z1) WITH 'ZS010400' TEXT-012 '8'." 当年度開発計画
*  ENDCASE.
**
*ENDFORM.                    " frm_set_kaikeikaku
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_tkaisort
*&---------------------------------------------------------------------
*       ソート処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_TKAISORT.
*
*  IF R_ZENSYA = CNS_X.
*    SORT GT_TKAIHATU ASCENDING BY VKBUR    " 営業所
*                                    MVGR4    " 開発販売実績
*                                    SPMON.   " 分析月
*  ELSEIF R_EIGYOU = CNS_X.
*    SORT GT_TKAIHATU ASCENDING BY VKGRP    " 営業ｸﾞﾙｰﾌﾟ
*                                    MVGR4    " 開発販売実績
*                                    SPMON.   " 分析月
*  ENDIF.
*
*ENDFORM.                    " frm_tkaisort
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_zkaisort
*&---------------------------------------------------------------------
*       ソート処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_ZKAISORT.
*  IF R_ZENSYA = CNS_X.
*    SORT GT_ZKAIHATU ASCENDING BY VKBUR    " 営業所
*                                    MVGR4    " 開発販売実績
*                                    SPMON.   " 分析月
*  ELSEIF R_EIGYOU = CNS_X.
*    SORT GT_ZKAIHATU ASCENDING BY VKGRP    " 営業ｸﾞﾙｰﾌﾟ
*                                    MVGR4    " 開発販売実績
*                                    SPMON.   " 分析月
*  ENDIF.
*
*ENDFORM.                    " frm_zkaisort
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_kaisort
*&---------------------------------------------------------------------
*       ソート処理
*----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_KAISORT.
*  IF R_ZENSYA = CNS_X.
*    SORT GT_KAIKEIKAKU ASCENDING BY VKBUR    " 営業所
*                                    MVGR4    " 開発販売実績
*                                    SPMON.   " 分析月
*  ELSEIF R_EIGYOU = CNS_X.
*    SORT GT_KAIKEIKAKU ASCENDING BY VKGRP    " 営業ｸﾞﾙｰﾌﾟ
*                                    MVGR4    " 開発販売実績
*                                    SPMON.   " 分析月
*  ENDIF.
*ENDFORM.                    " frm_kaisort
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_make_data
*&---------------------------------------------------------------------
*       帳票出力用内部テーブル作成処理
*----------------------------------------------------------------------
form frm_make_data.

* ① 帳票出力用内部テーブル作成処理
if gt_kokeikaku is initial.
else.
* 請求伝票内部TBLループ処理
loop at gt_kokeikaku into gf_kokeikaku.

* 全社選択時:営業所/受注先コードがブレイクした場合
if sy-tabix > 1.
if ( r_zensya = cns_x )
and ( tmp_kokeikaku-vkbur <> gf_kokeikaku-vkbur )
or ( tmp_kokeikaku-pkunag <> gf_kokeikaku-pkunag ).
* (a) 設定項目の帳票出力用内部TBLへの追加処理
perform frm_kokoumoku.
* 営業所選択時:営業所グループ/受注先コードがブレイクした場合
elseif ( r_eigyou = cns_x )
and ( tmp_kokeikaku-vkgrp <> gf_kokeikaku-vkgrp )
or ( tmp_kokeikaku-pkunag <> gf_kokeikaku-pkunag )
and ( sy-tabix > 1 ).
* (a) 設定項目の帳票出力用内部TBLへの追加処理
perform frm_kokoumoku.
endif.
endif.
* (b) 当月売上予算設定処理
if gf_kokeikaku-spmon = p_syori.
uriyosan = uriyosan + gf_kokeikaku-netwr.
endif.
* (c) 累計売上予算設定処理
ruriyosan = ruriyosan + gf_kokeikaku-netwr.
*      ENDIF.

tmp_kokeikaku = gf_kokeikaku.
endloop.
endif.
perform frm_kokoumoku.

*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
** ② 帳票出力用内部テーブル作成処理
*  IF GT_KAIKEIKAKU IS INITIAL.
*  ELSE.
* 請求伝票内部TBLループ処理
*    LOOP AT GT_KAIKEIKAKU INTO GF_KAIKEIKAKU.
*
** 全社選択時:営業所/開発販売実績の先頭1バイトがブレイクした場合
*      IF SY-TABIX > 1.
*        IF ( R_ZENSYA = CNS_X )
*            AND ( TMP_KAIKEIKAKU-VKBUR <> GF_KAIKEIKAKU-VKBUR )
*           OR ( TMP_KAIKEIKAKU-MVGR4+0(1) <> GF_KAIKEIKAKU-MVGR4+0(1) )
.
** (a) 設定項目の帳票出力用内部TBLへの追加処理
*          PERFORM FRM_KAIKOUMOKU.
*
** 営業所選択時:営業ｸﾞﾙｰﾌﾟ/開発販売実績の先頭1バイトがブレイクした場合
*        ELSEIF ( R_EIGYOU = CNS_X )
*            AND ( TMP_KAIKEIKAKU-VKGRP <> GF_KAIKEIKAKU-VKGRP )
*          OR ( TMP_KAIKEIKAKU-MVGR4+0(1)  <> GF_KAIKEIKAKU-MVGR4+0(1) )
*            AND ( SY-TABIX > 1 ).
*
** (a) 設定項目の帳票出力用内部TBLへの追加処理
*          PERFORM FRM_KAIKOUMOKU.
*        ENDIF.
*      ENDIF.
** (b) 当月売上予算設定処理
*      IF GF_KAIKEIKAKU-SPMON = P_SYORI.
*        KURIYOSAN = KURIYOSAN + GF_KAIKEIKAKU-NETWR.
*      ENDIF.
** (c) 累計売上予算設定処理
*      KRURIYOSAN = KRURIYOSAN + GF_KAIKEIKAKU-NETWR.
**      ENDIF.
*
*      TMP_KAIKEIKAKU = GF_KAIKEIKAKU.
*    ENDLOOP.
*  ENDIF.
*
*  IF GT_KAIKEIKAKU IS INITIAL.
*  ELSE.
*    PERFORM FRM_KAIKOUMOKU.
*  ENDIF.
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*

endform.                    " frm_make_data
*&---------------------------------------------------------------------
*&      Form  frm_kokoumoku
*&---------------------------------------------------------------------
*       設定項目の帳票出力用内部TBLへの追加処理
*----------------------------------------------------------------------
form frm_kokoumoku.

* ｱ) 売上実績（当月）の設定
perform frm_selling_results_main_m.
* ｲ) 売上実績（累計）の設定
perform frm_selling_results_main_all.
* ⅲ）集計済みレコード削除処理
perform frm_delete_computed_record.

* ｳ) 当月粗利率の設定
if syoumikei = 0.
gf_write-arariritu = 0.
else.
gf_write-arariritu = ararikei / syoumikei * 100.
endif.

* ｴ) 累計粗利率の設定
if syoumiruikei = 0.
gf_rwrite-arariritu = 0.
else.
gf_rwrite-arariritu = arariruikei / syoumiruikei * 100.
endif.
* ｵ）今期同月予算比の設定
if uriyosan = 0.
gf_write-konkiyosannhi = 0.
else.
gf_write-konkiyosannhi = syoumikei / uriyosan * 100.
endif.

* ｶ）今期累計予算比の設定
if ruriyosan = 0.
gf_rwrite-konkiyosannhi = 0.
else.
gf_rwrite-konkiyosannhi = syoumiruikei / ruriyosan * 100.
endif.
* ｷ）前年同月比の設定
perform frm_same_month_last_year.

* ｸ) 前年同期比の設定
perform frm_same_period_last_year.


* ｹ) 帳票出力内部TBLレコード追加処理
* ⅰ）当月・累計フラグ、顧客・開発フラグの設定
gf_write-kflg = '1'.
gf_rwrite-kflg = '1'.
gf_write-rflg = '1'.
gf_rwrite-rflg = '2'.
* ⅱ）営業所名の設定
perform frm_vkbur.

* ⅲ) 営業ｸﾞﾙｰﾌﾟの設定
perform frm_vkgrp.
* ⅳ) 得意先名の設定
perform frm_pkunag.

*---APPEND START PSD T.SAITOH 2002/06/27 ---------------------------*
*   売上予算金額／粗利金額の設定
perform frm_sell_budget_from_s901
using gf_write-budget_sum
gf_rwrite-budget_sum.
*---APPEND END   PSD T.SAITOH 2002/06/27 ---------------------------*

* 年度と優先度の設定
gf_write-year       = tmp_kokeikaku-year.
gf_write-priority   = tmp_kokeikaku-priority.
gf_rwrite-year      = tmp_kokeikaku-year.
gf_rwrite-priority  = tmp_kokeikaku-priority.

* ⅴ) レコード追加
tmp_kokeikaku = gf_kokeikaku.
append gf_write to gt_write.
append gf_rwrite to gt_write.

* 各変数の初期化
syoumikei = 0.
zsyoumikei = 0.
ararikei = 0.
syoumiruikei = 0.
zsyoumiruikei = 0.
arariruikei = 0.
uriyosan = 0.
ruriyosan = 0.
clear gf_tkokaku.
clear gf_write.
clear gf_rwrite.

endform.                    " frm_kokoumoku
**&---------------------------------------------------------------------
**&      Form  frm_kaikoumoku
**&---------------------------------------------------------------------
**       設定項目の帳票出力用内部TBLへの追加処理
**----------------------------------------------------------------------
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM FRM_KAIKOUMOKU.

* 履歴削除

*ENDFORM.                    " frm_kaikoumoku
**---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------
*&      Form  frm_write_data
*&---------------------------------------------------------------------
*       帳票出力処理
*----------------------------------------------------------------------
form frm_write_data.

* ①ソート
if r_zensya = cns_x.
*---APPEND START PSD T.SAITOH 2002/06/26 ---------------------------*
*    SORT GT_WRITE ASCENDING BY VKBUR    " 営業所
*                               KFLG    " 顧客・開発フラグ
*                               KUNNR    " 得意先・開発グループ
*                               RFLG.  " 当月・累計フラグ
sort gt_write ascending by year     " 年度
vkbur    " 営業所
priority " 優先度
kflg     " 顧客・開発フラグ
kunnr    " 得意先・開発グループ
rflg.    " 当月・累計フラグ
*---APPEND END   PSD T.SAITOH 2002/06/26 ---------------------------*
elseif r_eigyou = cns_x.
sort gt_write ascending by vkgrp    " 営業グループ
kflg     " 顧客・開発フラグ
kunnr     " 得意先・開発グループ
rflg.   " 当月・累計フラグ
endif.

* ②帳票出力
loop at gt_write into gf_write.
* a) 改ページ
if sy-tabix > 1.
if r_zensya = cns_x.
if tmp_write-vkbur <> gf_write-vkbur.
perform page_change.
endif.
endif.
if r_eigyou = cns_x.
if tmp_write-vkgrp <> gf_write-vkgrp.
perform page_change.
endif.
endif.
endif.
* b) 表示行あふれ処理
*---MODIFY START PSD T.SAITOH 2002/06/27 ---------------------------*
* 優先度指定あり10件とその他を表示するため１１行必要
*    IF KO_CNT = 10 AND GF_WRITE-KFLG = 1.
if ko_cnt = 11 and gf_write-kflg = 1.
*---MODIFY END   PSD T.SAITOH 2002/06/27 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/06/17 ---------------------------*
*      SKIP TO LINE 28.
skip to line 58.
*---MODIFY END   PSD T.SAITOH 2002/06/17 ---------------------------*
write text-021.
continue.

elseif kai_cnt = 10 and gf_write-kflg = 2.
skip to line 58.
write text-021.
continue.
endif.

* c) 主要顧客、開発予算率表出力

if sy-tabix = 1.
if gf_write-kflg = 1.
perform write_kokaku.
elseif gf_write-kflg = 2.
*---DELETE START PSD T.SAITOH 2002/06/17 ---------------------------*
*        PERFORM write_kaihead.
*        PERFORM write_kaimeisai.
*---DELETE END   PSD T.SAITOH 2002/06/17 ---------------------------*
endif.
endif.

if tmp_write-kflg = 1.
if gf_write-kflg = 1.
perform write_kokaku.
elseif gf_write-kflg = 2.
*---DELETE START PSD T.SAITOH 2002/06/17 ---------------------------*
*        PERFORM write_kaihead.
*        PERFORM write_kaimeisai.
*---DELETE END   PSD T.SAITOH 2002/06/17 ---------------------------*
endif.
endif.

if tmp_write-kflg = 2.
if gf_write-kflg = 2.
*---DELETE START PSD T.SAITOH 2002/06/17 ---------------------------*
*        PERFORM write_kaimeisai.
*---DELETE END   PSD T.SAITOH 2002/06/17 ---------------------------*
elseif gf_write-kflg = 1.
perform write_kokaku.
endif.
endif.

tmp_write = gf_write.
endloop.

if tmp_write-kflg = 1.
*---DELETE START PSD T.SAITOH 2002/06/17 ---------------------------*
*    PERFORM write_kaihead.
*---DELETE END   PSD T.SAITOH 2002/06/17 ---------------------------*
endif.

endform.                    " frm_write_data
*&---------------------------------------------------------------------
*&    主要顧客予算達成率表ヘッダ
*&---------------------------------------------------------------------
top-of-page.

*---APPEND START PSD T.SAITOH 2002/06/17 ---------------------------*
skip 5.
*---APPEND END   PSD T.SAITOH 2002/06/17 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
if r_nenkan = cns_x.
*    WRITE:  text-027,6 p_SYORI+2(2),'年',p_SYORI+4(2),'月度',
*    26 text-014,65 SY-DATUM DD/MM/YY.
write:0 text-027,10 p_syori+2(2),'年',p_syori+4(2),'月度',
32 text-014,72 sy-datum dd/mm/yy.
elseif r_kikan = cns_x
and p_syori+4(2) >= 4 and p_syori+4(2) =< 9.
*    WRITE:  text-028,6 p_SYORI+2(2),'年',p_SYORI+4(2),'月度',
*    26 text-014,65 SY-DATUM DD/MM/YY.
write:0  text-028,10 p_syori+2(2),'年',p_syori+4(2),'月度',
32 text-014,72 sy-datum dd/mm/yy.
elseif r_kikan = cns_x
and p_syori+4(2) >= 10 and p_syori+4(2) =< 12
or p_syori+4(2) >= 1 and p_syori+4(2) =< 3.
*    WRITE:  text-029,6 p_SYORI+2(2),'年',p_SYORI+4(2),'月度',
*    26 text-014,65 SY-DATUM DD/MM/YY.
write:0  text-029,10 p_syori+2(2),'年',p_syori+4(2),'月度',
32 text-014,72 sy-datum dd/mm/yy.
endif.
skip." <--- ADD COMMAND 2002/05/29 PSD T.SAITOH
*---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
skip 2.

if r_zensya = cns_x.
*---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
*    WRITE:  text-015,GF_WRITE-BEZEI.
write:0  text-015,gf_write-bezei.
*---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
elseif r_eigyou = cns_x.
*---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
*    WRITE:  text-015,9 GF_WRITE-BEZEI,31 text-022,43 GF_WRITE-GBEZEI.
write:0  text-015,13 gf_write-bezei,35 text-022,47 gf_write-gbezei.
*---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
endif.
*---APPEND START PSD T.SAITOH 2002/06/17 ---------------------------*
skip.
*---APPEND END   PSD T.SAITOH 2002/06/17 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
*  WRITE: /63 text-016.
*  WRITE:  /0 text-030,6 text-031,27 p_SYORI+4(2),text-032,
*         42 text-033,50 text-034,62 text-035.
write: /70 text-016.  "単位：千円
*---APPEND START PSD T.SAITOH 2002/06/17 ---------------------------*
skip.
*---APPEND END   PSD T.SAITOH 2002/06/17 ---------------------------*
skip." <--- ADD COMMAND 2002/05/29 PSD T.SAITOH

*---modify START PSD T.SAITOH 2002/06/27 ---------------------------*
* 項目名
*  WRITE:  /4 TEXT-030,10 TEXT-031,31 P_SYORI+4(2),TEXT-032,
*         46 TEXT-033,54 TEXT-034,66 TEXT-035.
write:  /0 text-030,6 text-031,25 p_syori+4(2),text-032,
40 text-033,48 text-034,56 text-035,65 text-037.
*---modify END   PSD T.SAITOH 2002/06/27 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*

*&---------------------------------------------------------------------*
*&      Form  page_change
*&---------------------------------------------------------------------*
*       改ページ
*----------------------------------------------------------------------*
form page_change.
* ---ｱ) 前ページ開発予算達成率表出力

if tmp_write-kflg = 1 and gf_write-kflg = 1.
*---DELETE START PSD T.SAITOH 2002/06/17 ---------------------------*
*    PERFORM write_kaihead.
cnt = 0.
ko_cnt = 0.
kai_cnt = 0.
new-page.
*---DELETE END   PSD T.SAITOH 2002/06/17 ---------------------------*

elseif  tmp_write-kflg = 2 and gf_write-kflg = 1.
cnt = 0.
ko_cnt = 0.
kai_cnt = 0.
new-page.

* ---ｲ) 主要顧客予算達成率表ブレイク処理
elseif gf_write-kflg = 2.
*---DELETE START PSD T.SAITOH 2002/06/17 ---------------------------*
cnt = 0.
ko_cnt = 0.
kai_cnt = 0.
new-page.
*    PERFORM write_kaihead.
*---DELETE END   PSD T.SAITOH 2002/06/17 ---------------------------*

endif.

endform.                    " page_change
*&---------------------------------------------------------------------*
*&      Form  write_kaihead
*&---------------------------------------------------------------------*
*       開発予算達成率表ヘッダ出力
*----------------------------------------------------------------------*
*---DELETE START PSD T.SAITOH 2002/06/27 ---------------------------*
*FORM WRITE_KAIHEAD.
**---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
**  SKIP TO LINE 30.
*  SKIP TO LINE 43.
**---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*
**---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
**  WRITE:  26 text-017.
*  WRITE:  38 TEXT-017.                    "開発予算達成率表（タイトル）
**---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*  SKIP.
**---APPEND START PSD T.SAITOH 2002/05/29 ---------------------------*
*  SKIP.
**---APPEND END   PSD T.SAITOH 2002/05/29 ---------------------------*
*
**---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
**  WRITE:  /0 ' ',6 text-036,27 p_SYORI+4(2),text-032,
**          42 text-033,50 text-034,62 text-035.
*  WRITE:  /4 ' ',10 TEXT-036,31 P_SYORI+4(2),TEXT-032,
*          46 TEXT-033,54 TEXT-034,66 TEXT-035.
**---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*
*ENDFORM.                    " write_kaihead
*---DELETE END   PSD T.SAITOH 2002/06/27 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  write_kaimeisai
*&---------------------------------------------------------------------*
*       開発予算達成率表明細出力
*----------------------------------------------------------------------*
*FORM WRITE_KAIMEISAI.
*
*  IF GF_WRITE-RFLG = 1.
*    FORMAT COLOR 2 INTENSIFIED.
**---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
**  WRITE: /2(2) ' ',
**           6(40) GF_WRITE-NAME1,
**           27(12) GF_WRITE-URIJISEKI,
**           42(8) GF_WRITE-ARARIRITU,
**           54(8) GF_WRITE-KONKIYOSANNHI,
**           66(8) GF_WRITE-ZENENDOUGETUHI.
*    WRITE:/, 6(2) ' ',
*             10(40) GF_WRITE-NAME1,
*             31(12) GF_WRITE-URIJISEKI,
*             41(6) GF_WRITE-ARARIRITU,
*             53(6) GF_WRITE-KONKIYOSANNHI,
*             65(8) GF_WRITE-ZENENDOUGETUHI.
**---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*    FORMAT COLOR OFF.
*
*  ELSEIF GF_WRITE-RFLG = 2.
*    KAI_CNT = 1 + KAI_CNT.
**---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
**  WRITE: /2(2) ' ',
**           6(40) GF_WRITE-NAME1,
**           27(12) GF_WRITE-URIJISEKI,
**           42(8) GF_WRITE-ARARIRITU,
**           54(8) GF_WRITE-KONKIYOSANNHI,
**           66(8) GF_WRITE-ZENENDOUGETUHI.
*    WRITE:   /6(2) ' ',
*             10(40) GF_WRITE-NAME1,
*             31(12) GF_WRITE-URIJISEKI,
*             41(6) GF_WRITE-ARARIRITU,
*             53(6) GF_WRITE-KONKIYOSANNHI,
*             65(8) GF_WRITE-ZENENDOUGETUHI.
**---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*  ENDIF.
*
*ENDFORM.                    " write_kaimeisai
*&---------------------------------------------------------------------*
*&      Form  write_kokaku
*&---------------------------------------------------------------------*
*       主要顧客予算達成率表出力
*----------------------------------------------------------------------*
form write_kokaku.

if gf_write-rflg = 1.
cnt = 1 + cnt.
format color 2 intensified.
*---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
*    WRITE:  /2(2) cnt,
*            6(40) GF_WRITE-NAME1,
*            27(12) GF_WRITE-URIJISEKI,
*            42(8) GF_WRITE-ARARIRITU,
*            54(8) GF_WRITE-KONKIYOSANNHI,
*            66(8) GF_WRITE-ZENENDOUGETUHI.
*    WRITE:/, 6(2) CNT,
*            10(40) GF_WRITE-NAME1,
*            31(12) GF_WRITE-URIJISEKI,
*            46(8) GF_WRITE-ARARIRITU,
*            58(8) GF_WRITE-KONKIYOSANNHI,
*            70(8) GF_WRITE-ZENENDOUGETUHI.
write:/, 1(2) cnt,
6(20) gf_write-name1,
25(12) gf_write-urijiseki,
40(8) gf_write-arariritu,
50(6) gf_write-konkiyosannhi,
58(6) gf_write-zenendougetuhi.
*---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/06/27 ---------------------------*
write:  68(12) gf_write-budget_sum."予算金額
*---APPEND END   PSD T.SAITOH 2002/06/27 ---------------------------*
format color off.

elseif gf_write-rflg = 2.
ko_cnt = 1 + ko_cnt.
*---MODIFY START PSD T.SAITOH 2002/05/29 ---------------------------*
*    WRITE:  /2(2) '  ',
*            6(40) GF_WRITE-NAME1,
*            27(12) GF_WRITE-URIJISEKI,
*            42(8) GF_WRITE-ARARIRITU,
*            54(8) GF_WRITE-KONKIYOSANNHI,
*            66(8) GF_WRITE-ZENENDOUGETUHI.
write:  /1(2) '  ',
6(20) gf_write-name1,
25(12) gf_write-urijiseki,
40(8) gf_write-arariritu,
50(6) gf_write-konkiyosannhi,
58(6) gf_write-zenendougetuhi.
*---MODIFY END   PSD T.SAITOH 2002/05/29 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/06/27 ---------------------------*
write:  68(12) gf_write-budget_sum."粗利金額
*---APPEND END   PSD T.SAITOH 2002/06/27 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/06/17 ---------------------------*
skip.
*---APPEND END   PSD T.SAITOH 2002/06/17 ---------------------------*

endif.

endform.                    " write_kokaku
*&---------------------------------------------------------------------*
*&      Form  frm_priority_set
*&---------------------------------------------------------------------*
*       顧客実績（当年度）内部テーブルに優先度を設定する
*----------------------------------------------------------------------*
*  <->  P_ITAB     内部テーブル
*----------------------------------------------------------------------*
form frm_priority_set_tkokaku tables p_itab.

* フィールドシンボルの設定
field-symbols <pt> type typ_tkokaku.

* 優先度の設定
loop at p_itab assigning <pt>.
read table gt_priority into gf_priority
with key year   = t_syori+0(4)"会計年度
vkbur  = <pt>-vkbur  "営業所
pkunag = <pt>-pkunag."得意先

if sy-subrc = 0.
*     優先度が設定されている場合優先度を設定する
<pt>-priority = gf_priority-priority.
else.
*     優先度が設定されていない場合優先度はＺとし
*     受注先（得意先）をその他とする
<pt>-priority = 'Z'.
<pt>-pkunag   = 'ZZZZZZZZZZ'.
endif.
*   年度の設定
<pt>-year = p_syori+0(4).
endloop.

endform.                    " frm_priority_set
*&---------------------------------------------------------------------*
*&      Form  frm_priority_set
*&---------------------------------------------------------------------*
*       顧客実績（前年度）内部テーブルに優先度を設定する
*----------------------------------------------------------------------*
*  <->  P_ITAB     内部テーブル
*----------------------------------------------------------------------*
form frm_priority_set_zkokaku tables p_itab.

* フィールドシンボルの設定
field-symbols <pt> type typ_zkokaku.

* 優先度の設定
loop at p_itab assigning <pt>.
read table gt_priority into gf_priority
with key year  = t_syori+0(4) "会計年度
vkbur = <pt>-vkbur   "営業所
pkunag = <pt>-pkunag."得意先

if sy-subrc = 0.
*     優先度が設定されている場合優先度を設定する
<pt>-priority = gf_priority-priority.
else.
*     優先度が設定されていない場合優先度はＺとし
*     受注先（得意先）をその他とする
<pt>-priority = 'Z'.
<pt>-pkunag   = 'ZZZZZZZZZZ'.
endif.
*   年度の設定
<pt>-year = p_syori+0(4).
endloop.

endform.                    " frm_priority_set
*&---------------------------------------------------------------------*
*&      Form  frm_priority_set
*&---------------------------------------------------------------------*
*       顧客計画（当年度）内部テーブルに優先度を設定する
*----------------------------------------------------------------------*
*  <->  P_ITAB     内部テーブル
*----------------------------------------------------------------------*
form frm_priority_set_kokeikaku tables p_itab.

* フィールドシンボルの設定
field-symbols <pt> type typ_kokeikaku.

* 優先度の設定
loop at p_itab assigning <pt>.
read table gt_priority into gf_priority
with key year  = t_syori+0(4) "会計年度
vkbur = <pt>-vkbur   "営業所
pkunag = <pt>-pkunag."得意先

if sy-subrc = 0.
*     優先度が設定されている場合優先度を設定する
<pt>-priority = gf_priority-priority.
else.
*     優先度が設定されていない場合優先度はＺとし
*     受注先（得意先）をその他とする
<pt>-priority = 'Z'.
<pt>-pkunag   = 'ZZZZZZZZZZ'.
endif.
*   年度の設定
<pt>-year = p_syori+0(4).
endloop.

endform.                    " frm_priority_set
*&---------------------------------------------------------------------*
*&      Form  frm_set_priority_from_tvarv
*&---------------------------------------------------------------------*
*       変数テーブルから得意先優先度を内部テーブルに格納する
*----------------------------------------------------------------------*
form frm_set_priority_from_tvarv.

**   優先度キー名称設定
*    concatenate 'ZS'      "アドオンＳＤモジュールプログラム
*                SY-MANDT  "クライアント
*                SY-REPID  "プログラムＩＤ
*                'KUNNR'   "得意先コード名
*           into g_priority_name "優先度キー名称
*    SEPARATED BY '_'.
*
**   優先度固定長データ取得
*    SELECT LOW FROM TVARV
*         INTO corresponding fields of gf_tvarv_one_field
*         WHERE NAME = g_priority_name
*         AND TYPE = 'S'.
*
**     優先度情報を処理可能な構造に分離し格納する。
*      gf_priority-year     = gf_tvarv_one_field-LOW+0(4).
*      gf_priority-VKBUR    = gf_tvarv_one_field-LOW+4(4).
*      gf_priority-PKUNAG   = gf_tvarv_one_field-LOW+8(10).
*      gf_priority-priority = gf_tvarv_one_field-LOW+18(1).
*      append gf_priority to gt_priority.
*
*    endselect.
select gjahr
vkbur
pkunag
zsprio
from zsb003
into (gf_priority-year ,
gf_priority-vkbur ,
gf_priority-pkunag ,
gf_priority-priority)
* Add 2005.04.12 --->
Where  ZSPRIO LE 10
* Add 2005.04.12 <---
.

append gf_priority to gt_priority.
clear : gf_priority .
endselect .
endform.                    " frm_set_priority_from_tvarv
*>>>>>>APPEND START PSD T.SAITOH 2002/06/27 ---------------------------
*&---------------------------------------------------------------------*
*&      Form  frm_selling_results_main_m
*&---------------------------------------------------------------------*
*       売上実績（当月）
*----------------------------------------------------------------------*
form frm_selling_results_main_m.
* 全社の場合
if r_zensya = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
perform frm_selling_results_month.
elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
perform frm_selling_results_month_z.
endif.
* 営業所の場合
elseif r_eigyou = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
perform frm_eselling_results_month.
elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
perform frm_eselling_results_month_z.
endif.
endif.

case sy-subrc.
* ⅰ）対象データあり
when 0.
gf_write-urijiseki = syoumikei / 1000 * 100.
* ⅱ）対象データなし
when 4.
gf_write-urijiseki = 0.
endcase.

endform.                    " frm_selling_results_main_m
*&---------------------------------------------------------------------*
*&      Form  frm_selling_results_month
*&---------------------------------------------------------------------*
*       売上実績（当月）　優先度設定有り
*----------------------------------------------------------------------*
form frm_selling_results_month.

loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and pkunag = tmp_kokeikaku-pkunag
and spmon  = p_syori.

syoumikei = gf_tkokaku-netwr + syoumikei." 正味額合計
ararikei = gf_tkokaku-zzaraigaku + ararikei." 粗利金額合計

endloop.

endform.                    " frm_selling_results_month
*
*&---------------------------------------------------------------------*
*&      Form  frm_selling_results_month_z
*&---------------------------------------------------------------------*
*       売上実績（当月）　優先度設定なし（その他）
*----------------------------------------------------------------------*
form frm_selling_results_month_z.

loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and spmon  = p_syori.

syoumikei = gf_tkokaku-netwr + syoumikei." 正味額合計
ararikei = gf_tkokaku-zzaraigaku + ararikei." 粗利金額合計

endloop.

endform.                    " frm_selling_results_month_z
*&---------------------------------------------------------------------*
*&      Form  frm_eselling_results_month
*&---------------------------------------------------------------------*
*       売上実績（当月）　優先度設定あり（営業所）
*----------------------------------------------------------------------*
form frm_eselling_results_month.

loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and pkunag = tmp_kokeikaku-pkunag
and spmon  = p_syori.

syoumikei = gf_tkokaku-netwr + syoumikei." 正味額合計
ararikei = gf_tkokaku-zzaraigaku + ararikei." 粗利金額合計

endloop.

endform.                    " frm_eselling_results_month
*&---------------------------------------------------------------------*
*&      Form  frm_eselling_results_month_z
*&---------------------------------------------------------------------*
*       売上実績（当月）　優先度設定なし（営業所）（その他）
*----------------------------------------------------------------------*
form frm_eselling_results_month_z.

loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and spmon  = p_syori.

syoumikei = gf_tkokaku-netwr + syoumikei." 正味額合計
ararikei = gf_tkokaku-zzaraigaku + ararikei." 粗利金額合計

endloop.

endform.                    " frm_eselling_results_month_z
*&---------------------------------------------------------------------*
*&      Form  frm_selling_results_main_all
*&---------------------------------------------------------------------*
*       売上実績（累計）
*----------------------------------------------------------------------*
form frm_selling_results_main_all.
if r_zensya = cns_x.

if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.

loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and   pkunag = tmp_kokeikaku-pkunag
and   spmon  >= t_syori
and   spmon  =< p_syori.

syoumiruikei = gf_tkokaku-netwr + syoumiruikei." 正味額累計
arariruikei = gf_tkokaku-zzaraigaku + arariruikei." 粗利金額累計

endloop.
elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and      spmon  >= t_syori
and      spmon  =< p_syori.

syoumiruikei = gf_tkokaku-netwr + syoumiruikei." 正味額累計
arariruikei = gf_tkokaku-zzaraigaku + arariruikei." 粗利金額累計

endloop.
endif.

elseif r_eigyou = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.

loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and    vkgrp = tmp_kokeikaku-vkgrp
and    pkunag = tmp_kokeikaku-pkunag
and    spmon  >= t_syori
and    spmon  =< p_syori.

syoumiruikei = gf_tkokaku-netwr + syoumiruikei." 正味額累計
arariruikei = gf_tkokaku-zzaraigaku + arariruikei." 粗利金額累計

endloop.
elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
loop at gt_tkokaku into gf_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and   vkgrp = tmp_kokeikaku-vkgrp
and   spmon  >= t_syori
and   spmon  =< p_syori.

syoumiruikei = gf_tkokaku-netwr + syoumiruikei." 正味額累計
arariruikei = gf_tkokaku-zzaraigaku + arariruikei." 粗利金額累計

endloop.
endif.
endif.

case sy-subrc.
* ⅰ）対象データあり
when 0.
gf_rwrite-urijiseki = syoumiruikei / 1000 * 100.
* ⅱ）対象データなし
when 4.
gf_rwrite-urijiseki = 0.
endcase.

endform.                    " frm_selling_results_main_all
*&---------------------------------------------------------------------*
*&      Form  frm_delete_computed_record
*&---------------------------------------------------------------------*
*       集計済みレコード削除
*----------------------------------------------------------------------*
form frm_delete_computed_record.
if r_zensya = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
delete gt_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and pkunag = tmp_kokeikaku-pkunag
and      spmon  >= t_syori
and      spmon  =< p_syori.

elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
delete gt_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and      spmon  >= t_syori
and      spmon  =< p_syori.
endif.

elseif r_eigyou = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
delete gt_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and pkunag = tmp_kokeikaku-pkunag
and      spmon  >= t_syori
and      spmon  =< p_syori.

elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
delete gt_tkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and      spmon  >= t_syori
and      spmon  =< p_syori.
endif.
endif.

endform.                    " frm_delete_computed_record
*&---------------------------------------------------------------------*
*&      Form  frm_same_month_last_year
*&---------------------------------------------------------------------*
*       前年同月比の設定
*----------------------------------------------------------------------*
form frm_same_month_last_year.

if r_zensya = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and pkunag = tmp_kokeikaku-pkunag
and spmon  = zp_syori.

zsyoumikei = gf_zkokaku-netwr + zsyoumikei." 正味額合計

endloop.

elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and spmon  = zp_syori.

zsyoumikei = gf_zkokaku-netwr + zsyoumikei." 正味額合計

endloop.
endif.
elseif r_eigyou = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and pkunag = tmp_kokeikaku-pkunag
and spmon  = zp_syori.

zsyoumikei = gf_zkokaku-netwr + zsyoumikei." 正味額合計

endloop.
elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and spmon  = zp_syori.

zsyoumikei = gf_zkokaku-netwr + zsyoumikei." 正味額合計

endloop.

endif.
endif.

case sy-subrc.
* ⅰ）対象データあり
when 0.
* Add 2004/02/13 >>>>>
if zsyoumikei ne 0 .
* Add 2004/02/13 <<<<<
* Add 2005/05/19 >>>>>
*                         円項目分↓　　↓千円単位
zsyoumikei = zsyoumikei * 100 / 1000 .

* Add 2005/05/19 <<<<<

gf_write-zenendougetuhi = gf_write-urijiseki / zsyoumikei * 100.
* Add 2004/02/13 >>>>>
else .
gf_write-zenendougetuhi = '9999.9' .
endif .
* Add 2004/02/13 <<<<<

* ⅱ）対象データなし
when 4.
gf_write-zenendougetuhi = 0.
endcase.


endform.                    " frm_same_month_last_year
*&---------------------------------------------------------------------*
*&      Form  frm_same_period_last_year
*&---------------------------------------------------------------------*
*       前年同期比の設定
*----------------------------------------------------------------------*
form frm_same_period_last_year.

if r_zensya = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and pkunag = tmp_kokeikaku-pkunag
and spmon  >= zt_syori
and spmon  =< zp_syori.

zsyoumiruikei = gf_zkokaku-netwr + zsyoumiruikei.

endloop.

elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and spmon  >= zt_syori
and spmon  =< zp_syori.
zsyoumiruikei = gf_zkokaku-netwr + zsyoumiruikei.
endloop.
endif.

elseif r_eigyou = cns_x.
if tmp_kokeikaku-pkunag <> 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and pkunag = tmp_kokeikaku-pkunag
and spmon  >= zt_syori
and spmon  =< zp_syori.
zsyoumiruikei = gf_zkokaku-netwr + zsyoumiruikei.

endloop.
elseif tmp_kokeikaku-pkunag = 'ZZZZZZZZZZ'.
loop at gt_zkokaku into gf_zkokaku
where vkbur = tmp_kokeikaku-vkbur
and vkgrp = tmp_kokeikaku-vkgrp
and spmon  >= zt_syori
and spmon  =< zp_syori.

zsyoumiruikei = gf_zkokaku-netwr + zsyoumiruikei.

endloop.

endif.
endif.

case sy-subrc.
* ⅰ）対象データあり
when 0.
* Add 2004/02/13 >>>>>
if zsyoumiruikei ne 0 .
* Add 2004/02/13 <<<<<
* Add 2005/04/04 >>>>>
*                                 円項目分↓　　↓千円単位
zsyoumiruikei = zsyoumiruikei * 100 / 1000 .

* Add 2005/04/04 <<<<<
gf_rwrite-zenendougetuhi = gf_rwrite-urijiseki / zsyoumiruikei *
100.
* Add 2004/02/13 >>>>>
else .
gf_rwrite-zenendougetuhi = '9999.9' .
endif .
* Add 2004/02/13 <<<<<

* ⅱ）対象データなし
when 4.
gf_rwrite-zenendougetuhi = 0.
endcase.

endform.                    " frm_same_period_last_year
*&---------------------------------------------------------------------*
*&      Form  frm_vkbur
*&---------------------------------------------------------------------*
*       営業所名の設定
*----------------------------------------------------------------------*
form frm_vkbur.

read table gt_eigyousyo with key vkbur = tmp_kokeikaku-vkbur
into gf_eigyousyo.
case sy-subrc.
* 対象データあり
when 0.
gf_write-vkbur = tmp_kokeikaku-vkbur.
gf_write-bezei = gf_eigyousyo-bezei.
gf_rwrite-vkbur = tmp_kokeikaku-vkbur.
gf_rwrite-bezei = ' '.
* 対象データなし
when 4.
gf_write-vkbur = tmp_kokeikaku-vkbur.
gf_write-bezei = ' '.
gf_rwrite-vkbur = tmp_kokeikaku-vkbur.
gf_rwrite-bezei = ' '.
endcase.

endform.                    " frm_vkbur
*&---------------------------------------------------------------------*
*&      Form  frm_vkgrp
*&---------------------------------------------------------------------*
*       営業グループの設定
*----------------------------------------------------------------------*
form frm_vkgrp.

if r_eigyou = cns_x.
read table gt_eigyougp with key vkgrp = tmp_kokeikaku-vkgrp
into gf_eigyougp.

case sy-subrc.
* 対象データあり
when 0.
gf_write-vkgrp = tmp_kokeikaku-vkgrp.
gf_write-gbezei = gf_eigyougp-bezei.
gf_rwrite-vkgrp = tmp_kokeikaku-vkgrp.
gf_rwrite-gbezei = ' '.
* 対象データなし
when 4.
gf_write-vkgrp  = tmp_kokeikaku-vkgrp.
gf_write-gbezei  = ' '.
gf_rwrite-vkgrp = tmp_kokeikaku-vkgrp.
gf_rwrite-gbezei = ' '.
endcase.
endif.

endform.                    " frm_vkgrp
*&---------------------------------------------------------------------*
*&      Form  frm_pkunag
*&---------------------------------------------------------------------*
*       得意先名称の設定
*----------------------------------------------------------------------*
form frm_pkunag.

select single name1
into corresponding fields of gf_write
from kna1 where kunnr = tmp_kokeikaku-pkunag.
case sy-subrc.
* 対象データあり
when 0.
gf_write-kunnr = tmp_kokeikaku-pkunag.
gf_write-name1 = gf_write-name1.
gf_rwrite-kunnr = tmp_kokeikaku-pkunag.
gf_rwrite-name1 = ' '.
* 対象データなし
when 4.
gf_write-kunnr = tmp_kokeikaku-pkunag.
gf_write-name1 = ' '.
gf_rwrite-kunnr = tmp_kokeikaku-pkunag.
gf_rwrite-name1 = ' '.
endcase.


endform.                    " frm_pkunag

*&---------------------------------------------------------------------
*&      Form  frm_sell_budget_from_s901
*&---------------------------------------------------------------------
*        得意先/セグメント/計画情報
*----------------------------------------------------------------------
* <-- 売上予算累計
* <-- 粗利予算累計
*----------------------------------------------------------------------
form frm_sell_budget_from_s901 using p_sell_sum p_margin_sum.

data:l_netwr     type s901-netwr,     "売上予算累計
l_margin    type s901-zzaraigaku."粗利予算累計
* 全社を選択
if r_zensya = cns_x.
if gf_write-kunnr <> 'ZZZZZZZZZZ'.
*   優先得意先
perform frm_sbfs901_priority using p_sell_sum p_margin_sum.
else.
*   その他
perform frm_sbfs901_etc using p_sell_sum p_margin_sum.
endif.

elseif r_eigyou = cns_x.
select
netwr zzaraigaku
into (l_netwr,l_margin)
from s901
* 2004/10/13 mod>>
where vrsio = yosanv
*        where vrsio = '001'
* 2004/10/13 mod<<
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vkorg = '1000'
and   vkgrp = gf_write-vkgrp
and   pkunag = gf_write-kunnr.

*    　   売上予算と粗利予算集計
p_sell_sum     = p_sell_sum     + ( l_netwr / 10 ).
p_margin_sum   = p_margin_sum   + ( l_margin / 10 ).

endselect.
endif.

* エラー処理
case sy-subrc.
when 0.
when 4.
when 8.    " システムエラー
message a603(z1) with sy-repid '予算集計' sy-subrc."
endcase.

endform.                    " frm_set_tkokaku
*&---------------------------------------------------------------------*
*&      Form  frm_sbfs901_priority
*&---------------------------------------------------------------------*
*       優先度あり得意先の売上粗利予算累計集計
*----------------------------------------------------------------------*
form frm_sbfs901_priority using p_sell_sum p_margin_sum.

data:l_netwr     type s901-netwr,     "売上予算累計
l_margin    type s901-zzaraigaku."粗利予算累計

select netwr zzaraigaku
into (l_netwr,l_margin)
from s901
* 2004/10/13 mod>>
where vrsio = yosanv
*      where vrsio = '001'
* 2004/10/13 mod<<
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vkorg = '1000'
and   vkbur  = gf_write-vkbur
and   pkunag = gf_write-kunnr.

*     売上予算と粗利予算集計
p_sell_sum     = p_sell_sum   + ( l_netwr / 10 ).
p_margin_sum   = p_margin_sum + ( l_margin / 10 ).

endselect.

endform.                    " frm_sbfs901_priority
*&---------------------------------------------------------------------*
*&      Form  frm_sbfs901_etc
*&---------------------------------------------------------------------*
*       優先度なし（その他）得意先の売上粗利予算累計集計
*----------------------------------------------------------------------*
form frm_sbfs901_etc using p_sell_sum p_margin_sum.
data:l_netwr     type s901-netwr,     "売上予算累計
l_margin    type s901-zzaraigaku,"粗利予算累計
l_pkunag    type s901-pkunag.    "得意先

select netwr zzaraigaku pkunag
into (l_netwr,l_margin,l_pkunag)
from s901
* 2004/10/13 mod>>
where vrsio = yosanv
*      where vrsio = '001'
* 2004/10/13 mod<<
and   spmon  >= t_syori+0(6)
and   spmon  <= p_syori+0(6)
and   vkorg = '1000'
and   vkbur  = gf_write-vkbur.

*     優先度が設定されているかどうか読込む
read table gt_priority into gf_priority
with key year   = t_syori+0(4)
vkbur  = gf_write-vkbur
pkunag = l_pkunag.
if sy-subrc <> 0.
*     　優先度が設定されていないモノのみ売上予算と粗利予算集計
p_sell_sum     = p_sell_sum   + ( l_netwr / 10 ).
p_margin_sum   = p_margin_sum + ( l_margin / 10 ).
endif.
if l_pkunag eq 'ZZZZZZZZZZ' .
p_sell_sum     = p_sell_sum   + ( l_netwr / 10 ).
p_margin_sum   = p_margin_sum + ( l_margin / 10 ).
endif .
endselect.

endform.                    " frm_sbfs901_etc
