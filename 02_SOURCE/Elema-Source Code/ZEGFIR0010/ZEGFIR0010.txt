***********************************************************************
* [PROGRAM NAME]
*   PROGRAM ID :ZEGFIR0010
*              :Statement of Account
* [PROGRAM CONTENS]
*   CONTENTS
*
* [VERSION]
*　YYYY/MM/DD   Programar         Description
*  2014/10/27   ISID18            New Created
*  2015/01/07   ISID18           Customer's address extraction updating
*                                Frontend Codepage Extraction updating
*  2015/02/03   ISID18           Extracted text based to report lang.
*                                Company address issue
*  2015/02/25   ISID18           Put minus sign in front of amount
*                                Report language initial process
*  2015/03/23   ISID18           Add company code to file
*  2015/05/21   ISID17           ファイルソート順の修正
*  2015/06/09   ISID REN         ファイルソート順の修正
*  2015/06/15   ISID18           ファイルソート順の修正
*  2015/06/25   ISID18           自社名編集ロジック変更
*  2016/08/03   ISID18           タイ展開対応
*  2016/09/08   ISID18           Remittance有無により、ファイル名を分ける対応
***********************************************************************
REPORT ZEGFIR0010
LINE-SIZE 153
LINE-COUNT 58
NO STANDARD PAGE HEADING
MESSAGE-ID ZMEGFI01.

************************************************************************
* CONSTANTS DEFINATION
************************************************************************
CONSTANTS:
CNS_LOCK_MODE(1)   TYPE C     VALUE 'E',    " Lock mode
CNS_TXT(4)         TYPE C     VALUE '.txt', " text file
CNS_REPORT_TYPE(2) TYPE C     VALUE 'SA',   " Report type
CNS_MODE_P(1)      TYPE C     VALUE 'P',    " Print/Reprint
CNS_MODE_D(1)      TYPE C     VALUE 'D',    " Download
CNS_KOART_D        TYPE KOART VALUE 'D',    " Account type(customer)
CNS_SHKZG_S        TYPE SHKZG VALUE 'S',    " Debit flag
CNS_SHKZG_H        TYPE SHKZG VALUE 'H'.    " Credit flag

************************************************************************
* TYPES DEFINATION
************************************************************************

* To hold information of company
TYPES:
BEGIN OF TYP_TH_T001,
BUKRS      TYPE T001-BUKRS,       " Company Code
ADRNR      TYPE T001-ADRNR,       " Address
NAME1      TYPE ADRC-NAME1,       " Name1
**** BEGIN OF UPD 2015/02/03 ISID18 ****
*    CITY1      TYPE ADRC-CITY1,       " City
STREET     TYPE ADRC-STREET,      " Street
CITY1      TYPE ADRC-STR_SUPPL1,  " City
**** END OF UPD 2015/02/03 ISID18 ****
TEL_NUMBER TYPE ADRC-TEL_NUMBER,  " First telephone no.
FAX_NUMBER TYPE ADRC-FAX_NUMBER,  " First fax no.
POST_CODE1 TYPE ADRC-POST_CODE1,  " City postal code
COUNTRY    TYPE ADRC-COUNTRY,     " Country
LANDX      TYPE T005T-LANDX,      " Country name
XDEZP      TYPE T005X-XDEZP,      " Decimal notation
DATFM      TYPE T005X-DATFM,      " Date format
END OF TYP_TH_T001.

* To hold customer code
TYPES:
BEGIN OF TYP_TH_KNB1,
KUNNR      TYPE KNB1-KUNNR,       " Customer code
ZSABE      TYPE KNB1-ZSABE,       " User at customer
END OF TYP_TH_KNB1.

**** START OF INS 2015/01/07 ISID18 ****
* To hold address number
TYPES:
BEGIN OF TYP_TH_KNA1,
KUNNR      TYPE KNA1-KUNNR,       " Customer code
ADRNR      TYPE KNA1-ADRNR,       " Address number
END OF TYP_TH_KNA1,
TYP_TD_KNA1  TYPE STANDARD TABLE OF TYP_TH_KNA1.

* To hold Country name
TYPES:
BEGIN OF TYP_TH_T005T,
LAND1      TYPE T005T-LAND1,      " Country Number
LANDX      TYPE T005T-LANDX,      " Country Name
END OF TYP_TH_T005T,
TYP_TD_T005T TYPE STANDARD TABLE OF TYP_TH_T005T.
**** END OF INS 2015/01/07 ISID18 ****

* To hold information of customer
TYPES:
BEGIN OF TYP_TH_CUST,
KUNNR      TYPE KNA1-KUNNR,       " Customer code
**** START OF UPD 2015/01/07 ISID18 ****
*    NAME1      TYPE ADRC-NAME1,       " Name1
NAME1      TYPE TEXT80,            " Name
**** END OF UPD 2015/01/07 ISID18 ****
CITY1      TYPE ADRC-CITY1,       " City
STREET     TYPE ADRC-STREET,      " Street
**** START OF INS 2015/01/07 ISID18 ****
STR_SUPPL1 TYPE ADRC-STR_SUPPL1,  " Address 3
STR_SUPPL2 TYPE ADRC-STR_SUPPL2,  " Address 4
**** END OF INS 2015/01/07 ISID18 ****
TEL_NUMBER TYPE ADRC-TEL_NUMBER,  " First telephone no.
FAX_NUMBER TYPE ADRC-FAX_NUMBER,  " First fax no.
POST_CODE1 TYPE ADRC-POST_CODE1,  " City postal code
COUNTRY    TYPE ADRC-COUNTRY,     " Country
LANDX      TYPE T005T-LANDX,      " Country name
END OF TYP_TH_CUST.

* To hold data of accounting
TYPES:
BEGIN OF TYP_TH_BSID,
BUKRS      TYPE BSID-BUKRS,       " Company code
KUNNR      TYPE KNA1-KUNNR,       " Customer code
ZUONR      TYPE BSID-ZUONR,       " Assignment number
BELNR      TYPE BSID-BELNR,       " Document no
BUZEI      TYPE BSID-BUZEI,       " Item
BUDAT      TYPE BSID-BUDAT,       " Posting date
BLDAT      TYPE BSID-BLDAT,       " Document date
SHKZG      TYPE BSID-SHKZG,       " Debit/Credit Indicator
ZTERM      TYPE BSID-ZTERM,       " Terms of Payment Key
PSWSL      TYPE BSID-PSWSL,       " Update Currency
PSWBT      TYPE BSID-PSWBT,       " Amount for Updating
END OF TYP_TH_BSID.

* To hold data of accounting
TYPES:
BEGIN OF TYP_TH_EDIT,
BUKRS      TYPE BSID-BUKRS,        " Company code
KUNNR      TYPE KNA1-KUNNR,        " Customer code
ZUONR      TYPE BSID-ZUONR,        " Asignment number
BELNR      TYPE BSID-BELNR,        " Document no
BUZEI      TYPE BSID-BUZEI,        " Item
BUDAT      TYPE BSID-BUDAT,        " Posting date
DUEDATE    TYPE NETDT,             " Due date
WAERS      TYPE BSID-PSWSL,        " Currency Key
SHKZG      TYPE BSID-SHKZG,        " Debit/Credit Indicator
ZTERM      TYPE BSID-ZTERM,        " Terms of Payment Key
DEBIT_AMT  TYPE BSID-PSWBT,        " Debit amount
CREDIT_AMT TYPE BSID-PSWBT,        " Credit amount
AMOUNT     TYPE BSID-PSWBT,        " Balance
END OF TYP_TH_EDIT.

TYPES:
BEGIN OF TYP_TH_KEY,
OUTMODE(1)    TYPE C,             " Output mode
BUKRS         TYPE BSID-BUKRS,    " Company code
KUNNR         TYPE BSID-KUNNR,    " Customer code
CLOSEDATE     TYPE SY-DATUM,      " Closing date
END OF TYP_TH_KEY.

TYPES:
BEGIN OF TYP_TH_MSG,
TYPE(15)        TYPE C,             " Message type
TEXT(128)       TYPE C,             " Message text
END OF TYP_TH_MSG.

***** 2016/8/3 ISID18 INS START *****
TYPES:
BEGIN OF TYP_NUM3,
Z_NUM3 TYPE ZTEGFIT002-Z_NUM3,
END OF TYP_NUM3.
***** 2016/8/3 ISID18 INS END *****
************************************************************************
* DATA DEFINATION
************************************************************************
* Variables
DATA:
W_RECORDS_TOT TYPE I,
W_RECORDS_OK  TYPE I,
W_RECORDS_ERR TYPE I,
W_ERRFLG(1)   TYPE C,                " Error flag
W_LOGNO       TYPE ZEOUTPUTLOGNO,    " Output logno
W_OUTPUT_FN   TYPE STRING,           " Output filename
W_OUTPUT_CP   TYPE ZEOUTPUTCP,       " Codepage
W_KUNNR       TYPE KNA1-KUNNR,       " Customer code
W_BELNR       TYPE BSID-BELNR,       " Document no
W_BUDAT       TYPE BSID-BUDAT,       " Posting date
W_XDEZP       TYPE T005X-XDEZP,      " Decimal notation
W_DATFM       TYPE T005X-DATFM.      " Date format

* Structures
DATA:
TH_MSG       TYPE TYP_TH_MSG,       " Message
TH_T001      TYPE TYP_TH_T001,      " Company information
TH_KNB1      TYPE TYP_TH_KNB1,      " Company code
TH_CUST      TYPE TYP_TH_CUST,      " Customer information
TH_BSID      TYPE TYP_TH_BSID,      " Accounting data
TH_EDIT      TYPE TYP_TH_EDIT,      " Edit data
TH_SFILE     TYPE ZSEGFI0001,       " File data
TH_KEY       TYPE TYP_TH_KEY.       " Key data

* Internal tables
DATA:
TD_MSG       TYPE STANDARD TABLE OF TYP_TH_MSG,  " Message
TD_KNB1      TYPE STANDARD TABLE OF TYP_TH_KNB1, " customer code
TD_CUST      TYPE STANDARD TABLE OF TYP_TH_CUST, " customer info.
TD_BSID      TYPE STANDARD TABLE OF TYP_TH_BSID, " Accounting data
TD_EDIT_ITEM TYPE STANDARD TABLE OF TYP_TH_EDIT, " Edit data(item)
TD_EDIT_SUM  TYPE STANDARD TABLE OF TYP_TH_EDIT, " Edit data(sum)
TD_SFILE     TYPE STANDARD TABLE OF ZSEGFI0001,  " File data
TD_KEY       TYPE STANDARD TABLE OF TYP_TH_KEY.  " Key data
************************************************************************
* SELECTION-SCREEN
************************************************************************
* Mode(Print/Reprint/Download)
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN POSITION 32.
PARAMETERS RB_PRINT RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 34(15) TEXT-002 FOR FIELD RB_PRINT.
SELECTION-SCREEN POSITION 52.
PARAMETERS RB_REPNT RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 54(15) TEXT-003 FOR FIELD RB_REPNT.
SELECTION-SCREEN POSITION 72.
PARAMETERS RB_DOWNL RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 74(15) TEXT-004 FOR FIELD RB_DOWNL.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK B1.
SELECTION-SCREEN SKIP 1.

* Print option(Printer/tray)
SELECTION-SCREEN BEGIN OF BLOCK B2 WITH FRAME TITLE TEXT-005.
PARAMETERS P_TRAY TYPE TSP03L-LNAME.
SELECTION-SCREEN END OF BLOCK B2.
SELECTION-SCREEN SKIP 1.

* Download option(File path)
SELECTION-SCREEN BEGIN OF BLOCK B3 WITH FRAME TITLE TEXT-006.
PARAMETERS P_DFILE TYPE RLGRAP-FILENAME.
SELECTION-SCREEN END OF BLOCK B3.
SELECTION-SCREEN SKIP 1.

* Source data
SELECTION-SCREEN BEGIN OF BLOCK B4 WITH FRAME TITLE TEXT-007.
PARAMETERS P_BUKRS TYPE T001-BUKRS OBLIGATORY.  " Company code
SELECT-OPTIONS S_KUNNR FOR W_KUNNR OBLIGATORY.  " Customer Code
PARAMETERS P_DATE TYPE SY-DATUM OBLIGATORY.     " Closing Date
SELECT-OPTIONS S_BELNR FOR W_BELNR.             " Document no
SELECT-OPTIONS S_BUDAT FOR W_BUDAT.             " Posint date
***** 2016/8/3 ISID18 INS START *****
PARAMETERS P_DUE_D TYPE ZTEGFIT002-Z_DUE_DATE.   " Due date
***** 2016/8/3 ISID18 INS END *****
SELECTION-SCREEN END OF BLOCK B4.
SELECTION-SCREEN SKIP 1.

* Report Parameter
SELECTION-SCREEN BEGIN OF BLOCK B5 WITH FRAME TITLE TEXT-008.
PARAMETERS P_REMK1 TYPE ZTEGFIT002-Z_SA_REMARKS1. " Remark 1
PARAMETERS P_REMK2 TYPE ZTEGFIT002-Z_SA_REMARKS2. " Remark 2
PARAMETERS P_REMK3 TYPE ZTEGFIT002-Z_SA_REMARKS3. " Remark 3
PARAMETERS P_REMK4 TYPE ZTEGFIT002-Z_SA_REMARKS4. " Remark 4
PARAMETERS P_REMK5 TYPE ZTEGFIT002-Z_SA_REMARKS5. " Remark 5
**** START ADD 2015/06/25 ISID18 ****
PARAMETERS P_CNAME TYPE ZTEGFIT002-Z_COMPANY_NAME.  " CompanyName
PARAMETERS P_CADD1 TYPE ZTEGFIT002-Z_COMPANY_ADDR1. " CompanyAddress
PARAMETERS P_CADD2 TYPE ZTEGFIT002-Z_COMPANY_ADDR2. " CompanyAddress2
PARAMETERS P_CTEL  TYPE ZTEGFIT002-Z_COMPANY_TEL.   " CompanyTel
PARAMETERS P_CFAX  TYPE ZTEGFIT002-Z_COMPANY_FAX.   " CompanyFax
**** END ADD 2015/06/25 ISID18 ****
PARAMETERS P_XDEZP TYPE T005X-XDEZP.              " Decimals notation
PARAMETERS P_DATFM TYPE T005X-DATFM.              " Date format
**** START OF INS 2015/01/07 ISID18 ****
PARAMETERS P_LANGU TYPE T002-SPRAS.           " Report Language
PARAMETERS P_TITLE TYPE ZTEGFIT002-Z_REPORT_TITLE." Report Title
**** END OF INS 2015/01/07 ISID18 ****
SELECTION-SCREEN END OF BLOCK B5.
SELECTION-SCREEN SKIP 1.
************************************************************************
* INITIALIZATION
************************************************************************
INITIALIZATION.

* Set company code
GET PARAMETER ID 'BUK' FIELD P_BUKRS.

************************************************************************
* AT SELECTION-SCREEN
************************************************************************
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_DFILE.

DATA:
LW_FILENAME   TYPE STRING,
LW_PATH       TYPE STRING,
LW_FULLPATH   TYPE STRING.

CALL METHOD CL_GUI_FRONTEND_SERVICES=>FILE_SAVE_DIALOG
CHANGING
FILENAME             = LW_FILENAME
PATH                 = LW_PATH
FULLPATH             = LW_FULLPATH
EXCEPTIONS
CNTL_ERROR           = 2
ERROR_NO_GUI         = 3
NOT_SUPPORTED_BY_GUI = 4
OTHERS               = 5.

IF SY-SUBRC <> 0.
ELSE.
P_DFILE = LW_FULLPATH.
ENDIF.

AT SELECTION-SCREEN.

* Validating at selection-screen
PERFORM SEL_VALIDATE.

************************************************************************
* START-OF-SELECTION
************************************************************************
START-OF-SELECTION.

* Fetch the data from the database table
PERFORM READ_DATA.

* Edit the extracted data
PERFORM EDIT_DATA.

* Sum of the amount by assignment number
PERFORM SUM_DATA.

* File output
PERFORM OUTPUT_DATA.

************************************************************************
* END-OF-SELECTION
************************************************************************
END-OF-SELECTION.

* Write result screen.
PERFORM WRITE_OUT.

************************************************************************
* TOP-OF-PAGE
************************************************************************
TOP-OF-PAGE.

* Header
PERFORM HEADER_OUT.

************************************************************************
*      Form  sel_validate
************************************************************************
*  Validating at selection screen
************************************************************************
FORM SEL_VALIDATE.

* Company code validation
SELECT SINGLE ADRNR
INTO TH_T001-ADRNR
FROM T001
WHERE BUKRS = P_BUKRS.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_BUKRS'.
MESSAGE E001 WITH P_BUKRS.
ENDIF.

* Printer/Tray is blank when print or reprint
IF RB_PRINT = 'X' OR
RB_REPNT = 'X'.
IF P_TRAY IS INITIAL.
SET CURSOR FIELD 'P_TRAY'.
MESSAGE E005 WITH TEXT-009.
ENDIF.
ENDIF.

* File path is blank when download
IF RB_DOWNL = 'X'.
IF P_DFILE IS INITIAL.
SET CURSOR FIELD 'P_DFILE'.
MESSAGE E005 WITH TEXT-010.
ENDIF.
ENDIF.

* Authorization check
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD P_BUKRS
ID 'ACTVT' FIELD '03'.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_BUKRS'.
MESSAGE E000 WITH P_BUKRS.
ENDIF.

ENDFORM.                    "GS_SELVALIDATE
************************************************************************
*   Form  read_data
************************************************************************
*   Fetch data from table
************************************************************************
FORM READ_DATA.

**** START OF INS 2015/01/07 ISID18 ****
DATA:
LTH_KNA1  TYPE TYP_TH_KNA1,
LTD_KNA1  TYPE TYP_TD_KNA1,
LTD_KNA12 TYPE TYP_TD_KNA1,
LTH_T005T TYPE TYP_TH_T005T,
LTD_T005T TYPE TYP_TD_T005T,
LRH_ADRC  TYPE BUS_ADDRNUMBER_RANGE,
LRD_ADRC  TYPE BUADDRNRRNG,
LTD_ADRC  TYPE ZTEGZZ002,
LTD_ADRC2 TYPE ZTEGZZ002,
LTH_ADRC  TYPE ZSEGZZ0002.
**** END OF INS 2015/01/07 ISID18 ****

**** START OF INS 2015/02/25 ISID18 ****
DATA LW_LANGU TYPE SY-LANGU.
IF P_LANGU IS NOT INITIAL.
LW_LANGU = P_LANGU.
ELSE.
LW_LANGU = SY-LANGU.
ENDIF.
**** END OF INS 2015/02/25 ISID18 ****
* To select the company name and address
SELECT
ADRC~NAME1
**** BEGIN OF UPD 2015/02/03 ISID18 ****
*    ADRC~CITY1
ADRC~STREET
ADRC~STR_SUPPL1 AS CITY1
**** END OF UPD 2015/02/03 ISID18 ****
ADRC~TEL_NUMBER
ADRC~FAX_NUMBER
ADRC~POST_CODE1
ADRC~COUNTRY
T005T~LANDX
UP TO 1 ROWS
FROM ADRC AS ADRC
INNER JOIN T005T AS T005T
ON ADRC~COUNTRY = T005T~LAND1
INTO CORRESPONDING FIELDS OF TH_T001
WHERE ADRC~ADDRNUMBER = TH_T001-ADRNR
AND ADRC~DATE_TO   >= SY-DATUM
**** BEGIN OF UPD 2015/02/03 ISID18 ****
*     AND T005T~SPRAS     = SY-LANGU.
**** BEGIN OF UPD 2015/02/25 ISID18 ****
*     AND T005T~SPRAS     = P_LANGU.
AND T005T~SPRAS     = LW_LANGU.
**** END OF UPD 2015/02/25 ISID18 ****
**** END OF UPD 2015/02/03 ISID18 ****
ENDSELECT.
IF SY-SUBRC <> 0.
MESSAGE S002 WITH 'T001&ADRC'
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.

* To select decimal notation, date format
SELECT SINGLE
XDEZP DATFM
INTO CORRESPONDING FIELDS OF TH_T001
FROM T005X
WHERE LAND = TH_T001-COUNTRY.

* To select customer name and address
REFRESH TD_CUST.
**** START OF UPD 2015/01/07 ISID18 ****
*  SELECT
*    KNA1~KUNNR
*    ADRC~NAME1
*    ADRC~CITY1
*    ADRC~STREET
*    ADRC~TEL_NUMBER
*    ADRC~FAX_NUMBER
*    ADRC~POST_CODE1
*    ADRC~COUNTRY
*    T005T~LANDX
*    INTO CORRESPONDING FIELDS OF TABLE TD_CUST
*    FROM KNA1 AS KNA1
*    LEFT JOIN ADRC AS ADRC
*      ON KNA1~ADRNR = ADRC~ADDRNUMBER
*   INNER JOIN T005T AS T005T
*      ON ADRC~COUNTRY = T005T~LAND1
*   WHERE T005T~SPRAS = SY-LANGU
*     AND KNA1~KUNNR IN S_KUNNR.
*  IF SY-SUBRC <> 0.
*    MESSAGE S002 WITH 'KNA1&ADRC'
*      DISPLAY LIKE 'E'.
*    LEAVE LIST-PROCESSING.
*  ENDIF.
* Extract customer address number
REFRESH LTD_KNA1.
SELECT KUNNR         " Customer code
ADRNR         " Address number
INTO TABLE LTD_KNA1
FROM KNA1
WHERE KUNNR IN S_KUNNR.
LTD_KNA12[] = LTD_KNA1[].
SORT LTD_KNA12 BY ADRNR.
DELETE ADJACENT DUPLICATES FROM LTD_KNA12
COMPARING ADRNR.

* Range table for address
REFRESH LRD_ADRC.
LOOP AT LTD_KNA12 INTO LTH_KNA1.
CLEAR LRH_ADRC.
LRH_ADRC-SIGN   = 'I'.
LRH_ADRC-OPTION = 'EQ'.
LRH_ADRC-LOW    = LTH_KNA1-ADRNR.
APPEND LRH_ADRC TO LRD_ADRC.
ENDLOOP.
FREE LTD_KNA12.

* Get Address information
REFRESH LTD_ADRC.
CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
EXPORTING
IMPMULTITFLG     = '2'
IMPRNGADDRNUMBER = LRD_ADRC
IMPORTING
EXPTABADRC       = LTD_ADRC.
FREE LRD_ADRC.
SORT LTD_ADRC BY ADDRNUMBER.

* Get Country Name
LTD_ADRC2[] = LTD_ADRC[].
SORT LTD_ADRC2 BY COUNTRY.
DELETE ADJACENT DUPLICATES FROM LTD_ADRC2
COMPARING COUNTRY.
REFRESH LTD_T005T.
IF LTD_ADRC2[] IS NOT INITIAL.
SELECT LAND1
LANDX
INTO TABLE LTD_T005T
FROM T005T
FOR ALL ENTRIES IN LTD_ADRC2
WHERE LAND1 = LTD_ADRC2-COUNTRY
**** BEGIN OF UPD 2015/02/03 ISID18 ****
*       AND SPRAS = SY-LANGU.
**** BEGIN OF UPD 2015/02/25 ISID18 ****
*       AND SPRAS = P_LANGU.
AND SPRAS = LW_LANGU.
**** END OF UPD 2015/02/25 ISID18 ****
**** END OF UPD 2015/02/03 ISID18 ****
ENDIF.
FREE LTD_ADRC2.
SORT LTD_T005T BY LAND1.

* Edit
CLEAR TH_CUST.
LOOP AT LTD_KNA1 INTO LTH_KNA1.
TH_CUST-KUNNR   = LTH_KNA1-KUNNR.
CLEAR LTH_ADRC.
READ TABLE LTD_ADRC INTO LTH_ADRC
WITH KEY ADDRNUMBER = LTH_KNA1-ADRNR
BINARY SEARCH.
TH_CUST-NAME1      = LTH_ADRC-Z_NAME.       " CustName
TH_CUST-STREET     = LTH_ADRC-Z_ADDRESS1.   " Street
TH_CUST-CITY1      = LTH_ADRC-Z_ADDRESS2.   " city
TH_CUST-STR_SUPPL1 = LTH_ADRC-Z_ADDRESS3.   " Address 3
TH_CUST-STR_SUPPL2 = LTH_ADRC-Z_ADDRESS4.   " Address 4
TH_CUST-TEL_NUMBER = LTH_ADRC-TEL_NUMBER.   " Tel number
TH_CUST-FAX_NUMBER = LTH_ADRC-FAX_NUMBER.   " Fax number
TH_CUST-POST_CODE1 = LTH_ADRC-POST_CODE1.   " Post code
TH_CUST-COUNTRY    = LTH_ADRC-COUNTRY.      " Country
CLEAR LTH_T005T.
READ TABLE LTD_T005T INTO LTH_T005T
WITH KEY LAND1 = LTH_ADRC-COUNTRY
BINARY SEARCH.
TH_CUST-LANDX      = LTH_T005T-LANDX.      " Country Name
APPEND TH_CUST TO TD_CUST.
ENDLOOP.
**** END OF UPD 2015/01/07 ISID18 ****
SORT TD_CUST BY KUNNR.

* Company and customer validation
SELECT KUNNR ZSABE
FROM KNB1
INTO TABLE TD_KNB1
WHERE BUKRS = P_BUKRS
AND KUNNR IN S_KUNNR.
IF SY-SUBRC <> 0.
MESSAGE S002 WITH 'KNB1'
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.
SORT TD_KNB1 BY KUNNR.

* To choose the line item where budat is <= as of date.
SELECT
BUKRS     " Company code
KUNNR     " Customer code
ZUONR     " Assignment Number
BELNR     " Document no.
BUZEI     " Item
BUDAT     " Posting date
BLDAT     " Document date
SHKZG     " Debit/credit flag
ZTERM     " Payment term
PSWSL     " Update Currency
PSWBT     " Amount for Updating
FROM BSID
INTO TABLE TD_BSID
FOR ALL ENTRIES IN TD_KNB1
WHERE BUKRS =  P_BUKRS
AND KUNNR =  TD_KNB1-KUNNR
AND BUDAT <= P_DATE
AND BUDAT IN S_BUDAT
AND BELNR IN S_BELNR.

* To get data from bsad if p_date < sy-datum only
IF P_DATE < SY-DATUM.
SELECT
BUKRS     " Company code
KUNNR     " Customer code
ZUONR     " Assignment Number
BELNR     " Document no.
BUZEI     " Item
BUDAT     " Posting date
BLDAT     " Document date
SHKZG     " Debit/credit flag
ZTERM     " Payment term
PSWSL     " Update Currency
PSWBT     " Amount for Updating
FROM BSAD APPENDING TABLE TD_BSID
FOR ALL ENTRIES IN TD_KNB1
WHERE BUKRS =  P_BUKRS
AND KUNNR =  TD_KNB1-KUNNR
AND BELNR IN S_BELNR
AND XZAHL <> 'X'
AND AUGDT >  P_DATE
AND BUDAT <= P_DATE
AND BUDAT IN S_BUDAT.
ENDIF.

* If no data exist
IF TD_BSID[] IS INITIAL.
MESSAGE S002 WITH 'BSID&BSAD'
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    "read_data
************************************************************************
*      Form  EDIT_DATA
************************************************************************
*      Edit the extracted data
************************************************************************
FORM EDIT_DATA .

DATA:
LW_ZFBDT    TYPE BSEG-ZFBDT,
LW_ZBD1T    TYPE BSEG-ZBD1T,
LTH_I_FAEDE TYPE FAEDE,
LTH_E_FAEDE TYPE FAEDE.

REFRESH TD_EDIT_ITEM.
LOOP AT TD_BSID INTO TH_BSID.
CLEAR TH_EDIT.
MOVE-CORRESPONDING TH_BSID TO TH_EDIT.

*   When assignment number is blank
*   Set document numbet to assignment number
IF TH_EDIT-ZUONR IS INITIAL.
TH_EDIT-ZUONR = TH_EDIT-BELNR.
ENDIF.

*   Set Currency
TH_EDIT-WAERS = TH_BSID-PSWSL.

*   Get baseline date
CALL FUNCTION 'FI_TERMS_OF_PAYMENT_PROPOSE'
EXPORTING
I_BLDAT         = TH_BSID-BLDAT
I_BUDAT         = TH_BSID-BUDAT
I_ZTERM         = TH_BSID-ZTERM
IMPORTING
E_ZBD1T         = LW_ZBD1T
E_ZFBDT         = LW_ZFBDT
EXCEPTIONS
TERMS_NOT_FOUND = 1
OTHERS          = 2.
IF SY-SUBRC <> 0.
MESSAGE E006 WITH 'FI_TERMS_OF_PAYMENT_PROPOSE' SPACE.
ENDIF.

*   Get duedate
CLEAR: LTH_I_FAEDE,
LTH_E_FAEDE.
LTH_I_FAEDE-KOART = CNS_KOART_D.
LTH_I_FAEDE-ZFBDT = LW_ZFBDT.
LTH_I_FAEDE-ZBD1T = LW_ZBD1T.
CALL FUNCTION 'DETERMINE_DUE_DATE'
EXPORTING
I_FAEDE                    = LTH_I_FAEDE
IMPORTING
E_FAEDE                    = LTH_E_FAEDE
EXCEPTIONS
ACCOUNT_TYPE_NOT_SUPPORTED = 1
OTHERS                     = 2.
IF SY-SUBRC = 0.
TH_EDIT-DUEDATE = LTH_E_FAEDE-NETDT.
ELSE.
MESSAGE E006 WITH 'DETERMINE_DUE_DATE' SPACE.
ENDIF.
***** 2016/8/3 ISID18 INS START *****
*    画面で指定した「DueDate」より先のデータを処理対象外とする
IF P_DUE_D IS NOT INITIAL
AND TH_EDIT-DUEDATE > P_DUE_D.
CONTINUE.
ENDIF.
***** 2016/8/3 ISID18 INS END *****
*   Set Debit/Credit amount
CASE TH_BSID-SHKZG.
WHEN CNS_SHKZG_S.
TH_EDIT-DEBIT_AMT = TH_BSID-PSWBT.
WHEN CNS_SHKZG_H.
TH_EDIT-CREDIT_AMT = TH_BSID-PSWBT.
WHEN OTHERS.
ENDCASE.

*   Get balance amount
TH_EDIT-AMOUNT = TH_EDIT-DEBIT_AMT -
TH_EDIT-CREDIT_AMT.
APPEND TH_EDIT TO TD_EDIT_ITEM.
ENDLOOP.
FREE TD_BSID.

ENDFORM.                    " EDIT_DATA
************************************************************************
*     Form  SUM_DATA
************************************************************************
*      Sum of the amount
************************************************************************
FORM SUM_DATA .

DATA:
LW_DEBIT   TYPE BSID-PSWBT,
LW_CREDIT  TYPE BSID-PSWBT,
LW_AMOUNT  TYPE BSID-PSWBT,
LTH_EDIT   TYPE TYP_TH_EDIT,
LTH_EDIT2  TYPE TYP_TH_EDIT,
LTD_EDIT   TYPE STANDARD TABLE OF TYP_TH_EDIT.
***** 2016/8/3 ISID18 INS START *****
DATA:
LTB_NUM3 TYPE STANDARD TABLE OF TYP_NUM3,
LST_NUM3 TYPE TYP_NUM3,
LW_NUM3 TYPE ZTEGFIT002-Z_NUM3,
LW_RECEIPTNO TYPE ZSEGFI0001-Z_RECEIPTNO.
***** 2016/8/3 ISID18 INS END *****

* Sort
SORT TD_EDIT_ITEM
BY BUKRS      "Company code
KUNNR      "Customer code
**** START DEL BY ISID17 2015/05/21 ****
*       ZUONR      " Invoice
**** END DEL BY ISID17 2015/05/21 ****
BUDAT      "Posint date
**** START UPD BY ISID17 2015/05/21 ****
*       BELNR.     "Document no
BELNR             "Document no
**** START UPD 2015/06/15 ISID18 ****
*       BUZEI DESCENDING. "Item
BUZEI.      "Item
**** END UPD 2015/06/15 ISID18 ****
**** END DEL BY ISID17 2015/05/21 ****

LTD_EDIT[] = TD_EDIT_ITEM[].
REFRESH TD_EDIT_SUM[].
CLEAR TH_EDIT.

* Sum by Invioce no
LOOP AT LTD_EDIT INTO LTH_EDIT.
LOOP AT TD_EDIT_ITEM INTO TH_EDIT
WHERE BUKRS = LTH_EDIT-BUKRS
AND KUNNR = LTH_EDIT-KUNNR
AND ZUONR = LTH_EDIT-ZUONR.
LW_DEBIT  = LW_DEBIT + TH_EDIT-DEBIT_AMT.
LW_CREDIT = LW_CREDIT + TH_EDIT-CREDIT_AMT.
LW_AMOUNT = LW_AMOUNT + TH_EDIT-AMOUNT.
ENDLOOP.
CLEAR LTH_EDIT2.
MOVE-CORRESPONDING LTH_EDIT TO LTH_EDIT2.
LTH_EDIT2-DEBIT_AMT  = LW_DEBIT.
LTH_EDIT2-CREDIT_AMT = LW_CREDIT.
LTH_EDIT2-AMOUNT     = LW_AMOUNT.
APPEND LTH_EDIT2 TO TD_EDIT_SUM.
CLEAR: LW_DEBIT,
LW_CREDIT,
LW_AMOUNT.
DELETE LTD_EDIT
WHERE BUKRS = LTH_EDIT-BUKRS
AND KUNNR = LTH_EDIT-KUNNR
AND ZUONR = LTH_EDIT-ZUONR.
ENDLOOP.

SORT TD_EDIT_SUM
BY BUKRS      " Company code
KUNNR      " Customer code
BUDAT      " Posting date
ZUONR      " Invoice
BELNR.     " Document no.

***** 2016/8/3 ISID18 INS START *****
*  今月最大ReceiptNo番号取得
SELECT
Z_NUM3
INTO TABLE LTB_NUM3
FROM ZTEGFIT002
WHERE Z_YEAR = SY-DATUM+3(2)
AND Z_MONTH = SY-DATUM+5(2).

*  今月最大ReceiptNo番号編集
CLEAR LST_NUM3.
SORT LTB_NUM3 BY Z_NUM3 ASCENDING.
READ TABLE LTB_NUM3 INTO LST_NUM3 INDEX 1.
LW_NUM3 = LST_NUM3-Z_NUM3.
***** 2016/8/3 ISID18 INS END *****

REFRESH TD_SFILE.
CLEAR TH_EDIT.
LOOP AT TD_EDIT_SUM INTO TH_EDIT.
CLEAR TH_SFILE.
*   After customer changing
AT NEW KUNNR.
PERFORM KEY_EDIT USING TH_EDIT.
***** 2016/8/3 ISID18 INS START *****
*     採番編集
TRY.
LW_NUM3 = LW_NUM3 + 1.
CATCH CX_SY_ARITHMETIC_OVERFLOW.
LW_NUM3 = 999.
ENDTRY.
*    ReceiptNo編集
CONCATENATE 'R'
SY-DATUM+2(2)  "年
SY-DATUM+4(2)  "月
'/'
LW_NUM3           "採番
INTO LW_RECEIPTNO.
***** 2016/8/3 ISID18 INS END *****
ENDAT.

*   Header edit
PERFORM HEADER_EDIT USING TH_EDIT.

*   Footer edit
PERFORM FOOTER_EDIT.

*   Edit the item
PERFORM ITEM_EDIT USING TH_EDIT.
***** 2016/8/3 ISID18 INS START *****
TH_SFILE-Z_RECEIPTNO = LW_RECEIPTNO.
***** 2016/8/3 ISID18 INS END *****
APPEND TH_SFILE TO TD_SFILE.
ENDLOOP.

* Sort
**** START UPD BY ISID17 2015/05/21 ****
*  SORT TD_SFILE
*    BY Z_CUST_CD         " Customer code
*       CURRENCY          " Currency
*       Z_DUEDATE         " Due date
*       BUDAT             " Posting date
*       Z_INVOICE_NO.     " Invioce no.
SORT TD_SFILE
BY BUKRS              "CompanyCode
Z_CUST_CD          "CustCode
**** START ADD BY ISID REN 2015/06/09 ****
CURRENCY           "Currency
**** START UPD 2015/06/15 ISID18 ****
*       Z_CLOSING_DATE     "ClosingDate
Z_DUEDATE          "DueDate
**** END UPD 2015/06/15 ISID18 ****
**** END ADD BY ISID REN 2015/06/09 ****
BUDAT              "Posting date
**** START DEL BY ISID REN 2015/06/09 ****
*       Z_CLOSING_DATE     "ClosingDate
**** END DEL BY ISID REN 2015/06/09 ****
BELNR.             "AccountDocumentNo.
**** END UPD BY ISID17 2015/05/21 ****

ENDFORM.                    " SUM_DATA
************************************************************************
*      Form  HEADER_EDIT
************************************************************************
*      Header edit
************************************************************************
FORM HEADER_EDIT
USING PTH_EDIT TYPE TYP_TH_EDIT.

DATA LW_CHAR(10) TYPE C.
TH_SFILE-LNAME = P_TRAY.                        " Printer/Tray
**** START ADD 2015/03/23 ISID18 ****
TH_SFILE-BUKRS = P_BUKRS.                       " CompanyCode
**** END ADD 2015/03/23 ISID18 ****
**** START UPD 2015/06/25 ISID18 ****
*  TH_SFILE-Z_COMP_NAME = TH_T001-NAME1.           " CompanyName
*  TH_SFILE-Z_COMP_ADDRESS1 = TH_T001-STREET.      " CompanyAddress1
*  TH_SFILE-Z_COMP_ADDRESS2 = TH_T001-CITY1.       " CompanyAddress2
TH_SFILE-Z_COMP_COUNTRY = TH_T001-LANDX.        " CompanyCountry
TH_SFILE-Z_COMP_POSTCODE = TH_T001-POST_CODE1.  " CompanyPostCode
*  TH_SFILE-Z_COMP_TEL = TH_T001-TEL_NUMBER.       " CompanyTel
*  TH_SFILE-Z_COMP_FAX = TH_T001-FAX_NUMBER.       " CompanyFax
IF P_CNAME IS NOT INITIAL.
TH_SFILE-Z_COMP_NAME = P_CNAME.               " CompanyName
ELSE.
TH_SFILE-Z_COMP_NAME = TH_T001-NAME1.         " CompanyName
ENDIF.
IF P_CADD1 IS NOT INITIAL.
TH_SFILE-Z_COMP_ADDRESS1 = P_CADD1.           " CompanyAddress1
ELSE.
TH_SFILE-Z_COMP_ADDRESS1 = TH_T001-STREET.    " CompanyAddress1
ENDIF.
IF P_CADD2 IS NOT INITIAL.
TH_SFILE-Z_COMP_ADDRESS2 = P_CADD2.           " CompanyAddress2
ELSE.
TH_SFILE-Z_COMP_ADDRESS2 = TH_T001-CITY1.     " CompanyAddress2
ENDIF.
IF P_CTEL IS NOT INITIAL.
TH_SFILE-Z_COMP_TEL = P_CTEL.                 " CompanyTel
ELSE.
TH_SFILE-Z_COMP_TEL = TH_T001-TEL_NUMBER.     " CompanyTel
ENDIF.
IF P_CFAX IS NOT INITIAL.
TH_SFILE-Z_COMP_FAX = P_CFAX.                 " CompanyFax
ELSE.
TH_SFILE-Z_COMP_FAX = TH_T001-FAX_NUMBER.     " CompanyFax
ENDIF.
**** END UPD 2015/06/25 ISID18 ****
TH_SFILE-Z_CLOSING_DATE  = P_DATE.              " Closing date
LW_CHAR = PTH_EDIT-KUNNR.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
TH_SFILE-Z_CUST_CD  = LW_CHAR.                  " CustCode
CLEAR TH_CUST.
READ TABLE TD_CUST INTO TH_CUST
WITH KEY KUNNR = PTH_EDIT-KUNNR
BINARY SEARCH.
TH_SFILE-Z_CUST_NAME     = TH_CUST-NAME1.       " CustName
TH_SFILE-Z_CUST_ADDRESS1 = TH_CUST-STREET.      " CustAddress1
TH_SFILE-Z_CUST_ADDRESS2 = TH_CUST-CITY1.       " CustAddress2
**** START OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_CUST_ADDRESS3 = TH_CUST-STR_SUPPL1.  " CustAddress3
TH_SFILE-Z_CUST_ADDRESS4 = TH_CUST-STR_SUPPL2.  " CustAddress4
**** END OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_CUST_COUNTRY  = TH_CUST-LANDX.       " CustCountry
TH_SFILE-Z_CUST_POSTCODE = TH_CUST-POST_CODE1.  " CustPostCode
CLEAR TH_KNB1.
READ TABLE TD_KNB1 INTO TH_KNB1
WITH KEY KUNNR = PTH_EDIT-KUNNR
BINARY SEARCH.
TH_SFILE-Z_CUST_ATTN  = TH_KNB1-ZSABE.       " Contact person
TH_SFILE-Z_CUST_TEL   = TH_CUST-TEL_NUMBER.  " CustTel
TH_SFILE-Z_CUST_FAX   = TH_CUST-FAX_NUMBER.  " CustFax

ENDFORM.                    " HEADER_EDIT
************************************************************************
*      Form  ITEM_EDIT
************************************************************************
*       Item edit
************************************************************************
FORM ITEM_EDIT
USING PTH_EDIT TYPE TYP_TH_EDIT.

DATA LW_WAERS    TYPE WAERS.
DATA LW_CHAR(20) TYPE C.
TH_SFILE-BUDAT = PTH_EDIT-BUDAT.               " PostingDate
CLEAR LW_CHAR.
LW_CHAR = PTH_EDIT-BELNR.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
TH_SFILE-BELNR = LW_CHAR.                      " DocumentNo
CLEAR LW_CHAR.
LW_CHAR = PTH_EDIT-ZUONR.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
TH_SFILE-Z_INVOICE_NO = LW_CHAR.               " Invoice no
TH_SFILE-Z_DUEDATE  = PTH_EDIT-DUEDATE.        " DueDate
PERFORM CONVERT_CURRENCY
USING    PTH_EDIT-WAERS
CHANGING LW_WAERS.
TH_SFILE-CURRENCY   = LW_WAERS.       " Currency
PERFORM CONVERT_AMOUNT:
USING    LW_WAERS
PTH_EDIT-DEBIT_AMT
CHANGING TH_SFILE-Z_DEBIT,         " Debit
USING    LW_WAERS
PTH_EDIT-CREDIT_AMT
CHANGING TH_SFILE-Z_CREDIT,        " Credit
USING    LW_WAERS
PTH_EDIT-AMOUNT
CHANGING TH_SFILE-Z_AMOUNT.        " Amount

ENDFORM.                    " ITEM_EDIT
************************************************************************
*      Form  FOOTER_EDIT
************************************************************************
*       Footer edit
************************************************************************
FORM FOOTER_EDIT .

TH_SFILE-Z_REMARKS1       = P_REMK1.        " Remark1
TH_SFILE-Z_REMARKS2       = P_REMK2.        " Remark2
TH_SFILE-Z_REMARKS3       = P_REMK3.        " Remark3
TH_SFILE-Z_REMARKS4       = P_REMK4.        " Remark4
TH_SFILE-Z_REMARKS5       = P_REMK5.        " Remark5
TH_SFILE-Z_OUTPUT_USERID  = SY-UNAME.       " User
TH_SFILE-Z_REPORT_FORMAT  = SPACE.          " Report format
**** START OF INS 2015/01/07 ISID18 ****
CALL FUNCTION 'CONVERSION_EXIT_ISOLA_OUTPUT'
EXPORTING
INPUT  = P_LANGU
IMPORTING
OUTPUT = TH_SFILE-Z_REPORT_LANG.
TH_SFILE-Z_REPORT_TITLE = P_TITLE.          " Report Title
**** END OF INS 2015/01/07 ISID18 ****

* Decimal notation
IF P_XDEZP IS NOT INITIAL.
TH_SFILE-XDEZP = P_XDEZP.
ELSE.
TH_SFILE-XDEZP = TH_T001-XDEZP.
ENDIF.
W_XDEZP = TH_SFILE-XDEZP.

* Date format
IF P_DATFM IS INITIAL.
TH_SFILE-DATFM = TH_T001-DATFM.
ELSE.
TH_SFILE-DATFM = P_DATFM.
ENDIF.
W_DATFM = TH_SFILE-DATFM.

ENDFORM.                    " FOOTER_EDIT
************************************************************************
*      Form  KEY_EDIT
************************************************************************
*       Key data edit
************************************************************************
FORM KEY_EDIT
USING PTH_EDIT TYPE TYP_TH_EDIT.

CLEAR TH_KEY.
IF RB_PRINT = 'X' OR
RB_REPNT = 'X'.
TH_KEY-OUTMODE = CNS_MODE_P.
ELSE.
TH_KEY-OUTMODE = CNS_MODE_D.
ENDIF.
TH_KEY-BUKRS     = PTH_EDIT-BUKRS.  " Company code
TH_KEY-KUNNR     = PTH_EDIT-KUNNR.  " Customer code
TH_KEY-CLOSEDATE = P_DATE.          " Closing date
APPEND TH_KEY TO TD_KEY.

ENDFORM.                    " KEY_EDIT
************************************************************************
*      Form  OUTPUT_DATA
************************************************************************
*       File output
************************************************************************
FORM OUTPUT_DATA .

DATA LW_RECORDS TYPE I.
DATA LTD_EDIT_ITEM TYPE STANDARD TABLE OF TYP_TH_EDIT.

* Get server file name
PERFORM GET_SERVER_FILE.

* Sort table
SORT TD_KEY
BY BUKRS         " Company code
KUNNR         " Customer code
CLOSEDATE.    " Closing date

* Sort item table
SORT TD_EDIT_ITEM
BY BUKRS         " Company code
KUNNR         " Customer code
BUDAT         " Posting date
BELNR         " Document no
BUZEI.        " Item

DESCRIBE TABLE TD_EDIT_ITEM LINES W_RECORDS_TOT.
LTD_EDIT_ITEM[] = TD_EDIT_ITEM[].
LOOP AT TD_KEY INTO TH_KEY.
CLEAR W_ERRFLG.
CLEAR LW_RECORDS.
LOOP AT LTD_EDIT_ITEM TRANSPORTING NO FIELDS
WHERE BUKRS = TH_KEY-BUKRS
AND KUNNR = TH_KEY-KUNNR.
LW_RECORDS = LW_RECORDS + 1.
ENDLOOP.

*   Lock table
PERFORM LOCK_TABLE.
IF W_ERRFLG IS NOT INITIAL.
W_RECORDS_ERR = W_RECORDS_ERR + LW_RECORDS.
ENDIF.
CHECK W_ERRFLG IS INITIAL.

*   Update Output Log
PERFORM UPDATE_ZTEGZZT001.
IF W_ERRFLG IS NOT INITIAL.
W_RECORDS_ERR = W_RECORDS_ERR + LW_RECORDS.
ENDIF.
CHECK W_ERRFLG IS INITIAL.

*   Update Output Management(SA)(ZTEGFIT001)
PERFORM UPDATE_ZTEGFIT001.
IF W_ERRFLG IS NOT INITIAL.
W_RECORDS_ERR = W_RECORDS_ERR + LW_RECORDS.
ENDIF.
CHECK W_ERRFLG IS INITIAL.

*   Update Output Work(SA)(ZTEGFIT002)
PERFORM UPDATE_ZTEGFIT002.
IF W_ERRFLG IS NOT INITIAL.
W_RECORDS_ERR = W_RECORDS_ERR + LW_RECORDS.
ELSE.
W_RECORDS_OK = W_RECORDS_OK + LW_RECORDS.
CLEAR TH_MSG.
MESSAGE S011 WITH TH_KEY-KUNNR INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-030.
APPEND TH_MSG TO TD_MSG.
ENDIF.
COMMIT WORK AND WAIT.
PERFORM RELEASE_TABLE.
ENDLOOP.
IF W_ERRFLG IS INITIAL.
CLEAR TH_MSG.
MESSAGE E004 INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-030.
APPEND TH_MSG TO TD_MSG.
ENDIF.

* File Download
PERFORM DOWNLOAD_FILE.

ENDFORM.                    " OUTPUT_DATA
************************************************************************
*      Form  GET_SERVER_FILE
************************************************************************
*       Get server file name
************************************************************************
FORM GET_SERVER_FILE .

DATA:
**** START OF INS 2015/01/07 ISID18 ****
LW_ENCODING  TYPE ABAP_ENCODING,
LW_RC        TYPE I,
**** END OF INS 2015/01/07 ISID18 ****
LW_CODEPAGE  TYPE CPCODEPAGE,
LW_OUTPUT_FN TYPE ZEOUTPUTFN,
LW_FILEPATH  TYPE XUVALUE.

***** 2016/9/8 ISID18 INS START *****
DATA:
LW_REMARK TYPE STRING.
***** 2016/9/8 ISID18 INS END *****

CLEAR: W_OUTPUT_FN,
W_OUTPUT_CP.
IF RB_PRINT = 'X' OR
RB_REPNT = 'X'.
GET PARAMETER ID 'ZSVF' FIELD LW_FILEPATH.
***** 2016/9/8 ISID18 INS START *****
IF P_BUKRS <> 'TH01'.
***** 2016/9/8 ISID18 INS END *****
*   Get filename from ZTEGZZM001
SELECT Z_OUTPUT_FN
Z_OUTPUT_CP
UP TO 1 ROWS
INTO (LW_OUTPUT_FN,W_OUTPUT_CP)
FROM ZTEGZZM001
WHERE PROGNAME       = SY-REPID
AND BUKRS          = P_BUKRS
AND Z_CONV_SUBKEY1 = CNS_REPORT_TYPE.
ENDSELECT.
IF SY-SUBRC <> 0.
MESSAGE S012 WITH 'ZTEGZZM001' SY-REPID
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.

*   Server file name
CONCATENATE LW_FILEPATH
LW_OUTPUT_FN
SY-REPID
SY-UNAME
SY-UZEIT
CNS_TXT
INTO W_OUTPUT_FN.

***** 2016/9/8 ISID18 INS START *****
ELSE.
*    Remark1が空白でない場合、SAP生成されるファイル名の先方は「10」で設定する
IF P_REMK1 IS NOT INITIAL.
LW_REMARK = 1.
*     Remark1が空白の場合、生成されるファイル名は「20」で設定する
ELSE.
LW_REMARK = 2.
ENDIF.

*     Get filename from ZTEGZZM001
SELECT Z_OUTPUT_FN
Z_OUTPUT_CP
UP TO 1 ROWS
INTO (LW_OUTPUT_FN,W_OUTPUT_CP)
FROM ZTEGZZM001
WHERE PROGNAME       = SY-REPID
AND BUKRS          = P_BUKRS
AND Z_CONV_SUBKEY1 = CNS_REPORT_TYPE
AND Z_CONV_SUBKEY2 = LW_REMARK.
ENDSELECT.
IF SY-SUBRC <> 0.
MESSAGE S012 WITH 'ZTEGZZM001' SY-REPID
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.

*   Server file name
CONCATENATE LW_FILEPATH
LW_OUTPUT_FN
SY-UNAME
SY-UZEIT
CNS_TXT
INTO W_OUTPUT_FN.

ENDIF.
***** 2016/9/8 ISID18 INS END *****
ELSE.
W_OUTPUT_FN = P_DFILE.
*   Get GUI codepage
**** START OF UPD 2015/01/07 ISID18 ****
*    CALL FUNCTION 'NLS_GET_FRONTEND_CP'
*      EXPORTING
*        LANGU                 = SY-LANGU
*      IMPORTING
*        FRONTEND_CODEPAGE     = LW_CODEPAGE
*      EXCEPTIONS
*        ILLEGAL_SYST_CODEPAGE = 1
*        NO_FRONTEND_CP_FOUND  = 2
*        INTERNAL_OR_DB_ERROR  = 3
*        OTHERS                = 4.
*    IF SY-SUBRC = 0.
CALL METHOD CL_GUI_FRONTEND_SERVICES=>GET_SAPLOGON_ENCODING
CHANGING
FILE_ENCODING                 = LW_ENCODING
RC                            = LW_RC
EXCEPTIONS
CNTL_ERROR                    = 1
ERROR_NO_GUI                  = 2
NOT_SUPPORTED_BY_GUI          = 3
CANNOT_INITIALIZE_GLOBALSTATE = 4
OTHERS                        = 5.
IF SY-SUBRC = 0.
LW_CODEPAGE = LW_ENCODING.
**** END OF UPD 2015/01/07 ISID18 ****
*     Get description of codepage
CALL FUNCTION 'SCP_CODEPAGE_INFO'
EXPORTING
CODEPAGE  = LW_CODEPAGE
IMPORTING
HTTP_NAME = W_OUTPUT_CP.
ENDIF.
ENDIF.

ENDFORM.                    " GET_SERVER_FILE
************************************************************************
*      Form  LOCK_TABLE
************************************************************************
*       Lock table
************************************************************************
FORM LOCK_TABLE .

* Get outputlog no
PERFORM GET_LOG_NO CHANGING W_LOGNO.

* Lock ZTEGZZT001
CALL FUNCTION 'ENQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = W_LOGNO
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.
RETURN.
ENDIF.

* Lock ZTEGFIT001
CALL FUNCTION 'ENQUEUE_EZZTEGFIT001'
EXPORTING
MODE_ZTEGFIT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = TH_KEY-OUTMODE
BUKRS           = TH_KEY-BUKRS
KUNNR           = TH_KEY-KUNNR
Z_CLOSING_DATE  = TH_KEY-CLOSEDATE
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.

*   Release ZTEGZZT001
CALL FUNCTION 'DEQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = W_LOGNO.
RETURN.
ENDIF.

* Lock ZTEGFIT002
CALL FUNCTION 'ENQUEUE_EZZTEGFIT002'
EXPORTING
MODE_ZTEGFIT002 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = TH_KEY-OUTMODE
BUKRS           = TH_KEY-BUKRS
KUNNR           = TH_KEY-KUNNR
Z_CLOSING_DATE  = TH_KEY-CLOSEDATE
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.

*   Release ZTEGZZT001
CALL FUNCTION 'DEQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = W_LOGNO.

*   Release ZTEGFIT001
CALL FUNCTION 'DEQUEUE_EZZTEGFIT001'
EXPORTING
MODE_ZTEGFIT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = TH_KEY-OUTMODE
BUKRS           = TH_KEY-BUKRS
KUNNR           = TH_KEY-KUNNR
Z_CLOSING_DATE  = TH_KEY-CLOSEDATE.
ENDIF.

ENDFORM.                    " LOCK_TABLE
************************************************************************
*      Form  RELEASE_TABLE
************************************************************************
*       Release table
************************************************************************
FORM RELEASE_TABLE .

* Release ZTEGZZT001
CALL FUNCTION 'DEQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = W_LOGNO.

* Release ZTEGFIT001
CALL FUNCTION 'DEQUEUE_EZZTEGFIT001'
EXPORTING
MODE_ZTEGFIT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = TH_KEY-OUTMODE
BUKRS           = TH_KEY-BUKRS
KUNNR           = TH_KEY-KUNNR
Z_CLOSING_DATE  = TH_KEY-CLOSEDATE.

* Release ZTEGFIT002
CALL FUNCTION 'DEQUEUE_EZZTEGFIT002'
EXPORTING
MODE_ZTEGFIT002 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = TH_KEY-OUTMODE
BUKRS           = TH_KEY-BUKRS
KUNNR           = TH_KEY-KUNNR
Z_CLOSING_DATE  = TH_KEY-CLOSEDATE.

ENDFORM.                    " RELEASE_TABLE
************************************************************************
*      Form  UPDATE_ZTEGZZT001
************************************************************************
*       Update Output Log
************************************************************************
FORM UPDATE_ZTEGZZT001 .

DATA LTH_INSERT   TYPE ZTEGZZT001.
DATA LW_PARA2(30) TYPE C.

CONCATENATE TH_KEY-OUTMODE
TH_KEY-BUKRS
TH_KEY-KUNNR
TH_KEY-CLOSEDATE
INTO LW_PARA2
SEPARATED BY SPACE.
LTH_INSERT-MANDT = SY-MANDT.                  " Client
LTH_INSERT-Z_OUTPUT_LOG_NO = W_LOGNO.         " Logno
LTH_INSERT-PROGNAME = SY-REPID.               " Program
LTH_INSERT-Z_REPORT_NAME = CNS_REPORT_TYPE.   " Report name
LTH_INSERT-Z_OUTPUT_MODE = TH_KEY-OUTMODE.    " Output mode
LTH_INSERT-LNAME = P_TRAY.                    " Output device
LTH_INSERT-Z_OUTPUT_PATH = W_OUTPUT_FN.       " Output file
LTH_INSERT-Z_OUTPUT_CP = W_OUTPUT_CP.         " Codepage
LTH_INSERT-Z_KEY1_TYPE = 'BUKRS'.
LTH_INSERT-Z_KEY1_VALUE = TH_KEY-BUKRS.       " Company code
LTH_INSERT-Z_KEY2_TYPE = 'KUNNR'.
LTH_INSERT-Z_KEY2_VALUE = TH_KEY-KUNNR.       " Customer code
LTH_INSERT-Z_KEY3_TYPE = 'Z_CLOSING_DATE'.
LTH_INSERT-Z_KEY3_VALUE = TH_KEY-CLOSEDATE.   " Closing date
LTH_INSERT-Z_CRE_YMD = SY-DATUM.              " Created date
LTH_INSERT-Z_CRE_HMS = SY-UZEIT.              " Created time
LTH_INSERT-Z_CRE_USERID = SY-UNAME.           " User

* Insert
INSERT INTO ZTEGZZT001 VALUES LTH_INSERT.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE E003 WITH 'ZTEGZZT001'
LW_PARA2
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.
ROLLBACK WORK.
PERFORM RELEASE_TABLE.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGZZT001
************************************************************************
*      Form  UPDATE_ZTEGFIT001
************************************************************************
*       Update Output Management(SA)(ZTEGFIT001)
************************************************************************
FORM UPDATE_ZTEGFIT001 .

DATA LTH_INSERT TYPE ZTEGFIT001.
DATA LW_PARA2(30) TYPE C.

CONCATENATE TH_KEY-OUTMODE
TH_KEY-BUKRS
TH_KEY-KUNNR
TH_KEY-CLOSEDATE
INTO LW_PARA2
SEPARATED BY SPACE.
LTH_INSERT-MANDT = SY-MANDT.                     " Client
LTH_INSERT-Z_OUTPUT_MODE = TH_KEY-OUTMODE.       " Output mode
LTH_INSERT-BUKRS = TH_KEY-BUKRS.                 " Company code
LTH_INSERT-KUNNR = TH_KEY-KUNNR.                 " Customer code
LTH_INSERT-Z_CLOSING_DATE = TH_KEY-CLOSEDATE.    " Closing date
LTH_INSERT-Z_CRE_YMD = SY-DATUM.                 " Created date
LTH_INSERT-Z_CRE_HMS = SY-UZEIT.                 " Created time
LTH_INSERT-Z_CRE_USERID = SY-UNAME.              " User

* Update
MODIFY ZTEGFIT001 FROM LTH_INSERT.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE E003 WITH 'ZTEGFIT001'
LW_PARA2
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.
ROLLBACK WORK.
PERFORM RELEASE_TABLE.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGFIT001
************************************************************************
*     Form  UPDATE_ZTEGFIT002
************************************************************************
*       Update Output Work(SA)(ZTEGFIT002)
************************************************************************
FORM UPDATE_ZTEGFIT002 .

DATA:
LTH_INSERT   TYPE ZTEGFIT002,
LTD_INSERT   TYPE STANDARD TABLE OF ZTEGFIT002,
LW_PARA2(30) TYPE C,
LW_CHAR(20)  TYPE C.
***** 2016/8/3 ISID18 INS START *****
DATA:
LW_KUNNR_OUT TYPE KUNNR,
LST_SFILE TYPE ZSEGFI0001.
***** 2016/8/3 ISID18 INS END *****

CONCATENATE TH_KEY-OUTMODE
TH_KEY-BUKRS
TH_KEY-KUNNR
TH_KEY-CLOSEDATE
INTO LW_PARA2
SEPARATED BY SPACE.

* Delete data
DELETE FROM ZTEGFIT002
WHERE Z_OUTPUT_MODE  = TH_KEY-OUTMODE
AND BUKRS          = TH_KEY-BUKRS
AND KUNNR          = TH_KEY-KUNNR
AND Z_CLOSING_DATE = TH_KEY-CLOSEDATE.
IF SY-SUBRC <> 0 AND
SY-SUBRC <> 4.
CLEAR TH_MSG.
MESSAGE E007 WITH 'ZTEGFIT002'
LW_PARA2
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.
ROLLBACK WORK.
PERFORM RELEASE_TABLE.
RETURN.
ENDIF.

LOOP AT TD_EDIT_ITEM INTO TH_EDIT
WHERE BUKRS = TH_KEY-BUKRS
AND KUNNR = TH_KEY-KUNNR.
CLEAR LTH_INSERT.
LTH_INSERT-MANDT = SY-MANDT.                   " Client
LTH_INSERT-Z_OUTPUT_MODE = TH_KEY-OUTMODE.     " Output mode
LTH_INSERT-BUKRS = TH_KEY-BUKRS.               " Company code
LTH_INSERT-KUNNR = TH_KEY-KUNNR.               " Customer code
LTH_INSERT-Z_CLOSING_DATE = TH_KEY-CLOSEDATE.  " Closing date
LTH_INSERT-BUDAT = TH_EDIT-BUDAT.              " Posting date
LTH_INSERT-BELNR = TH_EDIT-BELNR.              " Document no.
LTH_INSERT-BUZEI = TH_EDIT-BUZEI.              " Item no.
LTH_INSERT-LNAME = P_TRAY.                     " Printer/Tray
**** START UPD 2015/06/25 ISID18 ****
*    LTH_INSERT-Z_COMPANY_NAME = TH_T001-NAME1.     " CompanyName
*    LTH_INSERT-Z_COMPANY_ADDR1 = TH_T001-STREET.   " CompanyAddress1
*    LTH_INSERT-Z_COMPANY_ADDR2 = TH_T001-CITY1.    " CompanyAddress2
*    LTH_INSERT-Z_COMPANY_TEL = TH_T001-TEL_NUMBER. " CompanyTel
*    LTH_INSERT-Z_COMPANY_FAX = TH_T001-FAX_NUMBER. " CompanyFax
IF P_CNAME IS NOT INITIAL.
LTH_INSERT-Z_COMPANY_NAME = P_CNAME.           " CompanyName
ELSE.
LTH_INSERT-Z_COMPANY_NAME = TH_T001-NAME1.     " CompanyName
ENDIF.
IF P_CADD1 IS NOT INITIAL.
LTH_INSERT-Z_COMPANY_ADDR1 = P_CADD1.          " CompanyAddress1
ELSE.
LTH_INSERT-Z_COMPANY_ADDR1 = TH_T001-STREET.   " CompanyAddress1
ENDIF.
IF P_CADD2 IS NOT INITIAL.
LTH_INSERT-Z_COMPANY_ADDR2 = P_CADD2.          " CompanyAddress2
ELSE.
LTH_INSERT-Z_COMPANY_ADDR2 = TH_T001-CITY1.    " CompanyAddress2
ENDIF.
IF P_CTEL IS NOT INITIAL.
LTH_INSERT-Z_COMPANY_TEL = P_CTEL.             " CompanyTel
ELSE.
LTH_INSERT-Z_COMPANY_TEL = TH_T001-TEL_NUMBER. " CompanyTel
ENDIF.
IF P_CFAX IS NOT INITIAL.
LTH_INSERT-Z_COMPANY_FAX = P_CFAX.             " CompanyFax
ELSE.
LTH_INSERT-Z_COMPANY_FAX = TH_T001-FAX_NUMBER. " CompanyFax
ENDIF.
**** END UPD 2015/06/25 ISID18 ****
LTH_INSERT-Z_COMPANY_POST = TH_T001-POST_CODE1." CompanyPostcode

CLEAR TH_CUST.
READ TABLE TD_CUST INTO TH_CUST
WITH KEY KUNNR = TH_KEY-KUNNR
BINARY SEARCH.
LTH_INSERT-Z_CUST_NAME = TH_CUST-NAME1.        " CustomerName
LTH_INSERT-Z_ADDRESS1 = TH_CUST-STREET.        " CustomerAddress1
LTH_INSERT-Z_ADDRESS2 = TH_CUST-CITY1.         " CustomerAddress2
**** START OF INS 2015/01/07 ISID18 ****
LTH_INSERT-Z_ADDRESS3 = TH_CUST-STR_SUPPL1.    " CustomerAddress3
LTH_INSERT-Z_ADDRESS4 = TH_CUST-STR_SUPPL2.    " CustomerAddress4
**** END OF INS 2015/01/07 ISID18 ****
LTH_INSERT-Z_CUST_POST = TH_CUST-POST_CODE1.   " CustomerPostcode
CLEAR TH_KNB1.
READ TABLE TD_KNB1 INTO TH_KNB1
WITH KEY KUNNR = TH_KEY-KUNNR
BINARY SEARCH.
LTH_INSERT-ZSABE = TH_KNB1-ZSABE.              " ContactPerson
LTH_INSERT-Z_CUST_TEL = TH_CUST-TEL_NUMBER.    " CustomerTel
LTH_INSERT-Z_CUST_FAX = TH_CUST-FAX_NUMBER.    " CustomerFax
LTH_INSERT-COUNTRY = TH_CUST-COUNTRY.          " CustomerCountryID
LTH_INSERT-LANDX = TH_CUST-LANDX.              " CustomerCountryNm
CLEAR LW_CHAR.
LW_CHAR = TH_EDIT-ZUONR.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
LTH_INSERT-Z_INVOICE_NO = LW_CHAR.             " InvoiceNo.
LTH_INSERT-Z_DUE_DATE = TH_EDIT-DUEDATE.       " Duedate
LTH_INSERT-SHKZG = TH_EDIT-SHKZG.              " Debit/credit flag
LTH_INSERT-ZTERM = TH_EDIT-ZTERM.              " Payment term
PERFORM CONVERT_CURRENCY
USING    TH_EDIT-WAERS
CHANGING LTH_INSERT-WAERS.                  " Currency
LTH_INSERT-Z_DEBIT = TH_EDIT-DEBIT_AMT.        " Debit
LTH_INSERT-Z_CREDIT = TH_EDIT-CREDIT_AMT.      " Credit
LTH_INSERT-Z_AMOUNT = TH_EDIT-AMOUNT.          " Amount
LTH_INSERT-Z_SA_REMARKS1 = P_REMK1.            " Remark1
LTH_INSERT-Z_SA_REMARKS2 = P_REMK2.            " Remark2
LTH_INSERT-Z_SA_REMARKS3 = P_REMK3.            " Remark3
LTH_INSERT-Z_SA_REMARKS4 = P_REMK4.            " Remark4
LTH_INSERT-Z_SA_REMARKS5 = P_REMK5.            " Remark5
LTH_INSERT-Z_OUTPUT_USERID = SY-UNAME.         " Output User
LTH_INSERT-XDEZP = W_XDEZP.                    " Decimal notation
LTH_INSERT-DATFM = W_DATFM.                    " Date Format
LTH_INSERT-Z_REPORT_FORMAT = SPACE.            " Report format
**** START OF INS 2015/01/07 ISID18 ****
LTH_INSERT-Z_REPORT_LANG  = P_LANGU.           " Report Language
LTH_INSERT-Z_REPORT_TITLE = P_TITLE.           " Report Title
**** END OF INS 2015/01/07 ISID18 ****
LTH_INSERT-Z_CRE_YMD = SY-DATUM.               " Created date
LTH_INSERT-Z_CRE_HMS = SY-UZEIT.               " Created time
LTH_INSERT-Z_CRE_USERID = SY-UNAME.            " Created user
***** 2016/8/3 ISID18 INS START *****
*    年月編集
LTH_INSERT-Z_YEAR = SY-DATUM+2(2).
LTH_INSERT-Z_MONTH = SY-DATUM+4(2).
*    ReceiptNo編集
CLEAR:
LST_SFILE,
LW_KUNNR_OUT.
*    得意先コード外部値変換
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT         = TH_KEY-KUNNR
IMPORTING
OUTPUT     = LW_KUNNR_OUT.
*    採番番号編集
READ TABLE TD_SFILE INTO LST_SFILE
WITH KEY Z_CUST_CD = LW_KUNNR_OUT.
IF LST_SFILE-Z_RECEIPTNO IS NOT INITIAL.
LTH_INSERT-Z_NUM3 = LST_SFILE-Z_RECEIPTNO+6(3).
ENDIF.
***** 2016/8/3 ISID18 INS END *****
APPEND LTH_INSERT TO LTD_INSERT.
ENDLOOP.

* insert
INSERT ZTEGFIT002 FROM TABLE LTD_INSERT.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE E003 WITH 'ZTEGFIT002'
LW_PARA2
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
W_ERRFLG = 'X'.
ROLLBACK WORK.
PERFORM RELEASE_TABLE.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGFIT002
************************************************************************
*      Form  DOWNLOAD_FILE
************************************************************************
*       Download file
************************************************************************
FORM DOWNLOAD_FILE .

DATA:
LW_SFILE     TYPE STRING,
LW_OUTPUT_CP TYPE STRING,
LW_CODEPAGE  TYPE ABAP_ENCODING,
LW_CDUTF8    TYPE ABAP_ENCODING,
LW_SEPARATOR TYPE CHAR01.

LW_OUTPUT_CP = W_OUTPUT_CP.
LW_CDUTF8 = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( 'UTF-8' ).
LW_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( LW_OUTPUT_CP ).
CASE 'X'.
WHEN RB_PRINT
OR RB_REPNT.
IF LW_CODEPAGE = LW_CDUTF8.
OPEN DATASET W_OUTPUT_FN FOR OUTPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ELSE.
OPEN DATASET W_OUTPUT_FN FOR OUTPUT
IN LEGACY TEXT MODE
CODE PAGE LW_CODEPAGE
IGNORING CONVERSION ERRORS.
ENDIF.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE E008 WITH W_OUTPUT_FN
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
ELSE.
LOOP AT TD_SFILE INTO TH_SFILE.
CONCATENATE TH_SFILE-LNAME            " Printer/tray
**** START ADD 2015/03/23 ISID18 ****
TH_SFILE-BUKRS            " CompanyCode
**** END ADD 2015/03/23 ISID18 ****
TH_SFILE-Z_COMP_NAME      " CompanyName
TH_SFILE-Z_COMP_ADDRESS1  " CompanyAddress1
TH_SFILE-Z_COMP_ADDRESS2  " CompanyAddress2
TH_SFILE-Z_COMP_COUNTRY   " CompanyCountry
TH_SFILE-Z_COMP_POSTCODE  " CompanyPostcode
TH_SFILE-Z_COMP_TEL       " CompanyTel
TH_SFILE-Z_COMP_FAX       " CompanyAFax
TH_SFILE-Z_CLOSING_DATE   " Closing date
TH_SFILE-Z_CUST_CD        " CustomerCode
TH_SFILE-Z_CUST_NAME      " CustomerName
TH_SFILE-Z_CUST_ADDRESS1  " CustomerAddress1
TH_SFILE-Z_CUST_ADDRESS2  " CustomerAddress2
**** START OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_CUST_ADDRESS3  " CustomerAddress3
TH_SFILE-Z_CUST_ADDRESS4  " CustomerAddress4
**** END OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_CUST_COUNTRY   " CustomerCountry
TH_SFILE-Z_CUST_POSTCODE  " CustomerPostcode
TH_SFILE-Z_CUST_ATTN      " CustomerContacePerson
TH_SFILE-Z_CUST_TEL       " CustomerTel
TH_SFILE-Z_CUST_FAX       " CustomerFax
TH_SFILE-BUDAT            " PostingDate
TH_SFILE-BELNR            " DocumentNo.
TH_SFILE-Z_INVOICE_NO     " InvoiceNo.
TH_SFILE-Z_DUEDATE        " DueDate
TH_SFILE-Z_DEBIT          " Debit
TH_SFILE-Z_CREDIT         " Credit
TH_SFILE-CURRENCY         " Currency
TH_SFILE-Z_AMOUNT         " Amount
TH_SFILE-Z_REMARKS1       " Remark1
TH_SFILE-Z_REMARKS2       " Remark2
TH_SFILE-Z_REMARKS3       " Remark3
TH_SFILE-Z_REMARKS4       " Remark4
TH_SFILE-Z_REMARKS5       " Remark5
TH_SFILE-Z_OUTPUT_USERID  " User
TH_SFILE-XDEZP            " Decimal notation
TH_SFILE-DATFM            " Date format
TH_SFILE-Z_REPORT_FORMAT  " Report format
**** START OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_REPORT_LANG    " Report Language
TH_SFILE-Z_REPORT_TITLE   " Report Title
**** END OF INS 2015/01/07 ISID18 ****
***** 2016/8/3 ISID18 INS START *****
TH_SFILE-Z_RECEIPTNO   " ReceiptNo
***** 2016/8/3 ISID18 INS END *****
INTO LW_SFILE
SEPARATED BY CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
TRANSFER LW_SFILE TO W_OUTPUT_FN.
ENDLOOP.
CLOSE DATASET W_OUTPUT_FN.
CLEAR TH_MSG-TEXT.
MESSAGE S010 INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-030.
APPEND TH_MSG TO TD_MSG.
ENDIF.
WHEN RB_DOWNL.
PERFORM SET_HEADER_LINE.
LW_SEPARATOR = CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
CALL FUNCTION 'GUI_DOWNLOAD'
EXPORTING
FILENAME                = W_OUTPUT_FN
FILETYPE                = 'ASC'
WRITE_FIELD_SEPARATOR   = LW_SEPARATOR
CODEPAGE                = LW_CODEPAGE
TABLES
DATA_TAB                = TD_SFILE
EXCEPTIONS
FILE_WRITE_ERROR        = 1
NO_BATCH                = 2
GUI_REFUSE_FILETRANSFER = 3
INVALID_TYPE            = 4
NO_AUTHORITY            = 5
UNKNOWN_ERROR           = 6
HEADER_NOT_ALLOWED      = 7
SEPARATOR_NOT_ALLOWED   = 8
FILESIZE_NOT_ALLOWED    = 9
HEADER_TOO_LONG         = 10
DP_ERROR_CREATE         = 11
DP_ERROR_SEND           = 12
DP_ERROR_WRITE          = 13
UNKNOWN_DP_ERROR        = 14
ACCESS_DENIED           = 15
DP_OUT_OF_MEMORY        = 16
DISK_FULL               = 17
DP_TIMEOUT              = 18
FILE_NOT_FOUND          = 19
DATAPROVIDER_EXCEPTION  = 20
CONTROL_FLUSH_ERROR     = 21
OTHERS                  = 22.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE E009 INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
ELSE.
MESSAGE S010 INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-030.
APPEND TH_MSG TO TD_MSG.
ENDIF.
WHEN OTHERS.
ENDCASE.

ENDFORM.                    " DOWNLOAD_FILE

************************************************************************
*      Form  WRITE_OUT
************************************************************************
*       Write result screen
************************************************************************
FORM WRITE_OUT .

DATA:
LW_MODE(10) TYPE C,
LRH_KUNNR   LIKE LINE OF S_KUNNR,
LRH_BELNR   LIKE LINE OF S_BELNR,
LRH_BUDAT   LIKE LINE OF S_BUDAT,
LW_TEXT(23) TYPE C,
LW_KUNNR    TYPE STRING,
LW_BELNR    TYPE STRING,
LW_BUDAT    TYPE STRING.

* Mode
CASE 'X'.
WHEN RB_PRINT.
LW_MODE = TEXT-002.
WHEN RB_REPNT.
LW_MODE = TEXT-003.
WHEN RB_DOWNL.
LW_MODE = TEXT-004.
WHEN OTHERS.
ENDCASE.

* Customer code
LOOP AT S_KUNNR INTO LRH_KUNNR.
CLEAR LW_TEXT.
CONCATENATE LRH_KUNNR-SIGN
LRH_KUNNR-OPTION
LRH_KUNNR-LOW
LRH_KUNNR-HIGH
INTO LW_TEXT.
CONCATENATE LW_KUNNR
LW_TEXT
INTO LW_KUNNR
SEPARATED BY '/'.
SHIFT LW_KUNNR LEFT DELETING LEADING '/'.
ENDLOOP.

* Document no.
LOOP AT S_BELNR INTO LRH_BELNR.
CLEAR LW_TEXT.
CONCATENATE LRH_BELNR-SIGN
LRH_BELNR-OPTION
LRH_BELNR-LOW
LRH_BELNR-HIGH
INTO LW_TEXT.
CONCATENATE LW_BELNR
LW_TEXT
INTO LW_BELNR
SEPARATED BY '/'.
SHIFT LW_BELNR LEFT DELETING LEADING '/'.
ENDLOOP.

* Posting date
LOOP AT S_BUDAT INTO LRH_BUDAT.
CLEAR LW_TEXT.
CONCATENATE LRH_BUDAT-SIGN
LRH_BUDAT-OPTION
LRH_BUDAT-LOW
LRH_BUDAT-HIGH
INTO LW_TEXT.
CONCATENATE LW_BUDAT
LW_TEXT
INTO LW_BUDAT
SEPARATED BY '/'.
SHIFT LW_BUDAT LEFT DELETING LEADING '/'.
ENDLOOP.

SKIP 2.
WRITE: /1 TEXT-018,         " Parameters
/3 TEXT-019,         " Mode
28 ':',
32 LW_MODE,
/3 TEXT-020,         " Company code
28 ':',
32 P_BUKRS,
/3 TEXT-021,         " Customer code
28 ':',
32 LW_KUNNR,
/3 TEXT-022,         " Closing date
28 ':',
32 P_DATE,
/3 TEXT-023,         " Document no.
28 ':',
32 LW_BELNR,
/3 TEXT-031,
28 ':',
32 LW_BUDAT,         " Posint date
/3 TEXT-024,         " File Name
28 ':',
32 W_OUTPUT_FN.

SKIP 2.
WRITE: /1 TEXT-025,         " Result
/3 TEXT-026,         " Number of Transactions
28 ':',
32 W_RECORDS_TOT,
/3 TEXT-027,         " Number of Normal
28 ':',
32 W_RECORDS_OK,
/3 TEXT-028,         " Number of Errors
28 ':',
32 W_RECORDS_ERR.

SKIP 2.
WRITE: /1 TEXT-029.
LOOP AT TD_MSG INTO TH_MSG.
WRITE: /4  TH_MSG-TYPE,   " Message type
25 TH_MSG-TEXT.   " Message text
ENDLOOP.

ENDFORM.                    " WRITE_OUT
************************************************************************
*      Form  GET_LOG_NO
************************************************************************
*       Get output log no
************************************************************************
*      <--P_LOGNO  logno
************************************************************************
FORM GET_LOG_NO
CHANGING P_LOGNO TYPE ZEOUTPUTLOGNO.

CLEAR P_LOGNO.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = '01'
OBJECT                  = 'ZEGZZ0001'
IMPORTING
NUMBER                  = P_LOGNO
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 4
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
BUFFER_OVERFLOW         = 7
OTHERS                  = 8.
IF SY-SUBRC <> 0.
CLEAR TH_MSG.
MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO TH_MSG-TEXT.
TH_MSG-TYPE = TEXT-011.
APPEND TH_MSG TO TD_MSG.
ENDIF.

ENDFORM.                    " GET_LOG_NO
************************************************************************
*      Form  SET_HEADER_LINE
************************************************************************
*       Set header text in local file
************************************************************************
FORM SET_HEADER_LINE .

DATA LW_STR TYPE STRING.

**** START OF INS 2015/02/25 ISID18 ****
DATA LW_LANGU TYPE SY-LANGU.
IF P_LANGU IS NOT INITIAL.
LW_LANGU = P_LANGU.
ELSE.
LW_LANGU = SY-LANGU.
ENDIF.
**** END OF INS 2015/02/25 ISID18 ****

* Get Header text.
CALL FUNCTION 'ZEG_ZZ_DD04T_GET'
EXPORTING
IMPTSNAME    = 'ZSEGFI0001'
**** BEGIN OF UPD 2015/02/03 ISID18 ****
*      IMPLANGU     = SY-LANGU
**** BEGIN OF UPD 2015/02/25 ISID18 ****
*      IMPLANGU     = P_LANGU
IMPLANGU     = LW_LANGU
**** END OF UPD 2015/02/25 ISID18 ****
**** END OF UPD 2015/02/03 ISID18 ****
IMPORTING
EXPSCRTEXT_L = LW_STR.

CLEAR TH_SFILE.
SPLIT LW_STR AT CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB
INTO TH_SFILE-LNAME            " Printer/tray
**** START ADD 2015/03/23 ISID18 ****
TH_SFILE-BUKRS            " CompanyCode
**** END ADD 2015/03/23 ISID18 ****
TH_SFILE-Z_COMP_NAME      " CompanyName
TH_SFILE-Z_COMP_ADDRESS1  " CompanyAddress1
TH_SFILE-Z_COMP_ADDRESS2  " CompanyAddress2
TH_SFILE-Z_COMP_COUNTRY   " CompanyCountry
TH_SFILE-Z_COMP_POSTCODE  " CompanyPostcode
TH_SFILE-Z_COMP_TEL       " CompanyTel
TH_SFILE-Z_COMP_FAX       " CompanyAFax
TH_SFILE-Z_CLOSING_DATE   " Closing date
TH_SFILE-Z_CUST_CD        " CustomerCode
TH_SFILE-Z_CUST_NAME      " CustomerName
TH_SFILE-Z_CUST_ADDRESS1  " CustomerAddress1
TH_SFILE-Z_CUST_ADDRESS2  " CustomerAddress2
**** START OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_CUST_ADDRESS3  " CustomerAddress3
TH_SFILE-Z_CUST_ADDRESS4  " CustomerAddress4
**** END OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_CUST_COUNTRY   " CustomerCountry
TH_SFILE-Z_CUST_POSTCODE  " CustomerPostcode
TH_SFILE-Z_CUST_ATTN      " CustomerContacePerson
TH_SFILE-Z_CUST_TEL       " CustomerTel
TH_SFILE-Z_CUST_FAX       " CustomerFax
TH_SFILE-BUDAT            " PostingDate
TH_SFILE-BELNR            " DocumentNo.
TH_SFILE-Z_INVOICE_NO     " InvoiceNo.
TH_SFILE-Z_DUEDATE        " DueDate
TH_SFILE-Z_DEBIT          " Debit
TH_SFILE-Z_CREDIT         " Credit
TH_SFILE-CURRENCY         " Currency
TH_SFILE-Z_AMOUNT         " Amount
TH_SFILE-Z_REMARKS1       " Remark1
TH_SFILE-Z_REMARKS2       " Remark2
TH_SFILE-Z_REMARKS3       " Remark3
TH_SFILE-Z_REMARKS4       " Remark4
TH_SFILE-Z_REMARKS5       " Remark5
TH_SFILE-Z_OUTPUT_USERID  " User
TH_SFILE-XDEZP            " Decimal notation
TH_SFILE-DATFM            " Date format
TH_SFILE-Z_REPORT_FORMAT  " Report format
**** START OF INS 2015/01/07 ISID18 ****
TH_SFILE-Z_REPORT_LANG    " Report Language
TH_SFILE-Z_REPORT_TITLE.  " Report Title
**** END OF INS 2015/01/07 ISID18 ****
INSERT TH_SFILE INTO TD_SFILE INDEX 1.

ENDFORM.                    " SET_HEADER_LINE
************************************************************************
*      Form  CONVERT_AMOUNT
************************************************************************
*      Covert amount to display
************************************************************************
*      -->P_WAERS     Currency
*      -->P_IN_AMT   Internal amount
*      <--P_OUT_AMT  External amount
************************************************************************
FORM CONVERT_AMOUNT
USING    P_WAERS   TYPE BSID-PSWSL
P_IN_AMT  TYPE BSID-PSWBT
CHANGING P_OUT_AMT TYPE STRING.

DATA LW_AMOUNT(20) TYPE C.

* convert the format of amount
CLEAR LW_AMOUNT.
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = P_WAERS
SAP_AMOUNT  = P_IN_AMT
IMPORTING
IDOC_AMOUNT = LW_AMOUNT.

**** START ADD 2015/02/25 ISID18 ****
CALL FUNCTION 'CLOI_PUT_SIGN_IN_FRONT'
CHANGING
VALUE = LW_AMOUNT.
CONDENSE LW_AMOUNT NO-GAPS.
**** END ADD 2015/02/25 ISID18 ****

P_OUT_AMT = LW_AMOUNT.

ENDFORM.                    " CONVERT_AMOUNT
************************************************************************
*      Form  CONVERT_CURRENCY
************************************************************************
*       Convert currency
************************************************************************
*      -->P_IN_WAERS   CURRENCY BEFORE CONVERTING
*      <--P_OUT_WAERS  CURRENCY AFTER CONVERTING
************************************************************************
FORM CONVERT_CURRENCY
USING    P_IN_WAERS  TYPE WAERS
CHANGING P_OUT_WAERS TYPE WAERS.

CLEAR P_OUT_WAERS.
SELECT SINGLE Z_WAERS
INTO P_OUT_WAERS
FROM ZTEGZZM002
WHERE WAERS = P_IN_WAERS.
IF SY-SUBRC <> 0.
P_OUT_WAERS = P_IN_WAERS.
ENDIF.

ENDFORM.                    " CONVERT_CURRENCY
************************************************************************
*      Form  HEADER_OUT
************************************************************************
*     Header Output
************************************************************************
FORM HEADER_OUT .

* タイトル表題設定
SET TITLEBAR 'GUI_TITLE_2000'.

WRITE:  1 TEXT-012,         " Client
10 ':',
13 SY-MANDT,
130 TEXT-013,         " Date
136 ':',
139 SY-DATLO.
WRITE: /1 TEXT-014,         " Program
10 ':',
13 SY-REPID,
130 TEXT-015,         " Time
136 ':',
139 SY-TIMLO.
WRITE: /1 TEXT-016,         " User
10 ':',
13 SY-UNAME,
60 TEXT-017.

ENDFORM.                    " HEADER_OUT
*Text symbol text・
*001:Mode
*002:Print
*003:Reprint
*004:Download
*005:Print Option
*006:Download Option
*007:Source Data
*008:Report Parameter
*009:Printer/Tray
*010:File Path
*011:[Error]
*012:CLIENT
*013:Date
*014:PROGRAM
*015:Time
*016:USER
*017:<<<Statement　of Account Report Output>>>
*018:<Parameters>
*019:Mode
*020:Company Code
*021:Customer Code
*022:Closing Date
*023:Document No.
*024:File Name
*025:<Result>
*026:Number of Transcations
*027:Number of Normal
*028:Number of Errors
*029:<Message>
*030:[Information]
*031:Posting Date
*Selection text・
*P_BUKRS:        Company code
*P_CADD1:        Company Address1
*P_CADD2:        Company Address2
*P_CFAX:        Company Fax
*P_CNAME:        Company Name
*P_CTEL:        Company Tel
*P_DATE:        Closing date
*P_DATFM:        Date Format
*P_DFILE:        File Path
*P_DUE_D:        Due Date
*P_LANGU:        Report Language
*P_REMK1:        Remark1
*P_REMK2:        Remark2
*P_REMK3:        Remark3
*P_REMK4:        Remark4
*P_REMK5:        Remark5
*P_TITLE:        Report Title
*P_TRAY:        Printer/Tray
*P_XDEZP:        Dec.pt.format
*RB_DOWNL:        Download
*RB_PRINT:        Print
*RB_REPNT:        Reprint
*S_BELNR:        Document No.
*S_BUDAT:        Posting Date
*S_KUNNR:        Customer code
