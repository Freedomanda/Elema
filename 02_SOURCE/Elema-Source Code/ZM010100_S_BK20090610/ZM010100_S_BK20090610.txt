************************************************************************
* [プログラム名]
*   ZM010100        発注残一覧
*
* [処理概要]
*   ・発注残の管理帳票の出力
*
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2001/10/31   PSD M.Arai        新規開発　
*  2001/11/26   PSD M.Arai        受注番号抽出条件変更対応
*  2001/12/12   PSD M.Arai        直送区分追加対応
*  2001/12/25   PSD M.Arai        ページ番号対応
*  2001/12/25   PSD M.Arai        ヘッダ表示不具合対応
*  2001/12/25   PSD M.Arai        入力チェック方法変更
*  2002/03/11   PSD M.Arai        返品発注対応
*  2002/04/22   PSD T.SAITOH      レポートＩＤ間違いを修正
*  2002/04/24   PSD T.SAITOH      「発注止め」の発注伝票を対象外
*  2002/04/24   PSD T.SAITOH      選択条件の追加
*  2002/04/24   PSD T.SAITOH      発注番号表示編集内容変更
*  2002/05/27   PSD K.ARAI        パフォーマンス対応
*  2002/06/20   PSD T.SAITOH      再移送
*  2002/06/28   PSD T.SAITOH      購買組織追加
*  2002/07/09   PSD T.SAITOH      購買組織（初期値：ユーザーパラメータ）
*  2002/08/08   カットオーバー ----------------------------------------
*  2002/08/09   PSD T.SAITOH      仕入先ではなく手配先を表示する
*  2002/09/06   PSD T.SAITOH      帳票の行間を開けるように変更
*  2003/04/30   NDSC S.IWAKI      パフォーマンス対応
*  2004/01/20   DMC M.SEIWA       ALV化
*  2004/01/26   DMC M.SEIWA       ALVの文字列不具合対応
*  2004/07/13   DMC K.FURUYA      品名の取得先変更(MAKT -> EKPO)
*  2005/02/16   DMC A.MASUDA      登録者名の項目追加
*  2005/07/05   DMC A.MASUDA      登録者出力不具合のバグ修正
*  2005/10/06   DMC A.MASUDA      ７月修正分の不具合のバグ修正
*  2005/10/07   DMC A.MASUDA      バッチインプットデータにもユーザの抽出
*                                 条件の反映を行った
*  2008/04/23   DMC               1.発注残一覧に仕入先品目コードを
*                                   表示する(EKPO-IDNLF)
*                                 2.NASTを読み込む条件に下記条件を
*                                   追加する(aktiv NE 'X')
************************************************************************
*---MODIFY START PSD T.SAITOH 2002/04/22 ---------------------------*
* REPORT  zzsttd30_001 NO STANDARD PAGE HEADING
REPORT ZM010100 NO STANDARD PAGE HEADING
*---MODIFY END   PSD T.SAITOH 2002/04/22 ---------------------------*
LINE-SIZE  170
LINE-COUNT 58.

************************************************************************
* TYPES
************************************************************************
TYPE-POOLS SLIS.

* 購買伝票情報
TYPES: BEGIN OF TYP_INFO,
EBELN     TYPE EKKO-EBELN,      " 購買伝票番号
BSART     TYPE EKKO-BSART,      " 購買伝票タイプ
EKGRP     TYPE EKKO-EKGRP,      " 購買グループ
*         LLIEF     TYPE EKKO-LLIEF,     "
BEDAT     TYPE EKKO-BEDAT,      " 購買伝票日付
LIFNR     TYPE EKKO-LIFNR,      " 仕入先勘定コード
RESWK     TYPE EKKO-RESWK,      " 供給（出庫）プラント
WAERS     TYPE EKKO-WAERS,      " 通貨
EBELP     TYPE EKPO-EBELP,      " 購買伝票明細番号
WERKS     TYPE EKPO-WERKS,      " プラント
MATNR     TYPE EKPO-MATNR,      " 品目コード
MENGE     TYPE EKPO-MENGE,      " 購買発注数量
NETPR     TYPE EKPO-NETPR,      " 正味価格
PEINH     TYPE EKPO-PEINH,      " 価格単位
BANFN     TYPE EKPO-BANFN,      " 購買依頼番号
BNFPO     TYPE EKPO-BNFPO,      " 購買依頼明細番号
KNTTP     TYPE EKPO-KNTTP,      " 勘定伝票カテゴリ
*↓APPEND 2001/12/12 PSD M.Arai 直送区分追加対応
EVERS     TYPE EKPO-EVERS,      " 出荷指示
*↑APPEND 2001/12/12 PSD M.Arai
NAME1     TYPE V_T001W-NAME1,   " プラント名
EKNAM     TYPE T024-EKNAM,      " 購買グループテキスト
*---2004/07/13 MOD START
*         maktx     TYPE makt-maktx,      " 品目テキスト
TXZ01     TYPE EKPO-TXZ01,      " 品目テキスト
*---2004/07/13 MOD END
*---APPEND START PSD T.SAITOH 2002/08/09 ---------------------------*
EKORG     TYPE EKKO-EKORG,      " 購買グループ
*---APPEND END   PSD T.SAITOH 2002/08/09 ---------------------------*
* Add  2005.08.24 --->
LABNR     TYPE EKPO-LABNR ,     "請書番号
* Add  2005.08.24 <---
* BEGIN OF ADD BY DMC 2008/04/23
IDNLF     TYPE EKPO-IDNLF,      "仕入先品目コー
* END OF ADD BY DMC 2008/04/23
END   OF TYP_INFO.

* 帳票出力用データ
TYPES: BEGIN OF TYP_WRITE,
WERKS     TYPE EKPO-WERKS,      " 部門
NAME1     TYPE V_T001W-NAME1,   " 部門名
EKGRP     TYPE EKKO-EKGRP,      " 担当者
EKNAM     TYPE T024-EKNAM,      " 担当者名
ZTEHAI    TYPE EKKO-LIFNR,      " 手配先
ZNAME(35) TYPE C,               " 手配先名
EINDT     TYPE EKET-EINDT,      " 発注納期
BEDAT     TYPE EKKO-BEDAT,      " 発注日
ZNUM(15)  TYPE C,               " 発注番号
MATNR     TYPE EKPO-MATNR,      " 品目コード
*---2004/07/13 MOD START
*         maktx     TYPE makt-maktx,      " 品目テキスト
TXZ01     TYPE EKPO-TXZ01,      " 品目テキスト
*---2004/07/13 MOD END
MENGE     TYPE EKPO-MENGE,      " 発注数
WEMNG     TYPE EKPO-MENGE,      " 入荷数
ZENGE     TYPE EKPO-MENGE,      " 未納数
ZANS(14)  TYPE C,               " 納期回答
VBELN     TYPE EBKN-VBELN,      " 受注番号
ZMNY      TYPE P,               " 未納入金額
EBELN     TYPE EKPO-EBELN,      " 伝票番号(ソート用）
EBELP     TYPE EKPO-EBELP,      " 伝票明細(ソート用）
*↓APPEND 2001/12/12 PSD M.Arai 直送区分追加追加対応
EVERS     TYPE EKPO-EVERS,      " 直送区分
*↑APPEND 2001/12/12 PSD M.Arai
*---APPEND START DMC A.MASUDA 2005/02/16 ---------------------------*
TNAME(14) TYPE C,               " 担当者名
*---APPEND END   DMC A.MASUDA 2005/02/16 ---------------------------*
* Add  2005.08.24 --->
LABNR     TYPE EKPO-LABNR ,     "請書番号
* Add  2005.08.24 <---

END   OF TYP_WRITE.


*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
TYPES: BEGIN OF TYP_NAST,
KAPPL     TYPE NAST-KAPPL,      " アプリケーション
OBJKY     TYPE NAST-OBJKY,      " 対象キー
KSCHL     TYPE NAST-KSCHL,      " メッセージタイプ
SPRAS     TYPE NAST-SPRAS,      " メッセージ言語
PARNR     TYPE NAST-PARNR,      " メッセージ取引先
ERDAT     TYPE NAST-ERDAT,      " パートナー機能
ERUHR     TYPE NAST-ERUHR,      " 登録日
NACHA     TYPE NAST-NACHA,      " 登録時間
VSTAT     TYPE NAST-VSTAT,      " 処理ステータス
END OF TYP_NAST.
* NAST内部テーブル
DATA: GT_NAST TYPE HASHED TABLE OF TYP_NAST
WITH UNIQUE KEY KAPPL
OBJKY
KSCHL
SPRAS
PARNR
ERDAT
ERUHR
NACHA
VSTAT.
DATA GF_NAST TYPE TYP_NAST.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
DATA:G_VBELN LIKE EKKN-VBELN.
DATA:FLG_TEC TYPE C.
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*
************************************************************************
* DATA
************************************************************************
* 内部テーブル
* 伝票情報内部テーブル
DATA: GF_INFO    TYPE          TYP_INFO,
GT_INFO    LIKE TABLE OF GF_INFO.
**2004.01.20 MOD_S SEIWA
* 帳票出力内部テーブル
*DATA: gf_write   TYPE         typ_write,
DATA: GF_WRITE   TYPE          ZSLIST_V20,
GT_WRITE   LIKE TABLE OF GF_WRITE.
**2004.01.20 MOD_E SEIWA

* 納入日程行内部テーブル
DATA: GF_EKET    TYPE          EKET,
GT_EKET    LIKE TABLE OF GF_EKET.

* 総合計
DATA: G_SUM      TYPE P.
** 2004.01.20 MOD_S seiwa >>>>>>>

*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
* 登録者名内部テーブル
DATA: GF_EKKO    TYPE          EKKO,
GT_EKKO    LIKE TABLE OF GF_EKKO.
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*

*---APPEND START DMC A.MASUDA  2005/10/07 -----------------------------*
* ユーザー名格納用構造
TYPES:
BEGIN OF TYP_NAME,
NAME_TEXT TYPE ADRP-NAME_TEXT,
END   OF TYP_NAME.
* ユーザー名格納用テーブル
DATA:
GT_NAME_TEXT TYPE STANDARD TABLE OF TYP_NAME,
GW_NAME_TEXT TYPE TYP_NAME.
*---APPEND END   DMC A.MASUDA  2005/10/07 -----------------------------*

************************************************************************
* CONSTANTS
************************************************************************
DATA:CNS_X(1)       TYPE C VALUE 'X'.
*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
CONSTANTS:CNS_X_2(1)       TYPE C VALUE 'X',
CNS_VE(2)      TYPE C VALUE 'VE',
CNS_BATCH(8)   TYPE C VALUE 'WF-BATCH',
CNS_EDIAD(8)   TYPE C VALUE 'EDIADMIN',
CNS_TEC0000(7) TYPE C VALUE 'TEC0000'.
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*
************************************************************************
* 　DATA　ALV GRID CONTROL
*********************************************************************
* REUSE_ALV_EVENTS_GET 用[一覧タイプに使用可能イベントの返品テーブル]
DATA:G_REPID       LIKE SY-REPID,                  "現在のプログラムID
G_TOP_OF_PAGE TYPE SLIS_FORMNAME VALUE 'TOP_OF_PAGE',
GF_LAYOUT     TYPE SLIS_LAYOUT_ALV,          "レイアウト
GF_VARIANT    LIKE DISVARIANT,               "バリアント
GF_PRINT      TYPE SLIS_PRINT_ALV,           "印刷拒否
GF_EVENT      TYPE SLIS_ALV_EVENT,           "イベント設定
G_DATA        TYPE SY-DATUM.                 "システム日付

DATA:G_FLG_EXIT(1)  TYPE C VALUE '0'.     " ＬＯＯＰ終了フラグ


*　ALV表示用内部テーブル
DATA:GT_ALV        TYPE TABLE OF ZSLIST_V20  WITH HEADER LINE.
DATA:GF_ALV        TYPE ZSLIST_V20.

*　イベント設定内部テーブル
DATA:GT_EVENT      TYPE SLIS_T_EVENT.
** 2004.01.20 MOD_E　seiwa >>>>>>>

************************************************************************
* 選択画面定義
************************************************************************
*↓DELETE 2001/12/25 PSD M.Arai 入力チェック変更対応
*SELECT-OPTIONS: pr_werks FOR gf_info-werks OBLIGATORY,  " プラント
*↑DELETE 2001/12/25 PSD M.Arai

*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
* 購買組織対応
PARAMETERS: PR_EKORG TYPE EKKO-EKORG MEMORY ID EKO OBLIGATORY."購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*

*↓APPEND 2001/12/25 PSD M.Arai 入力チェック変更対応
SELECT-OPTIONS: PR_WERKS FOR GF_INFO-WERKS,              " プラント
*↑APPEND 2001/12/25 PSD M.Arai
PR_EKGRP FOR GF_INFO-EKGRP               " 購買グループ
.
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
SELECT-OPTIONS: PR_LIFNR FOR GF_INFO-LIFNR,              " 仕入先
PR_EINDT FOR GF_EKET-EINDT               " 納入期日
.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
SELECT-OPTIONS: PR_ERNAM FOR GF_EKKO-ERNAM.          " ユーザーコード
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*
************************************************************************
* AT SELECTION-SCREEN
************************************************************************
*↓APPEND 2001/12/25 PSD M.Arai 入力チェック変更対応
AT SELECTION-SCREEN.
IF PR_WERKS IS INITIAL AND
SY-UCOMM+0(1) <> '%'.
MESSAGE E006(Z1) WITH TEXT-119.
ENDIF.
*↑APPEND 2001/12/25 PSD M.Arai
*---APPEND START DMC A.MASUDA 2005/10/07 ------------------------------*
PERFORM FRM_CHECK_NAME_DATA.
*---APPEND END   DMC A.MASUDA 2005/10/07 ------------------------------*
************************************************************************
* START-OF-SELECTION
************************************************************************
START-OF-SELECTION.
*　2004.01.20　MOD_S
*--- 初期処理
PERFORM FRM_INIT.
*　2004.01.20　MOD_E

* 対象データ抽出処理
PERFORM FRM_GET_DATA.
* 帳票出力用内部テーブル作成処理
PERFORM FRM_MAKE_DATA.
*2004.01.20 DELETE_S
* 帳票出力処理
*  PERFORM frm_write_data.
*2004.01.20 DELETE_E

*---2004.01.20 MOD_S
* ALV 帳票出力
PERFORM WRITE_OUT.
*--2004.01.20　MOD_E
************************************************************************
* TOP-OF-PAGE
***********************************************************************
*--2004.01.20　MOD_S "動的コール
FORM FRM_TOP_OF_PAGE.
*TOP-OF-PAGE.
*--- ヘッダー出力処理
*--　ALV　の場合
*
WRITE:   42      TEXT-100,            " 表題
92      TEXT-101,            " 作成日時
101     SY-DATUM DD/MM/YY,   " 日付
110     SY-UZEIT+0(2),       " 時間
112     ':',
113     SY-UZEIT+2(2),       " 分
150     TEXT-118,            " PAGE
156(6)  SY-PAGNO,
/92      TEXT-102,            " 部門
97(4)   GT_ALV-WERKS,        " 部門コード
103(20) GT_ALV-NAME1,      " 部門名
126     TEXT-103,
133(4)  GT_ALV-EKGRP,      " 担当者コード
138(18) GT_ALV-EKNAM.      " 担当者名

WRITE:  /97(26)  SY-ULINE,
133(23) SY-ULINE.





**2004.01.20 DELETE＿S
**--　帳票　の場合
*  FORMAT COLOR OFF.
*  WRITE:   42      text-100,
*           92      text-101,
*           101     sy-datum DD/MM/YY,   " 日付
*           110     sy-uzeit+0(2),       " 時間
*           112     ':',
*           113     sy-uzeit+2(2),       " 分
**↓APPEND 2001/12/25 PSD M.Arai ページ番号対応
*           150     text-118,
*           156(6)  sy-pagno,
**↑APPEND 2001/12/25 PSD M.Arai
*          /92      text-102,
*           97(4)   gf_write-werks,      " 部門コード
*           103(20) gf_write-name1,      " 部門名
*           126     text-103,
*           133(4)  gf_write-ekgrp,      " 担当者コード
*           138(18) gf_write-eknam.      " 担当者名
*  FORMAT COLOR OFF.
*
*  WRITE:  /97(26)  sy-uline,
*           133(23) sy-uline.
*
*  FORMAT COLOR 1 ON.
*
*  WRITE:  /1       text-104,
*           11      text-106,
*           20      text-107,
*           36      text-108,
*           55      text-109,
*           98      text-110,
*           109     text-111,
*           120     text-112,
*           130     text-113,
*           144     text-114,
**↓APPEND 2001/12/12 M.Arai 直送区分追加対応
*           154     text-117.
**↑APPEND 2001/12/12 M.Arai
**↓DELETE 2001/12/12 M.Arai 直送区分追加対応
**           155     ' '.
**↑DELETE 2001/12/12 M.Arai
*
*  FORMAT COLOR OFF.
**↓APPEND 2001/12/12 M.Arai 直送区分追加対応
*  WRITE: /1(161) sy-uline.
**↑APPEND 2001/12/12 M.Arai
*
**↓DELETE 2001/12/12 M.Arai 直送区分追加対応
**  WRITE: /1(155)  sy-uline.
**↑DELETE 2001/12/12 M.Arai
*  FORMAT COLOR OFF.
*ENDIF.
*
*2004.01.20　DELETE_E
ENDFORM.
*2004.01.20 MOD_E
************************************************************************
* Form
***********************************************************************
*  2004.01.20 MOD_S
*&---------------------------------------------------------------------*
*& **** Form  FRM_INIT  ALV CALLER_EXIT 動的コール
*&---------------------------------------------------------------------*
FORM FRM_CALLER_EXIT USING RS_DATA TYPE SLIS_DATA_CALLER_EXIT.
RS_DATA-CALLBACK_HEADER_TRANSPORT = 'FILITEXTS_TEXT_TRANSPORT'.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  FRM_INIT  初期処理
*&---------------------------------------------------------------------*
FORM FRM_INIT.
G_REPID             = SY-REPID.   " プログラムＩＤ取得
G_DATA              = SY-DATUM.   " システム日付取得
ENDFORM.                    " FRM_INIT
*---2004.01.20 MOD_E
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_data
*&---------------------------------------------------------------------*
*       対象データ抽出処理
*----------------------------------------------------------------------*
FORM FRM_GET_DATA.

SELECT
A~EBELN   A~BSART   A~EKGRP   A~LIFNR   A~BEDAT
A~RESWK   A~WAERS
B~EBELP   B~WERKS   B~MATNR   B~MENGE   B~NETPR
*    b~peinh   b~banfn   b~bnfpo   b~knttp
*↓APPEND 2001/12/12 PSD M.Arai 直送区分追加のため
B~PEINH   B~BANFN   B~BNFPO   B~KNTTP   B~EVERS
*↑APPEND 2001/12/12 PSD M.Arai
C~EKNAM
*2004/07/13 MOD START
*    d~maktx   d~matnr
B~TXZ01   D~MATNR
*2004/07/13 MOD END
E~NAME1
*---APPEND START PSD T.SAITOH 2002/08/09 ---------------------------*
A~EKORG "購買組織
*---APPEND END   PSD T.SAITOH 2002/08/09 ---------------------------*
* Add 2005.08.24 --->
B~LABNR
* Add 2005.08.24 <---
* BEGIN OF ADD BY DMC 2008/04/23
B~IDNLF  "仕入先品目コード
* END OF ADD BY DMC 2008/04/23
INTO CORRESPONDING FIELDS OF TABLE GT_INFO
FROM  ( ( ( EKKO AS A INNER JOIN EKPO AS B
ON     A~EBELN  = B~EBELN ) LEFT OUTER JOIN T024      AS C
ON     A~EKGRP  = C~EKGRP ) INNER      JOIN MAKT      AS D
ON     B~MATNR  = D~MATNR ) LEFT OUTER JOIN T001W     AS E
ON     B~WERKS  = E~WERKS
*---APPEND START PSD T.SAITOH 2002/06/28 ---------------------------*
*    WHERE    a~ekgrp IN pr_ekgrp
WHERE    A~EKORG = PR_EKORG  "購買組織
AND      A~EKGRP IN PR_EKGRP
*---APPEND END   PSD T.SAITOH 2002/06/28 ---------------------------*
AND      B~WERKS IN PR_WERKS
AND    ( B~KNTTP = ''
OR       B~KNTTP = 'M' )
AND      B~ELIKZ = ''
AND      B~LOEKZ = ''
AND      A~LOEKZ = ''
AND      D~SPRAS = 'J'
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
AND      A~LIFNR IN PR_LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
.

* エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE S600(Z1) WITH TEXT-006.
STOP.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH TEXT-002 TEXT-003 SY-SUBRC.
STOP.
ENDCASE.

ENDFORM.                    " FRM_GET_data
*
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*       帳票出力用内部テーブル作成処理
*----------------------------------------------------------------------*
FORM FRM_MAKE_DATA.
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
DATA : L_NODATA_FROM_EKET TYPE C."納入日程行データ無し時のリターン
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

LOOP AT GT_INFO INTO GF_INFO.
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
* NASTに発注止めが存在した場合対象外とする
PERFORM FRM_NAST_CHECK.
IF SY-SUBRC = 0.
CONTINUE.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

* 購買伝票情報テーブルを帳票出力用内部テーブルに設定
MOVE-CORRESPONDING GF_INFO TO GF_WRITE.

* ↓ APPEND 2002.03.12 PSD M.ARAI 返品発注対応
* 発注数量の設定
PERFORM FRM_SET_MENGE.
* ↑

* 手配先名称の設定
PERFORM FRM_SET_TEHAINAME.

* 発注納期、入荷数の設定
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
*    PERFORM frm_set_noki_inptdata.
CLEAR L_NODATA_FROM_EKET.
PERFORM FRM_SET_NOKI_INPTDATA CHANGING L_NODATA_FROM_EKET.
IF L_NODATA_FROM_EKET <> 0.
CONTINUE.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

* 未納数の設定
PERFORM FRM_SET_MINOU.

* 発注番号の設定
PERFORM FRM_SET_HNUM.

* 納期回答の設定
PERFORM FRM_SET_ANS.

* 受注番号の設定
PERFORM FRM_SET_JNUM.

* 未納入金額の設定
PERFORM FRM_SET_MINOUNYUU.

*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
* 販売管理伝票番号の設定
PERFORM FRM_SET_VBELN USING    GF_INFO-EBELN          " 購買伝票
GF_INFO-EBELP          " 購買伝票明細
CHANGING G_VBELN.               " 販売管理伝票
* 販売管理伝票番号、明細が存在しない場合は、在庫品で処理
IF G_VBELN = SPACE.
* 購買伝票ヘッダ(EKKO)の登録者から担当者名の取得
PERFORM FRM_SET_EKKO_ERNAM USING    GF_INFO-EBELN   " 購買伝票
CHANGING GF_WRITE-TNAME. " 担当者名
* 販売管理伝票番号、明細が存在した場合は、個別購買で処理
ELSE.
* 販売伝票ヘッダ(VBAK)の登録者から担当者名の取得
PERFORM FRM_SET_VBAK_ERNAM USING    G_VBELN         " 販売管理伝票
CHANGING GF_WRITE-TNAME. " 担当者名
* 取得された担当者名が 'WF-BATCH' の場合
IF GF_WRITE-TNAME+0(8) = CNS_BATCH
OR GF_WRITE-TNAME+0(8) = CNS_EDIAD
*---APPEND START DMC A.MASUDA 2005/10/06 ---------------------------*
OR GF_WRITE-TNAME+0(7) = CNS_TEC0000.
*---APPEND END   DMC A.MASUDA 2005/10/06 ---------------------------*
CLEAR:GF_WRITE-TNAME.
* 営業員コードから担当者名の取得
PERFORM FRM_SET_PERNR USING    G_VBELN            " 販売管理伝票
CHANGING GF_WRITE-TNAME.    " 担当者名
ENDIF.
ENDIF.
* 担当者名取得時
IF ( GF_WRITE-TNAME <> SPACE ) OR
( GF_WRITE-TNAME = SPACE    AND FLG_TEC = CNS_X_2 ).
* 帳票用内部テーブルにレコード追加
APPEND GF_WRITE TO GT_WRITE.
ENDIF.

*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*

* 帳票用内部テーブルにレコード追加
*    APPEND gf_write TO gt_write.

CLEAR GF_INFO.
CLEAR GF_WRITE.
ENDLOOP.

* ソート処理
SORT GT_WRITE ASCENDING BY WERKS   " 部門
EKGRP   " 担当者
ZTEHAI  " 手配先
EINDT   " 発注納期
BEDAT   " 発注日
EBELN   " 発注番号
EBELP   " 明細番号
*                             znum.   " 発注番号
.

ENDFORM.                    " FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*&      Form  frm_write_data
*&---------------------------------------------------------------------*
*       帳票出力処理
*----------------------------------------------------------------------*
*FORM frm_write_data.
*2004.01.20 DELETE_S
*  DATA: lf_break_point(17) TYPE c,              " ﾌﾞﾚｲｸﾎﾟｲﾝﾄ判別用項目
*        lf_tmp_break_point LIKE lf_break_point, " テンプ
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        tmp_write LIKE gf_write,
*        gf_write_org LIKE gf_write.
**↑APPEND 2001/12/25 PSD M.Arai

*
**---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
** ０件処理追加
*  DATA: l_cnt_rec TYPE i."出力用内部テーブルレコード件数
*  DESCRIBE TABLE gt_write LINES l_cnt_rec.
*  IF l_cnt_rec = 0.
*    MESSAGE s600(z1) WITH text-006.
*    STOP.
*  ENDIF.
**---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
*

** 帳票出力処理
*  LOOP AT gt_write INTO gf_write.
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*    gf_write_org = gf_write.
**↑APPEND 2001/12/25 PSD M.Arai
*
** ブレイクポイント判別用項目設定
*    lf_break_point+0(4)  = gf_write-werks.   " 部門
*    lf_break_point+4(3)  = gf_write-ekgrp.   " 担当者
*    lf_break_point+7(10) = gf_write-ztehai.  " 手配先
*
*    IF sy-tabix <> 1.
** 担当者ブレイク時
*      IF lf_break_point+0(7) <> lf_tmp_break_point+0(7).
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = tmp_write.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_break_tehai.       " 手配先合計出力
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = gf_write_org.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_break_tanto.       " 改ページ
*        PERFORM frm_write_tehai.       " 手配先ヘッダ出力
** 手配先ブレイク時
*      ELSEIF lf_break_point <> lf_tmp_break_point.
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = tmp_write.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_break_tehai.       " 手配先合計出力
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = gf_write_org.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_write_tehai.       " 手配先ヘッダ出力
*      ENDIF.
*    ELSE.
*      PERFORM frm_write_tehai.          " 手配先ヘッダ出力
*    ENDIF.
*
** 明細行出力
*    PERFORM frm_write_meisai.
*
*    lf_tmp_break_point = lf_break_point. " ブレイク項目の退避
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*    tmp_write = gf_write.
**↑APPEND 2001/12/25 PSD M.Arai
* ENDLOOP.


*  PERFORM frm_break_tehai.   " 手配先合計出力

*ENDFORM.                    " frm_write_data
*--2004.01.20 DELETE_E

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_TEHAINAME
*&---------------------------------------------------------------------*
*       手配先名取得
*----------------------------------------------------------------------*
FORM FRM_SET_TEHAINAME.

* 購買伝票タイプによる手配先名抽出処理
* ↓ MODIFY 2002.03.12 PSD M.ARAI 返品発注対応
*  IF gf_info-bsart = 'NB'.
IF GF_INFO-BSART = 'NB' OR
GF_INFO-BSART = 'ZB'.
* ↑
" 仕入先コード設定
CALL FUNCTION 'Z_MZERO_DELETE'
EXPORTING
CHANGE_STRING = GF_INFO-LIFNR
IMPORTING
STRING        = GF_WRITE-ZTEHAI.
.

*---APPEND START PSD T.SAITOH 2002/08/09 ---------------------------*
* カットオーバー後仕様変更：EKPAから取引先機能OA(BA・・DB上)で取得
* 手配先を取得
SELECT SINGLE LIFN2
INTO GF_INFO-LIFNR
FROM EKPA
WHERE EBELN = GF_INFO-EBELN
AND EBELP = 0
AND EKORG = GF_INFO-EKORG
AND PARVW = 'BA'."手配先'OA':ＤＢ上は'BA'
*   エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH TEXT-002 'EKPA' SY-SUBRC.
ENDCASE.
*---APPEND END   PSD T.SAITOH 2002/08/09 ---------------------------*

*    " 仕入先マスタ抽出処理
SELECT SINGLE NAME1 FROM LFA1
INTO GF_WRITE-ZNAME
WHERE LIFNR = GF_INFO-LIFNR.
* エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-007.
WHEN OTHERS.
MESSAGE A603(Z1) WITH TEXT-002 TEXT-004 SY-SUBRC.
ENDCASE.

ELSE.
"プラントコード設定
GF_WRITE-ZTEHAI = GF_INFO-RESWK.

" プラント抽出処理
SELECT SINGLE NAME1
INTO GF_WRITE-ZNAME
FROM T001W
WHERE WERKS = GF_INFO-RESWK.

* エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-008.
WHEN OTHERS.
MESSAGE A603(Z1) WITH TEXT-002 TEXT-005 SY-SUBRC.
ENDCASE.

ENDIF.


ENDFORM.                    " FRM_SET_TEHAINAME
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_NOKI_INPTDATA
*&---------------------------------------------------------------------*
*       納期、入荷数の設定
*----------------------------------------------------------------------*
* <-- NODATA_FROM_EKET EKETテーブル読込みのリターン値
*----------------------------------------------------------------------*
FORM FRM_SET_NOKI_INPTDATA CHANGING P_NODATA_FROM_EKET.

DATA: L_SUM TYPE EKET-WEMNG.

* 納期、入庫数量の取得
SELECT WEMNG EINDT FROM EKET
INTO CORRESPONDING FIELDS OF TABLE GT_EKET
WHERE EBELN = GF_INFO-EBELN
AND   EBELP = GF_INFO-EBELP
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
AND   EINDT IN PR_EINDT
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*---MODIFY START PSD T.SAITOH 2002/04/24 ---------------------------*
*      MESSAGE s600(z1) WITH text-009.
P_NODATA_FROM_EKET = SY-SUBRC.
EXIT.
*---MODIFY END   PSD T.SAITOH 2002/04/24 ---------------------------*
WHEN OTHERS.
MESSAGE A603(Z1) WITH TEXT-002 TEXT-010 SY-SUBRC.
ENDCASE.

* 総入庫数の設定処理
LOOP AT GT_EKET INTO GF_EKET.
L_SUM = L_SUM + GF_EKET-WEMNG.
ENDLOOP.
* ↓ MODIFY 2002.03.12 PSD M.ARAI 返品発注対応
*  gf_write-wemng = l_sum.
IF GF_INFO-BSART = 'ZB'.
GF_WRITE-WEMNG = L_SUM * ( -1 ).   " 返品発注
ELSE.
GF_WRITE-WEMNG = L_SUM.            " 通常
ENDIF.
* ↑
* 明細納入期日の設定
READ TABLE GT_EKET INTO GF_EKET INDEX 1.
GF_WRITE-EINDT = GF_EKET-EINDT.

ENDFORM.                    " FRM_SET_NOKI_INPTDATA
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MINOU
*&---------------------------------------------------------------------*
*       未納数の設定
*----------------------------------------------------------------------*
FORM FRM_SET_MINOU.

GF_WRITE-ZENGE = GF_WRITE-MENGE - GF_WRITE-WEMNG.

ENDFORM.                    " FRM_SET_MINOU
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_HNUM
*&---------------------------------------------------------------------*
*       発注番号の設定
*----------------------------------------------------------------------*
FORM FRM_SET_HNUM.

*---MODIFY START PSD T.SAITOH 2002/04/24 ---------------------------*
GF_WRITE-ZNUM+0(2)  = GF_INFO-WERKS+1(2).  "プラント
GF_WRITE-ZNUM+2(1)  = '-'.
*  gf_write-znum+3(8)  = gf_info-ebeln+2(8).  "購買伝票番号
GF_WRITE-ZNUM+3(10)  = GF_INFO-EBELN.      "購買伝票番号
*  gf_write-znum+11(1) = '-'.
*  gf_write-znum+12(3) = gf_info-ebelp+2(3).  "購買伝票明細番号
GF_WRITE-ZNUM+13(1) = '-'.
GF_WRITE-ZNUM+14(1) = GF_INFO-EBELP+3(1).  "購買伝票明細番号
*---MODIFY END   PSD T.SAITOH 2002/04/24 ---------------------------*

ENDFORM.                    " FRM_SET_HNUM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_ANS
*&---------------------------------------------------------------------*
*       納期回答の設定
*----------------------------------------------------------------------*
FORM FRM_SET_ANS.

DATA: L_NAME   TYPE THEAD-TDNAME,
LT_TLINE TYPE TABLE OF TLINE,
LF_TLINE TYPE          TLINE.

* テキスト名称の設定
CONCATENATE GF_INFO-EBELN GF_INFO-EBELP INTO L_NAME.

* 納期回答情報の取得
CALL FUNCTION 'READ_TEXT'
EXPORTING
*      CLIENT                        = SY-MANDT
ID                            = 'F04'
LANGUAGE                      = 'J'
NAME                          = L_NAME
OBJECT                        = 'EKPO'
*     ARCHIVE_HANDLE                = 0
*     LOCAL_CAT                     = ' '
*   IMPORTING
*     HEADER                        =
TABLES
LINES                         = LT_TLINE
EXCEPTIONS
ID                            = 1
LANGUAGE                      = 2
NAME                          = 3
NOT_FOUND                     = 4
OBJECT                        = 5
REFERENCE_CHECK               = 6
WRONG_ACCESS_TO_ARCHIVE       = 7
OTHERS                        = 8
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
MESSAGE S001(Z1) WITH TEXT-011 SY-SUBRC.
ENDCASE.

* 納期回答の設定
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
GF_WRITE-ZANS+0(1)  = '('.
GF_WRITE-ZANS+1(12) = LF_TLINE-TDLINE+0(12).
GF_WRITE-ZANS+13(1) = ')'.

ENDFORM.                    " FRM_SET_ANS
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_JNUM
*&---------------------------------------------------------------------*
*       受注番号の設定
*----------------------------------------------------------------------*
FORM FRM_SET_JNUM.

IF GF_INFO-KNTTP = 'M'.

* ↓DELETE 2001/11/26 PSD M.Arai 受注番号抽出条件変更対応
*    SELECT SINGLE vbeln FROM ebkn
*      INTO CORRESPONDING FIELDS OF gf_write
*      WHERE banfn = gf_info-banfn
*      AND   bnfpo = gf_info-bnfpo
*      AND   zebkn = '01'
*      AND   loekz = ''.
* ↑DELETE 2001/11/26 PSD M.Arai

* ↓APPEND 2001/11/26 PSD M.Arai
*---2003/04/30 UPDATE START S.IWAKI(NDSC)
*    SELECT SINGLE a~vbeln
*      INTO CORRESPONDING FIELDS OF gf_write
*      FROM ebkn AS a INNER JOIN eban AS b
*      ON   a~banfn = b~banfn
*      AND  a~bnfpo = b~bnfpo
*      WHERE b~ebeln = gf_info-ebeln
*      AND   b~ebelp = gf_info-ebelp
*      AND   a~zebkn = '01'
*      AND   a~loekz = ''.
SELECT SINGLE A~VBELN
INTO CORRESPONDING FIELDS OF GF_WRITE
FROM ( EBKN AS A INNER JOIN EBAN AS B
ON   A~BANFN = B~BANFN
AND  A~BNFPO = B~BNFPO )
INNER JOIN EKET AS C
ON   A~BANFN = C~BANFN
AND  A~BNFPO = C~BNFPO
WHERE C~EBELN = GF_INFO-EBELN
AND   C~EBELP = GF_INFO-EBELP
AND   C~ETENR = '0001'
AND   A~ZEBKN = '01'
AND   A~LOEKZ = ''.
*---2003/04/30 UPDATE END   S.IWAKI(NDSC)
* ↑APPEND 2001/11/26 PSD M.Arai

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE S603(Z1) WITH TEXT-002 TEXT-012 SY-SUBRC.
STOP.
ENDCASE.
ENDIF.

ENDFORM.                    " FRM_SET_JNUM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MINOUNYUU
*&---------------------------------------------------------------------*
*       未納入金の設定
*----------------------------------------------------------------------*
FORM FRM_SET_MINOUNYUU.

DATA L_NETPR(255) TYPE N.

CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = GF_INFO-WAERS
SAP_AMOUNT  = GF_INFO-NETPR
IMPORTING
IDOC_AMOUNT = L_NETPR.

GF_WRITE-ZMNY = GF_WRITE-ZENGE * L_NETPR / GF_INFO-PEINH.

ENDFORM.                    " FRM_SET_MINOUNYUU
**&---------------------------------------------------------------------
*
**&      Form  FRM_WRITE_MEISAI
**&---------------------------------------------------------------------
*
**       明細行出力
**----------------------------------------------------------------------
*
*FORM frm_write_meisai.
*
*  FORMAT COLOR 2 INTENSIFIED OFF.
*  WRITE: /2       gf_write-eindt DD/MM/YY,       "発注納期
*          11      gf_write-bedat DD/MM/YY,       "発注日
*          20      gf_write-znum.                 "発注番号
*
*  FORMAT COLOR 2 INTENSIFIED OFF.
*
*  WRITE:  36      gf_write-matnr,                "品目コード
*          56      gf_write-maktx,                "品名
*          96(11)  gf_write-menge DECIMALS 2,     "発注数
*          107(11) gf_write-wemng DECIMALS 2,     "入荷数
*          118(11) gf_write-zenge DECIMALS 2,     "未納数
*          129     gf_write-zans,                 "納期回答
*          144     gf_write-vbeln,                "受注番号
**↓APPEND 2001/12/12 M.Arai 直送区分追加対応
*          157     gf_write-evers,                "直送区分
*          161     ' '.
**↑APPEND 2001/12/12 M.Arai 直送区分追加対応
**↓DELETE 2001/12/12 M.Arai 直送区分追加対応
**          155     ' '.
**↑DELETE 2001/12/12 M.Arai
**---APPEND START PSD T.SAITOH 2002/09/06 ---------------------------*
*   SKIP 1.
**---APPEND END   PSD T.SAITOH 2002/09/06 ---------------------------*
* FORMAT COLOR OFF.
*
** 手配先合計計算処理
*  g_sum = g_sum + gf_write-zmny.
*
*ENDFORM.                    " FRM_WRITE_MEISAI
*&---------------------------------------------------------------------*
*&      Form  frm_break_tanto
*&---------------------------------------------------------------------*
*       担当名ブレイク時処理
*----------------------------------------------------------------------*
FORM FRM_BREAK_TANTO.

NEW-PAGE.

ENDFORM.                    " frm_break_tanto
*&---------------------------------------------------------------------*
*&      Form  frm_break_tehai
*&---------------------------------------------------------------------*
*       手配先合計出力
*----------------------------------------------------------------------*
FORM FRM_BREAK_TEHAI.

SKIP.

FORMAT COLOR 3 ON INTENSIFIED OFF.
WRITE: /101  TEXT-115,
112  G_SUM,
161  ' '.
FORMAT COLOR OFF.
CLEAR G_SUM.

SKIP.

ENDFORM.                    " frm_break_tehai
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_TEHAI
*&---------------------------------------------------------------------*
*       手配先ヘッダ出力
*----------------------------------------------------------------------*
FORM FRM_WRITE_TEHAI.

FORMAT COLOR 7 INTENSIFIED OFF.

WRITE : /1      TEXT-116,
8(8)   GF_WRITE-ZTEHAI,    " 手配先コード
18(34) GF_WRITE-ZNAME.     " 手配先名
*           155    ' '.
FORMAT COLOR OFF.

ENDFORM.                    " FRM_WRITE_TEHAI
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MENGE
*&---------------------------------------------------------------------*
*       発注数量の設定
*----------------------------------------------------------------------*
FORM FRM_SET_MENGE.

IF GF_INFO-BSART = 'ZB'.
GF_WRITE-MENGE = GF_WRITE-MENGE * ( -1 ).
ENDIF.

ENDFORM.                    " FRM_SET_MENGE
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_NAST_CHECK
*&---------------------------------------------------------------------*
*       NASTに発注止めがあったら対象外とする
*----------------------------------------------------------------------*
FORM FRM_NAST_CHECK.
* MODIFY PSD K.ARAI 2002/05/28
SELECT SINGLE
KAPPL
OBJKY
KSCHL
SPRAS
PARNR
ERDAT
ERUHR
NACHA
VSTAT
INTO CORRESPONDING FIELDS OF GF_NAST
FROM NAST
WHERE KAPPL = 'EF'
AND OBJKY = GF_INFO-EBELN
AND KSCHL = 'NEU'
AND NACHA = '8'
* BEGIN OF ADD BY DMC 2008/04/23
AND AKTIV NE 'X'
* END OF ADD BY DMC 2008/04/23
AND VSTAT = '0'.

*  SELECT SINGLE *
*         INTO CORRESPONDING FIELDS OF GF_NAST
*         FROM NAST
*        WHERE KAPPL = 'EF'
*          AND OBJKY = GF_INFO-EBELN
*          AND KSCHL = 'NEU'
*          AND NACHA = '8'
*          AND VSTAT = '0'.
* MODIFY END
ENDFORM.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

*----2004.01.20 ADD_s
*&---------------------------------------------------------------------*
*&      Form  WRITE_OUT         ALV帳票出力
*&---------------------------------------------------------------------*
FORM WRITE_OUT.
*--- 帳票設定処理
PERFORM FRM_WRITE_SET.
*--- 表示
*-リスト出力
CALL FUNCTION 'REUSE_ALV_LIST_DISPLAY'          "【単純一覧出力】
EXPORTING
I_CALLBACK_PROGRAM            = G_REPID      "レポートID
I_CALLBACK_TOP_OF_PAGE        = G_TOP_OF_PAGE "TOP_OF_PAGE
I_STRUCTURE_NAME              = 'ZSLIST_V20'  "構造
IS_LAYOUT                     = GF_LAYOUT     "レイアウト設定
I_SAVE                        = 'A'           "レイアウト保存
IS_VARIANT                    = GF_VARIANT    "バリアント
IT_EVENTS                     = GT_EVENT[]    "イベント設定
IS_PRINT                      = GF_PRINT      "印刷設定
TABLES
T_OUTTAB                     = GT_ALV        "帳票出力用内部テーブル
EXCEPTIONS
PROGRAM_ERROR                 = 1
OTHERS                        = 2 .
IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " WRITE_OUT


*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_SET　   帳票設定処理
*&---------------------------------------------------------------------*
FORM FRM_WRITE_SET.
*--- 内部テーブル存在チェック
IF GT_WRITE IS INITIAL.
MESSAGE S204(Z1).
STOP.
ENDIF.
*--- 内部テーブル変換処理(ALV用内部テーブルに）
GT_ALV[] = GT_WRITE[].

*--- イベント取得処理
PERFORM FRM_EVENT_GET.

*--- ページ切り替え設定
GF_LAYOUT-GROUP_CHANGE_EDIT = CNS_X.

*--- ALV一覧ステータス印刷拒否設定
GF_PRINT-NO_PRINT_LISTINFOS = CNS_X.

*--- バリアント保存設定
GF_VARIANT-VARIANT   = '/TEST_0119'.   " レイアウトをバリアント保存

ENDFORM.                    " FRM_WRITE_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_EVENT_GET  イベント取得処理
*&---------------------------------------------------------------------*
FORM FRM_EVENT_GET.
*--- イベント取得
CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
EXPORTING
I_LIST_TYPE     = 0
IMPORTING
ET_EVENTS       = GT_EVENT
EXCEPTIONS
LIST_TYPE_WRONG = 1
OTHERS          = 2.
IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

*--- 使用イベントに実行するサブルーチン名を設定
LOOP AT GT_EVENT INTO GF_EVENT.
CASE GF_EVENT-NAME.
WHEN 'TOP_OF_PAGE'.
GF_EVENT-FORM = 'FRM_TOP_OF_PAGE'.
MODIFY GT_EVENT FROM GF_EVENT.
WHEN 'CALLER_EXIT'.
GF_EVENT-FORM = 'FRM_CALLER_EXIT'.
MODIFY GT_EVENT FROM GF_EVENT.
ENDCASE.
ENDLOOP.


ENDFORM.                    " FRM_EVENT_GET

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_PRINT_PARAMETERS
*&---------------------------------------------------------------------*
*       ALV印刷強制処理    動的コール
*----------------------------------------------------------------------*
FORM FRM_SET_PRINT_PARAMETERS.

DATA:LF_PRI_PARAMS LIKE PRI_PARAMS.
TABLES USR01.

SELECT SINGLE * FROM USR01 WHERE BNAME = SY-UNAME.

* プリンタ設定
LF_PRI_PARAMS-PDEST = USR01-SPLD.
* 書式設定
LF_PRI_PARAMS-PAART = 'X_65_255'.

CALL FUNCTION 'SET_PRINT_PARAMETERS'
EXPORTING
DESTINATION = LF_PRI_PARAMS-PDEST
IMMEDIATELY = 'X'
LAYOUT      = LF_PRI_PARAMS-PAART
LINE_COUNT  = 65
LINE_SIZE   = 255
NEW_LIST_ID = 'X'
RELEASE     = USR01-SPDA.


ENDFORM.                    " FRM_SET_PRINT_PARAMETERS
*---APPEND START DMC A.MASUDA 2005/02/16 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_EKKO_ERNAM
*&---------------------------------------------------------------------*
*       購買伝票ヘッダ(EKKO)の登録者から担当者名の取得
*----------------------------------------------------------------------*
*      -->P_GF_INFO_EBELN   購買伝票番号
*      <--P_GF_WRITE_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_EKKO_ERNAM USING    P_GF_INFO_EBELN
CHANGING P_GF_WRITE_TNAME.

DATA:L_ERNAM LIKE EKKO-ERNAM.
CLEAR:L_ERNAM,P_GF_WRITE_TNAME,FLG_TEC.

SELECT SINGLE ERNAM
INTO L_ERNAM
FROM EKKO
WHERE EBELN = P_GF_INFO_EBELN
AND ERNAM IN PR_ERNAM.

CASE SY-SUBRC.
WHEN 0. "GET-DATA
IF L_ERNAM = CNS_TEC0000.
CLEAR:P_GF_WRITE_TNAME.
MOVE CNS_X_2 TO FLG_TEC.
ELSE.
PERFORM FRM_GET_TNAME USING    L_ERNAM
CHANGING P_GF_WRITE_TNAME.
ENDIF.
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKO' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_EKKO_ERNAM
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_TNAME
*&---------------------------------------------------------------------*
*       ユーザのテキストを取得する
*----------------------------------------------------------------------*
*      -->P_L_ERNAM  ユーザ
*      <--P_L_TNAME  テキスト
*----------------------------------------------------------------------*
FORM FRM_GET_TNAME USING    P_L_ERNAM
CHANGING P_L_TNAME.

DATA:L_KEY(30) TYPE C.
CLEAR:P_L_TNAME,L_KEY.
CONCATENATE SY-MANDT P_L_ERNAM INTO L_KEY .

SELECT SINGLE ADRP~NAME_TEXT
INTO P_L_TNAME
FROM ADRP
INNER JOIN ADRVP
ON ADRP~PERSNUMBER = ADRVP~PERSNUMBER
WHERE ADRVP~APPL_KEY = L_KEY.

ENDFORM.                    " FRM_GET_TNAME
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_PERNR
*&---------------------------------------------------------------------*
*       営業員コードから担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G_VBELN         販売管理伝票番号
*      <--P_GF_WRITE_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_PERNR USING    P_G_VBELN
CHANGING P_GF_WRITE_TNAME.

DATA:L_PERNR LIKE VBPA-PERNR.
CLEAR:L_PERNR,P_GF_WRITE_TNAME.

SELECT SINGLE PERNR
INTO L_PERNR
FROM VBPA
WHERE VBELN = P_G_VBELN
AND PARVW = CNS_VE.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
* APPEND START DMC A.MASUDA 2005/07/05 -->
FLG_TEC = CNS_X_2.
* APPEND END   DMC A.MASUDA 2005/07/05 <--
EXIT.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'VBPA' SY-SUBRC.
ENDCASE.
*
DATA:L_NACHN LIKE PA0002-NACHN.
DATA:L_VORNA LIKE PA0002-VORNA.
CLEAR:L_NACHN,L_VORNA.

SELECT SINGLE NACHN VORNA
INTO (L_NACHN , L_VORNA)
FROM PA0002
WHERE PERNR = L_PERNR.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
CONCATENATE L_NACHN
'　'
L_VORNA
INTO P_GF_WRITE_TNAME.
REPLACE '　' WITH SPACE INTO P_GF_WRITE_TNAME.

*---APPEND START DMC A.MASUDA 2005/10/07 ------------------------------*
*     検索条件のユーザーに存在しないものは削除する
IF NOT PR_ERNAM IS INITIAL.
READ TABLE GT_NAME_TEXT INTO GW_NAME_TEXT
WITH KEY NAME_TEXT = P_GF_WRITE_TNAME
BINARY SEARCH.
IF SY-SUBRC <> 0.
CLEAR:P_GF_WRITE_TNAME.
ENDIF.
ENDIF.
*---APPEND END   DMC A.MASUDA 2005/10/07 ------------------------------*
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'PA0002' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_PERNR
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_VBAK_ERNAM
*&---------------------------------------------------------------------*
*       販売伝票ヘッダ(VBAK)の登録者から担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G_VBELN         販売管理伝票番号
*      <--P_GF_WRITE_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_VBAK_ERNAM USING    P_G_VBELN
CHANGING P_GF_WRITE_TNAME.

DATA:L_ERNAM LIKE VBAK-ERNAM.
CLEAR:L_ERNAM,P_GF_WRITE_TNAME,FLG_TEC.

SELECT SINGLE ERNAM
INTO L_ERNAM
FROM VBAK
WHERE VBELN = P_G_VBELN
AND ( ERNAM IN PR_ERNAM
*---APPEND START DMC A.MASUDA 2005/07/05 ---------------------------*
OR ERNAM = CNS_BATCH
OR ERNAM = CNS_TEC0000
OR ERNAM = CNS_EDIAD ).
*---APPEND END   DMC A.MASUDA 2005/07/05 ---------------------------*
CASE SY-SUBRC.
WHEN 0. " GET-DATA
IF L_ERNAM = CNS_BATCH.
MOVE L_ERNAM TO P_GF_WRITE_TNAME.
ELSEIF L_ERNAM = CNS_EDIAD.
MOVE L_ERNAM TO P_GF_WRITE_TNAME.
ELSEIF L_ERNAM = CNS_TEC0000.
MOVE L_ERNAM TO P_GF_WRITE_TNAME.
*---DELETE START DMC A.MASUDA 2005/10/06 ---------------------------*
*        CLEAR:P_GF_WRITE_TNAME.
*        MOVE CNS_X_2 TO FLG_TEC.
*---DELETE END   DMC A.MASUDA 2005/10/06 ---------------------------*
ELSE.
PERFORM FRM_GET_TNAME USING    L_ERNAM
CHANGING P_GF_WRITE_TNAME.
ENDIF.
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
*---DELETE START DMC A.MASUDA 2005/10/06 ---------------------------*
*      PERFORM FRM_SET_PERNR USING    P_G_VBELN           " 販売管理伝票
*                            CHANGING P_GF_WRITE_TNAME.   " 担当者名
*      IF P_GF_WRITE_TNAME IS INITIAL.
*        FLG_TEC = CNS_X_2.
*      ENDIF.
*---DELETE END   DMC A.MASUDA 2005/10/06 ---------------------------*
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'VBAK' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_VBAK_ERNAM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_VBELN
*&---------------------------------------------------------------------*
*       販売管理伝票番号の設定
*----------------------------------------------------------------------*
*      -->P_GF_INFO_EBELN   購買伝票番号
*      -->P_GF_INFO_EBELP   購買伝票明細番号
*      <--P_G_VBELN         販売管理伝票番号
*----------------------------------------------------------------------*
FORM FRM_SET_VBELN USING    P_GF_INFO_EBELN
P_GF_INFO_EBELP
CHANGING P_G_VBELN.

DATA:L_VBELN LIKE EKKN-VBELN.
DATA:L_VBELP LIKE EKKN-VBELP.
CLEAR:L_VBELN,L_VBELP,P_G_VBELN.

SELECT SINGLE VBELN
VBELP
INTO (L_VBELN , L_VBELP )
FROM EKKN
WHERE EBELN = P_GF_INFO_EBELN
AND EBELP = P_GF_INFO_EBELP.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
MOVE L_VBELN TO P_G_VBELN.
WHEN 4. " NO-DATA
CLEAR:P_G_VBELN.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKN' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_VBELN
*---APPEND END   DMC A.MASUDA 2005/02/16 ---------------------------*
*---APPEND START DMC A.MASUDA 2005/10/07 ------------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_NAME_DATA
*&---------------------------------------------------------------------*
*       検索条件ユーザー名の取得処理
*----------------------------------------------------------------------*
FORM FRM_CHECK_NAME_DATA.

* 検索条件作成用RANGE
RANGES:
R_NAMCHECK FOR ADRVP-APPL_KEY.

CLEAR:
R_NAMCHECK.
* 入力されたユーザを文字列結合し新規レンジテーブルの作成
LOOP AT PR_ERNAM.

R_NAMCHECK-SIGN   = PR_ERNAM-SIGN.
R_NAMCHECK-OPTION = PR_ERNAM-OPTION.
*   LOW項目の文字列結合
CONCATENATE SY-MANDT PR_ERNAM-LOW INTO R_NAMCHECK-LOW.
IF NOT PR_ERNAM-HIGH IS INITIAL.
CONCATENATE SY-MANDT PR_ERNAM-HIGH INTO R_NAMCHECK-HIGH.
ENDIF.

APPEND R_NAMCHECK.

ENDLOOP.
IF NOT R_NAMCHECK IS INITIAL.

SELECT ADRP~NAME_TEXT
INTO TABLE GT_NAME_TEXT
FROM ADRP
INNER JOIN ADRVP
ON ADRP~PERSNUMBER = ADRVP~PERSNUMBER
WHERE ADRVP~APPL_KEY IN R_NAMCHECK.
IF SY-SUBRC = 0.
SORT GT_NAME_TEXT BY NAME_TEXT ASCENDING.
ENDIF.

ENDIF.

ENDFORM.
*---APPEND END   DMC A.MASUDA 2005/10/07 ------------------------------*
