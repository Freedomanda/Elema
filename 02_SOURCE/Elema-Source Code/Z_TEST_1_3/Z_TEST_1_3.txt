REPORT Z_TEST_1_3 .

TYPES:
BEGIN OF TYP_ZNEN002,
MATNR      TYPE ZNEN002-MATNR,
WERKS      TYPE ZNEN002-WERKS,
*    ZANDT      TYPE ZNEN002-ZANDT,
MENGE      TYPE ZNEN002-MENGE,
MEINS      TYPE MARA-MEINS,
*    MENGE_SG   TYPE MSEG-MENGE,
*    MEINS_SG   TYPE MSEG-MEINS,
ERFMG_SG   TYPE MSEG-ERFMG,
ERFME_SG   TYPE MSEG-ERFME,
MBLNR      TYPE MSEG-MBLNR,
XBLNR      TYPE MKPF-XBLNR,
BLDAT      TYPE MKPF-BLDAT,
END   OF TYP_ZNEN002.

TYPES:
BEGIN OF TYP_MSEG,
MBLNR      TYPE MSEG-MBLNR,
MATNR      TYPE MSEG-MATNR,
WERKS      TYPE MSEG-WERKS,
ERFMG      TYPE MSEG-ERFMG,
ERFME      TYPE MSEG-ERFME,
XBLNR      TYPE MKPF-XBLNR,
BLDAT      TYPE MKPF-BLDAT,
END   OF TYP_MSEG.

DATA:
TD_ZNEN002_M  TYPE STANDARD TABLE OF TYP_ZNEN002,
TH_ZNEN002_M  LIKE          LINE  OF TD_ZNEN002_M,

TD_ZNEN002    TYPE STANDARD TABLE OF TYP_ZNEN002,
TH_ZNEN002    LIKE          LINE  OF TD_ZNEN002.

DATA:
TD_MSEG       TYPE STANDARD TABLE OF TYP_MSEG,
TH_MSEG       LIKE          LINE  OF TD_MSEG.


START-OF-SELECTION.

* 在庫情報(出庫)を抽出
SELECT ZNEN002~MATNR
ZNEN002~WERKS
*         ZNEN002~ZANDT
SUM( ZNEN002~MENGE )
MARA~MEINS
INTO TABLE TD_ZNEN002_M
FROM ZNEN002
INNER JOIN MARA
ON ZNEN002~MATNR = MARA~MATNR
GROUP BY ZNEN002~MATNR
ZNEN002~WERKS
*            ZNEN002~ZANDT
MARA~MEINS
.
* 紐づく出庫情報を抽出
SELECT
MSEG~MBLNR
MSEG~MATNR
MSEG~WERKS
MSEG~ERFMG
MSEG~ERFME
MKPF~XBLNR
MKPF~BLDAT
FROM MSEG
INNER JOIN MKPF
ON MSEG~MBLNR = MKPF~MBLNR
INTO TABLE TD_MSEG
FOR ALL ENTRIES IN TD_ZNEN002_M
WHERE MSEG~MATNR =  TD_ZNEN002_M-MATNR
AND MSEG~WERKS =  TD_ZNEN002_M-WERKS
AND MSEG~ERFME <> TD_ZNEN002_M-MEINS
AND MSEG~WEMPF <> SPACE
AND MSEG~SHKZG = 'H'
.
SORT TD_MSEG BY MATNR WERKS BLDAT.
SORT TD_ZNEN002_M BY MATNR WERKS.
* 在庫情報に出庫数量の合算値と数量単位を付加
LOOP AT TD_MSEG INTO TH_MSEG.
READ TABLE TD_ZNEN002_M INTO TH_ZNEN002_M
WITH KEY MATNR = TH_MSEG-MATNR
WERKS = TH_MSEG-WERKS.
TH_ZNEN002_M-ERFMG_SG = TH_MSEG-ERFMG.
TH_ZNEN002_M-ERFME_SG = TH_MSEG-ERFME.
TH_ZNEN002_M-MBLNR    = TH_MSEG-MBLNR.
TH_ZNEN002_M-XBLNR    = TH_MSEG-XBLNR.
TH_ZNEN002_M-BLDAT    = TH_MSEG-BLDAT.
APPEND TH_ZNEN002_M TO TD_ZNEN002.
ENDLOOP.

* 一覧出力
SORT TD_ZNEN002 BY MATNR WERKS ASCENDING
XBLNR       DESCENDING.
DELETE ADJACENT DUPLICATES FROM TD_ZNEN002
COMPARING MATNR WERKS MENGE ERFME_SG.

LOOP AT TD_ZNEN002 INTO TH_ZNEN002.
WRITE:/ TH_ZNEN002-MATNR,
TH_ZNEN002-WERKS,
TH_ZNEN002-MENGE,
TH_ZNEN002-MEINS,
TH_ZNEN002-ERFMG_SG,
TH_ZNEN002-ERFME_SG,
83(16) TH_ZNEN002-MBLNR,
100(16) TH_ZNEN002-XBLNR,
117(8)  TH_ZNEN002-BLDAT.
ENDLOOP.

TOP-OF-PAGE.
* ヘッダ出力
WRITE: /0(10)   '品目コード',
16(8)   'プラント',
37(4)   '数量',
42(4)   '単位',
55(6)   '出数量',
63(6)   '出単位',
83(14)  '入出庫伝票番号',
100(12) '出荷伝票番号',
117(8)  '出荷日付'.
