REPORT Z_TEST_1_3 .

TYPES:
BEGIN OF TYP_ZNEN002,
MATNR      TYPE ZNEN002-MATNR,
WERKS      TYPE ZNEN002-WERKS,
ZZNO       TYPE ZNEN002-ZZNO,
MENGE      TYPE ZNEN002-MENGE,
MEINS      TYPE MARA-MEINS,
MENGE_SG   TYPE MSEG-MENGE,
MEINS_SG   TYPE MSEG-MEINS,
ERFMG_SG   TYPE MSEG-ERFMG,
ERFME_SG   TYPE MSEG-ERFME,
MBLNR      TYPE MSEG-MBLNR,
XBLNR      TYPE MKPF-XBLNR,
LOWAMT     TYPE ZN007-LOWAMT,
END   OF TYP_ZNEN002.

TYPES:
BEGIN OF TYP_MSEG,
MBLNR      TYPE MSEG-MBLNR,
MATNR      TYPE MSEG-MATNR,
WERKS      TYPE MSEG-WERKS,
EBELN      TYPE MSEG-EBELN,
MENGE      TYPE MSEG-MENGE,
MEINS      TYPE MSEG-MEINS,
ERFMG      TYPE MSEG-ERFMG,
ERFME      TYPE MSEG-ERFME,
XBLNR      TYPE MKPF-XBLNR,
END   OF TYP_MSEG.

DATA:
TD_ZNEN002_M  TYPE STANDARD TABLE OF TYP_ZNEN002,
TH_ZNEN002_M  LIKE          LINE  OF TD_ZNEN002_M,

TD_ZNEN002    TYPE STANDARD TABLE OF TYP_ZNEN002,
TH_ZNEN002    LIKE          LINE  OF TD_ZNEN002.

DATA:
TD_MSEG       TYPE STANDARD TABLE OF TYP_MSEG,
TH_MSEG       LIKE          LINE  OF TD_MSEG.

DATA:
CTR_MSEG(7)    TYPE P DECIMALS 2,
W_CHAR         TYPE C,
WLOWAMT        TYPE ZN007-LOWAMT,
W_I            TYPE I,
W_A(10)        TYPE C,
W_B(10)        TYPE C,
W_C            TYPE C,
CTR_ZNEN002    TYPE I.

CONSTANTS:
CNS_PONO(5)    TYPE N  VALUE '00010'.


START-OF-SELECTION.

IF  W_B NA W_A.
IF W_B NS W_A .
WRITE W_B.
ENDIF.
ELSEif W_A NA W_B.

WRITE W_B.
ENDIF.



IF W_CHAR CO '1234567890'.
W_I = W_CHAR.
W_I = W_I + W_I.
ENDIF.

TH_ZNEN002_M-LOWAMT = 100.
APPEND TH_ZNEN002_M TO TD_ZNEN002_M .
READ TABLE TD_ZNEN002_M INTO TH_ZNEN002_M
WITH KEY LOWAMT = WLOWAMT.



* 在庫情報(出庫)を抽出
SELECT ZNEN002~MATNR
ZNEN002~WERKS
*         ZNEN002~ZZNO
*         ZNEN002~MENGE
MARA~MEINS
INTO CORRESPONDING FIELDS OF TABLE TD_ZNEN002_M
FROM ZNEN002
INNER JOIN MARA
ON ZNEN002~MATNR = MARA~MATNR
*   WHERE ZNEN002~MATNR = '000000000000022161'
GROUP BY ZNEN002~MATNR
ZNEN002~WERKS
*            ZNEN002~MENGE
MARA~MEINS
*   WHERE ZNEN002~ZZNO <> SPACE
*     AND ZNEN002~ZZPOS = CNS_PONO
.
* 紐づく出庫情報を抽出
SELECT MSEG~MBLNR
MSEG~MATNR
MSEG~WERKS
MSEG~EBELN
MSEG~MENGE
MSEG~MEINS
MSEG~ERFMG
MSEG~ERFME
MKPF~XBLNR
FROM MSEG
INNER JOIN MKPF
ON MSEG~MBLNR = MKPF~MBLNR
INTO CORRESPONDING FIELDS OF TABLE TD_MSEG
FOR ALL ENTRIES IN TD_ZNEN002_M
WHERE MSEG~MATNR =  TD_ZNEN002_M-MATNR
AND MSEG~WERKS =  TD_ZNEN002_M-WERKS
AND MSEG~ERFME <> TD_ZNEN002_M-MEINS
AND MSEG~WEMPF <> SPACE
*     AND EBELN = TD_ZNEN002-ZZNO
AND MSEG~SHKZG = 'H'
.

* 在庫情報に出庫時の数量単位を付加
LOOP AT TD_MSEG INTO TH_MSEG.

READ TABLE TD_ZNEN002_M INTO TH_ZNEN002_M
WITH KEY MATNR = TH_MSEG-MATNR
WERKS = TH_MSEG-WERKS.

*    TH_ZNEN002-MENGE_SG = TH_MSEG-MENGE.
*    TH_ZNEN002-MEINS_SG = TH_MSEG-MEINS.
TH_ZNEN002_M-ERFMG_SG = TH_MSEG-ERFMG.
TH_ZNEN002_M-ERFME_SG = TH_MSEG-ERFME.
TH_ZNEN002_M-MBLNR    = TH_MSEG-MBLNR.
TH_ZNEN002_M-XBLNR    = TH_MSEG-XBLNR.

APPEND TH_ZNEN002_M TO TD_ZNEN002.
AT END OF MATNR.
LOOP AT TD_ZNEN002 INTO TH_ZNEN002.
AT NEW MATNR.
ENDAT.

ENDLOOP.
ENDAT.
ENDLOOP.


* 一覧出力
SORT TD_ZNEN002 BY MATNR WERKS ASCENDING
XBLNR       DESCENDING.
LOOP AT TD_ZNEN002 INTO TH_ZNEN002.
IF TH_ZNEN002-MEINS = TH_ZNEN002-ERFME_SG.
CONTINUE.
ENDIF.
WRITE:/ TH_ZNEN002-MATNR,
TH_ZNEN002-WERKS,
TH_ZNEN002-ZZNO,
TH_ZNEN002-MENGE,
TH_ZNEN002-MEINS,
TH_ZNEN002-ERFMG_SG,
TH_ZNEN002-ERFME_SG,
83(16) TH_ZNEN002-XBLNR,
100(16) TH_ZNEN002-XBLNR.
ENDLOOP.

TOP-OF-PAGE.
* ヘッダ出力
WRITE: /0(10)   '品目コード',
16(8)   'プラント',
25(6)   '発注NO',
46(4)   '数量',
55(4)   '単位',
68(6)   '出数量',
76(6)   '出単位',
83(14)  '入出庫伝票番号',
100(12) '出荷伝票番号'.
