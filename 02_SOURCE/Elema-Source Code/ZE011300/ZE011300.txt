************************************************************************
* [プログラム名]
*   ZE011300        納品書（受注出力）
*
* [処理概要]
*   納品書の印刷
*
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2002/02/13   PSD H.Tanaka      新規開発
*  2002/02/20   PSD H.Tanaka      仕様変更・不具合対応
*                                 ・NASTテーブルロック/ロック解除変更
*                                 ・アドレス取得方法変更
*  2002/03/04   PSD M.Arai        納入完了区分追加対応
*  2002/03/04   PSD M.Arai        単価区分追加対応
*  2002/03/04   PSD M.Arai        製造番号追加対応
*  2002/03/04   PSD M.Arai        対象レコード取得不具合対応
*  2002/03/11   PSD M.Arai        受渡場所・出力タイプ追加対応
*  2002/03/15   PSD M.Arai        出庫日対応
*  2002/03/25   PSD M.ARAI        NAST更新不具合対応
*  2002/04/26   PSD K.ARAI        仕様変更・明細カテゴリ対応
*  2002/05/02   PSD K.ARAI        仕様変更・単価編集
*  2002/05/09   PSD K.ARAI        金額項目不具合対応
*  2002/05/09   PSD K.ARAI        税額項目取得条件変更
*  2002/05/14   PSD T.SAITOH      出荷先情報から受注先情報に変更
*  2002/05/17   PSD K.ARAI        営業所・出荷先情報取得方法変更
*  2002/06/02   PSD T.SAITOH      NASTチェック処理パフォーマンス対応
*  2002/06/07   PSD T.SAITOH      セット品親の単価設定処理を追加
*  2002/06/20   PSD T.SAITOH      再移送
*  2002/08/06   PSD T.SAITOH      ロックユーザーＩＤ取得
*  2002/08/14   PSD T.SAITOH      納品キー番号TEXT ID Z901→Z902
*                  出庫日、納期、納期予定日を出力しない ブランクを設定
*  2002/08/14   PSD T.SAITOH      納期は出力する
*  2002/08/24   PSD T.IIDA        付加数値：取得項目先の変更
*  2002/09/04   PSD T.SAITOH      基本数量単位から販売数量単位に変更
*  2002/09/10   PSD T.IIDA        付加数値：空白削除
*  2002/10/07   NDSC STTD06       付加数値：属性変更
*  2003/03/17   NDSC STTD07       得意先発注番号取得TBL変更
*  2003/06/09   NDSC STTD31       概算単価を出力項目に追加
*　2003/10/29   NDSC STTD07       概算金額、概算消費税額、概算合計額追加
*  2004/05/13   NDSC STTD07       READ_TEXTの戻り値が4の場合、空白を設定
*  2008/06/30   DMC  STTD06       受注者用備考の読込条件変更
*& 2012/08/22   ISID              ES-UP
*& 2012/10/30   ISID              ES-UP
*  2013/02/20   GSL S.TOHTAKE     入り数の桁変更・通常出力でも設定可能に
*  2013/04/17   GSL S.TOHTAKE     入り数入力時複数伝票番号設定時
*                                 メッセージ表示
*  2013/08/21   GSL S.TOHTAKE     出力項目：納品Noの値を納品キー番号か
*                                 ら納品番号に変更する
*  2014/09/01   ISID11            コードページUTF-8の改修
*  2015/01/23   ISID11            コードページの再修正
************************************************************************
REPORT  ZE011300.


*---------------------------------------------------------------------
* TYPES
*---------------------------------------------------------------------
TYPE-POOLS SLIS.
*--- メッセージステータスデータ型
TYPES: BEGIN OF TYP_NAST,
KAPPL      TYPE NAST-KAPPL,        " アプリケーション
OBJKY      TYPE NAST-OBJKY,        " 対象キー
KSCHL      TYPE NAST-KSCHL,        " メッセージタイプ
LDEST      TYPE NAST-LDEST,        " 出力デバイス
USNAM      TYPE NAST-USNAM,        " ユーザＩＤ
DATVR      TYPE NAST-DATVR,        " 処理日
UHRVR      TYPE NAST-UHRVR,        " 処理時間
END   OF TYP_NAST.

*--- 販売伝票データ型
TYPES: BEGIN OF TYP_VBAP,
VBELN      TYPE VBAK-VBELN,        " 販売伝票番号
* Edit 2003.03.17 >>>
*         BSTNK      TYPE VBAK-BSTNK,        " 得意先発注番号
BSTKD      TYPE VBKD-BSTKD,        " 得意先発注番号
* Edit 2003.03.17 <<<
AUDAT      TYPE VBAK-AUDAT,        " 受注伝票日付
AUART      TYPE VBAK-AUART,        " 販売伝票タイプ
VKORG      TYPE VBAK-VKORG,        " 販売組織
VTWEG      TYPE VBAK-VTWEG,        " 流通チャンネル
KUNNR      TYPE VBAK-KUNNR,        " 受注先
KNUMV      TYPE VBAK-KNUMV,        " 伝票条件番号
VKBUR      TYPE VBAK-VKBUR,        " 営業所コード
POSNR      TYPE VBAP-POSNR,        " 販売伝票明細
KDMAT      TYPE VBAP-KDMAT,        " 得意先発注番号
VRKME      TYPE VBAP-VRKME,        " 基本数量単位
NETPR      TYPE VBAP-NETPR,        " 正味価格
KWMENG     TYPE VBAP-KWMENG,       " 受注数量
MATNR      TYPE VBAP-MATNR,        " 品目コード
WAERK      TYPE VBAP-WAERK,        "
EDATU      TYPE VBEP-EDATU,        " 得意先希望納期
BSTDK_E    TYPE VBKD-BSTDK_E,      " 変更納期
* ↓ APPEND 2002.04.26 PSD K.ARAI 　明細カテゴリ編集対応
PSTYV      TYPE VBAP-PSTYV,        " 明細カテゴリ
NETWR      TYPE VBAP-NETWR,        " 受注金額
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI 　単価編集
KPEIN      TYPE VBAP-KPEIN,        " 価格数量単位
* ↑
END   OF TYP_VBAP.

*--- スプール：デバイス名（長）データ型
TYPES: BEGIN OF TYP_TSP03L,
LNAME      TYPE TSP03L-LNAME,      " デバイス名（長）
PADEST     TYPE TSP03L-PADEST,     " デバイスの省略
END   OF TYP_TSP03L.

*--- 条件：タイプ：テキストデータ型
TYPES: BEGIN OF TYP_T685T,
KAPPL      TYPE T685T-KAPPL,       " アプリケーション
KSCHL      TYPE T685T-KSCHL,       " メッセージタイプ
VTEXT      TYPE T685T-VTEXT,       " 名称
END   OF TYP_T685T.

*--- アドレス型
TYPES: BEGIN OF TYP_ADRC,
NAME1      TYPE ADRC-NAME1,        " 名称１
NAME2      TYPE ADRC-NAME2,        " 名称２
NAME3      TYPE ADRC-NAME3,        " 名称３
TEL_NUMBER TYPE ADRC-TEL_NUMBER,   " 電話番号
FAX_NUMBER TYPE ADRC-FAX_NUMBER,   " ＦＡＸ番号
POST_CODE1 TYPE ADRC-POST_CODE1,   " 郵便番号
CITY1      TYPE ADRC-CITY1,        " 市区町村
STR_SUPPL1 TYPE ADRC-STR_SUPPL1,   " 地名２
STR_SUPPL2 TYPE ADRC-STR_SUPPL2,   " 地名３
* ↓ APPEND 2002.04.26 PSD K.ARAI
REGION     TYPE ADRC-REGION,       " 地域
STREET     TYPE ADRC-STREET,       " 都道府県名
* ↑
END   OF TYP_ADRC.

* ↓ MODIFY 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
*TYPES: BEGIN OF TYP_WRITE,
*         PNAME      TYPE TSP03D-PAPROSNAME, " プリンタ／トレイ
*         TNAME(8)   TYPE C,                 " 帳票名
*         VBELN(20)  TYPE C,                 " 受注伝票番号
*         KUNNR      TYPE VBAK-KUNNR,        " 得意先
*         BSTKD      TYPE VBKD-BSTKD,        " 注文番号
*         KDMAT      TYPE KNMT-KDMAT,        " 図版
*         POSTX      TYPE KNMT-POSTX,        " 商品名
*         LFIMG(16)  TYPE C,                 " 数量
*         vrkme      TYPE LIPS-vrkme,        " 単位
*         NETPR(13)  TYPE C,                 " 単価
*         KEBTR(13)  TYPE C,                 " 税額
*         SNIBK(40)  TYPE C,                 " 社内用備考
*         SZITK(40)  TYPE C,                 " 消費税用注記
**         WADAT      TYPE LIKP-WADAT_IST,    " 出庫日
*         EIGNM      TYPE ADRC-NAME1,        " 営業所名
*         EIGTN      TYPE ADRC-TEL_NUMBER,   " 営業所電話番号
*         EIGFN      TYPE ADRC-FAX_NUMBER,   " 営業所ＦＡＸ番号
*         EIGPC      TYPE ADRC-POST_CODE1,   " 営業所郵便番号
*         EGAD1      TYPE ADRC-CITY1,        " 営業所住所１
*         EGAD2      TYPE ADRC-STR_SUPPL1,   " 営業所住所２
*         EGAD3      TYPE ADRC-STR_SUPPL2,   " 営業所住所３
*         SKNM1      TYPE ADRC-NAME1,        " 出荷先名
*         SKNM2      TYPE ADRC-NAME2,        " 名称２
*         SKNM3      TYPE ADRC-NAME3,        " 名称３
*         SKSPC      TYPE ADRC-POST_CODE1,   " 出荷先郵便番号
*         SKAD1      TYPE ADRC-CITY1,        " 出荷先住所１
*         SKAD2      TYPE ADRC-STR_SUPPL1,   " 出荷先住所２
*         SKAD3      TYPE ADRC-STR_SUPPL2,   " 出荷先住所３
*         HBMCD(15)  TYPE C,                 " 発注部門コード
*         TISCD(10)  TYPE C,                 " 訂正コード
*         SKKBN(8)   TYPE C,                 " 支給区分
*         KBTNT(8)   TYPE C,                 " 購買担当
*         SKKSH(20)  TYPE C,                 " 材質・規格・寸法
*         HINNM      TYPE KNMT-POSTX,        " 品名（品名仕様）
*         KSKBN(8)   TYPE C,                 " 検査区分
*         JYSRN(100) TYPE C,                 " 自由使用欄
*         BIKOU(30)  TYPE C,                 " 備考
*         SZKBN(12)  TYPE C,                 " 消費税区分
*         NASNM(100) TYPE C,                 " 納入先宛先名
*         NNKNM(30)  TYPE C,                 " 納入キー番号
*         FKSTI(8)   TYPE C,                 " 付加数値
*         UWSBS(20)  TYPE C,                 " 受渡場所名
*         HTBCD(23)  TYPE C,                 " 発注者用バーコード情報
*         HTBKU(50)  TYPE C,                 " 発注者用備考
*         IRISU(6)   TYPE C,                 " 入り数
*         KOGUT(4)   TYPE C,                 " 個口
*         BUNSI(4)   TYPE C,                 " 分子
*         EDATU      TYPE VBEP-EDATU,        " 納期
*         BSTDK      TYPE VBKD-BSTDK_E,      " 納期予定日
*         KWMENG(17) TYPE C,                 " 受注数
*         JTBKU(40)  TYPE C,                 " 受注者用備考
*         NINNO(40)  TYPE C,                 " 納入No
*         AUDAT      TYPE VBAK-AUDAT,        " 注文納期
*         TNKBN(40)  TYPE C,                 " 直納区分
*         RHAKO(10)  TYPE C,                 " 再出力区分
*         PRNTR      TYPE TSP03L-LNAME,      " プリンタ
** ↓ APPEND 2002.03.03 PSD M.ARAI 項目追加対応
*         ENDTYP     TYPE C,                 " 納入完了区分
*         UNTTYP(40) TYPE C,                 " 単価区分
*         PRDNUM(40) TYPE C,                 " 製造番号
** ↑
*      END   OF TYP_WRITE.
TYPES: TYP_WRITE TYPE ZE0113.
* ↑

* ↓ APPEND 2002.04.26 PSD K.ARAI
TYPES: TYP_DUMMY TYPE  ZE0113_TEMP.         "明細カテゴリ対応用
* ↑

*--- ファイルデータ型
* Mod ES-UP 2012/10/30 -->
*TYPES: BEGIN OF TYP_FILE,
*         DATA(2000)  TYPE C,
*      END   OF TYP_FILE.
* Mod ES-UP 2012/10/30 <--
*--- 2002/05/09 APPEND PSD K.ARAI
*--- 税額取得用
TYPES: BEGIN OF TYP_KONV,
KWERT       TYPE KONV-KWERT,    "条件金額
WAERS       TYPE KONV-WAERS,    "通貨
KBETR       TYPE KONV-KBETR,    "条件レート
END   OF TYP_KONV.

* ↓ APPEND 2002.05.10 PSD K.ARAI
*--- アドレス型
TYPES: BEGIN OF TYP_ADRC_INFO,
VKBUR      TYPE TVBUR-VKBUR,       " 営業所
ADRNR      TYPE TVBUR-ADRNR,       " アドレスNo
NAME1      TYPE ADRC-NAME1,        " 名称１
TEL_NUMBER TYPE ADRC-TEL_NUMBER,   " 電話番号
FAX_NUMBER TYPE ADRC-FAX_NUMBER,   " ＦＡＸ番号
POST_CODE1 TYPE ADRC-POST_CODE1,   " 郵便番号
CITY1      TYPE ADRC-CITY1,        " 市区町村
STR_SUPPL1 TYPE ADRC-STR_SUPPL1,   " 地名２
STR_SUPPL2 TYPE ADRC-STR_SUPPL2,   " 地名３
REGION     TYPE ADRC-REGION,       " 地域
*--- APPEND 2002/05/17 PSD K.ARAI
STREET     TYPE ADRC-STREET,
*--- APPEND END
END   OF TYP_ADRC_INFO.
*---------------------------------------------------------------------
* DATA
*---------------------------------------------------------------------
*--- メッセージステータス内部テーブル
DATA: GF_NAST       TYPE           TYP_NAST,
GF_NAST_READ  TYPE           TYP_NAST,
GT_NAST       TYPE TABLE OF  TYP_NAST.

*--- 販売伝票内部テーブル
DATA: GF_VBAP  TYPE           TYP_VBAP,
GT_VBAP  TYPE TABLE OF  TYP_VBAP.

*--- スプール：デバイス名（長）内部テーブル
DATA: GF_TSP03L TYPE          TYP_TSP03L,
GT_TSP03L TYPE TABLE OF TYP_TSP03L.

*--- 条件：タイプ：テキストデータ型
DATA: GF_T685T  TYPE          TYP_T685T,
GT_T685T  TYPE TABLE OF TYP_T685T.

*--- アドレスデータ型
DATA: GF_ADRC   TYPE          TYP_ADRC.

*--- 2002/05/10 APPEND PSD K.ARAI
*--- 営業所情報用
DATA: GT_ADRC_INFO TYPE  HASHED TABLE OF TYP_ADRC_INFO
WITH UNIQUE KEY VKBUR,
GF_ADRC_INFO TYPE TYP_ADRC_INFO.

*--- ファイル出力用構造
DATA: GF_WRITE  TYPE          TYP_WRITE,
GT_WRITE  TYPE TABLE OF TYP_WRITE.
* ↓ APPEND 2002.04.26 PSD K.ARAI
DATA: GF_WRITE_TEMP  TYPE     TYP_WRITE.

*---  明細カテゴリ処理対応用
DATA: GF_DUMMY  TYPE          TYP_DUMMY,
GT_DUMMY  TYPE TABLE OF TYP_DUMMY.
* ↑
*--- ファイル出力用内部テーブル
*DATA: GF_FILE   TYPE          TYP_FILE.
* Mod ES-UP 2012/10/30 -->
DATA: GF_FILE   TYPE  STRING.
* Mod ES-UP 2012/10/30 <--

*--- 項目定義
DATA: G_FILENAME(62)          TYPE C,     " ファイル名
G_FILEOPENNAME(62)      TYPE C      " ファイルＯＰＥＮ名
.
* ↓ APPEND 2002.04.26 PSD K.ARAI
DATA: G_NETWR    LIKE ZS0115-NETWR,       "売上金額
G_NETWRT   LIKE ZS0115-NETWRT,      "売上税込金額
G_KEBTR    LIKE ZS0115-KEBTR,       "消費税
* Edit 2013.02.20 GSL Tohtake.s Start
*     G_OUTNO(4) TYPE N.
G_OUTNO(6) TYPE N.
* Edit 2013.02.20 GSL Tohtake.s End
* ↑

* 2003.06.09 append
DATA: G_KONTPR   LIKE ZS0115-KONTPR.      "概算単価
* 2003.06.09 end.

*--- カウンタ定義
DATA: CUT_DATA(10)             TYPE C,    " データ件数
CUT_ERR(10)              TYPE C.    " データ件数

*--- フラグ定義
DATA: F_ERR(1)                 TYPE C,    " エラーフラグ
F_VBAK(1)                TYPE C,    " 受注伝票情報フラグ
F_NAST(1)                TYPE C,    " メッセージステータスフラグ
F_TSP03L(1)              TYPE C.    " 条件：タイプ：テキストフラグ

*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
DATA: GT_SEQG3 LIKE TABLE OF SEQG3 WITH HEADER LINE,
GF_SEQG3 LIKE SEQG3.
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*

*---------------------------------------------------------------------
* 定数宣言
*---------------------------------------------------------------------
CONSTANTS: CNS_NAST(4)    TYPE C VALUE 'NAST',
CNS_VBAP(9)    TYPE C VALUE 'VBAK VBAP',
CNS_VBPA(9)    TYPE C VALUE 'VBPA ADRC',
CNS_KONV(4)    TYPE C VALUE 'KONV',
CNS_TSP03L(6)  TYPE C VALUE 'TSP03L',
CNS_T685T(5)   TYPE C VALUE 'T685T',
CNS_J(1)       TYPE C VALUE 'J',
CNS_X(1)       TYPE C VALUE 'X',
* Del ES-UP 2012/08/22 -->
*           CNS_09(1)      TYPE X VALUE '09',
* Del ES-UP 2012/08/22 <--
* ↓ APPEND 2002.03.01 PSD M.ARAI 納入完了区分追加対応
CNS_*(1)       TYPE C VALUE 'V'
* ↑
.
**** START DEL 2014/09/01 ISID11 ****
** Add ES-UP 2012/08/22 -->
*CONSTANTS CNS_SJIS TYPE STRING VALUE `shift_jis`.
** Add ES-UP 2012/08/22 <--
**** END DEL 2014/09/01 ISID11 ****
*---------------------------------------------------------------------
* 選択画面定義
*---------------------------------------------------------------------
*--- 通常出力
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(33) TEXT-050.
PARAMETERS: R_NMOUT RADIOBUTTON GROUP RDOG.
SELECTION-SCREEN END   OF LINE.
*--- 再出力
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 1(33) TEXT-001.
PARAMETERS: R_REOUT RADIOBUTTON GROUP RDOG.
SELECTION-SCREEN END   OF LINE.
*--- 営業所
SELECT-OPTIONS: S_VKBUR FOR GF_VBAP-VKBUR.
*--- 受注伝票NO.
SELECT-OPTIONS: S_VBELN FOR GF_VBAP-VBELN.
*--- 入り数
* Edit 2013.02.20 GSL Tohtake.s Start
*PARAMETERS: P_OUTNO(4) TYPE N.
PARAMETERS: P_OUTNO(6) TYPE N.
* Edit 2013.02.20 GSL Tohtake.s End
*--- プリンタ／トレイ
PARAMETERS: P_PRNTR TYPE TYP_TSP03L-LNAME.
*--- ファイルパス
PARAMETERS: P_FILE(20) TYPE C NO-DISPLAY.
***2002.09.30 >>>
SELECTION-SCREEN SKIP.
PARAMETERS:P_SURYO(16).
***2002.09.30 <<<
*---------------------------------------------------------------------
* INITIALIZATION
*---------------------------------------------------------------------
INITIALIZATION .
*--- ファイル作成先ディレクトリ取得
GET PARAMETER ID 'ZSVF' FIELD P_FILE.
IF SY-SUBRC = 4.
MESSAGE E614(Z1) WITH TEXT-106.
ENDIF.
*---------------------------------------------------------------------
* AT SELECTION-SCREEN
*---------------------------------------------------------------------
AT SELECTION-SCREEN.
* Edit 2013.04.17 GSL Tohtake.s Start
DATA: L_DOC_CNT TYPE I.
* Edit 2013.04.17 GSL Tohtake.s End
*--- スプール：デバイス名（長）情報取得処理
PERFORM FRM_TSP03L_GET.
*---入力パラメータチェック
*--- 2002/05/10 MODIFY PSD K.ARAI
IF SY-UCOMM+0(1) <> '%' .
*  IF SY-UCOMM <> '%008' AND
*     SY-UCOMM <> '%009'.
*--- 2002/05/10 END

*--- 営業所存在チェック処理
IF S_VKBUR IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-115.
ELSE.
PERFORM FRM_VKBUR_CHECK.
ENDIF.
IF R_REOUT = CNS_X.          " 再入力ボタンチェック時
IF S_VBELN IS INITIAL.
MESSAGE E805(Z1) WITH TEXT-055.
ENDIF.
*      IF P_OUTNO IS INITIAL.     " 入り数
*        MESSAGE E006(Z1) WITH TEXT-092.
*      ENDIF.
ELSEIF R_NMOUT = CNS_X.      " 通常入力ボタンチェック時
IF NOT P_OUTNO IS INITIAL.     " 入り数
* Edit 2013.02.20 GSL Tohtake.s Start
*        CLEAR P_OUTNO.
*        MESSAGE E615(Z1) WITH TEXT-092.
IF S_VBELN IS INITIAL.
MESSAGE E805(Z1) WITH TEXT-055.
* Edit 2013.04.17 GSL Tohtake.s Start
ELSE.
DESCRIBE TABLE S_VBELN LINES L_DOC_CNT.
IF L_DOC_CNT = 1.
IF S_VBELN-OPTION <> 'EQ' OR S_VBELN-SIGN <> 'I'.
MESSAGE W917(Z1).
ENDIF.
ELSE.
MESSAGE W917(Z1).
ENDIF.
* Edit 2013.04.17 GSL Tohtake.s End
ENDIF.
* Edit 2013.02.20 GSL Tohtake.s End
ENDIF.
ENDIF.
*--- プリンタ／トレイ設定
PERFORM FRM_PRINTER_CHECK.
ENDIF.

*---------------------------------------------------------------------
* START-OF-SELECTION
*---------------------------------------------------------------------
START-OF-SELECTION.
*--- 出力タイプ取得処理
PERFORM FRM_T685T_GET.
* ↓ APPEND 2002.04.26 PSD K.Arai
G_OUTNO = P_OUTNO.
* ↑
* 2002/02/20 PSD H.Tanaka DEL ↓
*--- テーブルロック処理
*  PERFORM ENQUEUE_EZNAST USING 'ZS01'.

IF R_NMOUT = CNS_X.
*--- 通常出力用ファイル出力用情報取得処理
PERFORM FRM_NMOUT_DATA.
ELSEIF R_REOUT = CNS_X.
*--- 再出力用ファイル出力用情報取得処理
PERFORM FRM_REOUT_DATA.
ENDIF.

*--- ファイルヘッダ部更新処理
PERFORM FRM_FILE_HEADER.
*--- ファイル更新処理
PERFORM FRM_TBL_APPEND.
*--- ファイルＣＬＯＳＥ処理
CLOSE DATASET G_FILEOPENNAME.
IF SY-SUBRC <> 0.
PERFORM FRM_FILE_ERR.
ROLLBACK WORK.
STOP.
ENDIF.

*--- 終了メッセージ処理
PERFORM FRM_END_MESSAGE.

************************************************************************
* Form
***********************************************************************
*&---------------------------------------------------------------------
*&      Form  FRM_MAKE_DATA
*&---------------------------------------------------------------------
*       ファイル出力用内部テーブル設定処理
*----------------------------------------------------------------------
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------
FORM FRM_MAKE_DATA.

CLEAR GF_WRITE-RHAKO .

*--- プリンタ／トレイ設定
PERFORM FRM_PNAME_SET.
CHECK F_ERR <> CNS_X.
*--- 帳票名設定
PERFORM FRM_TNAME_SET.
*--- 単価設定
PERFORM FRM_KINGAKU_HENKAN USING    GF_VBAP-WAERK
GF_VBAP-NETPR
CHANGING GF_WRITE-NETPR.
* ↓ APPEND 2002.04.26 PSD K.ARAI 　単価編集
*--- 価格数量単位 が０の時は1をいれる
IF GF_VBAP-KPEIN = 0.
GF_VBAP-KPEIN = 1.
ENDIF.
*--- 単価設定
GF_WRITE-NETPR = GF_WRITE-NETPR / GF_VBAP-KPEIN.
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-NETPR NO-GAPS.
* ↑

* ↓ 2002.04.26 PSD K.ARAI
PERFORM FRM_KINGAKU_HENKAN USING    GF_VBAP-WAERK
GF_VBAP-NETWR
CHANGING GF_WRITE-NETWR.
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-NETWR NO-GAPS.
* ↑

*--- APPEND 2003.06.09 KONV単価取得追加
PERFORM FRM_KONV          USING     GF_VBAP-VBELN
GF_VBAP-POSNR
GF_WRITE-KONTPR.
CONDENSE GF_WRITE-KONTPR NO-GAPS.
*--- append end.

* ↓ 2002.03.04 PSD M.ARAI 納入完了区分追加対応
*--- 納入完了区分設定
PERFORM FRM_SET_ENDTYP.

*--- 税額設定
PERFORM FRM_KEBTR_SET.
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-KEBTR NO-GAPS.
* ↑

*--- 再出力区分設定
IF R_REOUT = CNS_X.
GF_WRITE-RHAKO = 'R'.
ENDIF.
*--- 営業所／仕入先設定
PERFORM FRM_EGSR_SET.
*--- ファイル編集処理
PERFORM FRM_TBL_MAKE.

PERFORM FRM_READ_SET.

ENDFORM.                    " FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*&      Form  DEQUEUE_EZNAST
*&---------------------------------------------------------------------*
*       ＮＡＳＴロック解除処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM DEQUEUE_EZNAST.
CALL FUNCTION 'DEQUEUE_ALL'
EXCEPTIONS
OTHERS = 1.
IF SY-SUBRC <> 0.
MESSAGE A502(Z1) WITH 'DEQUEUE_ALL'
SY-SUBRC.
ENDIF.

ENDFORM.                    " DEQUEUE_EZNAST
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_FILE
*&---------------------------------------------------------------------*
*       ファイル作成処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_MAKE_FILE.
*--- ファイル出力処理
TRANSFER GF_FILE TO G_FILEOPENNAME.
IF SY-SUBRC <> 0.
PERFORM FRM_FILE_ERR.
ROLLBACK WORK.
STOP.
ENDIF.
ENDFORM.                    " FRM_MAKE_FILE
*&---------------------------------------------------------------------*
*&      Form  FRM_TBL_APPEND
*&---------------------------------------------------------------------*
*       内部テーブル更新処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_TBL_APPEND.

* ↓ APPEND 2002.04.26 PSD K.ARAI
PERFORM FRM_PSTYV_EDIT.
* ↑

*---APPEND START PSD T.SAITOH 2002/06/07 ---------------------------*
PERFORM FRM_COMPUTE_SINGLE_COST.
*---APPEND END   PSD T.SAITOH 2002/06/07 ---------------------------*



SORT GT_WRITE BY KUNNR PNAME VBELN BUNSI.
LOOP AT GT_WRITE INTO GF_WRITE.

*--- 2003/10/29 APPEND 概算金額の項目を追加
PERFORM FRM_CALC_KONTWR  USING     GF_WRITE-KONTPR
GF_WRITE-LFIMG
CHANGING  GF_WRITE-KONTWR.
CONDENSE GF_WRITE-KONTWR NO-GAPS.
*--- APPEND END

*--- 2003/10/29 APPEND 概算消費税額の項目を追加
PERFORM FRM_CALC_KONBTR  USING    GF_WRITE-KONTWR
CHANGING GF_WRITE-KONBTR.
CONDENSE GF_WRITE-KONBTR NO-GAPS.
*--- APPEND END

*--- 2003/10/29 APPEND 概算合計額の項目を追加
PERFORM FRM_CALC_KONTWRT  USING    GF_WRITE-KONTWR
GF_WRITE-KONBTR
CHANGING GF_WRITE-KONTWRT.
CONDENSE GF_WRITE-KONTWRT NO-GAPS.
*-- APPEND END

*--- ファイルタブ区切り処理
PERFORM FRM_TBL_TAB.
*--- ファイル作成処理
PERFORM FRM_MAKE_FILE.
CUT_DATA = CUT_DATA + 1.
ENDLOOP.

ENDFORM.                    " FRM_TBL_APPEND
*&---------------------------------------------------------------------*
*&      Form  FRM_TBL_TAB
*&---------------------------------------------------------------------*
*       内部テーブルタブ区切り処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_TBL_TAB.

*---APPEND START PSD T.SAITOH 2002/08/14 ---------------------------*
* 出庫日、納期予定日を出力しない（ブランクを設定）
CLEAR: GF_WRITE-WADAT,
GF_WRITE-BSTDK.
*---APPEND END   PSD T.SAITOH 2002/08/14 ---------------------------*
***2002.09.30 ADD >>>
* IF p_suryo <> SPACE.
**  CLEAR:GF_WRITE-LFIMG.   "2002.09.30
**  GF_WRITE-LFIMG = P_SURYO.
* ENDIF.
*--- 明細行編集
* Mod ES-UP 2012/08/22 -->
*  CONCATENATE GF_WRITE-PNAME CNS_09      " プリンタ／トレイ
*              GF_WRITE-TNAME CNS_09      " 帳票名
*              SY-DATUM       CNS_09      " 出力日
*              GF_WRITE-VBELN CNS_09      " 受注伝票番号
*              GF_WRITE-KUNNR CNS_09      " 得意先コード
** ↓ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
*              GF_WRITE-KSCHL CNS_09      " 出力タイプ
** ↑
*              GF_WRITE-BSTKD CNS_09      " 注文番号
*              GF_WRITE-KDMAT CNS_09      " 図版
*              GF_WRITE-POSTX CNS_09      " 商品名
*              GF_WRITE-LFIMG CNS_09      " 数量
*              GF_WRITE-VRKME CNS_09      " 単位
*              GF_WRITE-NETPR CNS_09      " 単価
*              GF_WRITE-KEBTR CNS_09      " 税額
*              GF_WRITE-SNIBK CNS_09      " 社内用備考
*              GF_WRITE-SZITK CNS_09      " 消費税用注記
*              GF_WRITE-WADAT CNS_09      " 出庫日
**                             CNS_09      " 出庫日
*              GF_WRITE-EIGNM CNS_09      " 営業所名
*              GF_WRITE-EIGTN CNS_09      " 営業所電話番号
*              GF_WRITE-EIGFN CNS_09      " 営業所ＦＡＸ番号
*              GF_WRITE-EIGPC CNS_09      " 営業所郵便番号
*              GF_WRITE-EGAD1 CNS_09      " 営業所住所１
*              GF_WRITE-EGAD2 CNS_09      " 営業所住所２
*              GF_WRITE-EGAD3 CNS_09      " 営業所住所３
*              GF_WRITE-SKNM1 CNS_09      " 出荷先名
*              GF_WRITE-SKNM2 CNS_09      " 名称２
*              GF_WRITE-SKNM3 CNS_09      " 名称３
*              GF_WRITE-SKSPC CNS_09      " 出荷先郵便番号
*              GF_WRITE-SKAD1 CNS_09      " 出荷先住所１
*              GF_WRITE-SKAD2 CNS_09      " 出荷先住所２
*              GF_WRITE-SKAD3 CNS_09      " 出荷先住所３
*              GF_WRITE-HBMCD CNS_09      " 発注部門コード
*              GF_WRITE-TISCD CNS_09      " 訂正コード
*              GF_WRITE-SKKBN CNS_09      " 支給区分
*              GF_WRITE-KBTNT CNS_09      " 購買担当
*              GF_WRITE-SKKSH CNS_09      " 材質・規格・寸法
*              GF_WRITE-HINNM CNS_09      " 品名（品名仕様）
*              GF_WRITE-KSKBN CNS_09      " 検査区分
*              GF_WRITE-JYSRN CNS_09      " 自由使用欄
*              GF_WRITE-BIKOU CNS_09      " 備考
*              GF_WRITE-SZKBN CNS_09      " 消費税区分
*              GF_WRITE-NASNM CNS_09      " 納入先宛先名
*              GF_WRITE-NNKNM CNS_09      " 納入キー番号
*              GF_WRITE-FKSTI CNS_09      " 付加数値
*              GF_WRITE-UWSBS CNS_09      " 受渡場所名
*              GF_WRITE-HTBCD CNS_09      " 発注者用バーコード情報
*              GF_WRITE-HTBKU CNS_09      " 発注者用備考
*              GF_WRITE-IRISU CNS_09      " 入り数
*              GF_WRITE-KOGUT CNS_09      " 個口
*              GF_WRITE-BUNSI CNS_09      " 分子
*              GF_WRITE-EDATU CNS_09      " 納期
*              GF_WRITE-BSTDK CNS_09      " 納期予定日
*              GF_WRITE-KWMENG CNS_09     " 受注数
*              GF_WRITE-JTBKU CNS_09      " 受注者用備考
*              GF_WRITE-NINNO CNS_09      " 納入No
*              GF_WRITE-AUDAT CNS_09      " 注文納期
*              GF_WRITE-TNKBN CNS_09      " 直納区分
*              GF_WRITE-RHAKO CNS_09      " 再出力区分
** ↓ APPEND 2002.03.01 PSD M.ARAI 項目追加対応
*              GF_WRITE-ENDTYP CNS_09     " 納入完了区分
*              GF_WRITE-UNTTYP CNS_09     " 単価区分
*              GF_WRITE-PRDNUM CNS_09     " 製造番号
** ↓ MODIFY 2002.04.26 PSD K.ARAI
*** ↓ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
**              GF_WRITE-UWBCD             " 受渡場所
*** ↑ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
*** ↑ APPEND 2002.03.01 PSD M.ARAI 項目追加対応
*              GF_WRITE-UWBCD  CNS_09      " 受渡場所
*              GF_WRITE-NETWR  CNS_09      " 受注金額
*              GF_WRITE-NETWRT CNS_09      " 受注税込金額
** ↑ MODIFY 2002.04.26 PSD K.ARAI
***  append 2003.06.09
**              GF_WRITE-KONTPR             "概算単価
**-- 2003/10/29 APPEND
*              GF_WRITE-KONTPR CNS_09     "概算単価
*              GF_WRITE-KONTWR CNS_09     "概算金額
*              GF_WRITE-KONBTR CNS_09     "概算消費税額
*              GF_WRITE-KONTWRT           "概算合計額
**--APPEND END
*    INTO GF_FILE.
CONCATENATE GF_WRITE-PNAME       " プリンタ／トレイ
GF_WRITE-TNAME       " 帳票名
SY-DATUM             " 出力日
GF_WRITE-VBELN       " 受注伝票番号
GF_WRITE-KUNNR       " 得意先コード
GF_WRITE-KSCHL       " 出力タイプ
GF_WRITE-BSTKD       " 注文番号
GF_WRITE-KDMAT       " 図版
GF_WRITE-POSTX       " 商品名
GF_WRITE-LFIMG       " 数量
GF_WRITE-VRKME       " 単位
GF_WRITE-NETPR       " 単価
GF_WRITE-KEBTR       " 税額
GF_WRITE-SNIBK       " 社内用備考
GF_WRITE-SZITK       " 消費税用注記
GF_WRITE-WADAT       " 出庫日
GF_WRITE-EIGNM       " 営業所名
GF_WRITE-EIGTN       " 営業所電話番号
GF_WRITE-EIGFN       " 営業所ＦＡＸ番号
GF_WRITE-EIGPC       " 営業所郵便番号
GF_WRITE-EGAD1       " 営業所住所１
GF_WRITE-EGAD2       " 営業所住所２
GF_WRITE-EGAD3       " 営業所住所３
GF_WRITE-SKNM1       " 出荷先名
GF_WRITE-SKNM2       " 名称２
GF_WRITE-SKNM3       " 名称３
GF_WRITE-SKSPC       " 出荷先郵便番号
GF_WRITE-SKAD1       " 出荷先住所１
GF_WRITE-SKAD2       " 出荷先住所２
GF_WRITE-SKAD3       " 出荷先住所３
GF_WRITE-HBMCD       " 発注部門コード
GF_WRITE-TISCD       " 訂正コード
GF_WRITE-SKKBN       " 支給区分
GF_WRITE-KBTNT       " 購買担当
GF_WRITE-SKKSH       " 材質・規格・寸法
GF_WRITE-HINNM       " 品名（品名仕様）
GF_WRITE-KSKBN       " 検査区分
GF_WRITE-JYSRN       " 自由使用欄
GF_WRITE-BIKOU       " 備考
GF_WRITE-SZKBN       " 消費税区分
GF_WRITE-NASNM       " 納入先宛先名
GF_WRITE-NNKNM       " 納入キー番号
GF_WRITE-FKSTI       " 付加数値
GF_WRITE-UWSBS       " 受渡場所名
GF_WRITE-HTBCD       " 発注者用バーコード情報
GF_WRITE-HTBKU       " 発注者用備考
GF_WRITE-IRISU       " 入り数
GF_WRITE-KOGUT       " 個口
GF_WRITE-BUNSI       " 分子
GF_WRITE-EDATU       " 納期
GF_WRITE-BSTDK       " 納期予定日
GF_WRITE-KWMENG      " 受注数
GF_WRITE-JTBKU       " 受注者用備考
GF_WRITE-NINNO       " 納入No
GF_WRITE-AUDAT       " 注文納期
GF_WRITE-TNKBN       " 直納区分
GF_WRITE-RHAKO       " 再出力区分
GF_WRITE-ENDTYP      " 納入完了区分
GF_WRITE-UNTTYP      " 単価区分
GF_WRITE-PRDNUM      " 製造番号
GF_WRITE-UWBCD       " 受渡場所
GF_WRITE-NETWR       " 受注金額
GF_WRITE-NETWRT      " 受注税込金額
GF_WRITE-KONTPR      "概算単価
GF_WRITE-KONTWR      "概算金額
GF_WRITE-KONBTR      "概算消費税額
GF_WRITE-KONTWRT     "概算合計額
INTO GF_FILE
SEPARATED BY CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
* Mod ES-UP 2012/08/22 <--
ENDFORM.                    " FRM_TBL_TAB
*&---------------------------------------------------------------------*
*&      Form  FRM_FILE_HEADER
*&---------------------------------------------------------------------*
*       ファイルヘッダ部更新処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_FILE_HEADER.
**** START DEL 2014/09/01 ISID11 ****
** Add ES-UP 2012/08/22 -->
*  DATA L_CODEPAGE TYPE ABAP_ENCODING.
*  L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_SJIS ).
** Add ES-UP 2012/08/22 <--
**** END DEL 2014/09/01 ISID11 ****
**** START ADD 2015/01/23 ISID11 ****
DATA:
L_FILENAME TYPE  ZTEGZZM001-Z_OUTPUT_FN,
L_Z_OUTPUT_CP TYPE  ZTEGZZM001-Z_OUTPUT_CP,
L_CODEPAGE TYPE ABAP_ENCODING,
L_SAPCODEPAGE TYPE STRING,
L_FLGUTF8  TYPE  FLAG,
L_SUBRC    TYPE SY-SUBRC.
**** END ADD 2015/01/23 ISID11 ****

CLEAR F_ERR.
IF GT_WRITE IS INITIAL.
MESSAGE S611(Z1).
STOP.
ELSE.

**** START ADD 2015/01/23 ISID11 ****
CALL FUNCTION 'ZEG_ZZ_GLOBAL_PGM_CONFIG_GET'
EXPORTING
IMPPGM      = SY-REPID
IMPBUKRS    = 'C001'
IMPORTING
EXPFILENAME = L_FILENAME
EXPCODEPAGE = L_Z_OUTPUT_CP
EXPFLGUTF8  = L_FLGUTF8.
**** END ADD 2015/01/23 ISID11 ****

*--- ファイル名更新
CONCATENATE
**** START UPD 2015/01/23 ISID11 ****
*                SY-REPID
L_FILENAME
**** END UPD 2015/01/23 ISID11 ****
SY-UNAME
SY-UZEIT
'.txt'
INTO G_FILENAME.

CONCATENATE P_FILE
G_FILENAME
INTO G_FILEOPENNAME.

*--- ファイルＯＰＥＮ処理

**** START ADD 2015/01/23 ISID11 ****
IF L_FLGUTF8 IS INITIAL.

L_SAPCODEPAGE = L_Z_OUTPUT_CP.

IF L_SAPCODEPAGE IS NOT INITIAL.

L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( L_SAPCODEPAGE ).

ENDIF.

TRY .
OPEN DATASET G_FILEOPENNAME FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
IGNORING CONVERSION ERRORS.

L_SUBRC = SY-SUBRC.

CATCH CX_SY_CODEPAGE_CONVERTER_INIT.

L_SUBRC = 8.

ENDTRY.

ELSE.
**** END ADD 2015/01/23 ISID11 ****

* Mod ES-UP 2012/08/22 -->
*    OPEN DATASET G_FILEOPENNAME FOR OUTPUT IN TEXT MODE.
OPEN DATASET G_FILEOPENNAME FOR OUTPUT
**** START UPD 2014/09/01 ISID11 ****
*      IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
IN TEXT MODE ENCODING UTF-8
**** END UPD 2014/09/01 ISID11 ****
IGNORING CONVERSION ERRORS.

**** START ADD 2015/01/23 ISID11 ****
L_SUBRC = SY-SUBRC.
**** END ADD 2015/01/23 ISID11 ****

* Mod ES-UP 2012/08/22 <--

**** START ADD 2015/01/23 ISID11 ****
ENDIF.
**** END ADD 2015/01/23 ISID11 ****

**** START UPD 2015/01/23 ISID11 ****
*    IF SY-SUBRC <> 0.
IF L_SUBRC <> 0.
**** END UPD 2015/01/23 ISID11 ****
PERFORM FRM_FILE_ERR.
ROLLBACK WORK.
STOP.
ENDIF.

*--- ヘッダ行更新
GF_FILE = '<start>'.
*--- ファイル作成処理
PERFORM FRM_MAKE_FILE.

CONCATENATE 'VrSetDocName2='
TEXT-049
SY-TITLE
'('
SY-UNAME
')'
TEXT-049
INTO GF_FILE.
*--- ファイル作成処理
PERFORM FRM_MAKE_FILE.

GF_FILE = '<end>'.
*--- ファイル作成処理
PERFORM FRM_MAKE_FILE.

*--- タイトル行更新
* Mod ES-UP 2012/08/22 -->
*    CONCATENATE TEXT-005 CNS_09
*                TEXT-019 CNS_09
*                TEXT-020 CNS_09
*                TEXT-055 CNS_09
*                TEXT-114 CNS_09
**↓ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
*                TEXT-121 CNS_09
**↑
*                TEXT-024 CNS_09
*                TEXT-026 CNS_09
*                TEXT-028 CNS_09
*                TEXT-031 CNS_09
*                TEXT-032 CNS_09
*                TEXT-059 CNS_09
*                TEXT-060 CNS_09
*                TEXT-061 CNS_09
*                TEXT-062 CNS_09
*                TEXT-063 CNS_09
*                TEXT-035 CNS_09
*                TEXT-064 CNS_09
*                TEXT-065 CNS_09
*                TEXT-066 CNS_09
*                TEXT-067 CNS_09
*                TEXT-068 CNS_09
*                TEXT-069 CNS_09
*                TEXT-021 CNS_09
*                TEXT-070 CNS_09
*                TEXT-071 CNS_09
*                TEXT-072 CNS_09
*                TEXT-073 CNS_09
*                TEXT-074 CNS_09
*                TEXT-075 CNS_09
*                TEXT-076 CNS_09
*                TEXT-077 CNS_09
*                TEXT-078 CNS_09
*                TEXT-079 CNS_09
*                TEXT-080 CNS_09
*                TEXT-081 CNS_09
*                TEXT-082 CNS_09
*                TEXT-083 CNS_09
*                TEXT-084 CNS_09
*                TEXT-085 CNS_09
*                TEXT-086 CNS_09
*                TEXT-087 CNS_09
*                TEXT-088 CNS_09
*                TEXT-089 CNS_09
*                TEXT-090 CNS_09
*                TEXT-091 CNS_09
*                TEXT-092 CNS_09
*                TEXT-093 CNS_09
*                TEXT-094 CNS_09
*                TEXT-029 CNS_09
*                TEXT-095 CNS_09
*                TEXT-096 CNS_09
*                TEXT-097 CNS_09
*                TEXT-098 CNS_09
*                TEXT-099 CNS_09
*                TEXT-100 CNS_09
*                TEXT-101 CNS_09
** ↓ APPEND 2002.03.04 PSD M.Arrai 納入完了区分追加対応
*                TEXT-116 CNS_09
*                TEXT-117 CNS_09
*                TEXT-118 CNS_09
** ↓ MODIFY 2002.04.26 PSD K.ARAI
*** ↓ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
**                TEXT-120
*** ↑ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
*** ↑ APPEND 2002.03.04 PSD M.Arrai 納入完了区分追加対応
*               TEXT-120 CNS_09
*               TEXT-122 CNS_09
*               TEXT-123 CNS_09
** ↑ MODIFY 2002.04.26 PSD K.ARAI
***    append 2003.06.09
**               TEXT-126
***    append end.
**-- 2003/10/23 APPEND
*                TEXT-126 CNS_09      "概算単価
*                TEXT-127 CNS_09      "概算金額
*                TEXT-128 CNS_09      "概算消費税額
*                TEXT-129             "概算合計額
**-- APPEND END
*      INTO GF_FILE.
CONCATENATE TEXT-005       " プリンタ／トレイ
TEXT-019       " 帳票名
TEXT-020       " 出力日
TEXT-055       " 受注伝票番号
TEXT-114       " 得意先コード
TEXT-121       " 出力タイプ
TEXT-024       " 注文番号
TEXT-026       " 図版
TEXT-028       " 商品名
TEXT-031       " 数量
TEXT-032       " 単位
TEXT-059       " 単価
TEXT-060       " 税額
TEXT-061       " 社内用備考
TEXT-062       " 消費税用注記
TEXT-063       " 出庫日
TEXT-035       " 営業所名
TEXT-064       " 営業所電話番号
TEXT-065       " 営業所ＦＡＸ番号
TEXT-066       " 営業所郵便番号
TEXT-067       " 営業所住所１
TEXT-068       " 営業所住所２
TEXT-069       " 営業所住所３
TEXT-021       " 出荷先名
TEXT-070       " 名称２
TEXT-071       " 名称３
TEXT-072       " 出荷先郵便番号
TEXT-073       " 出荷先住所１
TEXT-074       " 出荷先住所２
TEXT-075       " 出荷先住所３
TEXT-076       " 発注部門コード
TEXT-077       " 訂正コード
TEXT-078       " 支給区分
TEXT-079       " 購買担当
TEXT-080       " 材質・規格・寸法
TEXT-081       " 品名（品名仕様）
TEXT-082       " 検査区分
TEXT-083       " 自由使用欄
TEXT-084       " 備考
TEXT-085       " 消費税区分
TEXT-086       " 納入先宛先名
TEXT-087       " 納入キー番号
TEXT-088       " 付加数値
TEXT-089       " 受渡場所名
TEXT-090       " 発注者用バーコード情報
TEXT-091       " 発注者用備考
TEXT-092       " 入り数
TEXT-093       " 個口
TEXT-094       " 分子
TEXT-029       " 納期
TEXT-095       " 納期予定日
TEXT-096       " 受注数
TEXT-097       " 受注者用備考
TEXT-098       " 納入No
TEXT-099       " 注文納期
TEXT-100       " 直納区分
TEXT-101       " 再出力区分
TEXT-116       " 納入完了区分
TEXT-117       " 単価区分
TEXT-118       " 製造番号
TEXT-120       " 受渡場所
TEXT-122       " 受注金額
TEXT-123       " 受注税込金額
TEXT-126       "概算単価
TEXT-127       "概算金額
TEXT-128       "概算消費税額
TEXT-129       "概算合計額
INTO GF_FILE
SEPARATED BY CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
* Mod ES-UP 2012/08/22 <--
*--- ファイル作成処理
PERFORM FRM_MAKE_FILE.
ENDIF.

ENDFORM.                    " FRM_FILE_HEADER
*&---------------------------------------------------------------------*
*&      Form  FRM_UPDATE_DATA
*&---------------------------------------------------------------------*
*       テーブル更新処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_UPDATE_DATA.
CHECK NOT ( GT_WRITE IS INITIAL ).
*--- ＮＡＳＴテーブルＫＥＹ取得処理
* ↓ DELETE 2002/03/25 PSD M.ARAI NAST更新不具合対応
*  PERFORM FRM_NAST_KEYGET.
* ↑
*--- ＮＡＳＴテーブル更新処理
IF R_REOUT = CNS_X.
UPDATE NAST SET DATVR = SY-DATUM
UHRVR = SY-UZEIT
USNAM = SY-UNAME
*--- 2002/05/10 APPEND PSD K.ARAI
LDEST = GF_NAST-LDEST
*--- 2002/05/10 APPEND END
WHERE KAPPL         = 'V1'
AND KSCHL         = GF_NAST-KSCHL
AND SPRAS         = 'J'
* ↓ MODIFY 2002/03/25 PSD M.ARAI NAST更新不具合対応
*        AND OBJKY         = GF_NAST_READ-OBJKY
AND OBJKY         = GF_NAST-OBJKY
AND DATVR         = GF_NAST-DATVR
AND UHRVR         = GF_NAST-UHRVR
* ↑
AND VSTAT         = '1'.
ELSEIF R_NMOUT = CNS_X.
UPDATE NAST SET VSTAT = '1'
DATVR = SY-DATUM
UHRVR = SY-UZEIT
USNAM = SY-UNAME
*--- 2002/05/10 APPEND PSD K.ARAI
LDEST = GF_NAST-LDEST
*--- 2002/05/10 APPEND END
WHERE KAPPL         = 'V1'
AND KSCHL         = GF_NAST-KSCHL
AND SPRAS         = 'J'
* ↓ MODIFY 2002/03/25 PSD M.ARAI NAST更新不具合対応
*        AND OBJKY         = GF_NAST_READ-OBJKY
AND OBJKY         = GF_NAST-OBJKY
* ↑
AND VSTAT         = '0'.
ENDIF.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
*--- ＤＥ更新エラー処理
PERFORM FRM_DE_ERR.
*--- テーブルロック解除処理
PERFORM DEQUEUE_EZNAST.
ROLLBACK WORK.
STOP.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_NAST
SY-SUBRC.
ENDCASE.
ENDFORM.                    " FRM_UPDATE_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_TSP03L_GET
*&---------------------------------------------------------------------*
*       テーブル読込条件⑨
*       スプール：デバイス名（長）情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_TSP03L_GET.
*--- スプール：デバイス名（長）情報取得
CHECK F_TSP03L <> CNS_X.
SELECT LNAME PADEST
FROM TSP03L INTO TABLE GT_TSP03L.

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
F_TSP03L = CNS_X.
WHEN 4.         " 対象データなし
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_TSP03L
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_TSP03L_GET
*&---------------------------------------------------------------------*
*&      Form  FRM_PNAME_SET
*&---------------------------------------------------------------------*
*       プリンタ／トレイ設定処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_PNAME_SET.

IF P_PRNTR IS INITIAL.
READ TABLE GT_TSP03L INTO GF_TSP03L
WITH KEY PADEST = GF_NAST-LDEST.
CASE SY-SUBRC.
WHEN 0.
GF_WRITE-PRNTR = GF_NAST-LDEST.
GF_WRITE-PNAME = GF_TSP03L-LNAME.
WHEN 4.
*--- エラーメッセージ出力処理
CUT_ERR = CUT_ERR + 1.
PERFORM FRM_SELECT_MESSAGE USING TEXT-005
GF_VBAP-VBELN
GF_VBAP-POSNR.
F_ERR = CNS_X.
ENDCASE.
ELSEIF NOT P_PRNTR IS INITIAL.
READ TABLE GT_TSP03L INTO GF_TSP03L
WITH KEY LNAME = P_PRNTR.
CASE SY-SUBRC.
WHEN 0.
GF_WRITE-PRNTR = GF_TSP03L-PADEST.
GF_WRITE-PNAME = P_PRNTR.
*--- 2002/05/10 APPEND PSD K.ARAI
GF_NAST-LDEST = GF_TSP03L-PADEST.
*--- 2002/05/10
WHEN 4.
*--- エラーメッセージ出力処理
CUT_ERR = CUT_ERR + 1.
PERFORM FRM_SELECT_MESSAGE USING TEXT-005
GF_VBAP-VBELN
GF_VBAP-POSNR.
F_ERR = CNS_X.
ENDCASE.
ENDIF.

ENDFORM.                    " FRM_PNAME_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_TBL_MAKE
*&---------------------------------------------------------------------*
*       ファイル編集処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_TBL_MAKE.

CONCATENATE GF_VBAP-VBELN
'-'
GF_VBAP-POSNR
INTO GF_WRITE-VBELN.                    " 受注伝票番号
GF_WRITE-KUNNR = GF_VBAP-KUNNR.                     " 得意先コード
* ↓ APPEND 2002.03.11 PSD M.ARAI 受渡場所・出力タイプ追加対応
GF_WRITE-KSCHL = GF_NAST-KSCHL.                     " 出力タイプ
*
GF_WRITE-BSTKD = GF_VBAP-BSTKD.                     " 注文番号
GF_WRITE-KDMAT = GF_VBAP-KDMAT.                     " 図番
* ↓変更個所　2002/10/07
IF P_SURYO IS INITIAL .
GF_WRITE-LFIMG = GF_VBAP-KWMENG.                    " 数量
ELSE .
GF_WRITE-LFIMG = P_SURYO .                          " 数量
ENDIF .
* ↑変更個所　2002/10/07
* GF_WRITE-LFIMG = GF_VBAP-KWMENG.                    " 数量
* ↑元の処理
IF GF_VBAP-KWMENG < 0.
SHIFT GF_WRITE-LFIMG RIGHT CIRCULAR.
ENDIF.
CONDENSE GF_WRITE-LFIMG NO-GAPS.
WRITE GF_VBAP-VRKME TO GF_WRITE-VRKME.              " 単位
*  GF_WRITE-WADAT = GF_INFO-WADAT_IST.                 " 出庫日
* ↓ APPEND 2002.03.15 PSD M.ARAI 出庫日対応
GF_WRITE-WADAT = GF_VBAP-AUDAT.                     " 出庫日
* ↑

GF_WRITE-HINNM = GF_WRITE-POSTX.                    " 品名（品名仕様）
**-- Delete 1 Line  S  2002/08/24  PSD T.IIDA --**
*  GF_WRITE-FKSTI = GF_VBAP-POSNR.                     " 付加数値
**-- Delete 1 Line  E  2002/08/24  PSD T.IIDA --**
* 2002/02/18 PSD H.Tanaka MOD ↓
*  IF R_NMOUT = CNS_X.
* Edit 2013.02.20 GSL Tohtake.s Start
*  IF   R_NMOUT = CNS_X OR
*     ( R_REOUT = CNS_X AND
*       P_OUTNO IS INITIAL ).
IF   P_OUTNO IS INITIAL.
* Edit 2013.02.20 GSL Tohtake.s End
GF_WRITE-IRISU = GF_WRITE-LFIMG.                  " 入り数
GF_WRITE-KOGUT = '1'.                             " 個口
GF_WRITE-BUNSI = '1'.                             " 分子
ENDIF.

GF_WRITE-EDATU  = GF_VBAP-EDATU.                    " 納期
GF_WRITE-BSTDK  = GF_VBAP-BSTDK_E.                  " 納期予定日
GF_WRITE-KWMENG = GF_VBAP-KWMENG.                   " 受注数
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-KWMENG NO-GAPS.
* ↑
GF_WRITE-AUDAT  = GF_VBAP-AUDAT.                    " 注文納期
* ↓ APPEND 2002.04.26 PSD K.ARAI
GF_WRITE-NETWRT = GF_WRITE-NETWR + GF_WRITE-KEBTR.  " 受注税込金額
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-NETWRT NO-GAPS.
* ↑
GF_WRITE-PSTYV  = GF_VBAP-PSTYV.                    " 明細カテゴリ
* ↑

ENDFORM.                    " FRM_TBL_MAKE
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MESSAGE
*&---------------------------------------------------------------------*
*       エラーメッセージ出力処理
*----------------------------------------------------------------------*
*      -->P_TEXT      テキスト
*      -->P_VBELN     出荷伝票番号
*      -->P_VGPOS     出荷明細番号
*----------------------------------------------------------------------*
FORM FRM_SELECT_MESSAGE USING  P_TEXT
P_VBELN
P_VGPOS.
IF CUT_ERR = 1.
WRITE / TEXT-054.
ENDIF.
WRITE: / TEXT-055,
P_VBELN,
TEXT-113,
P_VGPOS,
TEXT-041,
P_TEXT,
TEXT-040.

ENDFORM.                    " FRM_SELECT_MESSAGE
*&---------------------------------------------------------------------*
*&      Form  FRM_FILE_ERR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_FILE_ERR.

IF CUT_ERR = 1.
WRITE / TEXT-053.
ENDIF.
WRITE: / TEXT-111,
TEXT-043,
TEXT-044.

ENDFORM.                    " FRM_FILE_ERR
*&---------------------------------------------------------------------*
*&      Form  FRM_DE_ERR
*&---------------------------------------------------------------------*
*       ＤＥ更新エラー処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_DE_ERR.

WRITE: / TEXT-051.
WRITE: / TEXT-045,
GF_WRITE-TNAME,
TEXT-048,
TEXT-044.

ENDFORM.                    " FRM_DE_ERR
*&---------------------------------------------------------------------*
*&      Form  FRM_END_MESSAGE
*&---------------------------------------------------------------------*
*       終了メッセージ処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_END_MESSAGE.

CHECK F_ERR <> CNS_X.
IF GT_WRITE IS INITIAL.
ELSE.
*--- テーブルロック解除処理
COMMIT WORK.
PERFORM DEQUEUE_EZNAST.
SKIP.
WRITE: / TEXT-052,
/ TEXT-111,
TEXT-046,
CUT_DATA,
TEXT-047.
ENDIF.

ENDFORM.                    " FRM_END_MESSAGE
*&---------------------------------------------------------------------*
*&      Form  FRM_TNAME_SET
*&---------------------------------------------------------------------*
*       帳票名設定処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_TNAME_SET.
*--- 帳票情報取得
* ↓ MODIFY 2002.03.04 PSD M.ARAI 帳票名設定不具合対応
*  READ TABLE GT_T685T INTO GF_T685T
*    WITH KEY KSCHL = GF_NAST-KSCHL.
*  IF SY-SUBRC = 0.
*    GF_WRITE-TNAME = GF_T685T-VTEXT.
*  ENDIF.
GF_WRITE-TNAME = TEXT-119.
* ↑
ENDFORM.                    " FRM_TNAME_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_NAST_KEYGET
*&---------------------------------------------------------------------*
*       ＮＡＳＴテーブルＫＥＹ取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_NAST_KEYGET.
READ TABLE GT_NAST INTO GF_NAST_READ
WITH KEY OBJKY+0(10) = GF_VBAP-VBELN.
ENDFORM.                    " FRM_NAST_KEYGET
*&---------------------------------------------------------------------*
*&      Form  FRM_REOUT_DATA
*&---------------------------------------------------------------------*
*       再出力用ファイル出力用情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_REOUT_DATA.
*--- 販売伝票情報取得処理
PERFORM FRM_REOUT_VBAP.

LOOP AT GT_VBAP INTO GF_VBAP.
* ↓ APPEND 2002.03.04 PSD M.Arai 対象レコード取得不具合対応
CLEAR F_ERR.
* ↑

*--- メッセージステータス情報取得処理
PERFORM FRM_NAST_CHECK.
CHECK F_ERR <> CNS_X.
PERFORM FRM_REOUT_NAST.
LOOP AT GT_NAST INTO GF_NAST
WHERE OBJKY+0(10) = GF_VBAP-VBELN.
* ↓ APPEND 2002.04.26 PSD K.Arai
IF GF_NAST-OBJKY+10(6) = SPACE.
CONTINUE.
ENDIF.
* ↑
* ↓ APPEND 2002.03.04 PSD M.Arai 対象レコード取得不具合対応
CLEAR F_ERR.
* ↑
* 2002/02/20 PSD H.Tanaka ADD ↓
*--- テーブルロック処理
PERFORM ENQUEUE_EZNAST.
*--- ファイル出力用内部テーブル設定処理
PERFORM FRM_MAKE_DATA.
* ↓ APPEND 2002.03.04 PSD M.Arai 対象レコード取得不具合対応
CHECK F_ERR <> CNS_X.
* ↑
* ↓ DELETE 2002.04.26 PSD K.Arai
** 2002/02/18 PSD H.Tanaka MOD ↓
*        IF P_OUTNO IS INITIAL.
* ↑
*--- 出力用内部テーブル更新処理
APPEND GF_WRITE TO GT_WRITE.
* ↓ DELETE 2002.04.26 PSD K.Arai
*        ELSE.
*          PERFORM FRM_IRISU_SET.
*        ENDIF.
* ↑
*--- テーブル更新処理
PERFORM FRM_UPDATE_DATA.

* ↓ append 2002/03/25 psd m.arai NAST更新不具合対応
EXIT.
* ↑
ENDLOOP.
ENDLOOP.
*--- エラーメッセージ出力処理
IF F_NAST <> CNS_X.
MESSAGE S611(Z1).
STOP.
ENDIF.

ENDFORM.                    " FRM_REOUT_DATA
*&---------------------------------------------------------------------*
*&      Form  ENQUEUE_EZNAST
*&---------------------------------------------------------------------*
*       ＮＡＳＴロック処理
*----------------------------------------------------------------------*
*      -->P_KSCHL   text
*----------------------------------------------------------------------*
* 2002/02/20 PSD H.Tanaka MOD ↓
*FORM ENQUEUE_EZNAST USING P_KSCHL.
FORM ENQUEUE_EZNAST.

*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
DATA:L_UNAME LIKE SY-UNAME."ユーザーＩＤ
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*

CALL FUNCTION 'ENQUEUE_EZNAST'
EXPORTING
MODE_NAST = 'E'                       " 排他制御
MANDT     = SY-MANDT                  " クライアント番号
KAPPL     = 'V1'                      " アプリケーション
* 2002/02/20 PSD H.Tanaka ADD ↓
OBJKY     = GF_NAST-OBJKY             " オブジェクトキー
* 2002/02/20 PSD H.Tanaka MOD ↓
*            KSCHL     = P_KSCHL                   " メッセージタイプ
KSCHL     = GF_NAST-KSCHL             " メッセージタイプ
SPRAS     = 'J'                       " メッセージ言語
EXCEPTIONS
FOREIGN_LOCK = 1
OTHERS       = 2.

CASE SY-SUBRC.
WHEN 0.
WHEN 1.
*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
*     ユーザーＩＤを取得
PERFORM FRM_ENQ_CHECK USING L_UNAME.
*     エラーメッセージ：XXXX が処理中です
MESSAGE S023(Z1) WITH L_UNAME. "
ROLLBACK WORK. " ロールバック
**--- 2002/05/10 MODIFY PSD K.ARAI
*      MESSAGE S023(Z1).
**      MESSAGE S004(Z1) WITH CNS_NAST.
**--- 2002/05/10 END
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*
STOP.
WHEN OTHERS.
MESSAGE A502(Z1) WITH 'ENQUEUE_EZNAST'
SY-SUBRC.
ENDCASE.

ENDFORM.                    " ENQUEUE_EZNAST

*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_ENQ_CHECK
*&---------------------------------------------------------------------*
*       ロックユーザーＩＤ取得
*----------------------------------------------------------------------*
FORM FRM_ENQ_CHECK USING P_UNAME.

DATA:L_GARG TYPE SEQG3-GARG."キー

* ロックキーの設定

CONCATENATE SY-MANDT
'V1'
GF_NAST-OBJKY
'*'
GF_NAST-KSCHL
'J'
INTO L_GARG.

* ロック情報を取得する

CALL FUNCTION 'ENQUEUE_READ'
EXPORTING
GCLIENT       = SY-MANDT
GNAME         = 'NAST'
GARG          = L_GARG
GUNAME        = SPACE
*  IMPORTING
*   NUMBER        =
*   SUBRC         =
TABLES
ENQ           = GT_SEQG3
.
LOOP AT GT_SEQG3 INTO GF_SEQG3.
P_UNAME = GF_SEQG3-GUNAME. " ユーザＩＤを設定
IF GF_SEQG3-GUNAME <> SPACE.
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    "FRM_ENQ_CHECK
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*

*&---------------------------------------------------------------------*
*&      Form  FRM_T685T_GET
*&---------------------------------------------------------------------*
*       テーブル読込条件③
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_T685T_GET.

*--- 出力タイプ情報取得
SELECT KAPPL KSCHL VTEXT
FROM T685T
INTO CORRESPONDING FIELDS OF TABLE GT_T685T
WHERE SPRAS = CNS_J
AND KVEWE = 'B'
AND KAPPL = 'V1'.

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.         " 対象データなし
MESSAGE S600(Z1) WITH TEXT-057.
STOP.
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_T685T
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_T685T_GET
*&---------------------------------------------------------------------*
*&      Form  FRM_NMOUT_NAST
*&---------------------------------------------------------------------*
*       テーブル読込条件①
*       メッセージステータス情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_NMOUT_NAST.
CLEAR:   GF_NAST,
F_NAST,
F_VBAK.
REFRESH: GT_NAST.

*--- メッセージステータス情報取得
SELECT KAPPL OBJKY KSCHL LDEST USNAM
INTO CORRESPONDING FIELDS OF TABLE GT_NAST
FROM NAST
WHERE KAPPL = 'V1'
AND KSCHL = 'ZS01'
AND SPRAS = 'J'
AND VSTAT = '0'.

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.         " 対象データなし
MESSAGE S611(Z1).
STOP.
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_NAST
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_NMOUT_NAST
*&---------------------------------------------------------------------*
*&      Form  FRM_NMOUT_VBAP
*&---------------------------------------------------------------------*
*       テーブル読込条件②
*       販売伝票情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_NMOUT_VBAP.
CLEAR:   GF_VBAP,
F_ERR.
REFRESH: GT_VBAP.
*--- 販売伝票情報取得
*  SELECT SINGLE A~VBELN A~BSTNK A~AUDAT A~AUART A~VKORG
* Edit 2003.03.17 >>>
*  SELECT A~VBELN A~BSTNK A~AUDAT A~AUART A~VKORG
SELECT A~VBELN D~BSTKD A~AUDAT A~AUART A~VKORG
* Edit 2003.03.17 <<<
A~VTWEG A~KUNNR A~WAERK A~KNUMV
* ↓ APPEND 2002.05.10 PSD K.ARAI
A~VKBUR
* ↑
B~POSNR B~KDMAT B~VRKME B~NETPR B~KWMENG
B~MATNR C~EDATU D~BSTDK_E
* ↓ MODIFY 2002.04.26 PSD K.ARAI 抽出項目の追加
B~PSTYV B~NETWR
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI 　単価編集
B~KPEIN
* ↑
*    INTO CORRESPONDING FIELDS OF GT_VBAP
INTO CORRESPONDING FIELDS OF TABLE GT_VBAP
FROM ( ( VBAK AS A INNER JOIN VBAP AS B
ON     A~VBELN  = B~VBELN ) INNER JOIN VBEP  AS C
ON     B~VBELN  = C~VBELN
AND     B~POSNR  = C~POSNR ) INNER JOIN VBKD AS D
ON     B~VBELN  = D~VBELN
WHERE A~VKBUR IN S_VKBUR
AND B~VBELN =  GF_NAST-OBJKY+0(10)
*     AND B~ABGRU =  'ZP'
AND C~ETENR =  '0001'
AND D~POSNR =  '000000'.

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
F_VBAK = CNS_X.
WHEN 4.         " 対象データなし
F_ERR  = CNS_X.
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_VBAP
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_NMOUT_VBAP
*&---------------------------------------------------------------------*
*&      Form  FRM_KEBTR_SET
*&---------------------------------------------------------------------*
*       テーブル読込条件⑩
*       税額設定
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_KEBTR_SET.
*--- 2002/05/09 MODIFY PSD K.ARAI
DATA: LF_KONV  TYPE          TYP_KONV,
LT_KONV  TYPE TABLE OF TYP_KONV.
*DATA: L_KWERT       TYPE KONV-KWERT.
*--- MODIFY END

*--- 条件 (トランザクションデータ)情報取得
SELECT KWERT WAERS KBETR
INTO CORRESPONDING FIELDS OF TABLE LT_KONV
FROM   KONV
WHERE   KNUMV = GF_VBAP-KNUMV            "伝票条件番号
AND   KPOSN = GF_VBAP-POSNR            "条件明細番号
AND   KAPPL = 'V'                      "アプリケーション
AND ( KSCHL = 'MWST'                   "条件タイプ
OR   KSCHL = 'MWSU'
OR   KSCHL = 'MWSD' ) .
*  SELECT SINGLE KWERT
*    INTO (L_KWERT)
*    FROM KONV
*   WHERE KNUMV = GF_VBAP-KNUMV
*     AND KPOSN = GF_VBAP-POSNR
*     AND KAPPL = 'V'
*     AND KSCHL = 'MWST'.

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
*--- 2002/05/09 MODIFY PSD K.ARAI
LOOP AT LT_KONV INTO LF_KONV.
PERFORM FRM_ZEIGAKU_HENKAN USING    GF_VBAP-WAERK
LF_KONV-KWERT
CHANGING GF_WRITE-KEBTR.
EXIT.
ENDLOOP.
** ↓ APPEND 2002.04.26 PSD K.ARAI
**      PERFORM FRM_KINGAKU_HENKAN USING    GF_VBAP-WAERK
**                                          L_KWERT
**                                 CHANGING GF_WRITE-KEBTR.
*      PERFORM FRM_ZEIGAKU_HENKAN USING    GF_VBAP-WAERK
*                                          L_KWERT
*                                 CHANGING GF_WRITE-KEBTR.
** ↑
*--- MODIFY END
WHEN 4.         " 対象データなし
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_KONV
SY-SUBRC.
ENDCASE.
ENDFORM.                    " FRM_KEBTR_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_READ_TEXT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ID      text
*      -->P_VBELN   販売伝票
*      <--P_TDLINE  社内用備考
*----------------------------------------------------------------------*
FORM FRM_READ_TEXT USING    P_ID
P_VBELN
P_OBJECT
CHANGING P_TDLINE.

DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_VBELN     LIKE THEAD-TDNAME.

L_VBELN = P_VBELN.

*--- 汎用モジュール『READ_TEXT』
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID        = P_ID
LANGUAGE  = 'J'
NAME      = L_VBELN
OBJECT    = P_OBJECT
TABLES
LINES     = LT_TLINE
EXCEPTIONS
NOT_FOUND = 4
OTHERS    = 8.
CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
*      P_TDLINE = LF_TLINE+0(40).
P_TDLINE = LF_TLINE-TDLINE.
*--- 2004/05/13 NDSC MASUDA 追加 START ---*
WHEN 4.
P_TDLINE = SPACE.
*--- 2004/05/13 NDSC MASUDA 追加 END   ---*
WHEN 8.
*--- エラーメッセージ出力処理
MESSAGE A502(Z1) WITH 'READ_TEXT'
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_READ_TEXT
*&---------------------------------------------------------------------*
*&      Form  FRM_EIGYO_SET
*&---------------------------------------------------------------------*
*       テーブル読込条件⑥⑦
*       営業所情報設定処理
*----------------------------------------------------------------------*
*      -->P_PARVW   取引機能
*----------------------------------------------------------------------*
FORM FRM_EIGYO_SET USING P_PARVW.
CLEAR GF_ADRC.
*--- 営業所情報設定
SELECT SINGLE B~NAME1 B~NAME2 B~NAME3
B~TEL_NUMBER    B~FAX_NUMBER
B~POST_CODE1    B~CITY1
B~STR_SUPPL1    B~STR_SUPPL2
* ↓ APPEND 2002.04.26 PSD K.ARAI
B~STREET        B~REGION
* ↑
INTO CORRESPONDING FIELDS OF GF_ADRC
FROM VBPA AS A INNER JOIN ADRC AS B
ON A~ADRNR  = B~ADDRNUMBER
WHERE A~VBELN = GF_VBAP-VBELN
* 2002/02/20 PSD H.Tanaka MOD ↓
*     AND A~POSNR = '000000'
AND A~POSNR = GF_VBAP-POSNR
AND A~PARVW = P_PARVW.
*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.         " 対象データなし
* ↓ MODIFY 2002.04.26 PSD K.ARAI
*--- 営業所／仕入先情報再設定
PERFORM FRM_EIGYO_RESET USING P_PARVW.
** 2002/02/20 PSD H.Tanaka ADD ↓
**--- 営業所／仕入先情報再設定
*      PERFORM FRM_EIGYO_RESET USING 'AG'.
* ↑
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_VBPA
SY-SUBRC.
ENDCASE.
*--- APPEND PSD K.ARAI 2002/05/17
*---仕入先住所１データ抽出
PERFORM FRM_SIIRE_ADD1.
*--- APPEND END
ENDFORM.                    " FRM_EIGYO_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_EGSR_SET
*&---------------------------------------------------------------------*
*       営業所／仕入先設定処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_EGSR_SET.

*--- 営業所情報設定
*--- 2002/05/10 MODIFY PSD K.ARAI
PERFORM FRM_SET_EIGYO_INFO.
*  PERFORM FRM_EIGYO_SET USING 'AG'.
GF_WRITE-EIGNM = GF_ADRC_INFO-NAME1.
GF_WRITE-EIGTN = GF_ADRC_INFO-TEL_NUMBER.
GF_WRITE-EIGFN = GF_ADRC_INFO-FAX_NUMBER.
GF_WRITE-EIGPC = GF_ADRC_INFO-POST_CODE1.
GF_WRITE-EGAD1 = GF_ADRC_INFO-CITY1.
GF_WRITE-EGAD2 = GF_ADRC_INFO-STR_SUPPL1.
GF_WRITE-EGAD3 = GF_ADRC_INFO-STR_SUPPL2.
*  GF_WRITE-EIGNM = GF_ADRC-NAME1.
*  GF_WRITE-EIGTN = GF_ADRC-TEL_NUMBER.
*  GF_WRITE-EIGFN = GF_ADRC-FAX_NUMBER.
*  GF_WRITE-EIGPC = GF_ADRC-POST_CODE1.
*  GF_WRITE-EGAD1 = GF_ADRC-CITY1.
*  GF_WRITE-EGAD2 = GF_ADRC-STR_SUPPL1.
*  GF_WRITE-EGAD3 = GF_ADRC-STR_SUPPL2.
*--- 2002/05/10 END

*--- 仕入先情報設定
*---MODIFY START PSD T.SAITOH 2002/05/14 ---------------------------*
*  PERFORM FRM_EIGYO_SET USING 'WE'.
* 出荷先から受注先に変更
PERFORM FRM_EIGYO_SET USING 'AG'.
*---MODIFY END   PSD T.SAITOH 2002/05/14 ---------------------------*
GF_WRITE-SKNM1 = GF_ADRC-NAME1.
GF_WRITE-SKNM2 = GF_ADRC-NAME2.
GF_WRITE-SKNM3 = GF_ADRC-NAME3.
GF_WRITE-SKSPC = GF_ADRC-POST_CODE1.
GF_WRITE-SKAD1 = GF_ADRC-CITY1.
GF_WRITE-SKAD2 = GF_ADRC-STR_SUPPL1.
GF_WRITE-SKAD3 = GF_ADRC-STR_SUPPL2.

ENDFORM.                    " FRM_EGSR_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_READ_SET
*&---------------------------------------------------------------------*
FORM FRM_READ_SET.

DATA: L_VBELN     LIKE THEAD-TDNAME,
*     L_FKSTI     TYPE SY-TABIX.                " 付加数値取得時使用
L_FKSTI(08) TYPE C.                " 付加数値取得時使用
*      LW_FKSTI(08) TYPE N.

CONCATENATE GF_VBAP-VBELN
GF_VBAP-POSNR
INTO L_VBELN.
*--- 社内備考設定
PERFORM FRM_READ_TEXT USING    '0001'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-SNIBK.

*--- 発注部門コード設定
PERFORM FRM_READ_TEXT USING    'Z020'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-HBMCD.

*--- 訂正コード設定
PERFORM FRM_READ_TEXT USING    'Z002'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-TISCD.

*--- 支給区分設定
PERFORM FRM_READ_TEXT USING    'Z004'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-SKKBN.

*--- 購買担当設定
PERFORM FRM_READ_TEXT USING    'Z005'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-KBTNT.

*--- 材質／企画／寸法設定
PERFORM FRM_READ_TEXT USING    'Z006'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-SKKSH.

*--- 検査区分設定
PERFORM FRM_READ_TEXT USING    'Z008'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-KSKBN.

*--- 自由使用欄設定
PERFORM FRM_READ_TEXT USING    'Z009'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-JYSRN.

*--- 備考設定
PERFORM FRM_READ_TEXT USING    'Z010'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-BIKOU.

*--- 消費税区分設定
PERFORM FRM_READ_TEXT USING    'Z011'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-SZKBN.

*--- 納入先宛先名設定
PERFORM FRM_READ_TEXT USING    'Z012'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-NASNM.

*--- 納品キー番号設定
*---modify START PSD T.SAITOH 2002/08/14 ---------------------------*
* IDミスを修正
*  PERFORM FRM_READ_TEXT USING    'Z901'
PERFORM FRM_READ_TEXT USING    'Z902'
*---modify END   PSD T.SAITOH 2002/08/14 ---------------------------*
L_VBELN
'VBBP'
CHANGING GF_WRITE-NNKNM.

*--- 受渡場所名設定
PERFORM FRM_READ_TEXT USING    'Z013'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-UWSBS.

*--- 発注者用バーコード情報設定
PERFORM FRM_READ_TEXT USING    'Z014'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-HTBCD.

*--- 発注者用備考設定
PERFORM FRM_READ_TEXT USING    'Z015'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-HTBKU.

*--- MODIFY START DMC 2008/06/30
*--- 受注者用備考設定
*  PERFORM FRM_READ_TEXT USING    '0002'
*                                 GF_VBAP-VBELN
*                                 'VBBK'
*                        CHANGING GF_WRITE-JTBKU.

DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_VBELN1     LIKE THEAD-TDNAME.

L_VBELN1 = GF_VBAP-VBELN.

*--- 汎用モジュール『READ_TEXT』
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID        = '0002'
LANGUAGE  = 'J'
NAME      = L_VBELN1
OBJECT    = 'VBBK'
TABLES
LINES     = LT_TLINE
EXCEPTIONS
NOT_FOUND = 4
OTHERS    = 8.
CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
GF_WRITE-JTBKU = LF_TLINE-TDLINE.
WHEN 4.
PERFORM FRM_READ_TEXT USING 'Z023'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-JTBKU.
WHEN 8.
MESSAGE A502(Z1) WITH 'READ_TEXT'
SY-SUBRC.
ENDCASE.
*--- MODIFY END DMC 2008/06/30

*--- 納入No設定
*---modify START GSL S.TOHTAKE 2013/08/22 ---------------------------*
*  PERFORM FRM_READ_TEXT USING    'Z902'
PERFORM FRM_READ_TEXT USING    'Z901'
*---modify END   GSL S.TOHTAKE 2013/08/22 ---------------------------*
L_VBELN
'VBBP'
CHANGING GF_WRITE-NINNO.

*--- 直納区分設定
PERFORM FRM_READ_TEXT USING    'Z017'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-TNKBN.

*--- 商品名設定
PERFORM FRM_READ_TEXT USING    'Z018'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-POSTX.
GF_WRITE-HINNM = GF_WRITE-POSTX.                    " 品名（品名仕様）


* ↓ APPEND 2002.03.04 PSD M.Arai 単価区分追加対応
PERFORM FRM_READ_TEXT USING    'Z003'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-UNTTYP.     " 単価区分

* ↑

* ↓ APPEND 2002.03.04 PSD M.Arai 製造番号追加対応
PERFORM FRM_READ_TEXT USING    'Z021'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-PRDNUM.     " 製造番号

* ↑

* ↓ APPEND 2002.03.11 PSD M.Arai 受渡場所・出力タイプ追加対応
PERFORM FRM_READ_TEXT USING    'Z007'
GF_VBAP-VBELN
'VBBK'
CHANGING GF_WRITE-UWBCD .     " 受渡場所
* ↑

**-- Append Start   付加数値取得  2002/08/24  PSD T.IIDA --**
PERFORM FRM_READ_TEXT USING    'Z901'
L_VBELN
'VBBP'
CHANGING L_FKSTI.
*- 数値項目で取得し前０を削除する
***2002.10.07 ADD >>>
IF L_FKSTI CO '0123456789. ' .
*    LW_FKSTI = L_FKSTI.
GF_WRITE-FKSTI = L_FKSTI.
ELSE.
GF_WRITE-FKSTI = L_FKSTI.                           " 付加数値
ENDIF.
CONDENSE GF_WRITE-FKSTI NO-GAPS.                    " Append '02/09/10
***2002.10.07 ADD <<<
**-- Append End     付加数値取得  2002/08/24  PSD T.IIDA --**

ENDFORM.                    " FRM_READ_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_REOUT_VBAP
*&---------------------------------------------------------------------*
*       テーブル読込条件⑪
*       販売伝票情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_REOUT_VBAP.
CLEAR:   GF_VBAP,
F_NAST,
F_VBAK.
REFRESH: GT_VBAP.

*--- 販売伝票情報取得
* Edit 2003.03.17 >>>
*  SELECT A~VBELN A~BSTNK A~AUDAT A~AUART
SELECT A~VBELN D~BSTKD A~AUDAT A~AUART
* Edit 2003.03.17 <<<
A~VKORG A~VTWEG A~KUNNR A~KNUMV
* ↓ APPEND 2002.05.10 PSD K.ARAI
A~VKBUR
* ↑
B~POSNR B~KDMAT B~VRKME B~NETPR
B~KWMENG B~MATNR B~WAERK
C~EDATU D~BSTDK_E
* ↓ MODIFY 2002.04.26 PSD K.ARAI 抽出項目の追加
B~PSTYV B~NETWR
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI 　単価編集
B~KPEIN
* ↑
*    INTO CORRESPONDING FIELDS OF GT_VBAP
INTO CORRESPONDING FIELDS OF TABLE GT_VBAP
FROM ( ( VBAK AS A INNER JOIN VBAP AS B
ON     A~VBELN  = B~VBELN ) INNER JOIN VBEP  AS C
ON     B~VBELN  = C~VBELN
AND     B~POSNR  = C~POSNR ) INNER JOIN VBKD AS D
ON     B~VBELN  = D~VBELN
WHERE A~VBELN IN S_VBELN
AND A~VKBUR IN S_VKBUR
*     AND B~ABGRU =  'ZP'
AND C~ETENR =  '0001'
AND D~POSNR =  '000000'.

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.         " 対象データなし
MESSAGE S611(Z1).
STOP.
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_VBAP
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_REOUT_VBAP
*&---------------------------------------------------------------------*
*&      Form  FRM_REOUT_NAST
*&---------------------------------------------------------------------*
*       テーブル読込条件⑤
*       メッセージステータス情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_REOUT_NAST.
CLEAR:   GF_NAST.
REFRESH: GT_NAST.
*---APPEND START PSD T.SAITOH 2002/06/02 ---------------------------*
DATA: L_VBELN_POSNR_MIN TYPE NAST-OBJKY,"オブジェクトキー最小値
L_VBELN_POSNR_MAX TYPE NAST-OBJKY."オブジェクトキー最大値

L_VBELN_POSNR_MIN+0(10) = GF_VBAP-VBELN.
L_VBELN_POSNR_MIN+10(6) = '000000'.
L_VBELN_POSNR_MAX+0(10) = GF_VBAP-VBELN.
L_VBELN_POSNR_MAX+10(6) = '999999'.

*---APPEND END   PSD T.SAITOH 2002/06/02 ---------------------------*
*--- メッセージステータス情報取得
SELECT KAPPL OBJKY KSCHL DATVR UHRVR LDEST USNAM
INTO CORRESPONDING FIELDS OF TABLE GT_NAST
FROM NAST
WHERE KAPPL = 'V1'
*---APPEND START PSD T.SAITOH 2002/06/02 ---------------------------*
AND OBJKY BETWEEN L_VBELN_POSNR_MIN AND L_VBELN_POSNR_MAX
*---APPEND END   PSD T.SAITOH 2002/06/02 ---------------------------*
AND KSCHL = 'ZS01'
AND SPRAS = CNS_J
AND VSTAT = '1'.
*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
*--- 日付判定処理
PERFORM FRM_DATE_SET.
F_NAST = CNS_X.
WHEN 4.         " 対象データなし
F_ERR = CNS_X.
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_NAST
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_REOUT_NAST
*&---------------------------------------------------------------------*
*&      Form  FRM_KINGAKU_HENKAN
*&---------------------------------------------------------------------*
*       金額変換処理
*----------------------------------------------------------------------*
*      -->P_TSUKACD  通貨コード
*      -->P_KINGAKU  変換前金額
*      <--P_HENKAN   変換後金額
*----------------------------------------------------------------------*
FORM FRM_KINGAKU_HENKAN USING    P_TSUKACD
P_KINGAKU
CHANGING P_HENKAN.
DATA L_IDOC_AMOUNT(255) TYPE C.
*--- 汎用モジュール金額変換モジュール
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = P_TSUKACD
SAP_AMOUNT  = P_KINGAKU
IMPORTING
IDOC_AMOUNT = L_IDOC_AMOUNT
EXCEPTIONS
OTHERS      = 1.
IF SY-SUBRC <> 1.
P_HENKAN = L_IDOC_AMOUNT.
ENDIF.

ENDFORM.                    " FRM_KINGAKU_HENKAN
*&---------------------------------------------------------------------*
*&      Form  FRM_NMOUT_DATA
*&---------------------------------------------------------------------*
*       通常出力用ファイル出力用情報取得処理
*----------------------------------------------------------------------*
FORM FRM_NMOUT_DATA.
*--- メッセージステータス情報取得処理
PERFORM FRM_NMOUT_NAST.

LOOP AT GT_NAST INTO GF_NAST
WHERE OBJKY+0(10) IN S_VBELN.
F_NAST = CNS_X.
* ↓ APPEND 2002.04.26 PSD K.Arai
IF GF_NAST-OBJKY+10(6) = SPACE.
CONTINUE.
ENDIF.
* ↑
*--- 販売伝票情報取得処理
PERFORM FRM_NMOUT_VBAP.
CHECK F_ERR <> CNS_X.

LOOP AT GT_VBAP INTO GF_VBAP.

* ↓ APPEND 2002.03.04 PSD M.Arai 対象レコード取得不具合対応
CLEAR F_ERR.
* ↑

* ↓ APPEND 2002.04.26 PSD K.Arai
IF  GF_VBAP-PSTYV <> 'ZSEK'
AND GF_VBAP-POSNR <> GF_NAST-OBJKY+10(6).
CONTINUE.
ENDIF.
* ↑

* 2002/02/20 PSD H.Tanaka ADD ↓
*--- テーブルロック処理
PERFORM ENQUEUE_EZNAST.
*--- ファイル出力用内部テーブル設定処理
PERFORM FRM_MAKE_DATA.
*--- 出力用内部テーブル更新処理
CHECK F_ERR <> CNS_X.

* ↓ APPEND 2002.04.26 PSD K.Arai
PERFORM FRM_READ_WRITE.
IF SY-SUBRC = 0.
CONTINUE.
ENDIF.
* ↑
APPEND GF_WRITE TO GT_WRITE.

ENDLOOP.
*--- テーブル更新処理
PERFORM FRM_UPDATE_DATA.

ENDLOOP.
*--- エラーメッセージ出力処理
IF F_NAST = CNS_X.
IF F_VBAK <> CNS_X.
MESSAGE S600(Z1) WITH TEXT-015.
STOP.
ENDIF.
ELSE.
MESSAGE S611(Z1).
STOP.
ENDIF.
ENDFORM.                    " FRM_NMOUT_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_NAST_CHECK
*&---------------------------------------------------------------------*
*       テーブル読込条件④
*       メッセージステータス情報取得処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_NAST_CHECK.
DATA: LF_NAST TYPE          TYP_NAST,
LT_NAST TYPE TABLE OF TYP_NAST.

*---MODIFY START PSD T.SAITOH 2002/06/02 ---------------------------*

* --- add start
* オブジェクトキー
DATA: L_OBJKY TYPE NAST-OBJKY.
L_OBJKY+0(10) = GF_VBAP-VBELN.
L_OBJKY+10(6) = GF_VBAP-POSNR.
* add end

*--- メッセージステータス情報取得
SELECT SINGLE KAPPL OBJKY KSCHL LDEST USNAM
INTO CORRESPONDING FIELDS OF LF_NAST
FROM NAST
WHERE KAPPL = 'V1'
AND OBJKY = L_OBJKY
AND KSCHL = 'ZS01'
AND SPRAS = CNS_J
AND VSTAT = '0'.

CASE SY-SUBRC.
WHEN 0. "存在したら再出力の対象ではない
F_ERR = CNS_X.
WHEN 4.

WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_NAST
SY-SUBRC.
ENDCASE.

**--- メッセージステータス情報取得
*  SELECT KAPPL OBJKY KSCHL LDEST USNAM
*    INTO CORRESPONDING FIELDS OF TABLE LT_NAST
*    FROM NAST
*   WHERE KAPPL = 'V1'
*     AND KSCHL = 'ZS01'
*     AND SPRAS = CNS_J
*     AND VSTAT = '0'.
**--- エラー処理
*  CASE SY-SUBRC.
*    WHEN 0.
*      READ TABLE LT_NAST INTO LF_NAST
** ↓ MODIFY 2002.04.26 PSD K.ARAI
**        WITH KEY OBJKY+0(10) = GF_VBAP-VBELN.
*        WITH KEY OBJKY+0(10) = GF_VBAP-VBELN
*                 OBJKY+10(6) = GF_VBAP-POSNR.
** ↑
*      IF SY-SUBRC = 0.
**--- 対象データあり
*        F_ERR = CNS_X.
*      ENDIF.
*    WHEN 4.         " 対象データなし
*    WHEN OTHERS.    " システムエラー
*      MESSAGE A603(Z1) WITH SY-REPID
*                            CNS_NAST
*                            SY-SUBRC.
*  ENDCASE.
*
*---MODIFY END   PSD T.SAITOH 2002/06/02 ---------------------------*


ENDFORM.                    " FRM_NAST_CHECK
*&---------------------------------------------------------------------*
*&      Form  FRM_IRISU_SET
*&---------------------------------------------------------------------*
*       入り数設定処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_IRISU_SET.
DATA: L_KOGUT           TYPE I,
* ↓ MODIFY 2002.04.26 PSD K.ARAI
L_AMARI           TYPE I,     "余り
*      L_AMARI           TYPE VBAP-KWMENG,
L_BUNSI           TYPE I,
L_OUTNO           TYPE I.     "入り数
*      L_OUTNO           TYPE VBAP-KWMENG.
* ↑
* ↓ MODIFY 2002.04.26 PSD K.ARAI
*--- 明細カテゴリが通常
IF GF_DUMMY-PSTYV <> 'ZSEK'.
*--- 入り数入力値が0
IF G_OUTNO = 0.
L_OUTNO = GF_WRITE_TEMP-LFIMG.
ELSE.
L_OUTNO = P_OUTNO.
ENDIF.
*  IF P_OUTNO <> 0.
*    COMPUTE L_KOGUT = ABS( GF_VBAP-KWMENG ) DIV P_OUTNO.
*    COMPUTE L_AMARI = ABS( GF_VBAP-KWMENG ) MOD P_OUTNO.
COMPUTE L_KOGUT = ABS( GF_WRITE_TEMP-LFIMG ) DIV L_OUTNO.
COMPUTE L_AMARI = ABS( GF_WRITE_TEMP-LFIMG ) MOD L_OUTNO.
* ↑
IF L_AMARI <> 0.
L_KOGUT = L_KOGUT + 1.
ENDIF.
* ↓ DELETE 2002.04.26 PSD K.ARAI
*  ENDIF.
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI
MOVE-CORRESPONDING GF_WRITE_TEMP TO GF_WRITE.
CLEAR GF_WRITE_TEMP.
*--- 明細カテゴリが子
ELSE.
IF G_OUTNO = 0.
L_OUTNO = GF_WRITE-LFIMG.
ELSE.
L_OUTNO = P_OUTNO.
ENDIF.
COMPUTE L_KOGUT = ABS( GF_WRITE-LFIMG ) DIV L_OUTNO.
COMPUTE L_AMARI = ABS( GF_WRITE-LFIMG ) MOD L_OUTNO.
IF L_AMARI <> 0.
L_KOGUT = L_KOGUT + 1.
ENDIF.
ENDIF.
* ↑
*--- 個口数行レコードを作成する
* ↓ DELETE 2002.04.26 PSD K.ARAI
*  L_OUTNO = P_OUTNO.
* ↑
DO L_KOGUT TIMES.
GF_WRITE-KOGUT = L_KOGUT.
L_BUNSI = L_BUNSI + 1.
GF_WRITE-BUNSI = L_BUNSI.
*---　入り数の設定処理
* ↓ MODIFY 2002.04.26 PSD K.ARAI
IF L_AMARI <> 0 AND L_BUNSI = L_KOGUT.
GF_WRITE-IRISU = L_AMARI.
ELSE.
GF_WRITE-IRISU = L_OUTNO.
ENDIF.
*    IF L_BUNSI = L_KOGUT.
*      IF L_AMARI = 0.
*        GF_WRITE-IRISU = L_OUTNO.
*      ELSE.
*        GF_WRITE-IRISU = L_AMARI.
*      ENDIF.
*    ELSE.
*      GF_WRITE-IRISU = L_OUTNO.
*    ENDIF.
* ↑
*--- 出力用内部テーブル更新処理
* ↓ APPEND 2002.04.26 PSD K.ARAI
IF GF_DUMMY-PSTYV = 'ZSEK'.
GF_WRITE-NETWR  = G_NETWR.
GF_WRITE-NETWRT = G_NETWRT.
GF_WRITE-KEBTR  = G_KEBTR .
ENDIF.
* ↑
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-IRISU  NO-GAPS.
CONDENSE GF_WRITE-KOGUT  NO-GAPS.
CONDENSE GF_WRITE-BUNSI  NO-GAPS.
CONDENSE GF_WRITE-NETWR  NO-GAPS.
CONDENSE GF_WRITE-KEBTR  NO-GAPS.
CONDENSE GF_WRITE-NETWRT NO-GAPS.
* ↑
APPEND GF_WRITE TO GT_WRITE.
ENDDO.
* ↓ APPEND 2002.04.26 PSD K.ARAI
CLEAR :GF_WRITE,
G_NETWR ,
G_NETWRT,
G_KEBTR .
* ↑
ENDFORM.                    " FRM_IRISU_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_PRINTER_CHECK
*&---------------------------------------------------------------------*
*       プリンタ／トレイチェック処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_PRINTER_CHECK.

IF NOT P_PRNTR IS INITIAL.
READ TABLE GT_TSP03L INTO GF_TSP03L
WITH KEY LNAME = P_PRNTR.
CASE SY-SUBRC.
WHEN 0.
GF_WRITE-PRNTR = GF_TSP03L-PADEST.
GF_WRITE-PNAME = P_PRNTR.
WHEN 4.
*--- 2002/05/10 MODIFY PSD K.ARAI
MESSAGE E614(Z1) WITH TEXT-124."画面入力されたプリンタ/トレイ
*        MESSAGE E614(Z1) WITH P_PRNTR.
*--- 2002/05/10 END
ENDCASE.
ENDIF.

ENDFORM.                    " FRM_PRINTER_CHECK
*&---------------------------------------------------------------------*
*&      Form  FRM_DATE_SET
*&---------------------------------------------------------------------*
*       日付判定処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_DATE_SET.
DATA L_NAST  TYPE          TYP_NAST.
DATA LT_NAST TYPE TABLE OF TYP_NAST.
*--- 日付判定処理
SORT GT_NAST DESCENDING BY OBJKY+0(10) DATVR UHRVR.
LOOP AT GT_NAST INTO GF_NAST
WHERE OBJKY+0(10) = GF_VBAP-VBELN.
IF L_NAST-OBJKY+0(10) <> GF_NAST-OBJKY+0(10).
L_NAST = GF_NAST.
APPEND L_NAST TO LT_NAST.
ENDIF.
ENDLOOP.
GT_NAST = LT_NAST.
SORT GT_NAST BY OBJKY+0(10).
ENDFORM.                    " FRM_DATE_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_VKBUR_CHECK
*&---------------------------------------------------------------------*
*       営業所存在チェック処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_VKBUR_CHECK.
DATA L_VKBUR TYPE VBAK-VKBUR.
*--- 営業所存在チェック
*--- 2002/05/1O MODIFY K.ARAI
SELECT A~VKBUR      A~ADRNR
B~NAME1      B~TEL_NUMBER
B~FAX_NUMBER B~POST_CODE1
B~CITY1      B~STR_SUPPL1
B~STR_SUPPL2 B~REGION
*--- 2002/05/17 APPEND K.ARAI
B~STREET
*--- END
INTO CORRESPONDING FIELDS OF TABLE GT_ADRC_INFO
FROM TVBUR AS A INNER JOIN ADRC AS B
ON A~ADRNR  = B~ADDRNUMBER
WHERE A~VKBUR IN S_VKBUR.

*   SELECT SINGLE VKBUR INTO L_VKBUR
*   FROM TVBUR
*   WHERE VKBUR IN S_VKBUR.

*  SELECT SINGLE A~VKBUR
*    INTO L_VKBUR
*    FROM VBAK AS A INNER JOIN VBAP AS B
*      ON A~VBELN  = B~VBELN
*   WHERE A~VBELN IN S_VBELN
*     AND A~VKBUR IN S_VKBUR.
*--- 2002/05/1O END
*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.         " 対象データなし
*--- 2002/05/10 MODIFY PSD K.ARAI
MESSAGE E613(Z1) WITH TEXT-115 TEXT-125.
*      MESSAGE E600(Z1) WITH TEXT-115.
*--- 2002/05/10 END
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_VBAP
SY-SUBRC.
ENDCASE.


ENDFORM.                    " FRM_VKBUR_CHECK
*&---------------------------------------------------------------------*
*&      Form  FRM_EIGYO_RESET
*&---------------------------------------------------------------------*
*       テーブル読込条件⑥⑦
*       営業所情報再設定処理
*----------------------------------------------------------------------*
*      -->P_PARVW   取引機能
*----------------------------------------------------------------------*
FORM FRM_EIGYO_RESET USING P_PARVW.
CLEAR GF_ADRC.
*--- 営業所情報設定
SELECT SINGLE B~NAME1 B~NAME2 B~NAME3
B~TEL_NUMBER    B~FAX_NUMBER
B~POST_CODE1    B~CITY1
B~STR_SUPPL1    B~STR_SUPPL2
* ↓ APPEND 2002.04.26 PSD K.ARAI
B~STREET        B~REGION
* ↑
INTO CORRESPONDING FIELDS OF GF_ADRC
FROM VBPA AS A INNER JOIN ADRC AS B
ON A~ADRNR  = B~ADDRNUMBER
WHERE A~VBELN = GF_VBAP-VBELN
AND A~POSNR = '000000'
AND A~PARVW = P_PARVW.
*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
WHEN 4.         " 対象データなし
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_VBPA
SY-SUBRC.
ENDCASE.
*--- 2002/05/17 PSD K.ARAI DELETE
** ↓ APPEND 2002.04.26 PSD K.ARAI
**---営業所住所１データ抽出
*  PERFORM FRM_EIGYO_ADD1.
** ↑
*--- DELETE END
ENDFORM.                    " FRM_EIGYO_RESET
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_ENDTYP
*&---------------------------------------------------------------------*
*       納入完了区分
*----------------------------------------------------------------------*
FORM FRM_SET_ENDTYP.

GF_WRITE-ENDTYP = ''.

ENDFORM.                    " FRM_SET_ENDTYP
*&---------------------------------------------------------------------*
*&      Form  FRM_ZEIGAKU_HENKAN
*&---------------------------------------------------------------------*
*       税額変換
*----------------------------------------------------------------------*
*      -->P_TSUKACD  通貨コード
*      -->P_KINGAKU  変換前金額
*      <--P_HENKAN   変換後金額
*----------------------------------------------------------------------*
FORM FRM_ZEIGAKU_HENKAN USING    P_TSUKACD
P_KINGAKU
CHANGING P_HENKAN.
DATA : L_AMOUNT_DIS TYPE WMTO_S-AMOUNT,
L_AMOUNT_INT TYPE WMTO_S-AMOUNT.
L_AMOUNT_INT = P_KINGAKU.
*--- 汎用モジュール金額変換モジュール
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_DISPLAY'
EXPORTING
CURRENCY        = P_TSUKACD
AMOUNT_INTERNAL = L_AMOUNT_INT
IMPORTING
AMOUNT_DISPLAY  = L_AMOUNT_DIS
EXCEPTIONS
INTERNAL_ERROR  = 1
OTHERS          = 2.
IF SY-SUBRC <> 1.
P_HENKAN = L_AMOUNT_DIS.
ENDIF.

ENDFORM.                    " FRM_ZEIGAKU_HENKAN
*&---------------------------------------------------------------------*
*&      Form  FRM_READ_WRITE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_READ_WRITE.
DATA : L_OBJKY TYPE NAST-OBJKY.
CONCATENATE GF_VBAP-VBELN '-' GF_VBAP-POSNR INTO L_OBJKY.
READ TABLE GT_WRITE INTO GF_WRITE WITH  KEY VBELN = L_OBJKY.


ENDFORM.                    " FRM_READ_WRITE
*&---------------------------------------------------------------------*
*&      Form  FRM_PSTYV_EDIT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  明細カテゴリ'ZSEO'の時、同一伝票の明細行の税抜売上金額・税込売上金額
*  消費税を集計した値を出力
*  明細カテゴリ'ZSEK'は処理対象外とする
*----------------------------------------------------------------------*
FORM FRM_PSTYV_EDIT.
*--- GT_WRITEのデータ をGT_DUMMY に移動
LOOP AT GT_WRITE INTO GF_WRITE.
MOVE-CORRESPONDING GF_WRITE TO GF_DUMMY.
APPEND GF_DUMMY TO GT_DUMMY.
CLEAR  GF_DUMMY.
ENDLOOP.
CLEAR   GF_WRITE .
REFRESH GT_WRITE.

SORT GT_DUMMY BY VBELN.
*--- GT_DUMMY を明細カテゴリから編集
LOOP AT GT_DUMMY INTO GF_DUMMY.
MOVE-CORRESPONDING GF_DUMMY TO GF_WRITE_TEMP.
*  -- カテゴリ親---*
IF GF_DUMMY-PSTYV = 'ZSEO'.
MOVE-CORRESPONDING GF_DUMMY TO GF_WRITE.
*  -- カテゴリ子---*
ELSEIF GF_DUMMY-PSTYV = 'ZSEK'.
*税額、受注金額、受注税込金額を集計
G_NETWR  = GF_DUMMY-NETWR  + G_NETWR.
G_NETWRT = GF_DUMMY-NETWRT + G_NETWRT.
G_KEBTR  = GF_DUMMY-KEBTR  + G_KEBTR.
*  2003.06.09 append
G_KONTPR = GF_DUMMY-KONTPR + G_KONTPR.
*  2003.06.09 end

*  -- カテゴリ通常---*
ELSE .
* Edit 2013.02.20 GSL Tohtake.s Start
*      IF R_REOUT = CNS_X .
IF R_REOUT = CNS_X OR NOT P_OUTNO IS INITIAL.
* Edit 2013.02.20 GSL Tohtake.s End
PERFORM FRM_IRISU_SET.
ELSE.

*通常時
* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE_TEMP-NETWR  NO-GAPS.
CONDENSE GF_WRITE_TEMP-NETWRT NO-GAPS.
CONDENSE GF_WRITE_TEMP-KEBTR  NO-GAPS.
* ↑
*  2003.06.09 append
CONDENSE GF_WRITE_TEMP-KONTPR NO-GAPS.
*  2003.06.09 end

APPEND GF_WRITE_TEMP TO GT_WRITE.
CLEAR  GF_WRITE_TEMP.
ENDIF.
ENDIF.
AT END OF PSTYV.
*カテゴリが子
IF  GF_DUMMY-PSTYV = 'ZSEK'.
* Edit 2013.02.20 GSL Tohtake.s Start
*        IF R_REOUT = CNS_X.
IF R_REOUT = CNS_X OR NOT P_OUTNO IS INITIAL.
* Edit 2013.02.20 GSL Tohtake.s End

PERFORM FRM_IRISU_SET.
ELSE.
GF_WRITE-NETWR  = G_NETWR.
GF_WRITE-NETWRT = G_NETWRT.
GF_WRITE-KEBTR  = G_KEBTR .
*  2003.06.09 append
GF_WRITE-KONTPR = G_KONTPR.
*  2003.06.09 end

* ↓ APPEND 2002.04.26 PSD K.ARAI
CONDENSE GF_WRITE-NETWR  NO-GAPS.
CONDENSE GF_WRITE-NETWRT NO-GAPS.
CONDENSE GF_WRITE-KEBTR  NO-GAPS.
* ↑
*  2003.06.09 append
CONDENSE GF_WRITE-KONTPR NO-GAPS.
*  2003.06.09 end.

APPEND GF_WRITE TO GT_WRITE.
CLEAR :GF_WRITE,
G_NETWR,
G_NETWRT,
G_KEBTR,
G_KONTPR.          " 2003.06.09 append
ENDIF.
ENDIF.
ENDAT.
ENDLOOP.

ENDFORM.                    " FRM_PSTYV_EDIT
*&---------------------------------------------------------------------*
*&      Form  FRM_EIGYO_ADD1
*&---------------------------------------------------------------------*
*  営業所住所１データ抽出
*----------------------------------------------------------------------*
FORM FRM_EIGYO_ADD1.
DATA : L_BEZEI LIKE T005U-BEZEI.                     "都道府県名
SELECT SINGLE BEZEI INTO L_BEZEI
FROM  T005U
WHERE  SPRAS = 'J'                 "言語キー
AND  LAND1 = 'JP'                "国コード
AND  BLAND = GF_ADRC-REGION.     "都道府県

CONCATENATE L_BEZEI
GF_ADRC-STREET
GF_ADRC-CITY1     INTO   GF_ADRC-CITY1.
ENDFORM.                    " FRM_EIGYO_ADD1
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_EIGYO_INFO
*&---------------------------------------------------------------------*
*       営業所情報設定
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_SET_EIGYO_INFO.
*--- 2002/05/17 APPEND PSD K.ARAI
DATA : L_BEZEI LIKE T005U-BEZEI.                      "内容説明
*--- 2002/05/17 END

READ TABLE GT_ADRC_INFO INTO GF_ADRC_INFO
WITH TABLE KEY VKBUR = GF_VBAP-VKBUR.

*--- 2002/05/17 APPEND PSD K.ARAI
SELECT SINGLE BEZEI INTO L_BEZEI                     "内容説明
FROM  T005U
WHERE  SPRAS = 'J'                 "言語キー
AND  LAND1 = 'JP'                "国コード
AND  BLAND = GF_ADRC_INFO-REGION.     "都道府県

CONCATENATE L_BEZEI
GF_ADRC_INFO-STREET
GF_ADRC_INFO-CITY1     INTO   GF_ADRC_INFO-CITY1.
*--- 2002/05/17 END
ENDFORM.                    " FRM_SET_EIGYO_INFO
*&---------------------------------------------------------------------*
*&      Form  FRM_SIIRE_ADD1
*&---------------------------------------------------------------------*
*       仕入先住所１設定
*----------------------------------------------------------------------*
FORM FRM_SIIRE_ADD1.
DATA : L_BEZEI LIKE T005U-BEZEI.                     "内容説明

SELECT SINGLE BEZEI INTO L_BEZEI                     "内容説明
FROM  T005U
WHERE  SPRAS = 'J'                 "言語キー
AND  LAND1 = 'JP'                "国コード
AND  BLAND = GF_ADRC-REGION.     "都道府県

CONCATENATE L_BEZEI
GF_ADRC-STREET
GF_ADRC-CITY1     INTO   GF_ADRC-CITY1.
ENDFORM.                    " FRM_SIIRE_ADD1
*&---------------------------------------------------------------------*
*&      Form  FRM_COMPUTE_SINGLE_COST
*&---------------------------------------------------------------------*
*       セット品親の単価を集計する。
*----------------------------------------------------------------------*
FORM FRM_COMPUTE_SINGLE_COST.
DATA: L_NETPR(9) TYPE P DECIMALS 2,"単価
L_NETWR(9) TYPE P           ,"受注金額
L_LFIMG(9) TYPE P DECIMALS 2."数量

FIELD-SYMBOLS <FS> LIKE GF_WRITE.

LOOP AT GT_WRITE ASSIGNING <FS>.
*   セット品親のみ対象
IF <FS>-PSTYV = 'ZSEO' OR <FS>-PSTYV = 'ZREO'.
CONDENSE <FS>-NETWR  NO-GAPS.
CONDENSE <FS>-LFIMG  NO-GAPS.

L_NETWR = <FS>-NETWR.
L_LFIMG = <FS>-LFIMG.

*     0で除算はしない
IF L_LFIMG <> 0.
L_NETPR = L_NETWR / L_LFIMG.
<FS>-NETPR = L_NETPR.
CONDENSE <FS>-NETPR NO-GAPS.
ENDIF.
* 2003.06.09 append
CONDENSE  <FS>-KONTPR NO-GAPS.
* 2003.06.09 end.

ENDIF.
ENDLOOP.

ENDFORM.                    " FRM_COMPUTE_SINGLE_COST
*&---------------------------------------------------------------------*
*&      Form  FRM_KONV
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_VBELN  text
*      -->P_VBAP_POSNR  text
*      -->P_KONTPR  text
*----------------------------------------------------------------------*
FORM FRM_KONV USING    P_VBELN
P_POSNR
P_KONTPR.
DATA : W_KNUMV LIKE VBAK-KNUMV,
W_KBETR LIKE KONV-KBETR,
W_WAERS LIKE KONV-WAERS,
W_KPEIN LIKE KONV-KPEIN.

SELECT SINGLE KNUMV INTO W_KNUMV
FROM VBAK
WHERE VBELN = P_VBELN.
SELECT SINGLE KBETR
WAERS
KPEIN
INTO (W_KBETR,W_WAERS,W_KPEIN)
FROM KONV
WHERE KNUMV = W_KNUMV
AND KPOSN = P_POSNR
AND KSCHL = 'EDI1'.

IF SY-SUBRC <> 0.
CLEAR P_KONTPR.
EXIT.
ELSE.
PERFORM FRM_KINGAKU_HENKAN    USING W_WAERS
W_KBETR
CHANGING P_KONTPR.
P_KONTPR = P_KONTPR / W_KPEIN.
ENDIF.
ENDFORM.                    " FRM_KONV

*&---------------------------------------------------------------------*
*&      Form  FRM_CALC_KONTWR
*&---------------------------------------------------------------------*
*       2003/10/29 APPEND
*       概算金額計算
*----------------------------------------------------------------------*
*      -->P_KONTPR  概算単価
*      -->P_LFIMG   概算数量
*      <--P__KONTWR 概算金額
*----------------------------------------------------------------------*
FORM FRM_CALC_KONTWR USING    P_KONTPR
P_LFIMG
CHANGING P_KONTWR.

DATA: L_KONTPR TYPE ZSNUMGF101,    "概算単価
L_LFIMG  TYPE LIPS-LFIMG,    "数量
L_KONTWR TYPE ZSNUMGF101.    "概算金額

L_KONTPR = P_KONTPR.
L_LFIMG  = P_LFIMG.
L_KONTWR = P_KONTWR.

IF ( L_KONTPR IS INITIAL ).
CLEAR: P_KONTWR.
EXIT.
ELSE.
L_KONTWR = L_KONTPR * L_LFIMG.
P_KONTWR = L_KONTWR.
ENDIF.
ENDFORM.                    " FRM_CALC_KONTWR
*&---------------------------------------------------------------------*
*&      Form  FRM_CALC_KONBTR
*&---------------------------------------------------------------------*
*       2003/10/29 APPEND
*       概算消費税額計算
*----------------------------------------------------------------------*
*      -->P_KONTWR  概算金額
*      <--P_KONBTR  概算消費税額
*----------------------------------------------------------------------*
FORM FRM_CALC_KONBTR USING    P_KONTWR
CHANGING P_KONBTR.

DATA: LF_KONV  TYPE          TYP_KONV,
LT_KONV  TYPE TABLE OF TYP_KONV,
L_KBETR  TYPE KONV-KBETR.              "税率
DATA: L_KONTWR TYPE ZSNUMGF101,              "概算金額
L_KONBTR TYPE ZSNUMGF101.          "概算消費税額

L_KONTWR = P_KONTWR.
L_KONBTR = P_KONBTR.

IF ( L_KONTWR IS INITIAL ).
CLEAR: P_KONBTR.
EXIT.
ENDIF.

*--- 条件 (トランザクションデータ)情報取得
SELECT KWERT WAERS KBETR
INTO CORRESPONDING FIELDS OF TABLE LT_KONV
FROM   KONV
WHERE   KNUMV = GF_VBAP-KNUMV            "伝票条件番号
AND   KPOSN = GF_VBAP-POSNR            "条件明細番号
AND   KAPPL = 'V'                      "アプリケーション
AND ( KSCHL = 'MWST'                   "条件タイプ
OR   KSCHL = 'MWSU'
OR   KSCHL = 'MWSD' ) .

*--- エラー処理
CASE SY-SUBRC.
WHEN 0.
LOOP AT LT_KONV INTO LF_KONV.
L_KBETR = LF_KONV-KBETR / 1000.
L_KONBTR = L_KONTWR * L_KBETR.
P_KONBTR = L_KONBTR.
EXIT.
ENDLOOP.
WHEN 4.         " 対象データなし
WHEN OTHERS.    " システムエラー
MESSAGE A603(Z1) WITH SY-REPID
CNS_KONV
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_CALC_KONBTR
*&---------------------------------------------------------------------*
*&      Form  FRM_CALC_KONTWRT
*&---------------------------------------------------------------------*
*       2003/10/29 APPEND
*       概算合計額計算
*----------------------------------------------------------------------*
*      -->P_KONTWR  概算金額
*      -->P_KONBTR  概算消費税額
*      <--P_KONTWRT 概算合計額
*----------------------------------------------------------------------*
FORM FRM_CALC_KONTWRT USING    P_KONTWR
P_KONBTR
CHANGING P_KONTWRT.

DATA:L_KONTWR  TYPE ZSNUMGF101,               "概算金額
L_KONBTR  TYPE ZSNUMGF101,               "概算消費税額
L_KONTWRT TYPE ZSNUMGF101.               "概算合計額

L_KONTWR  = P_KONTWR.
L_KONBTR  = P_KONBTR.
L_KONTWRT = P_KONTWRT.

IF ( L_KONTWR IS INITIAL ).
CLEAR P_KONTWRT.
EXIT.
ELSE.
L_KONTWRT = L_KONTWR + L_KONBTR.
P_KONTWRT = L_KONTWRT.
ENDIF.
ENDFORM.                    " FRM_CALC_KONTWRT
