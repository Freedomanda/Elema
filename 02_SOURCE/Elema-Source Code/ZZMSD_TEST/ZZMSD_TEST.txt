*&---------------------------------------------------------------------*
*& Report  Zxxxxxxxx                                                   *
*&---------------------------------------------------------------------*
*&  機能     :
*&  作成日   :
*&  作成者   :
*&  変更履歴 : ｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘ
*&             xxxx.xx.xx  x.xxxxxx(xxxxxx)
*&  変更履歴 : ｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘｘ
*&             xxxx.xx.xx  x.xxxxxx(xxxxxx)
*&---------------------------------------------------------------------*
REPORT ZZMSD_TEST
NO STANDARD PAGE HEADING
LINE-SIZE 200.
*       MESSAGE-ID xxx.

************************************************************************
* 構造定義(TYPES)
************************************************************************

* 取得データ用定義
TYPES:
BEGIN OF TYP_GETDATA,
TEXTLINE(4000) TYPE C,
END   OF TYP_GETDATA.

TYPES:
BEGIN OF TYP_FILEDATA,
SPLDT(20) TYPE C, "支給年月日
SPLYM(20) TYPE C, "支給対象年月
EMPCD(20) TYPE C, "社員コード
NAME(20)  TYPE C, "Name
COST(20)  TYPE C, "COST CENTER給与
EMPDV(20) TYPE C, "社員区分
DIV02(20) TYPE C, "区分０２
POSCD(20) TYPE C, "役職コード
MN001(20) TYPE C, "給与項目or金額001
MN002(20) TYPE C, "給与項目or金額002
MN003(20) TYPE C, "給与項目or金額003
MN004(20) TYPE C, "給与項目or金額004
MN005(20) TYPE C, "給与項目or金額005
MN006(20) TYPE C, "給与項目or金額006
MN007(20) TYPE C, "給与項目or金額007
MN008(20) TYPE C, "給与項目or金額008
MN009(20) TYPE C, "給与項目or金額009
MN010(20) TYPE C, "給与項目or金額010
MN011(20) TYPE C, "給与項目or金額011
MN012(20) TYPE C, "給与項目or金額012
MN013(20) TYPE C, "給与項目or金額013
MN014(20) TYPE C, "給与項目or金額014
MN015(20) TYPE C, "給与項目or金額015
MN016(20) TYPE C, "給与項目or金額016
MN017(20) TYPE C, "給与項目or金額017
MN018(20) TYPE C, "給与項目or金額018
MN019(20) TYPE C, "給与項目or金額019
MN020(20) TYPE C, "給与項目or金額020
MN021(20) TYPE C, "給与項目or金額021
MN022(20) TYPE C, "給与項目or金額022
MN023(20) TYPE C, "給与項目or金額023
MN024(20) TYPE C, "給与項目or金額024
MN025(20) TYPE C, "給与項目or金額025
MN026(20) TYPE C, "給与項目or金額026
MN027(20) TYPE C, "給与項目or金額027
MN028(20) TYPE C, "給与項目or金額028
MN029(20) TYPE C, "給与項目or金額029
MN030(20) TYPE C, "給与項目or金額030
MN031(20) TYPE C, "給与項目or金額031
MN032(20) TYPE C, "給与項目or金額032
MN033(20) TYPE C, "給与項目or金額033
MN034(20) TYPE C, "給与項目or金額034
MN035(20) TYPE C, "給与項目or金額035
MN036(20) TYPE C, "給与項目or金額036
MN037(20) TYPE C, "給与項目or金額037
MN038(20) TYPE C, "給与項目or金額038
MN039(20) TYPE C, "給与項目or金額039
MN040(20) TYPE C, "給与項目or金額040
MN041(20) TYPE C, "給与項目or金額041
MN042(20) TYPE C, "給与項目or金額042
MN043(20) TYPE C, "給与項目or金額043
MN044(20) TYPE C, "給与項目or金額044
MN045(20) TYPE C, "給与項目or金額045
MN046(20) TYPE C, "給与項目or金額046
MN047(20) TYPE C, "給与項目or金額047
MN048(20) TYPE C, "給与項目or金額048
MN049(20) TYPE C, "給与項目or金額049
MN050(20) TYPE C, "給与項目or金額050
MN051(20) TYPE C, "給与項目or金額051
MN052(20) TYPE C, "給与項目or金額052
MN053(20) TYPE C, "給与項目or金額053
MN054(20) TYPE C, "給与項目or金額054
MN055(20) TYPE C, "給与項目or金額055
MN056(20) TYPE C, "給与項目or金額056
MN057(20) TYPE C, "給与項目or金額057
MN058(20) TYPE C, "給与項目or金額058
MN059(20) TYPE C, "給与項目or金額059
MN060(20) TYPE C, "給与項目or金額060
MN061(20) TYPE C, "給与項目or金額061
MN062(20) TYPE C, "給与項目or金額062
MN063(20) TYPE C, "給与項目or金額063
MN064(20) TYPE C, "給与項目or金額064
MN065(20) TYPE C, "給与項目or金額065
MN066(20) TYPE C, "給与項目or金額066
MN067(20) TYPE C, "給与項目or金額067
MN068(20) TYPE C, "給与項目or金額068
MN069(20) TYPE C, "給与項目or金額069
MN070(20) TYPE C, "給与項目or金額070
MN071(20) TYPE C, "給与項目or金額071
MN072(20) TYPE C, "給与項目or金額072
MN073(20) TYPE C, "給与項目or金額073
MN074(20) TYPE C, "給与項目or金額074
MN075(20) TYPE C, "給与項目or金額075
MN076(20) TYPE C, "給与項目or金額076
MN077(20) TYPE C, "給与項目or金額077
MN078(20) TYPE C, "給与項目or金額078
MN079(20) TYPE C, "給与項目or金額079
MN080(20) TYPE C, "給与項目or金額080
MN081(20) TYPE C, "給与項目or金額081
MN082(20) TYPE C, "給与項目or金額082
MN083(20) TYPE C, "給与項目or金額083
MN084(20) TYPE C, "給与項目or金額084
MN085(20) TYPE C, "給与項目or金額085
MN086(20) TYPE C, "給与項目or金額086
MN087(20) TYPE C, "給与項目or金額087
MN088(20) TYPE C, "給与項目or金額088
MN089(20) TYPE C, "給与項目or金額089
MN090(20) TYPE C, "給与項目or金額090
MN091(20) TYPE C, "給与項目or金額091
MN092(20) TYPE C, "給与項目or金額092
MN093(20) TYPE C, "給与項目or金額093
MN094(20) TYPE C, "給与項目or金額094
MN095(20) TYPE C, "給与項目or金額095
MN096(20) TYPE C, "給与項目or金額096
MN097(20) TYPE C, "給与項目or金額097
MN098(20) TYPE C, "給与項目or金額098
MN099(20) TYPE C, "給与項目or金額099
MN100(20) TYPE C, "給与項目or金額100
MN101(20) TYPE C, "給与項目or金額101
MN102(20) TYPE C, "給与項目or金額102
MN103(20) TYPE C, "給与項目or金額103
MN104(20) TYPE C, "給与項目or金額104
MN105(20) TYPE C, "給与項目or金額105
MN106(20) TYPE C, "給与項目or金額106
MN107(20) TYPE C, "給与項目or金額107
MN108(20) TYPE C, "給与項目or金額108
MN109(20) TYPE C, "給与項目or金額109
MN110(20) TYPE C, "給与項目or金額110
MN111(20) TYPE C, "給与項目or金額111
MN112(20) TYPE C, "給与項目or金額112
MN113(20) TYPE C, "給与項目or金額113
MN114(20) TYPE C, "給与項目or金額114
MN115(20) TYPE C, "給与項目or金額115
MN116(20) TYPE C, "給与項目or金額116
MN117(20) TYPE C, "給与項目or金額117
MN118(20) TYPE C, "給与項目or金額118
MN119(20) TYPE C, "給与項目or金額119
MN120(20) TYPE C, "給与項目or金額120
MN121(20) TYPE C, "給与項目or金額121
MN122(20) TYPE C, "給与項目or金額122
MN123(20) TYPE C, "給与項目or金額123
MN124(20) TYPE C, "給与項目or金額124
MN125(20) TYPE C, "給与項目or金額125
MN126(20) TYPE C, "給与項目or金額126
MN127(20) TYPE C, "給与項目or金額127
MN128(20) TYPE C, "給与項目or金額128
MN129(20) TYPE C, "給与項目or金額129
MN130(20) TYPE C, "給与項目or金額130
MN131(20) TYPE C, "給与項目or金額131
MN132(20) TYPE C, "給与項目or金額132
MN133(20) TYPE C, "給与項目or金額133
MN134(20) TYPE C, "給与項目or金額134
MN135(20) TYPE C, "給与項目or金額135
MN136(20) TYPE C, "給与項目or金額136
MN137(20) TYPE C, "給与項目or金額137
MN138(20) TYPE C, "給与項目or金額138
MN139(20) TYPE C, "給与項目or金額139
MN140(20) TYPE C, "給与項目or金額140
MN141(20) TYPE C, "給与項目or金額141
MN142(20) TYPE C, "給与項目or金額142
MN143(20) TYPE C, "給与項目or金額143
MN144(20) TYPE C, "給与項目or金額144
MN145(20) TYPE C, "給与項目or金額145
MN146(20) TYPE C, "給与項目or金額146
MN147(20) TYPE C, "給与項目or金額147
MN148(20) TYPE C, "給与項目or金額148
MN149(20) TYPE C, "給与項目or金額149
MN150(20) TYPE C, "給与項目or金額150
MN151(20) TYPE C, "給与項目or金額151
MN152(20) TYPE C, "給与項目or金額152
MN153(20) TYPE C, "給与項目or金額153
MN154(20) TYPE C, "給与項目or金額154
MN155(20) TYPE C, "給与項目or金額155
MN156(20) TYPE C, "給与項目or金額156
MN157(20) TYPE C, "給与項目or金額157
MN158(20) TYPE C, "給与項目or金額158
MN159(20) TYPE C, "給与項目or金額159
MN160(20) TYPE C, "給与項目or金額160
MN161(20) TYPE C, "給与項目or金額161
MN162(20) TYPE C, "給与項目or金額162
MN163(20) TYPE C, "給与項目or金額163
MN164(20) TYPE C, "給与項目or金額164
MN165(20) TYPE C, "給与項目or金額165
MN166(20) TYPE C, "給与項目or金額166
MN167(20) TYPE C, "給与項目or金額167
MN168(20) TYPE C, "給与項目or金額168
MN169(20) TYPE C, "給与項目or金額169
MN170(20) TYPE C, "給与項目or金額170
MN171(20) TYPE C, "給与項目or金額171
MN172(20) TYPE C, "給与項目or金額172
MN173(20) TYPE C, "給与項目or金額173
MN174(20) TYPE C, "給与項目or金額174
MN175(20) TYPE C, "給与項目or金額175
MN176(20) TYPE C, "給与項目or金額176
MN177(20) TYPE C, "給与項目or金額177
MN178(20) TYPE C, "給与項目or金額178
MN179(20) TYPE C, "給与項目or金額179
MN180(20) TYPE C, "給与項目or金額180
MN181(20) TYPE C, "給与項目or金額181
MN182(20) TYPE C, "給与項目or金額182
MN183(20) TYPE C, "給与項目or金額183
MN184(20) TYPE C, "給与項目or金額184
MN185(20) TYPE C, "給与項目or金額185
MN186(20) TYPE C, "給与項目or金額186
MN187(20) TYPE C, "給与項目or金額187
MN188(20) TYPE C, "給与項目or金額188
MN189(20) TYPE C, "給与項目or金額189
MN190(20) TYPE C, "給与項目or金額190
MN191(20) TYPE C, "給与項目or金額191
MN192(20) TYPE C, "給与項目or金額192
MN193(20) TYPE C, "給与項目or金額193
MN194(20) TYPE C, "給与項目or金額194
MN195(20) TYPE C, "給与項目or金額195
MN196(20) TYPE C, "給与項目or金額196
MN197(20) TYPE C, "給与項目or金額197
MN198(20) TYPE C, "給与項目or金額198
MN199(20) TYPE C, "給与項目or金額199
MN200(20) TYPE C, "給与項目or金額200
MN201(20) TYPE C, "給与項目or金額201
MN202(20) TYPE C, "給与項目or金額202
MN203(20) TYPE C, "給与項目or金額203
MN204(20) TYPE C, "給与項目or金額204
MN205(20) TYPE C, "給与項目or金額205
MN206(20) TYPE C, "給与項目or金額206
MN207(20) TYPE C, "給与項目or金額207
MN208(20) TYPE C, "給与項目or金額208
MN209(20) TYPE C, "給与項目or金額209
MN210(20) TYPE C, "給与項目or金額210
MN211(20) TYPE C, "給与項目or金額211
MN212(20) TYPE C, "給与項目or金額212
MN213(20) TYPE C, "給与項目or金額213
MN214(20) TYPE C, "給与項目or金額214
MN215(20) TYPE C, "給与項目or金額215
MN216(20) TYPE C, "給与項目or金額216
MN217(20) TYPE C, "給与項目or金額217
MN218(20) TYPE C, "給与項目or金額218
MN219(20) TYPE C, "給与項目or金額219
MN220(20) TYPE C, "給与項目or金額220
MN221(20) TYPE C, "給与項目or金額221
MN222(20) TYPE C, "給与項目or金額222
MN223(20) TYPE C, "給与項目or金額223
MN224(20) TYPE C, "給与項目or金額224
MN225(20) TYPE C, "給与項目or金額225
MN226(20) TYPE C, "給与項目or金額226
MN227(20) TYPE C, "給与項目or金額227
MN228(20) TYPE C, "給与項目or金額228
MN229(20) TYPE C, "給与項目or金額229
MN230(20) TYPE C, "給与項目or金額230
MN231(20) TYPE C, "給与項目or金額231
MN232(20) TYPE C, "給与項目or金額232
MN233(20) TYPE C, "給与項目or金額233
MN234(20) TYPE C, "給与項目or金額234
MN235(20) TYPE C, "給与項目or金額235
MN236(20) TYPE C, "給与項目or金額236
MN237(20) TYPE C, "給与項目or金額237
MN238(20) TYPE C, "給与項目or金額238
MN239(20) TYPE C, "給与項目or金額239
MN240(20) TYPE C, "給与項目or金額240
MN241(20) TYPE C, "給与項目or金額241
MN242(20) TYPE C, "給与項目or金額242
MN243(20) TYPE C, "給与項目or金額243
MN244(20) TYPE C, "給与項目or金額244
MN245(20) TYPE C, "給与項目or金額245
MN246(20) TYPE C, "給与項目or金額246
END   OF TYP_FILEDATA.

TYPES:
BEGIN OF TYP_KANREN,
SALMN(04) TYPE N,           "給与項目
SAKNR     TYPE SKB1-SAKNR,  "勘定コード
END   OF TYP_KANREN.

TYPES:
BEGIN OF TYP_KANRENTB,
SALMN(04) TYPE N,           "給与項目
SHKZG     TYPE BSEG-SHKZG,  "貸借コード
SPLDV(01) TYPE C,           "支給区分
EDATE     TYPE D,           "終了日付
ITMDV(01) TYPE C,           "項目区分
SAKNR     TYPE SKB1-SAKNR,  "勘定コード
UMSKZ     TYPE T074-UMSKZ,  "特殊仕訳
MWSKZ     TYPE T007A-MWSKZ, "税コード
SGTXT     TYPE BSEG-SGTXT,  "明細テキスト
END   OF TYP_KANRENTB.

TYPES:
BEGIN OF TYP_SYAINSYUKEI,
EMPCD(10)  TYPE C,           "社員コード
COST(10)   TYPE C,           "原価センタ
SGTXT      TYPE BSEG-SGTXT,  "明細テキスト
SAKNR      TYPE SKB1-SAKNR,  "勘定コード
SPLDV(01)  TYPE C,           "支給区分
SHKZG      TYPE BSEG-SHKZG,  "貸借コード
ITMDV(01)  TYPE C,           "項目区分
UMSKZ      TYPE T074-UMSKZ,  "特殊仕訳
XBILK      TYPE SKA1-XBILK,
MWSKZ      TYPE T007A-MWSKZ, "税コード
BSCHL      TYPE BSEG-BSCHL,
PAYMN(13)  TYPE N,           "支払金額
LTEXT(100) TYPE C,           "メッセージ
END   OF TYP_SYAINSYUKEI.

TYPES:
BEGIN OF TYP_KANRENCHK,
SALMN(04) TYPE C, "給与項目
SHKZG(01) TYPE C, "貸借
SHKTX(04) TYPE C, "貸借テキスト
SPLDV(01) TYPE C, "支給区分
SPLTX(04) TYPE C, "支給区分テキスト
EDATE(10) TYPE C, "終了日付
ITMDV(01) TYPE C, "項目区分
ITMTX(08) TYPE C, "項目区分テキスト
SAKNR(10) TYPE C, "勘定コード
MITKZ(01) TYPE C, "勘定タイプ
MITTX(04) TYPE C, "勘定タイプテキスト
UMSKZ(01) TYPE C, "特殊仕訳コード
MWSKZ(02) TYPE C, "税コード
SGTXT(50) TYPE C, "明細テキスト
RESLT(06) TYPE C, "結果
LTEXT(38) TYPE C, "メッセージ
END   OF TYP_KANRENCHK.

TYPES:
BEGIN OF TYP_DATACHK,
EMPCD(07)  TYPE C, "社員コード
NAME(20)   TYPE C, "NAME
COST(10)   TYPE C, "原価センタ
PAYMN(11)  TYPE C, "支払金額
CHECK(08)  TYPE C, "チェック
LTEXT(100) TYPE C, "メッセージ
END   OF TYP_DATACHK.

TYPES:
BEGIN OF TYP_SIWAKEIMG,
BELNR(10) TYPE C, "伝票NO
BUDAT(10) TYPE C, "転記日付
BSCHL(02) TYPE C, "PK
SAKNR(10) TYPE C, "勘定コード
TXT20(35) TYPE C, "勘定テキスト
MWSKZ(02) TYPE C, "税コード
KOSTL(10) TYPE C, "原価センタ
PAYMN(18) TYPE C, "金額
APLCT(50) TYPE C, "適用
END  OF TYP_SIWAKEIMG.

************************************************************************
* 内部テーブル定義(INTERNAL TABLES)
************************************************************************
DATA:
GT_GETDATA     TYPE STANDARD TABLE OF TYP_GETDATA,
GT_FILEDATA    TYPE STANDARD TABLE OF TYP_FILEDATA,
GT_KANREN      TYPE STANDARD TABLE OF TYP_KANREN,
GT_KANRENTB    TYPE STANDARD TABLE OF TYP_KANRENTB,
GT_KANRENCHK   TYPE STANDARD TABLE OF TYP_KANRENCHK,
GT_DATACHK     TYPE STANDARD TABLE OF TYP_DATACHK,
GT_SYAINSYUKEI TYPE STANDARD TABLE OF TYP_SYAINSYUKEI,
GT_SUM_SYAIN   TYPE STANDARD TABLE OF TYP_SYAINSYUKEI,
GT_SUM_ALL     TYPE STANDARD TABLE OF TYP_SYAINSYUKEI,
GT_SIWAKEIMG   TYPE STANDARD TABLE OF TYP_SIWAKEIMG,
GT_BDC         TYPE STANDARD TABLE OF BDCDATA.

************************************************************************
* 内部テーブル用作業領域定義(WORK AREA)
************************************************************************
DATA:
GW_GETDATA     TYPE TYP_GETDATA,
GW_FILEDATA    TYPE TYP_FILEDATA,
GW_FLHEDATA    TYPE TYP_FILEDATA,
GW_KANREN      TYPE TYP_KANREN,
GW_KANRENTB    TYPE TYP_KANRENTB,
GW_KANRENCHK   TYPE TYP_KANRENCHK,
GW_DATACHK     TYPE TYP_DATACHK,
GW_SYAINSYUKEI TYPE TYP_SYAINSYUKEI,
GW_SUM_SYAIN   TYPE TYP_SYAINSYUKEI,
GW_SUM_ALL     TYPE TYP_SYAINSYUKEI,
GW_SIWAKEIMG   TYPE TYP_SIWAKEIMG,
GW_BDC         TYPE BDCDATA.

************************************************************************
* 変数定義(VARIABLE)
************************************************************************
DATA:
GW_TABNAM(10) TYPE C,

GF_ERRFLG(01) TYPE C,

GW_CO_CHKT TYPE I,

* データ件数
GW_CO_READ TYPE I, "読みこみ件数
GW_CO_KAOK TYPE I, "関連付けテーブルチェック正常件数
GW_CO_KAER TYPE I, "関連付けテーブルチェックエラー件数
GW_CO_DAOK TYPE I, "データチェック正常件数
GW_CO_DAER TYPE I, "データチェックエラー件数
GW_CO_TATE TYPE I, "立替件数

* 合計金額
GW_SUM_SI TYPE I, "支給合計
GW_SUM_KO TYPE I, "控除合計
GW_SUM_FU TYPE I, "振込合計
GW_SUM_KF TYPE I. "会社負担合計


************************************************************************
* 定数定義(CONSTANTS)
************************************************************************
*CONSTANTS:


************************************************************************
* 選択画面用パラメータ定義(SELECTION-SCREEN)
************************************************************************
SELECTION-SCREEN: BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.

PARAMETERS:
P_BUKRS     TYPE T001-BUKRS OBLIGATORY,      "会社コード
P_BUDAT     TYPE BKPF-BUDAT OBLIGATORY,      "転記日付
P_BKTXT(35) TYPE C,                          "伝票ヘッダテキスト
CB_TEST     AS CHECKBOX,                     "テスト実行
P_FILE      TYPE RLGRAP-FILENAME OBLIGATORY, "ファイルパス
RB_SERVE    RADIOBUTTON GROUP R1,            "サーバ
RB_LOCAL    RADIOBUTTON GROUP R1,            "ローカル
P_COUNT(04) TYPE N OBLIGATORY.               "立替限度回数

SELECTION-SCREEN: END   OF BLOCK B1.

SELECT-OPTIONS:
S_TEST FOR GW_KANRENTB-EDATE.

AT SELECTION-SCREEN ON HELP-REQUEST FOR P_FILE.

PERFORM CALL_WS_FILENAME_GET USING 'C:\TEMP'
P_FILE
'*.CSV,ALL FILES,*.*.'
'S'
'ファイル取得先'
CHANGING P_FILE.

*&---------------------------------------------------------------------*
*  TOP-OF-PAGE
*&---------------------------------------------------------------------*
TOP-OF-PAGE.
PERFORM OUTPUT_HEADER.

*&---------------------------------------------------------------------*
*  主処理(START-OF-SELECTION)
*&---------------------------------------------------------------------*
START-OF-SELECTION.

* ファイルの読込処理
* サーバー選択時
IF RB_SERVE = 'X'.
PERFORM GET_SERVE_FILE.
* ローカル選択時
ELSE.
PERFORM GET_LOCAL_FILE.
ENDIF.

* 関連付けテーブルデータチェック処理
PERFORM CHECK_KANREN_DATA.
* エラーの場合帳票出力
IF GF_ERRFLG = 'X'.
PERFORM OUTPUT_KANREN_LIST.
*    STOP.
ENDIF.

* 社員コード別データチェック処理
PERFORM CHECK_KAISYA_DATA.
* エラー判定
IF GF_ERRFLG = 'X'.
*   エラーの場合帳票出力
PERFORM OUTPUT_KANREN_LIST.
PERFORM OUTPUT_DATACHECK_LIST.
STOP.
ENDIF.

* 纏め上げ(社員コード別)
PERFORM TOTALS_EMPCD_MANEY.

* 纏め上げ(全レコード)
PERFORM TOTALS_ALLDATA_MANEY.

* BDCテーブル作成処理

* バッチインプット処理

* エラー判定
IF GF_ERRFLG = 'X'.
PERFORM OUTPUT_KANREN_LIST.
PERFORM OUTPUT_DATACHECK_LIST.
PERFORM OUTPUT_SIWAKE_LIST.
ELSE.
* 帳票出力
PERFORM OUTPUT_KANREN_LIST.
PERFORM OUTPUT_DATACHECK_LIST.
PERFORM OUTPUT_SIWAKE_LIST.
ENDIF.

*&---------------------------------------------------------------------*
*  終了処理(END-OF-SELECTION)
*&---------------------------------------------------------------------*
END-OF-SELECTION.

*&---------------------------------------------------------------------*
*&      Form  CHECK_BUKRS_DATA
*&---------------------------------------------------------------------*
*       会社ｺｰﾄﾞの存在チェック
*----------------------------------------------------------------------*
FORM CHECK_BUKRS_DATA.

DATA:
LW_BUKRS TYPE T001-BUKRS.

SELECT SINGLE BUKRS
INTO LW_BUKRS
FROM T001
WHERE BUKRS = P_BUKRS.
IF SY-SUBRC <> 0.
* '会社コードがマスタに存在しません。'
ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_LOCAL_FILE
*&---------------------------------------------------------------------*
*       処理対象ファイルの取得(ローカルPC)
*----------------------------------------------------------------------*
FORM GET_LOCAL_FILE.

CALL FUNCTION 'WS_UPLOAD'
EXPORTING
FILENAME                = P_FILE
TABLES
DATA_TAB                = GT_GETDATA
EXCEPTIONS
CONVERSION_ERROR        = 1
FILE_OPEN_ERROR         = 2
FILE_READ_ERROR         = 3
INVALID_TYPE            = 4
NO_BATCH                = 5
UNKNOWN_ERROR           = 6
INVALID_TABLE_WIDTH     = 7
GUI_REFUSE_FILETRANSFER = 8
CUSTOMER_ERROR          = 9
OTHERS                  = 10.

LOOP AT GT_GETDATA INTO GW_GETDATA.

IF SY-TABIX = 2.
CONTINUE.
ENDIF.
SPLIT GW_GETDATA AT ',' INTO GW_FILEDATA-SPLDT GW_FILEDATA-SPLYM
GW_FILEDATA-EMPCD GW_FILEDATA-NAME
GW_FILEDATA-COST  GW_FILEDATA-EMPDV
GW_FILEDATA-DIV02 GW_FILEDATA-POSCD
GW_FILEDATA-MN001 GW_FILEDATA-MN002
GW_FILEDATA-MN003 GW_FILEDATA-MN004
GW_FILEDATA-MN005 GW_FILEDATA-MN006
GW_FILEDATA-MN007 GW_FILEDATA-MN008
GW_FILEDATA-MN009 GW_FILEDATA-MN010
GW_FILEDATA-MN011 GW_FILEDATA-MN012
GW_FILEDATA-MN013 GW_FILEDATA-MN014
GW_FILEDATA-MN015 GW_FILEDATA-MN016
GW_FILEDATA-MN017 GW_FILEDATA-MN018
GW_FILEDATA-MN019 GW_FILEDATA-MN020
GW_FILEDATA-MN021 GW_FILEDATA-MN022
GW_FILEDATA-MN023 GW_FILEDATA-MN024
GW_FILEDATA-MN025 GW_FILEDATA-MN026
GW_FILEDATA-MN027 GW_FILEDATA-MN028
GW_FILEDATA-MN029 GW_FILEDATA-MN030
GW_FILEDATA-MN031 GW_FILEDATA-MN032
GW_FILEDATA-MN033 GW_FILEDATA-MN034
GW_FILEDATA-MN035 GW_FILEDATA-MN036
GW_FILEDATA-MN037 GW_FILEDATA-MN038
GW_FILEDATA-MN039 GW_FILEDATA-MN040
GW_FILEDATA-MN041 GW_FILEDATA-MN042
GW_FILEDATA-MN043 GW_FILEDATA-MN044
GW_FILEDATA-MN045 GW_FILEDATA-MN046
GW_FILEDATA-MN047 GW_FILEDATA-MN048
GW_FILEDATA-MN049 GW_FILEDATA-MN050
GW_FILEDATA-MN051 GW_FILEDATA-MN052
GW_FILEDATA-MN053 GW_FILEDATA-MN054
GW_FILEDATA-MN055 GW_FILEDATA-MN056
GW_FILEDATA-MN057 GW_FILEDATA-MN058
GW_FILEDATA-MN059 GW_FILEDATA-MN060
GW_FILEDATA-MN061 GW_FILEDATA-MN062
GW_FILEDATA-MN063 GW_FILEDATA-MN064
GW_FILEDATA-MN065 GW_FILEDATA-MN066
GW_FILEDATA-MN067 GW_FILEDATA-MN068
GW_FILEDATA-MN069 GW_FILEDATA-MN070
GW_FILEDATA-MN071 GW_FILEDATA-MN072
GW_FILEDATA-MN073 GW_FILEDATA-MN074
GW_FILEDATA-MN075 GW_FILEDATA-MN076
GW_FILEDATA-MN077 GW_FILEDATA-MN078
GW_FILEDATA-MN079 GW_FILEDATA-MN080
GW_FILEDATA-MN081 GW_FILEDATA-MN082
GW_FILEDATA-MN083 GW_FILEDATA-MN084
GW_FILEDATA-MN085 GW_FILEDATA-MN086
GW_FILEDATA-MN087 GW_FILEDATA-MN088
GW_FILEDATA-MN089 GW_FILEDATA-MN090
GW_FILEDATA-MN091 GW_FILEDATA-MN092
GW_FILEDATA-MN093 GW_FILEDATA-MN094
GW_FILEDATA-MN095 GW_FILEDATA-MN096
GW_FILEDATA-MN097 GW_FILEDATA-MN098
GW_FILEDATA-MN099 GW_FILEDATA-MN100
GW_FILEDATA-MN101 GW_FILEDATA-MN102
GW_FILEDATA-MN103 GW_FILEDATA-MN104
GW_FILEDATA-MN105 GW_FILEDATA-MN106
GW_FILEDATA-MN107 GW_FILEDATA-MN108
GW_FILEDATA-MN109 GW_FILEDATA-MN110
GW_FILEDATA-MN111 GW_FILEDATA-MN112
GW_FILEDATA-MN113 GW_FILEDATA-MN114
GW_FILEDATA-MN115 GW_FILEDATA-MN116
GW_FILEDATA-MN117 GW_FILEDATA-MN118
GW_FILEDATA-MN119 GW_FILEDATA-MN120
GW_FILEDATA-MN121 GW_FILEDATA-MN122
GW_FILEDATA-MN123 GW_FILEDATA-MN124
GW_FILEDATA-MN125 GW_FILEDATA-MN126
GW_FILEDATA-MN127 GW_FILEDATA-MN128
GW_FILEDATA-MN129 GW_FILEDATA-MN130
GW_FILEDATA-MN131 GW_FILEDATA-MN132
GW_FILEDATA-MN133 GW_FILEDATA-MN134
GW_FILEDATA-MN135 GW_FILEDATA-MN136
GW_FILEDATA-MN137 GW_FILEDATA-MN138
GW_FILEDATA-MN139 GW_FILEDATA-MN140
GW_FILEDATA-MN141 GW_FILEDATA-MN142
GW_FILEDATA-MN143 GW_FILEDATA-MN144
GW_FILEDATA-MN145 GW_FILEDATA-MN146
GW_FILEDATA-MN147 GW_FILEDATA-MN148
GW_FILEDATA-MN149 GW_FILEDATA-MN150
GW_FILEDATA-MN151 GW_FILEDATA-MN152
GW_FILEDATA-MN153 GW_FILEDATA-MN154
GW_FILEDATA-MN155 GW_FILEDATA-MN156
GW_FILEDATA-MN157 GW_FILEDATA-MN158
GW_FILEDATA-MN159 GW_FILEDATA-MN160
GW_FILEDATA-MN161 GW_FILEDATA-MN162
GW_FILEDATA-MN163 GW_FILEDATA-MN164
GW_FILEDATA-MN165 GW_FILEDATA-MN166
GW_FILEDATA-MN167 GW_FILEDATA-MN168
GW_FILEDATA-MN169 GW_FILEDATA-MN170
GW_FILEDATA-MN171 GW_FILEDATA-MN172
GW_FILEDATA-MN173 GW_FILEDATA-MN174
GW_FILEDATA-MN175 GW_FILEDATA-MN176
GW_FILEDATA-MN177 GW_FILEDATA-MN178
GW_FILEDATA-MN179 GW_FILEDATA-MN180
GW_FILEDATA-MN181 GW_FILEDATA-MN182
GW_FILEDATA-MN183 GW_FILEDATA-MN184
GW_FILEDATA-MN185 GW_FILEDATA-MN186
GW_FILEDATA-MN187 GW_FILEDATA-MN188
GW_FILEDATA-MN189 GW_FILEDATA-MN190
GW_FILEDATA-MN191 GW_FILEDATA-MN192
GW_FILEDATA-MN193 GW_FILEDATA-MN194
GW_FILEDATA-MN195 GW_FILEDATA-MN196
GW_FILEDATA-MN197 GW_FILEDATA-MN198
GW_FILEDATA-MN199 GW_FILEDATA-MN200
GW_FILEDATA-MN201 GW_FILEDATA-MN202
GW_FILEDATA-MN203 GW_FILEDATA-MN204
GW_FILEDATA-MN205 GW_FILEDATA-MN206
GW_FILEDATA-MN207 GW_FILEDATA-MN208
GW_FILEDATA-MN209 GW_FILEDATA-MN210
GW_FILEDATA-MN211 GW_FILEDATA-MN212
GW_FILEDATA-MN213 GW_FILEDATA-MN214
GW_FILEDATA-MN215 GW_FILEDATA-MN216
GW_FILEDATA-MN217 GW_FILEDATA-MN218
GW_FILEDATA-MN219 GW_FILEDATA-MN220
GW_FILEDATA-MN221 GW_FILEDATA-MN222
GW_FILEDATA-MN223 GW_FILEDATA-MN224
GW_FILEDATA-MN225 GW_FILEDATA-MN226
GW_FILEDATA-MN227 GW_FILEDATA-MN228
GW_FILEDATA-MN229 GW_FILEDATA-MN230
GW_FILEDATA-MN231 GW_FILEDATA-MN232
GW_FILEDATA-MN233 GW_FILEDATA-MN234
GW_FILEDATA-MN235 GW_FILEDATA-MN236
GW_FILEDATA-MN237 GW_FILEDATA-MN238
GW_FILEDATA-MN239 GW_FILEDATA-MN240
GW_FILEDATA-MN241 GW_FILEDATA-MN242
GW_FILEDATA-MN243 GW_FILEDATA-MN244
GW_FILEDATA-MN245 GW_FILEDATA-MN246.
APPEND GW_FILEDATA TO GT_FILEDATA.
ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_SERVE_FILE
*&---------------------------------------------------------------------*
*       処理対象ファイルの取得(サーバー)
*----------------------------------------------------------------------*
FORM GET_SERVE_FILE.

* ファイルのオープン処理
OPEN DATASET P_FILE FOR INPUT.
IF SY-SUBRC <> 0.

ENDIF.
* ファイルの読みこみ処理
DO.
READ DATASET P_FILE INTO GW_GETDATA.
IF SY-SUBRC <> 0.
EXIT.
ENDIF.
SPLIT GW_GETDATA AT ',' INTO GW_FILEDATA-SPLDT GW_FILEDATA-SPLYM
GW_FILEDATA-EMPCD GW_FILEDATA-NAME
GW_FILEDATA-COST  GW_FILEDATA-EMPDV
GW_FILEDATA-DIV02 GW_FILEDATA-POSCD
GW_FILEDATA-MN001 GW_FILEDATA-MN002
GW_FILEDATA-MN003 GW_FILEDATA-MN004
GW_FILEDATA-MN005 GW_FILEDATA-MN006
GW_FILEDATA-MN007 GW_FILEDATA-MN008
GW_FILEDATA-MN009 GW_FILEDATA-MN010
GW_FILEDATA-MN011 GW_FILEDATA-MN012
GW_FILEDATA-MN013 GW_FILEDATA-MN014
GW_FILEDATA-MN015 GW_FILEDATA-MN016
GW_FILEDATA-MN017 GW_FILEDATA-MN018
GW_FILEDATA-MN019 GW_FILEDATA-MN020
GW_FILEDATA-MN021 GW_FILEDATA-MN022
GW_FILEDATA-MN023 GW_FILEDATA-MN024
GW_FILEDATA-MN025 GW_FILEDATA-MN026
GW_FILEDATA-MN027 GW_FILEDATA-MN028
GW_FILEDATA-MN029 GW_FILEDATA-MN030
GW_FILEDATA-MN031 GW_FILEDATA-MN032
GW_FILEDATA-MN033 GW_FILEDATA-MN034
GW_FILEDATA-MN035 GW_FILEDATA-MN036
GW_FILEDATA-MN037 GW_FILEDATA-MN038
GW_FILEDATA-MN039 GW_FILEDATA-MN040
GW_FILEDATA-MN041 GW_FILEDATA-MN042
GW_FILEDATA-MN043 GW_FILEDATA-MN044
GW_FILEDATA-MN045 GW_FILEDATA-MN046
GW_FILEDATA-MN047 GW_FILEDATA-MN048
GW_FILEDATA-MN049 GW_FILEDATA-MN050
GW_FILEDATA-MN051 GW_FILEDATA-MN052
GW_FILEDATA-MN053 GW_FILEDATA-MN054
GW_FILEDATA-MN055 GW_FILEDATA-MN056
GW_FILEDATA-MN057 GW_FILEDATA-MN058
GW_FILEDATA-MN059 GW_FILEDATA-MN060
GW_FILEDATA-MN061 GW_FILEDATA-MN062
GW_FILEDATA-MN063 GW_FILEDATA-MN064
GW_FILEDATA-MN065 GW_FILEDATA-MN066
GW_FILEDATA-MN067 GW_FILEDATA-MN068
GW_FILEDATA-MN069 GW_FILEDATA-MN070
GW_FILEDATA-MN071 GW_FILEDATA-MN072
GW_FILEDATA-MN073 GW_FILEDATA-MN074
GW_FILEDATA-MN075 GW_FILEDATA-MN076
GW_FILEDATA-MN077 GW_FILEDATA-MN078
GW_FILEDATA-MN079 GW_FILEDATA-MN080
GW_FILEDATA-MN081 GW_FILEDATA-MN082
GW_FILEDATA-MN083 GW_FILEDATA-MN084
GW_FILEDATA-MN085 GW_FILEDATA-MN086
GW_FILEDATA-MN087 GW_FILEDATA-MN088
GW_FILEDATA-MN089 GW_FILEDATA-MN090
GW_FILEDATA-MN091 GW_FILEDATA-MN092
GW_FILEDATA-MN093 GW_FILEDATA-MN094
GW_FILEDATA-MN095 GW_FILEDATA-MN096
GW_FILEDATA-MN097 GW_FILEDATA-MN098
GW_FILEDATA-MN099 GW_FILEDATA-MN100
GW_FILEDATA-MN101 GW_FILEDATA-MN102
GW_FILEDATA-MN103 GW_FILEDATA-MN104
GW_FILEDATA-MN105 GW_FILEDATA-MN106
GW_FILEDATA-MN107 GW_FILEDATA-MN108
GW_FILEDATA-MN109 GW_FILEDATA-MN110
GW_FILEDATA-MN111 GW_FILEDATA-MN112
GW_FILEDATA-MN113 GW_FILEDATA-MN114
GW_FILEDATA-MN115 GW_FILEDATA-MN116
GW_FILEDATA-MN117 GW_FILEDATA-MN118
GW_FILEDATA-MN119 GW_FILEDATA-MN120
GW_FILEDATA-MN121 GW_FILEDATA-MN122
GW_FILEDATA-MN123 GW_FILEDATA-MN124
GW_FILEDATA-MN125 GW_FILEDATA-MN126
GW_FILEDATA-MN127 GW_FILEDATA-MN128
GW_FILEDATA-MN129 GW_FILEDATA-MN130
GW_FILEDATA-MN131 GW_FILEDATA-MN132
GW_FILEDATA-MN133 GW_FILEDATA-MN134
GW_FILEDATA-MN135 GW_FILEDATA-MN136
GW_FILEDATA-MN137 GW_FILEDATA-MN138
GW_FILEDATA-MN139 GW_FILEDATA-MN140
GW_FILEDATA-MN141 GW_FILEDATA-MN142
GW_FILEDATA-MN143 GW_FILEDATA-MN144
GW_FILEDATA-MN145 GW_FILEDATA-MN146
GW_FILEDATA-MN147 GW_FILEDATA-MN148
GW_FILEDATA-MN149 GW_FILEDATA-MN150
GW_FILEDATA-MN151 GW_FILEDATA-MN152
GW_FILEDATA-MN153 GW_FILEDATA-MN154
GW_FILEDATA-MN155 GW_FILEDATA-MN156
GW_FILEDATA-MN157 GW_FILEDATA-MN158
GW_FILEDATA-MN159 GW_FILEDATA-MN160
GW_FILEDATA-MN161 GW_FILEDATA-MN162
GW_FILEDATA-MN163 GW_FILEDATA-MN164
GW_FILEDATA-MN165 GW_FILEDATA-MN166
GW_FILEDATA-MN167 GW_FILEDATA-MN168
GW_FILEDATA-MN169 GW_FILEDATA-MN170
GW_FILEDATA-MN171 GW_FILEDATA-MN172
GW_FILEDATA-MN173 GW_FILEDATA-MN174
GW_FILEDATA-MN175 GW_FILEDATA-MN176
GW_FILEDATA-MN177 GW_FILEDATA-MN178
GW_FILEDATA-MN179 GW_FILEDATA-MN180
GW_FILEDATA-MN181 GW_FILEDATA-MN182
GW_FILEDATA-MN183 GW_FILEDATA-MN184
GW_FILEDATA-MN185 GW_FILEDATA-MN186
GW_FILEDATA-MN187 GW_FILEDATA-MN188
GW_FILEDATA-MN189 GW_FILEDATA-MN190
GW_FILEDATA-MN191 GW_FILEDATA-MN192
GW_FILEDATA-MN193 GW_FILEDATA-MN194
GW_FILEDATA-MN195 GW_FILEDATA-MN196
GW_FILEDATA-MN197 GW_FILEDATA-MN198
GW_FILEDATA-MN199 GW_FILEDATA-MN200
GW_FILEDATA-MN201 GW_FILEDATA-MN202
GW_FILEDATA-MN203 GW_FILEDATA-MN204
GW_FILEDATA-MN205 GW_FILEDATA-MN206
GW_FILEDATA-MN207 GW_FILEDATA-MN208
GW_FILEDATA-MN209 GW_FILEDATA-MN210
GW_FILEDATA-MN211 GW_FILEDATA-MN212
GW_FILEDATA-MN213 GW_FILEDATA-MN214
GW_FILEDATA-MN215 GW_FILEDATA-MN216
GW_FILEDATA-MN217 GW_FILEDATA-MN218
GW_FILEDATA-MN219 GW_FILEDATA-MN220
GW_FILEDATA-MN221 GW_FILEDATA-MN222
GW_FILEDATA-MN223 GW_FILEDATA-MN224
GW_FILEDATA-MN225 GW_FILEDATA-MN226
GW_FILEDATA-MN227 GW_FILEDATA-MN228
GW_FILEDATA-MN229 GW_FILEDATA-MN230
GW_FILEDATA-MN231 GW_FILEDATA-MN232
GW_FILEDATA-MN233 GW_FILEDATA-MN234
GW_FILEDATA-MN235 GW_FILEDATA-MN236
GW_FILEDATA-MN237 GW_FILEDATA-MN238
GW_FILEDATA-MN239 GW_FILEDATA-MN240
GW_FILEDATA-MN241 GW_FILEDATA-MN242
GW_FILEDATA-MN243 GW_FILEDATA-MN244
GW_FILEDATA-MN245 GW_FILEDATA-MN246.
APPEND GW_FILEDATA TO GT_FILEDATA.
ENDDO.

* ファイルのクローズ処理
CLOSE DATASET P_FILE.
IF SY-SUBRC <> 0.

ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  GET_KANREN_DATA
*&---------------------------------------------------------------------*
*       関連付けデータテーブルの取得
*----------------------------------------------------------------------*
FORM GET_KANREN_DATA.


PERFORM TEST_DATA.
LOOP AT GT_KANREN INTO GW_KANREN.
*    SELECT
*      INTO
*      FROM
*     WHERE = GW_KANREN-SALNM.
*      APPEND GW_KANRENTB INTO GT_KANRENTB.
*      GW_KANREN-SAKNR = GW_KANRENTB-SAKNR.
*      MODIFY GW_KANREN GT_KANREN
*    ENDSELECT.
*
READ TABLE GT_KANRENTB INTO GW_KANRENTB
WITH KEY SALMN = GW_KANREN-SALMN
BINARY SEARCH.
IF SY-SUBRC = 0.
GW_KANREN-SAKNR = GW_KANRENTB-SAKNR.
MODIFY GT_KANREN FROM GW_KANREN.
ENDIF.

ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_KANREN_DATA
*&---------------------------------------------------------------------*
*       関連付けデータテーブルのチェック
*----------------------------------------------------------------------*
FORM CHECK_KANREN_DATA.

DATA:
LW_MANEY(20) TYPE C,
LW_SAKNR     TYPE SKB1-SAKNR,
LW_MWSKZ     TYPE T007A-MWSKZ.

* 給与項目行を取得
READ TABLE GT_FILEDATA INTO GW_FLHEDATA INDEX 1.

* 給与項目のチェック
DO VARYING LW_MANEY FROM GW_FLHEDATA-MN001 NEXT GW_FLHEDATA-MN002.

GW_CO_CHKT = GW_CO_CHKT + 1.
GW_KANREN-SALMN = LW_MANEY.
APPEND GW_KANREN TO GT_KANREN.
IF  GW_CO_CHKT > 246.
EXIT.
ENDIF.
ENDDO.

* 関連付けチェックテーブルの取得
PERFORM GET_KANREN_DATA.

LOOP AT GT_KANREN INTO GW_KANREN WHERE SAKNR <> SPACE.
*   給与項目の関連付けテーブルエントリの有無のチェック
READ TABLE GT_KANRENTB INTO GW_KANRENTB
WITH KEY SALMN = GW_KANREN-SALMN
BINARY SEARCH.
IF SY-SUBRC <> 0.
GW_KANRENCHK-LTEXT = '給与項目がチェックテーブルに存在しません。'.
GF_ERRFLG = 'X'.
GW_CO_KAER = GW_CO_KAER + 1.
GW_KANRENCHK-SALMN = GW_KANREN-SALMN.
APPEND GW_KANRENCHK TO GT_KANRENCHK.
CONTINUE.
ENDIF.
MOVE-CORRESPONDING GW_KANRENTB TO GW_KANRENCHK.

*   支給区分のチェック
IF  GW_KANRENTB-SPLDV <> '1'
AND GW_KANRENTB-SPLDV <> '2'.
GW_KANRENCHK-LTEXT = '支給区分に誤りがあります。'.
GF_ERRFLG = 'X'.
GW_CO_KAER = GW_CO_KAER + 1.
APPEND GW_KANRENCHK TO GT_KANRENCHK.
CONTINUE.
ENDIF.

*   項目区分のチェック
IF  GW_KANRENTB-ITMDV <> 'P'
AND GW_KANRENTB-ITMDV <> 'D'
AND GW_KANRENTB-ITMDV <> 'C'
AND GW_KANRENTB-ITMDV <> 'T'.
GW_KANRENCHK-LTEXT = '項目区分に誤りがあります。'.
GF_ERRFLG = 'X'.
GW_CO_KAER = GW_CO_KAER + 1.
APPEND GW_KANRENCHK TO GT_KANRENCHK.
CONTINUE.
ENDIF.

*   勘定コードのマスタ存在チェック(SKB1)
SELECT SINGLE SAKNR
INTO LW_SAKNR
FROM SKB1
WHERE SAKNR = GW_KANRENTB-SAKNR.
IF SY-SUBRC <> 0.
GW_KANRENCHK-LTEXT = '勘定コードがマスタに存在しません。'.
GF_ERRFLG = 'X'.
GW_CO_KAER = GW_CO_KAER + 1.
APPEND GW_KANRENCHK TO GT_KANRENCHK.
CONTINUE.
ENDIF.

*   税コードのマスタ存在チェック(T007A)
SELECT SINGLE MWSKZ
INTO LW_MWSKZ
FROM T007A
WHERE MWSKZ = GW_KANRENTB-MWSKZ.
IF SY-SUBRC <> 0.
GW_KANRENCHK-LTEXT = '税コードがマスタに存在しません。'.
GF_ERRFLG = 'X'.
GW_CO_KAER = GW_CO_KAER + 1.
APPEND GW_KANRENCHK TO GT_KANRENCHK.
CONTINUE.
ENDIF.

APPEND GW_KANRENCHK TO GT_KANRENCHK.
GW_CO_KAOK = GW_CO_KAOK + 1.

ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_KANREN_LIST
*&---------------------------------------------------------------------*
*       関連付けチェックリストの出力
*----------------------------------------------------------------------*
FORM OUTPUT_KANREN_LIST.

NEW-PAGE.

WRITE: /1   '給与項目',
10  '貸借',
17  '支給区分',
26  '終了日付',
37  '項目区分',
59  '勘定コード',
60  '勘定typ',
68  '特',
71  '税',
74  '明細テキスト',
125 '結果',
132 'メッセージ'.

ULINE.
LOOP AT GT_KANRENCHK INTO GW_KANRENCHK.
WRITE: /1   GW_KANRENCHK-SALMN, "給与項目
10  GW_KANRENCHK-SHKZG, "貸借
12  GW_KANRENCHK-SHKTX, "貸借テキスト
17  GW_KANRENCHK-SPLDV, "支給区分
19  GW_KANRENCHK-SPLTX, "支給区分テキスト
26  GW_KANRENCHK-EDATE, "終了日付
37  GW_KANRENCHK-ITMDV, "項目区分
39  GW_KANRENCHK-ITMTX, "項目区分テキスト
59  GW_KANRENCHK-SAKNR, "勘定コード
60  GW_KANRENCHK-MITKZ, "勘定タイプ
62  GW_KANRENCHK-MITTX, "勘定タイプテキスト
68  GW_KANRENCHK-UMSKZ, "特殊仕訳コード
71  GW_KANRENCHK-MWSKZ, "税コード
74  GW_KANRENCHK-SGTXT, "明細テキスト
125 GW_KANRENCHK-RESLT, "結果
132 GW_KANRENCHK-LTEXT. "メッセージ
ENDLOOP.

* 件数出力
NEW-PAGE.
ULINE.
WRITE: /3 '＊＊＊＊＊＊＊＊＊＊＊＊＊＊',
/3 '読込レコード　　：',
17 GW_CO_READ,
27 '件',
/3 '正常　　　　　　：',
17 GW_CO_KAOK,
27 '件',
/3 'エラー　　　　　：',
17 GW_CO_KAER,
27 '件',
/3 '＊＊＊＊＊＊＊＊＊＊＊＊＊＊'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_KANREN_DATA
*&---------------------------------------------------------------------*
*       関連付けデータテーブルのチェック
*----------------------------------------------------------------------*
FORM CHECK_KAISYA_DATA.

DATA:
LW_KOSTL TYPE CSKS-KOSTL,
LW_C_LIFNR(10) TYPE N,
LW_LIFNR(10) TYPE C,
LW_MANEY(20) TYPE C.

LOOP AT GT_FILEDATA INTO GW_FILEDATA.

CLEAR:
GW_DATACHK,
GW_CO_CHKT.

MOVE-CORRESPONDING GW_FILEDATA TO GW_DATACHK.

*   支給年月日の日付書式チェック
*    PERFORM CALL_CONVERT_DATE_TO_EXTERNAL USING GW_FILEDATA-SPLDT.
IF GW_FILEDATA-SPLDT IS INITIAL.
GW_DATACHK-LTEXT = '支給年月日の書式に誤りがあります。'.
*      GF_ERRFLG = 'X'.
GW_CO_DAER = GW_CO_DAER + 1.
APPEND GW_DATACHK TO GT_DATACHK.
CONTINUE.
ENDIF.

*   社員コードの必須入力チェック
IF GW_FILEDATA-EMPCD IS INITIAL.
GW_DATACHK-LTEXT = '社員コードが未入力です。'.
GF_ERRFLG = 'X'.
GW_CO_DAER = GW_CO_DAER + 1.
APPEND GW_DATACHK TO GT_DATACHK.
CONTINUE.
ENDIF.

* 社員コードの仕入先マスタ存在チェック(LFA1)
IF GW_FILEDATA-EMPCD CO ' 0123456789'.
MOVE  GW_FILEDATA-EMPCD TO LW_C_LIFNR.
WRITE LW_C_LIFNR TO GW_FILEDATA-EMPCD.
ENDIF.

SELECT SINGLE LIFNR
INTO LW_LIFNR
FROM LFA1
WHERE LIFNR = GW_FILEDATA-EMPCD.
IF SY-SUBRC <> 0.
GW_DATACHK-LTEXT = '社員コードが仕入先マスタに存在しません。'.
GF_ERRFLG = 'X'.
GW_CO_DAER = GW_CO_DAER + 1.
APPEND GW_DATACHK TO GT_DATACHK.
CONTINUE.
ENDIF.

*   NAMEの必須入力チェック
IF GW_FILEDATA-NAME IS INITIAL.
GW_DATACHK-LTEXT = 'NAMEが未入力です。'.
GF_ERRFLG = 'X'.
GW_CO_DAER = GW_CO_DAER + 1.
APPEND GW_DATACHK TO GT_DATACHK.
CONTINUE.
ENDIF.

*   COST CENTER給与の必須入力チェック
IF GW_FILEDATA-COST IS INITIAL.
GW_DATACHK-LTEXT = 'COST CENTER給与が未入力です。'.
GF_ERRFLG = 'X'.
GW_CO_DAER = GW_CO_DAER + 1.
APPEND GW_DATACHK TO GT_DATACHK.
CONTINUE.
ENDIF.

* COST CENTER給与の原価センタマスタ存在チェック（CSKS）
SELECT SINGLE KOSTL
INTO LW_KOSTL
FROM CSKS
WHERE KOSTL = GW_FILEDATA-COST.
IF SY-SUBRC <> 0.
GW_DATACHK-LTEXT =
'COST CENTER給与が原価センタマスタに存在しません。'.
GF_ERRFLG = 'X'.
GW_CO_DAER = GW_CO_DAER + 1.
APPEND GW_DATACHK TO GT_DATACHK.
CONTINUE.
ENDIF.

*   金額項目の文字混入チェック(最大246項目)
DO VARYING LW_MANEY FROM GW_FILEDATA-MN001 NEXT GW_FILEDATA-MN002.

GW_CO_CHKT = GW_CO_CHKT + 1.
GW_KANREN-SALMN = LW_MANEY.
IF LW_MANEY CO ' 0123456789'.
READ TABLE GT_KANREN   INTO GW_KANREN   INDEX GW_CO_CHKT.
IF  NOT GW_KANREN-SALMN IS INITIAL
AND NOT GW_KANREN-SAKNR IS INITIAL.
READ TABLE GT_KANRENTB INTO GW_KANRENTB
WITH KEY SALMN  = GW_KANREN-SALMN
BINARY SEARCH.
GW_SYAINSYUKEI-EMPCD = GW_FILEDATA-EMPCD. "社員コード
GW_SYAINSYUKEI-COST  = GW_FILEDATA-COST.  "原価センタ
GW_SYAINSYUKEI-SAKNR = GW_KANRENTB-SAKNR. "勘定コード
GW_SYAINSYUKEI-UMSKZ = GW_KANRENTB-UMSKZ. "特殊仕訳
GW_SYAINSYUKEI-SHKZG = GW_KANRENTB-SHKZG. "貸借コード
GW_SYAINSYUKEI-MWSKZ = GW_KANRENTB-MWSKZ. "税コード
GW_SYAINSYUKEI-SGTXT = GW_KANRENTB-SGTXT. "明細テキスト
GW_SYAINSYUKEI-PAYMN = LW_MANEY.          "支払金額
APPEND GW_SYAINSYUKEI TO GT_SYAINSYUKEI.
ENDIF.
ELSE.
READ TABLE GT_KANREN INTO GW_KANREN INDEX GW_CO_CHKT.
GW_DATACHK-LTEXT = '給与項目：XXXXの金額に誤りがあります。'.
GF_ERRFLG = 'X'.
EXIT.
ENDIF.
IF  GW_CO_CHKT > 246.
EXIT.
ENDIF.
ENDDO.
*
APPEND GW_DATACHK TO GT_DATACHK.
GW_CO_DAOK = GW_CO_DAOK + 1.

ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_DATACECHK_LIST
*&---------------------------------------------------------------------*
*       データチェックリストの出力
*----------------------------------------------------------------------*
FORM TOTALS_EMPCD_MANEY.

DATA:
LW_XBILK(01) TYPE C,
LW_MANEY     TYPE I,
LW_SUMMN     TYPE I.

SORT GT_SYAINSYUKEI BY EMPCD  "社員コード
SAKNR  "勘定コード
SGTXT  "明細テキスト
SHKZG  "貸借コード
COST   "原価センタ
UMSKZ  "特殊仕訳
MWSKZ  "税コード
PAYMN. "支払金額

LOOP AT GT_SYAINSYUKEI INTO GW_SYAINSYUKEI.

*   集計金額の確認
AT NEW EMPCD.

IF LW_SUMMN > 0.
GW_SUM_SYAIN-PAYMN = LW_SUMMN * -1.
GW_SUM_SYAIN-SHKZG = 'H'.
GW_SUM_SYAIN-SAKNR = '9999999999'.
GW_SUM_SYAIN-SGTXT = '立替済'.
APPEND GW_SUM_SYAIN TO GT_SUM_SYAIN.
ENDIF.
IF LW_SUMMN < 0.
GW_SUM_SYAIN-PAYMN = LW_SUMMN * -1.
GW_SUM_SYAIN-SHKZG = 'S'.
GW_SUM_SYAIN-SAKNR = '9999999999'.
GW_SUM_SYAIN-SGTXT = '立替済'.
APPEND GW_SUM_SYAIN TO GT_SUM_SYAIN.
ENDIF.
CLEAR:
LW_SUMMN.
ENDAT.

MOVE-CORRESPONDING GW_SYAINSYUKEI TO GW_SUM_SYAIN.

CASE GW_SYAINSYUKEI-SHKZG.

WHEN 'S'.
LW_MANEY = LW_MANEY + GW_SYAINSYUKEI-PAYMN.
LW_SUMMN = LW_SUMMN + GW_SYAINSYUKEI-PAYMN.
WHEN 'H'.
LW_MANEY = LW_MANEY - GW_SYAINSYUKEI-PAYMN.
LW_SUMMN = LW_SUMMN - GW_SYAINSYUKEI-PAYMN.
ENDCASE.

*   B/S勘定かP/L勘定の判定
SELECT SINGLE XBILK
INTO LW_XBILK
FROM SKA1
WHERE SAKNR = GW_SYAINSYUKEI-SAKNR.
IF  LW_XBILK = 'X'.
AT END OF SAKNR.
GW_SUM_SYAIN-XBILK = LW_XBILK.
GW_SUM_SYAIN-PAYMN = LW_MANEY.
CLEAR:
LW_MANEY.
APPEND GW_SUM_SYAIN TO GT_SUM_SYAIN.
ENDAT.
ELSE.
AT END OF SGTXT.
GW_SUM_SYAIN-XBILK = LW_XBILK.
GW_SUM_SYAIN-PAYMN = LW_MANEY.
CLEAR:
LW_MANEY.
APPEND GW_SUM_SYAIN TO GT_SUM_SYAIN.
ENDAT.
ENDIF.
ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  TOTALS_ALLDATA_MANEY
*&---------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
FORM TOTALS_ALLDATA_MANEY.

DATA:
LW_XBILK(01) TYPE C,
LW_MANEY     TYPE I,
LW_SUMMN     TYPE I.

SORT GT_SUM_SYAIN BY EMPCD  "社員コード
SAKNR  "勘定コード
SGTXT  "明細テキスト
SHKZG  "貸借コード
COST   "原価センタ
UMSKZ  "特殊仕訳
MWSKZ  "税コード
PAYMN. "支払金額

LOOP AT GT_SUM_SYAIN INTO GW_SUM_SYAIN.

MOVE-CORRESPONDING GW_SUM_SYAIN TO GW_SUM_ALL.

*   転記キーの判別処理
*   勘定コードの勘定タイプが総勘定元帳勘定かつ、貸借が借方の場合
IF  GW_SUM_SYAIN-XBILK = ' '
AND GW_SUM_SYAIN-SHKZG = 'H'.
GW_SUM_ALL-BSCHL = '40'.
ENDIF.
*   勘定コードの勘定タイプが総勘定元帳勘定かつ、貸借が貸方の場合
IF  GW_SUM_SYAIN-XBILK = ' '
AND GW_SUM_SYAIN-SHKZG = 'S'.
GW_SUM_ALL-BSCHL = '50'.
ENDIF.

*   勘定コードの勘定タイプが仕入先かつ、貸借が借方の場合
IF  GW_SUM_SYAIN-XBILK = 'X'
AND GW_SUM_SYAIN-SHKZG = 'H'.
GW_SUM_ALL-BSCHL = '29'.
ENDIF.

*   勘定コードの勘定タイプが仕入先かつ、貸借が貸方の場合
IF  GW_SUM_SYAIN-XBILK = 'X'
AND GW_SUM_SYAIN-SHKZG = 'S'.
GW_SUM_ALL-BSCHL = '39'.
ENDIF.

CASE GW_SUM_SYAIN-SHKZG.

WHEN 'S'.
LW_MANEY = LW_MANEY + GW_SUM_SYAIN-PAYMN.
LW_SUMMN = LW_SUMMN + GW_SUM_SYAIN-PAYMN.
WHEN 'H'.
LW_MANEY = LW_MANEY - GW_SUM_SYAIN-PAYMN.
LW_SUMMN = LW_SUMMN - GW_SUM_SYAIN-PAYMN.
ENDCASE.

*   B/S勘定かP/L勘定の判定
IF  GW_SUM_SYAIN = 'X'.
AT END OF SAKNR.
GW_SUM_ALL-PAYMN = LW_MANEY.
CLEAR:
LW_MANEY.
APPEND GW_SUM_ALL TO GT_SUM_ALL.
ENDAT.
ELSE.
AT END OF SGTXT.
GW_SUM_ALL-PAYMN = LW_MANEY.
CLEAR:
LW_MANEY.
APPEND GW_SUM_ALL TO GT_SUM_ALL.
ENDAT.
ENDIF.
ENDLOOP.

* 立替限度回数チェック
IF  GW_CO_TATE > P_COUNT.
MOVE-CORRESPONDING GW_SUM_ALL TO GW_SIWAKEIMG.

GW_SIWAKEIMG-APLCT =
'設定された立替限度回数を超える立替処理が行われました。'.
GW_SIWAKEIMG-BUDAT = P_BUDAT.
INSERT GW_SIWAKEIMG INTO GT_SIWAKEIMG INDEX 1.
*    APPEND GW_SIWAKEIMG TO GT_SIWAKEIMG.
ENDIF.

* BDCの作成
LOOP AT GT_SUM_ALL INTO GW_SUM_ALL.

MOVE-CORRESPONDING GW_SUM_ALL TO GW_SIWAKEIMG.
APPEND GW_SIWAKEIMG TO GT_SIWAKEIMG.

ENDLOOP.
CLEAR:
GW_SIWAKEIMG.
GW_SIWAKEIMG-BUDAT = P_BUDAT.
INSERT GW_SIWAKEIMG INTO GT_SIWAKEIMG INDEX 1.
*    APPEND GW_SIWAKEIMG TO GT_SIWAKEIMG.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_DATACECHK_LIST
*&---------------------------------------------------------------------*
*       データチェックリストの出力
*----------------------------------------------------------------------*
FORM OUTPUT_DATACHECK_LIST.

NEW-PAGE.

WRITE: /1  '社員ｺｰﾄﾞ',
11 'NAME',
33 '原価センタ',
45 '支払金額',
58 'チェック',
70 'メッセージ'.
ULINE.

LOOP AT GT_DATACHK INTO GW_DATACHK.
WRITE: /1  GW_DATACHK-EMPCD, "社員コード
11 GW_DATACHK-NAME,  "NAME
33 GW_DATACHK-COST,  "原価センタ
45 GW_DATACHK-PAYMN, "支払金額
58 GW_DATACHK-CHECK, "チェック
70 GW_DATACHK-LTEXT. "メッセージ
ENDLOOP.

* 件数出力
NEW-PAGE.
ULINE.
WRITE: /3 '＊＊＊＊＊＊＊＊＊＊＊＊＊＊',
/3 '読込レコード　　：',
17 GW_CO_READ,
27 '件',
/3 '正常　　　　　　：',
17 GW_CO_DAOK,
27 '件',
/3 'エラー　　　　　：',
17 GW_CO_DAER,
27 '件',
/3 '＊＊＊＊＊＊＊＊＊＊＊＊＊＊'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_SIWAKE_LIST
*&---------------------------------------------------------------------*
*       仕訳イメージリストの出力
*----------------------------------------------------------------------*
FORM OUTPUT_SIWAKE_LIST.

* ヘッダ出力
WRITE: /1   '伝票NO',
13  '転記日付',
25  'PK',
29  '勘定コード',
41  '勘定テキスト',
78  '税',
82  '原価センタ',
94  '金　額',
114 '適用'.

* 明細出力
LOOP AT GT_SIWAKEIMG INTO GW_SIWAKEIMG.
WRITE: /1   GW_SIWAKEIMG-BELNR, "伝票NO
13  GW_SIWAKEIMG-BUDAT, "転記日付
25  GW_SIWAKEIMG-BSCHL, "PK
29  GW_SIWAKEIMG-SAKNR, "勘定コード
41  GW_SIWAKEIMG-TXT20, "勘定テキスト
78  GW_SIWAKEIMG-MWSKZ, "税コード
82  GW_SIWAKEIMG-KOSTL, "原価センタ
94  GW_SIWAKEIMG-PAYMN, "金額
114 GW_SIWAKEIMG-APLCT. "適用
ENDLOOP.

* 金額出力
NEW-PAGE.
ULINE.
WRITE: /3 '＊＊＊＊＊＊＊＊＊＊＊＊＊＊',
/3 '支給合計　　　　：',
17 GW_SUM_SI,
/3 '控除合計　　　　：',
17 GW_SUM_KO,
/3 '振込合計　　　　：',
17 GW_SUM_FU,
/3 '会社負担合計　　：',
17 GW_SUM_KF,
/3 '＊＊＊＊＊＊＊＊＊＊＊＊＊＊'.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CALL_CONVERT_DATE_TO_EXTERNAL
*&---------------------------------------------------------------------*
*       日付の書式チェック
*----------------------------------------------------------------------*
FORM CALL_CONVERT_DATE_TO_EXTERNAL USING PA_DATE.

CALL FUNCTION 'CONVERT_DATE_TO_EXTERNAL'
EXPORTING
DATE_INTERNAL            = PA_DATE
IMPORTING
DATE_EXTERNAL            = PA_DATE
EXCEPTIONS
DATE_INTERNAL_IS_INVALID = 1
OTHERS                   = 2.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CALL_CONVERT_DATE_TO_EXTERNAL
*&---------------------------------------------------------------------*
*       日付の書式チェック
*----------------------------------------------------------------------*
FORM OUTPUT_HEADER.

WRITE: /79  '給与仕訳ＢＤＣ',
161 'ページ',
167 SY-PAGNO.
WRITE: /79  '==============',
138 '作成年月日',
148 SY-DATUM+0(4),
152 '年',
154 SY-DATUM+4(2),
156 '月',
158 SY-DATUM+6(2),
160 '日',
164 SY-UZEIT+0(2),
166 ':',
168 SY-UZEIT+2(2).

IF CB_TEST IS INITIAL.
WRITE: /81  '【本実行】'.
ELSE.
WRITE: /79  '【テスト実行】'.
ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      FORM CALL_WS_FILENAME_GET
*&---------------------------------------------------------------------*
*       ファイル入出力先の検索ウィンドウ呼び出し処理
*----------------------------------------------------------------------*
FORM CALL_WS_FILENAME_GET USING PA_FILENAME
PA_PATH
PA_MASK
PA_MODE
PA_TITLE
CHANGING PA_PATH_C.

CALL FUNCTION 'WS_FILENAME_GET'
EXPORTING
DEF_FILENAME     = PA_FILENAME
DEF_PATH         = PA_PATH
MASK             = PA_MASK
MODE             = PA_MODE
TITLE            = PA_TITLE
IMPORTING
FILENAME         = PA_PATH_C
EXCEPTIONS
INV_WINSYS       = 1
NO_BATCH         = 2
SELECTION_CANCEL = 3
SELECTION_ERROR  = 4
OTHERS           = 5.

IF SY-SUBRC <> 0 AND
SY-SUBRC <> 3.

ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DYNPRO
*&---------------------------------------------------------------------*
*       ＢＤＣ作成
*----------------------------------------------------------------------*
*      -->DYNBEG   text                                                *
*      -->NAME     text                                                *
*      -->VALUE    text                                                *
*----------------------------------------------------------------------*
FORM SET_DYNPRO_ITEM USING PA_DYNBEGIN
PA_NAME
PA_VALUE.

CLEAR:
GW_BDC.

IF PA_DYNBEGIN = 'X'.
MOVE PA_NAME  TO GW_BDC-PROGRAM.
MOVE PA_VALUE TO GW_BDC-DYNPRO.
MOVE 'X'   TO GW_BDC-DYNBEGIN.
ELSE.
MOVE PA_NAME  TO GW_BDC-FNAM.
MOVE PA_VALUE TO GW_BDC-FVAL.
ENDIF.
APPEND GW_BDC TO GT_BDC.

ENDFORM.
*  ※以下はテスト用ツール
*&---------------------------------------------------------------------*
*&      Form
*&---------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
FORM TEST_DATA.

CALL FUNCTION 'WS_UPLOAD'
EXPORTING
FILENAME                =
'C:\TEMP\テスト用の関連付けチェックデータ.txt'
FILETYPE                = 'DAT'
TABLES
DATA_TAB                = GT_KANRENTB
EXCEPTIONS
CONVERSION_ERROR        = 1
FILE_OPEN_ERROR         = 2
FILE_READ_ERROR         = 3
INVALID_TYPE            = 4
NO_BATCH                = 5
UNKNOWN_ERROR           = 6
INVALID_TABLE_WIDTH     = 7
GUI_REFUSE_FILETRANSFER = 8
CUSTOMER_ERROR          = 9
OTHERS                  = 10.

ENDFORM.
