*&---------------------------------------------------------------------*
*& Report  YTEST_RXY4
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  YTEST_RXY4.


PARAMETERS P_EBELN   TYPE EBELN. "得意先発注番号
PARAMETERS P_TEST    TYPE C DEFAULT 'X'.

PERFORM BAPI_SO_CREATE.


FORM BAPI_SO_CREATE.

DATA:
LW_NUMBER         TYPE POSNR_VA,
LW_VBELN          TYPE BAPIVBELN-VBELN,
LST_HEADER_IN     TYPE BAPISDHD1,
LST_ORDER_PARTNER TYPE BAPIPARNR,
LTD_ORDER_PARTNER TYPE TABLE OF BAPIPARNR,
LST_ITEMS_IN      TYPE BAPISDITM,
LTD_ITEMS_IN      TYPE TABLE OF BAPISDITM,
LST_SCHEDULES     TYPE BAPISCHDL,
LTD_SCHEDULES     TYPE STANDARD TABLE OF BAPISCHDL,
LST_CONDITIONS    TYPE BAPICOND,
LTD_CONDITIONS    TYPE STANDARD TABLE OF BAPICOND,
LW_COND_VALUE     TYPE BAPICURR-BAPICURR,
LST_RETURN        TYPE BAPIRET2,
LTD_RETURN        TYPE TABLE OF BAPIRET2,
LST_SWITCH        TYPE BAPISDLS.

DATA:
LT_ORDER_TEXT       TYPE TABLE OF BAPISDTEXT,
WL_ORDER_TEXT       TYPE  BAPISDTEXT,
LT_PARTNERADDRESSES TYPE TABLE OF BAPIADDR1,
WL_PARTNERADDRESSES TYPE  BAPIADDR1.

* 1 受注伝票ヘッダ
LST_HEADER_IN-DOC_TYPE   = 'ZOR'.  " 販売伝票タイプ
LST_HEADER_IN-SALES_ORG  = '1000'. " 販売組織
LST_HEADER_IN-DISTR_CHAN = '10'.   "流通チャネル
LST_HEADER_IN-DIVISION   = '10'.   " 製品部門
LST_HEADER_IN-SALES_GRP  = '040'.  " 営業グループ
LST_HEADER_IN-SALES_OFF  = '0400'. " 営業所
LST_HEADER_IN-PURCH_NO_C = P_EBELN.  " 得意先発注番号
LST_HEADER_IN-PURCH_DATE = SY-DATUM. " 得意先発注日付
*  LST_HEADER_IN-ORD_REASON = I_ST_ZT203-AUGRU. " 受注理由 (取引理由)
LST_HEADER_IN-CURRENCY   = 'JPY'. " 販売伝票通貨

* 4 伝票取引先
LST_ORDER_PARTNER-PARTN_ROLE = 'AG'. " 受注先「SP」
LST_ORDER_PARTNER-PARTN_NUMB = '0000040410'. " 受注先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = 'WE'. " 出荷先「SH」
LST_ORDER_PARTNER-PARTN_NUMB = '0000040410'. " 出荷先
LST_ORDER_PARTNER-ADDR_LINK    = '00002'.
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = 'VE'. " 営業員「PE」
LST_ORDER_PARTNER-PARTN_NUMB = '1297'. " 営業員
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = 'ZJ'. " 最終需要者「ZJ」
LST_ORDER_PARTNER-PARTN_NUMB = '0001965075'." 最終需要者
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = 'ZC'." 最終需要者(商流)「ZC」
LST_ORDER_PARTNER-PARTN_NUMB = '0001965078'." 最終需要者(商流)
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_HEADER_IN-REQ_DATE_H = SY-DATUM.    " 指定納入期日

* 3 明細データ
LST_ITEMS_IN-ITM_NUMBER = '10'.       " 販売伝票明細
LST_ITEMS_IN-MATERIAL   = 'BY05-09S16M'. " 品目コード
*  LST_ITEMS_IN-SHORT_TEXT = LST_ZT203-TXZ01. " 受注明細のテキスト (短)
LST_ITEMS_IN-PLANT      = 'P040'. " プラント
LST_ITEMS_IN-SALES_UNIT = 'BAG'. " 販売単位
LST_ITEMS_IN-TARGET_QTY = 2. " 販売単位による受注数量
*  LST_ITEMS_IN-TARGET_QU  = 'BAG'. " 目標数量 (数量単位)
*  LST_ITEMS_IN-REF_DOC    = LST_ZT203-EBELN. " 参照伝票番号
*  LST_ITEMS_IN-REF_DOC_IT = LST_ZT203-EBELP. " 参照明細番号

APPEND LST_ITEMS_IN TO LTD_ITEMS_IN.
CLEAR LST_ITEMS_IN.

* 5 納入日程行データ
LST_SCHEDULES-ITM_NUMBER = '10'.     " 販売伝票明細
LST_SCHEDULES-SCHED_LINE = '01'.   " 納入日程行
LST_SCHEDULES-REQ_DATE   = SY-DATUM. " 納入日程日付
LST_SCHEDULES-REQ_QTY    = 2. " 販売単位による受注数量

APPEND LST_SCHEDULES TO LTD_SCHEDULES.
CLEAR LST_SCHEDULES.

* 6 条件
LST_CONDITIONS-ITM_NUMBER = '10'.    " 販売伝票明細

LST_CONDITIONS-COND_TYPE  = 'ZPR1'." 条件タイプ
LST_CONDITIONS-COND_VALUE = 2000." 条件レート
LST_CONDITIONS-CURRENCY   = 'JPY'. " 通貨コード
LST_CONDITIONS-COND_UNIT  = 'BAG'. " 条件単位
LST_CONDITIONS-COND_P_UNT = '10'. " 販売単位

APPEND LST_CONDITIONS TO LTD_CONDITIONS.
CLEAR: LST_CONDITIONS.

* テキスト
*  WL_ORDER_TEXT-DOC_NUMBER = .
WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-FORMAT_COL = '01'.
WL_ORDER_TEXT-TEXT_LINE = 'TEST01'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-FORMAT_COL = '02'.
WL_ORDER_TEXT-TEXT_LINE = 'TEST02'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-FORMAT_COL = '03'.
WL_ORDER_TEXT-TEXT_LINE = 'TEST03'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-FORMAT_COL = '04'.
WL_ORDER_TEXT-TEXT_LINE = 'TEST04'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-FORMAT_COL = '05'.
WL_ORDER_TEXT-TEXT_LINE = 'TEST05'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-FORMAT_COL = '06'.
WL_ORDER_TEXT-TEXT_LINE = 'TEST06'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

*  WL_ORDER_TEXT-DOC_NUMBER = .
WL_ORDER_TEXT-ITM_NUMBER = '10'.
WL_ORDER_TEXT-TEXT_ID = '0007'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-TEXT_LINE = 'TEST07'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

* 3 明細データ
LST_ITEMS_IN-ITM_NUMBER = '20'.       " 販売伝票明細
LST_ITEMS_IN-MATERIAL   = 'BY05-09S16M'. " 品目コード
*  LST_ITEMS_IN-SHORT_TEXT = LST_ZT203-TXZ01. " 受注明細のテキスト (短)
LST_ITEMS_IN-PLANT      = 'P040'. " プラント
LST_ITEMS_IN-SALES_UNIT = 'BAG'. " 販売単位
LST_ITEMS_IN-TARGET_QTY = 1. " 販売単位による受注数量
*  LST_ITEMS_IN-TARGET_QU  = 'BAG'. " 目標数量 (数量単位)
*  LST_ITEMS_IN-REF_DOC    = LST_ZT203-EBELN. " 参照伝票番号
*  LST_ITEMS_IN-REF_DOC_IT = LST_ZT203-EBELP. " 参照明細番号

APPEND LST_ITEMS_IN TO LTD_ITEMS_IN.
CLEAR LST_ITEMS_IN.

* 5 納入日程行データ
LST_SCHEDULES-ITM_NUMBER = '20'.     " 販売伝票明細
LST_SCHEDULES-SCHED_LINE = '01'.   " 納入日程行
LST_SCHEDULES-REQ_DATE   = SY-DATUM. " 納入日程日付
LST_SCHEDULES-REQ_QTY    = 1. " 販売単位による受注数量

APPEND LST_SCHEDULES TO LTD_SCHEDULES.
CLEAR LST_SCHEDULES.

* 6 条件
LST_CONDITIONS-ITM_NUMBER = '20'.    " 販売伝票明細

LST_CONDITIONS-COND_TYPE  = 'ZPR1'." 条件タイプ
LST_CONDITIONS-COND_VALUE = 1000." 条件レート
LST_CONDITIONS-CURRENCY   = 'JPY'. " 通貨コード
LST_CONDITIONS-COND_UNIT  = 'BAG'. " 条件単位
LST_CONDITIONS-COND_P_UNT = '10'. " 販売単位

APPEND LST_CONDITIONS TO LTD_CONDITIONS.
CLEAR: LST_CONDITIONS.

* テキスト
*  WL_ORDER_TEXT-DOC_NUMBER = .
WL_ORDER_TEXT-ITM_NUMBER = '20'.
WL_ORDER_TEXT-TEXT_ID = '0001'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-TEXT_LINE = 'TEST012'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.

*  WL_ORDER_TEXT-DOC_NUMBER = .
WL_ORDER_TEXT-ITM_NUMBER = '20'.
WL_ORDER_TEXT-TEXT_ID = '0005'.
WL_ORDER_TEXT-LANGU = SY-LANGU.
WL_ORDER_TEXT-TEXT_LINE = 'TEST052'.
APPEND WL_ORDER_TEXT TO LT_ORDER_TEXT.
CLEAR WL_ORDER_TEXT.




WL_PARTNERADDRESSES-ADDR_NO    = '00002' .
WL_PARTNERADDRESSES-NAME       = '出荷先テスト'.
WL_PARTNERADDRESSES-STREET     = '東京' .
WL_PARTNERADDRESSES-CITY       = '02' .
WL_PARTNERADDRESSES-STR_SUPPL1 = '地名 2' .
WL_PARTNERADDRESSES-STR_SUPPL2 = '地名 3' .
WL_PARTNERADDRESSES-COUNTRY    = 'JP'.
WL_PARTNERADDRESSES-LANGU      = 'JA'.
WL_PARTNERADDRESSES-TEL1_NUMBR = '1110'.
WL_PARTNERADDRESSES-FAX_NUMBER = '1111' .
APPEND WL_PARTNERADDRESSES TO LT_PARTNERADDRESSES.
CLEAR WL_PARTNERADDRESSES.


LST_SWITCH-PRICING = 'G'.
" 価格要素のコピー (変更なし)/税の再決定

* 「W:販売管理伝票カテゴリ」が固定値「C」（受注）の場合

CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
EXPORTING
ORDER_HEADER_IN     = LST_HEADER_IN
TESTRUN             = P_TEST
IMPORTING
SALESDOCUMENT       = LW_VBELN
TABLES
RETURN              = LTD_RETURN
ORDER_ITEMS_IN      = LTD_ITEMS_IN
ORDER_PARTNERS      = LTD_ORDER_PARTNER
ORDER_SCHEDULES_IN  = LTD_SCHEDULES
ORDER_CONDITIONS_IN = LTD_CONDITIONS
ORDER_TEXT          = LT_ORDER_TEXT
PARTNERADDRESSES    = LT_PARTNERADDRESSES.

* BAPIから返した「RETURN」にエラーメッセージ存在する場合
LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = 'E' OR
TYPE = 'A'.

WRITE: /001 LST_RETURN-MESSAGE.
ENDLOOP.

IF SY-SUBRC <> 0.
IF P_TEST IS INITIAL.
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
WAIT = 'X'.
WRITE: /001 '受注が作成しました:',
LW_VBELN.
ELSE.
CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
WRITE: /001 'エラーはありません'.
ENDIF.
ENDIF.

ENDFORM.
