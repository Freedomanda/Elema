*&---------------------------------------------------------------------*
*& プログラムID : ZEGSDR2020
*& 作成者       : iSiD 万
*& 作成日       : 2014/10/27
*& 処理概要     : 1.抽出条件を元に承認待ちの受注データを取得する。
*&                2.受注情報を変更し、一時保存と承認できること。
*&                3.受注自動登録ジョブエラーを最小限にするため、
*&                  承認する際に出来る限りにチェックを行い。
*&                4.リカバリを考慮し、エラーになった受注データを
*&                  一覧に表示し変更再承認できること。
*&                5.エラーデータをリカバリするため、オンライン
*&                  ALVで登録済とエラー一覧を確認する。
*&                6.承認済一覧（受注自動登録未）を確認できること。
*&---------------------------------------------------------------------*
*& 改定履歴
*& No   DATE       MODIFYED BY   SUMMARY
*&
*&---------------------------------------------------------------------*
REPORT  YEGSDR2020 NO STANDARD PAGE HEADING.

*&----------------------------------------------------------------------
* 定数の宣言
*&----------------------------------------------------------------------
CONSTANTS:
CNS_KBUNCC_1(1) TYPE C VALUE '1',           " 受発注連携
CNS_KBUNCC_2(1) TYPE C VALUE '2',           " 受注承認
CNS_KBUNCC_3(1) TYPE C VALUE '3',           " 受注登録
CNS_STATUS_A(1) TYPE C VALUE 'A',           " 処理中
CNS_STATUS_E(1) TYPE C VALUE 'E',           " エラー
CNS_STATUS_C(1) TYPE C VALUE 'C',           " 完了
CNS_STATUS_D(1) TYPE C VALUE 'D',           " 削除
CNS_MSG_E       TYPE SY-MSGTY VALUE 'E',    " 信息#型:E
CNS_MSG_S       TYPE SY-MSGTY VALUE 'S',    " 信息#型:S
CNS_PAR_SH      TYPE PARVW    VALUE 'SH',   " 取引先機能:Sh
CNS_PAR_PE      TYPE PARVW    VALUE 'PE',   " 取引先機能:PE
CNS_TABLENM(10) TYPE C VALUE 'ZTEGSDT203',  " 表名;ZTEGSDT203
CNS_STNM008     TYPE TABNAME VALUE 'ZSEGSD0008',
" 構造名;ZSEGSD0008
CNS_STNM010     TYPE TABNAME VALUE 'ZSEGSD0010',
" 構造名;ZSEGSD0010
CNS_STNM011     TYPE TABNAME VALUE 'ZSEGSD0011',
" 構造名;ZSEGSD0011
CNS_PF_STATUS   TYPE SLIS_FORMNAME VALUE 'SET_STATUS',
" ALVステータス
CNS_USER_CMD    TYPE SLIS_FORMNAME VALUE 'USER_COMMAND',
" ALVユーザの事件
CNS_USER_APP    TYPE SY-UCOMM      VALUE 'APP',
" 承認事件
CNS_USER_MOD    TYPE SY-UCOMM      VALUE 'MODI',
" 変更事件
CNS_USER_DEL    TYPE SY-UCOMM      VALUE 'DEL',
" 削除事件
CNS_USER_BACK   TYPE SY-UCOMM      VALUE 'BACK',
" 返回事件
CNS_USER_EXIT   TYPE SY-UCOMM      VALUE 'EXIT',
" 退出事件
CNS_USER_ENTR   TYPE SY-UCOMM      VALUE 'ENTR',
" ENTR事件
CNS_USER_SAPP   TYPE SY-UCOMM      VALUE 'SAPP',
" SCREEN9000承認事件
CNS_USER_SHOD   TYPE SY-UCOMM      VALUE 'SHOD',
" SCREEN9000保存事件
CNS_USER_SAVE   TYPE SY-UCOMM      VALUE 'SAVE',
" SCREEN9000保存事件

CNS_ROLE_SP     TYPE PARVW         VALUE 'AG',
" 受注先: SP
CNS_ROLE_SH     TYPE PARVW         VALUE 'WE',
" 出荷先: SH
CNS_ROLE_PE     TYPE PARVW         VALUE 'VE',
" 営業員: PE
CNS_ROLE_ZJ     TYPE PARVW         VALUE 'ZJ',
" 最終需要者: ZJ
CNS_ROLE_ZC     TYPE PARVW         VALUE 'ZC',
" 最終需要者(商流): ZC
CNS_LINE_01     TYPE ETENR         VALUE 1, " 納入日程行:0001
CNS_COND_ZPR0   TYPE KSCHA         VALUE 'ZPR0',
" 条件タイプ:ZPR0
CNS_CONTA(7)    TYPE C             VALUE 'ALVCONT',
" SCREEN9000の容器名
CNS_FNM_WAERK   TYPE LVC_FNAME     VALUE 'WAERK',
" 通貨
CNS_FNM_NETWR   TYPE LVC_FNAME     VALUE 'NETWR',
" 受注額
CNS_FNM_TEXT1   TYPE LVC_FNAME     VALUE 'TEXT1',
" 支払条件テキスト
CNS_FNM_ZTERM   TYPE LVC_FNAME     VALUE 'ZTERM',
" 支払条件
CNS_FNM_POSNR   TYPE LVC_FNAME     VALUE 'POSNR',
" 販売伝票明細
CNS_FNM_MATNR   TYPE LVC_FNAME     VALUE 'MATNR',
" 品目コード
CNS_FNM_ARKTX   TYPE LVC_FNAME     VALUE 'ARKTX',
" 受注明細のテキスト (短)
CNS_FNM_KWMENG  TYPE LVC_FNAME     VALUE 'KWMENG',
" 累積受注数量
CNS_FNM_VRKME   TYPE LVC_FNAME     VALUE 'VRKME',
" 販売単位
CNS_FNM_NETPR   TYPE LVC_FNAME     VALUE 'NETPR',
" 正味価格
CNS_FNM_KPEIN   TYPE LVC_FNAME     VALUE 'KPEIN',
" 価格条件単位
CNS_FNM_ZVRKME  TYPE LVC_FNAME     VALUE 'ZVRKME',
" 販売単位
CNS_FNM_WERKS  TYPE LVC_FNAME      VALUE 'WERKS',
" プラント
CNS_FNM_EDATU  TYPE LVC_FNAME      VALUE 'EDATU'.
" 納入日程日付
*&----------------------------------------------------------------------
* 型定義
*&----------------------------------------------------------------------
TYPES:
* 販売エリア構造
BEGIN OF TYP_TVTA,
VKORG TYPE TVTA-VKORG,                    " 販売組織
VTWEG TYPE TVTA-VTWEG,                    " 流通チャネル
SPART TYPE TVTA-SPART,                    " 製品部門
END OF TYP_TVTA,

* 承認一覧構造
BEGIN OF TYP_ZTEGSDT203,
VKORG     TYPE ZTEGSDT203-VKORG,          " 販売組織
VTWEG     TYPE ZTEGSDT203-VTWEG,          " 流通チャネル
SPART     TYPE ZTEGSDT203-SPART,          " 製品部門
VKBUR     TYPE ZTEGSDT203-VKBUR,          " 営業所
VKGRP     TYPE ZTEGSDT203-VKGRP,          " 営業グループ
KUNNR     TYPE ZTEGSDT203-KUNNR,          " 受注先
NAME1     TYPE KNA1-NAME1,                " 名称1
MATNR     TYPE ZTEGSDT203-MATNR,          " 品目コード
TXZ01     TYPE ZTEGSDT203-TXZ01,          " テキスト (短)
MENGE     TYPE ZTEGSDT203-MENGE,          " 購買発注量
MEINS     TYPE ZTEGSDT203-MEINS,          " 発注単位
NETPR     TYPE ZTEGSDT203-NETPR,          " 正味価格
WAERS     TYPE ZTEGSDT203-WAERS,          " 通貨コード
PEINH     TYPE ZTEGSDT203-PEINH,          " 価格単位
BPRME     TYPE ZTEGSDT203-BPRME,          " 購買発注価格単位
NETWR     TYPE ZTEGSDT203-NETWR,          " 正味発注額
DWERK     TYPE ZTEGSDT203-DWERK,          " 出荷プラント
ZKUNNR_S  TYPE ZTEGSDT203-ZKUNNR_S,       " 出荷先
ZNAME1    TYPE KNA1-NAME1,                " 出荷先名称
EINDT     TYPE ZTEGSDT203-EINDT,          " 明細納入期日
ZTERM     TYPE ZTEGSDT203-ZTERM,          " 支払条件キー
EBELN     TYPE ZTEGSDT203-EBELN,          " 購買伝票番号
AEDAT     TYPE ZTEGSDT203-AEDAT,          " レコード登録日
MSGTX     TYPE ZTEGSDT203-MSGTX,          " メッセージテキスト
PERNR     TYPE ZTEGSDT203-PERNR,          " 営業員
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,      " 最終需要者
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS,      " 最終需要者(商流)
EBELP     TYPE ZTEGSDT203-EBELP,          " 購買伝票の明細番号
KNTTP     TYPE ZTEGSDT203-KNTTP,          " 勘定設定カテゴリ
BSART     TYPE ZTEGSDT203-BSART,          " 購買伝票タイプ
ENAME     TYPE PA0001-ENAME,              " 応募者氏名
END OF TYP_ZTEGSDT203,

* HR マスタレコード構造
BEGIN OF TYP_PA0001,
PERNR TYPE PA0001-PERNR,                  " 営業員
ENAME TYPE PA0001-ENAME,                  " 応募者氏名
END OF TYP_PA0001,

* 得意先マスタ構造
BEGIN OF TYP_KNVP,
KUNNR TYPE KNVP-KUNNR,                    " 得意先コード
VKORG TYPE KNVP-VKORG,                    " 販売組織
VTWEG TYPE KNVP-VTWEG,                    " 流通チャネル
SPART TYPE KNVP-SPART,                    " 製品部門
KUNN2 TYPE KNVP-KUNN2,                    " 取引先の得意先コード
NAME1 TYPE KNA1-NAME1,                    " 名称1
END OF TYP_KNVP,

* 最終需要者の情報構造
BEGIN OF TYP_ZTEGSDT204,
MATNR     TYPE ZTEGSDT204-MATNR,          " 品目コード
VKORG     TYPE TVKO-VKORG,                " 販売組織
ZKUNNR_ZJ TYPE ZTEGSDT204-ZKUNNR_ZJ,      " 最終需要者
ZKUNNR_DS TYPE ZTEGSDT204-ZKUNNR_DS,      " 最終需要者(商流)
END OF TYP_ZTEGSDT204,

* 営業員情報構造
BEGIN OF TYP_ENAME,
KUNNR     TYPE KNVP-KUNNR,                " 得意先コード
VKORG     TYPE KNVP-VKORG,                " 販売組織
VTWEG     TYPE KNVP-VTWEG,                " 流通チャネル
SPART     TYPE KNVP-SPART,                " 製品部門
KUNN2     TYPE KNVP-KUNN2,                " 取引先の得意先コード
ENAME     TYPE PA0001-ENAME,              " 従業員氏名
END OF TYP_ENAME,

* 出荷プラントの情報構造
BEGIN OF TYP_KNVV,
KUNNR     TYPE KNVV-KUNNR,                " 得意先コード
VKORG     TYPE KNVV-VKORG,                " 販売組織
VTWEG     TYPE KNVV-VTWEG,                " 流通チャネル
SPART     TYPE KNVV-SPART,                " 製品部門
VWERK     TYPE KNVV-VWERK,                " 出荷プラント
END OF TYP_KNVV,

* 承認一覧構造
BEGIN OF TYP_APP_ALVDATA.
TYPES:EBELP     TYPE ZTEGSDT203-EBELP,
KNTTP     TYPE ZTEGSDT203-KNTTP,
BSART     TYPE ZTEGSDT203-BSART,
PERNR     TYPE ZTEGSDT203-PERNR,
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS.
INCLUDE TYPE ZSEGSD0008.
TYPES:CHK(1)    TYPE C,
END OF TYP_APP_ALVDATA,

* エラー一覧構造
BEGIN OF TYP_ERR_ALVDATA.
TYPES:EBELP     TYPE ZTEGSDT203-EBELP,
KNTTP     TYPE ZTEGSDT203-KNTTP,
BSART     TYPE ZTEGSDT203-BSART,
PERNR     TYPE ZTEGSDT203-PERNR,
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS.
INCLUDE TYPE ZSEGSD0011.
TYPES:CHK(1)    TYPE C,
END OF TYP_ERR_ALVDATA,

* 処理対象データTEMP構造
BEGIN OF TYP_TEM_ALVDATA,
BSTKD     TYPE ZSEGSD0011-BSTKD,          " 得意先発注番号
EBELP     TYPE ZTEGSDT203-EBELP,          " 購買伝票の明細番号
VKORG     TYPE ZSEGSD0011-VKORG,          " 販売組織
VTWEG     TYPE ZSEGSD0011-VTWEG,          " 流通チャネル
SPART     TYPE ZSEGSD0011-SPART,          " 製品部門
VKBUR     TYPE ZSEGSD0011-VKBUR,          " 営業所
VKGRP     TYPE ZSEGSD0011-VKGRP,          " 営業グループ
KUNNR     TYPE ZSEGSD0011-KUNNR,          " 得意先コード
NAME1     TYPE ZSEGSD0011-NAME1,          " 名称 1
MATNR     TYPE ZSEGSD0011-MATNR,          " 品目コード
ARKTX     TYPE ZSEGSD0011-ARKTX,          " 受注明細のテキスト (短)
KWMENG    TYPE ZSEGSD0011-KWMENG,         " 累積受注数量 (販売単位)
VRKME     TYPE ZSEGSD0011-VRKME,          " 販売単位
NETPR     TYPE ZSEGSD0011-NETPR,          " 正味価格
WAERK     TYPE ZSEGSD0011-WAERK,          " 販売伝票通貨
KPEIN     TYPE ZSEGSD0011-KPEIN,          " 価格条件単位
ZVRKME    TYPE ZSEGSD0011-ZVRKME,         " 販売単位
NETWR     TYPE ZSEGSD0011-NETWR,          " 正味価格
WERKS     TYPE ZSEGSD0011-WERKS,          " プラント(自社または外部)
ZEKUNNR   TYPE ZSEGSD0011-ZEKUNNR,        " 出荷先
ZEKNAME   TYPE ZSEGSD0011-ZEKNAME,        " 出荷先名称
EDATU     TYPE ZSEGSD0011-EDATU,          " 納入日程日付
ZEEMNAM   TYPE ZSEGSD0011-ZEEMNAM,        " 従業員名称
DZTERM    TYPE ZSEGSD0011-DZTERM,         " 支払条件キー
BSTDK     TYPE ZSEGSD0011-BSTDK,          " 得意先発注日付
MSGTX     TYPE ZSEGSD0011-MSGTX,          " メッセージテキスト
BSART     TYPE ZTEGSDT203-BSART,          " 購買伝票タイプ
KNTTP     TYPE ZTEGSDT203-KNTTP,          " 勘定設定カテゴリ
PERNR     TYPE ZTEGSDT203-PERNR,          " 営業員
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,      " 最終需要者
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS,      " 最終需要者(商流)
END OF TYP_TEM_ALVDATA,

* 販売伝票タイプ構造
BEGIN OF TYP_DATA_205,
BSART TYPE ZTEGSDT205-BSART,              " 購買伝票タイプ
KNTTP TYPE ZTEGSDT205-KNTTP,              " 勘定設定カテゴリ
AUART TYPE ZTEGSDT205-AUART,              " 販売伝票タイプ
AUGRU TYPE ZTEGSDT205-AUGRU,              " 受注理由
BEZEI TYPE TVAKT-BEZEI,                   " 販売伝票タイプテキスト
END OF TYP_DATA_205,

BEGIN OF TYP_TVAKT,
AUART TYPE TVAKT-AUART,                   " 販売伝票タイプ
BEZEI TYPE TVAKT-BEZEI,                   " 販売伝票タイプテキスト
END OF TYP_TVAKT,

BEGIN OF TYP_ZSEGSD0009.
INCLUDE TYPE ZSEGSD0009.
TYPES:KNTTP     TYPE ZTEGSDT203-KNTTP,
BSART     TYPE ZTEGSDT203-BSART,
END OF TYP_ZSEGSD0009,

BEGIN OF TYP_ZTERM,
ZTERM TYPE T052U-ZTERM,                   " 支払条件キー
TEXT1 TYPE T052U-TEXT1,                   " 支払条件の固有テキスト
END OF TYP_ZTERM,
* テーブル参照
TYP_TD_TVTA       TYPE STANDARD TABLE OF TYP_TVTA,
TYP_TD_ZTEGSDT203 TYPE STANDARD TABLE OF TYP_ZTEGSDT203,
TYP_TD_APPALVDATA TYPE STANDARD TABLE OF TYP_APP_ALVDATA,
TYP_TD_ERRALVDATA TYPE STANDARD TABLE OF TYP_ERR_ALVDATA,
TYP_TD_ALVDATA    TYPE STANDARD TABLE OF TYP_TEM_ALVDATA,
TYP_TD_205        TYPE STANDARD TABLE OF TYP_DATA_205,
TYP_TD_ITEM       TYPE STANDARD TABLE OF ZSEGSD0010.

*&----------------------------------------------------------------------
* 変数の定義
*&----------------------------------------------------------------------
DATA:
W_SYST_DATE    TYPE SY-DATUM,               " システム日付
W_SYST_TIME    TYPE SY-UZEIT,               " システム時刻
OK_CODE        TYPE SY-UCOMM.               " Dynproのオーケーコード
DATA V_FLG TYPE C.
* 選択画面定義用変数
DATA:
W_VTWEG    TYPE VBAK-VTWEG,                 " 流通チャネル
W_SPART    TYPE VBAK-SPART,                 " 製品部門
W_VKBUR    TYPE VBAK-VKBUR,                 " 営業所
W_VKGRP    TYPE VBAK-VKGRP,                 " 営業グループ
W_ZECREYMD TYPE ZECREYMD,                   " 登録日付
W_CHANGED  TYPE C.

* SCREEN9000ヘッダ部
DATA:
ST_ZSEGSD0009     TYPE TYP_ZSEGSD0009,
ST_ZSEGSD0009_INI TYPE TYP_ZSEGSD0009.
*&----------------------------------------------------------------------
* 作業領域定義
*&----------------------------------------------------------------------

*&----------------------------------------------------------------------
* 内部テーブル定義
*&----------------------------------------------------------------------
DATA:
TD_TVTA         TYPE STANDARD TABLE OF TYP_TVTA,
TD_APP_ALV      TYPE TYP_TD_APPALVDATA,
TD_ERR_ALV      TYPE TYP_TD_ERRALVDATA,
TD_ITEM_ALV     TYPE TYP_TD_ITEM,
TD_ITEM_ALV_INI TYPE TYP_TD_ITEM.

* レンジテーブル
DATA:
RD_VTWEG TYPE RANGE OF TVTW-VTWEG,          " 流通チャネル
RD_SPART TYPE RANGE OF TSPA-SPART,          " 製品部門
RD_VKBUR TYPE RANGE OF TVBUR-VKBUR,         " 営業所
RD_VKGRP TYPE RANGE OF TVKGR-VKGRP.         " 営業グループ

*&----------------------------------------------------------------------
* クラスインタフェース
*&----------------------------------------------------------------------
DATA:
CI_ALV                 TYPE REF TO CL_GUI_ALV_GRID,
CI_CCONTAINER          TYPE REF TO CL_GUI_CUSTOM_CONTAINER.

*&----------------------------------------------------------------------
* クラス定義
*&----------------------------------------------------------------------
CLASS:
CL_EVENT_RECEIVER DEFINITION DEFERRED.

*&----------------------------------------------------------------------
* 選択画面定義(1000)
*&----------------------------------------------------------------------
PARAMETERS:
P_VKORG    TYPE VBAK-VKORG MODIF ID VKO OBLIGATORY.
" 販売組織
SELECT-OPTIONS:
S_VTWEG    FOR  W_VTWEG MODIF ID VTW,       " 流通チャネル
S_SPART    FOR  W_SPART MODIF ID SPA,       " 製品部門
S_VKBUR    FOR  W_VKBUR MODIF ID VKB,       " 営業所
S_VKGRP    FOR  W_VKGRP,                    " 営業グループ
S_DATE     FOR  W_ZECREYMD.                 " 登録日付

PARAMETERS:
RB_APP   RADIOBUTTON GROUP RB1 DEFAULT 'X', " 承認一覧
RB_ERR   RADIOBUTTON GROUP RB1.             " リカバリ一覧
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS:
RB_LIST  RADIOBUTTON GROUP RB1.        " 承認済一覧（販売伝票未作成）
SELECTION-SCREEN COMMENT 2(48) TEXT-P01 FOR FIELD RB_LIST.
SELECTION-SCREEN END OF LINE.

*----------------------------------------------------------------------*
* AT SELETION-SCREEN
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
* A-1-1．入力チェック
PERFORM CHECK_INPUT.
* A-1-2．整合性チェック
* A-1-2-1．販売エリアの整合性チェック
PERFORM CHECK_TVTA CHANGING TD_TVTA.
* A-1-3．権限チェック
PERFORM CHECK_TVTA_AUTH CHANGING TD_TVTA.

*----------------------------------------------------------------------*
* START-OF-SELECTION
*----------------------------------------------------------------------*
START-OF-SELECTION.

W_SYST_DATE = SY-DATUM.                     "システム日付
W_SYST_TIME = SY-UZEIT.                     "システム時刻

* 主処理
PERFORM MAIN_PROCESS USING W_SYST_DATE.

*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       A-1-1．入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT .

* A-1-1-1．販売組織(Sales Organization)存在チェック
PERFORM CHECK_VKORG.

* A-1-1-2．流通チャネル(Distribution Channel)存在チェック
PERFORM CHECK_VTWEG.

* A-1-1-3． 販売部門(Division)存在チェック
PERFORM CHECK_SPART.

* A-1-1-4．営業所(Sales Office)存在チェック
PERFORM CHECK_VKBUR.

* A-1-1-5．営業グループ(Sales Group)存在チェック
PERFORM CHECK_VKGRP.

ENDFORM.                    " CHECK_INPUT

*&---------------------------------------------------------------------*
*&      Form  CHECK_VKORG
*&---------------------------------------------------------------------*
*       A-1-1-1．販売組織(Sales Organization)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKORG .

SELECT COUNT(*)
FROM TVKO
WHERE VKORG = P_VKORG.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_VKORG'.
MESSAGE E039(ZMEGSD01) WITH P_VKORG.
*   #售##( &1 )不存在
ENDIF.

ENDFORM.                    " CHECK_VKORG

*&---------------------------------------------------------------------*
*&      Form  CHECK_VTWEG
*&---------------------------------------------------------------------*
*       A-1-1-2．流通チャネル(Distribution Channel)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VTWEG .

TYPES: BEGIN OF LTYP_VTWEG,
VTWEG TYPE TVTW-VTWEG,
END OF LTYP_VTWEG.

DATA: LTD_VTWEG   TYPE STANDARD TABLE OF LTYP_VTWEG,
LST_VTWEG   TYPE LTYP_VTWEG,
LST_VTWEG_R LIKE LINE OF RD_VTWEG.

SELECT VTWEG
INTO TABLE LTD_VTWEG
FROM TVTW
WHERE VTWEG IN S_VTWEG.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VTWEG-LOW'.
MESSAGE E040(ZMEGSD01) WITH S_VTWEG-LOW.
*   流通チャネル&1は存在しません
ENDIF.

REFRESH RD_VTWEG.
LOOP AT LTD_VTWEG INTO LST_VTWEG.
LST_VTWEG_R-SIGN = 'I'.
LST_VTWEG_R-OPTION = 'EQ'.
LST_VTWEG_R-LOW = LST_VTWEG-VTWEG.
APPEND LST_VTWEG_R TO RD_VTWEG.
CLEAR LST_VTWEG_R.
ENDLOOP.

ENDFORM.                    " CHECK_VTWEG

*&---------------------------------------------------------------------*
*&      Form  CHECK_SPART
*&---------------------------------------------------------------------*
*       A-1-1-3． 販売部門(Division)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_SPART .

TYPES: BEGIN OF LTYP_SPART,
SPART TYPE TSPA-SPART,
END OF LTYP_SPART.

DATA: LTD_SPART   TYPE STANDARD TABLE OF LTYP_SPART,
LST_SPART   TYPE LTYP_SPART,
LST_SPART_R LIKE LINE OF RD_SPART.

SELECT SPART
INTO TABLE LTD_SPART
FROM TSPA
WHERE SPART IN S_SPART.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_SPART-LOW'.
MESSAGE E041(ZMEGSD01) WITH S_SPART-LOW.
*   製品部門&1は存在しません
ENDIF.

REFRESH RD_SPART.
LOOP AT LTD_SPART INTO LST_SPART.
LST_SPART_R-SIGN = 'I'.
LST_SPART_R-OPTION = 'EQ'.
LST_SPART_R-LOW = LST_SPART-SPART.
APPEND LST_SPART_R TO RD_SPART.
CLEAR LST_SPART_R.
ENDLOOP.

ENDFORM.                    " CHECK_SPART

*&---------------------------------------------------------------------*
*&      Form  CHECK_VKBUR
*&---------------------------------------------------------------------*
*       A-1-1-4．営業所(Sales Office)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKBUR .

TYPES: BEGIN OF LTYP_VKBUR,
VKBUR TYPE TVBUR-VKBUR,
END OF LTYP_VKBUR.

DATA: LTD_VKBUR   TYPE STANDARD TABLE OF LTYP_VKBUR,
LST_VKBUR   TYPE LTYP_VKBUR,
LST_VKBUR_R LIKE LINE OF RD_VKBUR.

SELECT VKBUR
INTO TABLE LTD_VKBUR
FROM TVBUR
WHERE VKBUR IN S_VKBUR.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKBUR-LOW'.
MESSAGE E042(ZMEGSD01) WITH S_VKBUR-LOW.
*   営業所&1は存在しません
ENDIF.

REFRESH RD_VKBUR.
LOOP AT LTD_VKBUR INTO LST_VKBUR.
LST_VKBUR_R-SIGN = 'I'.
LST_VKBUR_R-OPTION = 'EQ'.
LST_VKBUR_R-LOW = LST_VKBUR-VKBUR.
APPEND LST_VKBUR_R TO RD_VKBUR.
CLEAR LST_VKBUR_R.
ENDLOOP.

ENDFORM.                    " CHECK_VKBUR

*&---------------------------------------------------------------------*
*&      Form  CHECK_VKGRP
*&---------------------------------------------------------------------*
*       A-1-1-5．営業グループ(Sales Group)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKGRP .

TYPES: BEGIN OF LTYP_VKGRP,
VKGRP TYPE TVKGR-VKGRP,
END OF LTYP_VKGRP.

DATA: LTD_VKGRP   TYPE STANDARD TABLE OF LTYP_VKGRP,
LST_VKGRP   TYPE LTYP_VKGRP,
LST_VKGRP_R LIKE LINE OF RD_VKGRP.

SELECT VKGRP
INTO TABLE LTD_VKGRP
FROM TVKGR
WHERE VKGRP IN S_VKGRP.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKGRP-LOW'.
MESSAGE E043(ZMEGSD01) WITH S_VKGRP-LOW.
*   営業グループ&1は存在しません
ENDIF.

REFRESH RD_VKGRP.
LOOP AT LTD_VKGRP INTO LST_VKGRP.
LST_VKGRP_R-SIGN = 'I'.
LST_VKGRP_R-OPTION = 'EQ'.
LST_VKGRP_R-LOW = LST_VKGRP-VKGRP.
APPEND LST_VKGRP_R TO RD_VKGRP.
CLEAR LST_VKGRP_R.
ENDLOOP.

ENDFORM.                    " CHECK_VKGRP

*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA
*&---------------------------------------------------------------------*
*       A-1-2-1．販売エリアの整合性チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.


SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
INTO TABLE O_TD_TVTA
FROM TVTA
WHERE VKORG =  P_VKORG                     " 販売組織
AND VTWEG IN S_VTWEG                     " 流通チャネル
AND SPART IN S_SPART.                    " 製品部門

IF SY-SUBRC <> 0.
MESSAGE E044(ZMEGSD01).
*   指定された販売エリアの整合性がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA

*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA_AUTH
*&---------------------------------------------------------------------*
*       A-1-3．権限チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA_AUTH CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.

DATA:
LST_TVTA  TYPE TYP_TVTA,
LW_ERR(1) TYPE C.

LOOP AT O_TD_TVTA INTO LST_TVTA.
AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
ID 'VKORG' FIELD LST_TVTA-VKORG
ID 'VTWEG' FIELD LST_TVTA-VTWEG
ID 'SPART' FIELD LST_TVTA-SPART
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.
LW_ERR = ABAP_ON.
DELETE O_TD_TVTA.
ENDIF.
ENDLOOP.
IF LW_ERR IS NOT INITIAL
AND O_TD_TVTA IS INITIAL.
MESSAGE E038(ZMEGSD01).
*   販売エリアに対する実行権限がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA

*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*----------------------------------------------------------------------*
FORM MAIN_PROCESS USING I_W_DATE    TYPE SY-DATUM.

DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203.

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
*     A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203.
*     A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.
*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
*     A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203.
*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.
*     A-2-3-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN1 USING I_W_DATE
TD_TVTA
CHANGING LTD_ZTEGSDT203.
WHEN OTHERS.
ENDCASE.

* A-3．画面出力
PERFORM ALV_OUTPUT USING LTD_ZTEGSDT203.

ENDFORM.                    " MAIN_PROCESS

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN
*&---------------------------------------------------------------------*
*       以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*      -->I_KBUNCC_F       処理区分1
*      -->I_STATUS_F       ステータス1
*      -->I_KBUNCC_S       処理区分2
*      -->I_STATUS_S       ステータス2
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN  USING I_W_DATE       TYPE SY-DATUM
I_KBUNCC_F     TYPE C
I_STATUS_F     TYPE C
I_KBUNCC_S     TYPE C
I_STATUS_S     TYPE C
I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
ZTEGSDT203~MATNR                     " 品目コード
ZTEGSDT203~TXZ01                     " テキスト (短)
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1                         " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~PERNR                     " 営業員
ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
INTO TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG
" 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART
" 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ( ( ZTEGSDT203~ZKBUNCC    = I_KBUNCC_F
" 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_F )
" ステータス
OR ( ZTEGSDT203~ZKBUNCC  = I_KBUNCC_S
" 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_S ) ).
" ステータス
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.
ELSE.
LTD_SDT203 = O_TD_SDT203.
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= I_W_DATE                  " 開始日付
AND ENDDA >= I_W_DATE.                 " 終了日付

IF SY-SUBRC = 0.
SORT LTD_PA0001 BY PERNR ASCENDING.     " 営業員
ENDIF.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.
<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.
" 応募者氏名
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN

*&---------------------------------------------------------------------*
*&      Form  EDIT_DATA_MAIN
*&---------------------------------------------------------------------*
*       A-2-1-2．承認一覧の関連情報を取得
*----------------------------------------------------------------------*
*      -->I_KBUNCC_F     処理区分1
*      -->I_STATUS_F     ステータス1
*      -->I_KBUNCC_S     処理区分2
*      -->I_STATUS_S     ステータス2
*      -->I_TD_TVTA      ITAB:販売エリア
*      <--O_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM EDIT_DATA_MAIN CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.

DATA:
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LTD_KNVP   TYPE STANDARD TABLE OF TYP_KNVP,
LST_KNVP   TYPE TYP_KNVP,
LTD_SDT204 TYPE STANDARD TABLE OF TYP_ZTEGSDT204,
LST_SDT204 TYPE TYP_ZTEGSDT204,
LTD_ENAME  TYPE STANDARD TABLE OF TYP_ENAME,
LST_ENAME  TYPE TYP_ENAME,
LTD_KNVV   TYPE STANDARD TABLE OF TYP_KNVV,
LST_KNVV   TYPE TYP_KNVV.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.

*   A-2-1-2-1．出荷先の情報の検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門
DELETE LTD_SDT203
WHERE ZKUNNR_S IS NOT INITIAL.         " Ship-to

IF LTD_SDT203 IS NOT INITIAL.
SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~KUNN2                     " 取引先の得意先コード
KNA1~NAME1                     " 名称1
FROM KNVP
INNER JOIN KNA1
ON KNVP~KUNN2 = KNA1~KUNNR        " 取引先の得意先コード
INTO TABLE LTD_KNVP                 " ITAB:得意先マスタ
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = CNS_PAR_SH.       " 取引先機能
IF SY-SUBRC = 0.
SORT LTD_KNVP BY KUNNR ASCENDING  " 得意先コード
VKORG ASCENDING  " 販売組織
VTWEG ASCENDING  " 流通チャネル
SPART ASCENDING. " 製品部門
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-2．最終需要者の情報を検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.
SORT LTD_SDT203 BY MATNR ASCENDING      " 品目コード
VKORG ASCENDING.     " 販売組織
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING MATNR   " 品目コード
VKORG.  " 販売組織
DELETE LTD_SDT203 WHERE ZKUNNR_ZJ IS NOT INITIAL.
IF LTD_SDT203 IS NOT INITIAL.
SELECT ZTEGSDT204~MATNR               " 品目コード
TVKO~VKORG                     " 販売組織
ZTEGSDT204~ZKUNNR_ZJ           " 最終需要者
ZTEGSDT204~ZKUNNR_DS           " 最終需要者(商流)
FROM ZTEGSDT204
INNER JOIN TVKO
ON ZTEGSDT204~BUKRS = TVKO~BUKRS
INTO TABLE LTD_SDT204
FOR ALL ENTRIES IN LTD_SDT203
WHERE ZTEGSDT204~MATNR = LTD_SDT203-MATNR
" 品目コード
AND TVKO~VKORG       = LTD_SDT203-VKORG.
" 販売組織
IF SY-SUBRC = 0.
SORT LTD_SDT204 BY MATNR ASCENDING  " 品目コード
VKORG ASCENDING. " 販売組織
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-3．営業員情報の検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門
DELETE LTD_SDT203
WHERE ENAME IS NOT INITIAL.            " 応募者氏名

IF LTD_SDT203 IS NOT INITIAL.
SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~KUNN2                     " 取引先の得意先コード
PA0001~ENAME                   " 従業員氏名
FROM KNVP
INNER JOIN PA0001
ON KNVP~KUNN2 = PA0001~PERNR      " 取引先の得意先コード
INTO TABLE LTD_ENAME
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = CNS_PAR_PE.       " 取引先機能
IF SY-SUBRC = 0.
SORT LTD_ENAME BY KUNNR ASCENDING   " 得意先コード
VKORG ASCENDING   " 販売組織
VTWEG ASCENDING   " 流通チャネル
SPART ASCENDING.  " 製品部門
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-4．出荷プラントの情報を検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門
DELETE LTD_SDT203
WHERE DWERK IS NOT INITIAL.            " 出荷プラント

IF LTD_SDT203 IS NOT INITIAL.
SELECT KUNNR                          " 得意先コード
VKORG                          " 販売組織
VTWEG                          " 流通チャネル
SPART                          " 製品部門
VWERK                          " 出荷プラント
FROM KNVV
INTO TABLE LTD_KNVV
FOR ALL ENTRIES IN LTD_SDT203
WHERE KUNNR = LTD_SDT203-KUNNR       " 得意先コード
AND VKORG = LTD_SDT203-VKORG       " 販売組織
AND VTWEG = LTD_SDT203-VTWEG       " 流通チャネル
AND SPART = LTD_SDT203-SPART.      " 製品部門
IF SY-SUBRC = 0.
SORT LTD_KNVV BY KUNNR ASCENDING    " 得意先コード
VKORG ASCENDING    " 販売組織
VTWEG ASCENDING    " 流通チャネル
SPART ASCENDING.   " 製品部門
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-5．出荷先の情報を取得する。
IF <LFS_ST_SDT203>-ZKUNNR_S IS INITIAL.
CLEAR LST_KNVP.
READ TABLE LTD_KNVP INTO LST_KNVP
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
<LFS_ST_SDT203>-ZKUNNR_S = LST_KNVP-KUNN2.
" 出荷先
<LFS_ST_SDT203>-ZNAME1   = LST_KNVP-NAME1.
" 出荷先名称
ENDIF.

*   A-2-1-2‐6．最終需要者の情報を取得する。
IF <LFS_ST_SDT203>-ZKUNNR_ZJ IS INITIAL.
CLEAR LST_SDT204.
READ TABLE LTD_SDT204 INTO LST_SDT204
WITH KEY MATNR = <LFS_ST_SDT203>-MATNR
VKORG = <LFS_ST_SDT203>-VKORG
BINARY SEARCH.
<LFS_ST_SDT203>-ZKUNNR_ZJ = LST_SDT204-ZKUNNR_ZJ.
" 最終需要者
<LFS_ST_SDT203>-ZKUNNR_DS = LST_SDT204-ZKUNNR_DS.
" 最終需要者(商流)
ENDIF.

*   A-2-1-2-7．営業員の情報を取得する。
IF <LFS_ST_SDT203>-ENAME IS INITIAL.
CLEAR LST_ENAME.
READ TABLE LTD_ENAME INTO LST_ENAME
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
<LFS_ST_SDT203>-PERNR = LST_ENAME-KUNN2.
" 取引先の得意先コード
<LFS_ST_SDT203>-ENAME = LST_ENAME-ENAME.
" 従業員氏名
ENDIF.

*   A-2-1-2-8．出荷プラントの情報を検索
IF <LFS_ST_SDT203>-DWERK IS INITIAL.
CLEAR LST_KNVV.
READ TABLE LTD_KNVV INTO LST_KNVV
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
<LFS_ST_SDT203>-DWERK = LST_KNVV-VWERK.
ENDIF.

ENDLOOP.

ENDFORM.                    " EDIT_DATA_MAIN

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN1
*&---------------------------------------------------------------------*
*       A-2-3-1．以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN1  USING I_W_DATE       TYPE SY-DATUM
I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.

DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
ZTEGSDT203~MATNR                     " 品目コード
ZTEGSDT203~TXZ01                     " テキスト (短)
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1                         " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~PERNR                     " 営業員
ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
INTO TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG
" 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART
" 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ZTEGSDT203~ZKBUNCC   = CNS_KBUNCC_2  " 処理区分
AND ZTEGSDT203~STATUS    = CNS_STATUS_C. " ステータス
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.
ELSE.
LTD_SDT203 = O_TD_SDT203.
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= I_W_DATE                  " 開始日付
AND ENDDA >= I_W_DATE.                 " 終了日付

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.
<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.
" 応募者氏名
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN

*&---------------------------------------------------------------------*
*&      Form  ALV_OUTPUT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM ALV_OUTPUT  USING I_TD_SDT203      TYPE TYP_TD_ZTEGSDT203.

DATA:
LTD_FIELDCAT   TYPE LVC_T_FCAT,
LST_LAYOUT     TYPE LVC_S_LAYO.

* 項目カタログの編集
PERFORM EDIT_FIELDCAT USING CNS_STNM008
CNS_STNM011
CHANGING LTD_FIELDCAT.

* レイアウト構造の編集
PERFORM EDIT_LAYOUT CHANGING LST_LAYOUT.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING I_TD_SDT203.

* ALV一覧形式で出力する
IF RB_ERR IS INITIAL.
CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
TABLES
T_OUTTAB                 = TD_APP_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.

LEAVE LIST-PROCESSING.
ENDIF.
ELSE.
CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
TABLES
T_OUTTAB                 = TD_ERR_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.

LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

ENDFORM.                    " ALV_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_W_STRNM08    構造名
*      -->I_W_STRNM11    構造名
*      <--O_TD_SDT203    ITAB:項目カタログ
*----------------------------------------------------------------------*
FORM EDIT_FIELDCAT USING I_W_STRNM08     TYPE TABNAME
I_W_STRNM11     TYPE TABNAME
CHANGING O_TD_FIELDCAT   TYPE LVC_T_FCAT.

* A-3-1．データのALV一覧出力
DATA:
LST_FIELDCAT TYPE LVC_S_FCAT.

CLEAR O_TD_FIELDCAT.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME             = I_W_STRNM08
CHANGING
CT_FIELDCAT                  = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE       = 1
PROGRAM_ERROR                = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
LEAVE LIST-PROCESSING.
ENDIF.
LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.
*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME             = I_W_STRNM11
CHANGING
CT_FIELDCAT                  = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE       = 1
PROGRAM_ERROR                = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
LEAVE LIST-PROCESSING.
ENDIF.
LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.
*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME             = I_W_STRNM08
CHANGING
CT_FIELDCAT                  = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE       = 1
PROGRAM_ERROR                = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
LEAVE LIST-PROCESSING.
ENDIF.
WHEN OTHERS.
*     処理ない
ENDCASE.

ENDFORM.                    " EDIT_FIELDCAT

*&---------------------------------------------------------------------*
*&      Form  EDIT_LAYOUT
*&---------------------------------------------------------------------*
*       レイアウト構造の編集
*----------------------------------------------------------------------*
*      <--O_W_LAYOUT     レイアウト
*----------------------------------------------------------------------*
FORM EDIT_LAYOUT CHANGING O_ST_LAYOUT   TYPE LVC_S_LAYO.

O_ST_LAYOUT-CWIDTH_OPT = ABAP_ON.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.
O_ST_LAYOUT-BOX_FNAME = 'CHK'.
*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.
O_ST_LAYOUT-BOX_FNAME = 'CHK'.
*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
*     処理なし
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " EDIT_LAYOUT

*&---------------------------------------------------------------------*
*&      Form  EDIT_ALVDATA
*&---------------------------------------------------------------------*
*       ALV出力データの編集
*----------------------------------------------------------------------*
*      -->I_TD_SDT203      構造名
*      <--O_TD_APP_ALV    ITAB:承認済受注未登録一覧
*      <--O_TD_ERR_ALV    ITAB:エラー一覧
*----------------------------------------------------------------------*
FORM EDIT_ALVDATA USING I_TD_SDT203  TYPE TYP_TD_ZTEGSDT203.

DATA:
LST_SDT203      TYPE TYP_ZTEGSDT203,
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

REFRESH:
TD_APP_ALV,
TD_ERR_ALV.

LOOP AT I_TD_SDT203 INTO LST_SDT203.
LST_APP_ALVDATA-VKORG   = LST_SDT203-VKORG." 販売組織
LST_APP_ALVDATA-VTWEG   = LST_SDT203-VTWEG." 流通チャネル
LST_APP_ALVDATA-SPART   = LST_SDT203-SPART." 製品部門
LST_APP_ALVDATA-VKBUR   = LST_SDT203-VKBUR." 営業所
LST_APP_ALVDATA-VKGRP   = LST_SDT203-VKGRP." 営業グループ
LST_APP_ALVDATA-KUNNR   = LST_SDT203-KUNNR." 受注先
LST_APP_ALVDATA-NAME1   = LST_SDT203-NAME1." 名称 1
LST_APP_ALVDATA-MATNR   = LST_SDT203-MATNR." 品目コード
LST_APP_ALVDATA-ARKTX   = LST_SDT203-TXZ01." 受注明細のテキスト (短)
LST_APP_ALVDATA-KWMENG  = LST_SDT203-MENGE." 累積受注数量 (販売単位)
LST_APP_ALVDATA-VRKME   = LST_SDT203-MEINS." 販売単位
LST_APP_ALVDATA-NETPR   = LST_SDT203-NETPR." 正味価格
LST_APP_ALVDATA-WAERK   = LST_SDT203-WAERS." 販売伝票通貨
LST_APP_ALVDATA-KPEIN   = LST_SDT203-PEINH." 価格条件単位
LST_APP_ALVDATA-ZVRKME  = LST_SDT203-BPRME." 販売単位
LST_APP_ALVDATA-NETWR   = LST_SDT203-NETWR." 正味価格
LST_APP_ALVDATA-WERKS   = LST_SDT203-DWERK.
" プラント (自社または外部)
LST_APP_ALVDATA-ZEKUNNR = LST_SDT203-ZKUNNR_S.
" 出荷先
LST_APP_ALVDATA-ZEKNAME = LST_SDT203-ZNAME1.
" 出荷先名称
LST_APP_ALVDATA-EDATU   = LST_SDT203-EINDT.
" 納入日程日付
LST_APP_ALVDATA-ZEEMNAM = LST_SDT203-ENAME.
" 従業員名称
LST_APP_ALVDATA-DZTERM  = LST_SDT203-ZTERM.
" 支払条件キー
LST_APP_ALVDATA-BSTKD   = LST_SDT203-EBELN.
" 得意先発注番号
LST_APP_ALVDATA-BSTDK   = LST_SDT203-AEDAT.
" 得意先発注日付
LST_APP_ALVDATA-EBELP   = LST_SDT203-EBELP.
" 購買伝票の明細番号

LST_APP_ALVDATA-BSART   = LST_SDT203-BSART.
" 購買伝票タイプ
LST_APP_ALVDATA-KNTTP   = LST_SDT203-KNTTP.
" 勘定設定カテゴリ
LST_APP_ALVDATA-PERNR   = LST_SDT203-PERNR.
" 営業員
LST_APP_ALVDATA-ZKUNNR_ZJ   = LST_SDT203-ZKUNNR_ZJ.
" 最終需要者
LST_APP_ALVDATA-ZKUNNR_DS   = LST_SDT203-ZKUNNR_DS.
" 最終需要者(商流)

IF RB_ERR IS INITIAL.
APPEND LST_APP_ALVDATA TO TD_APP_ALV.
ELSE.
LST_ERR_ALVDATA = LST_APP_ALVDATA.
LST_ERR_ALVDATA-MSGTX   = LST_SDT203-MSGTX.
" メッセージテキスト
APPEND LST_ERR_ALVDATA TO TD_ERR_ALV.
ENDIF.
CLEAR:
LST_APP_ALVDATA,
LST_ERR_ALVDATA.
ENDLOOP.

SORT TD_APP_ALV BY BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

SORT TD_ERR_ALV BY BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

ENDFORM.                    " EDIT_ALVDATA

*&---------------------------------------------------------------------*
*&      Form  SET_STATUS
*&---------------------------------------------------------------------*
*       ALV画面のステータスの設定
*----------------------------------------------------------------------*
*      -->I_TD_EXTAB       ITAB:ユーザ例外
*----------------------------------------------------------------------*
FORM SET_STATUS USING I_TD_EXTAB TYPE SLIS_T_EXTAB.

DATA:
LST_EXTAB TYPE SLIS_EXTAB.

REFRESH:
I_TD_EXTAB.

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
SET TITLEBAR 'TITLE_APP'.
SET PF-STATUS 'STATUS_APP'.
*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_ERR'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB.
*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.
LST_EXTAB-FCODE = '&ALL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = '&SAL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'MODI'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'DEL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_LIST'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB..
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " SET_STATUS

*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&---------------------------------------------------------------------*
*       ALV画面の事件
*----------------------------------------------------------------------*
*      -->I_W_UCOMM       　ユーザ事件
*      -->I_ST_SELFIELD     information cursor position ALV
*----------------------------------------------------------------------*
FORM USER_COMMAND USING I_W_UCOMM     TYPE SY-UCOMM
I_ST_SELFIELD TYPE SLIS_SELFIELD.

DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LTD_UPDATE      TYPE TYP_TD_ALVDATA,
LW_QUESTION     TYPE CHAR72,
LW_ANSWER       TYPE CHAR1,
LW_ERRFLG       TYPE CHAR1,
LW_MESSAGE      TYPE BAPI_MSG.

I_ST_SELFIELD-REFRESH = ABAP_ON.

CLEAR LTD_PROCESS.
* A-4．ボタンイベント処理
CASE I_W_UCOMM.
*   A-4-1-1．　「Delete」ボタン押下時の処理
*   A-4-2-1．「Delete」ボタン押下時の処理
WHEN CNS_USER_DEL.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ELSE.
*       削除しますか？
MESSAGE S034(ZMEGSD01) INTO LW_QUESTION.

*       POP確認
PERFORM POP_CONFIRM USING TEXT-B01
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ENDIF.
ENDIF.

*     B-2-1．ロック処理
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS.

*     B-2-2．受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203 USING LTD_PROCESS
W_SYST_DATE
W_SYST_TIME.

COMMIT WORK AND WAIT.

*     B-2-3．ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS.

*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.

*   A-4-1-2．　「Approve」ボタン押下時の処理
WHEN CNS_USER_APP.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.
*     C-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.

*     C-1-3．ロック処理
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS.

*     C-2．受注シミュレーション処理
*     C-2-1．シミュレーション対象データの補足処理。
PERFORM EDIT_TD_PROCESS USING TD_APP_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG,
LW_MESSAGE.
PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LW_MESSAGE.
IF LW_ERRFLG IS INITIAL
AND LW_MESSAGE IS INITIAL.
*    C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_C
LW_MESSAGE
LTD_UPDATE
LTD_PROCESS
W_SYST_DATE
W_SYST_TIME.
ELSE.
* C-3-1．承認エラーの場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_E
LW_MESSAGE
LTD_UPDATE
LTD_PROCESS
W_SYST_DATE
W_SYST_TIME.

ENDIF.

*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.
*     C-4-2．メッセージを表示する。
IF LW_ERRFLG IS INITIAL.
*       指定された対象が全て承認されました
MESSAGE S045(ZMEGSD01).
ELSE.
*       承認失敗のデータが存在します。エラーリカバリ一覧をご確認ください
MESSAGE S046(ZMEGSD01).
ENDIF.
*   A-4-1-3．　「Change」ボタン押下時の処理
*   A-4-2-2．　「Change」ボタン押下時の処理
WHEN CNS_USER_MOD.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.
*     D-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.
*     購買発注番号混在チェック
PERFORM CHECK_TD_PROCESS USING TD_APP_ALV
TD_ERR_ALV
CHANGING LTD_PROCESS.
*     D-2．データ設定処理
CLEAR:
TD_ITEM_ALV,
TD_ITEM_ALV_INI,
ST_ZSEGSD0009,
ST_ZSEGSD0009_INI.
PERFORM SET_SCREEN_9000 USING LTD_PROCESS
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
TD_ITEM_ALV_INI.

ST_ZSEGSD0009_INI = ST_ZSEGSD0009.
CLEAR W_CHANGED.
CALL SCREEN 9000.
WHEN CNS_USER_BACK
OR CNS_USER_EXIT.
LEAVE TO SCREEN 0.
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " USER_COMMAND

*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
*       対象データを選択
*----------------------------------------------------------------------*
*      <--O_TD_SELFIELD     ITAB:選択対象データ
*----------------------------------------------------------------------*
FORM SELECT_DATA CHANGING O_TD_SELFIELD TYPE TYP_TD_ERRALVDATA.

DATA:
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

CASE ABAP_ON.
*   ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
LOOP AT TD_APP_ALV INTO LST_APP_ALVDATA
WHERE CHK IS NOT INITIAL.
MOVE-CORRESPONDING LST_APP_ALVDATA TO LST_ERR_ALVDATA.
APPEND LST_ERR_ALVDATA TO O_TD_SELFIELD.
CLEAR LST_ERR_ALVDATA.
ENDLOOP.
*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
O_TD_SELFIELD = TD_ERR_ALV.
DELETE O_TD_SELFIELD WHERE CHK IS INITIAL.
WHEN OTHERS.
*   処理なし
ENDCASE.

ENDFORM.                    " SELECT_DAT

*&---------------------------------------------------------------------*
*&      Form  POP_CONFIRM
*&---------------------------------------------------------------------*
*       POP確認
*----------------------------------------------------------------------*
*      -->I_W_TITLEBAR     TITLEBAR
*      -->I_W_QUESTION     TEXT_QUESTION
*      -->I_W_BUTTON1      TEXT_BUTTON_1
*      -->I_W_BUTTON2      TEXT_BUTTON_2
*      <--O_W_ANSWER       ANSWER
*----------------------------------------------------------------------*
FORM POP_CONFIRM USING I_W_TITLEBAR TYPE ANY
I_W_QUESTION TYPE ANY
I_W_BUTTON1  TYPE ANY
I_W_BUTTON2  TYPE ANY
CHANGING O_W_ANSWER   TYPE C.

CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TITLEBAR              = I_W_TITLEBAR
TEXT_QUESTION         = I_W_QUESTION
TEXT_BUTTON_1         = I_W_BUTTON1
TEXT_BUTTON_2         = I_W_BUTTON2
DISPLAY_CANCEL_BUTTON = SPACE
IMPORTING
ANSWER                = O_W_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND        = 1
OTHERS                = 2.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.


ENDFORM.                    " POP_CONFIRM

*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:ロック処理の対象データ
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA.

DATA:
LW_EBELN        TYPE EBELN,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LTD_PROCESS_TEM TYPE TYP_TD_ERRALVDATA,
LRD_BSTKD       TYPE RANGE OF BSTKD,
LST_BSTKD       LIKE LINE OF LRD_BSTKD.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
IF LST_PROCESS-BSTKD IN LRD_BSTKD.
CONTINUE.
ENDIF.
LW_EBELN = LST_PROCESS-BSTKD.
CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.

*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS_TEM.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
LST_BSTKD-SIGN   = 'I'.
LST_BSTKD-OPTION = 'EQ'.
LST_BSTKD-LOW    = LST_PROCESS-BSTKD.
APPEND LST_BSTKD TO LRD_BSTKD.
CLEAR LST_BSTKD.
ENDIF.

APPEND LST_PROCESS TO LTD_PROCESS_TEM.

ENDLOOP.

ENDFORM.                    " LOCK_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_TD_ALVDATA     ITAB:ロックの解除の対象データ
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203 USING I_TD_ALVDATA TYPE TYP_TD_ERRALVDATA.

DATA:
LST_ALVDATA   TYPE TYP_ERR_ALVDATA,
LW_EBELN      TYPE EBELN.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
LW_EBELN = LST_ALVDATA-BSTKD.
CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN.

ENDLOOP.

ENDFORM.                    " UNLOCK_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203
*&---------------------------------------------------------------------*
*       B-2-2．受発注連携データのステータス更新処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:更新処理の対象データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
I_W_DATE     TYPE SY-DATUM
I_W_TIME     TYPE SY-UZEIT.

DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2    " 処理区分
STATUS       = CNS_STATUS_D    " ステータス
Z_MOD_YMD    = I_W_DATE        " 更新年月日
Z_MOD_HMS    = I_W_TIME        " 更新時分秒
Z_MOD_USERID = SY-UNAME        " 更新ユーザ
WHERE EBELN        = LST_PROCESS-BSTKD
" 購買伝票番号
AND EBELP        = LST_PROCESS-EBELP.
" 購買伝票の明細番号
IF SY-SUBRC <> 0.
ROLLBACK WORK.
*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_PROCESS.
*    データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.
ENDLOOP.

ENDFORM.                    " UPDATE_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_AGAIN
*&---------------------------------------------------------------------*
*       B-3．ALV画面を再表示処理
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_AGAIN USING I_W_DATE    TYPE SY-DATUM.

DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203.

*  ラジオボタン「承認一覧(Approve)」を指定した場合
IF RB_APP IS NOT INITIAL.
*   A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203.
*   A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.
ENDIF.

* ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
IF RB_ERR IS NOT INITIAL.
*   A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203.
ENDIF.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING LTD_ZTEGSDT203.

ENDFORM.                    " DISPLAY_ALV_AGAIN

*&---------------------------------------------------------------------*
*&      Form  EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*       C-2-1．シミュレーション対象データの補足処理。
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM EDIT_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA.


LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

REFRESH O_TD_PROCESS.

LOOP AT LTD_PROCESS INTO LST_PROCESS.
LOOP AT I_TD_APP_ALV INTO LST_APP_ALV
WHERE BSTKD = LST_PROCESS-BSTKD.
LST_PROCESS_TEM = LST_APP_ALV.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDLOOP.
ENDLOOP.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS

*&---------------------------------------------------------------------*
*&      Form  BAPI_SALESORDER_CREAT
*&---------------------------------------------------------------------*
*       C-2-2．受注シミュレーション処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:処理の対象データ
*      <--O_TD_UPDATE      ITAB;更新対象データ
*      <--O_W_ERRFLG       BAPIエラーフラッグ
*      <--O_W_MESSAGE      BAPIエラーメッセージ
*----------------------------------------------------------------------*
FORM BAPI_SALESORDER_CREAT USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_UPDATE  TYPE TYP_TD_ALVDATA
O_W_ERRFLG   TYPE C
O_W_MESSAGE  TYPE BAPI_MSG.

DATA:
LST_PROCESS       TYPE TYP_ERR_ALVDATA,
LST_TEM_PROCESS   TYPE TYP_TEM_ALVDATA,
LST_TEM_PROCESS1  TYPE TYP_TEM_ALVDATA,
LTD_TEM_PROCESS   TYPE TYP_TD_ALVDATA,
LST_DATA_205      TYPE TYP_DATA_205,
LTD_DATA_205      TYPE TYP_TD_205,
LST_HEADER_IN     TYPE BAPISDHD1,
LST_ORDER_PARTNER TYPE BAPIPARNR,
LTD_ORDER_PARTNER TYPE TABLE OF BAPIPARNR,
LST_ITEMS_IN      TYPE BAPISDITM,
LTD_ITEMS_IN      TYPE TABLE OF BAPISDITM,
LST_SCHEDULES     TYPE BAPISCHDL,
LTD_SCHEDULES     TYPE STANDARD TABLE OF BAPISCHDL,
LST_CONDITIONS    TYPE BAPICOND,
LTD_CONDITIONS    TYPE STANDARD TABLE OF BAPICOND,
LW_NUMBER         TYPE POSNR_VA,
LW_COND_VALUE     TYPE BAPICURR-BAPICURR,
LTD_RETURN        TYPE TABLE OF BAPIRET2,
LST_RETURN        TYPE BAPIRET2.

* 販売伝票タイプを取得
PERFORM GET_DATA_205 USING I_TD_PROCESS
CHANGING LTD_DATA_205.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
MOVE-CORRESPONDING LST_PROCESS TO LST_TEM_PROCESS.
APPEND LST_TEM_PROCESS TO LTD_TEM_PROCESS.
CLEAR LST_TEM_PROCESS.
ENDLOOP.

SORT LTD_TEM_PROCESS BY BSTKD ASCENDING     " 得意先発注番号
EBELP ASCENDING.    " 購買伝票の明細番号

LOOP AT LTD_TEM_PROCESS INTO LST_TEM_PROCESS1.
LST_TEM_PROCESS = LST_TEM_PROCESS1.
AT NEW BSTKD.
*     @受注伝票ヘッダ
CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = LST_TEM_PROCESS-BSART
KNTTP = LST_TEM_PROCESS-KNTTP
BINARY SEARCH.

LST_HEADER_IN-DOC_TYPE   = LST_DATA_205-AUART.
" 販売伝票タイプ
LST_HEADER_IN-SALES_ORG  = LST_TEM_PROCESS-VKORG.
" 販売組織
LST_HEADER_IN-DISTR_CHAN = LST_TEM_PROCESS-VTWEG.
" 流通チャネル
LST_HEADER_IN-DIVISION   = LST_TEM_PROCESS-SPART.
" 製品部門
LST_HEADER_IN-SALES_GRP  = LST_TEM_PROCESS-VKGRP.
" 営業グループ
LST_HEADER_IN-SALES_OFF  = LST_TEM_PROCESS-VKBUR.
" 営業所
LST_HEADER_IN-PURCH_NO_C = LST_TEM_PROCESS-BSTKD.
" 得意先発注番号
LST_HEADER_IN-PURCH_DATE = LST_TEM_PROCESS-BSTDK.
" 得意先発注日付
LST_HEADER_IN-ORD_REASON = LST_DATA_205-AUGRU.
" 受注理由 (取引理由)
LST_HEADER_IN-CURRENCY   = LST_TEM_PROCESS-WAERK.
" 販売伝票通貨
ENDAT.
*   B明細データ
LW_NUMBER = LW_NUMBER + 10.
LST_ITEMS_IN-ITM_NUMBER = LW_NUMBER.      " 販売伝票明細
LST_ITEMS_IN-MATERIAL   = LST_TEM_PROCESS-MATNR.
" 品目コード
LST_ITEMS_IN-SHORT_TEXT = LST_TEM_PROCESS-ARKTX.
" 受注明細のテキスト (短)
LST_ITEMS_IN-PLANT      = LST_TEM_PROCESS-WERKS.
" プラント
LST_ITEMS_IN-SALES_UNIT = LST_TEM_PROCESS-ZVRKME.
" 販売単位
LST_ITEMS_IN-REF_DOC    = LST_TEM_PROCESS-BSTKD.
" 参照伝票番号
LST_ITEMS_IN-REF_DOC_IT = LST_TEM_PROCESS-EBELP.
" 参照明細番号
APPEND LST_ITEMS_IN TO LTD_ITEMS_IN.
CLEAR LST_ITEMS_IN.
*   D納入日程行データ
LST_SCHEDULES-ITM_NUMBER = LW_NUMBER.     " 販売伝票明細
LST_SCHEDULES-SCHED_LINE = CNS_LINE_01.   " 納入日程行
LST_SCHEDULES-REQ_DATE   = LST_TEM_PROCESS-EDATU.
" 納入日程日付
LST_SCHEDULES-REQ_QTY    = LST_TEM_PROCESS-KWMENG.
" 販売単位による受注数量
APPEND LST_SCHEDULES TO LTD_SCHEDULES.
CLEAR LST_SCHEDULES.

LST_CONDITIONS-ITM_NUMBER = LW_NUMBER.    " 販売伝票明細
LST_CONDITIONS-COND_TYPE  = CNS_COND_ZPR0." 条件タイプ

CLEAR LW_COND_VALUE.
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = LST_TEM_PROCESS-WAERK
AMOUNT_INTERNAL = LST_TEM_PROCESS-NETPR
IMPORTING
AMOUNT_EXTERNAL = LW_COND_VALUE.      " 条件レート

LST_CONDITIONS-COND_VALUE = LW_COND_VALUE." 条件レート
LST_CONDITIONS-CURRENCY   = LST_TEM_PROCESS-WAERK.
" 通貨コード
LST_CONDITIONS-COND_UNIT  = LST_TEM_PROCESS-ZVRKME.
" 条件単位
LST_CONDITIONS-COND_P_UNT = LST_TEM_PROCESS-KPEIN.
" 販売単位
APPEND LST_CONDITIONS TO LTD_CONDITIONS.
CLEAR LST_CONDITIONS.
APPEND LST_TEM_PROCESS TO O_TD_UPDATE.
AT END OF BSTKD.
*     C伝票取引先
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SP.
" 受注先「SP」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-KUNNR.
" 受注先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SH.
" 出荷先「SH」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZEKUNNR.
" 出荷先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_PE.
" 営業員「PE」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-PERNR.
" 営業員
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZJ.
" 最終需要者「ZJ」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_ZJ.
" 最終需要者
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZC.
" 最終需要者(商流)「ZC」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_DS.
" 最終需要者(商流)
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
EXPORTING
ORDER_HEADER_IN               = LST_HEADER_IN
TESTRUN                       = ABAP_ON
TABLES
RETURN                        = LTD_RETURN
ORDER_ITEMS_IN                = LTD_ITEMS_IN
ORDER_PARTNERS                = LTD_ORDER_PARTNER
ORDER_SCHEDULES_IN            = LTD_SCHEDULES
ORDER_CONDITIONS_IN           = LTD_CONDITIONS.

CLEAR O_W_MESSAGE.
LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E.
O_W_MESSAGE = LST_RETURN-MESSAGE.
O_W_ERRFLG = ABAP_ON.
EXIT.
ENDLOOP.

CLEAR:
LST_HEADER_IN,
LW_NUMBER.

REFRESH:
LTD_ITEMS_IN,
LTD_ORDER_PARTNER,
LTD_SCHEDULES,
LTD_CONDITIONS.
ENDAT.
ENDLOOP.

ENDFORM.                    " BAPI_SALESORDER_CREAT

*&---------------------------------------------------------------------*
*&      Form  CHECK_TD_PROCESS
*&---------------------------------------------------------------------*
*       購買発注番号混在チェック
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      -->I_TD_ERR_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM CHECK_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
I_TD_ERR_ALV TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA,
LW_CUNT         TYPE I.

LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

DESCRIBE TABLE LTD_PROCESS LINES LW_CUNT.
IF LW_CUNT > 1.
*   変更の場合、同一購買発注のみ指定できます
MESSAGE E047(ZMEGSD01).
ENDIF.

REFRESH O_TD_PROCESS.

IF RB_APP IS NOT INITIAL.
LOOP AT LTD_PROCESS INTO LST_PROCESS.
LOOP AT I_TD_APP_ALV INTO LST_APP_ALV
WHERE BSTKD = LST_PROCESS-BSTKD.
LST_PROCESS_TEM = LST_APP_ALV.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDLOOP.
ENDLOOP.
ENDIF.

IF RB_ERR IS NOT INITIAL.
O_TD_PROCESS = I_TD_ERR_ALV.
READ TABLE LTD_PROCESS INTO LST_PROCESS INDEX 1.
DELETE O_TD_PROCESS WHERE BSTKD <> LST_PROCESS-BSTKD.
ENDIF.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_205
*&---------------------------------------------------------------------*
*       販売伝票タイプを取得
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:ALV対象データ
*      <--O_TD_DATA_205    ITAB:販売伝票タイプデータ
*----------------------------------------------------------------------*
FORM GET_DATA_205 USING I_TD_PROCESS  TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_DATA_205 TYPE TYP_TD_205.
DATA:
LTD_PROCESS  TYPE TYP_TD_ERRALVDATA,
LTD_DATA_205 TYPE TYP_TD_205,
LST_TVAKT    TYPE TYP_TVAKT,
LTD_TVAKT    TYPE STANDARD TABLE OF TYP_TVAKT.

FIELD-SYMBOLS:
<LFS_ST_DATA_205> TYPE TYP_DATA_205.

LTD_PROCESS = I_TD_PROCESS.
SORT LTD_PROCESS BY BSART ASCENDING         " 購買伝票タイプ
KNTTP ASCENDING.        " 勘定設定カテゴリ
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSART       " 購買伝票タイプ
KNTTP.      " 勘定設定カテゴリ

SELECT BSART                                " 購買伝票タイプ
KNTTP                                " 勘定設定カテゴリ
AUART                                " 販売伝票タイプ
AUGRU                                " 受注理由
FROM ZTEGSDT205
INTO TABLE O_TD_DATA_205
FOR ALL ENTRIES IN LTD_PROCESS
WHERE BSART = LTD_PROCESS-BSART            " 購買伝票タイプ
AND KNTTP = LTD_PROCESS-KNTTP.           " 勘定設定カテゴリ
IF SY-SUBRC = 0.

LTD_DATA_205 = O_TD_DATA_205.
SORT LTD_DATA_205 BY AUART ASCENDING.     " 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205
COMPARING AUART.    " 販売伝票タイプ

SELECT AUART                              " 販売伝票タイプ
BEZEI                              " 販売伝票タイプテキスト
FROM TVAKT
INTO TABLE LTD_TVAKT
FOR ALL ENTRIES IN LTD_DATA_205
WHERE AUART = LTD_DATA_205-AUART         " 販売伝票タイプ
AND SPRAS = SY-LANGU.                  " システム言語

LOOP AT O_TD_DATA_205 ASSIGNING <LFS_ST_DATA_205>.
CLEAR LST_TVAKT.
READ TABLE LTD_TVAKT INTO LST_TVAKT
WITH KEY AUART = <LFS_ST_DATA_205>-AUART
BINARY SEARCH.
<LFS_ST_DATA_205>-BEZEI = LST_TVAKT-BEZEI.
" 販売伝票タイプテキスト
ENDLOOP.
SORT O_TD_DATA_205 BY BSART ASCENDING     " 購買伝票タイプ
KNTTP ASCENDING.    " 勘定設定カテゴリ

ENDIF.

ENDFORM.                    " GET_DATA_205

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_BAPI
*&---------------------------------------------------------------------*
*       C-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_MESSAGE        メッセージ
*      -->I_TD_ALVDATA     ITAB:BAPI処理対象
*      -->I_TD_UNLOCK      ITAB:UNLOCK処理対象データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_BAPI USING I_KBUNCC      TYPE C
I_STATUS      TYPE C
I_MESSAGE     TYPE BAPI_MSG
I_TD_ALVDATA  TYPE TYP_TD_ALVDATA
I_TD_UNLOCK   TYPE TYP_TD_ERRALVDATA
I_W_DATE      TYPE SY-DATUM
I_W_TIME      TYPE SY-UZEIT.
DATA:
LFG_ERR     TYPE C,
LST_ALVDATA TYPE TYP_TEM_ALVDATA.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC        " 処理区分
STATUS       = I_STATUS        " ステータス
MSGTX        = I_MESSAGE       " メッセージ
ZKUNNR_S     = LST_ALVDATA-ZEKUNNR
" 出荷先
ZKUNNR_ZJ    = LST_ALVDATA-ZKUNNR_ZJ
" 最終需要者
ZKUNNR_DS    = LST_ALVDATA-ZKUNNR_DS
" 最終需要者（商流）
PERNR        = LST_ALVDATA-PERNR
" 営業員
DWERK        = LST_ALVDATA-WERKS
" 出荷プラント
Z_MOD_YMD    = I_W_DATE        " 更新年月日
Z_MOD_HMS    = I_W_TIME        " 更新時分秒
Z_MOD_USERID = SY-UNAME        " 更新ユーザ
WHERE EBELN        = LST_ALVDATA-BSTKD
" 購買伝票番号
AND EBELP        = LST_ALVDATA-EBELP.
" 購買伝票の明細番号
IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
* C-3-3．データ更新に全件成功した場合、コミットし、ロックを解除
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
*  データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_BAPI

*&---------------------------------------------------------------------*
*&      Form  SET_SCREEN_9000
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS      ITAB:ALV処理対象データ
*      <--O_ZSEGSD0009      SCREEN9000ヘッダデータ
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*      <--O_TD_ITEM_ALV_INI SCREEN9000明細データ初期値
*----------------------------------------------------------------------*
FORM SET_SCREEN_9000 USING I_TD_PROCESS      TYPE TYP_TD_ERRALVDATA
CHANGING O_ZSEGSD0009      TYPE TYP_ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM
O_TD_ITEM_ALV_INI TYPE TYP_TD_ITEM.

DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LTD_DATA_205  TYPE TYP_TD_205,
LST_DATA_205  TYPE TYP_DATA_205,
LW_NETWR      TYPE NETWR,
LW_VKORGTEXT  TYPE VTXTK,
LW_VTWEGTEXT  TYPE VTXTK,
LW_SPARTTEXT  TYPE VTXTK,
LW_ZESALESTXT TYPE ZESALESTXT,
LW_TEXT1      TYPE TEXT1_052,
LST_ITEM_ALV  TYPE ZSEGSD0010.

* 販売伝票タイプを取得
PERFORM GET_DATA_205 USING I_TD_PROCESS
CHANGING LTD_DATA_205.
CLEAR:
LW_NETWR,
O_ZSEGSD0009.

REFRESH:
O_TD_ITEM_ALV,
O_TD_ITEM_ALV_INI.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
IF SY-TABIX = 1.
O_ZSEGSD0009-VKORG    = LST_PROCESS-VKORG.
" 販売組織
O_ZSEGSD0009-VTWEG    = LST_PROCESS-VTWEG.
" 流通チャネル
O_ZSEGSD0009-SPART    = LST_PROCESS-SPART.
" 製品部門
O_ZSEGSD0009-VKBUR    = LST_PROCESS-VKBUR.
" 営業所
O_ZSEGSD0009-VKGRP    = LST_PROCESS-VKGRP.
" 営業グループ
O_ZSEGSD0009-ZEKUNNR1 = LST_PROCESS-KUNNR.
" 受注先
O_ZSEGSD0009-ZEKNAME1 = LST_PROCESS-NAME1.
" 受注先名称
O_ZSEGSD0009-ZEKUNNR  = LST_PROCESS-ZEKUNNR.
" 出荷先
O_ZSEGSD0009-ZEKNAME  = LST_PROCESS-ZEKNAME.
" 出荷先名称
O_ZSEGSD0009-ZEKUNNR2 = LST_PROCESS-ZKUNNR_ZJ.
" 最終需要者
O_ZSEGSD0009-ZEKUNNR3 = LST_PROCESS-ZKUNNR_DS.
" 最終需要者(商流)
O_ZSEGSD0009-PERNR    = LST_PROCESS-PERNR.
" 営業員
O_ZSEGSD0009-ENAME    = LST_PROCESS-ZEEMNAM.
" 営業員氏名
O_ZSEGSD0009-BSTKD    = LST_PROCESS-BSTKD.
" 購買発注番号
O_ZSEGSD0009-BSTDK    = LST_PROCESS-BSTDK.
" 購買発注伝票日付
O_ZSEGSD0009-BSART    = LST_PROCESS-BSART.
" 購買伝票タイプ
O_ZSEGSD0009-KNTTP    = LST_PROCESS-KNTTP.
" 勘定設定カテゴリ
*     D-2-1-2．販売伝票タイプの設定処理。
CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = LST_PROCESS-BSART
KNTTP = LST_PROCESS-KNTTP
BINARY SEARCH.
O_ZSEGSD0009-AUART    = LST_DATA_205-AUART.
" 販売伝票タイプ
O_ZSEGSD0009-ZABEZEI  = LST_DATA_205-BEZEI.
" 販売伝票タイプテキスト
O_ZSEGSD0009-AUGRU    = LST_DATA_205-AUGRU.
" 受注理由 (取引理由)
*     D-2-1-3．販売エリアのテキストの設定処理。
SELECT SINGLE VTEXT
INTO LW_VKORGTEXT
FROM TVKOT
WHERE SPRAS = SY-LANGU
AND VKORG = LST_PROCESS-VKORG.
IF SY-SUBRC = 0
AND LW_VKORGTEXT IS NOT INITIAL.
LW_ZESALESTXT = LW_VKORGTEXT.
ENDIF.

*     D-2-1-3-2．流通チャネルの名称の取得処理
SELECT SINGLE VTEXT
INTO LW_VTWEGTEXT
FROM TVTWT
WHERE SPRAS = SY-LANGU
AND VTWEG = LST_PROCESS-VTWEG.
IF SY-SUBRC = 0
AND LW_VTWEGTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_VTWEGTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_VTWEGTEXT.
ENDIF.
ENDIF.

*     D-2-1-3-3．製品部門の名称の取得処理
SELECT SINGLE VTEXT
INTO LW_SPARTTEXT
FROM TSPAT
WHERE SPRAS = SY-LANGU
AND SPART = LST_PROCESS-SPART.
IF SY-SUBRC = 0
AND LW_SPARTTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_SPARTTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_SPARTTEXT.
ENDIF.
ENDIF.
O_ZSEGSD0009-ZESALESTXT = LW_ZESALESTXT." 販売エリアテキスト

*     D-2-1-4．営業所のテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = LST_PROCESS-VKBUR.

*     D-2-1-5．営業グループのテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = LST_PROCESS-VKGRP.

*     D-2-1-5．最終需要者の名称の設定処理。
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME2
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_ZJ.

*     D-2-1-6．最終需要者(商流)の名称の設定処理。
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME3
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_DS.
*     D-2-1-7．受注総額の設定処理。
*     通貨単位を設定
O_ZSEGSD0009-WAERK = LST_PROCESS-WAERK.
*     D-2-2-3．支払条件テキストの設定処理。
CLEAR LW_TEXT1.
SELECT TEXT1 UP TO 1 ROWS
FROM T052U
INTO LW_TEXT1
WHERE SPRAS = SY-LANGU
AND ZTERM = LST_PROCESS-DZTERM.
EXIT.
ENDSELECT.
ENDIF.
*   各明細の受注額(Net Value)を合計
LW_NETWR = LW_NETWR + LST_PROCESS-NETWR.

LST_ITEM_ALV-MATNR  = LST_PROCESS-MATNR.  " 品目コード
LST_ITEM_ALV-ARKTX  = LST_PROCESS-ARKTX.  " 品目テキスト
LST_ITEM_ALV-KWMENG = LST_PROCESS-KWMENG. " 数量
LST_ITEM_ALV-VRKME  = LST_PROCESS-VRKME.  " 単位
LST_ITEM_ALV-NETPR  = LST_PROCESS-NETPR.  " 単価
LST_ITEM_ALV-WAERK  = LST_PROCESS-WAERK.  " 通貨
LST_ITEM_ALV-KPEIN  = LST_PROCESS-KPEIN.  " /
LST_ITEM_ALV-ZVRKME = LST_PROCESS-ZVRKME. " UoM
LST_ITEM_ALV-NETWR  = LST_PROCESS-NETWR.  " 受注額
LST_ITEM_ALV-WERKS  = LST_PROCESS-WERKS.  " 出荷プラント
LST_ITEM_ALV-EDATU  = LST_PROCESS-EDATU.  " 納入期日
LST_ITEM_ALV-ZTERM  = LST_PROCESS-DZTERM. " 支払条件

*   D-2-2-2．明細番号(Item)の設定処理。
LST_ITEM_ALV-POSNR  = LST_PROCESS-EBELP.  " 購買伝票の明細番号

*   D-2-2-3-2．支払条件テキストの設定処理。
LST_ITEM_ALV-TEXT1 = LW_TEXT1.
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV.
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV_INI.
CLEAR LST_ITEM_ALV.
ENDLOOP.

O_ZSEGSD0009-NETWR = LW_NETWR.

ENDFORM.                    " SET_SCREEN_9000

*&---------------------------------------------------------------------*
*&      Module  STATUS_9000  OUTPUT
*&---------------------------------------------------------------------*
*      画面9000のステータスの設定
*----------------------------------------------------------------------*
MODULE STATUS_9000 OUTPUT.
SET PF-STATUS 'STATUS_9000'.
SET TITLEBAR 'BAR_9000'.
ENDMODULE.                 " STATUS_9000  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  ALV_DISPLAY  OUTPUT
*&---------------------------------------------------------------------*
*       D-3．詳細画面を表示処理
*----------------------------------------------------------------------*
MODULE ALV_DISPLAY OUTPUT.

* D-3．詳細画面を表示処理
PERFORM ALV_9000_OUPUT.

ENDMODULE.                 " ALV_DISPLAY  OUTPUT

*&---------------------------------------------------------------------*
*&       Class (Implementation)  CL_EVENT_RECEIVER
*&---------------------------------------------------------------------*
*        クラス:CL_EVENT_RECEIVER
*----------------------------------------------------------------------*
CLASS CL_EVENT_RECEIVER DEFINITION.

PUBLIC SECTION.
CLASS-METHODS:

HANDLE_DATA_CHANGED
FOR EVENT DATA_CHANGED OF CL_GUI_ALV_GRID
IMPORTING ER_DATA_CHANGED E_ONF4,

*     在数据修改完成之后
HANDLE_DATA_CHANGED_FINISHED
FOR EVENT DATA_CHANGED_FINISHED OF CL_GUI_ALV_GRID
IMPORTING E_MODIFIED,

*     F4#助用
HANDLE_F4
FOR EVENT ONF4 OF CL_GUI_ALV_GRID
IMPORTING ER_EVENT_DATA.

ENDCLASS.               "CL_EVENT_RECEIVER

*&---------------------------------------------------------------------*
*&       Class (Implementation)  GCL_EVENT_RECEIVER
*&---------------------------------------------------------------------*
*        クラス:CL_EVENT_RECEIVER
*----------------------------------------------------------------------*
CLASS CL_EVENT_RECEIVER IMPLEMENTATION.
*&---------------------------------------------------------------------

*&      Method HANDLE_DATA_CHANGED
*&---------------------------------------------------------------------

*&      在ALV可修改的情况下，控制数据修改
*&---------------------------------------------------------------------

METHOD HANDLE_DATA_CHANGED.

DATA:
LST_MOD      TYPE LVC_S_MODI,
LTD_ZTERM    TYPE STANDARD TABLE OF TYP_ZTERM,
LST_ZTERM    TYPE TYP_ZTERM,
LST_ITEM     TYPE ZSEGSD0010,
LST_MSG      TYPE LVC_S_MSG1.

SELECT ZTERM
TEXT1
FROM T052U
INTO TABLE LTD_ZTERM.

IF E_ONF4 = ABAP_ON.
RETURN.
ENDIF.
LOOP AT ER_DATA_CHANGED->MT_MOD_CELLS INTO LST_MOD.
CASE LST_MOD-FIELDNAME.
WHEN CNS_FNM_ZTERM.
CLEAR LST_ZTERM.
READ TABLE LTD_ZTERM INTO LST_ZTERM
WITH KEY ZTERM = LST_MOD-VALUE.
IF SY-SUBRC = 0.
CLEAR LST_ITEM.
READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX LST_MOD-ROW_ID.
LST_ITEM-TEXT1 = LST_ZTERM-TEXT1.
MODIFY TD_ITEM_ALV FROM LST_ITEM INDEX LST_MOD-ROW_ID.
ELSE.
CALL METHOD ER_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID = 'V1'
I_MSGNO = '398'
I_MSGTY = CNS_MSG_E
I_MSGV1 = LST_MOD-VALUE
I_FIELDNAME = CNS_FNM_ZTERM
I_ROW_ID    = LST_MOD-ROW_ID.
ENDIF.
WHEN CNS_FNM_POSNR
OR CNS_FNM_MATNR
OR CNS_FNM_ARKTX
OR CNS_FNM_KWMENG
OR CNS_FNM_VRKME
OR CNS_FNM_NETPR
OR CNS_FNM_KPEIN
OR CNS_FNM_ZVRKME
OR CNS_FNM_WERKS
OR CNS_FNM_EDATU.
IF LST_MOD-VALUE IS INITIAL.
CALL METHOD ER_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = '00'
I_MSGNO     = '055'
I_MSGTY     = CNS_MSG_E
I_FIELDNAME = LST_MOD-FIELDNAME
I_ROW_ID    = LST_MOD-ROW_ID.
ENDIF.
ENDCASE.
ENDLOOP.

CALL METHOD CI_ALV->ACTIVATE_DISPLAY_PROTOCOL( SPACE ).

CASE OK_CODE.
WHEN CNS_USER_BACK
OR  CNS_USER_EXIT.
*       処理なし
WHEN OTHERS.
CLEAR LST_MSG.
READ TABLE ER_DATA_CHANGED->MT_PROTOCOL INTO LST_MSG INDEX 1.
IF ER_DATA_CHANGED->MT_PROTOCOL IS NOT INITIAL.
MESSAGE ID LST_MSG-MSGID TYPE CNS_MSG_S NUMBER LST_MSG-MSGNO
WITH LST_MSG-MSGV1
LST_MSG-MSGV2
LST_MSG-MSGV3
LST_MSG-MSGV4
DISPLAY LIKE CNS_MSG_E.
ENDIF.
ENDCASE.

ENDMETHOD.
*&---------------------------------------------------------------------*
*&      Method  HANDLE_DATA_CHANGED_FINISHED
*&---------------------------------------------------------------------*
*&      データを変更された後
*&---------------------------------------------------------------------*
METHOD HANDLE_DATA_CHANGED_FINISHED.

DATA:
LW_COL       TYPE LVC_S_COL,
LW_ROW       TYPE LVC_S_ROW,
LW_MODIFIED  TYPE C,
LW_KWMENG    TYPE EKPO-MENGE,
LW_MENG_ALV  TYPE EKPO-MENGE,
LW_NETWR     TYPE NETWR.

FIELD-SYMBOLS:
<LFS_ALV>    TYPE ZSEGSD0010.

E_MODIFIED = ABAP_ON.
IF E_MODIFIED = ABAP_ON.
CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
ES_ROW_ID    = LW_ROW
ES_COL_ID    = LW_COL.

CALL METHOD CI_ALV->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LW_ROW
IS_COLUMN_ID = LW_COL.
ENDIF.
E_MODIFIED = LW_MODIFIED.

*  E-2-2-2．明細の数量と金額項目が変更された場合、
*  受注額の再計算処理を行う。
CLEAR LW_NETWR.
LOOP AT TD_ITEM_ALV ASSIGNING <LFS_ALV>.
CLEAR:
LW_KWMENG,
LW_MENG_ALV.

LW_MENG_ALV = <LFS_ALV>-KWMENG.

CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR                   = <LFS_ALV>-MATNR
I_IN_ME                   = <LFS_ALV>-VRKME
I_OUT_ME                  = <LFS_ALV>-ZVRKME
I_MENGE                   = LW_MENG_ALV
IMPORTING
E_MENGE                   = LW_KWMENG
EXCEPTIONS
ERROR_IN_APPLICATION      = 1
ERROR                     = 2
OTHERS                    = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ELSE.
<LFS_ALV>-NETWR = LW_KWMENG
* <LFS_ALV>-NETPR
/ <LFS_ALV>-KPEIN.
ENDIF.

LW_NETWR = <LFS_ALV>-NETWR + LW_NETWR.

ENDLOOP.

ST_ZSEGSD0009-NETWR = LW_NETWR.

CALL METHOD CL_GUI_CFW=>SET_NEW_OK_CODE
EXPORTING
NEW_CODE = CNS_USER_ENTR.
CALL METHOD CL_GUI_CFW=>FLUSH.

ENDMETHOD.

*&---------------------------------------------------------------------*
*&      Method  HANDLE_F4
*&---------------------------------------------------------------------*
*&      検索F4
*&---------------------------------------------------------------------*
METHOD HANDLE_F4.

PERFORM FRM_F4_SHOW.
ER_EVENT_DATA->M_EVENT_HANDLED = ABAP_ON.

ENDMETHOD.

ENDCLASS.               "GCL_EVENT_RECEIVER

*&---------------------------------------------------------------------*
*&      Form  ALV_9000_OUPUT
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_ITEM_ALV     ITAB:SCREEN9000ALV処理対象データ
*----------------------------------------------------------------------*
FORM ALV_9000_OUPUT.

DATA:
LTD_EXCLUDE        TYPE UI_FUNCTIONS,
LST_VARIANT        TYPE DISVARIANT,
LST_LAYOUT         TYPE LVC_S_LAYO,
LTD_FIELDCAT       TYPE LVC_T_FCAT,
LST_FIELDCAT       TYPE LVC_S_FCAT,
LTD_F4             TYPE LVC_T_F4,
LST_F4             TYPE LVC_S_F4,
LCL_EVENT_RECEIVER TYPE REF TO CL_EVENT_RECEIVER,
LW_VALID           TYPE C,
LTD_ITEM_ALV       TYPE TYP_TD_ITEM.

IF CI_ALV IS NOT INITIAL.
LTD_ITEM_ALV = TD_ITEM_ALV.
CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
TD_ITEM_ALV = LTD_ITEM_ALV.
CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.
IF LW_VALID IS INITIAL.
RETURN.
ENDIF.

ENDIF.

IF CI_ALV IS INITIAL.
*   容器の作成
CREATE OBJECT: CI_CCONTAINER
EXPORTING
CONTAINER_NAME = CNS_CONTA.

CREATE OBJECT CI_ALV
EXPORTING
I_PARENT = CI_CCONTAINER.

*   ALVレイアウトの設定
LST_LAYOUT-CWIDTH_OPT = ABAP_ON.

*   ALV項目定義
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = CNS_STNM010
CHANGING
CT_FIELDCAT            = LTD_FIELDCAT[]
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

LOOP AT LTD_FIELDCAT INTO LST_FIELDCAT.
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_WAERK
" 通貨
OR LST_FIELDCAT-FIELDNAME = CNS_FNM_NETWR
" 受注額
OR LST_FIELDCAT-FIELDNAME = CNS_FNM_TEXT1.
" 支払条件テキスト
CONTINUE.
ENDIF.
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_ZTERM.
LST_FIELDCAT-F4AVAILABL = ABAP_ON.
ENDIF.
LST_FIELDCAT-EDIT = ABAP_ON.
MODIFY LTD_FIELDCAT FROM LST_FIELDCAT.
ENDLOOP.

PERFORM EXCLUDE_TB_FUNCTIONS CHANGING LTD_EXCLUDE.

LST_VARIANT-REPORT  = SY-REPID.

CALL METHOD CI_ALV->SET_TABLE_FOR_FIRST_DISPLAY
EXPORTING
IS_VARIANT           = LST_VARIANT
IS_LAYOUT            = LST_LAYOUT
IT_TOOLBAR_EXCLUDING = LTD_EXCLUDE
CHANGING
IT_OUTTAB            = TD_ITEM_ALV
IT_FIELDCATALOG      = LTD_FIELDCAT
EXCEPTIONS
INVALID_PARAMETER_COMBINATION = 1
PROGRAM_ERROR                 = 2
TOO_MANY_LINES                = 3
OTHERS                        = 4 .
ELSE.
CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.
ENDIF.

CREATE OBJECT LCL_EVENT_RECEIVER.

SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED
FOR ALL INSTANCES.
* 触#回#后事件 在数据修改完成之后注册
SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED_FINISHED
FOR ALL INSTANCES.

* 注册更新事件（失去光#交点即触#）
CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_MODIFIED.

CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_ENTER.
* 検索F4
REFRESH LTD_F4.
CLEAR LST_F4.
LST_F4-FIELDNAME  = CNS_FNM_ZTERM.
LST_F4-REGISTER   = ABAP_ON.
LST_F4-GETBEFORE  = ABAP_ON.
LST_F4-CHNGEAFTER = ABAP_ON.
LST_F4-INTERNAL   = SPACE.
APPEND LST_F4 TO LTD_F4.

CALL METHOD CI_ALV->REGISTER_F4_FOR_FIELDS
EXPORTING
IT_F4             = LTD_F4.

SET HANDLER LCL_EVENT_RECEIVER->HANDLE_F4 FOR CI_ALV.

ENDFORM.                    " ALV_9000_OUPUT

*&---------------------------------------------------------------------*
*&      Form  EXCLUDE_TB_FUNCTIONS
*&---------------------------------------------------------------------*
*       ユーザ事件を除く
*----------------------------------------------------------------------*
*      <--O_TD_EXCLUDE     ITAB:SCREEN9000ALVユーザ事件
*----------------------------------------------------------------------*
FORM EXCLUDE_TB_FUNCTIONS CHANGING O_TD_EXCLUDE TYPE UI_FUNCTIONS.

DATA:
LST_EXCLUDE TYPE UI_FUNC.
LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_DELETE_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_INSERT_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_APPEND_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_UNDO .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_REFRESH .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_CHECK .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_CUT .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_MB_PASTE .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

ENDFORM.                    " EXCLUDE_TB_FUNCTIONS

*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9000  INPUT
*&---------------------------------------------------------------------*
*       画面9000のボタンイベント処理
*----------------------------------------------------------------------*
MODULE USER_COMMAND_9000 INPUT.

DATA:
LW_SAVE_OK  TYPE SY-UCOMM,
LW_QUESTION TYPE CHAR72,
LW_ANSWER   TYPE C,
LW_ERRFLG   TYPE C,
LW_VALID    TYPE C,
LW_MESSAGE  TYPE BAPI_MSG,
LTD_UPDATE  TYPE TYP_TD_ALVDATA,
LTD_PROCESS TYPE TYP_TD_ERRALVDATA.

CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
IF LW_VALID IS INITIAL.
RETURN.
ENDIF.

LW_SAVE_OK = OK_CODE.

CASE LW_SAVE_OK.
WHEN CNS_USER_ENTR.
*     E-2．データ設定処理
PERFORM GET_9000_AGAIN USING ST_ZSEGSD0009_INI
TD_ITEM_ALV_INI
W_SYST_DATE
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV.

WHEN CNS_USER_SAPP.
PERFORM GET_9000_AGAIN USING ST_ZSEGSD0009_INI
TD_ITEM_ALV_INI
W_SYST_DATE
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV.
*     G.Approve
PERFORM APP_9000_DATA USING ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG,
LW_MESSAGE.

PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LW_MESSAGE.
IF LW_ERRFLG IS INITIAL
AND LW_MESSAGE IS INITIAL.
MESSAGE LW_MESSAGE TYPE CNS_MSG_E.
ENDIF.

*     G-3-1．ロック処理
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS.

*    C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_9000 USING CNS_KBUNCC_2
CNS_STATUS_C
ST_ZSEGSD0009
TD_ITEM_ALV
W_SYST_DATE
W_SYST_TIME.
*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.
*     C-4-2．メッセージを表示する。
*      データ承認しました。(購買発注 = &1)
MESSAGE S049(ZMEGSD01) WITH ST_ZSEGSD0009-BSTKD.
LEAVE TO SCREEN 0.
WHEN CNS_USER_SHOD
OR CNS_USER_SAVE.
*     E-2．データ設定処理
PERFORM GET_9000_AGAIN USING ST_ZSEGSD0009_INI
TD_ITEM_ALV_INI
W_SYST_DATE
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV.

*     F-1-3．ロック処理
PERFORM LOCK_ZTEGSDT203_H USING ST_ZSEGSD0009.
*     F-2．データ更新処理
PERFORM UPDATE_ZTEGSDT203_H USING ST_ZSEGSD0009
TD_ITEM_ALV
W_SYST_DATE
W_SYST_TIME.
*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.

*     更新成功のメッセージを表示する
*     データ更新しました。(購買発注 = &1)
MESSAGE S048(ZMEGSD01) WITH ST_ZSEGSD0009-BSTKD.
LEAVE TO SCREEN 0.
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDMODULE.                 " USER_COMMAND_9000  INPUT

*&---------------------------------------------------------------------*
*&      Form  GET_9000_AGAIN
*&---------------------------------------------------------------------*
*       E-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_ZSEGSD0009_INI  SCREEN9000ALV ヘッダデータ初期値
*      -->I_TD_ITEM_ALV_INI SCREEN9000明細データ初期値
*      -->I_W_DATE          システム日付
*      <--O_ZSEGSD0009      SCREEN9000ALVヘッダデータ変更値_TEM
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*----------------------------------------------------------------------*
FORM GET_9000_AGAIN USING I_ZSEGSD0009_INI  TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV_INI TYPE TYP_TD_ITEM
I_W_DATE          TYPE SY-DATUM
CHANGING O_ZSEGSD0009      TYPE TYP_ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM.

DATA:
LST_ALV_INI  TYPE ZSEGSD0010,
LW_KWMENG    TYPE EKPO-MENGE,
LW_MENG_ALV  TYPE EKPO-MENGE,
LW_NETWR     TYPE NETWR,
LW_CHANGE    TYPE C.

FIELD-SYMBOLS:
<LFS_ALV>    TYPE ZSEGSD0010,
<LFS_ALV1>   TYPE ZSEGSD0010.

* 通貨チェック
PERFORM CHK_WAERK.
* E-2-1-1．営業所のテキストの再設定処理。
IF O_ZSEGSD0009-VKBUR <> I_ZSEGSD0009_INI-VKBUR.
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = O_ZSEGSD0009-VKBUR.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-VKBUR,
O_ZSEGSD0009-ZVBEZEI.
ENDIF.
ENDIF.

* E-2-1-2．営業グループのテキストの再設定処理。
IF O_ZSEGSD0009-VKGRP <> I_ZSEGSD0009_INI-VKGRP.
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = O_ZSEGSD0009-VKGRP.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-VKGRP,
O_ZSEGSD0009-ZTBEZEI.
ENDIF.
ENDIF.

* E-2-1-3．受注先の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR1 <> I_ZSEGSD0009_INI-ZEKUNNR1.
SELECT NAME1 UP TO 1 ROWS                 " 受注先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR1.     " 受注先
EXIT.
ENDSELECT.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR1,
O_ZSEGSD0009-ZEKNAME1.
ENDIF.
ENDIF.

* E-2-1-4．出荷先の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR <> I_ZSEGSD0009_INI-ZEKUNNR.
SELECT NAME1 UP TO 1 ROWS                 " 出荷先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR.     " 出荷先
EXIT.
ENDSELECT.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR,
O_ZSEGSD0009-ZEKNAME.
ENDIF.
ENDIF.

* E-2-1-5．最終需要者の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR2 <> I_ZSEGSD0009_INI-ZEKUNNR2.
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME2       " 最終需要者名称
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR2.
" 最終需要者
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR2,
O_ZSEGSD0009-ZEKNAME2.
ENDIF.
ENDIF.

* E-2-1-6．最終需要者(商流)の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR3 <> I_ZSEGSD0009_INI-ZEKUNNR3.
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME3       " 最終需要者(商流)名称
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR3.
" 最終需要者(商流)
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR3,
O_ZSEGSD0009-ZEKNAME3.
ENDIF.
ENDIF.

* E-2-1-7．営業員の氏名の再設定処理。
IF O_ZSEGSD0009-PERNR <> I_ZSEGSD0009_INI-PERNR.
SELECT SINGLE ENAME
INTO O_ZSEGSD0009-ENAME          " 営業員の氏名
FROM PA0001
WHERE PERNR =  O_ZSEGSD0009-PERNR " 営業員
AND BEGDA <= I_W_DATE           " 開始日付
AND ENDDA >= I_W_DATE.          " 終了日付
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-PERNR,
O_ZSEGSD0009-ENAME.
ENDIF.
ENDIF.

*  E-2-2-2．明細の数量と金額項目が変更された場合、
*  受注額の再計算処理を行う。
CLEAR LW_NETWR.
LOOP AT I_TD_ITEM_ALV_INI INTO LST_ALV_INI.

READ TABLE O_TD_ITEM_ALV ASSIGNING <LFS_ALV> INDEX SY-TABIX.

IF LST_ALV_INI-KWMENG <> <LFS_ALV>-KWMENG
OR LST_ALV_INI-VRKME <> <LFS_ALV>-VRKME
OR LST_ALV_INI-ZVRKME <> <LFS_ALV>-ZVRKME.

CLEAR:
LW_KWMENG,
LW_MENG_ALV.

LW_MENG_ALV = <LFS_ALV>-KWMENG.

CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR                   = <LFS_ALV>-MATNR
I_IN_ME                   = <LFS_ALV>-VRKME
I_OUT_ME                  = <LFS_ALV>-ZVRKME
I_MENGE                   = LW_MENG_ALV
IMPORTING
E_MENGE                   = LW_KWMENG
EXCEPTIONS
ERROR_IN_APPLICATION      = 1
ERROR                     = 2
OTHERS                    = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE TO SCREEN 9000.
ELSE.
<LFS_ALV>-NETWR = LW_KWMENG
* <LFS_ALV>-NETPR
/ <LFS_ALV>-KPEIN.
ENDIF.
LW_CHANGE = ABAP_ON.
ENDIF.
LW_NETWR = <LFS_ALV>-NETWR + LW_NETWR.

ENDLOOP.

IF LW_CHANGE IS NOT INITIAL.
O_ZSEGSD0009-NETWR = LW_NETWR.
ENDIF.

*  E-2-2-3．ヘッダの通貨項目が変更された場合、
* 「FS:明細」-通貨は同様に設定
IF O_ZSEGSD0009-WAERK <> I_ZSEGSD0009_INI-WAERK.
LOOP AT O_TD_ITEM_ALV ASSIGNING <LFS_ALV1>.
<LFS_ALV1>-WAERK = O_ZSEGSD0009-WAERK.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_9000_AGAIN

*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE TYP_ZSEGSD0009.

DATA:
LW_EBELN TYPE ZTEGSDT203-EBELN.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " LOCK_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE TYP_ZSEGSD0009.

DATA:
LW_EBELN TYPE ZTEGSDT203-EBELN.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN.

ENDFORM.                    " LOCK_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       F-2．データ更新処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_H USING I_ST_ZSEGSD0009 TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
I_W_DATE        TYPE SY-DATUM
I_W_TIME        TYPE SY-UZEIT.

DATA:
LST_ALV  TYPE ZSEGSD0010,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_EBELP TYPE EBELP.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.
LW_EBELN = I_ST_ZSEGSD0009-BSTKD.
LW_EBELP = LST_ALV-POSNR.
UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2        " 処理区分
STATUS       = CNS_STATUS_A        " ステータス
VKBUR        = I_ST_ZSEGSD0009-VKBUR
" 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP
" 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1
" 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR
" 出荷先
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2
" 最終需要者
ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3
" 最終需要者(商流)
PERNR        = I_ST_ZSEGSD0009-PERNR
" 営業員
MATNR        = LST_ALV-MATNR      " 品目コード
TXZ01        = LST_ALV-ARKTX      " テキスト (短)
MENGE        = LST_ALV-KWMENG     " 購買発注量
MEINS        = LST_ALV-VRKME      " 発注単位
NETPR        = LST_ALV-NETPR      " 正味価格
WAERS        = LST_ALV-WAERK      " 通貨コード
PEINH        = LST_ALV-KPEIN      " 価格単位
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
ZTERM        = LST_ALV-ZTERM      " 支払条件キー
Z_MOD_YMD    = I_W_DATE           " 更新年月日
Z_MOD_HMS    = I_W_TIME           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新時分秒
WHERE EBELN = LW_EBELN
AND EBELP = LW_EBELP.
IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
*   データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  APP_9000_DATA
*&---------------------------------------------------------------------*
*       G.Approve
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009    SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV      SCREEN9000明細データ
*      <--O_TD_PROCESS       ITAB:ALV処理対象データ
*----------------------------------------------------------------------*
FORM APP_9000_DATA USING I_ST_ZSEGSD0009   TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV     TYPE TYP_TD_ITEM
CHANGING O_TD_PROCESS      TYPE TYP_TD_ERRALVDATA.

DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LST_ITEM_ALV  TYPE ZSEGSD0010.

LOOP AT I_TD_ITEM_ALV INTO LST_ITEM_ALV.

LST_PROCESS-VKORG     = I_ST_ZSEGSD0009-VKORG.
" 販売組織
LST_PROCESS-VTWEG     = I_ST_ZSEGSD0009-VTWEG.
" 流通チャネル
LST_PROCESS-SPART     = I_ST_ZSEGSD0009-SPART.
" 製品部門
LST_PROCESS-VKBUR     = I_ST_ZSEGSD0009-VKBUR.
" 営業所
LST_PROCESS-VKGRP     = I_ST_ZSEGSD0009-VKGRP.
" 営業グループ
LST_PROCESS-KUNNR     = I_ST_ZSEGSD0009-ZEKUNNR1.
" 受注先
LST_PROCESS-NAME1     = I_ST_ZSEGSD0009-ZEKNAME1.
" 受注先名称
LST_PROCESS-ZEKUNNR   = I_ST_ZSEGSD0009-ZEKUNNR.
" 出荷先
LST_PROCESS-ZEKNAME   = I_ST_ZSEGSD0009-ZEKNAME.
" 出荷先名称
LST_PROCESS-ZKUNNR_ZJ = I_ST_ZSEGSD0009-ZEKUNNR2.
" 最終需要者
LST_PROCESS-ZKUNNR_DS = I_ST_ZSEGSD0009-ZEKUNNR3.
" 最終需要者(商流)
LST_PROCESS-PERNR     = I_ST_ZSEGSD0009-PERNR.
" 営業員
LST_PROCESS-ZEEMNAM   = I_ST_ZSEGSD0009-ENAME.
" 営業員氏名
LST_PROCESS-BSTKD     = I_ST_ZSEGSD0009-BSTKD.
" 購買発注番号
LST_PROCESS-BSTDK     = I_ST_ZSEGSD0009-BSTDK.
" 購買発注伝票日付
LST_PROCESS-BSART     = I_ST_ZSEGSD0009-BSART.
" 購買伝票タイプ
LST_PROCESS-KNTTP     = I_ST_ZSEGSD0009-KNTTP.
" 勘定設定カテゴリ
LST_PROCESS-MATNR     = LST_ITEM_ALV-MATNR.
" 品目コード
LST_PROCESS-ARKTX     = LST_ITEM_ALV-ARKTX.
" 品目テキスト
LST_PROCESS-KWMENG    = LST_ITEM_ALV-KWMENG.
" 数量
LST_PROCESS-VRKME     = LST_ITEM_ALV-VRKME.
" 単位
LST_PROCESS-NETPR     = LST_ITEM_ALV-NETPR.
" 単価
LST_PROCESS-WAERK     = LST_ITEM_ALV-WAERK.
" 通貨
LST_PROCESS-KPEIN     = LST_ITEM_ALV-KPEIN.
" /
LST_PROCESS-ZVRKME    = LST_ITEM_ALV-ZVRKME.
" UoM
LST_PROCESS-NETWR     = LST_ITEM_ALV-NETWR.
" 受注額
LST_PROCESS-WERKS     = LST_ITEM_ALV-WERKS.
" 出荷プラント
LST_PROCESS-EDATU     = LST_ITEM_ALV-EDATU.
" 納入期日
LST_PROCESS-DZTERM    = LST_ITEM_ALV-ZTERM.
" 支払条件
LST_PROCESS-EBELP     = LST_ITEM_ALV-POSNR.
" 購買伝票の明細番号
APPEND LST_PROCESS TO O_TD_PROCESS.
CLEAR LST_PROCESS.

ENDLOOP.

ENDFORM.                    " APP_9000_DATA

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_9000
*&---------------------------------------------------------------------*
*       G-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_9000 USING I_KBUNCC        TYPE C
I_STATUS        TYPE C
I_ST_ZSEGSD0009 TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
I_W_DATE        TYPE SY-DATUM
I_W_TIME        TYPE SY-UZEIT.

DATA:
LST_ALV  TYPE ZSEGSD0010,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_EBELP TYPE EBELP.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.
LW_EBELN = I_ST_ZSEGSD0009-BSTKD.
LW_EBELP = LST_ALV-POSNR.
UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC            " 処理区分
STATUS       = I_STATUS            " ステータス
VKBUR        = I_ST_ZSEGSD0009-VKBUR
" 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP
" 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1
" 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR
" 出荷先
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2
" 最終需要者
ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3
" 最終需要者(商流)
PERNR        = I_ST_ZSEGSD0009-PERNR
" 営業員
MATNR        = LST_ALV-MATNR      " 品目コード
TXZ01        = LST_ALV-ARKTX      " テキスト (短)
MENGE        = LST_ALV-KWMENG     " 購買発注量
MEINS        = LST_ALV-VRKME      " 発注単位
NETPR        = LST_ALV-NETPR      " 正味価格
WAERS        = LST_ALV-WAERK      " 通貨コード
PEINH        = LST_ALV-KPEIN      " 価格単位
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
ZTERM        = LST_ALV-ZTERM      " 支払条件キー
Z_MOD_YMD    = I_W_DATE           " 更新年月日
Z_MOD_HMS    = I_W_TIME           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新時分秒
WHERE EBELN = LW_EBELN
AND EBELP = LW_EBELP.
IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
*   データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  FRM_F4_SHOW
*&---------------------------------------------------------------------*
*       F4　help
*----------------------------------------------------------------------*
FORM FRM_F4_SHOW.

DATA: LTD_RETURN TYPE TABLE OF DDSHRETVAL,
LST_RETURN TYPE DDSHRETVAL,
L_ROW      TYPE I,
LST_STAB   TYPE LVC_S_STBL,
LTD_ZTERM  TYPE STANDARD TABLE OF TYP_ZTERM,
LST_ZTERM  TYPE TYP_ZTERM,
LST_ITEM   TYPE ZSEGSD0010.

SELECT ZTERM
TEXT1
FROM T052U
INTO TABLE LTD_ZTERM.

APPEND INITIAL LINE TO LTD_ZTERM.

CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
EXPORTING
RETFIELD        = CNS_FNM_ZTERM
VALUE_ORG       = 'S'
TABLES
VALUE_TAB       = LTD_ZTERM
RETURN_TAB      = LTD_RETURN
EXCEPTIONS
PARAMETER_ERROR = 1
NO_VALUES_FOUND = 2
OTHERS          = 3.
* エラー
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
READ TABLE LTD_RETURN INTO LST_RETURN INDEX 1.
IF SY-SUBRC = 0.
CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
E_ROW         = L_ROW.

READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX L_ROW.
IF SY-SUBRC = 0.
CLEAR LST_ZTERM.
READ TABLE LTD_ZTERM INTO LST_ZTERM
WITH KEY ZTERM = LST_RETURN-FIELDVAL.
LST_ITEM-ZTERM = LST_RETURN-FIELDVAL.
LST_ITEM-TEXT1 = LST_ZTERM-TEXT1.
MODIFY TD_ITEM_ALV FROM LST_ITEM INDEX L_ROW.
ENDIF.

LST_STAB-ROW = ABAP_ON.
LST_STAB-COL = ABAP_ON.
CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY
EXPORTING
IS_STABLE          = LST_STAB.
ENDIF.
ENDIF.

ENDFORM.                    " FRM_F4_SHOW
*&---------------------------------------------------------------------*
*&      Module  COMMAND_EXIT　INPUT
*&---------------------------------------------------------------------*
*       EXIT 事件
*----------------------------------------------------------------------*
MODULE COMMAND_EXIT INPUT.

CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
IF SY-DATAR = ABAP_ON.
W_CHANGED = ABAP_ON.
ENDIF.
IF LW_VALID IS INITIAL
OR W_CHANGED IS NOT INITIAL
OR TD_ITEM_ALV <> TD_ITEM_ALV_INI.
*   終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.
*   POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ELSEIF LW_ANSWER = 1.
LEAVE TO SCREEN 0.
CLEAR W_CHANGED.
ENDIF.
ENDIF.

CASE OK_CODE.
WHEN CNS_USER_BACK.
IF TD_ITEM_ALV_INI = TD_ITEM_ALV.
LEAVE TO SCREEN 0.
ELSE.
*       終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.
*       POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ELSEIF LW_ANSWER = 1.
LEAVE TO SCREEN 0.
ENDIF.
ENDIF.
WHEN CNS_USER_EXIT.
IF TD_ITEM_ALV_INI = TD_ITEM_ALV.
LEAVE TO SCREEN 0.
ELSE.
*       終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.
*       POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ELSEIF LW_ANSWER = 1.
LEAVE TO SCREEN 0.
ENDIF.
ENDIF.
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDMODULE.                 " COMMAND_EXIT  INPUT
*&---------------------------------------------------------------------*
*&      Form  CHK_WAERK
*&---------------------------------------------------------------------*
*       通貨チェック
*----------------------------------------------------------------------*
FORM CHK_WAERK .

SELECT COUNT(*)
FROM TCURC
WHERE WAERS = ST_ZSEGSD0009-WAERK.
IF SY-SUBRC <> 0.
*    通貨コード & は存在しません
MESSAGE S641(Z1) WITH ST_ZSEGSD0009-WAERK
DISPLAY LIKE CNS_MSG_E.
SET CURSOR FIELD 'ST_ZSEGSD0009-WAERK'.
LEAVE TO SCREEN 9000.
ENDIF.

ENDFORM.                    " CHK_WAERK

MODULE M_CHECK.
V_FLG = ABAP_ON.

ENDMODULE.
*Text symbol text・
*B01:Delete
*B02:YES
*B03:NO
*B04:Confirm
*P01:Approved List (Sales Order are not created yet.)
*Selection text・
*P_VKORG:        Sales Organization
*RB_APP:        Approve
*RB_ERR:        Error recovery
*RB_LIST:        Appr. List(SO are not created)
*S_DATE:        Create Date
*S_SPART:        Division
*S_VKBUR:        Sales Office
*S_VKGRP:        Sales Group
*S_VTWEG:        Distribution Channel
*&---------------------------------------------------------------------*
*& プログラムID : ZEGSDR2020
*& 作成者       : iSiD 万
*& 作成日       : 2014/10/27
*& 処理概要     : 1.抽出条件を元に承認待ちの受注データを取得する。
*&                2.受注情報を変更し、一時保存と承認できること。
*&                3.受注自動登録ジョブエラーを最小限にするため、
*&                  承認する際に出来る限りにチェックを行い。
*&                4.リカバリを考慮し、エラーになった受注データを
*&                  一覧に表示し変更再承認できること。
*&                5.エラーデータをリカバリするため、オンライン
*&                  ALVで登録済とエラー一覧を確認する。
*&                6.承認済一覧（受注自動登録未）を確認できること。
*&---------------------------------------------------------------------*
*& 改定履歴
*& No   DATE       MODIFYED BY   SUMMARY
*&
*&---------------------------------------------------------------------*
REPORT  YEGSDR2020 NO STANDARD PAGE HEADING.

*&----------------------------------------------------------------------
* 定数の宣言
*&----------------------------------------------------------------------
CONSTANTS:
CNS_KBUNCC_1(1) TYPE C VALUE '1',           " 受発注連携
CNS_KBUNCC_2(1) TYPE C VALUE '2',           " 受注承認
CNS_KBUNCC_3(1) TYPE C VALUE '3',           " 受注登録
CNS_STATUS_A(1) TYPE C VALUE 'A',           " 処理中
CNS_STATUS_E(1) TYPE C VALUE 'E',           " エラー
CNS_STATUS_C(1) TYPE C VALUE 'C',           " 完了
CNS_STATUS_D(1) TYPE C VALUE 'D',           " 削除
CNS_MSG_E       TYPE SY-MSGTY VALUE 'E',    " 信息#型:E
CNS_MSG_S       TYPE SY-MSGTY VALUE 'S',    " 信息#型:S
CNS_PAR_SH      TYPE PARVW    VALUE 'SH',   " 取引先機能:Sh
CNS_PAR_PE      TYPE PARVW    VALUE 'PE',   " 取引先機能:PE
CNS_TABLENM(10) TYPE C VALUE 'ZTEGSDT203',  " 表名;ZTEGSDT203
CNS_STNM008     TYPE TABNAME VALUE 'ZSEGSD0008',
" 構造名;ZSEGSD0008
CNS_STNM010     TYPE TABNAME VALUE 'ZSEGSD0010',
" 構造名;ZSEGSD0010
CNS_STNM011     TYPE TABNAME VALUE 'ZSEGSD0011',
" 構造名;ZSEGSD0011
CNS_PF_STATUS   TYPE SLIS_FORMNAME VALUE 'SET_STATUS',
" ALVステータス
CNS_USER_CMD    TYPE SLIS_FORMNAME VALUE 'USER_COMMAND',
" ALVユーザの事件
CNS_USER_APP    TYPE SY-UCOMM      VALUE 'APP',
" 承認事件
CNS_USER_MOD    TYPE SY-UCOMM      VALUE 'MODI',
" 変更事件
CNS_USER_DEL    TYPE SY-UCOMM      VALUE 'DEL',
" 削除事件
CNS_USER_BACK   TYPE SY-UCOMM      VALUE 'BACK',
" 返回事件
CNS_USER_EXIT   TYPE SY-UCOMM      VALUE 'EXIT',
" 退出事件
CNS_USER_ENTR   TYPE SY-UCOMM      VALUE 'ENTR',
" ENTR事件
CNS_USER_SAPP   TYPE SY-UCOMM      VALUE 'SAPP',
" SCREEN9000承認事件
CNS_USER_SHOD   TYPE SY-UCOMM      VALUE 'SHOD',
" SCREEN9000保存事件
CNS_USER_SAVE   TYPE SY-UCOMM      VALUE 'SAVE',
" SCREEN9000保存事件

CNS_ROLE_SP     TYPE PARVW         VALUE 'AG',
" 受注先: SP
CNS_ROLE_SH     TYPE PARVW         VALUE 'WE',
" 出荷先: SH
CNS_ROLE_PE     TYPE PARVW         VALUE 'VE',
" 営業員: PE
CNS_ROLE_ZJ     TYPE PARVW         VALUE 'ZJ',
" 最終需要者: ZJ
CNS_ROLE_ZC     TYPE PARVW         VALUE 'ZC',
" 最終需要者(商流): ZC
CNS_LINE_01     TYPE ETENR         VALUE 1, " 納入日程行:0001
CNS_COND_ZPR0   TYPE KSCHA         VALUE 'ZPR0',
" 条件タイプ:ZPR0
CNS_CONTA(7)    TYPE C             VALUE 'ALVCONT',
" SCREEN9000の容器名
CNS_FNM_WAERK   TYPE LVC_FNAME     VALUE 'WAERK',
" 通貨
CNS_FNM_NETWR   TYPE LVC_FNAME     VALUE 'NETWR',
" 受注額
CNS_FNM_TEXT1   TYPE LVC_FNAME     VALUE 'TEXT1',
" 支払条件テキスト
CNS_FNM_ZTERM   TYPE LVC_FNAME     VALUE 'ZTERM',
" 支払条件
CNS_FNM_POSNR   TYPE LVC_FNAME     VALUE 'POSNR',
" 販売伝票明細
CNS_FNM_MATNR   TYPE LVC_FNAME     VALUE 'MATNR',
" 品目コード
CNS_FNM_ARKTX   TYPE LVC_FNAME     VALUE 'ARKTX',
" 受注明細のテキスト (短)
CNS_FNM_KWMENG  TYPE LVC_FNAME     VALUE 'KWMENG',
" 累積受注数量
CNS_FNM_VRKME   TYPE LVC_FNAME     VALUE 'VRKME',
" 販売単位
CNS_FNM_NETPR   TYPE LVC_FNAME     VALUE 'NETPR',
" 正味価格
CNS_FNM_KPEIN   TYPE LVC_FNAME     VALUE 'KPEIN',
" 価格条件単位
CNS_FNM_ZVRKME  TYPE LVC_FNAME     VALUE 'ZVRKME',
" 販売単位
CNS_FNM_WERKS  TYPE LVC_FNAME      VALUE 'WERKS',
" プラント
CNS_FNM_EDATU  TYPE LVC_FNAME      VALUE 'EDATU'.
" 納入日程日付
*&----------------------------------------------------------------------
* 型定義
*&----------------------------------------------------------------------
TYPES:
* 販売エリア構造
BEGIN OF TYP_TVTA,
VKORG TYPE TVTA-VKORG,                    " 販売組織
VTWEG TYPE TVTA-VTWEG,                    " 流通チャネル
SPART TYPE TVTA-SPART,                    " 製品部門
END OF TYP_TVTA,

* 承認一覧構造
BEGIN OF TYP_ZTEGSDT203,
VKORG     TYPE ZTEGSDT203-VKORG,          " 販売組織
VTWEG     TYPE ZTEGSDT203-VTWEG,          " 流通チャネル
SPART     TYPE ZTEGSDT203-SPART,          " 製品部門
VKBUR     TYPE ZTEGSDT203-VKBUR,          " 営業所
VKGRP     TYPE ZTEGSDT203-VKGRP,          " 営業グループ
KUNNR     TYPE ZTEGSDT203-KUNNR,          " 受注先
NAME1     TYPE KNA1-NAME1,                " 名称1
MATNR     TYPE ZTEGSDT203-MATNR,          " 品目コード
TXZ01     TYPE ZTEGSDT203-TXZ01,          " テキスト (短)
MENGE     TYPE ZTEGSDT203-MENGE,          " 購買発注量
MEINS     TYPE ZTEGSDT203-MEINS,          " 発注単位
NETPR     TYPE ZTEGSDT203-NETPR,          " 正味価格
WAERS     TYPE ZTEGSDT203-WAERS,          " 通貨コード
PEINH     TYPE ZTEGSDT203-PEINH,          " 価格単位
BPRME     TYPE ZTEGSDT203-BPRME,          " 購買発注価格単位
NETWR     TYPE ZTEGSDT203-NETWR,          " 正味発注額
DWERK     TYPE ZTEGSDT203-DWERK,          " 出荷プラント
ZKUNNR_S  TYPE ZTEGSDT203-ZKUNNR_S,       " 出荷先
ZNAME1    TYPE KNA1-NAME1,                " 出荷先名称
EINDT     TYPE ZTEGSDT203-EINDT,          " 明細納入期日
ZTERM     TYPE ZTEGSDT203-ZTERM,          " 支払条件キー
EBELN     TYPE ZTEGSDT203-EBELN,          " 購買伝票番号
AEDAT     TYPE ZTEGSDT203-AEDAT,          " レコード登録日
MSGTX     TYPE ZTEGSDT203-MSGTX,          " メッセージテキスト
PERNR     TYPE ZTEGSDT203-PERNR,          " 営業員
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,      " 最終需要者
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS,      " 最終需要者(商流)
EBELP     TYPE ZTEGSDT203-EBELP,          " 購買伝票の明細番号
KNTTP     TYPE ZTEGSDT203-KNTTP,          " 勘定設定カテゴリ
BSART     TYPE ZTEGSDT203-BSART,          " 購買伝票タイプ
ENAME     TYPE PA0001-ENAME,              " 応募者氏名
END OF TYP_ZTEGSDT203,

* HR マスタレコード構造
BEGIN OF TYP_PA0001,
PERNR TYPE PA0001-PERNR,                  " 営業員
ENAME TYPE PA0001-ENAME,                  " 応募者氏名
END OF TYP_PA0001,

* 得意先マスタ構造
BEGIN OF TYP_KNVP,
KUNNR TYPE KNVP-KUNNR,                    " 得意先コード
VKORG TYPE KNVP-VKORG,                    " 販売組織
VTWEG TYPE KNVP-VTWEG,                    " 流通チャネル
SPART TYPE KNVP-SPART,                    " 製品部門
KUNN2 TYPE KNVP-KUNN2,                    " 取引先の得意先コード
NAME1 TYPE KNA1-NAME1,                    " 名称1
END OF TYP_KNVP,

* 最終需要者の情報構造
BEGIN OF TYP_ZTEGSDT204,
MATNR     TYPE ZTEGSDT204-MATNR,          " 品目コード
VKORG     TYPE TVKO-VKORG,                " 販売組織
ZKUNNR_ZJ TYPE ZTEGSDT204-ZKUNNR_ZJ,      " 最終需要者
ZKUNNR_DS TYPE ZTEGSDT204-ZKUNNR_DS,      " 最終需要者(商流)
END OF TYP_ZTEGSDT204,

* 営業員情報構造
BEGIN OF TYP_ENAME,
KUNNR     TYPE KNVP-KUNNR,                " 得意先コード
VKORG     TYPE KNVP-VKORG,                " 販売組織
VTWEG     TYPE KNVP-VTWEG,                " 流通チャネル
SPART     TYPE KNVP-SPART,                " 製品部門
KUNN2     TYPE KNVP-KUNN2,                " 取引先の得意先コード
ENAME     TYPE PA0001-ENAME,              " 従業員氏名
END OF TYP_ENAME,

* 出荷プラントの情報構造
BEGIN OF TYP_KNVV,
KUNNR     TYPE KNVV-KUNNR,                " 得意先コード
VKORG     TYPE KNVV-VKORG,                " 販売組織
VTWEG     TYPE KNVV-VTWEG,                " 流通チャネル
SPART     TYPE KNVV-SPART,                " 製品部門
VWERK     TYPE KNVV-VWERK,                " 出荷プラント
END OF TYP_KNVV,

* 承認一覧構造
BEGIN OF TYP_APP_ALVDATA.
TYPES:EBELP     TYPE ZTEGSDT203-EBELP,
KNTTP     TYPE ZTEGSDT203-KNTTP,
BSART     TYPE ZTEGSDT203-BSART,
PERNR     TYPE ZTEGSDT203-PERNR,
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS.
INCLUDE TYPE ZSEGSD0008.
TYPES:CHK(1)    TYPE C,
END OF TYP_APP_ALVDATA,

* エラー一覧構造
BEGIN OF TYP_ERR_ALVDATA.
TYPES:EBELP     TYPE ZTEGSDT203-EBELP,
KNTTP     TYPE ZTEGSDT203-KNTTP,
BSART     TYPE ZTEGSDT203-BSART,
PERNR     TYPE ZTEGSDT203-PERNR,
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS.
INCLUDE TYPE ZSEGSD0011.
TYPES:CHK(1)    TYPE C,
END OF TYP_ERR_ALVDATA,

* 処理対象データTEMP構造
BEGIN OF TYP_TEM_ALVDATA,
BSTKD     TYPE ZSEGSD0011-BSTKD,          " 得意先発注番号
EBELP     TYPE ZTEGSDT203-EBELP,          " 購買伝票の明細番号
VKORG     TYPE ZSEGSD0011-VKORG,          " 販売組織
VTWEG     TYPE ZSEGSD0011-VTWEG,          " 流通チャネル
SPART     TYPE ZSEGSD0011-SPART,          " 製品部門
VKBUR     TYPE ZSEGSD0011-VKBUR,          " 営業所
VKGRP     TYPE ZSEGSD0011-VKGRP,          " 営業グループ
KUNNR     TYPE ZSEGSD0011-KUNNR,          " 得意先コード
NAME1     TYPE ZSEGSD0011-NAME1,          " 名称 1
MATNR     TYPE ZSEGSD0011-MATNR,          " 品目コード
ARKTX     TYPE ZSEGSD0011-ARKTX,          " 受注明細のテキスト (短)
KWMENG    TYPE ZSEGSD0011-KWMENG,         " 累積受注数量 (販売単位)
VRKME     TYPE ZSEGSD0011-VRKME,          " 販売単位
NETPR     TYPE ZSEGSD0011-NETPR,          " 正味価格
WAERK     TYPE ZSEGSD0011-WAERK,          " 販売伝票通貨
KPEIN     TYPE ZSEGSD0011-KPEIN,          " 価格条件単位
ZVRKME    TYPE ZSEGSD0011-ZVRKME,         " 販売単位
NETWR     TYPE ZSEGSD0011-NETWR,          " 正味価格
WERKS     TYPE ZSEGSD0011-WERKS,          " プラント(自社または外部)
ZEKUNNR   TYPE ZSEGSD0011-ZEKUNNR,        " 出荷先
ZEKNAME   TYPE ZSEGSD0011-ZEKNAME,        " 出荷先名称
EDATU     TYPE ZSEGSD0011-EDATU,          " 納入日程日付
ZEEMNAM   TYPE ZSEGSD0011-ZEEMNAM,        " 従業員名称
DZTERM    TYPE ZSEGSD0011-DZTERM,         " 支払条件キー
BSTDK     TYPE ZSEGSD0011-BSTDK,          " 得意先発注日付
MSGTX     TYPE ZSEGSD0011-MSGTX,          " メッセージテキスト
BSART     TYPE ZTEGSDT203-BSART,          " 購買伝票タイプ
KNTTP     TYPE ZTEGSDT203-KNTTP,          " 勘定設定カテゴリ
PERNR     TYPE ZTEGSDT203-PERNR,          " 営業員
ZKUNNR_ZJ TYPE ZTEGSDT203-ZKUNNR_ZJ,      " 最終需要者
ZKUNNR_DS TYPE ZTEGSDT203-ZKUNNR_DS,      " 最終需要者(商流)
END OF TYP_TEM_ALVDATA,

* 販売伝票タイプ構造
BEGIN OF TYP_DATA_205,
BSART TYPE ZTEGSDT205-BSART,              " 購買伝票タイプ
KNTTP TYPE ZTEGSDT205-KNTTP,              " 勘定設定カテゴリ
AUART TYPE ZTEGSDT205-AUART,              " 販売伝票タイプ
AUGRU TYPE ZTEGSDT205-AUGRU,              " 受注理由
BEZEI TYPE TVAKT-BEZEI,                   " 販売伝票タイプテキスト
END OF TYP_DATA_205,

BEGIN OF TYP_TVAKT,
AUART TYPE TVAKT-AUART,                   " 販売伝票タイプ
BEZEI TYPE TVAKT-BEZEI,                   " 販売伝票タイプテキスト
END OF TYP_TVAKT,

BEGIN OF TYP_ZSEGSD0009.
INCLUDE TYPE ZSEGSD0009.
TYPES:KNTTP     TYPE ZTEGSDT203-KNTTP,
BSART     TYPE ZTEGSDT203-BSART,
END OF TYP_ZSEGSD0009,

BEGIN OF TYP_ZTERM,
ZTERM TYPE T052U-ZTERM,                   " 支払条件キー
TEXT1 TYPE T052U-TEXT1,                   " 支払条件の固有テキスト
END OF TYP_ZTERM,
* テーブル参照
TYP_TD_TVTA       TYPE STANDARD TABLE OF TYP_TVTA,
TYP_TD_ZTEGSDT203 TYPE STANDARD TABLE OF TYP_ZTEGSDT203,
TYP_TD_APPALVDATA TYPE STANDARD TABLE OF TYP_APP_ALVDATA,
TYP_TD_ERRALVDATA TYPE STANDARD TABLE OF TYP_ERR_ALVDATA,
TYP_TD_ALVDATA    TYPE STANDARD TABLE OF TYP_TEM_ALVDATA,
TYP_TD_205        TYPE STANDARD TABLE OF TYP_DATA_205,
TYP_TD_ITEM       TYPE STANDARD TABLE OF ZSEGSD0010.

*&----------------------------------------------------------------------
* 変数の定義
*&----------------------------------------------------------------------
DATA:
W_SYST_DATE    TYPE SY-DATUM,               " システム日付
W_SYST_TIME    TYPE SY-UZEIT,               " システム時刻
OK_CODE        TYPE SY-UCOMM.               " Dynproのオーケーコード
DATA V_FLG TYPE C.
* 選択画面定義用変数
DATA:
W_VTWEG    TYPE VBAK-VTWEG,                 " 流通チャネル
W_SPART    TYPE VBAK-SPART,                 " 製品部門
W_VKBUR    TYPE VBAK-VKBUR,                 " 営業所
W_VKGRP    TYPE VBAK-VKGRP,                 " 営業グループ
W_ZECREYMD TYPE ZECREYMD,                   " 登録日付
W_CHANGED  TYPE C.

* SCREEN9000ヘッダ部
DATA:
ST_ZSEGSD0009     TYPE TYP_ZSEGSD0009,
ST_ZSEGSD0009_INI TYPE TYP_ZSEGSD0009.
*&----------------------------------------------------------------------
* 作業領域定義
*&----------------------------------------------------------------------

*&----------------------------------------------------------------------
* 内部テーブル定義
*&----------------------------------------------------------------------
DATA:
TD_TVTA         TYPE STANDARD TABLE OF TYP_TVTA,
TD_APP_ALV      TYPE TYP_TD_APPALVDATA,
TD_ERR_ALV      TYPE TYP_TD_ERRALVDATA,
TD_ITEM_ALV     TYPE TYP_TD_ITEM,
TD_ITEM_ALV_INI TYPE TYP_TD_ITEM.

* レンジテーブル
DATA:
RD_VTWEG TYPE RANGE OF TVTW-VTWEG,          " 流通チャネル
RD_SPART TYPE RANGE OF TSPA-SPART,          " 製品部門
RD_VKBUR TYPE RANGE OF TVBUR-VKBUR,         " 営業所
RD_VKGRP TYPE RANGE OF TVKGR-VKGRP.         " 営業グループ

*&----------------------------------------------------------------------
* クラスインタフェース
*&----------------------------------------------------------------------
DATA:
CI_ALV                 TYPE REF TO CL_GUI_ALV_GRID,
CI_CCONTAINER          TYPE REF TO CL_GUI_CUSTOM_CONTAINER.

*&----------------------------------------------------------------------
* クラス定義
*&----------------------------------------------------------------------
CLASS:
CL_EVENT_RECEIVER DEFINITION DEFERRED.

*&----------------------------------------------------------------------
* 選択画面定義(1000)
*&----------------------------------------------------------------------
PARAMETERS:
P_VKORG    TYPE VBAK-VKORG MODIF ID VKO OBLIGATORY.
" 販売組織
SELECT-OPTIONS:
S_VTWEG    FOR  W_VTWEG MODIF ID VTW,       " 流通チャネル
S_SPART    FOR  W_SPART MODIF ID SPA,       " 製品部門
S_VKBUR    FOR  W_VKBUR MODIF ID VKB,       " 営業所
S_VKGRP    FOR  W_VKGRP,                    " 営業グループ
S_DATE     FOR  W_ZECREYMD.                 " 登録日付

PARAMETERS:
RB_APP   RADIOBUTTON GROUP RB1 DEFAULT 'X', " 承認一覧
RB_ERR   RADIOBUTTON GROUP RB1.             " リカバリ一覧
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS:
RB_LIST  RADIOBUTTON GROUP RB1.        " 承認済一覧（販売伝票未作成）
SELECTION-SCREEN COMMENT 2(48) TEXT-P01 FOR FIELD RB_LIST.
SELECTION-SCREEN END OF LINE.

*----------------------------------------------------------------------*
* AT SELETION-SCREEN
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
* A-1-1．入力チェック
PERFORM CHECK_INPUT.
* A-1-2．整合性チェック
* A-1-2-1．販売エリアの整合性チェック
PERFORM CHECK_TVTA CHANGING TD_TVTA.
* A-1-3．権限チェック
PERFORM CHECK_TVTA_AUTH CHANGING TD_TVTA.

*----------------------------------------------------------------------*
* START-OF-SELECTION
*----------------------------------------------------------------------*
START-OF-SELECTION.

W_SYST_DATE = SY-DATUM.                     "システム日付
W_SYST_TIME = SY-UZEIT.                     "システム時刻

* 主処理
PERFORM MAIN_PROCESS USING W_SYST_DATE.

*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       A-1-1．入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT .

* A-1-1-1．販売組織(Sales Organization)存在チェック
PERFORM CHECK_VKORG.

* A-1-1-2．流通チャネル(Distribution Channel)存在チェック
PERFORM CHECK_VTWEG.

* A-1-1-3． 販売部門(Division)存在チェック
PERFORM CHECK_SPART.

* A-1-1-4．営業所(Sales Office)存在チェック
PERFORM CHECK_VKBUR.

* A-1-1-5．営業グループ(Sales Group)存在チェック
PERFORM CHECK_VKGRP.

ENDFORM.                    " CHECK_INPUT

*&---------------------------------------------------------------------*
*&      Form  CHECK_VKORG
*&---------------------------------------------------------------------*
*       A-1-1-1．販売組織(Sales Organization)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKORG .

SELECT COUNT(*)
FROM TVKO
WHERE VKORG = P_VKORG.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_VKORG'.
MESSAGE E039(ZMEGSD01) WITH P_VKORG.
*   #售##( &1 )不存在
ENDIF.

ENDFORM.                    " CHECK_VKORG

*&---------------------------------------------------------------------*
*&      Form  CHECK_VTWEG
*&---------------------------------------------------------------------*
*       A-1-1-2．流通チャネル(Distribution Channel)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VTWEG .

TYPES: BEGIN OF LTYP_VTWEG,
VTWEG TYPE TVTW-VTWEG,
END OF LTYP_VTWEG.

DATA: LTD_VTWEG   TYPE STANDARD TABLE OF LTYP_VTWEG,
LST_VTWEG   TYPE LTYP_VTWEG,
LST_VTWEG_R LIKE LINE OF RD_VTWEG.

SELECT VTWEG
INTO TABLE LTD_VTWEG
FROM TVTW
WHERE VTWEG IN S_VTWEG.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VTWEG-LOW'.
MESSAGE E040(ZMEGSD01) WITH S_VTWEG-LOW.
*   流通チャネル&1は存在しません
ENDIF.

REFRESH RD_VTWEG.
LOOP AT LTD_VTWEG INTO LST_VTWEG.
LST_VTWEG_R-SIGN = 'I'.
LST_VTWEG_R-OPTION = 'EQ'.
LST_VTWEG_R-LOW = LST_VTWEG-VTWEG.
APPEND LST_VTWEG_R TO RD_VTWEG.
CLEAR LST_VTWEG_R.
ENDLOOP.

ENDFORM.                    " CHECK_VTWEG

*&---------------------------------------------------------------------*
*&      Form  CHECK_SPART
*&---------------------------------------------------------------------*
*       A-1-1-3． 販売部門(Division)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_SPART .

TYPES: BEGIN OF LTYP_SPART,
SPART TYPE TSPA-SPART,
END OF LTYP_SPART.

DATA: LTD_SPART   TYPE STANDARD TABLE OF LTYP_SPART,
LST_SPART   TYPE LTYP_SPART,
LST_SPART_R LIKE LINE OF RD_SPART.

SELECT SPART
INTO TABLE LTD_SPART
FROM TSPA
WHERE SPART IN S_SPART.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_SPART-LOW'.
MESSAGE E041(ZMEGSD01) WITH S_SPART-LOW.
*   製品部門&1は存在しません
ENDIF.

REFRESH RD_SPART.
LOOP AT LTD_SPART INTO LST_SPART.
LST_SPART_R-SIGN = 'I'.
LST_SPART_R-OPTION = 'EQ'.
LST_SPART_R-LOW = LST_SPART-SPART.
APPEND LST_SPART_R TO RD_SPART.
CLEAR LST_SPART_R.
ENDLOOP.

ENDFORM.                    " CHECK_SPART

*&---------------------------------------------------------------------*
*&      Form  CHECK_VKBUR
*&---------------------------------------------------------------------*
*       A-1-1-4．営業所(Sales Office)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKBUR .

TYPES: BEGIN OF LTYP_VKBUR,
VKBUR TYPE TVBUR-VKBUR,
END OF LTYP_VKBUR.

DATA: LTD_VKBUR   TYPE STANDARD TABLE OF LTYP_VKBUR,
LST_VKBUR   TYPE LTYP_VKBUR,
LST_VKBUR_R LIKE LINE OF RD_VKBUR.

SELECT VKBUR
INTO TABLE LTD_VKBUR
FROM TVBUR
WHERE VKBUR IN S_VKBUR.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKBUR-LOW'.
MESSAGE E042(ZMEGSD01) WITH S_VKBUR-LOW.
*   営業所&1は存在しません
ENDIF.

REFRESH RD_VKBUR.
LOOP AT LTD_VKBUR INTO LST_VKBUR.
LST_VKBUR_R-SIGN = 'I'.
LST_VKBUR_R-OPTION = 'EQ'.
LST_VKBUR_R-LOW = LST_VKBUR-VKBUR.
APPEND LST_VKBUR_R TO RD_VKBUR.
CLEAR LST_VKBUR_R.
ENDLOOP.

ENDFORM.                    " CHECK_VKBUR

*&---------------------------------------------------------------------*
*&      Form  CHECK_VKGRP
*&---------------------------------------------------------------------*
*       A-1-1-5．営業グループ(Sales Group)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKGRP .

TYPES: BEGIN OF LTYP_VKGRP,
VKGRP TYPE TVKGR-VKGRP,
END OF LTYP_VKGRP.

DATA: LTD_VKGRP   TYPE STANDARD TABLE OF LTYP_VKGRP,
LST_VKGRP   TYPE LTYP_VKGRP,
LST_VKGRP_R LIKE LINE OF RD_VKGRP.

SELECT VKGRP
INTO TABLE LTD_VKGRP
FROM TVKGR
WHERE VKGRP IN S_VKGRP.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKGRP-LOW'.
MESSAGE E043(ZMEGSD01) WITH S_VKGRP-LOW.
*   営業グループ&1は存在しません
ENDIF.

REFRESH RD_VKGRP.
LOOP AT LTD_VKGRP INTO LST_VKGRP.
LST_VKGRP_R-SIGN = 'I'.
LST_VKGRP_R-OPTION = 'EQ'.
LST_VKGRP_R-LOW = LST_VKGRP-VKGRP.
APPEND LST_VKGRP_R TO RD_VKGRP.
CLEAR LST_VKGRP_R.
ENDLOOP.

ENDFORM.                    " CHECK_VKGRP

*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA
*&---------------------------------------------------------------------*
*       A-1-2-1．販売エリアの整合性チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.


SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
INTO TABLE O_TD_TVTA
FROM TVTA
WHERE VKORG =  P_VKORG                     " 販売組織
AND VTWEG IN S_VTWEG                     " 流通チャネル
AND SPART IN S_SPART.                    " 製品部門

IF SY-SUBRC <> 0.
MESSAGE E044(ZMEGSD01).
*   指定された販売エリアの整合性がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA

*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA_AUTH
*&---------------------------------------------------------------------*
*       A-1-3．権限チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA_AUTH CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.

DATA:
LST_TVTA  TYPE TYP_TVTA,
LW_ERR(1) TYPE C.

LOOP AT O_TD_TVTA INTO LST_TVTA.
AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
ID 'VKORG' FIELD LST_TVTA-VKORG
ID 'VTWEG' FIELD LST_TVTA-VTWEG
ID 'SPART' FIELD LST_TVTA-SPART
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.
LW_ERR = ABAP_ON.
DELETE O_TD_TVTA.
ENDIF.
ENDLOOP.
IF LW_ERR IS NOT INITIAL
AND O_TD_TVTA IS INITIAL.
MESSAGE E038(ZMEGSD01).
*   販売エリアに対する実行権限がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA

*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*----------------------------------------------------------------------*
FORM MAIN_PROCESS USING I_W_DATE    TYPE SY-DATUM.

DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203.

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
*     A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203.
*     A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.
*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
*     A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203.
*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.
*     A-2-3-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN1 USING I_W_DATE
TD_TVTA
CHANGING LTD_ZTEGSDT203.
WHEN OTHERS.
ENDCASE.

* A-3．画面出力
PERFORM ALV_OUTPUT USING LTD_ZTEGSDT203.

ENDFORM.                    " MAIN_PROCESS

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN
*&---------------------------------------------------------------------*
*       以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*      -->I_KBUNCC_F       処理区分1
*      -->I_STATUS_F       ステータス1
*      -->I_KBUNCC_S       処理区分2
*      -->I_STATUS_S       ステータス2
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN  USING I_W_DATE       TYPE SY-DATUM
I_KBUNCC_F     TYPE C
I_STATUS_F     TYPE C
I_KBUNCC_S     TYPE C
I_STATUS_S     TYPE C
I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
ZTEGSDT203~MATNR                     " 品目コード
ZTEGSDT203~TXZ01                     " テキスト (短)
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1                         " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~PERNR                     " 営業員
ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
INTO TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG
" 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART
" 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ( ( ZTEGSDT203~ZKBUNCC    = I_KBUNCC_F
" 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_F )
" ステータス
OR ( ZTEGSDT203~ZKBUNCC  = I_KBUNCC_S
" 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_S ) ).
" ステータス
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.
ELSE.
LTD_SDT203 = O_TD_SDT203.
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= I_W_DATE                  " 開始日付
AND ENDDA >= I_W_DATE.                 " 終了日付

IF SY-SUBRC = 0.
SORT LTD_PA0001 BY PERNR ASCENDING.     " 営業員
ENDIF.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.
<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.
" 応募者氏名
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN

*&---------------------------------------------------------------------*
*&      Form  EDIT_DATA_MAIN
*&---------------------------------------------------------------------*
*       A-2-1-2．承認一覧の関連情報を取得
*----------------------------------------------------------------------*
*      -->I_KBUNCC_F     処理区分1
*      -->I_STATUS_F     ステータス1
*      -->I_KBUNCC_S     処理区分2
*      -->I_STATUS_S     ステータス2
*      -->I_TD_TVTA      ITAB:販売エリア
*      <--O_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM EDIT_DATA_MAIN CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.

DATA:
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LTD_KNVP   TYPE STANDARD TABLE OF TYP_KNVP,
LST_KNVP   TYPE TYP_KNVP,
LTD_SDT204 TYPE STANDARD TABLE OF TYP_ZTEGSDT204,
LST_SDT204 TYPE TYP_ZTEGSDT204,
LTD_ENAME  TYPE STANDARD TABLE OF TYP_ENAME,
LST_ENAME  TYPE TYP_ENAME,
LTD_KNVV   TYPE STANDARD TABLE OF TYP_KNVV,
LST_KNVV   TYPE TYP_KNVV.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.

*   A-2-1-2-1．出荷先の情報の検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門
DELETE LTD_SDT203
WHERE ZKUNNR_S IS NOT INITIAL.         " Ship-to

IF LTD_SDT203 IS NOT INITIAL.
SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~KUNN2                     " 取引先の得意先コード
KNA1~NAME1                     " 名称1
FROM KNVP
INNER JOIN KNA1
ON KNVP~KUNN2 = KNA1~KUNNR        " 取引先の得意先コード
INTO TABLE LTD_KNVP                 " ITAB:得意先マスタ
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = CNS_PAR_SH.       " 取引先機能
IF SY-SUBRC = 0.
SORT LTD_KNVP BY KUNNR ASCENDING  " 得意先コード
VKORG ASCENDING  " 販売組織
VTWEG ASCENDING  " 流通チャネル
SPART ASCENDING. " 製品部門
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-2．最終需要者の情報を検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.
SORT LTD_SDT203 BY MATNR ASCENDING      " 品目コード
VKORG ASCENDING.     " 販売組織
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING MATNR   " 品目コード
VKORG.  " 販売組織
DELETE LTD_SDT203 WHERE ZKUNNR_ZJ IS NOT INITIAL.
IF LTD_SDT203 IS NOT INITIAL.
SELECT ZTEGSDT204~MATNR               " 品目コード
TVKO~VKORG                     " 販売組織
ZTEGSDT204~ZKUNNR_ZJ           " 最終需要者
ZTEGSDT204~ZKUNNR_DS           " 最終需要者(商流)
FROM ZTEGSDT204
INNER JOIN TVKO
ON ZTEGSDT204~BUKRS = TVKO~BUKRS
INTO TABLE LTD_SDT204
FOR ALL ENTRIES IN LTD_SDT203
WHERE ZTEGSDT204~MATNR = LTD_SDT203-MATNR
" 品目コード
AND TVKO~VKORG       = LTD_SDT203-VKORG.
" 販売組織
IF SY-SUBRC = 0.
SORT LTD_SDT204 BY MATNR ASCENDING  " 品目コード
VKORG ASCENDING. " 販売組織
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-3．営業員情報の検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門
DELETE LTD_SDT203
WHERE ENAME IS NOT INITIAL.            " 応募者氏名

IF LTD_SDT203 IS NOT INITIAL.
SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~KUNN2                     " 取引先の得意先コード
PA0001~ENAME                   " 従業員氏名
FROM KNVP
INNER JOIN PA0001
ON KNVP~KUNN2 = PA0001~PERNR      " 取引先の得意先コード
INTO TABLE LTD_ENAME
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = CNS_PAR_PE.       " 取引先機能
IF SY-SUBRC = 0.
SORT LTD_ENAME BY KUNNR ASCENDING   " 得意先コード
VKORG ASCENDING   " 販売組織
VTWEG ASCENDING   " 流通チャネル
SPART ASCENDING.  " 製品部門
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-4．出荷プラントの情報を検索
AT FIRST.
LTD_SDT203 = O_TD_SDT203.

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門
DELETE LTD_SDT203
WHERE DWERK IS NOT INITIAL.            " 出荷プラント

IF LTD_SDT203 IS NOT INITIAL.
SELECT KUNNR                          " 得意先コード
VKORG                          " 販売組織
VTWEG                          " 流通チャネル
SPART                          " 製品部門
VWERK                          " 出荷プラント
FROM KNVV
INTO TABLE LTD_KNVV
FOR ALL ENTRIES IN LTD_SDT203
WHERE KUNNR = LTD_SDT203-KUNNR       " 得意先コード
AND VKORG = LTD_SDT203-VKORG       " 販売組織
AND VTWEG = LTD_SDT203-VTWEG       " 流通チャネル
AND SPART = LTD_SDT203-SPART.      " 製品部門
IF SY-SUBRC = 0.
SORT LTD_KNVV BY KUNNR ASCENDING    " 得意先コード
VKORG ASCENDING    " 販売組織
VTWEG ASCENDING    " 流通チャネル
SPART ASCENDING.   " 製品部門
ENDIF.
ENDIF.
ENDAT.

*   A-2-1-2-5．出荷先の情報を取得する。
IF <LFS_ST_SDT203>-ZKUNNR_S IS INITIAL.
CLEAR LST_KNVP.
READ TABLE LTD_KNVP INTO LST_KNVP
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
<LFS_ST_SDT203>-ZKUNNR_S = LST_KNVP-KUNN2.
" 出荷先
<LFS_ST_SDT203>-ZNAME1   = LST_KNVP-NAME1.
" 出荷先名称
ENDIF.

*   A-2-1-2‐6．最終需要者の情報を取得する。
IF <LFS_ST_SDT203>-ZKUNNR_ZJ IS INITIAL.
CLEAR LST_SDT204.
READ TABLE LTD_SDT204 INTO LST_SDT204
WITH KEY MATNR = <LFS_ST_SDT203>-MATNR
VKORG = <LFS_ST_SDT203>-VKORG
BINARY SEARCH.
<LFS_ST_SDT203>-ZKUNNR_ZJ = LST_SDT204-ZKUNNR_ZJ.
" 最終需要者
<LFS_ST_SDT203>-ZKUNNR_DS = LST_SDT204-ZKUNNR_DS.
" 最終需要者(商流)
ENDIF.

*   A-2-1-2-7．営業員の情報を取得する。
IF <LFS_ST_SDT203>-ENAME IS INITIAL.
CLEAR LST_ENAME.
READ TABLE LTD_ENAME INTO LST_ENAME
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
<LFS_ST_SDT203>-PERNR = LST_ENAME-KUNN2.
" 取引先の得意先コード
<LFS_ST_SDT203>-ENAME = LST_ENAME-ENAME.
" 従業員氏名
ENDIF.

*   A-2-1-2-8．出荷プラントの情報を検索
IF <LFS_ST_SDT203>-DWERK IS INITIAL.
CLEAR LST_KNVV.
READ TABLE LTD_KNVV INTO LST_KNVV
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
<LFS_ST_SDT203>-DWERK = LST_KNVV-VWERK.
ENDIF.

ENDLOOP.

ENDFORM.                    " EDIT_DATA_MAIN

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN1
*&---------------------------------------------------------------------*
*       A-2-3-1．以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN1  USING I_W_DATE       TYPE SY-DATUM
I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.

DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
ZTEGSDT203~MATNR                     " 品目コード
ZTEGSDT203~TXZ01                     " テキスト (短)
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1                         " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~PERNR                     " 営業員
ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
INTO TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG
" 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART
" 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ZTEGSDT203~ZKBUNCC   = CNS_KBUNCC_2  " 処理区分
AND ZTEGSDT203~STATUS    = CNS_STATUS_C. " ステータス
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.
ELSE.
LTD_SDT203 = O_TD_SDT203.
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= I_W_DATE                  " 開始日付
AND ENDDA >= I_W_DATE.                 " 終了日付

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.
<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.
" 応募者氏名
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN

*&---------------------------------------------------------------------*
*&      Form  ALV_OUTPUT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM ALV_OUTPUT  USING I_TD_SDT203      TYPE TYP_TD_ZTEGSDT203.

DATA:
LTD_FIELDCAT   TYPE LVC_T_FCAT,
LST_LAYOUT     TYPE LVC_S_LAYO.

* 項目カタログの編集
PERFORM EDIT_FIELDCAT USING CNS_STNM008
CNS_STNM011
CHANGING LTD_FIELDCAT.

* レイアウト構造の編集
PERFORM EDIT_LAYOUT CHANGING LST_LAYOUT.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING I_TD_SDT203.

* ALV一覧形式で出力する
IF RB_ERR IS INITIAL.
CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
TABLES
T_OUTTAB                 = TD_APP_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.

LEAVE LIST-PROCESSING.
ENDIF.
ELSE.
CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
TABLES
T_OUTTAB                 = TD_ERR_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.

LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

ENDFORM.                    " ALV_OUTPUT

*&---------------------------------------------------------------------*
*&      Form  EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_W_STRNM08    構造名
*      -->I_W_STRNM11    構造名
*      <--O_TD_SDT203    ITAB:項目カタログ
*----------------------------------------------------------------------*
FORM EDIT_FIELDCAT USING I_W_STRNM08     TYPE TABNAME
I_W_STRNM11     TYPE TABNAME
CHANGING O_TD_FIELDCAT   TYPE LVC_T_FCAT.

* A-3-1．データのALV一覧出力
DATA:
LST_FIELDCAT TYPE LVC_S_FCAT.

CLEAR O_TD_FIELDCAT.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME             = I_W_STRNM08
CHANGING
CT_FIELDCAT                  = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE       = 1
PROGRAM_ERROR                = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
LEAVE LIST-PROCESSING.
ENDIF.
LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.
*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME             = I_W_STRNM11
CHANGING
CT_FIELDCAT                  = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE       = 1
PROGRAM_ERROR                = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
LEAVE LIST-PROCESSING.
ENDIF.
LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.
*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME             = I_W_STRNM08
CHANGING
CT_FIELDCAT                  = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE       = 1
PROGRAM_ERROR                = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
LEAVE LIST-PROCESSING.
ENDIF.
WHEN OTHERS.
*     処理ない
ENDCASE.

ENDFORM.                    " EDIT_FIELDCAT

*&---------------------------------------------------------------------*
*&      Form  EDIT_LAYOUT
*&---------------------------------------------------------------------*
*       レイアウト構造の編集
*----------------------------------------------------------------------*
*      <--O_W_LAYOUT     レイアウト
*----------------------------------------------------------------------*
FORM EDIT_LAYOUT CHANGING O_ST_LAYOUT   TYPE LVC_S_LAYO.

O_ST_LAYOUT-CWIDTH_OPT = ABAP_ON.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.
O_ST_LAYOUT-BOX_FNAME = 'CHK'.
*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.
O_ST_LAYOUT-BOX_FNAME = 'CHK'.
*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
*     処理なし
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " EDIT_LAYOUT

*&---------------------------------------------------------------------*
*&      Form  EDIT_ALVDATA
*&---------------------------------------------------------------------*
*       ALV出力データの編集
*----------------------------------------------------------------------*
*      -->I_TD_SDT203      構造名
*      <--O_TD_APP_ALV    ITAB:承認済受注未登録一覧
*      <--O_TD_ERR_ALV    ITAB:エラー一覧
*----------------------------------------------------------------------*
FORM EDIT_ALVDATA USING I_TD_SDT203  TYPE TYP_TD_ZTEGSDT203.

DATA:
LST_SDT203      TYPE TYP_ZTEGSDT203,
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

REFRESH:
TD_APP_ALV,
TD_ERR_ALV.

LOOP AT I_TD_SDT203 INTO LST_SDT203.
LST_APP_ALVDATA-VKORG   = LST_SDT203-VKORG." 販売組織
LST_APP_ALVDATA-VTWEG   = LST_SDT203-VTWEG." 流通チャネル
LST_APP_ALVDATA-SPART   = LST_SDT203-SPART." 製品部門
LST_APP_ALVDATA-VKBUR   = LST_SDT203-VKBUR." 営業所
LST_APP_ALVDATA-VKGRP   = LST_SDT203-VKGRP." 営業グループ
LST_APP_ALVDATA-KUNNR   = LST_SDT203-KUNNR." 受注先
LST_APP_ALVDATA-NAME1   = LST_SDT203-NAME1." 名称 1
LST_APP_ALVDATA-MATNR   = LST_SDT203-MATNR." 品目コード
LST_APP_ALVDATA-ARKTX   = LST_SDT203-TXZ01." 受注明細のテキスト (短)
LST_APP_ALVDATA-KWMENG  = LST_SDT203-MENGE." 累積受注数量 (販売単位)
LST_APP_ALVDATA-VRKME   = LST_SDT203-MEINS." 販売単位
LST_APP_ALVDATA-NETPR   = LST_SDT203-NETPR." 正味価格
LST_APP_ALVDATA-WAERK   = LST_SDT203-WAERS." 販売伝票通貨
LST_APP_ALVDATA-KPEIN   = LST_SDT203-PEINH." 価格条件単位
LST_APP_ALVDATA-ZVRKME  = LST_SDT203-BPRME." 販売単位
LST_APP_ALVDATA-NETWR   = LST_SDT203-NETWR." 正味価格
LST_APP_ALVDATA-WERKS   = LST_SDT203-DWERK.
" プラント (自社または外部)
LST_APP_ALVDATA-ZEKUNNR = LST_SDT203-ZKUNNR_S.
" 出荷先
LST_APP_ALVDATA-ZEKNAME = LST_SDT203-ZNAME1.
" 出荷先名称
LST_APP_ALVDATA-EDATU   = LST_SDT203-EINDT.
" 納入日程日付
LST_APP_ALVDATA-ZEEMNAM = LST_SDT203-ENAME.
" 従業員名称
LST_APP_ALVDATA-DZTERM  = LST_SDT203-ZTERM.
" 支払条件キー
LST_APP_ALVDATA-BSTKD   = LST_SDT203-EBELN.
" 得意先発注番号
LST_APP_ALVDATA-BSTDK   = LST_SDT203-AEDAT.
" 得意先発注日付
LST_APP_ALVDATA-EBELP   = LST_SDT203-EBELP.
" 購買伝票の明細番号

LST_APP_ALVDATA-BSART   = LST_SDT203-BSART.
" 購買伝票タイプ
LST_APP_ALVDATA-KNTTP   = LST_SDT203-KNTTP.
" 勘定設定カテゴリ
LST_APP_ALVDATA-PERNR   = LST_SDT203-PERNR.
" 営業員
LST_APP_ALVDATA-ZKUNNR_ZJ   = LST_SDT203-ZKUNNR_ZJ.
" 最終需要者
LST_APP_ALVDATA-ZKUNNR_DS   = LST_SDT203-ZKUNNR_DS.
" 最終需要者(商流)

IF RB_ERR IS INITIAL.
APPEND LST_APP_ALVDATA TO TD_APP_ALV.
ELSE.
LST_ERR_ALVDATA = LST_APP_ALVDATA.
LST_ERR_ALVDATA-MSGTX   = LST_SDT203-MSGTX.
" メッセージテキスト
APPEND LST_ERR_ALVDATA TO TD_ERR_ALV.
ENDIF.
CLEAR:
LST_APP_ALVDATA,
LST_ERR_ALVDATA.
ENDLOOP.

SORT TD_APP_ALV BY BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

SORT TD_ERR_ALV BY BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

ENDFORM.                    " EDIT_ALVDATA

*&---------------------------------------------------------------------*
*&      Form  SET_STATUS
*&---------------------------------------------------------------------*
*       ALV画面のステータスの設定
*----------------------------------------------------------------------*
*      -->I_TD_EXTAB       ITAB:ユーザ例外
*----------------------------------------------------------------------*
FORM SET_STATUS USING I_TD_EXTAB TYPE SLIS_T_EXTAB.

DATA:
LST_EXTAB TYPE SLIS_EXTAB.

REFRESH:
I_TD_EXTAB.

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
SET TITLEBAR 'TITLE_APP'.
SET PF-STATUS 'STATUS_APP'.
*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_ERR'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB.
*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.
LST_EXTAB-FCODE = '&ALL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = '&SAL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'MODI'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'DEL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_LIST'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB..
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " SET_STATUS

*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&---------------------------------------------------------------------*
*       ALV画面の事件
*----------------------------------------------------------------------*
*      -->I_W_UCOMM       　ユーザ事件
*      -->I_ST_SELFIELD     information cursor position ALV
*----------------------------------------------------------------------*
FORM USER_COMMAND USING I_W_UCOMM     TYPE SY-UCOMM
I_ST_SELFIELD TYPE SLIS_SELFIELD.

DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LTD_UPDATE      TYPE TYP_TD_ALVDATA,
LW_QUESTION     TYPE CHAR72,
LW_ANSWER       TYPE CHAR1,
LW_ERRFLG       TYPE CHAR1,
LW_MESSAGE      TYPE BAPI_MSG.

I_ST_SELFIELD-REFRESH = ABAP_ON.

CLEAR LTD_PROCESS.
* A-4．ボタンイベント処理
CASE I_W_UCOMM.
*   A-4-1-1．　「Delete」ボタン押下時の処理
*   A-4-2-1．「Delete」ボタン押下時の処理
WHEN CNS_USER_DEL.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ELSE.
*       削除しますか？
MESSAGE S034(ZMEGSD01) INTO LW_QUESTION.

*       POP確認
PERFORM POP_CONFIRM USING TEXT-B01
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ENDIF.
ENDIF.

*     B-2-1．ロック処理
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS.

*     B-2-2．受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203 USING LTD_PROCESS
W_SYST_DATE
W_SYST_TIME.

COMMIT WORK AND WAIT.

*     B-2-3．ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS.

*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.

*   A-4-1-2．　「Approve」ボタン押下時の処理
WHEN CNS_USER_APP.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.
*     C-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.

*     C-1-3．ロック処理
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS.

*     C-2．受注シミュレーション処理
*     C-2-1．シミュレーション対象データの補足処理。
PERFORM EDIT_TD_PROCESS USING TD_APP_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG,
LW_MESSAGE.
PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LW_MESSAGE.
IF LW_ERRFLG IS INITIAL
AND LW_MESSAGE IS INITIAL.
*    C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_C
LW_MESSAGE
LTD_UPDATE
LTD_PROCESS
W_SYST_DATE
W_SYST_TIME.
ELSE.
* C-3-1．承認エラーの場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_E
LW_MESSAGE
LTD_UPDATE
LTD_PROCESS
W_SYST_DATE
W_SYST_TIME.

ENDIF.

*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.
*     C-4-2．メッセージを表示する。
IF LW_ERRFLG IS INITIAL.
*       指定された対象が全て承認されました
MESSAGE S045(ZMEGSD01).
ELSE.
*       承認失敗のデータが存在します。エラーリカバリ一覧をご確認ください
MESSAGE S046(ZMEGSD01).
ENDIF.
*   A-4-1-3．　「Change」ボタン押下時の処理
*   A-4-2-2．　「Change」ボタン押下時の処理
WHEN CNS_USER_MOD.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.
*     D-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.
*     購買発注番号混在チェック
PERFORM CHECK_TD_PROCESS USING TD_APP_ALV
TD_ERR_ALV
CHANGING LTD_PROCESS.
*     D-2．データ設定処理
CLEAR:
TD_ITEM_ALV,
TD_ITEM_ALV_INI,
ST_ZSEGSD0009,
ST_ZSEGSD0009_INI.
PERFORM SET_SCREEN_9000 USING LTD_PROCESS
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
TD_ITEM_ALV_INI.

ST_ZSEGSD0009_INI = ST_ZSEGSD0009.
CLEAR W_CHANGED.
CALL SCREEN 9000.
WHEN CNS_USER_BACK
OR CNS_USER_EXIT.
LEAVE TO SCREEN 0.
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " USER_COMMAND

*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
*       対象データを選択
*----------------------------------------------------------------------*
*      <--O_TD_SELFIELD     ITAB:選択対象データ
*----------------------------------------------------------------------*
FORM SELECT_DATA CHANGING O_TD_SELFIELD TYPE TYP_TD_ERRALVDATA.

DATA:
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

CASE ABAP_ON.
*   ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
LOOP AT TD_APP_ALV INTO LST_APP_ALVDATA
WHERE CHK IS NOT INITIAL.
MOVE-CORRESPONDING LST_APP_ALVDATA TO LST_ERR_ALVDATA.
APPEND LST_ERR_ALVDATA TO O_TD_SELFIELD.
CLEAR LST_ERR_ALVDATA.
ENDLOOP.
*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
O_TD_SELFIELD = TD_ERR_ALV.
DELETE O_TD_SELFIELD WHERE CHK IS INITIAL.
WHEN OTHERS.
*   処理なし
ENDCASE.

ENDFORM.                    " SELECT_DAT

*&---------------------------------------------------------------------*
*&      Form  POP_CONFIRM
*&---------------------------------------------------------------------*
*       POP確認
*----------------------------------------------------------------------*
*      -->I_W_TITLEBAR     TITLEBAR
*      -->I_W_QUESTION     TEXT_QUESTION
*      -->I_W_BUTTON1      TEXT_BUTTON_1
*      -->I_W_BUTTON2      TEXT_BUTTON_2
*      <--O_W_ANSWER       ANSWER
*----------------------------------------------------------------------*
FORM POP_CONFIRM USING I_W_TITLEBAR TYPE ANY
I_W_QUESTION TYPE ANY
I_W_BUTTON1  TYPE ANY
I_W_BUTTON2  TYPE ANY
CHANGING O_W_ANSWER   TYPE C.

CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TITLEBAR              = I_W_TITLEBAR
TEXT_QUESTION         = I_W_QUESTION
TEXT_BUTTON_1         = I_W_BUTTON1
TEXT_BUTTON_2         = I_W_BUTTON2
DISPLAY_CANCEL_BUTTON = SPACE
IMPORTING
ANSWER                = O_W_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND        = 1
OTHERS                = 2.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.


ENDFORM.                    " POP_CONFIRM

*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:ロック処理の対象データ
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA.

DATA:
LW_EBELN        TYPE EBELN,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LTD_PROCESS_TEM TYPE TYP_TD_ERRALVDATA,
LRD_BSTKD       TYPE RANGE OF BSTKD,
LST_BSTKD       LIKE LINE OF LRD_BSTKD.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
IF LST_PROCESS-BSTKD IN LRD_BSTKD.
CONTINUE.
ENDIF.
LW_EBELN = LST_PROCESS-BSTKD.
CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.

*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS_TEM.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
LST_BSTKD-SIGN   = 'I'.
LST_BSTKD-OPTION = 'EQ'.
LST_BSTKD-LOW    = LST_PROCESS-BSTKD.
APPEND LST_BSTKD TO LRD_BSTKD.
CLEAR LST_BSTKD.
ENDIF.

APPEND LST_PROCESS TO LTD_PROCESS_TEM.

ENDLOOP.

ENDFORM.                    " LOCK_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_TD_ALVDATA     ITAB:ロックの解除の対象データ
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203 USING I_TD_ALVDATA TYPE TYP_TD_ERRALVDATA.

DATA:
LST_ALVDATA   TYPE TYP_ERR_ALVDATA,
LW_EBELN      TYPE EBELN.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
LW_EBELN = LST_ALVDATA-BSTKD.
CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN.

ENDLOOP.

ENDFORM.                    " UNLOCK_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203
*&---------------------------------------------------------------------*
*       B-2-2．受発注連携データのステータス更新処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:更新処理の対象データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
I_W_DATE     TYPE SY-DATUM
I_W_TIME     TYPE SY-UZEIT.

DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2    " 処理区分
STATUS       = CNS_STATUS_D    " ステータス
Z_MOD_YMD    = I_W_DATE        " 更新年月日
Z_MOD_HMS    = I_W_TIME        " 更新時分秒
Z_MOD_USERID = SY-UNAME        " 更新ユーザ
WHERE EBELN        = LST_PROCESS-BSTKD
" 購買伝票番号
AND EBELP        = LST_PROCESS-EBELP.
" 購買伝票の明細番号
IF SY-SUBRC <> 0.
ROLLBACK WORK.
*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_PROCESS.
*    データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.
ENDLOOP.

ENDFORM.                    " UPDATE_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_AGAIN
*&---------------------------------------------------------------------*
*       B-3．ALV画面を再表示処理
*----------------------------------------------------------------------*
*      -->I_W_DATE         システム日付
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_AGAIN USING I_W_DATE    TYPE SY-DATUM.

DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203.

*  ラジオボタン「承認一覧(Approve)」を指定した場合
IF RB_APP IS NOT INITIAL.
*   A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203.
*   A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.
ENDIF.

* ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
IF RB_ERR IS NOT INITIAL.
*   A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING I_W_DATE
CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203.
ENDIF.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING LTD_ZTEGSDT203.

ENDFORM.                    " DISPLAY_ALV_AGAIN

*&---------------------------------------------------------------------*
*&      Form  EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*       C-2-1．シミュレーション対象データの補足処理。
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM EDIT_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA.


LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

REFRESH O_TD_PROCESS.

LOOP AT LTD_PROCESS INTO LST_PROCESS.
LOOP AT I_TD_APP_ALV INTO LST_APP_ALV
WHERE BSTKD = LST_PROCESS-BSTKD.
LST_PROCESS_TEM = LST_APP_ALV.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDLOOP.
ENDLOOP.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS

*&---------------------------------------------------------------------*
*&      Form  BAPI_SALESORDER_CREAT
*&---------------------------------------------------------------------*
*       C-2-2．受注シミュレーション処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:処理の対象データ
*      <--O_TD_UPDATE      ITAB;更新対象データ
*      <--O_W_ERRFLG       BAPIエラーフラッグ
*      <--O_W_MESSAGE      BAPIエラーメッセージ
*----------------------------------------------------------------------*
FORM BAPI_SALESORDER_CREAT USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_UPDATE  TYPE TYP_TD_ALVDATA
O_W_ERRFLG   TYPE C
O_W_MESSAGE  TYPE BAPI_MSG.

DATA:
LST_PROCESS       TYPE TYP_ERR_ALVDATA,
LST_TEM_PROCESS   TYPE TYP_TEM_ALVDATA,
LST_TEM_PROCESS1  TYPE TYP_TEM_ALVDATA,
LTD_TEM_PROCESS   TYPE TYP_TD_ALVDATA,
LST_DATA_205      TYPE TYP_DATA_205,
LTD_DATA_205      TYPE TYP_TD_205,
LST_HEADER_IN     TYPE BAPISDHD1,
LST_ORDER_PARTNER TYPE BAPIPARNR,
LTD_ORDER_PARTNER TYPE TABLE OF BAPIPARNR,
LST_ITEMS_IN      TYPE BAPISDITM,
LTD_ITEMS_IN      TYPE TABLE OF BAPISDITM,
LST_SCHEDULES     TYPE BAPISCHDL,
LTD_SCHEDULES     TYPE STANDARD TABLE OF BAPISCHDL,
LST_CONDITIONS    TYPE BAPICOND,
LTD_CONDITIONS    TYPE STANDARD TABLE OF BAPICOND,
LW_NUMBER         TYPE POSNR_VA,
LW_COND_VALUE     TYPE BAPICURR-BAPICURR,
LTD_RETURN        TYPE TABLE OF BAPIRET2,
LST_RETURN        TYPE BAPIRET2.

* 販売伝票タイプを取得
PERFORM GET_DATA_205 USING I_TD_PROCESS
CHANGING LTD_DATA_205.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
MOVE-CORRESPONDING LST_PROCESS TO LST_TEM_PROCESS.
APPEND LST_TEM_PROCESS TO LTD_TEM_PROCESS.
CLEAR LST_TEM_PROCESS.
ENDLOOP.

SORT LTD_TEM_PROCESS BY BSTKD ASCENDING     " 得意先発注番号
EBELP ASCENDING.    " 購買伝票の明細番号

LOOP AT LTD_TEM_PROCESS INTO LST_TEM_PROCESS1.
LST_TEM_PROCESS = LST_TEM_PROCESS1.
AT NEW BSTKD.
*     @受注伝票ヘッダ
CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = LST_TEM_PROCESS-BSART
KNTTP = LST_TEM_PROCESS-KNTTP
BINARY SEARCH.

LST_HEADER_IN-DOC_TYPE   = LST_DATA_205-AUART.
" 販売伝票タイプ
LST_HEADER_IN-SALES_ORG  = LST_TEM_PROCESS-VKORG.
" 販売組織
LST_HEADER_IN-DISTR_CHAN = LST_TEM_PROCESS-VTWEG.
" 流通チャネル
LST_HEADER_IN-DIVISION   = LST_TEM_PROCESS-SPART.
" 製品部門
LST_HEADER_IN-SALES_GRP  = LST_TEM_PROCESS-VKGRP.
" 営業グループ
LST_HEADER_IN-SALES_OFF  = LST_TEM_PROCESS-VKBUR.
" 営業所
LST_HEADER_IN-PURCH_NO_C = LST_TEM_PROCESS-BSTKD.
" 得意先発注番号
LST_HEADER_IN-PURCH_DATE = LST_TEM_PROCESS-BSTDK.
" 得意先発注日付
LST_HEADER_IN-ORD_REASON = LST_DATA_205-AUGRU.
" 受注理由 (取引理由)
LST_HEADER_IN-CURRENCY   = LST_TEM_PROCESS-WAERK.
" 販売伝票通貨
ENDAT.
*   B明細データ
LW_NUMBER = LW_NUMBER + 10.
LST_ITEMS_IN-ITM_NUMBER = LW_NUMBER.      " 販売伝票明細
LST_ITEMS_IN-MATERIAL   = LST_TEM_PROCESS-MATNR.
" 品目コード
LST_ITEMS_IN-SHORT_TEXT = LST_TEM_PROCESS-ARKTX.
" 受注明細のテキスト (短)
LST_ITEMS_IN-PLANT      = LST_TEM_PROCESS-WERKS.
" プラント
LST_ITEMS_IN-SALES_UNIT = LST_TEM_PROCESS-ZVRKME.
" 販売単位
LST_ITEMS_IN-REF_DOC    = LST_TEM_PROCESS-BSTKD.
" 参照伝票番号
LST_ITEMS_IN-REF_DOC_IT = LST_TEM_PROCESS-EBELP.
" 参照明細番号
APPEND LST_ITEMS_IN TO LTD_ITEMS_IN.
CLEAR LST_ITEMS_IN.
*   D納入日程行データ
LST_SCHEDULES-ITM_NUMBER = LW_NUMBER.     " 販売伝票明細
LST_SCHEDULES-SCHED_LINE = CNS_LINE_01.   " 納入日程行
LST_SCHEDULES-REQ_DATE   = LST_TEM_PROCESS-EDATU.
" 納入日程日付
LST_SCHEDULES-REQ_QTY    = LST_TEM_PROCESS-KWMENG.
" 販売単位による受注数量
APPEND LST_SCHEDULES TO LTD_SCHEDULES.
CLEAR LST_SCHEDULES.

LST_CONDITIONS-ITM_NUMBER = LW_NUMBER.    " 販売伝票明細
LST_CONDITIONS-COND_TYPE  = CNS_COND_ZPR0." 条件タイプ

CLEAR LW_COND_VALUE.
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = LST_TEM_PROCESS-WAERK
AMOUNT_INTERNAL = LST_TEM_PROCESS-NETPR
IMPORTING
AMOUNT_EXTERNAL = LW_COND_VALUE.      " 条件レート

LST_CONDITIONS-COND_VALUE = LW_COND_VALUE." 条件レート
LST_CONDITIONS-CURRENCY   = LST_TEM_PROCESS-WAERK.
" 通貨コード
LST_CONDITIONS-COND_UNIT  = LST_TEM_PROCESS-ZVRKME.
" 条件単位
LST_CONDITIONS-COND_P_UNT = LST_TEM_PROCESS-KPEIN.
" 販売単位
APPEND LST_CONDITIONS TO LTD_CONDITIONS.
CLEAR LST_CONDITIONS.
APPEND LST_TEM_PROCESS TO O_TD_UPDATE.
AT END OF BSTKD.
*     C伝票取引先
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SP.
" 受注先「SP」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-KUNNR.
" 受注先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SH.
" 出荷先「SH」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZEKUNNR.
" 出荷先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_PE.
" 営業員「PE」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-PERNR.
" 営業員
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZJ.
" 最終需要者「ZJ」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_ZJ.
" 最終需要者
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZC.
" 最終需要者(商流)「ZC」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_DS.
" 最終需要者(商流)
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
EXPORTING
ORDER_HEADER_IN               = LST_HEADER_IN
TESTRUN                       = ABAP_ON
TABLES
RETURN                        = LTD_RETURN
ORDER_ITEMS_IN                = LTD_ITEMS_IN
ORDER_PARTNERS                = LTD_ORDER_PARTNER
ORDER_SCHEDULES_IN            = LTD_SCHEDULES
ORDER_CONDITIONS_IN           = LTD_CONDITIONS.

CLEAR O_W_MESSAGE.
LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E.
O_W_MESSAGE = LST_RETURN-MESSAGE.
O_W_ERRFLG = ABAP_ON.
EXIT.
ENDLOOP.

CLEAR:
LST_HEADER_IN,
LW_NUMBER.

REFRESH:
LTD_ITEMS_IN,
LTD_ORDER_PARTNER,
LTD_SCHEDULES,
LTD_CONDITIONS.
ENDAT.
ENDLOOP.

ENDFORM.                    " BAPI_SALESORDER_CREAT

*&---------------------------------------------------------------------*
*&      Form  CHECK_TD_PROCESS
*&---------------------------------------------------------------------*
*       購買発注番号混在チェック
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      -->I_TD_ERR_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM CHECK_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
I_TD_ERR_ALV TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA,
LW_CUNT         TYPE I.

LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

DESCRIBE TABLE LTD_PROCESS LINES LW_CUNT.
IF LW_CUNT > 1.
*   変更の場合、同一購買発注のみ指定できます
MESSAGE E047(ZMEGSD01).
ENDIF.

REFRESH O_TD_PROCESS.

IF RB_APP IS NOT INITIAL.
LOOP AT LTD_PROCESS INTO LST_PROCESS.
LOOP AT I_TD_APP_ALV INTO LST_APP_ALV
WHERE BSTKD = LST_PROCESS-BSTKD.
LST_PROCESS_TEM = LST_APP_ALV.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDLOOP.
ENDLOOP.
ENDIF.

IF RB_ERR IS NOT INITIAL.
O_TD_PROCESS = I_TD_ERR_ALV.
READ TABLE LTD_PROCESS INTO LST_PROCESS INDEX 1.
DELETE O_TD_PROCESS WHERE BSTKD <> LST_PROCESS-BSTKD.
ENDIF.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_205
*&---------------------------------------------------------------------*
*       販売伝票タイプを取得
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:ALV対象データ
*      <--O_TD_DATA_205    ITAB:販売伝票タイプデータ
*----------------------------------------------------------------------*
FORM GET_DATA_205 USING I_TD_PROCESS  TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_DATA_205 TYPE TYP_TD_205.
DATA:
LTD_PROCESS  TYPE TYP_TD_ERRALVDATA,
LTD_DATA_205 TYPE TYP_TD_205,
LST_TVAKT    TYPE TYP_TVAKT,
LTD_TVAKT    TYPE STANDARD TABLE OF TYP_TVAKT.

FIELD-SYMBOLS:
<LFS_ST_DATA_205> TYPE TYP_DATA_205.

LTD_PROCESS = I_TD_PROCESS.
SORT LTD_PROCESS BY BSART ASCENDING         " 購買伝票タイプ
KNTTP ASCENDING.        " 勘定設定カテゴリ
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSART       " 購買伝票タイプ
KNTTP.      " 勘定設定カテゴリ

SELECT BSART                                " 購買伝票タイプ
KNTTP                                " 勘定設定カテゴリ
AUART                                " 販売伝票タイプ
AUGRU                                " 受注理由
FROM ZTEGSDT205
INTO TABLE O_TD_DATA_205
FOR ALL ENTRIES IN LTD_PROCESS
WHERE BSART = LTD_PROCESS-BSART            " 購買伝票タイプ
AND KNTTP = LTD_PROCESS-KNTTP.           " 勘定設定カテゴリ
IF SY-SUBRC = 0.

LTD_DATA_205 = O_TD_DATA_205.
SORT LTD_DATA_205 BY AUART ASCENDING.     " 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205
COMPARING AUART.    " 販売伝票タイプ

SELECT AUART                              " 販売伝票タイプ
BEZEI                              " 販売伝票タイプテキスト
FROM TVAKT
INTO TABLE LTD_TVAKT
FOR ALL ENTRIES IN LTD_DATA_205
WHERE AUART = LTD_DATA_205-AUART         " 販売伝票タイプ
AND SPRAS = SY-LANGU.                  " システム言語

LOOP AT O_TD_DATA_205 ASSIGNING <LFS_ST_DATA_205>.
CLEAR LST_TVAKT.
READ TABLE LTD_TVAKT INTO LST_TVAKT
WITH KEY AUART = <LFS_ST_DATA_205>-AUART
BINARY SEARCH.
<LFS_ST_DATA_205>-BEZEI = LST_TVAKT-BEZEI.
" 販売伝票タイプテキスト
ENDLOOP.
SORT O_TD_DATA_205 BY BSART ASCENDING     " 購買伝票タイプ
KNTTP ASCENDING.    " 勘定設定カテゴリ

ENDIF.

ENDFORM.                    " GET_DATA_205

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_BAPI
*&---------------------------------------------------------------------*
*       C-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_MESSAGE        メッセージ
*      -->I_TD_ALVDATA     ITAB:BAPI処理対象
*      -->I_TD_UNLOCK      ITAB:UNLOCK処理対象データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_BAPI USING I_KBUNCC      TYPE C
I_STATUS      TYPE C
I_MESSAGE     TYPE BAPI_MSG
I_TD_ALVDATA  TYPE TYP_TD_ALVDATA
I_TD_UNLOCK   TYPE TYP_TD_ERRALVDATA
I_W_DATE      TYPE SY-DATUM
I_W_TIME      TYPE SY-UZEIT.
DATA:
LFG_ERR     TYPE C,
LST_ALVDATA TYPE TYP_TEM_ALVDATA.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC        " 処理区分
STATUS       = I_STATUS        " ステータス
MSGTX        = I_MESSAGE       " メッセージ
ZKUNNR_S     = LST_ALVDATA-ZEKUNNR
" 出荷先
ZKUNNR_ZJ    = LST_ALVDATA-ZKUNNR_ZJ
" 最終需要者
ZKUNNR_DS    = LST_ALVDATA-ZKUNNR_DS
" 最終需要者（商流）
PERNR        = LST_ALVDATA-PERNR
" 営業員
DWERK        = LST_ALVDATA-WERKS
" 出荷プラント
Z_MOD_YMD    = I_W_DATE        " 更新年月日
Z_MOD_HMS    = I_W_TIME        " 更新時分秒
Z_MOD_USERID = SY-UNAME        " 更新ユーザ
WHERE EBELN        = LST_ALVDATA-BSTKD
" 購買伝票番号
AND EBELP        = LST_ALVDATA-EBELP.
" 購買伝票の明細番号
IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
* C-3-3．データ更新に全件成功した場合、コミットし、ロックを解除
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
*  データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_BAPI

*&---------------------------------------------------------------------*
*&      Form  SET_SCREEN_9000
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS      ITAB:ALV処理対象データ
*      <--O_ZSEGSD0009      SCREEN9000ヘッダデータ
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*      <--O_TD_ITEM_ALV_INI SCREEN9000明細データ初期値
*----------------------------------------------------------------------*
FORM SET_SCREEN_9000 USING I_TD_PROCESS      TYPE TYP_TD_ERRALVDATA
CHANGING O_ZSEGSD0009      TYPE TYP_ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM
O_TD_ITEM_ALV_INI TYPE TYP_TD_ITEM.

DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LTD_DATA_205  TYPE TYP_TD_205,
LST_DATA_205  TYPE TYP_DATA_205,
LW_NETWR      TYPE NETWR,
LW_VKORGTEXT  TYPE VTXTK,
LW_VTWEGTEXT  TYPE VTXTK,
LW_SPARTTEXT  TYPE VTXTK,
LW_ZESALESTXT TYPE ZESALESTXT,
LW_TEXT1      TYPE TEXT1_052,
LST_ITEM_ALV  TYPE ZSEGSD0010.

* 販売伝票タイプを取得
PERFORM GET_DATA_205 USING I_TD_PROCESS
CHANGING LTD_DATA_205.
CLEAR:
LW_NETWR,
O_ZSEGSD0009.

REFRESH:
O_TD_ITEM_ALV,
O_TD_ITEM_ALV_INI.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
IF SY-TABIX = 1.
O_ZSEGSD0009-VKORG    = LST_PROCESS-VKORG.
" 販売組織
O_ZSEGSD0009-VTWEG    = LST_PROCESS-VTWEG.
" 流通チャネル
O_ZSEGSD0009-SPART    = LST_PROCESS-SPART.
" 製品部門
O_ZSEGSD0009-VKBUR    = LST_PROCESS-VKBUR.
" 営業所
O_ZSEGSD0009-VKGRP    = LST_PROCESS-VKGRP.
" 営業グループ
O_ZSEGSD0009-ZEKUNNR1 = LST_PROCESS-KUNNR.
" 受注先
O_ZSEGSD0009-ZEKNAME1 = LST_PROCESS-NAME1.
" 受注先名称
O_ZSEGSD0009-ZEKUNNR  = LST_PROCESS-ZEKUNNR.
" 出荷先
O_ZSEGSD0009-ZEKNAME  = LST_PROCESS-ZEKNAME.
" 出荷先名称
O_ZSEGSD0009-ZEKUNNR2 = LST_PROCESS-ZKUNNR_ZJ.
" 最終需要者
O_ZSEGSD0009-ZEKUNNR3 = LST_PROCESS-ZKUNNR_DS.
" 最終需要者(商流)
O_ZSEGSD0009-PERNR    = LST_PROCESS-PERNR.
" 営業員
O_ZSEGSD0009-ENAME    = LST_PROCESS-ZEEMNAM.
" 営業員氏名
O_ZSEGSD0009-BSTKD    = LST_PROCESS-BSTKD.
" 購買発注番号
O_ZSEGSD0009-BSTDK    = LST_PROCESS-BSTDK.
" 購買発注伝票日付
O_ZSEGSD0009-BSART    = LST_PROCESS-BSART.
" 購買伝票タイプ
O_ZSEGSD0009-KNTTP    = LST_PROCESS-KNTTP.
" 勘定設定カテゴリ
*     D-2-1-2．販売伝票タイプの設定処理。
CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = LST_PROCESS-BSART
KNTTP = LST_PROCESS-KNTTP
BINARY SEARCH.
O_ZSEGSD0009-AUART    = LST_DATA_205-AUART.
" 販売伝票タイプ
O_ZSEGSD0009-ZABEZEI  = LST_DATA_205-BEZEI.
" 販売伝票タイプテキスト
O_ZSEGSD0009-AUGRU    = LST_DATA_205-AUGRU.
" 受注理由 (取引理由)
*     D-2-1-3．販売エリアのテキストの設定処理。
SELECT SINGLE VTEXT
INTO LW_VKORGTEXT
FROM TVKOT
WHERE SPRAS = SY-LANGU
AND VKORG = LST_PROCESS-VKORG.
IF SY-SUBRC = 0
AND LW_VKORGTEXT IS NOT INITIAL.
LW_ZESALESTXT = LW_VKORGTEXT.
ENDIF.

*     D-2-1-3-2．流通チャネルの名称の取得処理
SELECT SINGLE VTEXT
INTO LW_VTWEGTEXT
FROM TVTWT
WHERE SPRAS = SY-LANGU
AND VTWEG = LST_PROCESS-VTWEG.
IF SY-SUBRC = 0
AND LW_VTWEGTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_VTWEGTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_VTWEGTEXT.
ENDIF.
ENDIF.

*     D-2-1-3-3．製品部門の名称の取得処理
SELECT SINGLE VTEXT
INTO LW_SPARTTEXT
FROM TSPAT
WHERE SPRAS = SY-LANGU
AND SPART = LST_PROCESS-SPART.
IF SY-SUBRC = 0
AND LW_SPARTTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_SPARTTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_SPARTTEXT.
ENDIF.
ENDIF.
O_ZSEGSD0009-ZESALESTXT = LW_ZESALESTXT." 販売エリアテキスト

*     D-2-1-4．営業所のテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = LST_PROCESS-VKBUR.

*     D-2-1-5．営業グループのテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = LST_PROCESS-VKGRP.

*     D-2-1-5．最終需要者の名称の設定処理。
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME2
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_ZJ.

*     D-2-1-6．最終需要者(商流)の名称の設定処理。
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME3
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_DS.
*     D-2-1-7．受注総額の設定処理。
*     通貨単位を設定
O_ZSEGSD0009-WAERK = LST_PROCESS-WAERK.
*     D-2-2-3．支払条件テキストの設定処理。
CLEAR LW_TEXT1.
SELECT TEXT1 UP TO 1 ROWS
FROM T052U
INTO LW_TEXT1
WHERE SPRAS = SY-LANGU
AND ZTERM = LST_PROCESS-DZTERM.
EXIT.
ENDSELECT.
ENDIF.
*   各明細の受注額(Net Value)を合計
LW_NETWR = LW_NETWR + LST_PROCESS-NETWR.

LST_ITEM_ALV-MATNR  = LST_PROCESS-MATNR.  " 品目コード
LST_ITEM_ALV-ARKTX  = LST_PROCESS-ARKTX.  " 品目テキスト
LST_ITEM_ALV-KWMENG = LST_PROCESS-KWMENG. " 数量
LST_ITEM_ALV-VRKME  = LST_PROCESS-VRKME.  " 単位
LST_ITEM_ALV-NETPR  = LST_PROCESS-NETPR.  " 単価
LST_ITEM_ALV-WAERK  = LST_PROCESS-WAERK.  " 通貨
LST_ITEM_ALV-KPEIN  = LST_PROCESS-KPEIN.  " /
LST_ITEM_ALV-ZVRKME = LST_PROCESS-ZVRKME. " UoM
LST_ITEM_ALV-NETWR  = LST_PROCESS-NETWR.  " 受注額
LST_ITEM_ALV-WERKS  = LST_PROCESS-WERKS.  " 出荷プラント
LST_ITEM_ALV-EDATU  = LST_PROCESS-EDATU.  " 納入期日
LST_ITEM_ALV-ZTERM  = LST_PROCESS-DZTERM. " 支払条件

*   D-2-2-2．明細番号(Item)の設定処理。
LST_ITEM_ALV-POSNR  = LST_PROCESS-EBELP.  " 購買伝票の明細番号

*   D-2-2-3-2．支払条件テキストの設定処理。
LST_ITEM_ALV-TEXT1 = LW_TEXT1.
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV.
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV_INI.
CLEAR LST_ITEM_ALV.
ENDLOOP.

O_ZSEGSD0009-NETWR = LW_NETWR.

ENDFORM.                    " SET_SCREEN_9000

*&---------------------------------------------------------------------*
*&      Module  STATUS_9000  OUTPUT
*&---------------------------------------------------------------------*
*      画面9000のステータスの設定
*----------------------------------------------------------------------*
MODULE STATUS_9000 OUTPUT.
SET PF-STATUS 'STATUS_9000'.
SET TITLEBAR 'BAR_9000'.
ENDMODULE.                 " STATUS_9000  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  ALV_DISPLAY  OUTPUT
*&---------------------------------------------------------------------*
*       D-3．詳細画面を表示処理
*----------------------------------------------------------------------*
MODULE ALV_DISPLAY OUTPUT.

* D-3．詳細画面を表示処理
PERFORM ALV_9000_OUPUT.

ENDMODULE.                 " ALV_DISPLAY  OUTPUT

*&---------------------------------------------------------------------*
*&       Class (Implementation)  CL_EVENT_RECEIVER
*&---------------------------------------------------------------------*
*        クラス:CL_EVENT_RECEIVER
*----------------------------------------------------------------------*
CLASS CL_EVENT_RECEIVER DEFINITION.

PUBLIC SECTION.
CLASS-METHODS:

HANDLE_DATA_CHANGED
FOR EVENT DATA_CHANGED OF CL_GUI_ALV_GRID
IMPORTING ER_DATA_CHANGED E_ONF4,

*     在数据修改完成之后
HANDLE_DATA_CHANGED_FINISHED
FOR EVENT DATA_CHANGED_FINISHED OF CL_GUI_ALV_GRID
IMPORTING E_MODIFIED,

*     F4#助用
HANDLE_F4
FOR EVENT ONF4 OF CL_GUI_ALV_GRID
IMPORTING ER_EVENT_DATA.

ENDCLASS.               "CL_EVENT_RECEIVER

*&---------------------------------------------------------------------*
*&       Class (Implementation)  GCL_EVENT_RECEIVER
*&---------------------------------------------------------------------*
*        クラス:CL_EVENT_RECEIVER
*----------------------------------------------------------------------*
CLASS CL_EVENT_RECEIVER IMPLEMENTATION.
*&---------------------------------------------------------------------

*&      Method HANDLE_DATA_CHANGED
*&---------------------------------------------------------------------

*&      在ALV可修改的情况下，控制数据修改
*&---------------------------------------------------------------------

METHOD HANDLE_DATA_CHANGED.

DATA:
LST_MOD      TYPE LVC_S_MODI,
LTD_ZTERM    TYPE STANDARD TABLE OF TYP_ZTERM,
LST_ZTERM    TYPE TYP_ZTERM,
LST_ITEM     TYPE ZSEGSD0010,
LST_MSG      TYPE LVC_S_MSG1.

SELECT ZTERM
TEXT1
FROM T052U
INTO TABLE LTD_ZTERM.

IF E_ONF4 = ABAP_ON.
RETURN.
ENDIF.
LOOP AT ER_DATA_CHANGED->MT_MOD_CELLS INTO LST_MOD.
CASE LST_MOD-FIELDNAME.
WHEN CNS_FNM_ZTERM.
CLEAR LST_ZTERM.
READ TABLE LTD_ZTERM INTO LST_ZTERM
WITH KEY ZTERM = LST_MOD-VALUE.
IF SY-SUBRC = 0.
CLEAR LST_ITEM.
READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX LST_MOD-ROW_ID.
LST_ITEM-TEXT1 = LST_ZTERM-TEXT1.
MODIFY TD_ITEM_ALV FROM LST_ITEM INDEX LST_MOD-ROW_ID.
ELSE.
CALL METHOD ER_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID = 'V1'
I_MSGNO = '398'
I_MSGTY = CNS_MSG_E
I_MSGV1 = LST_MOD-VALUE
I_FIELDNAME = CNS_FNM_ZTERM
I_ROW_ID    = LST_MOD-ROW_ID.
ENDIF.
WHEN CNS_FNM_POSNR
OR CNS_FNM_MATNR
OR CNS_FNM_ARKTX
OR CNS_FNM_KWMENG
OR CNS_FNM_VRKME
OR CNS_FNM_NETPR
OR CNS_FNM_KPEIN
OR CNS_FNM_ZVRKME
OR CNS_FNM_WERKS
OR CNS_FNM_EDATU.
IF LST_MOD-VALUE IS INITIAL.
CALL METHOD ER_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = '00'
I_MSGNO     = '055'
I_MSGTY     = CNS_MSG_E
I_FIELDNAME = LST_MOD-FIELDNAME
I_ROW_ID    = LST_MOD-ROW_ID.
ENDIF.
ENDCASE.
ENDLOOP.

CALL METHOD CI_ALV->ACTIVATE_DISPLAY_PROTOCOL( SPACE ).

CASE OK_CODE.
WHEN CNS_USER_BACK
OR  CNS_USER_EXIT.
*       処理なし
WHEN OTHERS.
CLEAR LST_MSG.
READ TABLE ER_DATA_CHANGED->MT_PROTOCOL INTO LST_MSG INDEX 1.
IF ER_DATA_CHANGED->MT_PROTOCOL IS NOT INITIAL.
MESSAGE ID LST_MSG-MSGID TYPE CNS_MSG_S NUMBER LST_MSG-MSGNO
WITH LST_MSG-MSGV1
LST_MSG-MSGV2
LST_MSG-MSGV3
LST_MSG-MSGV4
DISPLAY LIKE CNS_MSG_E.
ENDIF.
ENDCASE.

ENDMETHOD.
*&---------------------------------------------------------------------*
*&      Method  HANDLE_DATA_CHANGED_FINISHED
*&---------------------------------------------------------------------*
*&      データを変更された後
*&---------------------------------------------------------------------*
METHOD HANDLE_DATA_CHANGED_FINISHED.

DATA:
LW_COL       TYPE LVC_S_COL,
LW_ROW       TYPE LVC_S_ROW,
LW_MODIFIED  TYPE C,
LW_KWMENG    TYPE EKPO-MENGE,
LW_MENG_ALV  TYPE EKPO-MENGE,
LW_NETWR     TYPE NETWR.

FIELD-SYMBOLS:
<LFS_ALV>    TYPE ZSEGSD0010.

E_MODIFIED = ABAP_ON.
IF E_MODIFIED = ABAP_ON.
CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
ES_ROW_ID    = LW_ROW
ES_COL_ID    = LW_COL.

CALL METHOD CI_ALV->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LW_ROW
IS_COLUMN_ID = LW_COL.
ENDIF.
E_MODIFIED = LW_MODIFIED.

*  E-2-2-2．明細の数量と金額項目が変更された場合、
*  受注額の再計算処理を行う。
CLEAR LW_NETWR.
LOOP AT TD_ITEM_ALV ASSIGNING <LFS_ALV>.
CLEAR:
LW_KWMENG,
LW_MENG_ALV.

LW_MENG_ALV = <LFS_ALV>-KWMENG.

CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR                   = <LFS_ALV>-MATNR
I_IN_ME                   = <LFS_ALV>-VRKME
I_OUT_ME                  = <LFS_ALV>-ZVRKME
I_MENGE                   = LW_MENG_ALV
IMPORTING
E_MENGE                   = LW_KWMENG
EXCEPTIONS
ERROR_IN_APPLICATION      = 1
ERROR                     = 2
OTHERS                    = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ELSE.
<LFS_ALV>-NETWR = LW_KWMENG
* <LFS_ALV>-NETPR
/ <LFS_ALV>-KPEIN.
ENDIF.

LW_NETWR = <LFS_ALV>-NETWR + LW_NETWR.

ENDLOOP.

ST_ZSEGSD0009-NETWR = LW_NETWR.

CALL METHOD CL_GUI_CFW=>SET_NEW_OK_CODE
EXPORTING
NEW_CODE = CNS_USER_ENTR.
CALL METHOD CL_GUI_CFW=>FLUSH.

ENDMETHOD.

*&---------------------------------------------------------------------*
*&      Method  HANDLE_F4
*&---------------------------------------------------------------------*
*&      検索F4
*&---------------------------------------------------------------------*
METHOD HANDLE_F4.

PERFORM FRM_F4_SHOW.
ER_EVENT_DATA->M_EVENT_HANDLED = ABAP_ON.

ENDMETHOD.

ENDCLASS.               "GCL_EVENT_RECEIVER

*&---------------------------------------------------------------------*
*&      Form  ALV_9000_OUPUT
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_ITEM_ALV     ITAB:SCREEN9000ALV処理対象データ
*----------------------------------------------------------------------*
FORM ALV_9000_OUPUT.

DATA:
LTD_EXCLUDE        TYPE UI_FUNCTIONS,
LST_VARIANT        TYPE DISVARIANT,
LST_LAYOUT         TYPE LVC_S_LAYO,
LTD_FIELDCAT       TYPE LVC_T_FCAT,
LST_FIELDCAT       TYPE LVC_S_FCAT,
LTD_F4             TYPE LVC_T_F4,
LST_F4             TYPE LVC_S_F4,
LCL_EVENT_RECEIVER TYPE REF TO CL_EVENT_RECEIVER,
LW_VALID           TYPE C,
LTD_ITEM_ALV       TYPE TYP_TD_ITEM.

IF CI_ALV IS NOT INITIAL.
LTD_ITEM_ALV = TD_ITEM_ALV.
CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
TD_ITEM_ALV = LTD_ITEM_ALV.
CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.
IF LW_VALID IS INITIAL.
RETURN.
ENDIF.

ENDIF.

IF CI_ALV IS INITIAL.
*   容器の作成
CREATE OBJECT: CI_CCONTAINER
EXPORTING
CONTAINER_NAME = CNS_CONTA.

CREATE OBJECT CI_ALV
EXPORTING
I_PARENT = CI_CCONTAINER.

*   ALVレイアウトの設定
LST_LAYOUT-CWIDTH_OPT = ABAP_ON.

*   ALV項目定義
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = CNS_STNM010
CHANGING
CT_FIELDCAT            = LTD_FIELDCAT[]
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

LOOP AT LTD_FIELDCAT INTO LST_FIELDCAT.
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_WAERK
" 通貨
OR LST_FIELDCAT-FIELDNAME = CNS_FNM_NETWR
" 受注額
OR LST_FIELDCAT-FIELDNAME = CNS_FNM_TEXT1.
" 支払条件テキスト
CONTINUE.
ENDIF.
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_ZTERM.
LST_FIELDCAT-F4AVAILABL = ABAP_ON.
ENDIF.
LST_FIELDCAT-EDIT = ABAP_ON.
MODIFY LTD_FIELDCAT FROM LST_FIELDCAT.
ENDLOOP.

PERFORM EXCLUDE_TB_FUNCTIONS CHANGING LTD_EXCLUDE.

LST_VARIANT-REPORT  = SY-REPID.

CALL METHOD CI_ALV->SET_TABLE_FOR_FIRST_DISPLAY
EXPORTING
IS_VARIANT           = LST_VARIANT
IS_LAYOUT            = LST_LAYOUT
IT_TOOLBAR_EXCLUDING = LTD_EXCLUDE
CHANGING
IT_OUTTAB            = TD_ITEM_ALV
IT_FIELDCATALOG      = LTD_FIELDCAT
EXCEPTIONS
INVALID_PARAMETER_COMBINATION = 1
PROGRAM_ERROR                 = 2
TOO_MANY_LINES                = 3
OTHERS                        = 4 .
ELSE.
CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.
ENDIF.

CREATE OBJECT LCL_EVENT_RECEIVER.

SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED
FOR ALL INSTANCES.
* 触#回#后事件 在数据修改完成之后注册
SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED_FINISHED
FOR ALL INSTANCES.

* 注册更新事件（失去光#交点即触#）
CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_MODIFIED.

CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_ENTER.
* 検索F4
REFRESH LTD_F4.
CLEAR LST_F4.
LST_F4-FIELDNAME  = CNS_FNM_ZTERM.
LST_F4-REGISTER   = ABAP_ON.
LST_F4-GETBEFORE  = ABAP_ON.
LST_F4-CHNGEAFTER = ABAP_ON.
LST_F4-INTERNAL   = SPACE.
APPEND LST_F4 TO LTD_F4.

CALL METHOD CI_ALV->REGISTER_F4_FOR_FIELDS
EXPORTING
IT_F4             = LTD_F4.

SET HANDLER LCL_EVENT_RECEIVER->HANDLE_F4 FOR CI_ALV.

ENDFORM.                    " ALV_9000_OUPUT

*&---------------------------------------------------------------------*
*&      Form  EXCLUDE_TB_FUNCTIONS
*&---------------------------------------------------------------------*
*       ユーザ事件を除く
*----------------------------------------------------------------------*
*      <--O_TD_EXCLUDE     ITAB:SCREEN9000ALVユーザ事件
*----------------------------------------------------------------------*
FORM EXCLUDE_TB_FUNCTIONS CHANGING O_TD_EXCLUDE TYPE UI_FUNCTIONS.

DATA:
LST_EXCLUDE TYPE UI_FUNC.
LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_DELETE_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_INSERT_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_APPEND_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY_ROW .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_UNDO .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_REFRESH .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_CHECK .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_CUT .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_MB_PASTE .
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

ENDFORM.                    " EXCLUDE_TB_FUNCTIONS

*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_9000  INPUT
*&---------------------------------------------------------------------*
*       画面9000のボタンイベント処理
*----------------------------------------------------------------------*
MODULE USER_COMMAND_9000 INPUT.

DATA:
LW_SAVE_OK  TYPE SY-UCOMM,
LW_QUESTION TYPE CHAR72,
LW_ANSWER   TYPE C,
LW_ERRFLG   TYPE C,
LW_VALID    TYPE C,
LW_MESSAGE  TYPE BAPI_MSG,
LTD_UPDATE  TYPE TYP_TD_ALVDATA,
LTD_PROCESS TYPE TYP_TD_ERRALVDATA.

CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
IF LW_VALID IS INITIAL.
RETURN.
ENDIF.

LW_SAVE_OK = OK_CODE.

CASE LW_SAVE_OK.
WHEN CNS_USER_ENTR.
*     E-2．データ設定処理
PERFORM GET_9000_AGAIN USING ST_ZSEGSD0009_INI
TD_ITEM_ALV_INI
W_SYST_DATE
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV.

WHEN CNS_USER_SAPP.
PERFORM GET_9000_AGAIN USING ST_ZSEGSD0009_INI
TD_ITEM_ALV_INI
W_SYST_DATE
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV.
*     G.Approve
PERFORM APP_9000_DATA USING ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG,
LW_MESSAGE.

PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LW_MESSAGE.
IF LW_ERRFLG IS INITIAL
AND LW_MESSAGE IS INITIAL.
MESSAGE LW_MESSAGE TYPE CNS_MSG_E.
ENDIF.

*     G-3-1．ロック処理
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS.

*    C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_9000 USING CNS_KBUNCC_2
CNS_STATUS_C
ST_ZSEGSD0009
TD_ITEM_ALV
W_SYST_DATE
W_SYST_TIME.
*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.
*     C-4-2．メッセージを表示する。
*      データ承認しました。(購買発注 = &1)
MESSAGE S049(ZMEGSD01) WITH ST_ZSEGSD0009-BSTKD.
LEAVE TO SCREEN 0.
WHEN CNS_USER_SHOD
OR CNS_USER_SAVE.
*     E-2．データ設定処理
PERFORM GET_9000_AGAIN USING ST_ZSEGSD0009_INI
TD_ITEM_ALV_INI
W_SYST_DATE
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV.

*     F-1-3．ロック処理
PERFORM LOCK_ZTEGSDT203_H USING ST_ZSEGSD0009.
*     F-2．データ更新処理
PERFORM UPDATE_ZTEGSDT203_H USING ST_ZSEGSD0009
TD_ITEM_ALV
W_SYST_DATE
W_SYST_TIME.
*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN USING W_SYST_DATE.

*     更新成功のメッセージを表示する
*     データ更新しました。(購買発注 = &1)
MESSAGE S048(ZMEGSD01) WITH ST_ZSEGSD0009-BSTKD.
LEAVE TO SCREEN 0.
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDMODULE.                 " USER_COMMAND_9000  INPUT

*&---------------------------------------------------------------------*
*&      Form  GET_9000_AGAIN
*&---------------------------------------------------------------------*
*       E-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_ZSEGSD0009_INI  SCREEN9000ALV ヘッダデータ初期値
*      -->I_TD_ITEM_ALV_INI SCREEN9000明細データ初期値
*      -->I_W_DATE          システム日付
*      <--O_ZSEGSD0009      SCREEN9000ALVヘッダデータ変更値_TEM
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*----------------------------------------------------------------------*
FORM GET_9000_AGAIN USING I_ZSEGSD0009_INI  TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV_INI TYPE TYP_TD_ITEM
I_W_DATE          TYPE SY-DATUM
CHANGING O_ZSEGSD0009      TYPE TYP_ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM.

DATA:
LST_ALV_INI  TYPE ZSEGSD0010,
LW_KWMENG    TYPE EKPO-MENGE,
LW_MENG_ALV  TYPE EKPO-MENGE,
LW_NETWR     TYPE NETWR,
LW_CHANGE    TYPE C.

FIELD-SYMBOLS:
<LFS_ALV>    TYPE ZSEGSD0010,
<LFS_ALV1>   TYPE ZSEGSD0010.

* 通貨チェック
PERFORM CHK_WAERK.
* E-2-1-1．営業所のテキストの再設定処理。
IF O_ZSEGSD0009-VKBUR <> I_ZSEGSD0009_INI-VKBUR.
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = O_ZSEGSD0009-VKBUR.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-VKBUR,
O_ZSEGSD0009-ZVBEZEI.
ENDIF.
ENDIF.

* E-2-1-2．営業グループのテキストの再設定処理。
IF O_ZSEGSD0009-VKGRP <> I_ZSEGSD0009_INI-VKGRP.
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = O_ZSEGSD0009-VKGRP.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-VKGRP,
O_ZSEGSD0009-ZTBEZEI.
ENDIF.
ENDIF.

* E-2-1-3．受注先の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR1 <> I_ZSEGSD0009_INI-ZEKUNNR1.
SELECT NAME1 UP TO 1 ROWS                 " 受注先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR1.     " 受注先
EXIT.
ENDSELECT.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR1,
O_ZSEGSD0009-ZEKNAME1.
ENDIF.
ENDIF.

* E-2-1-4．出荷先の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR <> I_ZSEGSD0009_INI-ZEKUNNR.
SELECT NAME1 UP TO 1 ROWS                 " 出荷先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR.     " 出荷先
EXIT.
ENDSELECT.
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR,
O_ZSEGSD0009-ZEKNAME.
ENDIF.
ENDIF.

* E-2-1-5．最終需要者の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR2 <> I_ZSEGSD0009_INI-ZEKUNNR2.
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME2       " 最終需要者名称
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR2.
" 最終需要者
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR2,
O_ZSEGSD0009-ZEKNAME2.
ENDIF.
ENDIF.

* E-2-1-6．最終需要者(商流)の名称の再設定処理。
IF O_ZSEGSD0009-ZEKUNNR3 <> I_ZSEGSD0009_INI-ZEKUNNR3.
SELECT SINGLE NAME1
INTO O_ZSEGSD0009-ZEKNAME3       " 最終需要者(商流)名称
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR3.
" 最終需要者(商流)
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKUNNR3,
O_ZSEGSD0009-ZEKNAME3.
ENDIF.
ENDIF.

* E-2-1-7．営業員の氏名の再設定処理。
IF O_ZSEGSD0009-PERNR <> I_ZSEGSD0009_INI-PERNR.
SELECT SINGLE ENAME
INTO O_ZSEGSD0009-ENAME          " 営業員の氏名
FROM PA0001
WHERE PERNR =  O_ZSEGSD0009-PERNR " 営業員
AND BEGDA <= I_W_DATE           " 開始日付
AND ENDDA >= I_W_DATE.          " 終了日付
IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-PERNR,
O_ZSEGSD0009-ENAME.
ENDIF.
ENDIF.

*  E-2-2-2．明細の数量と金額項目が変更された場合、
*  受注額の再計算処理を行う。
CLEAR LW_NETWR.
LOOP AT I_TD_ITEM_ALV_INI INTO LST_ALV_INI.

READ TABLE O_TD_ITEM_ALV ASSIGNING <LFS_ALV> INDEX SY-TABIX.

IF LST_ALV_INI-KWMENG <> <LFS_ALV>-KWMENG
OR LST_ALV_INI-VRKME <> <LFS_ALV>-VRKME
OR LST_ALV_INI-ZVRKME <> <LFS_ALV>-ZVRKME.

CLEAR:
LW_KWMENG,
LW_MENG_ALV.

LW_MENG_ALV = <LFS_ALV>-KWMENG.

CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR                   = <LFS_ALV>-MATNR
I_IN_ME                   = <LFS_ALV>-VRKME
I_OUT_ME                  = <LFS_ALV>-ZVRKME
I_MENGE                   = LW_MENG_ALV
IMPORTING
E_MENGE                   = LW_KWMENG
EXCEPTIONS
ERROR_IN_APPLICATION      = 1
ERROR                     = 2
OTHERS                    = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE TO SCREEN 9000.
ELSE.
<LFS_ALV>-NETWR = LW_KWMENG
* <LFS_ALV>-NETPR
/ <LFS_ALV>-KPEIN.
ENDIF.
LW_CHANGE = ABAP_ON.
ENDIF.
LW_NETWR = <LFS_ALV>-NETWR + LW_NETWR.

ENDLOOP.

IF LW_CHANGE IS NOT INITIAL.
O_ZSEGSD0009-NETWR = LW_NETWR.
ENDIF.

*  E-2-2-3．ヘッダの通貨項目が変更された場合、
* 「FS:明細」-通貨は同様に設定
IF O_ZSEGSD0009-WAERK <> I_ZSEGSD0009_INI-WAERK.
LOOP AT O_TD_ITEM_ALV ASSIGNING <LFS_ALV1>.
<LFS_ALV1>-WAERK = O_ZSEGSD0009-WAERK.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_9000_AGAIN

*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE TYP_ZSEGSD0009.

DATA:
LW_EBELN TYPE ZTEGSDT203-EBELN.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " LOCK_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE TYP_ZSEGSD0009.

DATA:
LW_EBELN TYPE ZTEGSDT203-EBELN.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN.

ENDFORM.                    " LOCK_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       F-2．データ更新処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_H USING I_ST_ZSEGSD0009 TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
I_W_DATE        TYPE SY-DATUM
I_W_TIME        TYPE SY-UZEIT.

DATA:
LST_ALV  TYPE ZSEGSD0010,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_EBELP TYPE EBELP.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.
LW_EBELN = I_ST_ZSEGSD0009-BSTKD.
LW_EBELP = LST_ALV-POSNR.
UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2        " 処理区分
STATUS       = CNS_STATUS_A        " ステータス
VKBUR        = I_ST_ZSEGSD0009-VKBUR
" 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP
" 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1
" 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR
" 出荷先
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2
" 最終需要者
ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3
" 最終需要者(商流)
PERNR        = I_ST_ZSEGSD0009-PERNR
" 営業員
MATNR        = LST_ALV-MATNR      " 品目コード
TXZ01        = LST_ALV-ARKTX      " テキスト (短)
MENGE        = LST_ALV-KWMENG     " 購買発注量
MEINS        = LST_ALV-VRKME      " 発注単位
NETPR        = LST_ALV-NETPR      " 正味価格
WAERS        = LST_ALV-WAERK      " 通貨コード
PEINH        = LST_ALV-KPEIN      " 価格単位
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
ZTERM        = LST_ALV-ZTERM      " 支払条件キー
Z_MOD_YMD    = I_W_DATE           " 更新年月日
Z_MOD_HMS    = I_W_TIME           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新時分秒
WHERE EBELN = LW_EBELN
AND EBELP = LW_EBELP.
IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
*   データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  APP_9000_DATA
*&---------------------------------------------------------------------*
*       G.Approve
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009    SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV      SCREEN9000明細データ
*      <--O_TD_PROCESS       ITAB:ALV処理対象データ
*----------------------------------------------------------------------*
FORM APP_9000_DATA USING I_ST_ZSEGSD0009   TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV     TYPE TYP_TD_ITEM
CHANGING O_TD_PROCESS      TYPE TYP_TD_ERRALVDATA.

DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LST_ITEM_ALV  TYPE ZSEGSD0010.

LOOP AT I_TD_ITEM_ALV INTO LST_ITEM_ALV.

LST_PROCESS-VKORG     = I_ST_ZSEGSD0009-VKORG.
" 販売組織
LST_PROCESS-VTWEG     = I_ST_ZSEGSD0009-VTWEG.
" 流通チャネル
LST_PROCESS-SPART     = I_ST_ZSEGSD0009-SPART.
" 製品部門
LST_PROCESS-VKBUR     = I_ST_ZSEGSD0009-VKBUR.
" 営業所
LST_PROCESS-VKGRP     = I_ST_ZSEGSD0009-VKGRP.
" 営業グループ
LST_PROCESS-KUNNR     = I_ST_ZSEGSD0009-ZEKUNNR1.
" 受注先
LST_PROCESS-NAME1     = I_ST_ZSEGSD0009-ZEKNAME1.
" 受注先名称
LST_PROCESS-ZEKUNNR   = I_ST_ZSEGSD0009-ZEKUNNR.
" 出荷先
LST_PROCESS-ZEKNAME   = I_ST_ZSEGSD0009-ZEKNAME.
" 出荷先名称
LST_PROCESS-ZKUNNR_ZJ = I_ST_ZSEGSD0009-ZEKUNNR2.
" 最終需要者
LST_PROCESS-ZKUNNR_DS = I_ST_ZSEGSD0009-ZEKUNNR3.
" 最終需要者(商流)
LST_PROCESS-PERNR     = I_ST_ZSEGSD0009-PERNR.
" 営業員
LST_PROCESS-ZEEMNAM   = I_ST_ZSEGSD0009-ENAME.
" 営業員氏名
LST_PROCESS-BSTKD     = I_ST_ZSEGSD0009-BSTKD.
" 購買発注番号
LST_PROCESS-BSTDK     = I_ST_ZSEGSD0009-BSTDK.
" 購買発注伝票日付
LST_PROCESS-BSART     = I_ST_ZSEGSD0009-BSART.
" 購買伝票タイプ
LST_PROCESS-KNTTP     = I_ST_ZSEGSD0009-KNTTP.
" 勘定設定カテゴリ
LST_PROCESS-MATNR     = LST_ITEM_ALV-MATNR.
" 品目コード
LST_PROCESS-ARKTX     = LST_ITEM_ALV-ARKTX.
" 品目テキスト
LST_PROCESS-KWMENG    = LST_ITEM_ALV-KWMENG.
" 数量
LST_PROCESS-VRKME     = LST_ITEM_ALV-VRKME.
" 単位
LST_PROCESS-NETPR     = LST_ITEM_ALV-NETPR.
" 単価
LST_PROCESS-WAERK     = LST_ITEM_ALV-WAERK.
" 通貨
LST_PROCESS-KPEIN     = LST_ITEM_ALV-KPEIN.
" /
LST_PROCESS-ZVRKME    = LST_ITEM_ALV-ZVRKME.
" UoM
LST_PROCESS-NETWR     = LST_ITEM_ALV-NETWR.
" 受注額
LST_PROCESS-WERKS     = LST_ITEM_ALV-WERKS.
" 出荷プラント
LST_PROCESS-EDATU     = LST_ITEM_ALV-EDATU.
" 納入期日
LST_PROCESS-DZTERM    = LST_ITEM_ALV-ZTERM.
" 支払条件
LST_PROCESS-EBELP     = LST_ITEM_ALV-POSNR.
" 購買伝票の明細番号
APPEND LST_PROCESS TO O_TD_PROCESS.
CLEAR LST_PROCESS.

ENDLOOP.

ENDFORM.                    " APP_9000_DATA

*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_9000
*&---------------------------------------------------------------------*
*       G-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      -->I_W_DATE         システム日付
*      -->I_W_TIME         システム時刻
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_9000 USING I_KBUNCC        TYPE C
I_STATUS        TYPE C
I_ST_ZSEGSD0009 TYPE TYP_ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
I_W_DATE        TYPE SY-DATUM
I_W_TIME        TYPE SY-UZEIT.

DATA:
LST_ALV  TYPE ZSEGSD0010,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_EBELP TYPE EBELP.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.
LW_EBELN = I_ST_ZSEGSD0009-BSTKD.
LW_EBELP = LST_ALV-POSNR.
UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC            " 処理区分
STATUS       = I_STATUS            " ステータス
VKBUR        = I_ST_ZSEGSD0009-VKBUR
" 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP
" 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1
" 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR
" 出荷先
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2
" 最終需要者
ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3
" 最終需要者(商流)
PERNR        = I_ST_ZSEGSD0009-PERNR
" 営業員
MATNR        = LST_ALV-MATNR      " 品目コード
TXZ01        = LST_ALV-ARKTX      " テキスト (短)
MENGE        = LST_ALV-KWMENG     " 購買発注量
MEINS        = LST_ALV-VRKME      " 発注単位
NETPR        = LST_ALV-NETPR      " 正味価格
WAERS        = LST_ALV-WAERK      " 通貨コード
PEINH        = LST_ALV-KPEIN      " 価格単位
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
ZTERM        = LST_ALV-ZTERM      " 支払条件キー
Z_MOD_YMD    = I_W_DATE           " 更新年月日
Z_MOD_HMS    = I_W_TIME           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新時分秒
WHERE EBELN = LW_EBELN
AND EBELP = LW_EBELP.
IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
*   データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H

*&---------------------------------------------------------------------*
*&      Form  FRM_F4_SHOW
*&---------------------------------------------------------------------*
*       F4　help
*----------------------------------------------------------------------*
FORM FRM_F4_SHOW.

DATA: LTD_RETURN TYPE TABLE OF DDSHRETVAL,
LST_RETURN TYPE DDSHRETVAL,
L_ROW      TYPE I,
LST_STAB   TYPE LVC_S_STBL,
LTD_ZTERM  TYPE STANDARD TABLE OF TYP_ZTERM,
LST_ZTERM  TYPE TYP_ZTERM,
LST_ITEM   TYPE ZSEGSD0010.

SELECT ZTERM
TEXT1
FROM T052U
INTO TABLE LTD_ZTERM.

APPEND INITIAL LINE TO LTD_ZTERM.

CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
EXPORTING
RETFIELD        = CNS_FNM_ZTERM
VALUE_ORG       = 'S'
TABLES
VALUE_TAB       = LTD_ZTERM
RETURN_TAB      = LTD_RETURN
EXCEPTIONS
PARAMETER_ERROR = 1
NO_VALUES_FOUND = 2
OTHERS          = 3.
* エラー
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
READ TABLE LTD_RETURN INTO LST_RETURN INDEX 1.
IF SY-SUBRC = 0.
CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
E_ROW         = L_ROW.

READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX L_ROW.
IF SY-SUBRC = 0.
CLEAR LST_ZTERM.
READ TABLE LTD_ZTERM INTO LST_ZTERM
WITH KEY ZTERM = LST_RETURN-FIELDVAL.
LST_ITEM-ZTERM = LST_RETURN-FIELDVAL.
LST_ITEM-TEXT1 = LST_ZTERM-TEXT1.
MODIFY TD_ITEM_ALV FROM LST_ITEM INDEX L_ROW.
ENDIF.

LST_STAB-ROW = ABAP_ON.
LST_STAB-COL = ABAP_ON.
CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY
EXPORTING
IS_STABLE          = LST_STAB.
ENDIF.
ENDIF.

ENDFORM.                    " FRM_F4_SHOW
*&---------------------------------------------------------------------*
*&      Module  COMMAND_EXIT　INPUT
*&---------------------------------------------------------------------*
*       EXIT 事件
*----------------------------------------------------------------------*
MODULE COMMAND_EXIT INPUT.

CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
IF SY-DATAR = ABAP_ON.
W_CHANGED = ABAP_ON.
ENDIF.
IF LW_VALID IS INITIAL
OR W_CHANGED IS NOT INITIAL
OR TD_ITEM_ALV <> TD_ITEM_ALV_INI.
*   終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.
*   POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ELSEIF LW_ANSWER = 1.
LEAVE TO SCREEN 0.
CLEAR W_CHANGED.
ENDIF.
ENDIF.

CASE OK_CODE.
WHEN CNS_USER_BACK.
IF TD_ITEM_ALV_INI = TD_ITEM_ALV.
LEAVE TO SCREEN 0.
ELSE.
*       終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.
*       POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ELSEIF LW_ANSWER = 1.
LEAVE TO SCREEN 0.
ENDIF.
ENDIF.
WHEN CNS_USER_EXIT.
IF TD_ITEM_ALV_INI = TD_ITEM_ALV.
LEAVE TO SCREEN 0.
ELSE.
*       終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.
*       POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ELSEIF LW_ANSWER = 1.
LEAVE TO SCREEN 0.
ENDIF.
ENDIF.
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDMODULE.                 " COMMAND_EXIT  INPUT
*&---------------------------------------------------------------------*
*&      Form  CHK_WAERK
*&---------------------------------------------------------------------*
*       通貨チェック
*----------------------------------------------------------------------*
FORM CHK_WAERK .

SELECT COUNT(*)
FROM TCURC
WHERE WAERS = ST_ZSEGSD0009-WAERK.
IF SY-SUBRC <> 0.
*    通貨コード & は存在しません
MESSAGE S641(Z1) WITH ST_ZSEGSD0009-WAERK
DISPLAY LIKE CNS_MSG_E.
SET CURSOR FIELD 'ST_ZSEGSD0009-WAERK'.
LEAVE TO SCREEN 9000.
ENDIF.

ENDFORM.                    " CHK_WAERK

MODULE M_CHECK.
V_FLG = ABAP_ON.

ENDMODULE.
*Text symbol text・
*B01:Delete
*B02:YES
*B03:NO
*B04:Confirm
*P01:Approved List (Sales Order are not created yet.)
*Selection text・
*P_VKORG:        Sales Organization
*RB_APP:        Approve
*RB_ERR:        Error recovery
*RB_LIST:        Appr. List(SO are not created)
*S_DATE:        Create Date
*S_SPART:        Division
*S_VKBUR:        Sales Office
*S_VKGRP:        Sales Group
*S_VTWEG:        Distribution Channel
