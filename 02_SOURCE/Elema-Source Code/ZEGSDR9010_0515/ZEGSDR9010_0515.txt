*&---------------------------------------------------------------------*
*& プログラムID : ZEGSDR9010
*& 作成者       : iSiD Xiao
*& 作成日       : 2015/03/16
*& 処理概要     : Sales Orderの一括アップロードを行う。
*&---------------------------------------------------------------------*
*& 改定履歴
*& No   DATE       MODIFYED BY   SUMMARY
*& 1    2015/05/04 ISID18        BAPI変更
*& 2    2015/05/14 ISID18        OrderUnit書式変更
*&---------------------------------------------------------------------*
**** start upd 2015/05/04 isid18 ****
*REPORT  zegsdr9010_test.
REPORT  zegsdr9010_0515.
**** end upd 2015/05/04 isid18 ****

*&----------------------------------------------------------------------
* 定数の宣言
*&----------------------------------------------------------------------
CONSTANTS:
cns_slash       TYPE c VALUE '\',          "File path split
cns_rfile(4)    TYPE c VALUE 'RST_',       "Result file
cns_efile(4)    TYPE c VALUE 'ERR_',       "Error file
cns_tab         TYPE c VALUE cl_abap_char_utilities=>horizontal_tab,
cns_ftype(10)   TYPE c VALUE 'ASC',        "File type
cns_tcd1(4)     TYPE c VALUE 'VA01',
cns_tcd2(4)     TYPE c VALUE 'VA02',
cns_parnr_ag    TYPE parvw  VALUE 'AG',    "取引先機能
cns_parnr_we    TYPE parvw  VALUE 'WE',    "取引先機能
cns_parnr_re    TYPE parvw  VALUE 'RE',    "取引先機能
cns_parnr_rg    TYPE parvw  VALUE 'RG',    "取引先機能
cns_parnr_ve    TYPE parvw  VALUE 'VE',    "取引先機能
cns_parnr_ze    TYPE parvw  VALUE 'ZE',    "取引先機能
cns_parnr_zj    TYPE parvw  VALUE 'ZJ',    "取引先機能
cns_parnr_zp    TYPE parvw  VALUE 'ZP',    "取引先機能
cns_posnr_00    TYPE posnr  VALUE '000000',"明細番号
cns_tdid_0001   TYPE tdid   VALUE '0001',  "テキスト ID
cns_tdid_0002   TYPE tdid   VALUE '0002',  "テキスト ID
cns_tdid_z010   TYPE tdid   VALUE 'Z010',  "テキスト ID
cns_tdid_9001   TYPE tdid   VALUE '9001',  "テキスト ID
**** start add 2015/05/04 isid18 ****
cns_tdid_z910   TYPE tdid   VALUE 'Z910',  "テキスト ID
cns_date_type   TYPE char1  VALUE '1',     "日付タイプ (日、週、月、期間)
cns_vbtyp_c     TYPE vbtyp  VALUE 'C',
cns_vbtyp_h     TYPE vbtyp  VALUE 'H',
cns_vbtyp_k     TYPE vbtyp  VALUE 'K',
cns_vbtyp_l     TYPE vbtyp  VALUE 'L',
cns_auart_cr    TYPE auart  VALUE 'CR',
cns_auart_dr    TYPE auart  VALUE 'DR',
cns_auart_zcr   TYPE auart  VALUE 'ZCR',
cns_auart_zdr   TYPE auart  VALUE 'ZDR',
**** end add 2015/05/04 isid18 ****
cns_format      TYPE tdformat VALUE '*',   "タグ列
cns_sched       TYPE etenr  VALUE '0001',  "納入日程行
cns_htype       TYPE datatype_d VALUE 'NUMC',"Number type
cns_update      TYPE char1  VALUE 'U',     "更新区分
cns_insert      TYPE char1  VALUE 'I',     "更新区分
cns_msg_a       TYPE c VALUE 'A',            "Message type
cns_msg_s       TYPE c VALUE 'S',
cns_msg_w       TYPE c VALUE 'W',
cns_msg_e       TYPE c VALUE 'E'.

*&----------------------------------------------------------------------
* 型定義
*&----------------------------------------------------------------------
TYPES:
* File field for server file
BEGIN OF typ_sfile,
field TYPE string,
END OF typ_sfile,
typ_td_sfile TYPE STANDARD TABLE OF typ_sfile,

* File field for Local file
BEGIN OF typ_file,
tcd        TYPE char4,          "TCD
gflag(1)   TYPE c,              "GroupFlag
auart      TYPE vbak-auart,     "DocType
vkorg      TYPE vbak-vkorg,     "SalesOrg
vtweg      TYPE vbak-vtweg,     "DistChannel
spart      TYPE vbak-spart,     "Division
vkbur      TYPE vbak-vkbur,     "SalesOffice
vkgrp      TYPE vbak-vkgrp,     "SalesGrp
vbeln      TYPE vbak-vbeln,     "SONo
bstkd      TYPE vbkd-bstkd,     "CustPurchNo
bstdk      TYPE vbkd-bstdk,     "CustPurchDate
audat      TYPE vbak-audat,     "DocDate
prsdt      TYPE vbkd-prsdt,     "PriceDate
lifsk      TYPE vbak-lifsk,     "ShipBlock
augru      TYPE vbak-augru,     "OrderReason
waerk      TYPE vbak-waerk,     "NetPriceCurrency
submi      TYPE vbak-submi,     "CollectNo
**** start add 2015/05/04 isid18 ****
bname      TYPE vbak-bname,     "OrderName
**** end add 2015/05/04 isid18 ****
soldto     TYPE kunnr,          "SoldTo
shipto     TYPE kunnr,          "ShipTo
ship_name  TYPE name1_gp,       "ShipToName1
ship_name2 TYPE name2_gp,       "ShipToName2
ship_name3 TYPE name3_gp,       "ShipToName3
countr_iso TYPE land1_iso,      "ShipToCountryCode
postl_code TYPE pstlz,          "ShipToPostalCode
street     TYPE stras_gp,       "ShipToAddress1
city       TYPE ort01_gp,       "ShipToAddress2
telephone  TYPE telf1,          "ShipToTel
fax_number TYPE telfx,          "ShipToFax
billto     TYPE kunnr,          "BillTo
payer      TYPE kunnr,          "Payer
saemp      TYPE kunnr,          "SalesEmployee
edupri     TYPE kunnr,          "EndUserPrice
eduexp     TYPE kunnr,          "EndUserExport
saassis    TYPE kunnr,          "SalesAssistant
**** start upd 2015/05/04 isid18 ****
*    langu_iso  TYPE laiso,          "TextLanguage
zterm      TYPE vbkd-zterm,     "PaymentTerms
**** end upd 2015/05/04 isid18 ****
inbrem     TYPE tdline,         "TextHdrInboundRemarks
tabrem     TYPE tdline,         "TextHdrDNRemarks
sorem      TYPE tdline,         "TextHdrSORemarks
**** start upd 2015/05/04 isid18 ****
*    itm_number TYPE posnr_va,       "Item
itm_number TYPE char6,          "Item
pstyv      TYPE vbap-pstyv,     "Item category
**** end upd 2015/05/04 isid18 ****
material   TYPE matnr,          "Material
short_text TYPE arktx,          "MaterialText
plant      TYPE werks_d,        "Plant
store_loc  TYPE lgort_d,        "SLoc
req_date   TYPE edatu,          "DeliveryDate
req_qty    TYPE char17,         "SOQty
**** start upd 2015/05/04 isid18 ****
*    cond_unit  TYPE kmein,          "OrderUnit
cond_unit  TYPE char3,          "OrderUnit
bstkd_item TYPE vbkd-bstkd,     "CustomerPONoItm
bstdk_item TYPE vbkd-bstdk,     "CustomerPODateItm
reason_rej TYPE abgru,          "RejectReason
**** end upd 2015/05/04 isid18 ****
cond_type  TYPE kscha,          "CondType
cond_value TYPE char17,         "NetPrice
cond_p_unt TYPE char5,          "PriceUnit
itemrem    TYPE tdline,         "TextItmShipRemarks
**** start add 2015/05/04 isid18 ****
transrem   TYPE tdline,         "TextItmTransportMeans
**** end add 2015/05/04 isid18 ****
END OF typ_file,
typ_td_file TYPE STANDARD TABLE OF typ_file,

* Field for message
BEGIN OF typ_msg,
col1 TYPE string,
col2 TYPE string,
col3 TYPE string,
**** start add 2015/05/04 isid18 ****
col4 TYPE string,
**** end add 2015/05/04 isid18 ****
END OF typ_msg,
typ_td_msg TYPE STANDARD TABLE OF typ_msg,

* File field for result file
BEGIN OF typ_rfile,
col1 TYPE string,
col2 TYPE string,
col3 TYPE string,
**** start add 2015/05/04 isid18 ****
col4 TYPE string,
**** end add 2015/05/04 isid18 ****
END OF typ_rfile,
typ_td_rfile TYPE STANDARD TABLE OF typ_rfile,

* Type for BAPI parameter
typ_td_soitem         TYPE STANDARD TABLE OF bapisditm,      "Item Data
typ_td_soitemx        TYPE STANDARD TABLE OF bapisditmx,     "Item Data Checkbox
typ_td_parnr          TYPE STANDARD TABLE OF bapiparnr,      "Document Partner
typ_td_parnrc         TYPE STANDARD TABLE OF bapiparnrc,     "Document Partner Change
typ_td_parnrad        TYPE STANDARD TABLE OF bapiaddr1,      "Document Partner Address
typ_td_soschedule     TYPE STANDARD TABLE OF bapischdl,      "Schedule Line Data
typ_td_soschedulex    TYPE STANDARD TABLE OF bapischdlx,     "Checkbox Schedule Line Data
typ_td_socondition    TYPE STANDARD TABLE OF bapicond,       "Conditions
typ_td_soconditionx   TYPE STANDARD TABLE OF bapicondx,      "Conditions Checkbox
typ_td_sotext         TYPE STANDARD TABLE OF bapisdtext.     "Texts

*&----------------------------------------------------------------------
* 内部テーブル定義
*&----------------------------------------------------------------------
DATA:
w_codepage  TYPE abap_encoding,"Codepage
w_flgutf8   TYPE flag,         "UTF-8
w_tnum      TYPE i,            "Total number
w_snum      TYPE i,            "Success number
w_enum      TYPE i,            "Error number
td_file     TYPE typ_td_file,  "Input file
td_efile    TYPE typ_td_file,  "Error file
td_msg      TYPE typ_td_msg.   "msg table

*&----------------------------------------------------------------------
* 変数の定義
*&----------------------------------------------------------------------
DATA:
w_werks TYPE werks_d.

*&----------------------------------------------------------------------
* 選択画面定義(1000)
*&----------------------------------------------------------------------
SELECTION-SCREEN BEGIN OF BLOCK bl1 WITH FRAME TITLE text-001.

SELECTION-SCREEN BEGIN OF LINE.
* サーバ
SELECTION-SCREEN POSITION 33.
PARAMETERS:p_serve RADIOBUTTON GROUP rb1 DEFAULT 'X'.
SELECTION-SCREEN: COMMENT 36(8) text-002.
* ローカル
SELECTION-SCREEN POSITION 46.
PARAMETERS:p_local RADIOBUTTON GROUP rb1.
SELECTION-SCREEN: COMMENT 49(6) text-003.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
* テスト実行
SELECTION-SCREEN POSITION 33.
PARAMETERS: p_tstck AS CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN: COMMENT 36(8) text-004.

SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK bl1.

SELECTION-SCREEN BEGIN OF BLOCK bl2 WITH FRAME TITLE text-005.

* Input file
PARAMETERS: p_ifile   TYPE rlgrap-filename OBLIGATORY.
* Result file
PARAMETERS: p_rfile   TYPE rlgrap-filename.
* Error file
PARAMETERS: p_efile   TYPE rlgrap-filename.

SELECTION-SCREEN END OF BLOCK bl2.

SELECTION-SCREEN BEGIN OF BLOCK bl3 WITH FRAME TITLE text-006.
* Plant
SELECT-OPTIONS: s_werks FOR w_werks OBLIGATORY.
SELECTION-SCREEN END OF BLOCK bl3.

*----------------------------------------------------------------------*
* INITIALIZATION
*----------------------------------------------------------------------*
INITIALIZATION.
* 初期処理
PERFORM init_data.

*----------------------------------------------------------------------*
* AT SELETION-SCREEN
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
* 入力チェック
PERFORM check_input.

AT SELECTION-SCREEN OUTPUT.
* Modify screen
PERFORM modify_screen.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_ifile.
* 検索ヘルプ
PERFORM f4_for_file.

*----------------------------------------------------------------------*
* START-OF-SELECTION
*----------------------------------------------------------------------*
START-OF-SELECTION.
* 主処理
PERFORM main_process.

*---------------------------------------------------------------------
* TOP-OF-PAGE
*---------------------------------------------------------------------
TOP-OF-PAGE.
* ヘッダ出力
PERFORM output_head.

*&---------------------------------------------------------------------*
*&      Form  INIT_DATA
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
FORM init_data .

* Modify screen
PERFORM modify_screen.

ENDFORM.                    " INIT_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       入力チェック
*----------------------------------------------------------------------*
FORM check_input .

TYPES: BEGIN OF ltyp_werks,
werks TYPE t001w-werks,
END OF ltyp_werks.

DATA: ltd_werks   TYPE STANDARD TABLE OF ltyp_werks,
lst_werks   TYPE ltyp_werks.

* A-1-1．入力チェック
* プラントコード存在チェック
SELECT werks
INTO TABLE ltd_werks
FROM t001w
WHERE werks IN s_werks.
IF sy-subrc <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
*   プラント ( &1 ) は存在しません
MESSAGE e004(zmegsd01) WITH s_werks-low.
ENDIF.

* A-1-2．権限チェック
LOOP AT ltd_werks INTO lst_werks.
AUTHORITY-CHECK OBJECT 'M_MSEG_WMB'
ID 'WERKS' FIELD lst_werks-werks
ID 'ACTVT' FIELD '01'.
IF sy-subrc <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
*     プラントに対する実行権限がありません
MESSAGE e003(zmegsd01).

ENDIF.
ENDLOOP.

* Result & Error ファイル名取得
PERFORM set_rfile.

ENDFORM.                    " CHECK_INPUT

*&---------------------------------------------------------------------*
*&      Form  F4_FOR_FILE
*&---------------------------------------------------------------------*
*       ファイル名取得
*----------------------------------------------------------------------*
FORM f4_for_file .

DATA:lt_file           TYPE filetable,   "ファイル名一覧格納テーブル
lv_filename(1024) TYPE c,           "ヘッダ
lv_rc             TYPE i.           "結果

CALL METHOD cl_gui_frontend_services=>file_open_dialog
CHANGING
file_table              = lt_file    "ファイル名一覧格納テーブル
rc                      = lv_rc      "結果
EXCEPTIONS
file_open_dialog_failed = 1
cntl_error              = 2
error_no_gui            = 3
not_supported_by_gui    = 4
OTHERS                  = 5.

IF  sy-subrc = 0
AND lv_rc  >= 0.                             " 結果
READ TABLE lt_file INTO lv_filename INDEX 1.
IF sy-subrc = 0.
*     ファイル名を選択画面にセット
p_ifile = lv_filename.

*     Result & Error ファイル名取得
PERFORM set_rfile.

ENDIF.
ELSE.
*   エラーの場合
MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
ENDIF.

ENDFORM.                    " F4_FOR_FILE

*&---------------------------------------------------------------------*
*&      Form  MODIFY_SCREEN
*&---------------------------------------------------------------------*
*       Modify screen
*----------------------------------------------------------------------*
FORM modify_screen .
* Modify screen
LOOP AT SCREEN.
IF screen-name = 'P_RFILE' OR
screen-name = 'P_EFILE'.
screen-input = '0'.
MODIFY SCREEN.
ENDIF.
ENDLOOP.
ENDFORM.                    " MODIFY_SCREEN

*&---------------------------------------------------------------------*
*&      Form  SET_RFILE
*&---------------------------------------------------------------------*
*       Result & Error ファイル名取得
*----------------------------------------------------------------------*
FORM set_rfile .

DATA:
lw_shiftn   TYPE i,
lw_path     TYPE rlgrap-filename,
lw_fullname TYPE rlgrap-filename,
lw_filename TYPE rlgrap-filename,
lw_rfile    TYPE rlgrap-filename,
lw_efile    TYPE rlgrap-filename.

IF p_ifile IS NOT INITIAL.
lw_fullname = p_ifile.
* search for '\'
DO.
SEARCH lw_fullname FOR cns_slash.
IF sy-subrc > 0.
lw_filename = lw_fullname.
EXIT.
ENDIF.
lw_shiftn = sy-fdpos + 1.
SHIFT lw_fullname BY lw_shiftn PLACES LEFT.
ENDDO.
ENDIF.


IF lw_filename IS NOT INITIAL.
lw_fullname = p_ifile.
*   Get path
SEARCH lw_fullname FOR lw_filename.
lw_path = lw_fullname(sy-fdpos).
CONDENSE lw_fullname.

*   Get result file
CONCATENATE lw_path cns_rfile lw_filename INTO lw_rfile.
p_rfile = lw_rfile.

*   Get error file
CONCATENATE lw_path cns_efile lw_filename INTO lw_efile.
p_efile = lw_efile.
ENDIF.

ENDFORM.                    " SET_RFILE

*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
FORM main_process .

* A-2. ファイル取込
PERFORM get_data CHANGING td_file.

* A-3&A-4．データ処理
PERFORM process_data CHANGING td_file
td_efile
td_msg.

* A-5．画面出力・ファイル出力
PERFORM process_result USING td_efile
td_msg.

ENDFORM.                    " MAIN_PROCESS

*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*       ファイル取込
*----------------------------------------------------------------------*
FORM get_data CHANGING o_td_file TYPE typ_td_file.

IF p_serve = abap_on.
*   A-2-1．ファイル取込（Server）
PERFORM get_data_serve CHANGING o_td_file.
ELSE.
*   A-2-2．ファイル取込（Local）
PERFORM get_data_local CHANGING o_td_file.
ENDIF.

ENDFORM.                    " GET_DATA

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_SERVE
*&---------------------------------------------------------------------*
*       A-2-1．ファイル取込（Server）
*----------------------------------------------------------------------*
*      <--O_TD_FILE   File data
*----------------------------------------------------------------------*
FORM get_data_serve  CHANGING o_td_file TYPE typ_td_file.

DATA:
lw_z_output_cp     TYPE ztegzzm001-z_output_cp,
lw_sapcodepage     TYPE string,
lst_sfile          TYPE typ_sfile,
ltd_sfile          TYPE typ_td_sfile.

* A-2-1-1．文字コードの取得
CALL FUNCTION 'ZEG_ZZ_GLOBAL_PGM_CONFIG_GET'
EXPORTING
imppgm      = sy-repid
impbukrs    = space
IMPORTING
expcodepage = lw_z_output_cp
expflgutf8  = w_flgutf8.
IF lw_z_output_cp IS INITIAL.
*  データが存在しない場合
MESSAGE s051(zmegsd01) WITH text-e01 sy-repid
DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.
lw_sapcodepage = lw_z_output_cp.

IF lw_sapcodepage IS NOT INITIAL.
w_codepage = cl_abap_codepage=>sap_codepage( lw_sapcodepage ).
ENDIF.

* A-2-1-2．アップロードデータの取込
IF w_flgutf8 IS INITIAL.
TRY.
OPEN DATASET p_ifile FOR INPUT
IN LEGACY TEXT MODE CODE PAGE w_codepage
IGNORING CONVERSION ERRORS.
CATCH  cx_sy_codepage_converter_init.
sy-subrc = 8.
ENDTRY.
ELSE.
OPEN DATASET p_ifile FOR INPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS
SKIPPING BYTE-ORDER MARK.
ENDIF.
IF sy-subrc <> 0.
*   エラーが発生した場合
MESSAGE s035(zmegsd01) WITH p_ifile DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

* 読込み
DO.
CLEAR lst_sfile.
READ DATASET p_ifile INTO lst_sfile-field.
IF sy-subrc <> 0.
EXIT.
ELSE.
APPEND lst_sfile TO ltd_sfile.
ENDIF.
ENDDO.

* ファイルクローズ
CLOSE DATASET p_ifile.

IF ltd_sfile IS NOT INITIAL.
*   タブで区切って編集
PERFORM split_file USING    ltd_sfile
CHANGING o_td_file.
ENDIF.

ENDFORM.                    " GET_DATA_SERVE

*&---------------------------------------------------------------------*
*&      Form  SPLIT_FILE
*&---------------------------------------------------------------------*
*       入力ファイルをタブで区切る
*----------------------------------------------------------------------*
*      -->I_TD_SFILE  Server File data
*      <--O_TD_FILE   File data
*----------------------------------------------------------------------*
FORM split_file  USING    i_td_sfile TYPE typ_td_sfile
CHANGING o_td_file  TYPE typ_td_file.

DATA:
lst_sfile  TYPE typ_sfile,
lst_file   TYPE typ_file,
lw_item(6) TYPE c.

LOOP AT i_td_sfile INTO lst_sfile.
CLEAR lst_file.

SPLIT lst_sfile-field
AT cns_tab
INTO lst_file-tcd            "TCD
lst_file-gflag          "GroupFlag
lst_file-auart          "DocType
lst_file-vkorg          "SalesOrg
lst_file-vtweg          "DistChannel
lst_file-spart          "Division
lst_file-vkbur          "SalesOffice
lst_file-vkgrp          "SalesGrp
lst_file-vbeln          "SONo
lst_file-bstkd          "CustPurchNo
lst_file-bstdk          "CustPurchDate
lst_file-audat          "DocDate
lst_file-prsdt          "PriceDate
lst_file-lifsk          "ShipBlock
lst_file-augru          "OrderReason
lst_file-waerk          "NetPriceCurrency
lst_file-submi          "CollectNo
**** start add 2015/05/04 isid18 ****
lst_file-bname          "OrderName
**** end add 2015/05/04 isid18 ****
lst_file-soldto         "SoldTo
lst_file-shipto         "ShipTo
lst_file-ship_name      "ShipToName1
lst_file-ship_name2     "ShipToName2
lst_file-ship_name3     "ShipToName3
lst_file-countr_iso     "ShipToCountryCode
lst_file-postl_code     "ShipToPostalCode
lst_file-street         "ShipToAddress1
lst_file-city           "ShipToAddress2
lst_file-telephone      "ShipToTel
lst_file-fax_number     "ShipToFax
lst_file-billto         "BillTo
lst_file-payer          "Payer
lst_file-saemp          "SalesEmployee
lst_file-edupri         "EndUserPrice
lst_file-eduexp         "EndUserExport
lst_file-saassis        "SalesAssistant
**** start upd 2015/05/04 isid18 ****
*          lst_file-langu_iso      "TextLanguage
lst_file-zterm          "PaymentTerms
**** end upd 2015/05/04 isid18 ****
lst_file-inbrem         "TextHdrInboundRemarks
lst_file-tabrem         "TextHdrDNRemarks
lst_file-sorem          "TextHdrSORemarks
lw_item                 "Item
**** start add 2015/05/04 isid18 ****
lst_file-pstyv          "Itemcategory
**** end add 2015/05/04 isid18 ****
lst_file-material       "Material
lst_file-short_text     "MaterialText
lst_file-plant          "Plant
lst_file-store_loc      "SLoc
lst_file-req_date       "DeliveryDate
lst_file-req_qty        "SOQty
lst_file-cond_unit      "OrderUnit
**** start add 2015/05/04 isid18 ****
lst_file-bstkd_item     "CustomerPONoItm
lst_file-bstdk_item     "CustomerPODateItm
lst_file-reason_rej     "RejectReason
**** end add 2015/05/04 isid18 ****
lst_file-cond_type      "CondType
lst_file-cond_value     "NetPrice
lst_file-cond_p_unt     "PriceUnit
lst_file-itemrem        "TextItmShipRemarks
**** start add 2015/05/04 isid18 ****
lst_file-transrem.      "TextItmTransportMeans
**** end add 2015/05/04 isid18 ****
lst_file-itm_number = lw_item.    "Item
APPEND lst_file TO o_td_file.
ENDLOOP.

ENDFORM.                    " SPLIT_FILE

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_LOCAL
*&---------------------------------------------------------------------*
*       A-2-2．ファイル取込（Local）
*----------------------------------------------------------------------*
*      <--O_TD_FILE   File data
*----------------------------------------------------------------------*
FORM get_data_local CHANGING o_td_file TYPE typ_td_file.

DATA:
lw_encoding TYPE abap_encoding,
lw_rc       TYPE i,
lv_filename TYPE string.

* A-2-2-1．文字コードの取得
CALL METHOD cl_gui_frontend_services=>get_saplogon_encoding
CHANGING
file_encoding                 = lw_encoding
rc                            = lw_rc
EXCEPTIONS
cntl_error                    = 1
error_no_gui                  = 2
not_supported_by_gui          = 3
cannot_initialize_globalstate = 4
OTHERS                        = 5.

* A-2-2-2．アップロードデータの取込
lv_filename = p_ifile.
CALL FUNCTION 'GUI_UPLOAD'
EXPORTING
filename                = lv_filename
filetype                = cns_ftype
has_field_separator     = cns_tab
codepage                = lw_encoding
TABLES
data_tab                = o_td_file
EXCEPTIONS
file_open_error         = 1
file_read_error         = 2
no_batch                = 3
gui_refuse_filetransfer = 4
invalid_type            = 5
no_authority            = 6
unknown_error           = 7
bad_data_format         = 8
header_not_allowed      = 9
separator_not_allowed   = 10
header_too_long         = 11
unknown_dp_error        = 12
access_denied           = 13
dp_out_of_memory        = 14
disk_full               = 15
dp_timeout              = 16
OTHERS                  = 17.
* エラーが発生した場合
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE cns_msg_s NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    " GET_DATA_LOCAL

*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
*       データ処理
*----------------------------------------------------------------------*
*      <--O_TD_FILE   File data
*      <--O_TD_EFILE  Error File data
*      <--O_TD_MSG    Error message table
*----------------------------------------------------------------------*
FORM process_data CHANGING o_td_file  TYPE typ_td_file
o_td_efile TYPE typ_td_file
o_td_msg   TYPE typ_td_msg.

DATA:
lw_index           TYPE sy-index,       "Line row
lw_index_so        TYPE sy-index,       "SO header row
lw_eflg            TYPE c,              "Every row check flag
lw_eflg_bapi       TYPE c,              "BAPI executive flag
lw_eflg_g          TYPE c,              "Group error check
lw_tcd(4)          TYPE c,
lst_file           TYPE typ_file,
ltd_efile          TYPE typ_td_file,
lw_col             TYPE i,
lw_typ             TYPE c,
lw_vbeln           TYPE vbeln,          "SO No
lw_bstkd           TYPE vbkd-bstkd,     "CustPurchNo
lw_bstdk           TYPE vbkd-bstdk,     "CustPurchDate
lw_waers           TYPE vbak-waerk,     "NetPriceCurrency
lw_spras           TYPE laiso,          "TextLanguage
**** start add 2015/05/04 isid18 ****
lw_bus_type        TYPE bapiusw01-objtype,
lw_auart           TYPE char4,
lst_file_bak       TYPE typ_file,
**** end add 2015/05/04 isid18 ****
lst_soheader       TYPE bapisdhd1,      "Order Header
lst_soheaderx      TYPE bapisdhd1x,     "Sales Order Check List
ltd_soitem         TYPE STANDARD TABLE OF bapisditm,      "Item Data
ltd_soitemx        TYPE STANDARD TABLE OF bapisditmx,     "Item Data Checkbox
ltd_parnr          TYPE STANDARD TABLE OF bapiparnr,      "Document Partner
ltd_parnrc         TYPE STANDARD TABLE OF bapiparnrc,     "Document Partner Change
ltd_parnrad        TYPE STANDARD TABLE OF bapiaddr1,      "Document Partner Address
ltd_soschedule     TYPE STANDARD TABLE OF bapischdl,      "Schedule Line Data
ltd_soschedulex    TYPE STANDARD TABLE OF bapischdlx,     "Checkbox Schedule Line Data
ltd_socondition    TYPE STANDARD TABLE OF bapicond,       "Conditions
ltd_soconditionx   TYPE STANDARD TABLE OF bapicondx,      "Conditions Checkbox
ltd_sotext         TYPE STANDARD TABLE OF bapisdtext,     "Texts\
**** start upd 2015/05/04 isid18 ****
*    lst_soheader_c     TYPE bapisdh1,      "Order Header
*    lst_soheaderx_c    TYPE bapisdh1x.     "Sales Order Check List
lst_soheader_c     TYPE bapisdhd1,      "Order Header
lst_soheaderx_c    TYPE bapisdhd1x.     "Sales Order Check List
**** end upd 2015/05/04 isid18 ****

* A-3-1．ファイル形式チェック
READ TABLE o_td_file INTO lst_file INDEX 1.
DESCRIBE FIELD lst_file TYPE lw_typ COMPONENTS lw_col.
**** start upd 2015/05/04 isid18 ****
*  IF lw_col <> 50.
IF lw_col <> 56.
**** end upd 2015/05/04 isid18 ****
MESSAGE s089(zmegsd01) DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

**** start add 2015/05/04 isid18 ****
* ヘッダ行削除
DELETE o_td_file INDEX 1.
**** end add 2015/05/04 isid18 ****

LOOP AT o_td_file INTO lst_file.
**** start add 2015/05/04 isid18 ****
CLEAR lst_file_bak.
**** end add 2015/05/04 isid18 ****
lw_index = sy-tabix.

IF lst_file-tcd IS NOT INITIAL AND
lst_file-gflag IS NOT INITIAL.
*     A-4-1-2．BAPIの実行
IF lw_tcd = cns_tcd1.
IF lw_eflg_g <> abap_on.
PERFORM so_create_execute USING lw_index_so
**** start add 2015/05/04 isid18 ****
lw_bus_type
**** end add 2015/05/04 isid18 ****
lst_soheader
lst_soheaderx
ltd_soitem
ltd_soitemx
ltd_parnr
ltd_soschedule
ltd_soschedulex
ltd_socondition
ltd_soconditionx
ltd_sotext
CHANGING  lw_eflg_bapi
o_td_msg.
**** start add 2015/05/04 isid18 ****
ELSE.
w_enum = w_enum + 1.
**** end add 2015/05/04 isid18 ****
ENDIF.
CLEAR lw_eflg_g.
ELSEIF lw_tcd = cns_tcd2.
IF lw_eflg <> abap_on.
PERFORM so_change_execute USING lw_index_so
lw_vbeln
**** start add 2015/05/04 isid18 ****
lw_bus_type
**** end add 2015/05/04 isid18 ****
lst_soheader_c
lst_soheaderx_c
ltd_soitem
ltd_soitemx
ltd_parnr
ltd_parnrc
ltd_parnrad
ltd_soschedule
ltd_soschedulex
ltd_socondition
ltd_soconditionx
ltd_sotext
CHANGING  lw_eflg_bapi
o_td_msg.
**** start add 2015/05/04 isid18 ****
ELSE.
w_enum = w_enum + 1.
**** end add 2015/05/04 isid18 ****
ENDIF.
CLEAR lw_eflg_g.
ENDIF.
*     Edit error file data
IF lw_eflg_bapi = abap_on.
APPEND LINES OF ltd_efile TO o_td_efile.
CLEAR lw_eflg_bapi.
ELSE.
REFRESH ltd_efile.
ENDIF.

CLEAR:
lw_tcd,
lw_index_so,
lw_bstkd,
lw_bstdk,
lw_waers,
lw_spras,
lw_vbeln,
**** start add 2015/05/04 isid18 ****
lw_bus_type,
lw_eflg_g,
lw_auart,
**** end add 2015/05/04 isid18 ****
lst_soheader,
lst_soheaderx,
lst_soheader_c,
lst_soheaderx_c.
REFRESH:
ltd_soitem,
ltd_soitemx,
ltd_parnr,
ltd_parnrc,
ltd_parnrad,
ltd_soschedule,
ltd_soschedulex,
ltd_socondition,
ltd_soconditionx,
ltd_sotext.

**** start add 2015/05/04 isid18 ****
PERFORM get_object_type
USING    lst_file-auart
CHANGING lw_bus_type.
**** end add 2015/05/04 isid18 ****

lw_tcd      = lst_file-tcd.    "Tcode
lw_index_so = lw_index.        "PO row id
*     For relation data check
lw_vbeln    = lst_file-vbeln.     "SO No
lw_bstkd    = lst_file-bstkd.     "CustPurchNo
lw_bstdk    = lst_file-bstdk.     "CustPurchDate
lw_waers    = lst_file-waerk.     "NetPriceCurrency
**** start del 2015/05/04 isid18 ****
*      lw_spras    = lst_file-langu_iso. "TextLanguage
**** end del 2015/05/04 isid18 ****
ELSE.
**** start upd 2015/05/04 isid18 ****
*      lst_file-vbeln     = lw_vbeln.    "SO No
*      lst_file-bstkd     = lw_bstkd.    "CustPurchNo
*      lst_file-bstdk     = lw_bstdk.    "CustPurchDate
*      lst_file-waerk     = lw_waers.    "NetPriceCurrency
*      lst_file-langu_iso = lw_spras.    "TextLanguage
IF lst_file-vbeln IS INITIAL.
lst_file-vbeln     = lw_vbeln.    "SO No
ENDIF.
IF lst_file-bstkd IS INITIAL.
lst_file-bstkd     = lw_bstkd.    "CustPurchNo
ENDIF.
IF lst_file-bstdk IS INITIAL.
lst_file-bstdk     = lw_bstdk.    "CustPurchDate
ENDIF.
IF lst_file-waerk IS INITIAL.
lst_file-waerk     = lw_waers.    "NetPriceCurrency
ENDIF.
**** end upd 2015/05/04 isid18 ****
ENDIF.

*   A-3-2．データチェック
CLEAR lw_eflg.
PERFORM check_data USING    lw_index
CHANGING lst_file
lw_eflg
o_td_msg.
IF lw_eflg = abap_on.
**** start upd 2015/05/04 isid18 ****
*      APPEND lst_file TO o_td_efile.
lst_file_bak = lst_file.
CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
EXPORTING
input  = lst_file_bak-auart
IMPORTING
output = lst_file_bak-auart.
APPEND lst_file_bak TO o_td_efile.
**** end upd 2015/05/04 isid18 ****
lw_eflg_g = abap_on.
CONTINUE.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*    APPEND lst_file TO ltd_efile.
lst_file_bak = lst_file.
CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
EXPORTING
input  = lst_file_bak-auart
IMPORTING
output = lst_file_bak-auart.
APPEND lst_file_bak TO ltd_efile.
**** end upd 2015/05/04 isid18 ****

IF lw_tcd = cns_tcd1.
*     A-4-1-1．BAPIのパラメータ設定
PERFORM so_create_edit USING    lst_file
CHANGING lst_soheader
lst_soheaderx
ltd_soitem
ltd_soitemx
ltd_parnr
ltd_soschedule
ltd_soschedulex
ltd_socondition
ltd_soconditionx
ltd_sotext.
ELSEIF lw_tcd = cns_tcd2.
*     A-4-2-1．bapiのパラメータ設定
PERFORM so_change_edit USING    lst_file
CHANGING lw_vbeln
**** start add 2015/05/04 isid18 ****
lw_auart
**** end add 2015/05/04 isid18 ****
lst_soheader_c
lst_soheaderx_c
ltd_soitem
ltd_soitemx
ltd_parnr
ltd_parnrc
ltd_parnrad
ltd_soschedule
ltd_soschedulex
ltd_socondition
ltd_soconditionx
ltd_sotext.
ENDIF.

ENDLOOP.

* Last transaction
IF lw_eflg_g <> abap_on.
IF lw_tcd = cns_tcd1.
PERFORM so_create_execute USING lw_index_so
**** start add 2015/05/04 isid18 ****
lw_bus_type
**** end add 2015/05/04 isid18 ****
lst_soheader
lst_soheaderx
ltd_soitem
ltd_soitemx
ltd_parnr
ltd_soschedule
ltd_soschedulex
ltd_socondition
ltd_soconditionx
ltd_sotext
CHANGING  lw_eflg_bapi
o_td_msg.
ELSEIF lw_tcd = cns_tcd2.
PERFORM so_change_execute USING lw_index_so
lw_vbeln
**** start add 2015/05/04 isid18 ****
lw_bus_type
**** end add 2015/05/04 isid18 ****
lst_soheader_c
lst_soheaderx_c
ltd_soitem
ltd_soitemx
ltd_parnr
ltd_parnrc
ltd_parnrad
ltd_soschedule
ltd_soschedulex
ltd_socondition
ltd_soconditionx
ltd_sotext
CHANGING  lw_eflg_bapi
o_td_msg.

ENDIF.

IF lw_eflg_bapi = abap_on.
APPEND LINES OF ltd_efile TO o_td_efile.
ELSE.
REFRESH ltd_efile.
ENDIF.
**** start add 2015/05/04 isid18 ****
ELSE.
w_enum = w_enum + 1.
**** end add 2015/05/04 isid18 ****
ENDIF.

ENDFORM.                    " PROCESS_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_DATA
*&---------------------------------------------------------------------*
*       A-3.データチェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      <--I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM check_data USING    i_w_index   TYPE sy-index
CHANGING i_st_file   TYPE typ_file
o_w_eflg    TYPE c
o_td_msg    TYPE typ_td_msg.

**** start add 2015/05/04 isid18 ****
PERFORM check_gflag USING i_w_index
i_st_file.
**** end add 2015/05/04 isid18 ****

* A-3-2-1．TCDのチェック
IF i_st_file-tcd IS NOT INITIAL AND
i_st_file-gflag IS NOT INITIAL.
**** start upd 2015/05/04 isid18 ****
*    PERFORM check_tcd USING i_st_file
PERFORM check_tcd USING    i_w_index
i_st_file
**** end upd 2015/05/04 isid18 ****
CHANGING o_w_eflg
o_td_msg.
IF o_w_eflg = abap_on.
RETURN.
ENDIF.
ENDIF.

* A-3-2-3．データ変換処理
**** start upd 2015/05/14 isid18 ****
*  PERFORM data_conversion CHANGING i_st_file.
PERFORM data_conversion USING    i_w_index
CHANGING i_st_file
o_w_eflg
o_td_msg.
IF o_w_eflg = abap_on.
RETURN.
ENDIF.
**** end upd 2015/05/14 isid18 ****

* A-3-2-2．プラントチェック
PERFORM check_werks USING    i_w_index
i_st_file
CHANGING o_w_eflg
o_td_msg.
IF o_w_eflg = abap_on.
RETURN.
ENDIF.

* A-3-2-4．日付形式チェック
PERFORM check_date USING    i_w_index
i_st_file
CHANGING o_w_eflg
o_td_msg.
IF o_w_eflg = abap_on.
RETURN.
ENDIF.

* A-3-2-5．数値形式チェック
PERFORM check_number USING    i_w_index
i_st_file
CHANGING o_w_eflg
o_td_msg.
IF o_w_eflg = abap_on.
RETURN.
ENDIF.

* A-3-2-6．相関チェック①
PERFORM check_relation1 USING    i_w_index
i_st_file
CHANGING o_w_eflg
o_td_msg.
IF o_w_eflg = abap_on.
RETURN.
ENDIF.

* A-3-2-7．相関チェック②
**** start del 2015/05/04 isid18 ***
*  PERFORM check_relation2 USING    i_w_index
*                                   i_st_file
*                          CHANGING o_w_eflg
*                                   o_td_msg.
*  IF o_w_eflg = abap_on.
*    RETURN.
*  ENDIF.
**** end del 2015/05/04 isid18 ****

ENDFORM.                    " CHECK_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_TCD
*&---------------------------------------------------------------------*
*       TCDのチェック
*----------------------------------------------------------------------*
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
**** start upd 2015/05/04 isid18 ****
*FORM check_tcd  USING    i_st_file TYPE typ_file
FORM check_tcd  USING    i_w_index   TYPE sy-index
i_st_file TYPE typ_file
**** end upd 2015/05/04 isid18 ****
CHANGING o_w_eflg  TYPE c
o_td_msg  TYPE typ_td_msg.

DATA:
lw_msg   TYPE string,
lst_msg  TYPE typ_msg.

**** start add 2015/05/04 isid18 ****
DATA: lw_rmsg  TYPE string,
lw_row   TYPE string.
lw_row = i_w_index.
CONDENSE lw_row.
CONCATENATE text-033 lw_row text-034
text-035 i_st_file-itm_number
INTO lw_rmsg SEPARATED BY space.
**** end add 2015/05/04 isid18 ****

IF i_st_file-tcd <> cns_tcd1 AND
i_st_file-tcd <> cns_tcd2.
MESSAGE s090(zmegsd01) WITH i_st_file-tcd INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
ENDIF.

ENDFORM.                    " CHECK_TCD

*&---------------------------------------------------------------------*
*&      Form  CHECK_WERKS
*&---------------------------------------------------------------------*
*       プラントチェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM check_werks  USING    i_w_index   TYPE sy-index
i_st_file   TYPE typ_file
CHANGING o_w_eflg    TYPE c
o_td_msg  TYPE typ_td_msg.

DATA:
lw_msg   TYPE string,
lst_msg  TYPE typ_msg.

**** start add 2015/05/04 isid18 ****
DATA: lw_rmsg  TYPE string,
lw_row   TYPE string.
lw_row = i_w_index.
CONDENSE lw_row.
CONCATENATE text-033 lw_row text-034
text-035 i_st_file-itm_number
INTO lw_rmsg SEPARATED BY space.
**** end add 2015/05/04 isid18 ****

IF i_st_file-plant NOT IN s_werks.
MESSAGE s091(zmegsd01) WITH i_w_index i_st_file-plant
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
ENDIF.

ENDFORM.                    " CHECK_WERKS

*&---------------------------------------------------------------------*
*&      Form  DATA_CONVERSION
*&---------------------------------------------------------------------*
*       データ変換処理
*----------------------------------------------------------------------*
*      <--O_ST_FILE  ファイル データ
*----------------------------------------------------------------------*
**** start upd 2015/05/14 isid18 ****
*FORM data_conversion  CHANGING o_st_file TYPE typ_file.
FORM data_conversion  USING    i_w_index TYPE sy-index
CHANGING o_st_file TYPE typ_file
o_w_eflg  TYPE c
o_td_msg  TYPE typ_td_msg.

DATA:
lw_msg   TYPE string,
lst_msg  TYPE typ_msg,
lw_rmsg  TYPE string,
lw_row   TYPE string.

lw_row = i_w_index.
CONDENSE lw_row.
CONCATENATE text-033 lw_row text-034
text-035 o_st_file-itm_number
INTO lw_rmsg SEPARATED BY space.
**** end upd 2015/05/14 isid18 ****

* DocType
* * 大文字変換
TRANSLATE o_st_file-auart TO UPPER CASE.
*
CALL FUNCTION 'CONVERSION_EXIT_AUART_INPUT'
EXPORTING
input  = o_st_file-auart
IMPORTING
output = o_st_file-auart.

* SalesOrg
TRANSLATE o_st_file-vkorg TO UPPER CASE.

* DistChannel
TRANSLATE o_st_file-vtweg TO UPPER CASE.

* Division
TRANSLATE o_st_file-spart TO UPPER CASE.

* SalesOffice
TRANSLATE o_st_file-vkbur TO UPPER CASE.

* SalesGrp
TRANSLATE o_st_file-vkgrp TO UPPER CASE.

* SONo
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-vbeln
IMPORTING
output = o_st_file-vbeln.

* ShipBlock
TRANSLATE o_st_file-lifsk TO UPPER CASE.

* OrderReason
TRANSLATE o_st_file-augru TO UPPER CASE.

* SoldTo
TRANSLATE o_st_file-soldto TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-soldto
IMPORTING
output = o_st_file-soldto.

* ShipTo
TRANSLATE o_st_file-shipto TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-shipto
IMPORTING
output = o_st_file-shipto.

* ShipToCountryCode
TRANSLATE o_st_file-countr_iso TO UPPER CASE.

* BillTo
TRANSLATE o_st_file-billto TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-billto
IMPORTING
output = o_st_file-billto.

* Payer
TRANSLATE o_st_file-payer TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-payer
IMPORTING
output = o_st_file-payer.

* SalesEmployee
TRANSLATE o_st_file-saemp TO UPPER CASE.

* EndUserPrice
TRANSLATE o_st_file-edupri TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-edupri
IMPORTING
output = o_st_file-edupri.

* EndUserExport
TRANSLATE o_st_file-eduexp TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
input  = o_st_file-eduexp
IMPORTING
output = o_st_file-eduexp.

* SalesAssistant
TRANSLATE o_st_file-saassis TO UPPER CASE.

**** start add 2015/05/04 isid18 ****
* PaymentTerms
TRANSLATE o_st_file-zterm TO UPPER CASE.
* ItemCategory
TRANSLATE o_st_file-pstyv TO UPPER CASE.
**** end add 2015/05/04 isid18 ****

* Material
TRANSLATE o_st_file-material TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
EXPORTING
input        = o_st_file-material
IMPORTING
output       = o_st_file-material
EXCEPTIONS
**** start upd 2015/05/14 isid18 ****
*      length_error = 0
*      OTHERS       = 0.
length_error = 1
OTHERS       = 2.
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
**** end upd 2015/05/14 isid18 ****

* Plant
TRANSLATE o_st_file-plant TO UPPER CASE.

* SLoc
TRANSLATE o_st_file-store_loc TO UPPER CASE.

* CondType
TRANSLATE o_st_file-cond_type TO UPPER CASE.

**** start add 2015/05/14 isid18 ****
* OrderUnit
CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT'
EXPORTING
input          = o_st_file-cond_unit
IMPORTING
output         = o_st_file-cond_unit
EXCEPTIONS
unit_not_found = 1
OTHERS         = 2.
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
**** end add 2015/05/14 isid18 ****

**** start add 2015/05/04 isid18 ****
* RejectReason
TRANSLATE o_st_file-reason_rej TO UPPER CASE.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " DATA_CONVERSION

*&---------------------------------------------------------------------*
*&      Form  CHECK_DATE
*&---------------------------------------------------------------------*
*       日付形式チェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM check_date  USING    i_w_index   TYPE sy-index
i_st_file   TYPE typ_file
CHANGING o_w_eflg    TYPE c
o_td_msg    TYPE typ_td_msg.
DATA:
lw_msg   TYPE string,
lst_msg  TYPE typ_msg,
lw_date  TYPE sy-datum.

**** start add 2015/05/04 isid18 ****
DATA: lw_rmsg  TYPE string,
lw_row   TYPE string.
lw_row = i_w_index.
CONDENSE lw_row.
CONCATENATE text-033 lw_row text-034
text-035 i_st_file-itm_number
INTO lw_rmsg SEPARATED BY space.
**** end add 2015/05/04 isid18 ****

* CustPurchDate
IF i_st_file-bstdk IS NOT INITIAL.
lw_date = i_st_file-bstdk.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
date                      = lw_date
EXCEPTIONS
plausibility_check_failed = 1
OTHERS                    = 2.
IF sy-subrc <> 0.
CLEAR: lw_msg,
lst_msg.
MESSAGE s092(zmegsd01) WITH i_w_index text-e02
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
ENDIF.

* DocDate
IF i_st_file-audat IS NOT INITIAL.
lw_date = i_st_file-audat.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
date                      = lw_date
EXCEPTIONS
plausibility_check_failed = 1
OTHERS                    = 2.
IF sy-subrc <> 0.
MESSAGE s092(zmegsd01) WITH i_w_index text-e03
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
ENDIF.

* PriceDate
IF i_st_file-prsdt IS NOT INITIAL.
lw_date = i_st_file-prsdt.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
date                      = lw_date
EXCEPTIONS
plausibility_check_failed = 1
OTHERS                    = 2.

IF sy-subrc <> 0.
CLEAR: lw_msg,
lst_msg.
MESSAGE s092(zmegsd01) WITH i_w_index text-e04
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
ENDIF.

**** start add 2015/05/04 isid18 ****
IF i_st_file-req_date IS NOT INITIAL.
lw_date = i_st_file-req_date.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
date                      = lw_date
EXCEPTIONS
plausibility_check_failed = 1
OTHERS                    = 2.
IF sy-subrc <> 0.
CLEAR: lw_msg,
lst_msg.
MESSAGE s092(zmegsd01) WITH i_w_index text-e09
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
ENDIF.

IF i_st_file-bstdk_item IS NOT INITIAL.
lw_date = i_st_file-bstdk_item.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
date                      = lw_date
EXCEPTIONS
plausibility_check_failed = 1
OTHERS                    = 2.
IF sy-subrc <> 0.
CLEAR: lw_msg,
lst_msg.
MESSAGE s092(zmegsd01) WITH i_w_index text-e08
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.
ENDIF.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " CHECK_DATE

*&---------------------------------------------------------------------*
*&      Form  CHECK_NUMBER
*&---------------------------------------------------------------------*
*       数値形式チェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM check_number  USING    i_w_index   TYPE sy-index
i_st_file   TYPE typ_file
CHANGING o_w_eflg    TYPE c
o_td_msg    TYPE typ_td_msg.

DATA:
lw_msg   TYPE string,
lst_msg  TYPE typ_msg,
lw_htype TYPE dd01v-datatype.

**** start add 2015/05/04 isid18 ****
DATA: lw_rmsg  TYPE string,
lw_row   TYPE string.
lw_row = i_w_index.
CONDENSE lw_row.
CONCATENATE text-033 lw_row text-034
text-035 i_st_file-itm_number
INTO lw_rmsg SEPARATED BY space.
**** end add 2015/05/04 isid18 ****

* SOQty
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
string_in = i_st_file-req_qty
IMPORTING
htype     = lw_htype.
IF lw_htype <> cns_htype.
CLEAR: lw_msg,
lst_msg.
MESSAGE s093(zmegsd01) WITH i_w_index text-e05
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.

* NetPrice
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
string_in = i_st_file-cond_value
IMPORTING
htype     = lw_htype.
IF lw_htype <> cns_htype.
CLEAR: lw_msg,
lst_msg.
MESSAGE s093(zmegsd01) WITH i_w_index text-e06
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.

* PriceUnit
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
string_in = i_st_file-cond_p_unt
IMPORTING
htype     = lw_htype.
IF lw_htype <> cns_htype.
CLEAR: lw_msg,
lst_msg.
MESSAGE s093(zmegsd01) WITH i_w_index text-e07
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.

ENDFORM.                    " CHECK_NUMBER

*&---------------------------------------------------------------------*
*&      Form  CHECK_RELATION1
*&---------------------------------------------------------------------*
*       相関チェック①
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM check_relation1  USING    i_w_index   TYPE sy-index
i_st_file   TYPE typ_file
CHANGING o_w_eflg    TYPE c
o_td_msg    TYPE typ_td_msg.

DATA:
lw_msg   TYPE string,
lst_msg  TYPE typ_msg.

**** start add 2015/05/04 isid18 ****
DATA: lw_rmsg  TYPE string,
lw_row   TYPE string.
lw_row = i_w_index.
CONDENSE lw_row.
CONCATENATE text-033 lw_row text-034
text-035 i_st_file-itm_number
INTO lw_rmsg SEPARATED BY space.
**** end add 2015/05/04 isid18 ****

* NetPriceCurrency, NetPrice,PriceUnit check
IF i_st_file-waerk IS NOT INITIAL OR
i_st_file-cond_value IS NOT INITIAL OR
i_st_file-cond_p_unt IS NOT INITIAL.

IF i_st_file-waerk IS INITIAL OR
i_st_file-cond_value IS INITIAL OR
i_st_file-cond_p_unt IS INITIAL.
MESSAGE s094(zmegsd01) WITH i_w_index
INTO lw_msg.
lst_msg-col1 = text-007.
lst_msg-col2 = text-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
**** end upd 2015/05/04 isid18 ****
APPEND lst_msg TO o_td_msg.
o_w_eflg = abap_on.
RETURN.
ENDIF.

ENDIF.

ENDFORM.                    " CHECK_RELATION1

*&---------------------------------------------------------------------*
*&      Form  CHECK_RELATION2
*&---------------------------------------------------------------------*
*       相関チェック②
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
**** start del 2015/05/04 isid18 ****
*FORM check_relation2  USING    i_w_index   TYPE sy-index
*                               i_st_file   TYPE typ_file
*                      CHANGING o_w_eflg    TYPE c
*                               o_td_msg    TYPE typ_td_msg.
*
*  DATA:
*    lw_msg   TYPE string,
*    lst_msg  TYPE typ_msg.
*
** TextLanguage check
*  IF i_st_file-inbrem  IS NOT INITIAL OR
*     i_st_file-tabrem  IS NOT INITIAL OR
*     i_st_file-sorem   IS NOT INITIAL OR
*     i_st_file-itemrem IS NOT INITIAL.
*
*    IF i_st_file-langu_iso IS INITIAL.
*      MESSAGE s095(zmegsd01) WITH i_w_index
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-008.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*      o_w_eflg = abap_on.
*      RETURN.
*    ENDIF.
*
*  ENDIF.
*
*ENDFORM.                    " CHECK_RELATION2
**** end del 2015/05/04 isid18 ****
*&---------------------------------------------------------------------*
*&      Form  SO_CREATE_EDIT
*&---------------------------------------------------------------------*
*       A-4-1-1．BAPIのパラメータ設定
*----------------------------------------------------------------------*
*      -->I_ST_FILE
*      <--o_st_soheader
*      <--o_st_soheaderx
*      <--o_td_soitem
*      <--o_td_soitemx
*      <--o_td_parnr
*      <--o_td_soschedule
*      <--o_td_soschedulex
*      <--o_td_socondition
*      <--o_td_soconditionx
*      <--o_td_sotext
*----------------------------------------------------------------------*
FORM so_create_edit  USING    i_st_file  TYPE typ_file
CHANGING o_st_soheader     TYPE bapisdhd1
o_st_soheaderx    TYPE bapisdhd1x
o_td_soitem       TYPE typ_td_soitem
o_td_soitemx      TYPE typ_td_soitemx
o_td_parnr        TYPE typ_td_parnr
o_td_soschedule   TYPE typ_td_soschedule
o_td_soschedulex  TYPE typ_td_soschedulex
o_td_socondition  TYPE typ_td_socondition
o_td_soconditionx TYPE typ_td_soconditionx
o_td_sotext       TYPE typ_td_sotext.

DATA:
lst_soitem       TYPE bapisditm,      "Item Data
lst_soitemx      TYPE bapisditmx,     "Item Data Checkbox
lst_parnr        TYPE bapiparnr,      "Document Partner
lst_soschedule   TYPE bapischdl,      "Schedule Line Data
lst_soschedulex  TYPE bapischdlx,     "Checkbox Schedule Line Data
lst_socondition  TYPE bapicond,       "Conditions
lst_soconditionx TYPE bapicondx,      "Conditions Checkbox
lst_sotext       TYPE bapisdtext.     "Texts

* A-4-1-1．BAPIのパラメータ設定
IF o_st_soheader IS INITIAL.
*   Order Header
o_st_soheader-doc_type   = i_st_file-auart.   "販売伝票タイプ
o_st_soheader-collect_no = i_st_file-submi.   "一括番号 (見積依頼/見積書)
o_st_soheader-sales_org  = i_st_file-vkorg.   "販売組織
o_st_soheader-distr_chan = i_st_file-vtweg.   "流通チャネル
o_st_soheader-division   = i_st_file-spart.   "製品部門
o_st_soheader-sales_grp  = i_st_file-vkgrp.   "営業グループ
o_st_soheader-sales_off  = i_st_file-vkbur.   "営業所
o_st_soheader-purch_date = i_st_file-bstdk.   "得意先発注日付
**** start add 2015/05/04 isid18 ****
o_st_soheader-name       = i_st_file-bname.   "発注者名称
o_st_soheader-pmnttrms   = i_st_file-zterm.   "支払条件キー
**** end add 2015/05/04 isid18 ****
o_st_soheader-dlv_block  = i_st_file-lifsk.   "出荷ブロック (伝票ヘッダ)
o_st_soheader-ord_reason = i_st_file-augru.   "受注理由 (取引理由)
o_st_soheader-price_date = i_st_file-prsdt.   "価格設定/換算レートの実施日付
o_st_soheader-purch_no_c = i_st_file-bstkd.   "得意先発注番号
o_st_soheader-doc_date   = i_st_file-audat.   "伝票日付 (受信日/送信日)

o_st_soheaderx-doc_type   = abap_on.          "販売伝票タイプ
IF o_st_soheader-collect_no IS NOT INITIAL.
o_st_soheaderx-collect_no = abap_on.          "一括番号 (見積依頼/見積書)
ENDIF.
o_st_soheaderx-sales_org  = abap_on.          "販売組織
o_st_soheaderx-distr_chan = abap_on.          "流通チャネル
o_st_soheaderx-division   = abap_on.          "製品部門
o_st_soheaderx-sales_grp  = abap_on.          "営業グループ
o_st_soheaderx-sales_off  = abap_on.          "営業所
o_st_soheaderx-purch_date = abap_on.          "得意先発注日付
**** start add 2015/05/04 isid18 ****
IF o_st_soheader-name IS NOT INITIAL.
o_st_soheaderx-name = abap_on.              "発注者名称
ENDIF.
o_st_soheaderx-pmnttrms = abap_on.            "支払条件キー
**** end add 2015/05/04 isid18 ****
IF o_st_soheader-dlv_block IS NOT INITIAL.
o_st_soheaderx-dlv_block  = abap_on.          "出荷ブロック (伝票ヘッダ)
ENDIF.
IF o_st_soheader-ord_reason IS NOT INITIAL.
o_st_soheaderx-ord_reason = abap_on.          "受注理由 (取引理由)
ENDIF.
o_st_soheaderx-price_date = abap_on.          "価格設定/換算レートの実施日付
o_st_soheaderx-purch_no_c = abap_on.          "得意先発注番号
o_st_soheaderx-doc_date   = abap_on.          "伝票日付 (受信日/送信日)

*   Document Partner
**** start add 2015/05/04 isid18 ****
IF i_st_file-soldto IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_ag.          "取引先機能
lst_parnr-partn_numb = i_st_file-soldto.      "得意先コード
APPEND lst_parnr TO o_td_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-shipto IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_we.          "取引先機能
lst_parnr-partn_numb = i_st_file-shipto.      "得意先コード
lst_parnr-name       = i_st_file-ship_name.   "名称 1
lst_parnr-name_2     = i_st_file-ship_name2.  "名称 2
lst_parnr-name_3     = i_st_file-ship_name3.  "名称 3
lst_parnr-street     = i_st_file-street.      "地名/番地-号
lst_parnr-countr_iso = i_st_file-countr_iso.  "国キー (ISO コード)
lst_parnr-postl_code = i_st_file-postl_code.  "郵便番号
lst_parnr-city       = i_st_file-city.        "市区町村
lst_parnr-telephone  = i_st_file-telephone.   "電話番号 1
lst_parnr-fax_number = i_st_file-fax_number.  "FAX 番号
APPEND lst_parnr TO o_td_parnr.
CLEAR lst_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-billto IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_re.          "取引先機能
lst_parnr-partn_numb = i_st_file-billto.      "得意先コード
APPEND lst_parnr TO o_td_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-payer IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_rg.          "取引先機能
lst_parnr-partn_numb = i_st_file-payer.      "得意先コード
APPEND lst_parnr TO o_td_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-saemp IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_ve.         "取引先機能
lst_parnr-partn_numb = i_st_file-saemp.      "得意先コード
APPEND lst_parnr TO o_td_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-edupri IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_ze.         "取引先機能
lst_parnr-partn_numb = i_st_file-edupri.     "得意先コード
APPEND lst_parnr TO o_td_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-eduexp IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_zj.         "取引先機能
lst_parnr-partn_numb = i_st_file-eduexp.     "得意先コード
APPEND lst_parnr TO o_td_parnr.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF i_st_file-saassis IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
lst_parnr-partn_role = cns_parnr_zp.         "取引先機能
lst_parnr-partn_numb = i_st_file-saassis.    "得意先コード
APPEND lst_parnr TO o_td_parnr.
**** start add 2015/05/04 isid18 ****
ENDIF.
**** end add 2015/05/04 isid18 ****

*   Texts
IF i_st_file-inbrem IS NOT INITIAL.
CLEAR lst_sotext-itm_number.                 "販売伝票明細
lst_sotext-text_id    = cns_tdid_0001.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.          "タグ列
lst_sotext-text_line  = i_st_file-inbrem.    "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*    IF i_st_file-inbrem IS NOT INITIAL.
IF i_st_file-tabrem IS NOT INITIAL.
**** end upd 2015/05/04 isid18 ****
CLEAR lst_sotext-itm_number.                 "販売伝票明細
lst_sotext-text_id    = cns_tdid_0002.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.          "タグ列
lst_sotext-text_line  = i_st_file-tabrem.    "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*    IF i_st_file-inbrem IS NOT INITIAL.
IF i_st_file-sorem IS NOT INITIAL.
**** end upd 2015/05/04 isid18 ****
CLEAR lst_sotext-itm_number.                 "販売伝票明細
lst_sotext-text_id    = cns_tdid_z010.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.          "タグ列
lst_sotext-text_line  = i_st_file-sorem.     "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.
ENDIF.

* Item Data
lst_soitem-itm_number = i_st_file-itm_number.   "販売伝票明細
lst_soitem-material   = i_st_file-material.     "品目コード
**** start add 2015/05/04 isid18 ****
lst_soitem-reason_rej = i_st_file-reason_rej.   "拒否理由
**** end add 2015/05/04 isid18 ****
lst_soitem-plant      = i_st_file-plant.        "プラント
lst_soitem-store_loc  = i_st_file-store_loc.    "保管場所
**** start add 2015/05/04 isid18 ****
lst_soitem-item_categ = i_st_file-pstyv.        "明細カテゴリ
**** end add 2015/05/04 isid18 ****
lst_soitem-short_text = i_st_file-short_text.   "受注明細のテキスト (短)
**** start upd 2015/05/04 isid18 ****
*  lst_soitem-purch_no_c = i_st_file-bstkd.        "得意先発注番号
*  lst_soitem-purch_date = i_st_file-bstdk.        "得意先発注日付
lst_soitem-purch_no_c = i_st_file-bstkd_item.   "得意先発注番号
lst_soitem-purch_date = i_st_file-bstdk_item.   "得意先発注日付
lst_soitem-target_qty = i_st_file-req_qty.      "目標数量
**** end upd 2015/05/04 isid18 ****
APPEND lst_soitem TO o_td_soitem.

lst_soitemx-itm_number = i_st_file-itm_number.   "販売伝票明細
lst_soitemx-material   = abap_on.               "品目コード
**** start add 2015/05/04 isid18 ****
IF lst_soitem-reason_rej IS NOT INITIAL.
lst_soitemx-reason_rej = abap_on.             "拒否理由
ENDIF.
**** end add 2015/05/04 isid18 ****
lst_soitemx-plant      = abap_on.               "プラント
IF lst_soitem-store_loc IS NOT INITIAL.
lst_soitemx-store_loc  = abap_on.               "保管場所
ENDIF.
**** start add 2015/05/04 isid18 ****
IF lst_soitem-item_categ IS NOT INITIAL.
lst_soitemx-item_categ = abap_on.               "明細カテゴリ
ENDIF.
**** end add 2015/05/04 isid18 ****
IF lst_soitem-short_text IS NOT INITIAL.
lst_soitemx-short_text = abap_on.               "受注明細のテキスト (短)
ENDIF.
**** start upd 2015/05/04 isid18 ****
*  lst_soitemx-purch_no_c = abap_on.               "得意先発注番号
*  lst_soitemx-purch_date = abap_on.               "得意先発注日付
IF lst_soitem-purch_no_c IS NOT INITIAL.
lst_soitemx-purch_no_c = abap_on.
ENDIF.
IF lst_soitem-purch_date IS NOT INITIAL.
lst_soitemx-purch_date = abap_on.              "得意先発注日付
ENDIF.
IF lst_soitem-target_qty IS NOT INITIAL.
lst_soitemx-target_qty = abap_on.              "目標数量
ENDIF.
**** end upd 2015/05/04 isid18 ****
APPEND lst_soitemx TO o_td_soitemx.

* Schedule Line Data
lst_soschedule-itm_number = i_st_file-itm_number. "購買伝票の明細番号
lst_soschedule-sched_line = cns_sched.            "納入日程行
lst_soschedule-req_date   = i_st_file-req_date.   "納入日付
**** start add 2015/05/04 isid18 ****
lst_soschedule-date_type  = cns_date_type.        "日付タイプ
**** end add 2015/05/04 isid18 ****
lst_soschedule-req_qty    = i_st_file-req_qty.    "計画数量
APPEND lst_soschedule TO o_td_soschedule.

lst_soschedulex-itm_number = i_st_file-itm_number.  "購買伝票の明細番号
lst_soschedulex-sched_line = abap_on.               "納入日程行
lst_soschedulex-req_date   = abap_on.               "納入期日カテゴリ
**** start add 2015/05/04 isid18 ****
lst_soschedulex-date_type  = abap_on.               "日付タイプ
**** end add 2015/05/04 isid18 ****
lst_soschedulex-req_qty    = abap_on.               "計画数量
APPEND lst_soschedulex TO o_td_soschedulex.

* Conditions
lst_socondition-itm_number = i_st_file-itm_number.  "販売伝票明細
lst_socondition-cond_type  = i_st_file-cond_type.   "条件タイプ
lst_socondition-cond_value = i_st_file-cond_value.  "条件レート
lst_socondition-currency   = i_st_file-waerk.       "通貨コード
lst_socondition-cond_unit  = i_st_file-cond_unit.   "条件単位
lst_socondition-cond_p_unt = i_st_file-cond_p_unt.  "価格条件単位
APPEND lst_socondition TO o_td_socondition.

lst_soconditionx-itm_number = i_st_file-itm_number. "販売伝票明細
IF lst_socondition-cond_type IS NOT INITIAL.
lst_soconditionx-cond_type  = abap_on.              "条件タイプ
ENDIF.
IF lst_socondition-cond_value IS NOT INITIAL.
lst_soconditionx-cond_value = abap_on.              "条件レート
ENDIF.
IF lst_socondition-currency IS NOT INITIAL.
lst_soconditionx-currency   = abap_on.              "通貨コード
ENDIF.
lst_soconditionx-cond_unit  = abap_on.              "条件単位
IF lst_socondition-cond_p_unt IS NOT INITIAL.
lst_soconditionx-cond_p_unt = abap_on.              "価格条件単位
ENDIF.
APPEND lst_soconditionx TO o_td_soconditionx.

* Texts
IF i_st_file-itemrem IS NOT INITIAL.
lst_sotext-itm_number = i_st_file-itm_number.       "販売伝票明細
lst_sotext-text_id    = cns_tdid_9001.              "テキスト ID
**** start upd 2015/05/04 isid18 ****
*    lst_sotext-langu_iso  = i_st_file-langu_iso.        "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.                 "タグ列
lst_sotext-text_line = i_st_file-itemrem.           "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.

**** start of add 2015/05/04 isid18 ****
* Texts
IF i_st_file-transrem IS NOT INITIAL.
lst_sotext-itm_number = i_st_file-itm_number.        "販売伝票明細
lst_sotext-text_id = cns_tdid_z910.                  "テキスト ID
lst_sotext-langu      = sy-langu.
lst_sotext-format_col = cns_format.                  "タグ列
lst_sotext-text_line = i_st_file-transrem.           "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.
**** end of add 2015/05/04 isid18 ****

ENDFORM.                    " SO_CREATE_EDIT

*&---------------------------------------------------------------------*
*&      Form  SO_CREATE_EXECUTE
*&---------------------------------------------------------------------*
*       BAPIの実行
*----------------------------------------------------------------------*
*      -->I_w_INTEX           Index
*      -->i_st_soheader       Order Header
*      -->i_st_soheaderx      Sales Order Check List
*      -->i_td_soitem         Item Data
*      -->i_td_soitemx        Item Data Checkbox
*      -->i_td_parnr          Document Partner
*      -->i_td_soschedule     Schedule Line Data
*      -->i_td_soschedulex    Checkbox Schedule Line Data
*      -->i_td_socondition    Conditions
*      -->i_td_soconditionx   Conditions Checkbox
*      -->i_td_sotext         Texts
*      <--O_W_EFLG            Error Flag
*      <--O_TD_MSG            Error message table
*----------------------------------------------------------------------*
FORM so_create_execute  USING
i_w_index            TYPE sy-index
**** start upd 2015/05/04 isid18 ****
*                        i_st_soheader        TYPE bapisdhd1
*                        i_st_soheaderx       TYPE bapisdhd1x
i_w_bustype          TYPE bapiusw01-objtype
value(i_st_soheader) TYPE bapisdhd1
value(i_st_soheaderx) TYPE bapisdhd1x
**** end upd 2015/05/04 isid18 ****
i_td_soitem          TYPE typ_td_soitem
i_td_soitemx         TYPE typ_td_soitemx
i_td_parnr           TYPE typ_td_parnr
i_td_soschedule      TYPE typ_td_soschedule
i_td_soschedulex     TYPE typ_td_soschedulex
i_td_socondition     TYPE typ_td_socondition
i_td_soconditionx    TYPE typ_td_soconditionx
i_td_sotext          TYPE typ_td_sotext
CHANGING o_w_eflg    TYPE c
o_td_msg    TYPE typ_td_msg.
DATA:
lw_trun     TYPE bapiflag-bapiflag,
lw_so       TYPE bapivbeln-vbeln,
ltd_return  TYPE TABLE OF bapiret2,
lst_return  TYPE bapiret2,
lw_msg      TYPE string,
**** start add 2015/05/04 isid18 ****
lw_rmsg     TYPE string,
lw_index    TYPE int4,
lw_item     TYPE char6,
lst_soitem  TYPE bapisditm,
ltd_sched   TYPE typ_td_soschedule,
lth_sched   TYPE bapischdl,
**** end add 2015/05/04 isid18 ****
lw_row      TYPE string,
lst_msg     TYPE typ_msg.

IF p_tstck = abap_on.
lw_trun = abap_on.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*  CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
*    EXPORTING
*      order_header_in      = i_st_soheader
*      order_header_inx     = i_st_soheaderx
*      testrun              = lw_trun
*    IMPORTING
*      salesdocument        = lw_so
*    TABLES
*      return               = ltd_return
*      order_items_in       = i_td_soitem
*      order_items_inx      = i_td_soitemx
*      order_partners       = i_td_parnr
*      order_schedules_in   = i_td_soschedule
*      order_schedules_inx  = i_td_soschedulex
*      order_conditions_in  = i_td_socondition
*      order_conditions_inx = i_td_soconditionx
*      order_text           = i_td_sotext.
* Delivery Date
ltd_sched[] = i_td_soschedule.
SORT ltd_sched BY req_date DESCENDING.
READ TABLE ltd_sched INTO lth_sched INDEX 1.
i_st_soheader-req_date_h = lth_sched-req_date.
i_st_soheaderx-req_date_h = abap_on.
CALL FUNCTION 'SD_SALESDOCUMENT_CREATE'
EXPORTING
sales_header_in      = i_st_soheader
sales_header_inx     = i_st_soheaderx
business_object      = i_w_bustype
testrun              = lw_trun
IMPORTING
salesdocument_ex     = lw_so
TABLES
return               = ltd_return
sales_items_in       = i_td_soitem
sales_items_inx      = i_td_soitemx
sales_partners       = i_td_parnr
sales_schedules_in   = i_td_soschedule
sales_schedules_inx  = i_td_soschedulex
sales_conditions_in  = i_td_socondition
sales_conditions_inx = i_td_soconditionx
sales_text           = i_td_sotext.
**** end upd 2015/05/04 isid18 ****

**** start del 2015/05/04 isid18 ****
*  w_tnum = w_tnum + 1.      "Total number
*  lw_row = i_w_index.
**** end del 2015/05/04 isid18 ****

* Test mode
**** start upd 2015/05/04 isid18 ****
*  IF p_tstck = abap_on.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return.
*      IF lst_return-type = cns_msg_e OR
*         lst_return-type = cns_msg_a.
*        o_w_eflg = abap_on.
*      ENDIF.
**     Output check message
*      IF lst_return-id IS NOT INITIAL AND
*         lst_return-type IS NOT INITIAL AND
*         lst_return-number IS NOT INITIAL.
*        MESSAGE ID lst_return-id TYPE lst_return-type
*          NUMBER lst_return-number
*          WITH lst_return-message_v1
*               lst_return-message_v2
*               lst_return-message_v3
*               lst_return-message_v4
*           INTO lw_msg.
*        CONDENSE lw_row.
*        CONCATENATE lw_msg text-031 lw_row text-032  INTO lw_msg.
*
*        CASE sy-msgty.
*          WHEN cns_msg_e OR
*                cns_msg_a.
*            lst_msg-col2 = text-008.
*          WHEN cns_msg_w.
*            lst_msg-col2 = text-030.
*          WHEN OTHERS.
*            lst_msg-col2 = text-009.
*        ENDCASE.
*        lst_msg-col1 = text-007.
*        lst_msg-col3 = lw_msg.
*        APPEND lst_msg TO o_td_msg.
*      ENDIF.
*    ENDLOOP.
*    IF o_w_eflg = abap_on.
*      w_enum = w_enum + 1.            "Error number
*    ELSE.
*      w_snum = w_snum + 1.            "Sucessful number
*    ENDIF.
*  ELSE.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return
*        WHERE type = cns_msg_e OR
*              type = cns_msg_a.
**     データ更新に失敗しました。(ROW = &1 / MSG = &2 )
*      MESSAGE s098(zmegsd01) WITH i_w_index lst_return-message
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-008.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*      o_w_eflg = abap_on.
*      w_enum = w_enum + 1.            "Error number
*
*      CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*      EXIT.
*    ENDLOOP.
*
**   BAPIから返した「RETURN」にエラーメッセージ存在しない場合
*    IF o_w_eflg <> abap_on.
*      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*        EXPORTING
*          wait = abap_on.
*
*      w_snum = w_snum + 1.            "Sucessful number
**     データ登録が正常終了しました。(ROW = &1 / SO= &2)
*      MESSAGE s103(zmegsd01) WITH i_w_index lw_so
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-009.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*    ENDIF.
*  ENDIF.
LOOP AT ltd_return INTO lst_return
WHERE type = cns_msg_e OR
type = cns_msg_a.
o_w_eflg = abap_on.
EXIT.
ENDLOOP.

* エラーなし場合
IF o_w_eflg IS INITIAL.
w_snum = w_snum + 1.
*   データ登録が正常終了しました。(ROW = &1 / SO= &2)
MESSAGE s103(zmegsd01) WITH i_w_index lw_so
INTO lw_msg.
CLEAR lw_row.
lw_row = i_w_index.
CONDENSE lw_row.

CLEAR lst_soitem.
READ TABLE i_td_soitem INTO lst_soitem INDEX 1.
WRITE lst_soitem-itm_number TO lw_item NO-ZERO.
CONDENSE lw_item.

CLEAR lw_rmsg.
CONCATENATE text-033 lw_row text-034 text-035
lw_item
INTO lw_rmsg SEPARATED BY space.
lst_msg-col1 = text-007.
lst_msg-col2 = text-009.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
*  Output check message
LOOP AT ltd_return INTO lst_return.
IF lst_return-id IS NOT INITIAL AND
lst_return-type IS NOT INITIAL AND
lst_return-number IS NOT INITIAL.
MESSAGE ID lst_return-id TYPE lst_return-type
NUMBER lst_return-number
WITH lst_return-message_v1
lst_return-message_v2
lst_return-message_v3
lst_return-message_v4
INTO lw_msg.
CLEAR lw_index.
CLEAR lst_soitem.
IF lst_return-row > 0.
lw_index = i_w_index + lst_return-row - 1.
READ TABLE i_td_soitem INTO lst_soitem INDEX lst_return-row.
ELSE.
lw_index = i_w_index.
READ TABLE i_td_soitem INTO lst_soitem INDEX 1.
ENDIF.
CLEAR lw_row.
lw_row = lw_index.
CONDENSE lw_row.
CLEAR lw_item.
WRITE lst_soitem-itm_number TO lw_item NO-ZERO.
CONDENSE lw_item.
CLEAR lw_rmsg.
CONCATENATE text-033 lw_row text-034 text-035
lw_item
INTO lw_rmsg SEPARATED BY space.

CASE lst_return-type.
WHEN cns_msg_e OR
cns_msg_a.
lst_msg-col2 = text-008.
WHEN cns_msg_w.
lst_msg-col2 = text-030.
WHEN OTHERS.
lst_msg-col2 = text-009.
ENDCASE.
lst_msg-col1 = text-007.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
ENDIF.
ENDLOOP.
IF p_tstck <> abap_on.
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
wait = abap_on.
ENDIF.

* エラーあり
ELSE.
w_enum = w_enum + 1.
LOOP AT ltd_return INTO lst_return
WHERE type = cns_msg_e OR
type = cns_msg_a.
*     Output check message
IF lst_return-id IS NOT INITIAL AND
lst_return-type IS NOT INITIAL AND
lst_return-number IS NOT INITIAL.
MESSAGE ID lst_return-id TYPE lst_return-type
NUMBER lst_return-number
WITH lst_return-message_v1
lst_return-message_v2
lst_return-message_v3
lst_return-message_v4
INTO lw_msg.
*       データ更新に失敗しました。(MSG = &1 )
MESSAGE s098(zmegsd01) WITH i_w_index lw_msg
INTO lw_msg.

CLEAR lw_index.
CLEAR lst_soitem.
IF lst_return-row > 0.
lw_index = i_w_index + lst_return-row - 1.
READ TABLE i_td_soitem INTO lst_soitem INDEX lst_return-row.
ELSE.
lw_index = i_w_index.
READ TABLE i_td_soitem INTO lst_soitem INDEX 1.
ENDIF.
CLEAR lw_row.
lw_row = lw_index.
CONDENSE lw_row.

CLEAR lw_item.
WRITE lst_soitem-itm_number TO lw_item NO-ZERO.
CONDENSE lw_item.

CLEAR lw_rmsg.
CONCATENATE text-033 lw_row text-034 text-035
lw_item
INTO lw_rmsg SEPARATED BY space.

CASE lst_return-type.
WHEN cns_msg_e OR
cns_msg_a.
lst_msg-col2 = text-008.
WHEN cns_msg_w.
lst_msg-col2 = text-030.
WHEN OTHERS.
lst_msg-col2 = text-009.
ENDCASE.
lst_msg-col1 = text-007.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
ENDIF.
ENDLOOP.
IF p_tstck <> abap_on.
CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
ENDIF.
ENDIF.
**** end upd 2015/05/04 isid18 ****

ENDFORM.                    " SO_CREATE_EXECUTE

*&---------------------------------------------------------------------*
*&      Form  SO_CHANGE_EDIT
*&---------------------------------------------------------------------*
*       A-4-1-1．BAPIのパラメータ設定
*----------------------------------------------------------------------*
*      -->I_ST_FILE  text
*      <--o_w_vbeln
*      <--o_st_soheader
*      <--o_st_soheaderx
*      <--o_td_soitem
*      <--o_td_soitemx
*      <--o_td_parnrc
*      <--o_td_parnrad
*      <--o_td_soschedule
*      <--o_td_soschedulex
*      <--o_td_socondition
*      <--o_td_soconditionx
*      <--o_td_sotext
*----------------------------------------------------------------------*
FORM so_change_edit  USING    i_st_file  TYPE typ_file
CHANGING o_w_vbeln         TYPE bapivbeln-vbeln
**** start upd 2015/05/04 isid18 ****
*                     o_st_soheader     TYPE bapisdh1
*                     o_st_soheaderx    TYPE bapisdh1x
o_w_auart         TYPE char4
o_st_soheader     TYPE bapisdhd1
o_st_soheaderx    TYPE bapisdhd1x
**** end upd 2015/05/04 isid18 ****
o_td_soitem       TYPE typ_td_soitem
o_td_soitemx      TYPE typ_td_soitemx
o_td_parnr        TYPE typ_td_parnr
o_td_parnrc       TYPE typ_td_parnrc
o_td_parnrad      TYPE typ_td_parnrad
o_td_soschedule   TYPE typ_td_soschedule
o_td_soschedulex  TYPE typ_td_soschedulex
o_td_socondition  TYPE typ_td_socondition
o_td_soconditionx TYPE typ_td_soconditionx
o_td_sotext       TYPE typ_td_sotext.

DATA:
**** start add 2015/05/04 isid18 ****
lw_item_num      TYPE posnr,          "ItemNumber
**** end add 2015/05/04 isid18 ****
lst_soitem       TYPE bapisditm,      "Item Data
lst_soitemx      TYPE bapisditmx,     "Item Data Checkbox
lst_parnr        TYPE bapiparnr,     "Document Partner Change
lst_parnrc       TYPE bapiparnrc,     "Document Partner Change
lst_parnrad      TYPE bapiaddr1,      "Partner Address
lst_soschedule   TYPE bapischdl,      "Schedule Line Data
lst_soschedulex  TYPE bapischdlx,     "Checkbox Schedule Line Data
lst_socondition  TYPE bapicond,       "Conditions
lst_soconditionx TYPE bapicondx,      "Conditions Checkbox
lst_sotext       TYPE bapisdtext.     "Texts

* A-4-2-1．BAPIのパラメータ設定
IF o_st_soheader IS INITIAL.
*   SONo
o_w_vbeln = i_st_file-vbeln.
**** start add 2015/05/04 isid18 ****
o_w_auart = i_st_file-auart.
IF o_w_auart IS INITIAL.
SELECT SINGLE auart
FROM vbak
INTO o_w_auart
WHERE vbeln = o_w_vbeln.
ENDIF.
CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
EXPORTING
input  = o_w_auart
IMPORTING
output = o_w_auart.
**** end add 2015/05/04 isid18 ****
*   Order Header
o_st_soheader-collect_no = i_st_file-submi.   "一括番号 (見積依頼/見積書)
o_st_soheader-purch_date = i_st_file-bstdk.   "得意先発注日付
o_st_soheader-dlv_block  = i_st_file-lifsk.   "出荷ブロック (伝票ヘッダ)
o_st_soheader-ord_reason = i_st_file-augru.   "受注理由 (取引理由)
o_st_soheader-price_date = i_st_file-prsdt.   "価格設定/換算レートの実施日付
o_st_soheader-purch_no_c = i_st_file-bstkd.   "得意先発注番号
o_st_soheader-doc_date   = i_st_file-audat.   "伝票日付 (受信日/送信日)
**** start add 2015/05/04 isid18 ****
o_st_soheader-sales_grp  = i_st_file-vkgrp.   "営業グループ
o_st_soheader-sales_off  = i_st_file-vkbur.   "営業所
o_st_soheader-name       = i_st_file-bname.   "発注者名称
o_st_soheader-pmnttrms   = i_st_file-zterm.   "支払条件キー
**** end add 2015/05/04 isid18 ****

o_st_soheaderx-updateflag = cns_update.       "更新区分
IF o_st_soheader-collect_no IS NOT INITIAL.
o_st_soheaderx-collect_no = abap_on.        "一括番号 (見積依頼/見積書)
ENDIF.
IF o_st_soheader-purch_date IS NOT INITIAL.
o_st_soheaderx-purch_date = abap_on.        "得意先発注日付
ENDIF.
IF o_st_soheader-dlv_block IS NOT INITIAL.
o_st_soheaderx-dlv_block  = abap_on.        "出荷ブロック (伝票ヘッダ)
ENDIF.
IF o_st_soheader-ord_reason IS NOT INITIAL.
o_st_soheaderx-ord_reason = abap_on.        "受注理由 (取引理由)
ENDIF.
IF o_st_soheader-price_date IS NOT INITIAL.
o_st_soheaderx-price_date = abap_on.        "価格設定/換算レートの実施日付
ENDIF.
IF o_st_soheader-purch_no_c IS NOT INITIAL.
o_st_soheaderx-purch_no_c = abap_on.        "得意先発注番号
ENDIF.
IF o_st_soheader-doc_date IS NOT INITIAL.
o_st_soheaderx-doc_date   = abap_on.        "伝票日付 (受信日/送信日)
ENDIF.
**** start add 2015/05/04 isid18 ****
IF o_st_soheader-sales_grp IS NOT INITIAL.
o_st_soheaderx-sales_grp  = abap_on.   "営業グループ
ENDIF.
IF o_st_soheader-sales_off IS NOT INITIAL.
o_st_soheaderx-sales_off  = abap_on.   "営業所
ENDIF.
IF o_st_soheader-name IS NOT INITIAL.
o_st_soheaderx-name       = abap_on.   "発注者名称
ENDIF.
IF o_st_soheader-pmnttrms IS NOT INITIAL.
o_st_soheaderx-pmnttrms   = abap_on.   "支払条件キー
ENDIF.

IF i_st_file-soldto IS NOT INITIAL.
*      lst_parnr-document   = i_st_file-vbeln.      "販売管理伝票番号
*      lst_parnr-updateflag = cns_update.           "更新区分
lst_parnr-partn_role = cns_parnr_ag.         "取引先機能
lst_parnr-partn_numb = i_st_file-soldto.     "得意先コード
APPEND lst_parnr TO o_td_parnr.
ENDIF.
**** end add 2015/05/04 isid18 ****

*   Document Partner
IF i_st_file-shipto IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role = cns_parnr_we.         "取引先機能
lst_parnrc-p_numb_new = i_st_file-shipto.     "得意先コード
PERFORM get_addno USING i_st_file-vbeln
CHANGING lst_parnrc-addr_link
lst_parnrad.
APPEND lst_parnrc TO o_td_parnrc.
IF i_st_file-ship_name IS NOT INITIAL.
lst_parnrad-name       = i_st_file-ship_name.   "名称 1
ENDIF.
IF i_st_file-ship_name2 IS NOT INITIAL.
lst_parnrad-name_2     = i_st_file-ship_name2.  "名称 2
ENDIF.
IF i_st_file-ship_name3 IS NOT INITIAL.
lst_parnrad-name_3     = i_st_file-ship_name3.  "名称 3
ENDIF.
IF i_st_file-street IS NOT INITIAL.
lst_parnrad-street     = i_st_file-street.      "地名/番地-号
ENDIF.
IF i_st_file-city IS NOT INITIAL.
lst_parnrad-city       = i_st_file-city.        "市区町村
ENDIF.
IF i_st_file-countr_iso IS NOT INITIAL.
lst_parnrad-country    = i_st_file-countr_iso.  "国キー (ISO コード)
ENDIF.
IF i_st_file-postl_code IS NOT INITIAL.
lst_parnrad-postl_cod1 = i_st_file-postl_code.  "郵便番号
ENDIF.
IF i_st_file-telephone IS NOT INITIAL.
lst_parnrad-tel1_numbr = i_st_file-telephone.   "電話番号 1
ENDIF.
IF i_st_file-fax_number IS NOT INITIAL.
lst_parnrad-fax_number = i_st_file-fax_number.  "FAX 番号
ENDIF.
APPEND lst_parnrad TO o_td_parnrad.
CLEAR: lst_parnrc,
lst_parnrad.
ENDIF.

IF i_st_file-billto IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role = cns_parnr_re.         "取引先機能
lst_parnrc-p_numb_new = i_st_file-billto.     "得意先コード
APPEND lst_parnrc TO o_td_parnrc.
ENDIF.

IF i_st_file-payer IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role = cns_parnr_rg.         "取引先機能
lst_parnrc-p_numb_new = i_st_file-payer.      "得意先コード
APPEND lst_parnrc TO o_td_parnrc.
ENDIF.

IF i_st_file-saemp IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role  = cns_parnr_ve.        "取引先機能
lst_parnrc-p_numb_new  = i_st_file-saemp.     "得意先コード
APPEND lst_parnrc TO o_td_parnrc.
ENDIF.

IF i_st_file-edupri IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role = cns_parnr_ze.         "取引先機能
lst_parnrc-p_numb_new = i_st_file-edupri.     "得意先コード
APPEND lst_parnrc TO o_td_parnrc.
ENDIF.

IF i_st_file-eduexp IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role = cns_parnr_zj.         "取引先機能
lst_parnrc-p_numb_new = i_st_file-eduexp.     "得意先コード
APPEND lst_parnrc TO o_td_parnrc.
ENDIF.

IF i_st_file-saassis IS NOT INITIAL.
lst_parnrc-document   = i_st_file-vbeln.      "販売管理伝票番号
lst_parnrc-updateflag = cns_update.           "更新区分
lst_parnrc-partn_role = cns_parnr_zp.         "取引先機能
lst_parnrc-p_numb_new = i_st_file-saassis.   	"得意先コード
APPEND lst_parnrc TO o_td_parnrc.
ENDIF.

*   Texts
IF i_st_file-inbrem IS NOT INITIAL.
CLEAR lst_sotext-itm_number.                 "販売伝票明細
lst_sotext-text_id    = cns_tdid_0001.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
*      lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.          "タグ列
lst_sotext-text_line = i_st_file-inbrem.     "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.

IF i_st_file-tabrem IS NOT INITIAL.
CLEAR lst_sotext-itm_number.                 "販売伝票明細
lst_sotext-text_id    = cns_tdid_0002.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
*      lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.          "タグ列
lst_sotext-text_line  = i_st_file-tabrem.    "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.

IF i_st_file-sorem IS NOT INITIAL.
CLEAR lst_sotext-itm_number.                 "販売伝票明細
lst_sotext-text_id    = cns_tdid_z010.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
*      lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.          "タグ列
lst_sotext-text_line  = i_st_file-sorem.     "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.
ENDIF.

* Item Data
lst_soitem-itm_number = i_st_file-itm_number.   "販売伝票明細
lst_soitem-material   = i_st_file-material.     "品目コード
lst_soitem-plant      = i_st_file-plant.        "プラント
lst_soitem-store_loc  = i_st_file-store_loc.    "保管場所
lst_soitem-short_text = i_st_file-short_text.   "受注明細のテキスト (短)
**** start upd 2015/05/04 isid18 ****
*  lst_soitem-purch_no_c = i_st_file-bstkd.        "得意先発注番号
*  lst_soitem-purch_date = i_st_file-bstdk.        "得意先発注日付
lst_soitem-reason_rej = i_st_file-reason_rej.   "拒否理由
lst_soitem-item_categ = i_st_file-pstyv.        "明細カテゴリ
lst_soitem-purch_no_c = i_st_file-bstkd_item.   "得意先発注番号
lst_soitem-purch_date = i_st_file-bstdk_item.   "得意先発注日付
lst_soitem-target_qty = i_st_file-req_qty.      "目標数量
**** end upd 2015/05/04 isid18 ****
APPEND lst_soitem TO o_td_soitem.

**** start upd 2015/05/04 isid18 ****
*  PERFORM item_update_check USING i_st_file-vbeln
*                                  i_st_file-itm_number
CLEAR lw_item_num.
lw_item_num = i_st_file-itm_number.
PERFORM item_update_check USING i_st_file-vbeln
lw_item_num
**** end upd 2015/05/04 isid18 ****
CHANGING lst_soitemx-updateflag.

lst_soitemx-itm_number = i_st_file-itm_number.   "販売伝票明細
IF lst_soitem-material IS NOT INITIAL.
lst_soitemx-material   = abap_on.               "品目コード
ENDIF.
IF lst_soitem-plant IS NOT INITIAL.
lst_soitemx-plant      = abap_on.               "プラント
ENDIF.
IF lst_soitem-store_loc IS NOT INITIAL.
lst_soitemx-store_loc  = abap_on.               "保管場所
ENDIF.
IF lst_soitem-short_text IS NOT INITIAL.
lst_soitemx-short_text = abap_on.               "受注明細のテキスト (短)
ENDIF.
IF lst_soitem-purch_no_c IS NOT INITIAL.
lst_soitemx-purch_no_c = abap_on.               "得意先発注番号
ENDIF.
IF lst_soitem-purch_date IS NOT INITIAL.
lst_soitemx-purch_date = abap_on.               "得意先発注日付
ENDIF.
**** start add 2015/05/04 isid18 ****
IF lst_soitem-reason_rej IS NOT INITIAL.
lst_soitemx-reason_rej = abap_on.               "拒否理由
ENDIF.
IF lst_soitem-item_categ IS NOT INITIAL.
lst_soitemx-item_categ = abap_on.               "明細カテゴリ
ENDIF.
IF lst_soitem-target_qty IS NOT INITIAL.
lst_soitemx-target_qty = abap_on.
ENDIF.
**** end add 2015/05/04 isid18 ****
APPEND lst_soitemx TO o_td_soitemx.

* Schedule Line Data
**** start add 2015/05/04 isid18 ****
IF o_w_auart <> cns_auart_cr  AND
o_w_auart <> cns_auart_dr  AND
o_w_auart <> cns_auart_zcr AND
o_w_auart <> cns_auart_zdr.
**** end add 2015/05/04 isid18 ****
lst_soschedule-itm_number = i_st_file-itm_number. "購買伝票の明細番号
lst_soschedule-sched_line = cns_sched.            "納入日程行
lst_soschedule-req_date   = i_st_file-req_date.   "納入日付
**** start add 2015/05/04 isid18 ****
lst_soschedule-date_type  = cns_date_type.        "日付タイプ
**** end add 2015/05/04 isid18 ****
lst_soschedule-req_qty    = i_st_file-req_qty.    "計画数量
APPEND lst_soschedule TO o_td_soschedule.

PERFORM schedule_update_check USING i_st_file-vbeln
**** start upd 2015/05/04 isid18 ****
*                                      i_st_file-itm_number
lw_item_num
**** start upd 2015/05/04 isid18 ****
CHANGING lst_soschedulex-updateflag.

lst_soschedulex-itm_number = i_st_file-itm_number.  "購買伝票の明細番号
lst_soschedulex-sched_line = cns_sched.             "納入日程行
**** start add 2015/05/04 isid18 ****
lst_soschedulex-date_type  = abap_on.               "日付タイプ
**** end add 2015/05/04 isid18 ****
IF lst_soschedule-req_date IS NOT INITIAL.
lst_soschedulex-req_date   = abap_on.             "納入日付
ENDIF.
IF lst_soschedule-req_qty IS NOT INITIAL.
lst_soschedulex-req_qty    = abap_on.             "計画数量
ENDIF.
APPEND lst_soschedulex TO o_td_soschedulex.
**** start add 2015/05/04 isid18 ****
ENDIF.
**** end add 2015/05/04 isid18 ****

* Conditions
PERFORM get_cond_key USING i_st_file-vbeln
**** start upd 2015/05/04 isid18 ****
*                                 i_st_file-itm_number
lw_item_num
**** start upd 2015/05/04 isid18 ****
i_st_file-cond_type
CHANGING lst_socondition-cond_st_no
**** start add 2015/05/04 isid18 ****
lst_soconditionx-updateflag.
IF lst_soconditionx-updateflag IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****

lst_socondition-itm_number = i_st_file-itm_number.  "販売伝票明細
lst_socondition-cond_type  = i_st_file-cond_type.   "条件タイプ

lst_socondition-cond_value = i_st_file-cond_value.  "条件レート
lst_socondition-currency   = i_st_file-waerk.       "通貨コード
lst_socondition-cond_unit  = i_st_file-cond_unit.   "条件単位
lst_socondition-cond_p_unt = i_st_file-cond_p_unt.  "価格条件単位
APPEND lst_socondition TO o_td_socondition.

**** start upd 2015/05/04 isid18 ****
*    lst_soconditionx-updateflag = cns_update.           "更新区分
*    lst_soconditionx-itm_number = i_st_file-itm_number. "販売伝票明細
*    lst_soconditionx-cond_st_no = lst_socondition-cond_st_no. "ステップ番号
lst_soconditionx-itm_number = i_st_file-itm_number. "販売伝票明細
IF lst_soconditionx-updateflag = cns_update.
lst_soconditionx-cond_st_no = lst_socondition-cond_st_no. "ステップ番号
ENDIF.
**** end upd 2015/05/04 isid18 ****
IF lst_socondition-cond_type IS NOT INITIAL.
lst_soconditionx-cond_type  = abap_on.              "条件タイプ
ENDIF.
IF lst_socondition-cond_value IS NOT INITIAL.
lst_soconditionx-cond_value = abap_on.              "条件レート
ENDIF.
IF lst_socondition-currency IS NOT INITIAL.
lst_soconditionx-currency   = abap_on.              "通貨コード
ENDIF.
IF lst_socondition-cond_unit IS NOT INITIAL.
lst_soconditionx-cond_unit  = abap_on.              "条件単位
ENDIF.
IF lst_socondition-cond_p_unt IS NOT INITIAL.
lst_soconditionx-cond_p_unt = abap_on.              "価格条件単位
ENDIF.
APPEND lst_soconditionx TO o_td_soconditionx.
**** start add 2015/05/04 isid18 ****
ENDIF.
**** end add 2015/05/04 isid18 ****

* Texts
IF i_st_file-itemrem IS NOT INITIAL.
lst_sotext-itm_number = i_st_file-itm_number.       "販売伝票明細
lst_sotext-text_id    = cns_tdid_9001.              "テキスト ID
**** start upd 2015/05/04 isid18 ****
*    lst_sotext-langu_iso  = i_st_file-langu_iso.        "ISO 639 準拠の言語
lst_sotext-langu      = sy-langu.
*    lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
lst_sotext-format_col = cns_format.                 "タグ列
lst_sotext-text_line  = i_st_file-itemrem.          "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.

**** start add 2015/05/04 isid18 ****
* Texts
IF i_st_file-transrem IS NOT INITIAL.
lst_sotext-itm_number = i_st_file-itm_number.       "販売伝票明細
lst_sotext-text_id    = cns_tdid_z910.              "テキスト ID
lst_sotext-langu      = sy-langu.
*    lst_sotext-doc_number = o_w_vbeln.
lst_sotext-format_col = cns_format.                 "タグ列
lst_sotext-text_line  = i_st_file-transrem.         "テキスト行
APPEND lst_sotext TO o_td_sotext.
ENDIF.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " SO_CHANGE_EDIT

*&---------------------------------------------------------------------*
*&      Form  ITEM_UPDATE_CHECK
*&---------------------------------------------------------------------*
*       Set Item Update Flag
*----------------------------------------------------------------------*
*      -->I_W_VBELN  SO No
*      -->I_W_ITEM   Item
*      <--O_W_UPD    UPDATEFLAG
*----------------------------------------------------------------------*
FORM item_update_check  USING    i_w_vbeln  TYPE vbeln
i_w_item   TYPE posnr
CHANGING o_w_upd    TYPE c.

DATA lw_vbeln TYPE vbeln.

SELECT SINGLE vbeln
FROM vbap
INTO lw_vbeln
WHERE vbeln = i_w_vbeln
AND posnr = i_w_item.

IF lw_vbeln IS INITIAL.
o_w_upd = cns_insert.             "更新区分
ELSE.
o_w_upd = cns_update.             "更新区分
ENDIF.

ENDFORM.                    " ITEM_UPDATE_CHECK

*&---------------------------------------------------------------------*
*&      Form  SCHEDULE_UPDATE_CHECK
*&---------------------------------------------------------------------*
*       Set Schedule Update Flag
*----------------------------------------------------------------------*
*      -->I_W_VBELN  SO No
*      -->I_W_ITEM   Item
*      <--O_W_UPD    UPDATEFLAG
*----------------------------------------------------------------------*
FORM schedule_update_check  USING    i_w_vbeln  TYPE vbeln
i_w_item   TYPE posnr
CHANGING o_w_upd    TYPE c.

DATA lw_vbeln TYPE vbeln.

SELECT SINGLE vbeln
FROM vbep
INTO lw_vbeln
WHERE vbeln = i_w_vbeln
AND posnr = i_w_item
AND etenr = cns_sched.

IF lw_vbeln IS INITIAL.
o_w_upd = cns_insert.             "更新区分
ELSE.
o_w_upd = cns_update.             "更新区分
ENDIF.

ENDFORM.                    " SCHEDULE_UPDATE_CHECK

*&---------------------------------------------------------------------*
*&      Form  GET_ADDNO
*&---------------------------------------------------------------------*
*       Get Address number
*----------------------------------------------------------------------*
*      -->i_vbeln  So No
*      <--o_addno  Address number
*----------------------------------------------------------------------*
FORM get_addno  USING    i_vbeln  TYPE vbeln
CHANGING o_addno  TYPE adrnr
o_parad  TYPE bapiaddr1.

CLEAR: o_addno,
o_parad.

SELECT SINGLE adrnr
FROM vbpa
INTO o_addno
WHERE vbeln = i_vbeln
AND posnr = cns_posnr_00
AND parvw = cns_parnr_we.

CHECK o_addno IS NOT INITIAL.

SELECT addrnumber
name1
name2
name3
street
city1
country
post_code1
tel_number
fax_number UP TO 1 ROWS
FROM adrc
INTO (o_parad-addr_no,     "アドレス番号
o_parad-name,        "名称 1
o_parad-name_2,      "名称 2
o_parad-name_3,      "名称 3
o_parad-street,      "地名/番地-号
o_parad-city,        "市区町村
o_parad-country,     "国キー (ISO コード)
o_parad-postl_cod1,  "郵便番号
o_parad-tel1_numbr,  "電話番号 1
o_parad-fax_number)  "FAX 番号
WHERE addrnumber = o_addno.
ENDSELECT.

ENDFORM.                    " GET_ADDNO

*&---------------------------------------------------------------------*
*&      Form  FRM_GET_COND_KEY
*&---------------------------------------------------------------------*
*       Get Conditon Key
*----------------------------------------------------------------------*
*      -->I_ST_FILE_VBELN  SO No
*      -->I_ST_FILE_ITM_NUMBER  item number
*      -->I_ST_FILE_COND_TYPE  condition type
*      <--o_cond_st_no   condition number
*----------------------------------------------------------------------*
FORM get_cond_key  USING i_vbeln        TYPE vbeln
i_posnr        TYPE posnr
i_cond_type    TYPE kscha
CHANGING o_cond_st_no   TYPE stunr
**** start add 2015/05/04 isid18 ****
o_updateflag   TYPE updkz_d.

DATA lw_stunr TYPE konv-stunr.
**** end add 2015/05/04 isid18 ****

DATA lw_knumv TYPE vbak-knumv.    "condition num

CLEAR: o_cond_st_no.

SELECT SINGLE knumv
FROM vbak
INTO lw_knumv
WHERE vbeln = i_vbeln.

**** start add 2015/05/04 isid18 ****
CLEAR o_updateflag.
SELECT stunr UP TO 1 ROWS
FROM konv
INTO lw_stunr
WHERE knumv = lw_knumv
AND kposn = i_posnr.
ENDSELECT.
IF sy-subrc <> 0.
o_updateflag = cns_insert.
IF i_cond_type IS INITIAL.
CLEAR o_updateflag.
ENDIF.
ELSE.
IF i_cond_type IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****

SELECT stunr UP TO 1 ROWS
FROM konv
INTO o_cond_st_no
WHERE knumv = lw_knumv
AND kposn = i_posnr
AND kschl = i_cond_type.
ENDSELECT.

**** start add 2015/05/04 isid18 ****
IF sy-subrc = 0.
o_updateflag = cns_update.
ELSE.
o_updateflag = cns_insert.
ENDIF.
ELSE.
CLEAR o_updateflag.
ENDIF.
ENDIF.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " GET_COND_KEY
*&---------------------------------------------------------------------*
*&      Form  SO_change_EXECUTE
*&---------------------------------------------------------------------*
*       BAPIの実行
*----------------------------------------------------------------------*
*      -->I_W_INTEX           Index
*      -->i_w_vbeln           SO nO
*      -->i_st_soheader       Header
*      -->i_st_soheaderx      Header check
*      -->i_td_soitem         Item
*      -->i_td_soitemx        Item check
*      -->i_td_parnrc         Partner change
*      -->i_td_parnrad        partner address
*      -->i_td_soschedule     schedule line
*      -->i_td_soschedulex    schedule line check
*      -->i_td_socondition    condition
*      -->i_td_soconditionx   condition check
*      -->i_td_sotext         text
*      <--O_W_EFLG            Error Flag
*      <--O_TD_MSG            Error message table
*----------------------------------------------------------------------*
FORM so_change_execute  USING
i_w_index            TYPE sy-index
i_w_vbeln            TYPE bapivbeln-vbeln
**** start upd 2015/05/04 isid18 ****
*                        i_st_soheader        TYPE bapisdh1
*                        i_st_soheaderx       TYPE bapisdh1x
i_w_bustype          TYPE bapiusw01-objtype
value(i_st_soheader)       TYPE bapisdhd1
value(i_st_soheaderx)      TYPE bapisdhd1x
**** end upd 2015/05/04 isid18 ****
i_td_soitem          TYPE typ_td_soitem
i_td_soitemx         TYPE typ_td_soitemx
i_td_parnr           TYPE typ_td_parnr
i_td_parnrc          TYPE typ_td_parnrc
i_td_parnrad         TYPE typ_td_parnrad
i_td_soschedule      TYPE typ_td_soschedule
i_td_soschedulex     TYPE typ_td_soschedulex
i_td_socondition     TYPE typ_td_socondition
i_td_soconditionx    TYPE typ_td_soconditionx
i_td_sotext          TYPE typ_td_sotext
CHANGING o_w_eflg    TYPE c
o_td_msg    TYPE typ_td_msg.
DATA:
lw_sdls     TYPE bapisdls,
lw_trun     TYPE bapiflag-bapiflag,
lw_so       TYPE bapivbeln-vbeln,
ltd_return  TYPE TABLE OF bapiret2,
lst_return  TYPE bapiret2,
lw_row      TYPE string,
lw_msg      TYPE string,
**** start add 2015/05/04 isid18 ****
lw_rmsg     TYPE string,
lw_index    TYPE int4,
lw_item     TYPE char6,
lst_soitem  TYPE bapisditm,
ltd_sched   TYPE typ_td_soschedule,
lth_sched   TYPE bapischdl,
lw_vdatu    TYPE vbak-vdatu,
**** end add 2015/05/04 isid18 ****
lst_msg     TYPE typ_msg.

IF p_tstck = abap_on.
lw_trun = abap_on.
ENDIF.

lw_sdls-cond_handl = abap_on.

lw_so = i_w_vbeln.

**** start upd 2015/05/04 isid18 ****
*  CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
*    EXPORTING
*      salesdocument    = lw_so
*      order_header_in  = i_st_soheader
*      order_header_inx = i_st_soheaderx
*      simulation       = lw_trun
*      logic_switch     = lw_sdls
*    TABLES
*      return           = ltd_return
*      order_item_in    = i_td_soitem
*      order_item_inx   = i_td_soitemx
*      partnerchanges   = i_td_parnrc
*      partneraddresses = i_td_parnrad
*      schedule_lines   = i_td_soschedule
*      schedule_linesx  = i_td_soschedulex
*      conditions_in    = i_td_socondition
*      conditions_inx   = i_td_soconditionx
*      order_text       = i_td_sotext.
IF i_td_soschedule[] IS NOT INITIAL.
SELECT SINGLE vdatu
FROM vbak
INTO lw_vdatu
WHERE vbeln = lw_so.
ltd_sched[] = i_td_soschedule[].
SORT ltd_sched BY req_date DESCENDING.
READ TABLE ltd_sched INTO lth_sched INDEX 1.
IF lw_vdatu < lth_sched-req_date.
i_st_soheader-req_date_h = lth_sched-req_date.
i_st_soheaderx-req_date_h = abap_on.
ENDIF.
ENDIF.
CALL FUNCTION 'SD_SALESDOCUMENT_CHANGE'
EXPORTING
salesdocument    = lw_so
order_header_in  = i_st_soheader
order_header_inx = i_st_soheaderx
simulation       = lw_trun
business_object  = i_w_bustype
call_from_bapi   = abap_on
logic_switch     = lw_sdls
TABLES
return           = ltd_return
item_in          = i_td_soitem
item_inx         = i_td_soitemx
partners         = i_td_parnr
partnerchanges   = i_td_parnrc
partneraddresses = i_td_parnrad
schedule_in      = i_td_soschedule
schedule_inx     = i_td_soschedulex
conditions_in    = i_td_socondition
conditions_inx   = i_td_soconditionx
sales_text       = i_td_sotext.
**** end upd 2015/05/04 isid18 ****

**** start upd 2015/05/04 isid18 ****
*  w_tnum = w_tnum + 1.                    "Total number
*  lw_row = i_w_index.

** Test mode
*  IF p_tstck = abap_on.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return.
*      IF lst_return-type = cns_msg_e OR
*         lst_return-type = cns_msg_a.
*        o_w_eflg = abap_on.
*      ENDIF.
*      IF lst_return-id IS NOT INITIAL AND
*         lst_return-type IS NOT INITIAL AND
*         lst_return-number IS NOT INITIAL.
*        MESSAGE ID lst_return-id TYPE lst_return-type
*          NUMBER lst_return-number
*          WITH lst_return-message_v1
*               lst_return-message_v2
*               lst_return-message_v3
*               lst_return-message_v4
*           INTO lw_msg.
*        CONDENSE lw_row.
*        CONCATENATE lw_msg text-031 lw_row text-032  INTO lw_msg.
*        CASE sy-msgty.
*          WHEN cns_msg_e OR
*                cns_msg_a.
*            lst_msg-col2 = text-008.
*          WHEN cns_msg_w.
*            lst_msg-col2 = text-030.
*          WHEN OTHERS.
*            lst_msg-col2 = text-009.
*        ENDCASE.
*        lst_msg-col1 = text-007.
*        lst_msg-col3 = lw_msg.
*        APPEND lst_msg TO o_td_msg.
*      ENDIF.
*    ENDLOOP.
*    IF o_w_eflg = abap_on.
*      w_enum = w_enum + 1.                "Error number
*    ELSE.
*      w_snum = w_snum + 1.                "Sucessful number
*    ENDIF.
*  ELSE.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return
*        WHERE type = cns_msg_e OR
*              type = cns_msg_a.
**     データ更新に失敗しました。(ROW = &1 / MSG = &2 )
*      MESSAGE s098(zmegsd01) WITH i_w_index lst_return-message
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-008.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*      o_w_eflg = abap_on.
*      w_enum = w_enum + 1.                 "Error number
*
*      CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*
*      EXIT.
*    ENDLOOP.
*
**   BAPIから返した「RETURN」にエラーメッセージ存在しない場合
*    IF o_w_eflg <> abap_on.
*      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*        EXPORTING
*          wait = abap_on.
*
*      w_snum = w_snum + 1.                "Sucessful number
**     データ更新が正常終了しました。(ROW = &1 / SO= &2)
*      MESSAGE s104(zmegsd01) WITH i_w_index lw_so
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-009.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*    ENDIF.
*  ENDIF.

LOOP AT ltd_return INTO lst_return
WHERE type = cns_msg_e OR
type = cns_msg_a.
o_w_eflg = abap_on.
EXIT.
ENDLOOP.

* エラーなし場合
IF o_w_eflg IS INITIAL.
w_snum = w_snum + 1.
*  データ更新が正常終了しました。(ROW = &1 / SO= &2)
MESSAGE s104(zmegsd01) WITH i_w_index lw_so
INTO lw_msg.
CLEAR lst_soitem.
READ TABLE i_td_soitem INTO lst_soitem INDEX 1.
CLEAR lw_row.
lw_row = i_w_index.
CONDENSE lw_row.
WRITE lst_soitem-itm_number TO lw_item NO-ZERO.
CONDENSE lw_item.
CLEAR lw_rmsg.
CONCATENATE text-033 lw_row text-034 text-035
lw_item
INTO lw_rmsg SEPARATED BY space.
lst_msg-col1 = text-007.
lst_msg-col2 = text-009.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
*   Output check message
LOOP AT ltd_return INTO lst_return.
IF lst_return-id IS NOT INITIAL AND
lst_return-type IS NOT INITIAL AND
lst_return-number IS NOT INITIAL.
MESSAGE ID lst_return-id TYPE lst_return-type
NUMBER lst_return-number
WITH lst_return-message_v1
lst_return-message_v2
lst_return-message_v3
lst_return-message_v4
INTO lw_msg.

*       row,item
CLEAR: lw_index, lw_row, lst_soitem.
IF lst_return-row > 0.
lw_index = i_w_index + lst_return-row - 1.
READ TABLE i_td_soitem INTO lst_soitem INDEX lst_return-row.
ELSE.
READ TABLE i_td_soitem INTO lst_soitem INDEX 1.
lw_index = i_w_index.
ENDIF.
lw_row = lw_index.
CONDENSE lw_row.

CLEAR lw_item.
WRITE lst_soitem-itm_number TO lw_item NO-ZERO.
CONDENSE lw_item.
CLEAR lw_rmsg.
CONCATENATE text-033 lw_row text-034 text-035
lw_item
INTO lw_rmsg SEPARATED BY space.

CASE lst_return-type.
WHEN cns_msg_e OR
cns_msg_a.
lst_msg-col2 = text-008.
WHEN cns_msg_w.
lst_msg-col2 = text-030.
WHEN OTHERS.
lst_msg-col2 = text-009.
ENDCASE.
lst_msg-col1 = text-007.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
ENDIF.
ENDLOOP.
IF p_tstck <> abap_on.
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
wait = abap_on.
ENDIF.

* エラーあり
ELSE.
w_enum = w_enum + 1.
LOOP AT ltd_return INTO lst_return
WHERE type = cns_msg_e OR
type = cns_msg_a.
*     Output check message
IF lst_return-id IS NOT INITIAL AND
lst_return-type IS NOT INITIAL AND
lst_return-number IS NOT INITIAL.
MESSAGE ID lst_return-id TYPE lst_return-type
NUMBER lst_return-number
WITH lst_return-message_v1
lst_return-message_v2
lst_return-message_v3
lst_return-message_v4
INTO lw_msg.
*       データ更新に失敗しました。(MSG = &1 )
MESSAGE s098(zmegsd01) WITH i_w_index lw_msg
INTO lw_msg.

*       row,item
CLEAR: lw_index, lw_row, lst_soitem.
IF lst_return-row > 0.
lw_index = i_w_index + lst_return-row - 1.
READ TABLE i_td_soitem INTO lst_soitem INDEX lst_return-row.
ELSE.
lw_index = i_w_index.
READ TABLE i_td_soitem INTO lst_soitem INDEX 1.
ENDIF.
lw_row = lw_index.
CONDENSE lw_row.

CLEAR lw_item.
WRITE lst_soitem-itm_number TO lw_item NO-ZERO.
CONDENSE lw_item.

CLEAR lw_rmsg.
CONCATENATE text-033 lw_row text-034 text-035
lw_item
INTO lw_rmsg SEPARATED BY space.

CASE lst_return-type.
WHEN cns_msg_e OR
cns_msg_a.
lst_msg-col2 = text-008.
WHEN cns_msg_w.
lst_msg-col2 = text-030.
WHEN OTHERS.
lst_msg-col2 = text-009.
ENDCASE.
lst_msg-col1 = text-007.
lst_msg-col3 = lw_rmsg.
lst_msg-col4 = lw_msg.
APPEND lst_msg TO o_td_msg.
ENDIF.
ENDLOOP.
IF p_tstck <> abap_on..
CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
ENDIF.
ENDIF.
**** end upd 2015/05/04 isid18 ****

ENDFORM.                    " SO_change_EXECUTE

*&---------------------------------------------------------------------*
*&      Form  PROCESS_RESULT
*&---------------------------------------------------------------------*
*       A-5．画面出力・ファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_EFILE  Error file table
*      -->I_TD_MSG    Error message table
*----------------------------------------------------------------------*
FORM process_result USING i_td_efile TYPE typ_td_file
i_td_msg   TYPE typ_td_msg.

DATA:
ltd_rfile TYPE typ_td_rfile.

* A-5-1．結果画面の画面出力
PERFORM write_result USING i_td_msg
CHANGING ltd_rfile.

* A-5-2．RESULTファイルのファイル出力
* A-5-3．ERRORファイルのファイル出力
PERFORM output_file USING ltd_rfile
i_td_efile.

ENDFORM.                    " PROCESS_RESULT

*&---------------------------------------------------------------------*
*&      Form  WRITE_RESULT
*&---------------------------------------------------------------------*
*       A-5-1．結果画面の画面出力
*----------------------------------------------------------------------*
*      -->I_TD_MSG    Error File data
*      <--O_TD_rfile  Result file table
*----------------------------------------------------------------------*
FORM write_result USING    i_td_msg   TYPE typ_td_msg
CHANGING o_td_rfile TYPE typ_td_rfile.
DATA:
lw_mode      TYPE string,
lrh_werks    LIKE LINE OF s_werks,
lw_werks     TYPE string,
lw_sign      TYPE string,
lw_option    TYPE string,
lw_low       TYPE string,
lw_high      TYPE string,
lw_no        TYPE i,
lst_msg      TYPE typ_msg,
lst_rfile    TYPE typ_rfile.

IF p_serve = abap_on.
lw_mode = text-002.
ELSE.
lw_mode = text-003.
ENDIF.

**** start add 2015/05/04 isid18 ****
w_tnum = w_enum + w_snum.
**** end add 2015/05/04 isid18 ****

* Plant: SI:X OP:XX LO:XX HI:XX
LOOP AT s_werks INTO lrh_werks.
CLEAR: lw_sign,
lw_option,
lw_low,
lw_high.
lw_no = lw_no + 1.
CONCATENATE 'SI:'
lrh_werks-sign
INTO lw_sign.
CONCATENATE 'OP:'
lrh_werks-option
INTO lw_option.
CONCATENATE 'LO:'
lrh_werks-low
INTO lw_low.
CONCATENATE 'HI:'
lrh_werks-high
INTO lw_high.
IF lw_no = 1.
CONCATENATE lw_sign
lw_option
lw_low
lw_high
INTO lw_werks
SEPARATED BY space.
ELSEIF lw_no > 1
AND lw_no <= 5.
CONCATENATE lw_werks
'/'
lw_sign
lw_option
lw_low
lw_high
INTO lw_werks
SEPARATED BY space.
ELSE.
CONCATENATE lw_werks
'/...'
INTO lw_werks
SEPARATED BY space.
ENDIF.
ENDLOOP.

SKIP.
WRITE: text-016.                        "<Paramenter>
WRITE:/2 text-017, 24 ':', lw_mode.     "Mode
WRITE:/2 text-018, 24 ':', p_tstck.     "Test Run
WRITE:/2 text-019, 24 ':', lw_werks.    "Plant
WRITE:/2 text-020, 24 ':', p_ifile.     "File Name(Input)
WRITE:/2 text-021, 24 ':', p_rfile.     "File Name(Result)
WRITE:/2 text-022, 24 ':', p_efile.     "File Name(Error)

SKIP.
WRITE: text-023.                        "<Result>
WRITE:/2 text-024, 24 ':', w_tnum.      "Number of Transcations
WRITE:/2 text-025, 24 ':', w_snum.      "Number of Normal
WRITE:/2 text-026, 24 ':', w_enum.      "Number of Errors

SKIP.
WRITE: text-027.                        "<Message>
LOOP AT i_td_msg INTO lst_msg.
WRITE:/3 lst_msg-col1,
24 lst_msg-col2,
40 lst_msg-col3,
**** start add 2015/05/04 isid18 ****
60 lst_msg-col4.
**** end add 2015/05/04 isid18 ****
ENDLOOP.

* RESULTファイルのファイル設定
* Output header
CONCATENATE text-010 ':' sy-mandt INTO lst_rfile-col1. "CLIENT
CONCATENATE text-013 ':' sy-datum INTO lst_rfile-col3. "Date
APPEND lst_rfile TO o_td_rfile.

CLEAR lst_rfile.
CONCATENATE text-011 ':' sy-cprog INTO lst_rfile-col1. "PROGRAM
CONCATENATE text-014 ':' sy-uzeit INTO lst_rfile-col3. "Time
APPEND lst_rfile TO o_td_rfile.

CLEAR lst_rfile.
CONCATENATE text-012 ':' sy-uname INTO lst_rfile-col1. "USER
lst_rfile-col2 = text-015.                             "Title
APPEND lst_rfile TO o_td_rfile.

CLEAR lst_rfile.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-016.    "<Paramenter>
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-017.    "Mode
lst_rfile-col2 = ':'.
lst_rfile-col3 = lw_mode.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-018.    "Test Run
lst_rfile-col2 = ':'.
lst_rfile-col3 = p_tstck.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-019.    "Plant
lst_rfile-col2 = ':'.
lst_rfile-col3 = lw_werks.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-020.    "File Name(Input)
lst_rfile-col2 = ':'.
lst_rfile-col3 = p_ifile.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-021.    "File Name(Result)
lst_rfile-col2 = ':'.
lst_rfile-col3 = p_rfile.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-022.    "File Name(Error)
lst_rfile-col2 = ':'.
lst_rfile-col3 = p_efile.
APPEND lst_rfile TO o_td_rfile.

CLEAR lst_rfile.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-023.    "<Result>
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-024.    "Number of Transcations
lst_rfile-col2 = ':'.
lst_rfile-col3 = w_tnum.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-025.    "Number of Normal
lst_rfile-col2 = ':'.
lst_rfile-col3 = w_snum.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-026.    "Number of Errors
lst_rfile-col2 = ':'.
lst_rfile-col3 = w_enum.
APPEND lst_rfile TO o_td_rfile.

CLEAR lst_rfile.
APPEND lst_rfile TO o_td_rfile.

lst_rfile-col1 = text-027.    "<Message>
APPEND lst_rfile TO o_td_rfile.

LOOP AT i_td_msg INTO lst_msg.
lst_rfile-col1 = lst_msg-col1.
lst_rfile-col2 = lst_msg-col2.
lst_rfile-col3 = lst_msg-col3.
**** start add 2015/05/04 isid18 ****
lst_rfile-col4 = lst_msg-col4.
**** end add 2015/05/04 isid18 ****
APPEND lst_rfile TO o_td_rfile.
ENDLOOP.

ENDFORM.                    " WRITE_RESULT

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_HEAD
*&---------------------------------------------------------------------*
*       ヘッダ出力
*----------------------------------------------------------------------*
FORM output_head.

*  SET TITLEBAR 'GUI_TITLE_RESULT'.

WRITE: /2 text-010, 15 ':', 17 sy-mandt,      "CLIENT
130 text-013, 135 ':', 137 sy-datum,  "Date
/2 text-011, 15 ':', 17 sy-cprog,      "PROGRAM
130 text-014, 135 ':', 137 sy-uzeit,  "Time
/2 text-012, 15 ':', 17 sy-uname,      "USER
66 text-015.                          "Title

ENDFORM.                    " OUTPUT_HEAD

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_FILE
*&---------------------------------------------------------------------*
*       ファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_RFILE  Result file table
*      -->I_TD_EFILE  Error file table
*----------------------------------------------------------------------*
FORM output_file  USING i_td_rfile TYPE typ_td_rfile
i_td_efile TYPE typ_td_file.

IF p_serve = abap_on.
*   サーバファイル出力
PERFORM output_serve USING i_td_rfile
i_td_efile.
ELSE.
*   ローカルファイル出力
PERFORM output_local USING i_td_rfile
i_td_efile.
ENDIF.

ENDFORM.                    " OUTPUT_FILE

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_SERVE
*&---------------------------------------------------------------------*
*       サーバファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_RFILE  Result file table
*      -->I_TD_EFILE  Error file table
*----------------------------------------------------------------------*
FORM output_serve USING i_td_rfile TYPE typ_td_rfile
i_td_efile TYPE typ_td_file.
DATA:
lst_rfile TYPE typ_rfile,
lst_file  TYPE typ_file,
lw_file   TYPE string.

* A-5-2．RESULTファイルのファイル出力
IF w_flgutf8 IS INITIAL.
TRY.
OPEN DATASET p_rfile FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE w_codepage
IGNORING CONVERSION ERRORS.
CATCH  cx_sy_codepage_converter_init.
sy-subrc = 8.
ENDTRY.
ELSE.
OPEN DATASET p_rfile FOR OUTPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ENDIF.
IF sy-subrc <> 0.
MESSAGE s035(zmegsd01) WITH p_rfile DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

LOOP AT i_td_rfile INTO lst_rfile.
CLEAR lw_file.
CONCATENATE lst_rfile-col1 lst_rfile-col2 lst_rfile-col3
INTO lw_file SEPARATED BY cns_tab.
TRANSFER lw_file TO p_rfile.
ENDLOOP.

* ファイルクローズ
CLOSE DATASET p_rfile.

* A-5-3．ERRORファイルのファイル出力
CHECK i_td_efile IS NOT INITIAL.
IF w_flgutf8 IS INITIAL.
TRY.
OPEN DATASET p_efile FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE w_codepage
IGNORING CONVERSION ERRORS.
CATCH  cx_sy_codepage_converter_init.
sy-subrc = 8.
ENDTRY.
ELSE.
OPEN DATASET p_efile FOR OUTPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ENDIF.
IF sy-subrc <> 0.
MESSAGE s035(zmegsd01) WITH p_efile DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

LOOP AT i_td_efile INTO lst_file.
CLEAR lw_file.
CONCATENATE
lst_file-tcd        "TCD
lst_file-gflag      "GroupFlag
lst_file-auart      "DocType
lst_file-vkorg      "SalesOrg
lst_file-vtweg      "DistChannel
lst_file-spart      "Division
lst_file-vkbur      "SalesOffice
lst_file-vkgrp      "SalesGrp
lst_file-vbeln      "SONo
lst_file-bstkd      "CustPurchNo
lst_file-bstdk      "CustPurchDate
lst_file-audat      "DocDate
lst_file-prsdt      "PriceDate
lst_file-lifsk      "ShipBlock
lst_file-augru      "OrderReason
lst_file-waerk      "NetPriceCurrency
lst_file-submi      "CollectNo
**** start add 2015/05/04 isid18 ****
lst_file-bname      "OrderName
**** end add 2015/05/04 isid18 ****
lst_file-soldto     "SoldTo
lst_file-shipto     "ShipTo
lst_file-ship_name  "ShipToName1
lst_file-ship_name2 "ShipToName2
lst_file-ship_name3 "ShipToName3
lst_file-countr_iso "ShipToCountryCode
lst_file-postl_code "ShipToPostalCode
lst_file-street     "ShipToAddress1
lst_file-city       "ShipToAddress2
lst_file-telephone  "ShipToTel
lst_file-fax_number "ShipToFax
lst_file-billto     "BillTo
lst_file-payer      "Payer
lst_file-saemp      "SalesEmployee
lst_file-edupri     "EndUserPrice
lst_file-eduexp     "EndUserExport
lst_file-saassis    "SalesAssistant
**** start upd 2015/05/04 isid18 ****
*      lst_file-langu_iso  "TextLanguage
lst_file-zterm      "PaymentTerms
**** end upd 2015/05/04 isid18 ****
lst_file-inbrem     "TextHdrInboundRemarks
lst_file-tabrem     "TextHdrDNRemarks
lst_file-sorem      "TextHdrSORemarks
lst_file-itm_number "Item
**** start add 2015/05/04 isid18 ****
lst_file-pstyv      "Itemcategory
**** end add 2015/05/04 isid18 ****
lst_file-material   "Material
lst_file-short_text "MaterialText
lst_file-plant      "Plant
lst_file-store_loc  "SLoc
lst_file-req_date   "DeliveryDate
lst_file-req_qty    "SOQty
lst_file-cond_unit  "OrderUnit
**** start add 2015/05/04 isid18 ****
lst_file-bstkd_item "CustomerPONoItm
lst_file-bstdk_item "CustomerPODateItm
lst_file-reason_rej "RejectReason
**** end add 2015/05/04 isid18 ****
lst_file-cond_type  "CondType
lst_file-cond_value "NetPrice
lst_file-cond_p_unt "PriceUnit
lst_file-itemrem    "TextItmShipRemarks
**** start add 2015/05/04 isid18 ****
lst_file-transrem   "TextItmTransportMeans
**** end add 2015/05/04 isid18 ****
INTO lw_file  SEPARATED BY cns_tab.
TRANSFER lw_file TO p_efile.
ENDLOOP.

* ファイルクローズ
CLOSE DATASET p_efile.

ENDFORM.                    " OUTPUT_SERVE

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_LOCAL
*&---------------------------------------------------------------------*
*       ローカルファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_RFILE  Result file table
*      -->I_TD_EFILE  Error file table
*----------------------------------------------------------------------*
FORM output_local USING i_td_rfile TYPE typ_td_rfile
i_td_efile TYPE typ_td_file.

DATA:
lw_filename TYPE string.

* A-5-2．RESULTファイルのファイル出力
lw_filename = p_rfile.
CALL FUNCTION 'GUI_DOWNLOAD'
EXPORTING
filename                = lw_filename
filetype                = cns_ftype
write_field_separator   = cns_tab
TABLES
data_tab                = i_td_rfile
EXCEPTIONS
file_write_error        = 1
no_batch                = 2
gui_refuse_filetransfer = 3
invalid_type            = 4
no_authority            = 5
unknown_error           = 6
header_not_allowed      = 7
separator_not_allowed   = 8
filesize_not_allowed    = 9
header_too_long         = 10
dp_error_create         = 11
dp_error_send           = 12
dp_error_write          = 13
unknown_dp_error        = 14
access_denied           = 15
dp_out_of_memory        = 16
disk_full               = 17
dp_timeout              = 18
file_not_found          = 19
dataprovider_exception  = 20
control_flush_error     = 21
OTHERS                  = 22.
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE cns_msg_s NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

* A-5-3．ERRORファイルのファイル出力
CHECK i_td_efile IS NOT INITIAL.
lw_filename = p_efile.
CALL FUNCTION 'GUI_DOWNLOAD'
EXPORTING
filename                = lw_filename
filetype                = cns_ftype
write_field_separator   = cns_tab
codepage                = w_codepage
TABLES
data_tab                = i_td_efile
EXCEPTIONS
file_write_error        = 1
no_batch                = 2
gui_refuse_filetransfer = 3
invalid_type            = 4
no_authority            = 5
unknown_error           = 6
header_not_allowed      = 7
separator_not_allowed   = 8
filesize_not_allowed    = 9
header_too_long         = 10
dp_error_create         = 11
dp_error_send           = 12
dp_error_write          = 13
unknown_dp_error        = 14
access_denied           = 15
dp_out_of_memory        = 16
disk_full               = 17
dp_timeout              = 18
file_not_found          = 19
dataprovider_exception  = 20
control_flush_error     = 21
OTHERS                  = 22.
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE cns_msg_s NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4
DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    " OUTPUT_LOCAL
**** start add 2015/05/04 isid18 ****
*&---------------------------------------------------------------------*
*&      Form  get_object_type
*&---------------------------------------------------------------------*
*       ビジネスオブジェクトタイプ
*----------------------------------------------------------------------*
*      -->o_td_busobj  ビジネスオブジェクトタイプ
*----------------------------------------------------------------------*
FORM get_object_type
USING    i_doc_type TYPE vbak-auart
CHANGING o_bus_type TYPE nast-objtype.

DATA lw_doc_type TYPE vbak-vbtyp.
CLEAR lw_doc_type.
CASE i_doc_type.
WHEN 'OR'
OR 'ZOR'
OR 'KA'
OR 'KB'
OR 'KE'.
lw_doc_type = cns_vbtyp_c.
WHEN 'RE'
OR 'ZRE'.
lw_doc_type = cns_vbtyp_h.
WHEN 'CR'
OR 'ZCR'.
lw_doc_type = cns_vbtyp_k.
WHEN 'DR'
OR 'ZDR'.
lw_doc_type = cns_vbtyp_l.
WHEN OTHERS.
ENDCASE.

CALL FUNCTION 'SD_OBJECT_TYPE_DETERMINE'
EXPORTING
i_document_type   = lw_doc_type
IMPORTING
e_business_object = o_bus_type.

ENDFORM.                    " get_object_type
*&---------------------------------------------------------------------*
*&      Form  CHECK_GFLAG
*&---------------------------------------------------------------------*
*       グループフラグチェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*----------------------------------------------------------------------*
FORM check_gflag  USING i_w_index   TYPE sy-index
i_st_file   TYPE typ_file.

* group flag check
IF i_st_file-gflag <> abap_on AND
i_w_index = 1.
MESSAGE s113(zmegsd01) DISPLAY LIKE cns_msg_e.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    " CHECK_GFLAG
**** end add 2015/05/04 isid18 ****
*Text symbol text・
*001:Mode
*002:Server
*003:Local
*004:Test Run
*005:File Option
*006:General Option
*007:(Sales Order)
*008:[Error]
*009:[Information]
*010:CLIENT
*011:PROGRAM
*012:USER
*013:Date
*014:Time
*015:<<<Sales Order Upload>>>
*016:<Parameters>
*017:Mode
*018:Test Run
*019:Plant
*020:File Name(Input)
*021:File Name(Result)
*022:File Name(Error)
*023:<Result>
*024:Number of Transcations
*025:Number of Normal
*026:Number of Errors
*027:<Message>
*030:[Warning]
*031:(Row=
*032:)
*033:Row:
*034:/
*035:Item:
*E01:ZTEGZZM001
*E02:CustSalesDate
*E03:DocDate
*E04:PriceDate
*E05:SOQty
*E06:NetPrice
*E07:PriceUnit
*E08:CustomerPODateItm

*Selection text・
*P_EFILE:        File Path(Error)
*P_IFILE:        File Path(Input)
*P_LOCAL:        Local
*P_RFILE:        File Path(Result)
*P_SERVE:        Server
*P_TSTCK:        Test Run
*S_WERKS:        Plant
