*&---------------------------------------------------------------------*
*&  Include           ZEGSDI1030F01
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT .
* プラントコード存在チェック
PERFORM CHECK_WERKS.

* 出荷ポイント存在チェック
PERFORM CHECK_VSTEL.

* プラントの権限チェック
PERFORM CHECK_WERKS_AUTH.

ENDFORM.                    " CHECK_INPUT
*&---------------------------------------------------------------------*
*&      Form  CHECK_WERKS
*&---------------------------------------------------------------------*
*       プラントコード存在チェック
*----------------------------------------------------------------------*
FORM CHECK_WERKS .

TYPES: BEGIN OF LTYP_WERKS,
WERKS TYPE T001W-WERKS,
END OF LTYP_WERKS.

DATA: LTD_WERKS   TYPE STANDARD TABLE OF LTYP_WERKS,
LST_WERKS   TYPE LTYP_WERKS,
LST_WERKS_R LIKE LINE OF RD_WERKS.

SELECT WERKS
INTO TABLE LTD_WERKS
FROM T001W
WHERE WERKS IN S_WERKS.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
*   プラント ( &1 ) は存在しません
MESSAGE E004(ZMEGSD01) WITH S_WERKS-LOW.
ENDIF.

REFRESH RD_WERKS.
LOOP AT LTD_WERKS INTO LST_WERKS.
LST_WERKS_R-SIGN = 'I'.
LST_WERKS_R-OPTION = 'EQ'.
LST_WERKS_R-LOW = LST_WERKS-WERKS.
APPEND LST_WERKS_R TO RD_WERKS.
ENDLOOP.

ENDFORM.                    " CHECK_WERKS
*&---------------------------------------------------------------------*
*&      Form  CHECK_VSTEL
*&---------------------------------------------------------------------*
*       出荷ポイント存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VSTEL .

TYPES: BEGIN OF LTYP_VSTEL,
VSTEL TYPE TVST-VSTEL,
END OF LTYP_VSTEL.

DATA: LTD_VSTEL   TYPE STANDARD TABLE OF LTYP_VSTEL,
LST_VSTEL   TYPE LTYP_VSTEL,
LST_VSTEL_R LIKE LINE OF RD_VSTEL.

SELECT VSTEL
INTO TABLE LTD_VSTEL
FROM TVST
WHERE VSTEL IN S_VSTEL.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VSTEL-LOW'.
*   出荷ポイント ( &1 ) は存在しません
MESSAGE E005(ZMEGSD01) WITH S_VSTEL-LOW.
ENDIF.

REFRESH RD_VSTEL.
LOOP AT LTD_VSTEL INTO LST_VSTEL.
LST_VSTEL_R-SIGN = 'I'.
LST_VSTEL_R-OPTION = 'EQ'.
LST_VSTEL_R-LOW = LST_VSTEL-VSTEL.
APPEND LST_VSTEL_R TO RD_VSTEL.
ENDLOOP.

ENDFORM.                    " CHECK_VSTEL
*&---------------------------------------------------------------------*
*&      Form  CHECK_WERKS_AUTH
*&---------------------------------------------------------------------*
*       プラントの権限チェック
*----------------------------------------------------------------------*
FORM CHECK_WERKS_AUTH .

DATA: LST_WERKS LIKE LINE OF RD_WERKS.

LOOP AT RD_WERKS INTO LST_WERKS.
AUTHORITY-CHECK OBJECT 'M_MSEG_WMB'
ID 'WERKS' FIELD LST_WERKS-LOW
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.

SET CURSOR FIELD 'S_WERKS-LOW'.
*     プラントに対する実行権限がありません
MESSAGE E003(ZMEGSD01).
ENDIF.
ENDLOOP.

ENDFORM.                    " CHECK_WERKS_AUTH
*&---------------------------------------------------------------------*
*&      Form  F4_FOR_LAYOUT
*&---------------------------------------------------------------------*
*       選択画面のLAYOUTのヘルプ設定
*----------------------------------------------------------------------*
FORM F4_FOR_LAYOUT .

DATA: LST_VARIANT_I TYPE DISVARIANT,
**** START ADD 2015/02/27 ISID11 ****
LST_VARIANT_E TYPE DISVARIANT,      "Variant
**** END ADD 2015/02/27 ISID11 ****
LW_SAVE(1)    TYPE C,
LW_EXIT(1)    TYPE C.

LW_SAVE = 'A'.                        "SAVE
LST_VARIANT_I-REPORT = SY-REPID.

CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
EXPORTING
IS_VARIANT    = LST_VARIANT_I
I_SAVE        = LW_SAVE
IMPORTING
E_EXIT        = LW_EXIT
**** START UPD 2015/02/27 ISID11 ****
*      ES_VARIANT    = ST_VARIANT_E
ES_VARIANT    = LST_VARIANT_E
**** END UPD 2015/02/27 ISID11 ****
EXCEPTIONS
NOT_FOUND     = 1
PROGRAM_ERROR = 2
OTHERS        = 3.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_LAYOUT'.

MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
IF LW_EXIT = SPACE.
**** START UPD 2015/02/27 ISID11 ****
*      P_LAYOUT = ST_VARIANT_E-VARIANT.
P_LAYOUT = LST_VARIANT_E-VARIANT.
**** END UPD 2015/02/27 ISID11 ****
ENDIF.
ENDIF.

ENDFORM.                    " F4_FOR_LAYOUT
*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
FORM MAIN_PROCESS .
* PackingListヘッダデータ取得
PERFORM GET_PKG_HEADER CHANGING TD_HEADER.

* 画面出力
PERFORM DISPLAY_ALV CHANGING TD_HEADER.

ENDFORM.                    " MAIN_PROCESS
*&---------------------------------------------------------------------*
*&      Form  GET_PKG_HEADER
*&---------------------------------------------------------------------*
*       PackingListヘッダデータ取得
*----------------------------------------------------------------------*
*      <--O_TD_HEADER  PackingListヘッダ
*----------------------------------------------------------------------*
FORM GET_PKG_HEADER  CHANGING O_TD_HEADER TYPE TYP_TD_HEADER.

DATA:
LTD_SHIPTO TYPE TYP_TD_KNA1,
LTD_SOLDTO TYPE TYP_TD_KNA1.
**** START DEL 2015/01/30 ISID11 ****
*    LTD_ZTEGSDT001 TYPE TYP_TD_ZTEGSDT001.
**** END DEL 2015/01/30 ISID11 ****

* Outbound Delivery」が選択されている場合
IF RB_01 IS NOT INITIAL.
*   Outbound Delivery
PERFORM GET_OUTBOUND CHANGING O_TD_HEADER.
**** START DEL 2015/01/30 ISID11 ****
*                                  LTD_ZTEGSDT001.
**** END DEL 2015/01/30 ISID11 ****

* External Data」が選択されている場合
ELSE.
*   External Data
PERFORM GET_EXTERNAL CHANGING O_TD_HEADER.
**** START DEL 2015/01/30 ISID11 ****
*                                  LTD_ZTEGSDT001.
**** END DEL 2015/01/30 ISID11 ****
ENDIF.

* テキスト取得
PERFORM GET_TEXT USING O_TD_HEADER
CHANGING LTD_SHIPTO
LTD_SOLDTO.

* データ編集
PERFORM EDIT_DATA USING LTD_SHIPTO
LTD_SOLDTO
**** START DEL 2015/01/30 ISID11 ****
*                          LTD_ZTEGSDT001
**** END DEL 2015/01/30 ISID11 ****
CHANGING O_TD_HEADER.

ENDFORM.                    " GET_PKG_HEADER
*&---------------------------------------------------------------------*
*&      Form  GET_OUTBOUND
*&---------------------------------------------------------------------*
*       Outbound Delivery
*----------------------------------------------------------------------*
*      <--O_TD_HEADER      PackingListヘッダ
*      <--O_TD_ZTEGSDT001  TradeCommon
*----------------------------------------------------------------------*
FORM GET_OUTBOUND  CHANGING O_TD_HEADER TYPE TYP_TD_HEADER.
**** START DEL 2015/01/30 ISID11 ****
*                            O_TD_ZTEGSDT001 TYPE TYP_TD_ZTEGSDT001.
**** END DEL 2015/01/30 ISID11 ****

* 販売管理伝票: 出荷ヘッダデータ
**** START UPD 2015/01/30 ISID11 ****
*  SELECT  VSTEL                         "出荷ポイント
*          WADAT                         "出庫予定日付
*          KUNAG                         "受注先
*          KUNNR                         "出荷先
*          VBELN                         "出荷伝票
*          ERDAT                         "レコード登録日
*          ERNAM                         "登録者
*    INTO CORRESPONDING FIELDS OF TABLE O_TD_HEADER
*    FROM LIKP
*   WHERE VBELN         IN S_VBELN        "Outbound Delivery
*     AND WADAT         IN S_WADAT        "Planed GI
*     AND KUNNR         IN S_KUNNR        "Ship-to party
*     AND VSTEL         IN RD_VSTEL       "ShippingPt
*     AND KUNAG         IN S_KUNAG.       "Sold-to party
SELECT LIKP~VSTEL                      "出荷ポイント
LIKP~WADAT                      "出庫予定日付
LIKP~KUNAG                      "受注先
LIKP~KUNNR                      "出荷先
LIKP~VBELN                      "出荷伝票
LIKP~ERDAT                      "レコード登録日
LIKP~ERNAM                      "登録者
ZTEGSDT001~Z_INVOICE_NO         "INVOICE No
ZTEGSDT001~Z_INVOICE_DATE       "INVOICE Date
ZTEGSDT001~Z_SOURCE_TYPE        "Source Type
ZTEGSDT001~Z_STATUS_PACKING     "Status
**** START ADD 2015/08/18 ISID21 ****
ZTEGSDT001~Z_HOLD_FLG           "Hold flag
**** END ADD 2015/08/18 ISID21 ****
ZTEGSDT001~Z_CRE_YMD_PKG    AS Z_CRE_YMD    "Create Date
ZTEGSDT001~Z_CRE_HMS_PKG    AS Z_CRE_HMS    "Create Time
ZTEGSDT001~Z_CRE_USERID_PKG AS Z_CRE_USERID "Create User
ZTEGSDT001~Z_MOD_YMD_PKG    AS Z_MOD_YMD    "Modify Date
ZTEGSDT001~Z_MOD_HMS_PKG    AS Z_MOD_HMS    "Modify Time
ZTEGSDT001~Z_MOD_USERID_PKG AS Z_MOD_USERID "Modify User
INTO CORRESPONDING FIELDS OF TABLE O_TD_HEADER
FROM LIKP
LEFT OUTER JOIN ZTEGSDT001
ON LIKP~VBELN  = ZTEGSDT001~VBELN  "出荷伝票
AND LIKP~ERDAT  = ZTEGSDT001~ERDAT  "レコード登録日
WHERE LIKP~VBELN  IN S_VBELN          "Outbound Delivery
AND LIKP~WADAT  IN S_WADAT          "Planed GI
AND LIKP~KUNNR  IN S_KUNNR          "Ship-to party
AND LIKP~VSTEL  IN RD_VSTEL         "ShippingPt
AND LIKP~KUNAG  IN S_KUNAG.         "Sold-to party
**** END UPD 2015/01/30 ISID11 ****

* データが存在しない場合、メッセージを出力し処理を終了する
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH
**** START UPD 2015/01/30 ISID11 ****
*                                'LIKP'.
'LIKP&ZTEGSDT001'.
**** END UPD 2015/01/30 ISID11 ****
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.

ENDIF.

**** START ADD 2015/01/30 ISID11 ****
DELETE O_TD_HEADER
WHERE NOT
( Z_INVOICE_NO IN S_INVO           "Invoice No
AND Z_INVOICE_DATE   IN S_INDATE     "Invoice Date
*     AND Z_SOURCE_TYPE    = '1'           "ステータス（PackingList）
AND Z_STATUS_PACKING IN S_STATUS     "Status
**** START ADD 2015/08/18 ISID21 ****
AND Z_HOLD_FLG       IN S_HFLG       "Hold Flag
**** END ADD 2015/08/18 ISID21 ****
AND Z_CRE_YMD        IN S_CREYMD     "Create Date
AND Z_CRE_HMS        IN S_CREHMS     "Create Time
AND Z_CRE_USERID     IN S_CREID      "Create User
AND Z_MOD_YMD        IN S_MODYMD     "Modify Date
AND Z_MOD_HMS        IN S_MODHMS     "Modify Time
AND Z_MOD_USERID     IN S_MODID ).   "Modify User

* データが存在しない場合、メッセージを出力し処理を終了する
IF O_TD_HEADER IS INITIAL .
MESSAGE S006(ZMEGSD01) WITH 'LIKP&ZTEGSDT001'.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.

ENDIF.
**** END ADD 2015/01/30 ISID11 ****

SORT O_TD_HEADER BY VBELN ASCENDING
ERDAT ASCENDING.

**** START DEL 2015/01/30 ISID11 ****
** TradeCommon
*  SELECT VBELN                                "出荷伝票
*         ERDAT                                "レコード登録日
*         Z_INVOICE_NO                         "INVOICE No
*         Z_INVOICE_DATE                       "INVOICE Date
*         Z_STATUS_PACKING                     "Status
*         Z_CRE_YMD_PKG                        "Create Date(Packing)
*         Z_CRE_HMS_PKG                        "Create Time(Packing)
*         Z_CRE_USERID_PKG                     "Create User(Packing)
*         Z_MOD_YMD_PKG                        "Modify Date(Packing)
*         Z_MOD_HMS_PKG                        "Modify Time(Packing)
*         Z_MOD_USERID_PKG                     "Modify User(Packing)
*    INTO TABLE O_TD_ZTEGSDT001
*    FROM ZTEGSDT001
*     FOR ALL ENTRIES IN O_TD_HEADER
*   WHERE VBELN            = O_TD_HEADER-VBELN    "出荷伝票
*     AND ERDAT            = O_TD_HEADER-ERDAT    "レコード登録日
*     AND Z_INVOICE_NO     IN S_INVO           "Invoice No
*     AND Z_INVOICE_DATE   IN S_INDATE         "Invoice Date
*     AND Z_SOURCE_TYPE    = '1'               "ステータス（PackingList）
*     AND Z_STATUS_PACKING IN S_STATUS         "Status
*     AND Z_CRE_YMD_PKG    IN S_CREYMD         "Create Date
*     AND Z_CRE_HMS_PKG    IN S_CREHMS         "Create Time
*     AND Z_CRE_USERID_PKG IN S_CREID          "Create User
*     AND Z_MOD_YMD_PKG    IN S_MODYMD         "Modify Date
*     AND Z_MOD_HMS_PKG    IN S_MODHMS         "Modify Time
*     AND Z_MOD_USERID_PKG IN S_MODID.         "Modify User
*
*  SORT O_TD_ZTEGSDT001 BY VBELN ASCENDING
*                          ERDAT ASCENDING.
**** END DEL 2015/01/30 ISID11 ****

ENDFORM.                    " GET_OUTBOUND
*&---------------------------------------------------------------------*
*&      Form  GET_EXTERNAL
*&---------------------------------------------------------------------*
*       External Data
*----------------------------------------------------------------------*
*      <--O_TD_HEADER      PackingListヘッダ
*      <--O_TD_ZTEGSDT001  TradeCommon
*----------------------------------------------------------------------*
FORM GET_EXTERNAL  CHANGING O_TD_HEADER TYPE TYP_TD_HEADER.
**** START DEL 2015/01/30 ISID11 ****
*                            O_TD_ZTEGSDT001 TYPE TYP_TD_ZTEGSDT001.
**** END DEL 2015/01/30 ISID11 ****

* Outbound Delivery(External)
**** START UPD 2015/01/30 ISID11 ****
*  SELECT VSTEL          "出荷ポイント
*         WADAT          "出庫予定日付
*         KUNNR          "出荷先
*         KUNAG          "受注先
*         VBELN          "出荷伝票
*         ERDAT          "レコード登録日
*         ERNAM          "登録者
*    INTO CORRESPONDING FIELDS OF TABLE O_TD_HEADER
*    FROM ZTEGSDT010
*   WHERE VBELN         IN S_VBELN        "Outbound Delivery
*     AND VSTEL         IN RD_VSTEL       "ShippingPt
*     AND WADAT         IN S_WADAT        "Planed GI
*     AND KUNNR         IN S_KUNNR        "Ship-to party
*     AND KUNAG         IN S_KUNAG.       "Sold-to party

SELECT ZTEGSDT010~VSTEL                "出荷ポイント
ZTEGSDT010~WADAT                "出庫予定日付
ZTEGSDT010~KUNNR                "出荷先
ZTEGSDT010~KUNAG                "受注先
ZTEGSDT010~VBELN                "出荷伝票
ZTEGSDT010~ERDAT                "レコード登録日
ZTEGSDT010~ERNAM                "登録者
ZTEGSDT001~Z_INVOICE_NO         "INVOICE No
ZTEGSDT001~Z_INVOICE_DATE       "INVOICE Date
ZTEGSDT001~Z_SOURCE_TYPE        "Source Type
ZTEGSDT001~Z_STATUS_PACKING     "Status
**** START ADD 2015/08/18 ISID21 ****
ZTEGSDT001~Z_HOLD_FLG           "Hold flag
**** END ADD 2015/08/18 ISID21 ****
ZTEGSDT001~Z_CRE_YMD_PKG    AS Z_CRE_YMD    "Create Date
ZTEGSDT001~Z_CRE_HMS_PKG    AS Z_CRE_HMS    "Create Time
ZTEGSDT001~Z_CRE_USERID_PKG AS Z_CRE_USERID "Create User
ZTEGSDT001~Z_MOD_YMD_PKG    AS Z_MOD_YMD    "Modify Date
ZTEGSDT001~Z_MOD_HMS_PKG    AS Z_MOD_HMS    "Modify Time
ZTEGSDT001~Z_MOD_USERID_PKG AS Z_MOD_USERID "Modify User
INTO CORRESPONDING FIELDS OF TABLE O_TD_HEADER
FROM ZTEGSDT010
LEFT OUTER JOIN ZTEGSDT001
ON ZTEGSDT010~VBELN = ZTEGSDT001~VBELN    "出荷伝票
AND ZTEGSDT010~ERDAT = ZTEGSDT001~ERDAT    "レコード登録日
WHERE ZTEGSDT010~VBELN IN S_VBELN            "Outbound Delivery
AND ZTEGSDT010~VSTEL IN RD_VSTEL           "ShippingPt
AND ZTEGSDT010~WADAT IN S_WADAT            "Planed GI
AND ZTEGSDT010~KUNNR IN S_KUNNR            "Ship-to party
AND ZTEGSDT010~KUNAG IN S_KUNAG.           "Sold-to party
**** END UPD 2015/01/30 ISID11 ****

* データが存在しない場合、メッセージを出力し処理を終了する
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH
**** START UPD 2015/01/30 ISID11 ****
*                                'ZTEGSDT010'.
'ZTEGSDT010&ZTEGSDT001'.
**** END UPD 2015/01/30 ISID11 ****
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.

ENDIF.

**** START ADD 2015/01/30 ISID11 ****
DELETE O_TD_HEADER
WHERE NOT
( Z_INVOICE_NO     IN S_INVO           "Invoice No
AND Z_INVOICE_DATE   IN S_INDATE         "Invoice Date
*     AND Z_SOURCE_TYPE    = '2'               "ステータス（PackingList）
AND Z_STATUS_PACKING IN S_STATUS         "Status
**** START ADD 2015/08/18 ISID21 ****
AND Z_HOLD_FLG       IN S_HFLG           "Hold flag
**** END ADD 2015/08/18 ISID21 ****
AND Z_CRE_YMD        IN S_CREYMD         "Create Date
AND Z_CRE_HMS        IN S_CREHMS         "Create Time
AND Z_CRE_USERID     IN S_CREID          "Create User
AND Z_MOD_YMD        IN S_MODYMD         "Modify Date
AND Z_MOD_HMS        IN S_MODHMS         "Modify Time
AND Z_MOD_USERID     IN S_MODID ).       "Modify User

* データが存在しない場合、メッセージを出力し処理を終了する
IF O_TD_HEADER IS INITIAL .
MESSAGE S006(ZMEGSD01) WITH 'ZTEGSDT010&ZTEGSDT001'.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.

ENDIF.
**** END ADD 2015/01/30 ISID11 ****

SORT O_TD_HEADER BY VBELN ASCENDING
ERDAT ASCENDING.

DELETE ADJACENT DUPLICATES FROM O_TD_HEADER
COMPARING VBELN
ERDAT.

**** START DEL 2015/01/30 ISID11 ****
** PackingList（Header）
*  SELECT VBELN                                "出荷伝票
*         ERDAT                                "レコード登録日
*         Z_INVOICE_NO                         "INVOICE No
*         Z_INVOICE_DATE                       "INVOICE Date
*         Z_STATUS_PACKING                     "Status
*         Z_CRE_YMD_PKG                        "Create Date(Packing)
*         Z_CRE_HMS_PKG                        "Create Time(Packing)
*         Z_CRE_USERID_PKG                     "Create User(Packing)
*         Z_MOD_YMD_PKG                        "Modify Date(Packing)
*         Z_MOD_HMS_PKG                        "Modify Time(Packing)
*         Z_MOD_USERID_PKG                     "Modify User(Packing)
*    INTO TABLE O_TD_ZTEGSDT001
*    FROM ZTEGSDT001
*     FOR ALL ENTRIES IN O_TD_HEADER
*   WHERE VBELN            = O_TD_HEADER-VBELN    "出荷伝票
*     AND ERDAT            = O_TD_HEADER-ERDAT    "レコード登録日
*     AND Z_INVOICE_NO     IN S_INVO           "Invoice No
*     AND Z_INVOICE_DATE   IN S_INDATE         "Invoice Date
*     AND Z_SOURCE_TYPE    = '2'               "ステータス（PackingList）
*     AND Z_STATUS_PACKING IN S_STATUS         "Status
*     AND Z_CRE_YMD_PKG    IN S_CREYMD         "Create Date
*     AND Z_CRE_HMS_PKG    IN S_CREHMS         "Create Time
*     AND Z_CRE_USERID_PKG IN S_CREID          "Create User
*     AND Z_MOD_YMD_PKG    IN S_MODYMD         "Modify Date
*     AND Z_MOD_HMS_PKG    IN S_MODHMS         "Modify Time
*     AND Z_MOD_USERID_PKG IN S_MODID.         "Modify User
*
*  SORT O_TD_ZTEGSDT001 BY VBELN ASCENDING
*                          ERDAT ASCENDING.
**** END DEL 2015/01/30 ISID11 ****

ENDFORM.                    " GET_EXTERNAL
*&---------------------------------------------------------------------*
*&      Form  GET_TEXT
*&---------------------------------------------------------------------*
*       テキスト取得
*----------------------------------------------------------------------*
*      <--I_TD_HEADER  PackingListヘッダ
*      <--O_TD_SHIPTO  ITAB:出荷先名称
*      <--O_TD_SOLDTO  ITAB:受注先名称
*----------------------------------------------------------------------*
FORM GET_TEXT USING I_TD_HEADER TYPE TYP_TD_HEADER
CHANGING O_TD_SHIPTO TYPE TYP_TD_KNA1
O_TD_SOLDTO TYPE TYP_TD_KNA1.
DATA:
LTD_HEADER TYPE TYP_TD_HEADER.

LTD_HEADER = I_TD_HEADER.

* 帳票出力項目：Ship-to party Name
SORT LTD_HEADER BY KUNNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_HEADER
COMPARING KUNNR.

SELECT KUNNR
NAME1
INTO TABLE O_TD_SHIPTO
FROM KNA1
FOR ALL ENTRIES IN LTD_HEADER
WHERE KUNNR = LTD_HEADER-KUNNR.

SORT O_TD_SHIPTO BY KUNNR ASCENDING.

* 帳票出力項目：Sold-to party Name
LTD_HEADER = I_TD_HEADER.
SORT LTD_HEADER BY KUNAG ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_HEADER
COMPARING KUNAG.

SELECT KUNNR
NAME1
INTO TABLE O_TD_SOLDTO
FROM KNA1
FOR ALL ENTRIES IN LTD_HEADER
WHERE KUNNR = LTD_HEADER-KUNAG.

SORT O_TD_SOLDTO BY KUNNR ASCENDING.

ENDFORM.                    " GET_TEXT
*&---------------------------------------------------------------------*
*&      Form  EDIT_DATA
*&---------------------------------------------------------------------*
*       データ編集
*----------------------------------------------------------------------*
*      -->I_TD_SHIPTO      ITAB:出荷先名称
*      -->I_TD_SOLDTO      ITAB:受注先名称
*      -->I_TD_ZTEGSDT001  TradeCommon
*      <--O_TD_HEADER      PackingListヘッダ
*----------------------------------------------------------------------*
FORM EDIT_DATA USING I_TD_SHIPTO TYPE TYP_TD_KNA1
I_TD_SOLDTO TYPE TYP_TD_KNA1
**** START DEL 2015/01/30 ISID11 ****
*                     I_TD_ZTEGSDT001 TYPE TYP_TD_ZTEGSDT001
**** END DEL 2015/01/30 ISID11 ****
CHANGING O_TD_HEADER TYPE TYP_TD_HEADER.
DATA:
**** START DEL 2015/01/30 ISID11 ****
*    LST_ZTEGSDT001 TYPE TYP_ZTEGSDT001,
**** END DEL 2015/01/30 ISID11 ****
LST_KNA1       TYPE TYP_KNA1.

FIELD-SYMBOLS:
<LFS_HEADER>   TYPE ZSEGSD0014.

LOOP AT O_TD_HEADER ASSIGNING <LFS_HEADER>.
*   Outbound Delivery」が選択されている場合
IF RB_01 IS NOT INITIAL.
*     Outbound Delivery
<LFS_HEADER>-Z_SOURCE_TYPE = '1'.             "ソースタイプ
*   External Data」が選択されている場合
ELSE.
*     External Data
<LFS_HEADER>-Z_SOURCE_TYPE = '2'.             "ソースタイプ
ENDIF.

**** START DEL 2015/01/30 ISID11 ****
*    READ TABLE I_TD_ZTEGSDT001 INTO LST_ZTEGSDT001
*           WITH KEY VBELN = <LFS_HEADER>-VBELN    "出荷伝票
*                    ERDAT = <LFS_HEADER>-ERDAT    "レコード登録日
*                    BINARY SEARCH.
*
*    IF SY-SUBRC = 0.
*
*      <LFS_HEADER>-Z_INVOICE_NO     = LST_ZTEGSDT001-Z_INVOICE_NO.
*      <LFS_HEADER>-Z_INVOICE_DATE   = LST_ZTEGSDT001-Z_INVOICE_DATE.
*      <LFS_HEADER>-Z_STATUS_PACKING = LST_ZTEGSDT001-Z_STATUS_PACKING.
*      <LFS_HEADER>-Z_CRE_YMD        = LST_ZTEGSDT001-Z_CRE_YMD_PKG.
*      <LFS_HEADER>-Z_CRE_HMS        = LST_ZTEGSDT001-Z_CRE_HMS_PKG.
*      <LFS_HEADER>-Z_CRE_USERID     = LST_ZTEGSDT001-Z_CRE_USERID_PKG.
*      <LFS_HEADER>-Z_MOD_YMD        = LST_ZTEGSDT001-Z_MOD_YMD_PKG.
*      <LFS_HEADER>-Z_MOD_HMS        = LST_ZTEGSDT001-Z_MOD_HMS_PKG.
*      <LFS_HEADER>-Z_MOD_USERID     = LST_ZTEGSDT001-Z_MOD_USERID_PKG.
*
*    ENDIF.
**** END DEL 2015/01/30 ISID11 ****

CLEAR:
LST_KNA1.

*   出荷先
READ TABLE I_TD_SHIPTO INTO LST_KNA1
WITH KEY KUNNR = <LFS_HEADER>-KUNNR
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_HEADER>-SHIPTONAME = LST_KNA1-NAME1.
ENDIF.

CLEAR:
LST_KNA1.

*   受注先
READ TABLE I_TD_SOLDTO INTO LST_KNA1
WITH KEY KUNNR = <LFS_HEADER>-KUNAG
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_HEADER>-SOLDTONAME = LST_KNA1-NAME1.
ENDIF.
ENDLOOP.

* ソート
SORT O_TD_HEADER BY VSTEL ASCENDING      "ShippingPt
WADAT ASCENDING      "Planed GI
KUNNR ASCENDING      "Ship-to party
VBELN ASCENDING.     "Outbound Delivery

ENDFORM.                    " EDIT_DATA
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV
*&---------------------------------------------------------------------*
*       画面出力
*----------------------------------------------------------------------*
*      <--O_TD_HEADER  ITAB:ALVデータ
*----------------------------------------------------------------------*
FORM DISPLAY_ALV  CHANGING O_TD_HEADER TYPE TYP_TD_HEADER.
DATA:
LTD_FIELDCAT TYPE LVC_T_FCAT,     "ITAB:FIELDCAT
**** START ADD 2015/02/27 ISID11 ****
LST_VARIANT_E TYPE DISVARIANT,       "Variant
**** END ADD 2015/02/27 ISID11 ****
LST_LAYOUT   TYPE LVC_S_LAYO.     "ST:LAYOUT

FIELD-SYMBOLS:
<LFS_FIELDCAT> TYPE LVC_S_FCAT.

* FIELDCAT属性の設定
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = 'ZSEGSD0014'
CHANGING
CT_FIELDCAT            = LTD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE 'S' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE 'E'.

LEAVE LIST-PROCESSING.
ENDIF.

READ TABLE LTD_FIELDCAT ASSIGNING <LFS_FIELDCAT> INDEX 1.

IF SY-SUBRC = 0.
<LFS_FIELDCAT>-NO_OUT = 'X'.
ENDIF.

* レイアウト属性の設定
* ストライプ
LST_LAYOUT-ZEBRA = 'X'.
LST_LAYOUT-BOX_FNAME = 'SEL'.
LST_LAYOUT-SEL_MODE  = 'D'.

* ALV コントロール: 列幅の最適化
LST_LAYOUT-CWIDTH_OPT = 'X'.

**** START ADD 2015/02/27 ISID11 ****
* バリアントの管理を分けられそうです
LST_VARIANT_E-REPORT = SY-REPID.
LST_VARIANT_E-VARIANT = P_LAYOUT.
**** END ADD 2015/02/27 ISID11 ****

CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS_2000
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD_2000
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
I_SAVE                   = 'A'
**** START UPD 2015/02/27 ISID11 ****
*      IS_VARIANT               = ST_VARIANT_E
IS_VARIANT               = LST_VARIANT_E
**** END UPD 2015/02/27 ISID11 ****
TABLES
T_OUTTAB                 = O_TD_HEADER
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE 'S' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE 'E'.

LEAVE LIST-PROCESSING.
ENDIF.
ENDFORM.                    " DISPLAY_ALV
*&---------------------------------------------------------------------*
*&      Form  SET_STATUS_2000
*&---------------------------------------------------------------------*
*       2000 ALV画面のステータスの設定
*----------------------------------------------------------------------*
FORM SET_STATUS_2000 USING UT_EXTAB TYPE SLIS_T_EXTAB.
REFRESH: UT_EXTAB.

SET TITLEBAR 'TTB_2000'.
SET PF-STATUS 'STT_2000' EXCLUDING UT_EXTAB.

ENDFORM.                    " SET_STATUS_2000
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND_2000
*&---------------------------------------------------------------------*
*       2000 ALV画面の事件
*----------------------------------------------------------------------*
FORM USER_COMMAND_2000 USING UCOMM    TYPE SY-UCOMM
SELFIELD TYPE SLIS_SELFIELD.
* ボタンイベント処理
CASE UCOMM.
*   「Item」ボタン押下時の処理
WHEN CNS_UCOMM_ITEM.
PERFORM EXCUTE_ITEM.

WHEN OTHERS.
ENDCASE.

**** START ADD 2015/02/05 ISID11 ****
SELFIELD-REFRESH = 'X'.
**** END ADD 2015/02/05 ISID11 ****

ENDFORM.                    " USER_COMMAND_2000
*&---------------------------------------------------------------------*
*&      Form  EXCUTE_ITEM
*&---------------------------------------------------------------------*
*       「Item」ボタン押下時の処理
*----------------------------------------------------------------------*
*      -->I_TD_HEADER  ITAB:ALVデータ
*----------------------------------------------------------------------*
FORM EXCUTE_ITEM  . "USING I_TD_HEADER TYPE TYP_TD_HEADER
* 行選択のチェック処理
PERFORM CHECK_ROW.

* 「PackingList Data Input（Item）」画面への画面遷移
* 選択行の下記パラメータを引き渡し、画面遷移する
"Source Type
"Outbound Delivery
"Created on
"ShippingPt
"Planed GI
"Sold-to party
"Sold-to party Name
"Ship-to party
"Ship-to party Name
PERFORM TRANSFER_ITEM.

ENDFORM.                    " EXCUTE_ITEM
*&---------------------------------------------------------------------*
*&      Form  CHECK_ROW
*&---------------------------------------------------------------------*
*       行選択のチェック処理
*----------------------------------------------------------------------*
FORM CHECK_ROW .
DATA:
LTD_HEADER   TYPE TYP_TD_HEADER.

LTD_HEADER = TD_HEADER.
* 行のチェックが複数選択されている場合はエラーとしメッセージを出力する
DELETE LTD_HEADER WHERE SEL IS INITIAL.

IF LINES( LTD_HEADER ) > 1.
MESSAGE E007(ZMEGSD01).
*   行が複数選択されています。
ENDIF.

LTD_HEADER = TD_HEADER.
* 行が選択されていない場合は、エラーとしメッセージを出力する
DELETE LTD_HEADER WHERE SEL IS NOT INITIAL.

IF SY-SUBRC <> 0.
MESSAGE E008(ZMEGSD01).
*   行が選択されていません。
ENDIF.

ENDFORM.                    " CHECK_ROW
*&---------------------------------------------------------------------*
*&      Form  TRANSFER_ITEM
*&---------------------------------------------------------------------*
*       ALV明細
*----------------------------------------------------------------------*
FORM TRANSFER_ITEM .

DATA:
LST_HEADER  TYPE ZSEGSD0014.

READ TABLE TD_HEADER INTO LST_HEADER
WITH KEY SEL = 'X'.

* PackingListデータ取得
PERFORM GET_PACKINGLIST USING LST_HEADER
CHANGING TD_ITEM
ST_HEADLINE.

TD_ORIGINAL = TD_ITEM.

* 画面出力
PERFORM DISPLAY_ALV_ITEM CHANGING TD_ITEM.

ENDFORM.                    " TRANSFER_ITEM
*&---------------------------------------------------------------------*
*&      Form  GET_PACKINGLIST
*&---------------------------------------------------------------------*
*       PackingListデータ取得
*----------------------------------------------------------------------*
*      -->I_ST_PARAMATER   前画面から引継いだパラメータ
*      <--O_TD_ITEM        PackingList明細
*      <--O_ST_HEADLINE    明細ヘッダ部
*----------------------------------------------------------------------*
FORM GET_PACKINGLIST USING I_ST_PARAMATER TYPE ZSEGSD0014
CHANGING O_TD_ITEM TYPE TYP_TD_ITEM
O_ST_HEADLINE TYPE TYP_HEADLINE.

DATA:
LTD_ZTEGSDT002   TYPE TYP_TD_ZTEGSDT002,
LTD_MAKT         TYPE TYP_TD_MAKT,        "ITAB:品目テキスト
LW_VTEXT         TYPE TVSTT-VTEXT,        "W:出荷ポイント名称
LW_DDTEXT        TYPE DD07T-DDTEXT,       "固定テキスト(短)
LTD_DIMENSION    TYPE TYP_TD_ZTEGSDM009.  "Dimension Text

* Outbound Delivery」が選択されている場合
IF RB_01 IS NOT INITIAL.
*   Outbound Delivery Item
PERFORM GET_OUTBOUNDITEM USING I_ST_PARAMATER
CHANGING O_TD_ITEM
LTD_ZTEGSDT002.
* External Data」が選択されている場合
ELSE.
*   External Data Item
PERFORM GET_EXTERNALITEM USING I_ST_PARAMATER
CHANGING O_TD_ITEM
LTD_ZTEGSDT002.
ENDIF.

**** START ADD 2015/02/11 ISID11 ****
* List排他制御
PERFORM LOCK_LIST USING I_ST_PARAMATER.
**** END ADD 2015/02/11 ISID11 ****

* テキスト取得
PERFORM GET_TEXT_ITEM USING I_ST_PARAMATER
O_TD_ITEM
CHANGING LTD_MAKT
LW_VTEXT
LW_DDTEXT.

* 項目「Dimension Text」
PERFORM GET_TEXT_DIMENSION USING LTD_ZTEGSDT002
CHANGING LTD_DIMENSION.

* データ編集
PERFORM EDIT_ITEM USING I_ST_PARAMATER
LTD_MAKT
LW_VTEXT
LW_DDTEXT
LTD_ZTEGSDT002
LTD_DIMENSION
CHANGING O_TD_ITEM
O_ST_HEADLINE.

ENDFORM.                    " GET_PACKINGLIST
*&---------------------------------------------------------------------*
*&      Form  GET_OUTBOUNDITEM
*&---------------------------------------------------------------------*
*       Outbound Delivery Item
*----------------------------------------------------------------------*
*      -->I_ST_PARAMATER   前画面から引継いだパラメータ
*      <--O_TD_ITEM        PackingList明細
*      <--O_ZTEGSDT002     PackingList
*----------------------------------------------------------------------*
FORM GET_OUTBOUNDITEM USING I_ST_PARAMATER TYPE ZSEGSD0014
CHANGING O_TD_ITEM TYPE TYP_TD_ITEM
O_ZTEGSDT002 TYPE TYP_TD_ZTEGSDT002.
* ローカル変数
**** START ADD 2015/10/28 ISID21 ****
DATA :
LST_ITEM        TYPE  ZSEGSD0015,
LTH_LIPS_INFO TYPE TYP_LIPS_INFO,
LTD_LIPS_INFO TYPE TABLE OF TYP_LIPS_INFO.

* 初期クリア
CLEAR O_TD_ITEM[].
**** END ADD 2015/10/28 ISID21 ****

* 出荷伝票
SELECT LIKP~VBELN              "帳票出力項目：Outbound Delivery
LIKP~ERDAT              "Created on
LIPS~POSNR              "帳票出力項目：Item
LIPS~MATNR              "帳票出力項目：Material
LIPS~LFIMG              "帳票出力項目：Deliv. Qty
**** START ADD 2015/10/28 ISID21 ****
LIPS~KCMENG           "Lot. Qty
**** END ADD 2015/10/28 ISID21 ****
LIPS~VRKME              "帳票出力項目：Unit
**** START  UPD 2015/10/28 ISID21 ****
*    INTO CORRESPONDING FIELDS OF TABLE O_TD_ITEM
INTO TABLE LTD_LIPS_INFO
**** START UPD 2015/10/28 ISID21 ****
FROM LIKP
INNER JOIN LIPS
ON LIKP~VBELN = LIPS~VBELN
WHERE LIKP~VBELN = I_ST_PARAMATER-VBELN
AND LIKP~ERDAT = I_ST_PARAMATER-ERDAT
**** START ADD 2015/10/28 ISID21 ****
AND LIPS~UECHA = SPACE.
**** END ADD 2015/10/28 ISID21 ****

* データが存在しない場合、メッセージを出力し処理を終了する
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH 'LIKP'.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.
ENDIF.

**** START ADD 2015/10/28 ISID21 ****
LOOP AT LTD_LIPS_INFO INTO LTH_LIPS_INFO.
CLEAR LST_ITEM.
LST_ITEM-VBELN = LTH_LIPS_INFO-VBELN.
LST_ITEM-ERDAT = LTH_LIPS_INFO-ERDAT.
LST_ITEM-POSNR = LTH_LIPS_INFO-POSNR.
LST_ITEM-MATNR = LTH_LIPS_INFO-MATNR.
LST_ITEM-LFIMG = LTH_LIPS_INFO-LFIMG + LTH_LIPS_INFO-KCMENG.
LST_ITEM-VRKME = LTH_LIPS_INFO-VRKME.
APPEND LST_ITEM TO O_TD_ITEM.
ENDLOOP.
**** END ADD 2015/10/28 ISID21 ****

SORT O_TD_ITEM BY VBELN ASCENDING
ERDAT ASCENDING.

* PackingList
SELECT VBELN                       "出荷伝票
ERDAT                       "レコード登録日
POSNR                       "出荷伝票明細
Z_PKG_POSNR_SUB             "Packing枝番
Z_MEINS_PACK                "梱包単位
Z_CASENO_FROM               "CASE No(Fro
Z_CASENO_TO                 "CASE No(To)
Z_CASE_COUNT                "CASE Count
Z_CASE_MIX                  "Mix
Z_LFIMG_UNIT                "1梱包あたりの梱包数量
Z_LFIMG                     "梱包数量
Z_VRKME                     "梱包数量単位
Z_NETWEIGHT_UNIT            "1梱包あたりの正味重量
Z_NETWEIGHT                 "正味重量
Z_GEWEI_NW                  "重量単位（正味重量）
Z_GRSWEIGHT_UNIT            "1梱包あたりの総重量
Z_GRSWEIGHT                 "総重量
Z_GEWEI_GW                  "重量単位（総重量）
Z_DIMENSION                 "Dimension
**** START ADD BY ISID17 2015/05/22 ****
Z_LENGTH                    "Length(cm)
Z_WIDTH                     "Width(cm)
Z_HEIGHT                    "Height(cm)
**** END ADD BY ISID17 2015/05/22 ****
Z_VOLUM                     "容積
Z_VOLEH                     "容積単位
Z_PKG_REMARKS               "Remarks
INTO TABLE O_ZTEGSDT002
FROM ZTEGSDT002
WHERE VBELN = I_ST_PARAMATER-VBELN
AND ERDAT = I_ST_PARAMATER-ERDAT.

SORT O_ZTEGSDT002 BY VBELN ASCENDING
ERDAT ASCENDING
POSNR ASCENDING.

ENDFORM.                    " GET_OUTBOUNDITEM
*&---------------------------------------------------------------------*
*&      Form  GET_EXTERNALITEM
*&---------------------------------------------------------------------*
*       External Data Item
*----------------------------------------------------------------------*
*      -->I_ST_PARAMATER   前画面から引継いだパラメータ
*      <--O_TD_ITEM        PackingList明細
*      <--O_ZTEGSDT002     PackingList
*----------------------------------------------------------------------*
FORM GET_EXTERNALITEM USING I_ST_PARAMATER TYPE ZSEGSD0014
CHANGING O_TD_ITEM TYPE TYP_TD_ITEM
O_ZTEGSDT002 TYPE TYP_TD_ZTEGSDT002.
SELECT VBELN              "帳票出力項目：Outbound Delivery
ERDAT              "Created on
POSNR              "帳票出力項目：Item
MATNR              "帳票出力項目：Material
LFIMG              "帳票出力項目：Deliv. Qty
VRKME              "帳票出力項目：Unit
INTO CORRESPONDING FIELDS OF TABLE O_TD_ITEM
FROM ZTEGSDT010
WHERE VBELN = I_ST_PARAMATER-VBELN
AND ERDAT = I_ST_PARAMATER-ERDAT.

* データが存在しない場合、メッセージを出力し処理を終了する
IF SY-SUBRC <> 0.
MESSAGE S006(ZMEGSD01) WITH 'LIKP'.
*   対象データが存在しません。(TBL = &1)
LEAVE LIST-PROCESSING.
ENDIF.

SORT O_TD_ITEM BY VBELN ASCENDING
ERDAT ASCENDING.

* PackingList
SELECT VBELN                       "出荷伝票
ERDAT                       "レコード登録日
POSNR                       "出荷伝票明細
Z_PKG_POSNR_SUB             "Packing枝番
Z_MEINS_PACK                "梱包単位
Z_CASENO_FROM               "CASE No(Fro
Z_CASENO_TO                 "CASE No(To)
Z_CASE_COUNT                "CASE Count
Z_CASE_MIX                  "Mix
Z_LFIMG_UNIT                "1梱包あたりの梱包数量
Z_LFIMG                     "梱包数量
Z_VRKME                     "梱包数量単位
Z_NETWEIGHT_UNIT            "1梱包あたりの正味重量
Z_NETWEIGHT                 "正味重量
Z_GEWEI_NW                  "重量単位（正味重量）
Z_GRSWEIGHT_UNIT            "1梱包あたりの総重量
Z_GRSWEIGHT                 "総重量
Z_GEWEI_GW                  "重量単位（総重量）
Z_DIMENSION                 "Dimension
**** START ADD BY ISID17 2015/05/22 ****
Z_LENGTH                    "Length(cm)
Z_WIDTH                     "Width(cm)
Z_HEIGHT                    "Height(cm)
**** END ADD BY ISID17 2015/05/22 ****
Z_VOLUM                     "容積
Z_VOLEH                     "容積単位
Z_PKG_REMARKS               "Remarks
INTO TABLE O_ZTEGSDT002
FROM ZTEGSDT002
WHERE VBELN = I_ST_PARAMATER-VBELN
AND ERDAT = I_ST_PARAMATER-ERDAT.

SORT O_ZTEGSDT002 BY VBELN ASCENDING
ERDAT ASCENDING
POSNR ASCENDING.

ENDFORM.                    " GET_EXTERNALITEM
*&---------------------------------------------------------------------*
*&      Form  GET_TEXT_ITEM
*&---------------------------------------------------------------------*
*       テキスト取得
*----------------------------------------------------------------------*
*      -->I_ST_PARAMATER  前画面から引継いだパラメータ
*      -->I_TD_ITEM       PackingList明細
*      <--O_TD_MAKT       ITAB:品目テキスト
*      <--O_VTEXT         W:出荷ポイント名称
*      <--O_DDTEXT        固定テキスト(短)
*----------------------------------------------------------------------*
FORM GET_TEXT_ITEM USING I_ST_PARAMATER TYPE ZSEGSD0014
I_TD_ITEM TYPE TYP_TD_ITEM
CHANGING O_TD_MAKT TYPE TYP_TD_MAKT
VALUE(O_VTEXT)  TYPE TVSTT-VTEXT
VALUE(O_DDTEXT) TYPE DD07T-DDTEXT.

DATA:
LTD_MATNR  TYPE TYP_TD_ITEM.

* 品目テキスト取得
LTD_MATNR = I_TD_ITEM.
SORT LTD_MATNR BY MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_MATNR
COMPARING MATNR.

SELECT MATNR                 "品目コード
MAKTX                 "品目テキスト
INTO TABLE O_TD_MAKT
FROM MAKT
FOR ALL ENTRIES IN LTD_MATNR
WHERE MATNR = LTD_MATNR-MATNR
AND SPRAS = SY-LANGU.

SORT O_TD_MAKT BY MATNR ASCENDING.

* 出荷ポイント名称取得
SELECT SINGLE VTEXT          "テキスト
INTO O_VTEXT
FROM TVSTT
WHERE SPRAS = SY-LANGU
AND VSTEL = I_ST_PARAMATER-VSTEL.

* Source Type名称取得
SELECT DDTEXT
INTO O_DDTEXT
FROM DD07T
UP TO 1 ROWS
WHERE DOMNAME    = 'ZDSOURCETYPE'
AND DDLANGUAGE = SY-LANGU
AND VALPOS     = I_ST_PARAMATER-Z_SOURCE_TYPE.
ENDSELECT.

ENDFORM.                    " GET_TEXT_ITEM
*&---------------------------------------------------------------------*
*&      Form  EDIT_ITEM
*&---------------------------------------------------------------------*
*       データ編集
*----------------------------------------------------------------------*
*      -->I_ST_PARAMATER  前画面から引継いだパラメータ
*      -->I_TD_MAKT       品目テキスト
*      -->I_VTEXT         W:出荷ポイント名称
*      -->I_DDTEXT        固定テキスト(短)
*      -->I_TD_ZTEGSDT002 ITAB:出荷明細
*      -->I_TD_DIMENSION  TemplateMaster(Dimension)
*      <--O_TD_ITEM       ITAB:PackingListデータ
*      <--O_ST_HEADLINE   明細ヘッダ部
*----------------------------------------------------------------------*
FORM EDIT_ITEM USING I_ST_PARAMATER  TYPE ZSEGSD0014
I_TD_MAKT       TYPE TYP_TD_MAKT
VALUE(I_VTEXT)        TYPE TVSTT-VTEXT
VALUE(I_DDTEXT)       TYPE DD07T-DDTEXT
I_TD_ZTEGSDT002 TYPE TYP_TD_ZTEGSDT002
I_TD_DIMENSION  TYPE TYP_TD_ZTEGSDM009
CHANGING O_TD_ITEM       TYPE TYP_TD_ITEM
O_ST_HEADLINE   TYPE TYP_HEADLINE.
DATA:
**** START ADD BY ISID REN 2015/05/31 ****
LS_STYL          TYPE LVC_S_STYL,
**** END ADD BY ISID REN 2015/05/31 ****
LST_ZTEGSDT002   TYPE TYP_ZTEGSDT002,
LST_MAKT         TYPE TYP_MAKT,
LST_ZTEGSDM009   TYPE TYP_ZTEGSDM009,
LTD_ITEM         TYPE TYP_TD_ITEM,
LTD_MATNR        TYPE TYP_TD_ITEM,
LST_ITEM         TYPE ZSEGSD0015,
LTD_MEINS        TYPE TYP_TD_MEINS,
LST_MEINS        TYPE TYP_MEINS.

LTD_ITEM = TD_ITEM.

SORT LTD_ITEM BY MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ITEM
COMPARING MATNR.

* ヘッダ部の編集

* Source Type
O_ST_HEADLINE-Z_SOURCE_TYPE = I_ST_PARAMATER-Z_SOURCE_TYPE.

* Source Type Name
O_ST_HEADLINE-DDTEXT        = I_DDTEXT.

* ShippingPt
O_ST_HEADLINE-VSTEL         = I_ST_PARAMATER-VSTEL.

* ShippingPt Name
O_ST_HEADLINE-VTEXT         = I_VTEXT.

* 変換 Exit ALPHA:  内部 -> 外部  Outbound Delivery
PERFORM CONVERT_ALPHA USING I_ST_PARAMATER-VBELN
CHANGING O_ST_HEADLINE-VBELN.

* Planed GI
WRITE I_ST_PARAMATER-WADAT TO O_ST_HEADLINE-WADAT.

* 変換 Exit ALPHA:  内部 -> 外部 Sold-to party
PERFORM CONVERT_ALPHA USING I_ST_PARAMATER-KUNAG
CHANGING O_ST_HEADLINE-KUNAG.

* Sold-to party Name
O_ST_HEADLINE-SOLDTONAME    = I_ST_PARAMATER-SOLDTONAME.

* 変換 Exit ALPHA:  内部 -> 外部 Ship-to party
PERFORM CONVERT_ALPHA USING I_ST_PARAMATER-KUNNR
CHANGING O_ST_HEADLINE-KUNNR.

* Ship-to party Name
O_ST_HEADLINE-SHIPTONAME    = I_ST_PARAMATER-SHIPTONAME.

* 明細部の編集
CLEAR:
LTD_ITEM.

LTD_ITEM = O_TD_ITEM.

CLEAR:
O_TD_ITEM.

LTD_MATNR = LTD_ITEM.
SORT LTD_MATNR BY MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_MATNR
COMPARING MATNR.
SELECT MATNR
MEINS
INTO TABLE LTD_MEINS
FROM MARA
FOR ALL ENTRIES IN LTD_MATNR
WHERE MATNR = LTD_MATNR-MATNR.

SORT LTD_MEINS BY MATNR ASCENDING.

LOOP AT LTD_ITEM INTO LST_ITEM.
*   ITAB:品目テキスト
READ TABLE I_TD_MAKT INTO LST_MAKT
WITH KEY MATNR = LST_ITEM-MATNR
BINARY SEARCH.

IF SY-SUBRC = 0.
*     Description
LST_ITEM-MAKTX = LST_MAKT-MAKTX.
ENDIF.

LOOP AT I_TD_ZTEGSDT002 INTO LST_ZTEGSDT002
WHERE VBELN = LST_ITEM-VBELN
AND ERDAT = LST_ITEM-ERDAT
AND POSNR = LST_ITEM-POSNR.
**** START ADD BY ISID REN 2015/05/31 ****
*     クリア
LST_ITEM-STYLE[] = TD_STYL_INI[].
**** END ADD BY ISID REN 2015/05/31 ****

*     Packing枝番
LST_ITEM-Z_PKG_POSNR_SUB = LST_ZTEGSDT002-Z_PKG_POSNR_SUB.
*     梱包単位
LST_ITEM-Z_MEINS_PACK    = LST_ZTEGSDT002-Z_MEINS_PACK.
*     CASE No(From)
LST_ITEM-Z_CASENO_FROM   = LST_ZTEGSDT002-Z_CASENO_FROM.
*     CASE No(To)
LST_ITEM-Z_CASENO_TO     = LST_ZTEGSDT002-Z_CASENO_TO.
*     CASE Count
LST_ITEM-Z_CASE_COUNT    = LST_ZTEGSDT002-Z_CASE_COUNT.
*     Mix
LST_ITEM-Z_CASE_MIX      = LST_ZTEGSDT002-Z_CASE_MIX.
*     1梱包あたりの梱包数量
LST_ITEM-Z_LFIMG_UNIT    = LST_ZTEGSDT002-Z_LFIMG_UNIT.
*     梱包数量
LST_ITEM-Z_LFIMG         = LST_ZTEGSDT002-Z_LFIMG.
*     梱包数量単位
LST_ITEM-Z_VRKME         = LST_ZTEGSDT002-Z_VRKME.
*     1梱包あたりの総重量 Add
LST_ITEM-Z_NETWEIGHT_UNIT = LST_ZTEGSDT002-Z_NETWEIGHT_UNIT.
*     正味重量
LST_ITEM-Z_NETWEIGHT     = LST_ZTEGSDT002-Z_NETWEIGHT.
*     重量単位（正味重量）
LST_ITEM-Z_GEWEI_NW      = LST_ZTEGSDT002-Z_GEWEI_NW.
*     1梱包あたりの総重量 Add
LST_ITEM-Z_GRSWEIGHT_UNIT = LST_ZTEGSDT002-Z_GRSWEIGHT_UNIT.
*     総重量
LST_ITEM-Z_GRSWEIGHT     = LST_ZTEGSDT002-Z_GRSWEIGHT.
*     重量単位（総重量）
LST_ITEM-Z_GEWEI_GW      = LST_ZTEGSDT002-Z_GEWEI_GW.
*     Dimension
LST_ITEM-Z_DIMENSION     = LST_ZTEGSDT002-Z_DIMENSION.

*     TemplateMaster(Dimension)
READ TABLE I_TD_DIMENSION INTO LST_ZTEGSDM009
WITH KEY Z_TEMPLATE_ID = LST_ITEM-Z_DIMENSION
BINARY SEARCH.

IF SY-SUBRC = 0.

*       Dimension Text
LST_ITEM-Z_DIMENSION_TEXT = LST_ZTEGSDM009-Z_DIMENSION_TEXT.

*       MEAS(M3) Per Pack
LST_ITEM-Z_VOLUM_UNIT = LST_ZTEGSDM009-Z_MEAS.

**** START ADD BY ISID17 2015/05/22 ****
ELSE.
*       帳票出力項目：MEAS(M3) Per Pack←
*       Length(cm)　×　Width(cm)　×　Height(cm)　／　1000000　を設定
LST_ITEM-Z_VOLUM_UNIT = LST_ZTEGSDT002-Z_LENGTH
* LST_ZTEGSDT002-Z_WIDTH
* LST_ZTEGSDT002-Z_HEIGHT
/ 1000000.
**** END ADD BY ISID17 2015/05/22 ****
ENDIF.

**** START ADD BY ISID17 2015/05/22 ****
*     Length(cm)
LST_ITEM-Z_LENGTH        = LST_ZTEGSDT002-Z_LENGTH.
*     Width(cm)
LST_ITEM-Z_WIDTH         = LST_ZTEGSDT002-Z_WIDTH.
*     Height(cm)
LST_ITEM-Z_HEIGHT        = LST_ZTEGSDT002-Z_HEIGHT.
**** END ADD BY ISID17 2015/05/22 ****

*     容積
LST_ITEM-Z_VOLUM         = LST_ZTEGSDT002-Z_VOLUM.
*     容積単位
LST_ITEM-Z_VOLEH         = LST_ZTEGSDT002-Z_VOLEH.
*     Remarks
LST_ITEM-Z_PKG_REMARKS   = LST_ZTEGSDT002-Z_PKG_REMARKS.

**** START ADD BY ISID REN 2015/05/31 ****
IF    LST_ITEM-Z_CASE_MIX   = ABAP_TRUE
**** START UPD BY ISID REN 2015/06/01 ****
*        AND LST_ITEM-Z_LFIMG_UNIT IS INITIAL  "Qty Per Pack
AND LST_ITEM-Z_GRSWEIGHT_UNIT = 0 "G/W(KGS) Per Pack
AND LST_ITEM-Z_LENGTH         = 0  "Length(cm)
AND LST_ITEM-Z_WIDTH          = 0  "Width(cm)
AND LST_ITEM-Z_HEIGHT         = 0  "Height(cm)
**** END UPD BY ISID REN 2015/06/01 ****
AND LST_ITEM-Z_DIMENSION  IS INITIAL. "Dimension
LS_STYL-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_DISABLED.

MODIFY LST_ITEM-STYLE FROM LS_STYL
TRANSPORTING STYLE
WHERE FIELDNAME IS NOT INITIAL.
ENDIF.
**** END ADD BY ISID REN 2015/05/31 ****

APPEND LST_ITEM TO O_TD_ITEM.

CLEAR:
LST_ITEM-Z_DIMENSION_TEXT,
LST_ITEM-Z_VOLUM_UNIT.

ENDLOOP.

IF SY-SUBRC <> 0.

*     Packing枝番
LST_ITEM-Z_PKG_POSNR_SUB = 1.

READ TABLE LTD_MEINS INTO LST_MEINS
WITH KEY MATNR = LST_ITEM-MATNR.

IF SY-SUBRC = 0.
LST_ITEM-Z_VRKME = LST_MEINS-MEINS.
ENDIF.

*     Left join
APPEND LST_ITEM TO O_TD_ITEM.
ENDIF.

CLEAR:
LST_ITEM.

ENDLOOP.

SORT O_TD_ITEM BY VBELN           ASCENDING
POSNR           ASCENDING
Z_PKG_POSNR_SUB ASCENDING.

ENDFORM.                    " EDIT_ITEM
*&---------------------------------------------------------------------*
*&      Form  CONVERT_ALPHA
*&---------------------------------------------------------------------*
*       変換 Exit ALPHA:  内部 -> 外部
*----------------------------------------------------------------------*
*      -->I_INNER  内部
*      <--O_OUT    外部
*----------------------------------------------------------------------*
FORM CONVERT_ALPHA USING VALUE(I_INNER) TYPE CHAR10
CHANGING VALUE(O_OUT) TYPE CHAR10.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = I_INNER
IMPORTING
OUTPUT = O_OUT.

ENDFORM.                    " CONVERT_ALPHA
*&---------------------------------------------------------------------*
*&      Class  CL_EVENT_RECEIVER DEFINITION
*&---------------------------------------------------------------------*
*       Define
*----------------------------------------------------------------------*
CLASS CL_EVENT_RECEIVER DEFINITION FINAL.
PUBLIC SECTION.
CLASS-METHODS:
*   画面値が変更される時事件
HANDLE_DATA_CHANGED
FOR EVENT DATA_CHANGED OF CL_GUI_ALV_GRID
IMPORTING ER_DATA_CHANGED,

*   画面値が変更された後事件
HANDLE_DATA_CHANGED_FINISHED
FOR EVENT DATA_CHANGED_FINISHED OF CL_GUI_ALV_GRID,

HANDLE_MODIFY
FOR EVENT DATA_CHANGED_FINISHED OF CL_GUI_ALV_GRID.

ENDCLASS.                    "CL_EVENT_RECEIVER DEFINITION
*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_ITEM
*&---------------------------------------------------------------------*
*       画面出力
*----------------------------------------------------------------------*
*      <--O_TD_ITEM       ALV
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_ITEM CHANGING O_TD_ITEM TYPE TYP_TD_ITEM.
DATA:
LTD_EVENT    TYPE SLIS_T_EVENT,      "Structure for event handling
LST_EVENT    LIKE LINE OF LTD_EVENT,
LTD_FIELDCAT TYPE LVC_T_FCAT,        "ITAB:FIELDCAT
LST_GLAY     TYPE LVC_S_GLAY,        "編集済セル終了時のコールバック
**** START ADD 2015/02/27 ISID11 ****
LST_VARIANT_E TYPE DISVARIANT,       "Variant
**** END ADD 2015/02/27 ISID11 ****
LST_LAYOUT   TYPE LVC_S_LAYO.        "ST:LAYOUT

CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
EXPORTING
I_LIST_TYPE     = 0
IMPORTING
ET_EVENTS       = LTD_EVENT
EXCEPTIONS
LIST_TYPE_WRONG = 1
OTHERS          = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

READ TABLE LTD_EVENT INTO LST_EVENT
WITH KEY NAME = 'CALLER_EXIT'.

IF SY-SUBRC = 0.
LST_EVENT-FORM = 'ENTER_BUTTON'.
MODIFY LTD_EVENT FROM LST_EVENT INDEX SY-TABIX.
ELSE.
LST_EVENT-NAME = 'CALLER_EXIT'.
LST_EVENT-FORM = 'ENTER_BUTTON'.
APPEND LST_EVENT TO LTD_EVENT.
ENDIF.

* FIELDCAT属性の設定
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = 'ZSEGSD0015'
CHANGING
CT_FIELDCAT            = LTD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

* フィールドカタログ編集
PERFORM EDIT_FIELDCAT CHANGING LTD_FIELDCAT.

* レイアウト属性の設定
* ストライプ
LST_LAYOUT-ZEBRA = 'X'.
LST_LAYOUT-BOX_FNAME = 'SEL'.
LST_LAYOUT-SEL_MODE  = 'D'.

**** START ADD 2015/02/05 ISID11 ****
LST_LAYOUT-NUMC_TOTAL  = 'X'.
**** END ADD 2015/02/05 ISID11 ****

**** START ADD BY 2015/05/28 ****
LST_LAYOUT-STYLEFNAME  = 'STYLE'.
**** END ADD BY 2015/05/28 ****

* ALV コントロール: 列幅の最適化
LST_LAYOUT-CWIDTH_OPT = 'X'.

* ALV コントロール: 編集済セル終了時のコールバック
LST_GLAY-EDT_CLL_CB = 'X'.

**** START ADD 2015/02/27 ISID11 ****
* バリアントの管理を分けられそうです
LST_VARIANT_E-REPORT = SY-REPID.
LST_VARIANT_E-HANDLE = '3000'.
**** END ADD 2015/02/27 ISID11 ****

CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM          = SY-REPID
I_CALLBACK_PF_STATUS_SET    = CNS_PF_STATUS_3000
I_CALLBACK_USER_COMMAND     = CNS_USER_CMD_3000
I_CALLBACK_HTML_TOP_OF_PAGE = 'TOP_OF_PAGE'
I_GRID_SETTINGS             = LST_GLAY
IS_LAYOUT_LVC               = LST_LAYOUT
IT_FIELDCAT_LVC             = LTD_FIELDCAT
I_SAVE                      = 'A'
**** START ADD 2015/02/27 ISID11 ****
IS_VARIANT                  = LST_VARIANT_E
**** END ADD 2015/02/27 ISID11 ****
IT_EVENTS                   = LTD_EVENT
I_HTML_HEIGHT_TOP           = 28
TABLES
T_OUTTAB                    = O_TD_ITEM
EXCEPTIONS
PROGRAM_ERROR               = 1
OTHERS                      = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " DISPLAY_ALV_ITEM
*&---------------------------------------------------------------------*
*&      Form  SET_STATUS_3000
*&---------------------------------------------------------------------*
*       3000 ALV画面のステータスの設定
*----------------------------------------------------------------------*
FORM SET_STATUS_3000 USING UT_EXTAB TYPE SLIS_T_EXTAB.
REFRESH: UT_EXTAB.

SET TITLEBAR 'TTB_3000'.
SET PF-STATUS 'STT_3000' EXCLUDING UT_EXTAB.

ENDFORM.                    " SET_STATUS_3000
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND_3000
*&---------------------------------------------------------------------*
*       3000 ALV画面の事件
*----------------------------------------------------------------------*
FORM USER_COMMAND_3000 USING UCOMM    TYPE SY-UCOMM
SELFIELD TYPE SLIS_SELFIELD.
OK_CODE = SY-UCOMM.
IF OK_CODE = 'RETURN'
OR OK_CODE = 'EXIT'
OR OK_CODE = 'CANCEL'.
*   Exit判断
PERFORM EXIT_ALV.
ENDIF.

* ボタンイベント処理
CASE OK_CODE.
*   「Add Row」ボタン押下時の処理
WHEN CNS_UCOMM_ADDROW.
PERFORM ADD_ROW.
SELFIELD-REFRESH = 'X'.

*   「Delete Row」ボタン押下時の処理
WHEN CNS_UCOMM_DELETEROW.
PERFORM DELETE_ROW.
SELFIELD-REFRESH = 'X'.

*   「Save」ボタン押下時の処理
WHEN '&DATA_SAVE'.
PERFORM SAVE_ITEM.

**** START ADD 2015/08/18 ISID21 ****
*   「Hold」ボタン押下時の処理
WHEN 'HOLD'.
PERFORM HOLD_ITEM.
**** END ADD 2015/08/18 ISID21 ****

WHEN OTHERS.
ENDCASE.

**** START ADD 2015/02/03 ISID11 ****
* 列幅の最適化
PERFORM ADJUST_CWIDTH.
**** END ADD 2015/02/03 ISID11 ****

CLEAR OK_CODE.

ENDFORM.                    " USER_COMMAND_3000
*&---------------------------------------------------------------------*
*&      Form  TOP_OF_PAGE
*&---------------------------------------------------------------------*
*       明細ヘッダ部
*----------------------------------------------------------------------*
FORM TOP_OF_PAGE USING I_REF_DOCUMENT TYPE REF TO CL_DD_DOCUMENT.
DATA:
LW_POSITION TYPE I,
LW_BUFF     TYPE STRING.

* Source Type:
CLEAR:
LW_POSITION,
LW_BUFF.

CONCATENATE
'<html>'
'<div style="left: 10px;'
'position: absolute;line-height:20px;top: 10px;">'
TEXT-H01
'</div>'
'<div style="left: 146px;'
'position: absolute;line-height:20px;top: 10px;">'
ST_HEADLINE-Z_SOURCE_TYPE
'</div>'
'<div style="left: 262px;'
'position: absolute;line-height:20px;top: 10px;">'
ST_HEADLINE-DDTEXT
'</div>'
'</html>'
INTO LW_BUFF.

CALL METHOD I_REF_DOCUMENT->HTML_INSERT
EXPORTING
CONTENTS = LW_BUFF
CHANGING
POSITION = LW_POSITION.

* ShippingPt:
CLEAR:
LW_BUFF.

CONCATENATE
'<div style="left: 10px;'
'position: absolute;line-height:20px;top: 30px;">'
TEXT-H02
'</div>'
'<div style="left: 146px;'
'position: absolute;line-height:20px;top: 30px;">'
ST_HEADLINE-VSTEL
'</div>'
'<div style="left: 262px;'
' position: absolute;line-height:20px;top: 30px;">'
ST_HEADLINE-VTEXT
'</div>'
INTO LW_BUFF.

CALL METHOD I_REF_DOCUMENT->HTML_INSERT
EXPORTING
CONTENTS = LW_BUFF
CHANGING
POSITION = LW_POSITION.

* Outbound Delivery:
CLEAR:
LW_BUFF.

CONCATENATE
'<div style="left: 10px;'
'position: absolute;line-height:20px;top: 50px;">'
TEXT-H03
'</div>'
'<div style="left: 146px;'
'position: absolute;line-height:20px;top: 50px;">'
ST_HEADLINE-VBELN
'</div>'
INTO LW_BUFF.

CALL METHOD I_REF_DOCUMENT->HTML_INSERT
EXPORTING
CONTENTS = LW_BUFF
CHANGING
POSITION = LW_POSITION.

* Planed GI:
CLEAR:
LW_BUFF.

CONCATENATE
'<div style="left: 10px;'
'position: absolute;line-height:20px;top: 70px;">'
TEXT-H04
'</div>'
'<div style="left: 146px;'
' position: absolute;line-height:20px;top: 70px;">'
ST_HEADLINE-WADAT
'</div>'
INTO LW_BUFF.

CALL METHOD I_REF_DOCUMENT->HTML_INSERT
EXPORTING
CONTENTS = LW_BUFF
CHANGING
POSITION = LW_POSITION.

* Sold-to party:
CLEAR:
LW_BUFF.

CONCATENATE
'<div style="left: 10px;'
' position: absolute;line-height:20px;top: 90px;">'
TEXT-H05
'</div>'
'<div style="left: 146px;'
'position: absolute;line-height:20px;top: 90px;">'
ST_HEADLINE-KUNAG
'</div>'
'<div style="left: 262px;'
'position: absolute;line-height:20px;top: 90px;">'
ST_HEADLINE-SOLDTONAME
'</div>'
INTO LW_BUFF.

CALL METHOD I_REF_DOCUMENT->HTML_INSERT
EXPORTING
CONTENTS = LW_BUFF
CHANGING
POSITION = LW_POSITION.

* Ship-to party:
CLEAR:
LW_BUFF.

CONCATENATE
'<div style="left: 10px;'
'position: absolute;line-height:20px;top: 110px;">'
TEXT-H06
'</div>'
'<div style="left: 146px;'
'position: absolute;line-height:20px;top: 110px;">'
ST_HEADLINE-KUNNR
'</div>'
'<div style="left: 262px; '
'position: absolute;line-height:20px;top: 110px;">'
ST_HEADLINE-SHIPTONAME
'</div>'
INTO LW_BUFF.

CALL METHOD I_REF_DOCUMENT->HTML_INSERT
EXPORTING
CONTENTS = LW_BUFF
CHANGING
POSITION = LW_POSITION.

ENDFORM.                    "HTML_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*&      Form  EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*       フィールドカタログ編集
*----------------------------------------------------------------------*
*      <--O_TD_FIELDCAT  ITAB:FIELDCAT
*----------------------------------------------------------------------*
FORM EDIT_FIELDCAT  CHANGING O_TD_FIELDCAT TYPE LVC_T_FCAT.
FIELD-SYMBOLS:
<LFS_FIELDCAT> TYPE LVC_S_FCAT.

LOOP AT O_TD_FIELDCAT ASSIGNING <LFS_FIELDCAT>.
IF <LFS_FIELDCAT>-FIELDNAME = 'SEL'
OR <LFS_FIELDCAT>-FIELDNAME = 'ERDAT'      "Created on
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_VRKME'    "梱包数量単位
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_GEWEI_NW' "重量単位（正味重量）
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_GEWEI_GW' "重量単位（総重量）
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_VOLEH'.   "容積単位
*     表示しない項目
<LFS_FIELDCAT>-NO_OUT = 'X'.
ENDIF.

IF <LFS_FIELDCAT>-FIELDNAME = 'Z_MEINS_PACK'     "Pack Unit
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_CASENO_FROM'    "CASE No(From)
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_CASENO_TO'      "CASE No(To)
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_CASE_MIX'       "Mix
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_LFIMG_UNIT'     "Qty Per Pack
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_NETWEIGHT_UNIT' "N/W(KG) Per Pack
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_GRSWEIGHT_UNIT' "G/W(KG) Per Pack
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_DIMENSION'      "Dimension
**** START ADD BY ISID REN 2015/05/28 ****
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_LENGTH'         "Length(cm)
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_WIDTH'          "Width(cm)
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_HEIGHT'         "Height(cm)
**** END ADD BY ISID REN 2015/05/28 ****
OR <LFS_FIELDCAT>-FIELDNAME = 'Z_PKG_REMARKS'.   "Remarks
*     入力可能
<LFS_FIELDCAT>-EDIT = 'X'.
ENDIF.

**** START ADD 2015/01/30 ISID11 ****
IF <LFS_FIELDCAT>-FIELDNAME = 'Z_PKG_REMARKS'.   "Remarks
*     小文字使用の可否
<LFS_FIELDCAT>-LOWERCASE = 'X'.
ENDIF.
**** END ADD 2015/01/30 ISID11 ****
ENDLOOP.

ENDFORM.                    " EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*&      Class  CL_EVENT_RECEIVER IMPLEMENTATION
*&---------------------------------------------------------------------*
*       Implementation
*----------------------------------------------------------------------*
CLASS CL_EVENT_RECEIVER IMPLEMENTATION.
*&---------------------------------------------------------------------*
*&       Method HANDLE_DATA_CHANGED
*&---------------------------------------------------------------------*
*        画面値が変更される時事件
*----------------------------------------------------------------------*
METHOD HANDLE_DATA_CHANGED.
DATA:
**** START ADD 2015/02/02 ISID11 ****
LW_SUBRC     TYPE SY-SUBRC,
**** END ADD 2015/02/02 ISID11 ****
LST_MSG      TYPE LVC_S_MSG1,
LST_MOD      TYPE LVC_S_MODI,
LST_ITEM     TYPE ZSEGSD0015.

**** START ADD BY REN 2015/05/28 ****
FIELD-SYMBOLS:
<LFS_ITEM>   TYPE ZSEGSD0015.
**** END ADD BY REN 2015/05/28 ****

CLEAR:
**** START ADD BY REN 2015/05/29 ****
TD_ALV_CHANGED_MODI,
**** END ADD BY REN 2015/05/29 ****
W_ERR_FLG.

CALL METHOD REF_GRID->ACTIVATE_DISPLAY_PROTOCOL( SPACE ).
TD_ALV_CHANGED_MODI[] = ER_DATA_CHANGED->MT_MOD_CELLS[].
LOOP AT ER_DATA_CHANGED->MT_MOD_CELLS INTO LST_MOD.
**** START DEL 2015/01/30 ISID11 ****
*      IF ( LST_MOD-FIELDNAME = 'Z_MEINS_PACK'
*      OR LST_MOD-FIELDNAME = 'Z_CASENO_FROM'
*      OR LST_MOD-FIELDNAME = 'Z_CASENO_TO'
*      OR LST_MOD-FIELDNAME = 'Z_LFIMG_UNIT'
*      OR LST_MOD-FIELDNAME = 'Z_NETWEIGHT_UNIT'
*      OR LST_MOD-FIELDNAME = 'Z_GRSWEIGHT_UNIT'
*      OR LST_MOD-FIELDNAME = 'Z_DIMENSION' )
*      AND LST_MOD-VALUE IS INITIAL.
*        CALL METHOD ER_DATA_CHANGED->ADD_PROTOCOL_ENTRY
*          EXPORTING
*            I_MSGID     = '00'
*            I_MSGNO     = '055'
*            I_MSGTY     = 'E'
*            I_FIELDNAME = LST_MOD-FIELDNAME
*            I_ROW_ID    = LST_MOD-ROW_ID.
*
*        READ TABLE TD_ITEM INTO LST_ITEM INDEX LST_MOD-ROW_ID.
*
*        CASE LST_MOD-FIELDNAME.
*          WHEN 'Z_MEINS_PACK'.
*
*            LST_ITEM-Z_MEINS_PACK = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_MEINS_PACK.
*
*
*          WHEN 'Z_CASENO_FROM'.
**           CaseNo Space , Calculate clear
*            CLEAR:
*              LST_ITEM-Z_LFIMG,
*              LST_ITEM-Z_NETWEIGHT,
*              LST_ITEM-Z_GRSWEIGHT,
*              LST_ITEM-Z_VOLUM.
*
*            LST_ITEM-Z_CASENO_FROM = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_CASENO_FROM
*                                Z_LFIMG
*                                Z_NETWEIGHT
*                                Z_GRSWEIGHT
*                                Z_VOLUM.
*
*          WHEN 'Z_CASENO_TO'.
**           CaseNo Space , Calculate clear
*            CLEAR:
*              LST_ITEM-Z_LFIMG,
*              LST_ITEM-Z_NETWEIGHT,
*              LST_ITEM-Z_GRSWEIGHT,
*              LST_ITEM-Z_VOLUM.
*
*            LST_ITEM-Z_CASENO_TO = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_CASENO_TO
*                                Z_LFIMG
*                                Z_NETWEIGHT
*                                Z_GRSWEIGHT
*                                Z_VOLUM.
*
*          WHEN 'Z_LFIMG_UNIT'.
*            CLEAR:
*              LST_ITEM-Z_LFIMG.
*
*            LST_ITEM-Z_LFIMG_UNIT = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_LFIMG_UNIT
*                                Z_LFIMG.
*
*          WHEN 'Z_NETWEIGHT_UNIT'.
*            CLEAR:
*              LST_ITEM-Z_NETWEIGHT.
*
*            LST_ITEM-Z_NETWEIGHT_UNIT = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_NETWEIGHT_UNIT
*                                Z_NETWEIGHT.
*
*          WHEN 'Z_GRSWEIGHT_UNIT'.
*            CLEAR:
*              LST_ITEM-Z_GRSWEIGHT.
*
*            LST_ITEM-Z_GRSWEIGHT_UNIT = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_GRSWEIGHT_UNIT
*                                Z_GRSWEIGHT.
*
*          WHEN 'Z_DIMENSION'.
*            CLEAR:
*              LST_ITEM-Z_VOLUM.
*
*            LST_ITEM-Z_DIMENSION = LST_MOD-VALUE.
*            MODIFY TD_ITEM FROM LST_ITEM
*                          INDEX LST_MOD-ROW_ID
*                   TRANSPORTING Z_DIMENSION
*                                Z_VOLUM.
*          WHEN OTHERS.
*        ENDCASE.
*
*        CONTINUE.
*      ENDIF.
**** END DEL 2015/01/30 ISID11 ****

CASE LST_MOD-FIELDNAME.
**** START ADD 2015/01/30 ISID11 ****
WHEN 'Z_MEINS_PACK'.
CONTINUE.
**** END ADD 2015/01/30 ISID11 ****

*       項目「Dimension」入力後の処理
WHEN 'Z_DIMENSION'.
PERFORM PROCESS_Z_DIMENSION USING LST_MOD-ROW_ID
LST_MOD-VALUE
**** START ADD 2015/02/02 ISID11 ****
LW_SUBRC.
IF LW_SUBRC <> 0.
CALL METHOD ER_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'ZMEGSD01'
I_MSGNO     = '006'
I_MSGTY     = 'E'
I_MSGV1     = 'ZTEGSDM009'
I_FIELDNAME = LST_MOD-FIELDNAME
I_ROW_ID    = LST_MOD-ROW_ID.
ENDIF.
**** END ADD 2015/02/02 ISID11 ****

**** START ADD BY ISID REN 2015/05/28 ****
*     項目「Length(cm)」「Width(cm)」「Height(cm)」入力後の処理
*     項目「Length(cm)」「Width(cm)」「Height(cm)」入力後
*     （フォーカスロスト）に
WHEN 'Z_LENGTH'
OR 'Z_WIDTH'
OR 'Z_HEIGHT'.
READ TABLE TD_ITEM ASSIGNING <LFS_ITEM> INDEX LST_MOD-ROW_ID.

*         入力行の項目「Dimension」「Dimension Text」の内容をクリアする
IF SY-SUBRC = 0.
CLEAR: <LFS_ITEM>-Z_DIMENSION,
<LFS_ITEM>-Z_DIMENSION_TEXT.
ENDIF.
**** END ADD BY ISID REN 2015/05/28 ****

WHEN OTHERS.
ENDCASE.
ENDLOOP.

READ TABLE ER_DATA_CHANGED->MT_PROTOCOL INTO LST_MSG INDEX 1.

IF ER_DATA_CHANGED->MT_PROTOCOL IS NOT INITIAL.
MESSAGE ID LST_MSG-MSGID TYPE 'S' NUMBER LST_MSG-MSGNO
WITH LST_MSG-MSGV1
LST_MSG-MSGV2
LST_MSG-MSGV3
LST_MSG-MSGV4
DISPLAY LIKE 'E'.
W_ERR_FLG = 'X'.
RETURN.
ENDIF.

ENDMETHOD.                    "HANDLE_DATA_CHANGED
*&---------------------------------------------------------------------*
*&      Method  HANDLE_DATA_CHANGED_FINISHED
*&---------------------------------------------------------------------*
*&      データを変更された後
*&---------------------------------------------------------------------*
METHOD HANDLE_DATA_CHANGED_FINISHED.
*   ローカル変数定義
DATA: LW_ERROR_FLG TYPE FLAG,
**** START ADD BY ISID REN 2015/05/28 ****
LW_COUNT     TYPE I,
LST_MOD      TYPE LVC_S_MODI,
LS_LM_ITEM   TYPE ZSEGSD0015,
LS_STYL      TYPE LVC_S_STYL.
**** END ADD BY ISID REN 2015/05/28 ****

FIELD-SYMBOLS:
<LFS_ITEM>   TYPE ZSEGSD0015.

**** 2015/12/1 ISID18 INS START ****
TYPES:
BEGIN OF TY_NTGEW,
MATNR TYPE MARA-MATNR,
NTGEW TYPE MARA-NTGEW,
GEWEI  TYPE MARA-GEWEI,
END OF TY_NTGEW.

DATA: LTB_NTGEW TYPE TABLE OF TY_NTGEW,
LST_NTGEW TYPE TY_NTGEW,
LW_TEMP_NTGEW TYPE ZENETWEIGHTUNIT.
**** 2015/12/1 ISID18 INS END ****

**** START ADD 2015/08/14 ISID21 ****
DELETE  TD_ITEM WHERE VBELN IS INITIAL AND
ERDAT IS INITIAL AND
POSNR IS INITIAL AND
MATNR IS INITIAL.
**** END ADD 2015/08/14 ISID21 ****
**** 2015/12/1 ISID18 INS START ****
IF TD_ITEM IS NOT INITIAL.
*    品目マスタから正味重量を取得する
SELECT
MATNR
NTGEW  "正味重量
GEWEI  "重量単位
FROM MARA
INTO TABLE LTB_NTGEW
FOR ALL ENTRIES IN TD_ITEM
WHERE MATNR = TD_ITEM-MATNR.

SORT LTB_NTGEW BY MATNR ASCENDING.
ENDIF.

*  Qty per packが変更された場合
LOOP AT TD_ALV_CHANGED_MODI INTO LST_MOD
WHERE FIELDNAME = 'Z_LFIMG_UNIT'.

READ TABLE TD_ITEM ASSIGNING <LFS_ITEM> INDEX LST_MOD-ROW_ID.
*       クリア処理
CLEAR LST_NTGEW.

*     正味重量、重量単位を取得する
READ TABLE LTB_NTGEW INTO LST_NTGEW
WITH KEY MATNR = <LFS_ITEM>-MATNR
BINARY SEARCH.

*      品目マスタに設定される場合
IF LST_NTGEW-NTGEW IS NOT INITIAL.
TRY.
*        帳票出力項目：N/W(KG) Per Pack
*       TEMP正味重量 = 正味重量×1梱包あたりの梱包数量
LW_TEMP_NTGEW = LST_NTGEW-NTGEW * <LFS_ITEM>-Z_LFIMG_UNIT.
CATCH CX_SY_ARITHMETIC_OVERFLOW.
LW_TEMP_NTGEW = CNS_NETWEIGHT_MAX.
ENDTRY.

IF LW_TEMP_NTGEW = CNS_NETWEIGHT_MAX.
<LFS_ITEM>-Z_NETWEIGHT_UNIT = LW_TEMP_NTGEW.
ELSE.
*    正味重量の重量単位からPacking listの単位KGへ変換する
CASE LST_NTGEW-GEWEI.
WHEN 'KG'.
<LFS_ITEM>-Z_NETWEIGHT_UNIT = LW_TEMP_NTGEW.
WHEN 'MG'.
<LFS_ITEM>-Z_NETWEIGHT_UNIT = LW_TEMP_NTGEW / 1000000.
WHEN 'G'.
<LFS_ITEM>-Z_NETWEIGHT_UNIT = LW_TEMP_NTGEW / 1000.
WHEN OTHERS.
ENDCASE.
ENDIF.
ENDIF.
ENDLOOP.
**** 2015/12/1 ISID18 INS END ****
LOOP AT TD_ITEM ASSIGNING <LFS_ITEM>.

IF <LFS_ITEM>-Z_CASENO_TO IS INITIAL
OR <LFS_ITEM>-Z_CASENO_FROM IS INITIAL.
CONTINUE.
ENDIF.

*     項目「Qty Per Pack」入力後の処理
IF <LFS_ITEM>-Z_CASENO_TO - <LFS_ITEM>-Z_CASENO_FROM >= 0.
*       帳票出力項目：CASE Count
<LFS_ITEM>-Z_CASE_COUNT =  <LFS_ITEM>-Z_CASENO_TO -
<LFS_ITEM>-Z_CASENO_FROM + 1.

TRY .
*           帳票出力項目：Pack. Qty
<LFS_ITEM>-Z_LFIMG = <LFS_ITEM>-Z_LFIMG_UNIT *
( <LFS_ITEM>-Z_CASENO_TO -
<LFS_ITEM>-Z_CASENO_FROM + 1 ).

CATCH CX_SY_ARITHMETIC_OVERFLOW.
<LFS_ITEM>-Z_LFIMG = CNS_LFIMG_MAX.
ENDTRY.

*       項目「N/W(KG) Per Pack」入力後の処理
TRY .
*           帳票出力項目：N/W(KG)
<LFS_ITEM>-Z_NETWEIGHT = <LFS_ITEM>-Z_NETWEIGHT_UNIT *
( <LFS_ITEM>-Z_CASENO_TO -
<LFS_ITEM>-Z_CASENO_FROM + 1 ).

CATCH CX_SY_ARITHMETIC_OVERFLOW.
<LFS_ITEM>-Z_NETWEIGHT = CNS_NETWEIGHT_MAX.
ENDTRY.

*       項目「G/W(KG) Per Pack」入力後の処理
TRY .
*           帳票出力項目：G/W(KG)
<LFS_ITEM>-Z_GRSWEIGHT = <LFS_ITEM>-Z_GRSWEIGHT_UNIT *
( <LFS_ITEM>-Z_CASENO_TO -
<LFS_ITEM>-Z_CASENO_FROM + 1 ).

CATCH CX_SY_ARITHMETIC_OVERFLOW.
<LFS_ITEM>-Z_GRSWEIGHT = CNS_NETWEIGHT_MAX.
ENDTRY.

**** START DEL BY ISID REN 2015/05/28 ****
*        TRY .
**           帳票出力項目：MEAS(M3)
*            <LFS_ITEM>-Z_VOLUM = <LFS_ITEM>-Z_VOLUM_UNIT *
*                                     ( <LFS_ITEM>-Z_CASENO_TO -
*                                     <LFS_ITEM>-Z_CASENO_FROM + 1 ).
*
*          CATCH CX_SY_ARITHMETIC_OVERFLOW.
*            <LFS_ITEM>-Z_VOLUM = CNS_NETWEIGHT_MAX.
*        ENDTRY.
**** END DEL BY ISID REN 2015/05/28 ****
ENDIF.

**** START ADD BY ISID REN 2015/05/28 ****
*     項目「G/W(KG) Per Pack」が入力されている場合
*     「N/W(KG) Per Pack」　＞　「G/W(KG) Per Pack」となっていた場合
*     OR 項目「N/W(KG) Per Pack」が入力されている場合
*    「N/W(KG) Per Pack」　＞　「G/W(KG) Per Pack」となっていた場合
**** START ADD BY ISID REN 2015/06/04 ****
*     G/Wが未入力時は、チェック対象外としてください
**** END ADD BY ISID REN 2015/06/04 ****
IF
**** START ADD BY ISID REN 2015/06/04 ****
<LFS_ITEM>-Z_GRSWEIGHT_UNIT <> 0
AND
**** END ADD BY ISID REN 2015/06/04 ****
<LFS_ITEM>-Z_NETWEIGHT_UNIT
> <LFS_ITEM>-Z_GRSWEIGHT_UNIT.
W_ERR_FLG = ABAP_TRUE.
ENDIF.

*     入力行の項目「Dimension」データがない場合
IF <LFS_ITEM>-Z_DIMENSION IS INITIAL.
*       項目「MEAS(M3) Per Pack」「MEAS(M3)」に下記を設定する
*       帳票出力項目：MEAS(M3) Per Pack←
*       Length(cm)　×　Width(cm)　×　Height(cm)　／　1000000　を設定
<LFS_ITEM>-Z_VOLUM_UNIT = <LFS_ITEM>-Z_LENGTH
* <LFS_ITEM>-Z_WIDTH
* <LFS_ITEM>-Z_HEIGHT
/ 1000000.
ENDIF.

*     帳票出力項目：MEAS(M3)←
*     MEAS(M3) Per Pack ×　（CASE No(To) - CASE No(From) + 1）を設定
<LFS_ITEM>-Z_VOLUM = <LFS_ITEM>-Z_VOLUM_UNIT *
( <LFS_ITEM>-Z_CASENO_TO -
<LFS_ITEM>-Z_CASENO_FROM + 1 ).
**** END ADD BY ISID REN 2015/05/28 ****
ENDLOOP.

**** START ADD BY ISID REN 2015/05/29 ****
*   「Mix」をONにした場合
LOOP AT TD_ALV_CHANGED_MODI INTO LST_MOD
WHERE FIELDNAME = 'Z_CASE_MIX'.

READ TABLE TD_ITEM INDEX LST_MOD-ROW_ID ASSIGNING <LFS_ITEM>.

IF SY-SUBRC = 0.
CLEAR LW_COUNT.
LOOP AT TD_ITEM TRANSPORTING NO FIELDS
WHERE Z_CASENO_FROM = <LFS_ITEM>-Z_CASENO_FROM
AND Z_CASENO_TO   = <LFS_ITEM>-Z_CASENO_TO
AND Z_CASE_MIX    = ABAP_TRUE.
LW_COUNT = LW_COUNT + 1.

*         現在処理行も含めて、２件以上チェックONとなっていた場合
IF LW_COUNT >= 2.
*           現在入力された行の以下の項目が
*           「入力不可」となるよう画面制御を行う
*           対象項目：「Pack Unit」「Qty Per Pack」「N/W(KGS) Per Pack」
*           「G/W(KGS) Per Pack」「Dimension」「Remarks」
READ TABLE TD_LAST_MOMENT_ITEM INDEX LST_MOD-ROW_ID
INTO LS_LM_ITEM.

IF    <LFS_ITEM>-Z_CASE_MIX = ABAP_TRUE
AND ( SY-SUBRC <> 0
OR    LS_LM_ITEM-Z_CASE_MIX <> ABAP_TRUE ).
CLEAR:
**** START DEL BY ISID REN 2015/06/01 ****
*                     <LFS_ITEM>-Z_MEINS_PACK,     "Pack Unit
*                     <LFS_ITEM>-Z_LFIMG_UNIT,     "Qty Per Pack
*                     <LFS_ITEM>-Z_NETWEIGHT_UNIT, "N/W(KGS) Per Pack
**** END DEL BY ISID REN 2015/06/01 ****
<LFS_ITEM>-Z_GRSWEIGHT_UNIT, "G/W(KGS) Per Pack
<LFS_ITEM>-Z_DIMENSION_TEXT, "Dimension Text
**** START UPD BY ISID REN 2015/06/01 ****
*                     <LFS_ITEM>-Z_PKG_REMARKS,    "Remarks
*                     <LFS_ITEM>-Z_LFIMG,          "Pack. Qty
*                     <LFS_ITEM>-Z_NETWEIGHT,      "N/W(KGS)
<LFS_ITEM>-Z_LENGTH,          "Length(cm)
<LFS_ITEM>-Z_WIDTH,           "Width(cm)
<LFS_ITEM>-Z_HEIGHT,          "Height(cm)
**** END UPD BY ISID REN 2015/06/01 ****
<LFS_ITEM>-Z_GRSWEIGHT.      "G/W(KGS)

IF <LFS_ITEM>-Z_DIMENSION IS NOT INITIAL.
CLEAR: <LFS_ITEM>-Z_DIMENSION,     "Dimension
<LFS_ITEM>-Z_VOLUM_UNIT,    "MEAS(M3) Per Pack
<LFS_ITEM>-Z_VOLUM.         "MEAS(M3)
ENDIF.

LS_STYL-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_DISABLED.

IF <LFS_ITEM>-STYLE IS INITIAL.
<LFS_ITEM>-STYLE = TD_STYL_INI.
ENDIF.

MODIFY <LFS_ITEM>-STYLE FROM LS_STYL
TRANSPORTING STYLE
WHERE FIELDNAME IS NOT INITIAL.
ENDIF.
EXIT.
ENDIF.
ENDLOOP.

IF LW_COUNT < 2.
*         現在入力された行の以下の項目が
*         「入力可能」となるよう画面制御を行う
*         対象項目：「Pack Unit」「Qty Per Pack」「N/W(KGS) Per Pack」
*         「G/W(KGS) Per Pack」「Dimension」「Remarks」
LS_STYL-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_ENABLED.
IF <LFS_ITEM>-STYLE IS INITIAL.
<LFS_ITEM>-STYLE = TD_STYL_INI.
ENDIF.

MODIFY <LFS_ITEM>-STYLE FROM LS_STYL
TRANSPORTING STYLE WHERE FIELDNAME IS NOT INITIAL.

MODIFY TD_ITEM FROM <LFS_ITEM>
TRANSPORTING STYLE
WHERE Z_CASENO_FROM = <LFS_ITEM>-Z_CASENO_FROM
AND Z_CASENO_TO   = <LFS_ITEM>-Z_CASENO_TO.
ENDIF.
ENDIF.
ENDLOOP.

TD_LAST_MOMENT_ITEM[] = TD_ITEM[].
**** END ADD BY ISID REN 2015/05/29 ****

CALL METHOD CL_GUI_CFW=>FLUSH.

**** START ADD BY ISID REN 2015/05/28 ****
*   メッセージ出力
IF W_ERR_FLG = ABAP_TRUE.
*     N/WがG/Wより大きくなっています。
**** START UPD BY ISID REN 2015/05/28 ****
*      MESSAGE E114(ZMEGSD01).
MESSAGE S114(ZMEGSD01) DISPLAY LIKE 'E'.
**** END UPD BY ISID REN 2015/05/28 ****
ENDIF.
**** END ADD BY ISID REN 2015/05/28 ****

ENDMETHOD.                    "HANDLE_DATA_CHANGED_FINISHED
*&---------------------------------------------------------------------*
*&      Method  HANDLE_MODIFY
*&---------------------------------------------------------------------*
*&      データを変更された後
*&---------------------------------------------------------------------*
METHOD HANDLE_MODIFY.

DATA:
LW_COL       TYPE LVC_S_COL,
LW_ROW       TYPE LVC_S_ROW.
**** START DEL 2015/01/30 ISID11 ****
*      LTD_MODI     TYPE LVC_T_CELL.
**** END DEL 2015/01/30 ISID11 ****

IF SY-UCOMM = CNS_UCOMM_ADDROW
OR SY-UCOMM = CNS_UCOMM_DELETEROW.

RETURN.

ENDIF.

CALL METHOD REF_GRID->GET_CURRENT_CELL
IMPORTING
ES_ROW_ID = LW_ROW
ES_COL_ID = LW_COL.

**** START DEL 2015/01/30 ISID11 ****
**   必須入力チェック
*    IF W_ERR_FLG IS INITIAL.
*      PERFORM CHECK_MUST_INPUT CHANGING LTD_MODI.
*    ENDIF.
**** END DEL 2015/01/30 ISID11 ****

**** START ADD 2015/01/30 ISID11 ****
*   列幅の最適化
PERFORM ADJUST_CWIDTH.
IF SY-UCOMM <> '&UMC'.
**** END ADD 2015/01/30 ISID11 ****
CALL METHOD REF_GRID->REFRESH_TABLE_DISPLAY.
**** START ADD 2015/01/30 ISID11 ****
ENDIF.
**** END ADD 2015/01/30 ISID11 ****

CALL METHOD REF_GRID->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LW_ROW
IS_COLUMN_ID = LW_COL.

**** START DEL 2015/01/30 ISID11 ****
*    IF LTD_MODI IS NOT INITIAL.
*      CALL METHOD REF_GRID->SET_SELECTED_CELLS
*        EXPORTING
*          IT_CELLS = LTD_MODI.
*
**     必要な入力項目すべてに入力してください
*      MESSAGE S055(00) DISPLAY LIKE 'E'.
*
*      W_ERR_FLG = 'X'.
*
*    ENDIF.
**** END DEL 2015/01/30 ISID11 ****

IF SY-UCOMM <> '&DATA_SAVE'.
CLEAR W_ERR_FLG.
ENDIF.

ENDMETHOD.                    "HANDLE_MODIFY
ENDCLASS.                    "LCL_EVENT_RECEIVER IMPLEMENTATION
*&---------------------------------------------------------------------*
*&      Form  ENTER_BUTTON
*&---------------------------------------------------------------------*
*       フィールドカタログ編集
*----------------------------------------------------------------------*
*      <--I_ST_GRID
*----------------------------------------------------------------------*
FORM ENTER_BUTTON USING I_ST_GRID TYPE SLIS_DATA_CALLER_EXIT.

DATA:
LREF_RECEIVER TYPE REF TO CL_EVENT_RECEIVER.

CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR'
IMPORTING
E_GRID = REF_GRID.

CALL METHOD REF_GRID->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_ENTER.

CREATE OBJECT LREF_RECEIVER.

SET HANDLER LREF_RECEIVER->HANDLE_DATA_CHANGED FOR REF_GRID.
SET HANDLER LREF_RECEIVER->HANDLE_DATA_CHANGED_FINISHED FOR REF_GRID.
SET HANDLER LREF_RECEIVER->HANDLE_MODIFY FOR REF_GRID.

ENDFORM.                    " ENTER_BUTTON
*&---------------------------------------------------------------------*
*&      Form  ADD_ROW
*&---------------------------------------------------------------------*
*       「Add Row」ボタン押下時の処理
*----------------------------------------------------------------------*
FORM ADD_ROW .

DATA:
LTD_ITEM   TYPE TYP_TD_ITEM,
LST_ITEM   TYPE ZSEGSD0015,
LST_ADDROW TYPE ZSEGSD0015,
LW_LFIMG   TYPE ZSEGSD0015-LFIMG.

* 行選択のチェック処理
PERFORM CHECK_SELECTED.

* 行追加処理
LTD_ITEM = TD_ITEM.

CLEAR LST_ITEM.

READ TABLE LTD_ITEM INTO LST_ITEM
WITH KEY SEL = 'X'.

CLEAR LST_ADDROW.
LST_ADDROW-VBELN = LST_ITEM-VBELN.
LST_ADDROW-ERDAT = LST_ITEM-ERDAT.
LST_ADDROW-POSNR = LST_ITEM-POSNR.
LST_ADDROW-MATNR = LST_ITEM-MATNR.
LST_ADDROW-MAKTX = LST_ITEM-MAKTX.
LST_ADDROW-LFIMG = LST_ITEM-LFIMG.
LST_ADDROW-VRKME = LST_ITEM-VRKME.
LST_ADDROW-Z_VRKME     = LST_ITEM-Z_VRKME.
LST_ADDROW-Z_GEWEI_NW  = LST_ITEM-Z_GEWEI_NW.
LST_ADDROW-Z_GEWEI_GW  = LST_ITEM-Z_GEWEI_GW.
LST_ADDROW-Z_VOLEH     = LST_ITEM-Z_VOLEH.

DELETE LTD_ITEM WHERE VBELN <> LST_ITEM-VBELN
OR POSNR <> LST_ITEM-POSNR.

SORT LTD_ITEM BY VBELN DESCENDING
POSNR DESCENDING
Z_PKG_POSNR_SUB DESCENDING.

CLEAR LST_ITEM.

READ TABLE LTD_ITEM INTO LST_ITEM INDEX 1.
LST_ADDROW-Z_PKG_POSNR_SUB = LST_ITEM-Z_PKG_POSNR_SUB + 1.

LOOP AT LTD_ITEM INTO LST_ITEM.
TRY .

LW_LFIMG = LW_LFIMG + LST_ITEM-Z_LFIMG.

CATCH CX_SY_ARITHMETIC_OVERFLOW.

LW_LFIMG = CNS_LFIMG_MAX.

ENDTRY.

ENDLOOP.

LST_ADDROW-Z_LFIMG_UNIT = LST_ITEM-LFIMG - LW_LFIMG.
IF LST_ADDROW-Z_LFIMG_UNIT < 0.

CLEAR LST_ADDROW-Z_LFIMG_UNIT.

ENDIF.

APPEND LST_ADDROW TO TD_ITEM.

SORT TD_ITEM BY VBELN           ASCENDING
POSNR           ASCENDING
Z_PKG_POSNR_SUB ASCENDING.

* 更新された内容をALV一覧に反映する
PERFORM REFRESH_ALV.

ENDFORM.                    " ADD_ROW
*&---------------------------------------------------------------------*
*&      Form  REFRESH_ALV
*&---------------------------------------------------------------------*
*       更新された内容をALV一覧に反映する
*----------------------------------------------------------------------*
FORM REFRESH_ALV .

CALL FUNCTION 'GET_GLOBALS_FROM_SLVC_FULLSCR'
IMPORTING
E_GRID = REF_GRID.

CALL METHOD REF_GRID->CHECK_CHANGED_DATA.

ENDFORM.                    " REFRESH_ALV
*&---------------------------------------------------------------------*
*&      Form  CHECK_SELECTED
*&---------------------------------------------------------------------*
*       行選択のチェック処理
*----------------------------------------------------------------------*
FORM CHECK_SELECTED .

DATA:
LTD_ITEM   TYPE TYP_TD_ITEM.

LTD_ITEM = TD_ITEM.
* 行のチェックが複数選択されている場合はエラーとしメッセージを出力する
DELETE LTD_ITEM WHERE SEL IS INITIAL.

IF LINES( LTD_ITEM ) > 1.

MESSAGE E007(ZMEGSD01).
*   行が複数選択されています。

ENDIF.

LTD_ITEM = TD_ITEM.
* 行が選択されていない場合は、エラーとしメッセージを出力する
DELETE LTD_ITEM WHERE SEL IS NOT INITIAL.

IF SY-SUBRC <> 0.

MESSAGE E008(ZMEGSD01).
*   行が選択されていません。

ENDIF.

ENDFORM.                    " CHECK_SELECTED
*&---------------------------------------------------------------------*
*&      Form  DELETE_ROW
*&---------------------------------------------------------------------*
*       「Delete Row」ボタン押下時の処理
*----------------------------------------------------------------------*
FORM DELETE_ROW .

DATA:
LTD_ITEM   TYPE TYP_TD_ITEM,
LST_ITEM   TYPE ZSEGSD0015.

* 行選択のチェック処理
PERFORM CHECK_SELECTED.

* 行削除処理
* 選択行のOutbound Delivery/Itemが同一の明細の中で、
* Sub Itemが最大の行の削除を行う
LTD_ITEM = TD_ITEM.
CLEAR LST_ITEM.

READ TABLE LTD_ITEM INTO LST_ITEM
WITH KEY SEL = 'X'.

DELETE LTD_ITEM WHERE VBELN <> LST_ITEM-VBELN
OR POSNR <> LST_ITEM-POSNR.

SORT LTD_ITEM BY VBELN DESCENDING
POSNR DESCENDING
Z_PKG_POSNR_SUB DESCENDING.

IF LINES( LTD_ITEM ) = 1.

RETURN.

ENDIF.

CLEAR LST_ITEM.

READ TABLE LTD_ITEM INTO LST_ITEM INDEX 1.

DELETE TD_ITEM WHERE VBELN = LST_ITEM-VBELN
AND POSNR = LST_ITEM-POSNR
AND Z_PKG_POSNR_SUB = LST_ITEM-Z_PKG_POSNR_SUB.

SORT TD_ITEM BY VBELN           ASCENDING
POSNR           ASCENDING
Z_PKG_POSNR_SUB ASCENDING.

* 更新された内容をALV一覧に反映する
PERFORM REFRESH_ALV.

ENDFORM.                    " DELETE_ROW
*&---------------------------------------------------------------------*
*&      Form  SAVE_ITEM
*&---------------------------------------------------------------------*
*       「Save」ボタン押下時の処理
*----------------------------------------------------------------------*
FORM SAVE_ITEM.

DATA:
LST_HEADER  TYPE ZSEGSD0014,
LW_YMD      TYPE SY-DATUM,
LW_HMS      TYPE SY-UZEIT,
LTD_MODI    TYPE LVC_T_CELL.


LW_YMD = SY-DATUM.
LW_HMS = SY-UZEIT.

* 必須入力チェック
IF W_ERR_FLG IS NOT INITIAL.

CLEAR:
W_ERR_FLG.

RETURN.

ENDIF.

READ TABLE TD_HEADER INTO LST_HEADER
WITH KEY SEL = 'X'.

* 保存時、ALVInput必須項目
PERFORM CHECK_MUST_INPUT CHANGING LTD_MODI.

* Case No
PERFORM CHECK_CASENO CHANGING LTD_MODI.

* 出荷伝票の数量との差異チェック
PERFORM CHECK_QTY CHANGING LTD_MODI.

IF LTD_MODI IS NOT INITIAL.

CALL METHOD REF_GRID->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

RETURN.

ENDIF.

* データ削除（PackingList）
PERFORM SAVE_EDIT_DATA USING LST_HEADER.

* データ保存@（TradeCommon）
PERFORM SAVE_EDIT_ZTEGSDT001 USING LST_HEADER
LW_YMD
LW_HMS.

* データ保存A（PackingList）
PERFORM SAVE_EDIT_ZTEGSDT002 USING LST_HEADER
LW_YMD
LW_HMS.

* テーブルリリース

COMMIT WORK AND WAIT.

**** START UPD 2015/02/11 ISID11 ****
*  PERFORM UNLOCK_TABLE USING TD_ITEM.
* Listテーブルロックの解除
PERFORM UNLOCK_LIST USING LST_HEADER.
**** END UPD 2015/02/11 ISID11 ****

**** START ADD 2015/02/05 ISID11 ****
TD_ORIGINAL = TD_ITEM.
**** END ADD 2015/02/05 ISID11 ****

**** START ADD 2015/02/11 ISID11 ****
* 更新画面2000
PERFORM REGET_SCREEN2000.
LEAVE TO SCREEN 0.
**** END ADD 2015/02/11 ISID11 ****

ENDFORM.                    " SAVE_ITEM

**** START ADD 2015/08/18 ISID21 ****
*&---------------------------------------------------------------------*
*&      Form  HOLD_ITEM
*&---------------------------------------------------------------------*
*       「Hold」ボタン押下時の処理
*----------------------------------------------------------------------*
FORM HOLD_ITEM.

DATA:
LST_HEADER  TYPE ZSEGSD0014,
LW_YMD      TYPE SY-DATUM,
LW_HMS      TYPE SY-UZEIT,
LTD_MODI    TYPE LVC_T_CELL.


LW_YMD = SY-DATUM.
LW_HMS = SY-UZEIT.

* 必須入力チェック
IF W_ERR_FLG IS NOT INITIAL.

CLEAR:
W_ERR_FLG.

RETURN.

ENDIF.

READ TABLE TD_HEADER INTO LST_HEADER
WITH KEY SEL = 'X'.

IF LST_HEADER-Z_STATUS_PACKING = 'X'
AND LST_HEADER-Z_HOLD_FLG = ''.
MESSAGE E125(ZMEGSD01).
ENDIF.

PERFORM REFRESH_ALV.

* データ削除（PackingList）
PERFORM SAVE_EDIT_DATA USING LST_HEADER.

* データ保存@（TradeCommon）
PERFORM SAVE_EDIT_ZTEGSDT001 USING LST_HEADER
LW_YMD
LW_HMS.

* データ保存A（PackingList）
PERFORM SAVE_EDIT_ZTEGSDT002 USING LST_HEADER
LW_YMD
LW_HMS.

* テーブルリリース

COMMIT WORK AND WAIT.

* Listテーブルロックの解除
PERFORM UNLOCK_LIST USING LST_HEADER.

TD_ORIGINAL = TD_ITEM.

* 更新画面2000
PERFORM REGET_SCREEN2000.
LEAVE TO SCREEN 0.

ENDFORM.                    " HOLD_ITEM
**** END ADD 2015/08/18 ISID21 ****

*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  CHECK_CASENO
*&---------------------------------------------------------------------*
*       Case No
*----------------------------------------------------------------------*
FORM CHECK_CASENO CHANGING O_TD_MODI TYPE LVC_T_CELL.

DATA:
LST_ITEM   TYPE ZSEGSD0015,
LST_MIX    TYPE ZSEGSD0015,
LTD_ITEM   TYPE TYP_TD_ITEM,
LTD_CASE   TYPE TYP_TD_ITEM,
LW_Z_CASENO_FROM TYPE ZSEGSD0015-Z_CASENO_FROM,
LW_Z_CASENO_TO   TYPE ZSEGSD0015-Z_CASENO_TO,
LW_CASENO        TYPE CHAR1,
LW_Z_MIX_FROM    TYPE ZSEGSD0015-Z_CASENO_FROM,
LW_Z_MIX_TO      TYPE ZSEGSD0015-Z_CASENO_TO,
**** START DEL BY ISID17 2015/05/22 *****
*    LW_Z_EMPTY_TO    TYPE ZSEGSD0015-Z_CASENO_TO,
**** END DEL BY ISID17 2015/05/22 *****
**** START ADD BY ISID REN 2015/07/23 ****
LTD_ITEM_CHK TYPE TYP_TD_ITEM,
**** END ADD BY ISID REN 2015/07/23 ****
LW_MIX     TYPE CHAR1,
LW_INDEX   TYPE SY-TABIX,
LW_NEW     TYPE SY-TABIX.

**** START ADD 2015/01/30 ISID11 ****
IF O_TD_MODI IS NOT INITIAL.
RETURN.
ENDIF.
**** END ADD 2015/01/30 ISID11 ****

LTD_ITEM = TD_ITEM.

MODIFY LTD_ITEM FROM LST_ITEM
TRANSPORTING SEL
WHERE VBELN IS NOT INITIAL.

SORT LTD_ITEM BY VBELN ASCENDING
ERDAT ASCENDING
POSNR ASCENDING.

* 保存前チェック（From/Toチェック）
LOOP AT LTD_ITEM INTO LST_ITEM.

LW_INDEX = LW_INDEX + 1.
LW_NEW = LW_NEW + 1.

*   「Case No(From) > Case No(To)」の場合、
*   メッセージを出力し処理を中断する
IF LST_ITEM-Z_CASENO_FROM > LST_ITEM-Z_CASENO_TO.

*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_CASENO_FROM'
CHANGING O_TD_MODI.

MESSAGE S009(ZMEGSD01) DISPLAY LIKE 'E'.
RETURN.
*     Case No(From)がCase No(To)より大きくなっています。

ENDIF.

AT NEW POSNR.

CLEAR:
LST_MIX.
LTD_CASE = LTD_ITEM.
SORT LTD_CASE BY VBELN ASCENDING
ERDAT ASCENDING
POSNR ASCENDING
Z_CASE_MIX ASCENDING.

*     取得MIXのLine対象
READ TABLE LTD_CASE INTO LST_MIX
WITH KEY VBELN = LST_ITEM-VBELN
ERDAT = LST_ITEM-ERDAT
POSNR = LST_ITEM-POSNR
Z_CASE_MIX = 'X'
BINARY SEARCH.

IF SY-SUBRC = 0.

LW_Z_MIX_FROM = LST_MIX-Z_CASENO_FROM.
LW_Z_MIX_TO   = LST_MIX-Z_CASENO_TO.
LW_MIX = 'X'.   "MIX Flag

ENDIF.

*     First 1 . Binnary Search not use

LTD_CASE = LTD_ITEM.

DELETE LTD_CASE WHERE VBELN <> LST_ITEM-VBELN
OR ERDAT <> LST_ITEM-ERDAT
OR POSNR <> LST_ITEM-POSNR.

IF LTD_CASE IS INITIAL.

CONTINUE.

ELSE.

CLEAR:
LST_MIX.

READ TABLE LTD_CASE INTO LST_MIX INDEX 1.

LW_Z_CASENO_FROM = LST_MIX-Z_CASENO_FROM.
LW_Z_CASENO_TO   = LST_MIX-Z_CASENO_TO.
ENDIF.

ENDAT.

*   保存前チェック（Mixチェック）
**** START UPD BY ISID REN 2015/07/23 ****
*    IF  LST_ITEM-Z_CASE_MIX IS NOT INITIAL
*    AND ( LW_Z_MIX_FROM <> LST_ITEM-Z_CASENO_FROM
*    OR    LW_Z_MIX_TO <> LST_ITEM-Z_CASENO_TO )
*    AND LW_MIX IS NOT INITIAL.
APPEND LINES OF LTD_ITEM TO LTD_ITEM_CHK.
DELETE LTD_ITEM_CHK WHERE VBELN         <> LST_ITEM-VBELN
OR ERDAT         <> LST_ITEM-ERDAT
**** START DEL BY ISID REN 2015/07/27 ****
*                           OR POSNR         <> LST_ITEM-POSNR
**** END DEL BY ISID REN 2015/07/27 ****
OR Z_CASE_MIX    <> 'X'
OR Z_CASENO_FROM <> LST_ITEM-Z_CASENO_FROM
OR Z_CASENO_TO   <> LST_ITEM-Z_CASENO_TO.

*   CaseNo(From)、CaseNo(To)をキーにして、
*   レコード件数が1件のものはエラーとする
IF LINES( LTD_ITEM_CHK ) = 1.
**** END UPD BY ISID REN 2015/07/23 ****

*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_CASENO_FROM'
CHANGING O_TD_MODI.

**** START UPD BY ISID REN 2015/07/23 ****
**     Mix明細のCase Noが一致していません。
*      MESSAGE S016(ZMEGSD01) DISPLAY LIKE 'E'.
**** START UPD BY ISID REN 2015/07/27 ****
**     Mix明細のCase Noをキーにレコード件数が1件のものはエラーです。
*      MESSAGE S122(ZMEGSD01) DISPLAY LIKE 'E'.
*     Mix明細のCase Noが一致していません。
MESSAGE S016(ZMEGSD01) DISPLAY LIKE 'E'.
**** END UPD BY ISID REN 2015/07/27 ****
**** END UPD BY ISID REN 2015/07/23 ****

RETURN.
ENDIF.

**** START DEL 2015/08/14 ISID21 ****
**   保存前チェック（重複チェック）
*    IF ( LW_Z_CASENO_FROM >= LST_ITEM-Z_CASENO_FROM
*    OR LW_Z_CASENO_TO >= LST_ITEM-Z_CASENO_FROM )
*    AND LST_ITEM-Z_CASE_MIX IS INITIAL
*    AND LW_NEW > 1.
*
**     SET CURSOR
*      PERFORM SET_CURSOR USING LW_INDEX
*                               'Z_CASENO_FROM'
*                      CHANGING O_TD_MODI.
*
*      MESSAGE S010(ZMEGSD01) DISPLAY LIKE 'E'.
*      RETURN.
**     Case Noが重複しています。
*
*    ENDIF.
**** END DEL 2015/08/14 ISID21 ****

IF LST_ITEM-Z_CASE_MIX IS NOT INITIAL
AND LW_NEW > 1
AND LW_CASENO IS INITIAL.

*     取得チェック成功のMAXのCaseNo
LTD_CASE = LTD_ITEM.

DELETE LTD_CASE FROM LW_INDEX + 1.

DELETE LTD_CASE WHERE VBELN <> LST_ITEM-VBELN
OR ERDAT <> LST_ITEM-ERDAT
OR POSNR <> LST_ITEM-POSNR.

SORT LTD_CASE BY Z_CASENO_TO DESCENDING.

CLEAR LST_MIX.

READ TABLE LTD_CASE INTO LST_MIX INDEX 1.

LST_ITEM-Z_CASENO_FROM =  LST_MIX-Z_CASENO_FROM.
LST_ITEM-Z_CASENO_TO   =  LST_MIX-Z_CASENO_TO.

ENDIF.

LW_Z_CASENO_FROM = LST_ITEM-Z_CASENO_FROM.
LW_Z_CASENO_TO   = LST_ITEM-Z_CASENO_TO.
LW_CASENO = LST_ITEM-Z_CASE_MIX.

**** START DEL BY ISID17 2015/05/22 ****
**   保存前チェック（空き番号チェック）
*    IF LW_NEW = 1.
*      IF LST_ITEM-Z_CASENO_FROM < 0
*      OR LST_ITEM-Z_CASENO_TO < 0
*      OR LST_ITEM-Z_CASENO_TO - LST_ITEM-Z_CASENO_FROM < 0.
**       SET CURSOR
*        PERFORM SET_CURSOR USING LW_INDEX
*                                 'Z_CASENO_FROM'
*                        CHANGING O_TD_MODI.
*
*        MESSAGE S011(ZMEGSD01) DISPLAY LIKE 'E'.
*        RETURN.
**       Case Noに空き番号が存在します。
*      ENDIF.
*
*      LW_Z_EMPTY_TO = LST_ITEM-Z_CASENO_TO.
*    ENDIF.
*
*    IF LW_NEW > 1.
*      IF LST_ITEM-Z_CASENO_FROM - LW_Z_EMPTY_TO > 1.
**       SET CURSOR
*        PERFORM SET_CURSOR USING LW_INDEX
*                                 'Z_CASENO_FROM'
*                        CHANGING O_TD_MODI.
*
*        MESSAGE S011(ZMEGSD01) DISPLAY LIKE 'E'.
*        RETURN.
**       Case Noに空き番号が存在します。
*      ENDIF.
*
*      LW_Z_EMPTY_TO = LST_ITEM-Z_CASENO_TO.
*    ENDIF.
**** END DEL BY ISID17 2015/05/22 ****

AT END OF POSNR.

CLEAR:
LW_MIX,
LW_NEW,
LW_Z_CASENO_FROM,
LW_Z_CASENO_TO,
**** START DEL BY ISID17 2015/05/22 ****
*        LW_Z_EMPTY_TO,
**** END DEL BY ISID17 2015/05/22 ****
LW_Z_MIX_FROM,
LW_Z_MIX_TO,
LW_CASENO.

ENDAT.

ENDLOOP.

ENDFORM.                    " CHECK_CASENO
*&---------------------------------------------------------------------*
*&      Form  SET_CURSOR
*&---------------------------------------------------------------------*
*       SET CURSOR
*----------------------------------------------------------------------*
*      -->I_TABIX  Lines
*      -->I_NAME   TEXT
*----------------------------------------------------------------------*
FORM SET_CURSOR  USING VALUE(I_TABIX) TYPE SY-TABIX
VALUE(I_NAME) TYPE LVC_FNAME
CHANGING O_TD_MODI TYPE LVC_T_CELL.

DATA:
LST_MODI   TYPE LVC_S_CELL.

LST_MODI-ROW_ID-INDEX = I_TABIX.
LST_MODI-COL_ID-FIELDNAME = I_NAME.
APPEND LST_MODI TO O_TD_MODI.

ENDFORM.                    " SET_CURSOR
*&---------------------------------------------------------------------*
*&      Form  CHECK_QTY
*&---------------------------------------------------------------------*
*       出荷伝票の数量との差異チェック
*----------------------------------------------------------------------*
FORM CHECK_QTY CHANGING O_TD_MODI TYPE LVC_T_CELL.

DATA:
LST_ITEM   TYPE ZSEGSD0015,
LST_SUM    TYPE ZSEGSD0015,
LTD_ITEM   TYPE TYP_TD_ITEM,
LW_Z_LFIMG TYPE ZSEGSD0015-Z_LFIMG,
LW_INDEX   TYPE SY-TABIX.

IF O_TD_MODI IS NOT INITIAL.
RETURN.
ENDIF.

LTD_ITEM = TD_ITEM.

SORT LTD_ITEM BY VBELN           ASCENDING
POSNR           ASCENDING.

DELETE ADJACENT DUPLICATES FROM LTD_ITEM
COMPARING VBELN
POSNR.

LOOP AT LTD_ITEM INTO LST_ITEM.

CLEAR:
LW_Z_LFIMG,
LW_INDEX.

LOOP AT TD_ITEM INTO LST_SUM
WHERE VBELN = LST_ITEM-VBELN
AND POSNR = LST_ITEM-POSNR.

IF LW_INDEX IS INITIAL.

LW_INDEX = SY-TABIX.

ENDIF.

LW_Z_LFIMG = LW_Z_LFIMG + LST_SUM-Z_LFIMG.

ENDLOOP.

IF LST_ITEM-LFIMG <> LW_Z_LFIMG.

*       SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_LFIMG_UNIT'
CHANGING O_TD_MODI.

MESSAGE S015(ZMEGSD01) WITH LST_ITEM-POSNR DISPLAY LIKE 'E'.
RETURN.
*     元伝票とPackingListデータの数量が一致しません。（明細：&1）

ENDIF.
ENDLOOP.

ENDFORM.                    " CHECK_QTY

*&---------------------------------------------------------------------*
*&      Form  PROCESS_Z_DIMENSION
*&---------------------------------------------------------------------*
*       項目「Dimension」入力後の処理
*----------------------------------------------------------------------*
*      -->I_ROW
*      -->I_VALUE
*      <--O_SUBRC
*----------------------------------------------------------------------*
FORM PROCESS_Z_DIMENSION  USING    I_ROW  TYPE INT4
I_VALUE TYPE LVC_S_MODI-VALUE
**** START ADD 2015/02/02 ISID11 ****
CHANGING    O_SUBRC TYPE SY-SUBRC.
**** END ADD 2015/02/02 ISID11 ****

DATA:
LW_DIMENSION_TEXT  TYPE ZTEGSDM009-Z_DIMENSION_TEXT,
**** START ADD BY ISID REN 2015/05/27 ****
LW_Z_LENGTH        TYPE ZTEGSDM009-Z_LENGTH, "Length(cm)
LW_Z_WIDTH         TYPE ZTEGSDM009-Z_WIDTH,  "Width(cm)
LW_Z_HEIGHT        TYPE ZTEGSDM009-Z_HEIGHT, "Height(cm)
**** END ADD BY ISID REN 2015/05/27 ****
LW_MEAS TYPE ZTEGSDM009-Z_MEAS.

FIELD-SYMBOLS:
<LFS_ITEM>   TYPE ZSEGSD0015.

READ TABLE TD_ITEM ASSIGNING <LFS_ITEM> INDEX I_ROW.

**** START ADD 2015/08/14 ISID21 ****
IF <LFS_ITEM> IS NOT ASSIGNED.
RETURN.
ENDIF.
**** END ADD 2015/08/14 ISID21 ****

**** START ADD BY ISID REN 2015/06/01 ****
IF I_VALUE IS INITIAL.
CLEAR:
<LFS_ITEM>-Z_DIMENSION_TEXT,
<LFS_ITEM>-Z_VOLUM_UNIT.
RETURN.
ENDIF.
**** END ADD BY ISID REN 2015/06/01 ****

SELECT SINGLE
Z_DIMENSION_TEXT      "Dimension Text
Z_MEAS                "MEAS(M3)
**** START ADD BY ISID REN 2015/05/27 ****
Z_LENGTH              "Length(cm)
Z_WIDTH               "Width(cm)
Z_HEIGHT              "Height(cm)
**** END ADD BY ISID REN 2015/05/27 ****
INTO (LW_DIMENSION_TEXT ,
LW_MEAS ,
**** START ADD BY ISID REN 2015/05/27 ****
LW_Z_LENGTH ,        "Length(cm)
LW_Z_WIDTH ,         "Width(cm)
LW_Z_HEIGHT)         "Height(cm)
**** END ADD BY ISID REN 2015/05/27 ****
FROM ZTEGSDM009
WHERE Z_TEMPLATE_ID = I_VALUE.

**** START ADD 2015/02/02 ISID11 ****
IF SY-SUBRC <> 0.
O_SUBRC = SY-SUBRC.
CLEAR:
<LFS_ITEM>-Z_DIMENSION_TEXT,
<LFS_ITEM>-Z_VOLUM_UNIT.

**** START ADD BY ISID REN 2015/05/27 ****
ELSE.
* 帳票出力項目：Dimension Text
<LFS_ITEM>-Z_DIMENSION_TEXT = LW_DIMENSION_TEXT.

* 項目「Dimension」入力後（フォーカスロスト）には、
* 項目「MEAS(M3) Per Pack」「MEAS(M3)」に下記を設定する
* 帳票出力項目：MEAS(M3) Per Pack
<LFS_ITEM>-Z_VOLUM_UNIT = LW_MEAS.

<LFS_ITEM>-Z_LENGTH = LW_Z_LENGTH.        "Length(cm)
<LFS_ITEM>-Z_WIDTH  = LW_Z_WIDTH.         "Width(cm)
<LFS_ITEM>-Z_HEIGHT = LW_Z_HEIGHT.        "Height(cm)
**** END ADD BY ISID REN 2015/05/27 ****
ENDIF.
**** END ADD 2015/02/02 ISID11 ****

**** DEL ADD BY ISID REN 2015/05/27 ****
** 帳票出力項目：Dimension Text
*  <LFS_ITEM>-Z_DIMENSION_TEXT = LW_DIMENSION_TEXT.
*
** 項目「Dimension」入力後（フォーカスロスト）には、
** 項目「MEAS(M3) Per Pack」「MEAS(M3)」に下記を設定する
** 帳票出力項目：MEAS(M3) Per Pack
*  <LFS_ITEM>-Z_VOLUM_UNIT = LW_MEAS.
**** END ADD BY ISID REN 2015/05/27 ****

ENDFORM.                    " PROCESS_Z_DIMENSION
*&---------------------------------------------------------------------*
*&      Form  SAVE_EDIT_DATA
*&---------------------------------------------------------------------*
*       データ削除（PackingList）
*----------------------------------------------------------------------*
FORM SAVE_EDIT_DATA USING I_ST_HEADER TYPE ZSEGSD0014.

**** START DEL 2015/02/11 ISID11 ****
** テーブルロック
*  PERFORM LOCK_TABLE.
**** END DEL 2015/02/11 ISID11 ****

* DELETE処理
PERFORM DELETE_ZTEGSDT002 USING I_ST_HEADER.

ENDFORM.                    " SAVE_EDIT_DATA
**** START DEL 2015/02/11 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  LOCK_TABLE
*&---------------------------------------------------------------------*
*       テーブルロック
*----------------------------------------------------------------------*
*FORM LOCK_TABLE .
*
*  DATA:
*    LST_ITEM TYPE ZSEGSD0015,
*    LTD_ITEM TYPE TYP_TD_ITEM.
*
*  LOOP AT TD_ITEM INTO LST_ITEM.
*
**   PackingList
*    CALL FUNCTION 'ENQUEUE_EZZTEGSDT002'
*      EXPORTING
*        MODE_ZTEGSDT002 = 'E'
*        VBELN           = LST_ITEM-VBELN
*        ERDAT           = LST_ITEM-ERDAT
*        POSNR           = LST_ITEM-POSNR
*        Z_PKG_POSNR_SUB = LST_ITEM-Z_PKG_POSNR_SUB
*      EXCEPTIONS
*        FOREIGN_LOCK    = 1
*        SYSTEM_FAILURE  = 2
*        OTHERS          = 3.
*    IF SY-SUBRC <> 0.
*
**     テーブルリリース
*      PERFORM UNLOCK_TABLE USING LTD_ITEM.
*
***** START UPD 2015/02/11 ISID11 ****
**      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*      MESSAGE E080(ZMEGSD01) WITH SY-MSGV1.
**     対象の伝票は、別のユーザが編集中です。（USER = &1）
***** END UPD 2015/02/11 ISID11 ****
*
*    ENDIF.
*
***** START DEL 2015/02/11 ISID11 ****
***   TradeCommon
**    CALL FUNCTION 'ENQUEUE_EZZTEGSDT001'
**      EXPORTING
**        MODE_ZTEGSDT001 = 'E'
**        VBELN           = LST_ITEM-VBELN
**        ERDAT           = LST_ITEM-ERDAT
**      EXCEPTIONS
**        FOREIGN_LOCK    = 1
**        SYSTEM_FAILURE  = 2
**        OTHERS          = 3.
**    IF SY-SUBRC <> 0.
**
**      APPEND LST_ITEM TO LTD_ITEM.
***     テーブルリリース
**      PERFORM UNLOCK_TABLE USING LTD_ITEM.
**
**      MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
**
**    ENDIF.
**** END DEL 2015/02/11 ISID11 ****
*    APPEND LST_ITEM TO LTD_ITEM.
*
*  ENDLOOP.
*
*ENDFORM.                    " LOCK_TABLE
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_TABLE
*&---------------------------------------------------------------------*
*       テーブルリリース
*----------------------------------------------------------------------*
*      -->I_TD_ITEM  PackingList明細
*----------------------------------------------------------------------*
*FORM UNLOCK_TABLE  USING    I_TD_ITEM TYPE TYP_TD_ITEM.
*
*  DATA:
*    LST_ITEM TYPE ZSEGSD0015.
*
*  LOOP AT I_TD_ITEM INTO LST_ITEM.
*
*    CALL FUNCTION 'DEQUEUE_EZZTEGSDT002'
*      EXPORTING
*        MODE_ZTEGSDT002 = 'E'
*        VBELN           = LST_ITEM-VBELN
*        ERDAT           = LST_ITEM-ERDAT
*        POSNR           = LST_ITEM-POSNR
*        Z_PKG_POSNR_SUB = LST_ITEM-Z_PKG_POSNR_SUB.
*
***** START DEL 2015/02/11 ISID11 ****
**    CALL FUNCTION 'DEQUEUE_EZZTEGSDT001'
**      EXPORTING
**        MODE_ZTEGSDT001 = 'E'
**        VBELN           = LST_ITEM-VBELN
**        ERDAT           = LST_ITEM-ERDAT.
***** END DEL 2015/02/11 ISID11 ****
*
*  ENDLOOP.
*
*ENDFORM.                    " UNLOCK_TABLE
**** END DEL 2015/02/11 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  DELETE_ZTEGSDT002
*&---------------------------------------------------------------------*
*       DELETE処理
*----------------------------------------------------------------------*
*      -->I_ST_HEADER
*----------------------------------------------------------------------*
FORM DELETE_ZTEGSDT002  USING I_ST_HEADER TYPE ZSEGSD0014.

DATA:
LW_MSG         TYPE SY-MSGV1,
LW_VBELN       TYPE ZTEGSDT002-VBELN.

* 存在の判断
SELECT VBELN
INTO LW_VBELN
FROM ZTEGSDT002
UP TO 1 ROWS
WHERE VBELN = I_ST_HEADER-VBELN
AND ERDAT = I_ST_HEADER-ERDAT.
ENDSELECT.

IF SY-SUBRC <> 0.

RETURN.

ENDIF.

DELETE FROM ZTEGSDT002 WHERE VBELN = I_ST_HEADER-VBELN
AND ERDAT = I_ST_HEADER-ERDAT.

IF SY-SUBRC <> 0.

ROLLBACK WORK.

**** START DEL 2015/02/11 ISID11 ****
**   テーブルリリース
*    PERFORM UNLOCK_TABLE USING TD_ITEM.
**** END DEL 2015/02/11 ISID11 ****

CONCATENATE 'ZMEGSD01'
'012'
INTO LW_MSG
SEPARATED BY SPACE.

MESSAGE E012(ZMEGSD01) WITH 'ZTEGSDT002' LW_MSG.
*   データ更新に失敗しました。(TBL = &1 / MSG = &2 )

ENDIF.

ENDFORM.                    " DELETE_ZTEGSDT002
*&---------------------------------------------------------------------*
*&      Form  SAVE_EDIT_ZTEGSDT001
*&---------------------------------------------------------------------*
*       データ保存@（TradeCommon）
*----------------------------------------------------------------------*
*      -->I_TD_ITEM
*      -->I_YMD     SY-DATUM
*      -->I_HMS     SY-UZEIT
*----------------------------------------------------------------------*
FORM SAVE_EDIT_ZTEGSDT001  USING I_ST_HEADER TYPE ZSEGSD0014
I_YMD TYPE SY-DATUM
I_HMS TYPE SY-UZEIT.
* ローカル変数定義
DATA:
LTD_VBELN      TYPE TYP_TD_VBELN,
**** START ADD BY ISID REN 2015/06/02 ****
LST_VBELN      TYPE TYP_VBELN,            "TradeCommon
**** END ADD BY ISID REN 2015/06/02 ****
LTD_ITEM       TYPE TYP_TD_ITEM,
LST_ITEM       TYPE ZSEGSD0015,
LST_INSERT     TYPE ZTEGSDT001,
**** START ADD 2015/08/18 ISID21 ****
LW_HFLG        TYPE C,
**** END ADD 2015/08/18 ISID21 ****
LW_MSG         TYPE SY-MSGV1.

**** START ADD 2015/08/18 ISID21 ****
CLEAR LW_HFLG.
IF OK_CODE = 'HOLD'.
LW_HFLG = 'X'.
ELSEIF OK_CODE = '&DATA_SAVE'.
LW_HFLG = ''.
ENDIF.
**** END ADD 2015/08/18 ISID21 ****

LTD_ITEM = TD_ITEM.
SORT LTD_ITEM BY VBELN ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ITEM
COMPARING VBELN.

SELECT VBELN         "出荷伝票
ERDAT         "レコード登録日
**** START ADD BY ISID REN 2015/06/02 ****
Z_CRE_YMD_PKG    "登録年月日（PACKING LIST）
Z_CRE_HMS_PKG    "登録時分秒（PACKING LIST）
Z_CRE_USERID_PKG "登録ユーザ（PACKING LIST）
**** END ADD BY ISID REN 2015/06/02 ****
INTO TABLE LTD_VBELN
FROM ZTEGSDT001
FOR ALL ENTRIES IN LTD_ITEM
WHERE VBELN = LTD_ITEM-VBELN
AND ERDAT = I_ST_HEADER-ERDAT.

SORT LTD_VBELN
BY VBELN ASCENDING
**** START UPD BY ISID REN 2015/06/02 ****
ERDAT ASCENDING.
**** END UPD BY ISID REN 2015/06/02 ****

LST_INSERT-ERDAT            = I_ST_HEADER-ERDAT.
LST_INSERT-Z_STATUS_PACKING = 'X'.
**** START ADD 2015/08/18 ISID21 ****
LST_INSERT-Z_HOLD_FLG       = LW_HFLG.
**** END ADD 2015/08/18 ISID21 ****
LST_INSERT-Z_CRE_YMD_PKG    = I_YMD.
LST_INSERT-Z_CRE_HMS_PKG    = I_HMS.
LST_INSERT-Z_CRE_USERID_PKG = SY-UNAME.
LST_INSERT-Z_CRE_YMD        = I_YMD.
LST_INSERT-Z_CRE_HMS        = I_HMS.
LST_INSERT-Z_CRE_USERID     = SY-UNAME.

LOOP AT LTD_ITEM INTO LST_ITEM.

READ TABLE LTD_VBELN
**** START UPD BY ISID REN 2015/06/02 ****
*      TRANSPORTING NO FIELDS
INTO LST_VBELN                           "TradeCommon
**** END UPD BY ISID REN 2015/06/02 ****
WITH KEY VBELN = LST_ITEM-VBELN
**** START UPD BY ISID REN 2015/06/02 ****
ERDAT = I_ST_HEADER-ERDAT
**** END UPD BY ISID REN 2015/06/02 ****
BINARY SEARCH.

*   UPDATE時（TradeCommonが存在する場合）
IF SY-SUBRC = 0.
**** START ADD BY ISID REN 2015/06/02 ****
*     ブランクの場合のみ設定
IF LST_VBELN-Z_CRE_YMD_PKG IS INITIAL. "登録年月日（PACKING LIST）
LST_VBELN-Z_CRE_YMD_PKG = I_YMD.
ENDIF.

IF LST_VBELN-Z_CRE_HMS_PKG IS INITIAL. "登録時分秒（PACKING LIST）
LST_VBELN-Z_CRE_HMS_PKG = I_HMS.
ENDIF.

IF LST_VBELN-Z_CRE_USERID_PKG
IS INITIAL.                       "登録ユーザ（PACKING LIST）
LST_VBELN-Z_CRE_USERID_PKG = SY-UNAME.
ENDIF.
**** END ADD BY ISID REN 2015/06/02 ****

UPDATE ZTEGSDT001
SET Z_STATUS_PACKING = 'X'
**** START ADD 2015/08/18 ISID21 ****
Z_HOLD_FLG       = LW_HFLG
**** END ADD 2015/08/18 ISID21 ****
**** START ADD BY ISID REN 2015/06/02 ****
Z_CRE_YMD_PKG
= LST_VBELN-Z_CRE_YMD_PKG    "登録年月日（PACKING LIST）
Z_CRE_HMS_PKG
= LST_VBELN-Z_CRE_HMS_PKG    "登録時分秒（PACKING LIST）
Z_CRE_USERID_PKG
= LST_VBELN-Z_CRE_USERID_PKG "登録ユーザ（PACKING LIST）
**** END ADD BY ISID REN 2015/06/02 ****
Z_MOD_YMD_PKG    = I_YMD
Z_MOD_HMS_PKG    = I_HMS
Z_MOD_USERID_PKG = SY-UNAME
Z_MOD_YMD        = I_YMD
Z_MOD_HMS        = I_HMS
Z_MOD_USERID     = SY-UNAME
WHERE VBELN = LST_ITEM-VBELN
AND ERDAT = I_ST_HEADER-ERDAT.

*   INSERT時（TradeCommonが存在しない場合）
ELSE.

LST_INSERT-VBELN            = LST_ITEM-VBELN.

INSERT ZTEGSDT001 FROM LST_INSERT.

ENDIF.

*   データ登録/更新に失敗した場合、メッセージを出力し処理を終了する

IF SY-SUBRC <> 0.

ROLLBACK WORK.

**** START DEL 2015/02/11 ISID11 ****
**     テーブルリリース
*      PERFORM UNLOCK_TABLE USING TD_ITEM.
**** END DEL 2015/02/11 ISID11 ****

CONCATENATE 'ZMEGSD01'
'012'
INTO LW_MSG
SEPARATED BY SPACE.

MESSAGE E012(ZMEGSD01) WITH 'ZTEGSDT001' LW_MSG.
*     データ更新に失敗しました。(TBL = &1 / MSG = &2 )

ENDIF.

ENDLOOP.

ENDFORM.                    " SAVE_EDIT_ZTEGSDT001
*&---------------------------------------------------------------------*
*&      Form  SAVE_EDIT_ZTEGSDT002
*&---------------------------------------------------------------------*
*       データ保存A（PackingList）
*----------------------------------------------------------------------*
*      -->I_ST_HEADER
*      -->I_YMD
*      -->I_HMS
*----------------------------------------------------------------------*
FORM SAVE_EDIT_ZTEGSDT002  USING I_ST_HEADER TYPE ZSEGSD0014
I_YMD TYPE SY-DATUM
I_HMS TYPE SY-UZEIT.

DATA:
LTD_ITEM   TYPE TYP_TD_ITEM,
LST_ITEM   TYPE ZSEGSD0015,
LST_INSERT TYPE ZTEGSDT002,
LTD_INSERT TYPE STANDARD TABLE OF ZTEGSDT002,
LTD_MEINS  TYPE TYP_TD_MEINS,
LST_MEINS  TYPE TYP_MEINS,
LW_MSG     TYPE SY-MSGV1.

LTD_ITEM = TD_ITEM.

SORT LTD_ITEM BY MATNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ITEM
COMPARING MATNR.

SELECT MATNR
MEINS
INTO TABLE LTD_MEINS
FROM MARA
FOR ALL ENTRIES IN LTD_ITEM
WHERE MATNR = LTD_ITEM-MATNR.

SORT LTD_MEINS BY MATNR ASCENDING.

LOOP AT TD_ITEM INTO LST_ITEM.

CLEAR LST_INSERT.

LST_INSERT-VBELN              = LST_ITEM-VBELN.
LST_INSERT-ERDAT              = I_ST_HEADER-ERDAT.
LST_INSERT-POSNR              = LST_ITEM-POSNR.
LST_INSERT-Z_PKG_POSNR_SUB    = LST_ITEM-Z_PKG_POSNR_SUB.
LST_INSERT-MATNR              = LST_ITEM-MATNR.
LST_INSERT-Z_MEINS_PACK       = LST_ITEM-Z_MEINS_PACK.
LST_INSERT-Z_LFIMG_UNIT       = LST_ITEM-Z_LFIMG_UNIT.
LST_INSERT-Z_LFIMG            = LST_ITEM-Z_LFIMG.

READ TABLE LTD_MEINS INTO LST_MEINS
WITH KEY MATNR = LST_ITEM-MATNR
BINARY SEARCH.

**** START UPD BY ISID REN 2015/07/13 ****
*    LST_INSERT-Z_VRKME            = LST_MEINS-MEINS.
LST_INSERT-Z_VRKME            = LST_ITEM-VRKME.
**** END UPD BY ISID REN 2015/07/13 ****

LST_INSERT-Z_CASENO_FROM      = LST_ITEM-Z_CASENO_FROM.
LST_INSERT-Z_CASENO_TO        = LST_ITEM-Z_CASENO_TO.
LST_INSERT-Z_CASE_COUNT       = LST_ITEM-Z_CASE_COUNT.
LST_INSERT-Z_CASE_MIX         = LST_ITEM-Z_CASE_MIX.
LST_INSERT-Z_NETWEIGHT_UNIT   = LST_ITEM-Z_NETWEIGHT_UNIT.
LST_INSERT-Z_NETWEIGHT        = LST_ITEM-Z_NETWEIGHT.
LST_INSERT-Z_GEWEI_NW         = 'KG'.
LST_INSERT-Z_GRSWEIGHT_UNIT   = LST_ITEM-Z_GRSWEIGHT_UNIT.
LST_INSERT-Z_GRSWEIGHT        = LST_ITEM-Z_GRSWEIGHT.
LST_INSERT-Z_GEWEI_GW         = 'KG'.
LST_INSERT-Z_DIMENSION        = LST_ITEM-Z_DIMENSION.

**** START ADD BY ISID17 2015/05/22 ****
LST_INSERT-Z_LENGTH           = LST_ITEM-Z_LENGTH. "Length(cm)
LST_INSERT-Z_WIDTH            = LST_ITEM-Z_WIDTH.  "Width(cm)
LST_INSERT-Z_HEIGHT           = LST_ITEM-Z_HEIGHT. "Height(cm)
**** END ADD BY ISID17 2015/05/22 ****

LST_INSERT-Z_VOLUM_UNIT       = LST_ITEM-Z_VOLUM_UNIT.
LST_INSERT-Z_VOLUM            = LST_ITEM-Z_VOLUM.
LST_INSERT-Z_VOLEH            = 'M3'.
LST_INSERT-Z_PKG_REMARKS      = LST_ITEM-Z_PKG_REMARKS.
LST_INSERT-Z_CRE_YMD          = I_YMD.
LST_INSERT-Z_CRE_HMS          = I_HMS.
LST_INSERT-Z_CRE_USERID       = SY-UNAME.

APPEND LST_INSERT TO LTD_INSERT.

CLEAR:
LST_MEINS.

ENDLOOP.

INSERT ZTEGSDT002 FROM TABLE LTD_INSERT.

* データ登録に失敗した場合、メッセージを出力し処理を終了する
IF SY-SUBRC <> 0.

ROLLBACK WORK.

**** START DEL 2015/02/11 ISID11 ****
**   テーブルリリース
*    PERFORM UNLOCK_TABLE USING TD_ITEM.
**** END DEL 2015/02/11 ISID11 ****

CONCATENATE 'ZMEGSD01'
'012'
INTO LW_MSG
SEPARATED BY SPACE.

MESSAGE E012(ZMEGSD01) WITH 'ZTEGSDT002' LW_MSG.
*   データ更新に失敗しました。(TBL = &1 / MSG = &2 )

* データ登録に成功した場合、メッセージを出力する
ELSE.

MESSAGE S013(ZMEGSD01).
*   データ登録が正常終了しました。

ENDIF.

ENDFORM.                    " SAVE_EDIT_ZTEGSDT002
*&---------------------------------------------------------------------*
*&      Form  EXIT_ALV
*&---------------------------------------------------------------------*
*       Exit判断
*----------------------------------------------------------------------*
FORM EXIT_ALV .

DATA:
LW_QUESTION TYPE CHAR72,
**** START ADD 2015/02/05 ISID11 ****
LTD_ITEM    TYPE TYP_TD_ITEM,
**** END ADD 2015/02/05 ISID11 ****
**** START ADD 2015/02/11 ISID11 ****
LST_HEADER  TYPE ZSEGSD0014,
LST_ITEM    TYPE ZSEGSD0015,
**** END ADD 2015/02/11 ISID11 ****
LW_ANSWER   TYPE CHAR1.

CLEAR:
W_ERR_FLG.

**** START ADD 2015/02/11 ISID11 ****
READ TABLE TD_HEADER INTO LST_HEADER
WITH KEY SEL = 'X'.
**** END ADD 2015/02/11 ISID11 ****

**** START UPD 2015/02/05 ISID11 ****
*  IF TD_ORIGINAL <> TD_ITEM.
LTD_ITEM = TD_ITEM.
MODIFY TABLE TD_ORIGINAL FROM LST_ITEM TRANSPORTING SEL.
MODIFY TABLE LTD_ITEM FROM LST_ITEM TRANSPORTING SEL.

IF TD_ORIGINAL <> LTD_ITEM.
**** END ADD 2015/02/05 ISID11 ****

*   終了しますか？
MESSAGE E050(ZMEGSD01) INTO LW_QUESTION.

CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TITLEBAR              = TEXT-B01
TEXT_QUESTION         = LW_QUESTION
TEXT_BUTTON_1         = TEXT-B02
TEXT_BUTTON_2         = TEXT-B03
DISPLAY_CANCEL_BUTTON = SPACE
IMPORTING
ANSWER                = LW_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND        = 1
OTHERS                = 2.
IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.

IF LW_ANSWER = '1'.

**** START ADD 2015/02/11 ISID11 ****
*     Listテーブルロックの解除
PERFORM UNLOCK_LIST USING LST_HEADER.
**** END ADD 2015/02/11 ISID11 ****

**** START ADD 2015/02/05 ISID11 ****
*     更新画面2000
PERFORM REGET_SCREEN2000.
**** END ADD 2015/02/05 ISID11 ****

LEAVE TO SCREEN 0.

ENDIF.

ELSE.

**** START ADD 2015/02/11 ISID11 ****
*     Listテーブルロックの解除
PERFORM UNLOCK_LIST USING LST_HEADER.
**** END ADD 2015/02/11 ISID11 ****

**** START ADD 2015/02/05 ISID11 ****
*   更新画面2000
PERFORM REGET_SCREEN2000.
**** END ADD 2015/02/05 ISID11 ****

LEAVE TO SCREEN 0.

ENDIF.

ENDFORM.                    " EXIT_ALV
*&---------------------------------------------------------------------*
*&      Form  GET_TEXT_DIMENSION
*&---------------------------------------------------------------------*
*       項目「Dimension Text」
*----------------------------------------------------------------------*
*      -->I_TD_ZTEGSDT002
*      <--O_TD_DIMENSION
*----------------------------------------------------------------------*
FORM GET_TEXT_DIMENSION USING I_TD_ZTEGSDT002 TYPE TYP_TD_ZTEGSDT002
CHANGING O_TD_DIMENSION TYPE TYP_TD_ZTEGSDM009.

DATA:
LTD_ZTEGSDT002 TYPE TYP_TD_ZTEGSDT002.

LTD_ZTEGSDT002 = I_TD_ZTEGSDT002.
DELETE LTD_ZTEGSDT002 WHERE Z_DIMENSION IS INITIAL.

IF LTD_ZTEGSDT002 IS INITIAL.

RETURN.

ENDIF.

SORT LTD_ZTEGSDT002 BY Z_DIMENSION ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT002
COMPARING Z_DIMENSION.

SELECT Z_TEMPLATE_ID         "テンプレートID
Z_DIMENSION_TEXT      "Dimension Text
Z_MEAS                "MEAS(M3) Per Pack
INTO TABLE O_TD_DIMENSION
FROM ZTEGSDM009
FOR ALL ENTRIES IN LTD_ZTEGSDT002
WHERE Z_TEMPLATE_ID = LTD_ZTEGSDT002-Z_DIMENSION.

SORT O_TD_DIMENSION BY Z_TEMPLATE_ID ASCENDING.

ENDFORM.                    " GET_TEXT_DIMENSION
*&---------------------------------------------------------------------*
*&      Form  CHECK_MUST_INPUT
*&---------------------------------------------------------------------*
*       必須入力チェック
*----------------------------------------------------------------------*
FORM CHECK_MUST_INPUT CHANGING O_TD_MODI TYPE LVC_T_CELL.

DATA:
LST_ITEM   TYPE ZSEGSD0015,
LW_INDEX   TYPE SY-TABIX.

LOOP AT TD_ITEM INTO LST_ITEM.
LW_INDEX = SY-TABIX.

*   Pack Unit
IF
**** START UPD BY ISID REN 2015/05/31 ****
**** START DEL BY ISID REN 2015/06/01 ****
*          LST_ITEM-Z_CASE_MIX IS INITIAL   "Mix
*      AND
**** END DEL BY ISID REN 2015/06/01 ****
**** END UPD BY ISID REN 2015/05/31 ****
LST_ITEM-Z_MEINS_PACK IS INITIAL.
*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_MEINS_PACK'
CHANGING O_TD_MODI.

**** START ADD 2015/01/30 ISID11 ****
*     必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE 'E'.
RETURN.
**** END ADD 2015/01/30 ISID11 ****
ENDIF.

IF LST_ITEM-Z_CASENO_FROM IS INITIAL.
*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_CASENO_FROM'
CHANGING O_TD_MODI.

**** START ADD 2015/01/30 ISID11 ****
*     必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE 'E'.
RETURN.
**** END ADD 2015/01/30 ISID11 ****
ENDIF.

IF LST_ITEM-Z_CASENO_TO IS INITIAL.
*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_CASENO_TO'
CHANGING O_TD_MODI.

**** START ADD 2015/01/30 ISID11 ****
*     必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE 'E'.
RETURN.
**** END ADD 2015/01/30 ISID11 ****
ENDIF.

IF
**** START UPD BY ISID REN 2015/05/31 ****
**** START DEL BY ISID REN 2015/06/01 ****
*          LST_ITEM-Z_CASE_MIX IS INITIAL   "Mix
*      AND
**** END DEL BY ISID REN 2015/06/01 ****
**** END UPD BY ISID REN 2015/05/31 ****
LST_ITEM-Z_LFIMG_UNIT IS INITIAL.

*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_LFIMG_UNIT'
CHANGING O_TD_MODI.

**** START ADD 2015/01/30 ISID11 ****
*     必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE 'E'.
RETURN.
**** END ADD 2015/01/30 ISID11 ****

ENDIF.

**** START DEL BY ISID REN 2015/06/01 ****
**   N/W(KGS) Per Pack
*    IF
**** START UPD BY ISID REN 2015/05/31 ****
**** START DEL BY ISID REN 2015/06/01 ****
*          LST_ITEM-Z_CASE_MIX IS INITIAL   "Mix
*      AND
**** END DEL BY ISID REN 2015/06/01 ****
**** END UPD BY ISID REN 2015/05/31 ****
*      LST_ITEM-Z_NETWEIGHT_UNIT IS INITIAL.
*
**     SET CURSOR
*      PERFORM SET_CURSOR USING LW_INDEX
*                               'Z_NETWEIGHT_UNIT'
*                      CHANGING O_TD_MODI.

**** START ADD 2015/01/30 ISID11 ****
**     必要な入力項目すべてに入力してください
*      MESSAGE S055(00) DISPLAY LIKE 'E'.
*      RETURN.
**** END ADD 2015/01/30 ISID11 ****
*    ENDIF.
**** END DEL BY ISID REN 2015/06/01 ****

*   G/W(KGS) Per Pack
IF
**** START ADD BY ISID REN 2015/05/31 ****
LST_ITEM-Z_CASE_MIX IS INITIAL   "Mix
AND
**** END ADD BY ISID REN 2015/05/31 ****
**** START UPD BY ISID REN 2015/06/05 ****
*      LST_ITEM-Z_GRSWEIGHT_UNIT IS INITIAL.
LST_ITEM-Z_GRSWEIGHT_UNIT = 0.
**** END UPD BY ISID REN 2015/06/05 ****

*     SET CURSOR
PERFORM SET_CURSOR USING LW_INDEX
'Z_GRSWEIGHT_UNIT'
CHANGING O_TD_MODI.
**** START ADD 2015/01/30 ISID11 ****
*     必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE 'E'.
RETURN.
**** END ADD 2015/01/30 ISID11 ****
ENDIF.

**** START DEL 2015/08/03 ISID18 ****
**** START DEL BY ISID REN 2015/05/29 ****
*    IF
***** START UPD BY ISID REN 2015/05/31 ****
*          LST_ITEM-Z_CASE_MIX IS INITIAL   "Mix
*      AND LST_ITEM-Z_LENGTH = 0            "Length(cm)
*      AND LST_ITEM-Z_WIDTH = 0             "Width(cm)
*      AND LST_ITEM-Z_HEIGHT = 0            "Height(cm)
*      AND
***** END UPD BY ISID REN 2015/05/31 ****
*      LST_ITEM-Z_DIMENSION IS INITIAL.
**     SET CURSOR
*      PERFORM SET_CURSOR USING LW_INDEX
*                               'Z_DIMENSION'
*                      CHANGING O_TD_MODI.
*
***** START ADD 2015/01/30 ISID11 ****
**     必要な入力項目すべてに入力してください
*      MESSAGE S055(00) DISPLAY LIKE 'E'.
*      RETURN.
***** END ADD 2015/01/30 ISID11 ****
*
*    ENDIF.
**** END DEL 2015/08/03 ISID18 ****
ENDLOOP.

ENDFORM.                    " CHECK_MUST_INPUT
**** START ADD 2015/02/03 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  ADJUST_CWIDTH
*&---------------------------------------------------------------------*
*       列幅の最適化
*----------------------------------------------------------------------*
FORM ADJUST_CWIDTH .

DATA:
LST_LAYOUT   TYPE LVC_S_LAYO.     "ST:LAYOUT
* ストライプ
LST_LAYOUT-ZEBRA = 'X'.
LST_LAYOUT-NO_TOOLBAR = 'X'.
LST_LAYOUT-BOX_FNAME = 'SEL'.
LST_LAYOUT-SEL_MODE  = 'D'.
**** START ADD 2015/02/05 ISID11 ****
LST_LAYOUT-NUMC_TOTAL  = 'X'.
**** END ADD 2015/02/05 ISID11 ****

* ALV コントロール: 列幅の最適化
LST_LAYOUT-CWIDTH_OPT = 'X'.
*TEST
LST_LAYOUT-STYLEFNAME  = 'STYLE'.
CALL METHOD REF_GRID->SET_FRONTEND_LAYOUT
EXPORTING
IS_LAYOUT = LST_LAYOUT.

ENDFORM.                    " ADJUST_CWIDTH
**** END ADD 2015/02/03 ISID11 ****
**** START ADD 2015/02/05 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  REGET_SCREEN2000
*&---------------------------------------------------------------------*
*       更新画面2000
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM REGET_SCREEN2000 .

FIELD-SYMBOLS:
<FS_HEADER>  TYPE ZSEGSD0014.

READ TABLE TD_HEADER ASSIGNING <FS_HEADER>
WITH KEY SEL = 'X'.

SELECT SINGLE
Z_STATUS_PACKING                 "Status
**** START ADD 2015/08/14 ISID21 ****
Z_HOLD_FLG                       "Hold Flag
**** END ADD 2015/08/14 ISID21 ****
Z_CRE_YMD_PKG    AS Z_CRE_YMD    "Create Date
Z_CRE_HMS_PKG    AS Z_CRE_HMS    "Create Time
Z_CRE_USERID_PKG AS Z_CRE_USERID "Create User
Z_MOD_YMD_PKG    AS Z_MOD_YMD    "Modify Date
Z_MOD_HMS_PKG    AS Z_MOD_HMS    "Modify Time
Z_MOD_USERID_PKG AS Z_MOD_USERID "Modify User
INTO (<FS_HEADER>-Z_STATUS_PACKING,
<FS_HEADER>-Z_HOLD_FLG,
<FS_HEADER>-Z_CRE_YMD,
<FS_HEADER>-Z_CRE_HMS,
<FS_HEADER>-Z_CRE_USERID,
<FS_HEADER>-Z_MOD_YMD,
<FS_HEADER>-Z_MOD_HMS,
<FS_HEADER>-Z_MOD_USERID)
FROM ZTEGSDT001
WHERE VBELN = <FS_HEADER>-VBELN
AND ERDAT = <FS_HEADER>-ERDAT.

CALL METHOD REF_GRID->CHECK_CHANGED_DATA.

* リフレッシュ
CALL METHOD REF_GRID->REFRESH_TABLE_DISPLAY
*    EXPORTING
*      IS_STABLE      =
*     I_SOFT_REFRESH =
EXCEPTIONS
FINISHED       = 1
OTHERS         = 2.

ENDFORM.                    " REGET_SCREEN2000
**** END ADD 2015/02/05 ISID11 ****
**** START ADD 2015/02/11 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  LOCK_LIST
*&---------------------------------------------------------------------*
*       List排他制御
*----------------------------------------------------------------------*
*      -->I_ST_HEADER  パラメータ引き渡し
*----------------------------------------------------------------------*
FORM LOCK_LIST USING I_ST_HEADER TYPE ZSEGSD0014.

* TradeCommon
CALL FUNCTION 'ENQUEUE_EZZTEGSDT001'
EXPORTING
MODE_ZTEGSDT001 = 'E'
VBELN           = I_ST_HEADER-VBELN
ERDAT           = I_ST_HEADER-ERDAT
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.

MESSAGE E080(ZMEGSD01) WITH SY-MSGV1.
*   対象の伝票は、別のユーザが編集中です。（USER = &1）

ENDIF.

ENDFORM.                    " LOCK_LIST
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_LIST
*&---------------------------------------------------------------------*
*       Listテーブルロックの解除
*----------------------------------------------------------------------*
*      -->I_ST_HEADER  パラメータ引き渡し
*----------------------------------------------------------------------*
FORM UNLOCK_LIST USING I_ST_HEADER TYPE ZSEGSD0014.

CALL FUNCTION 'DEQUEUE_EZZTEGSDT001'
EXPORTING
MODE_ZTEGSDT001 = 'E'
VBELN           = I_ST_HEADER-VBELN
ERDAT           = I_ST_HEADER-ERDAT.

ENDFORM.                    " UNLOCK_LIST
**** END ADD 2015/02/11 ISID11 ****
**** START ADD BY ISID REN 2015/05/29 ****
*&---------------------------------------------------------------------*
*&      Form  F_INITIALIZATION
*&---------------------------------------------------------------------*
*       初期設定
*----------------------------------------------------------------------*
*       無し
*----------------------------------------------------------------------*
FORM F_INITIALIZATION.
* ローカル変数定義
DATA: LT_FCAT TYPE LVC_T_FCAT,
LS_FCAT TYPE LVC_S_FCAT,
LS_STYL TYPE LVC_S_STYL.

* クリア
CLEAR TD_STYL_INI. "ALV コントロール: セル用スタイルテーブル

* FIELDCAT属性の設定
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = 'ZSEGSD0015'
CHANGING
CT_FIELDCAT            = LT_FCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

* 対象項目：「Pack Unit」「Qty Per Pack」「N/W(KGS) Per Pack」
*「G/W(KGS) Per Pack」「Dimension」「Remarks」限定
DELETE  LT_FCAT
WHERE
**** START UPD 2015/06/01 ISID11 ****
*          FIELDNAME <> 'Z_MEINS_PACK'     "Pack Unit
*      AND FIELDNAME <> 'Z_LFIMG_UNIT'     "Qty Per Pack
*      AND FIELDNAME <> 'Z_NETWEIGHT_UNIT' "N/W(KGS) Per Pack
FIELDNAME <> 'Z_LENGTH'          "Length(cm)
AND FIELDNAME <> 'Z_WIDTH'           "Width(cm)
AND FIELDNAME <> 'Z_HEIGHT'          "Height(cm)
**** END UPD 2015/06/01 ISID11 ****
AND FIELDNAME <> 'Z_GRSWEIGHT_UNIT' "G/W(KGS) Per Pack
AND FIELDNAME <> 'Z_DIMENSION'.      "Dimension
**** START DEL 2015/06/01 ISID11 ****
*      AND FIELDNAME <> 'Z_PKG_REMARKS'.   "Remarks
**** END DEL 2015/06/01 ISID11 ****

* 初期スタイルテーブル
LOOP AT LT_FCAT INTO LS_FCAT.
LS_STYL-FIELDNAME = LS_FCAT-FIELDNAME. "項目名
LS_STYL-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_ENABLED. "スタイル
LS_STYL-MAXLEN  = LS_FCAT-DD_OUTLEN.   "文字の出力長

*   桁数
INSERT LS_STYL INTO TABLE TD_STYL_INI.
ENDLOOP.

ENDFORM.                    " F_INITIALIZATION
**** END ADD BY ISID REN 2015/05/29 ****
