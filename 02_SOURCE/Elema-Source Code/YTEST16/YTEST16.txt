*----------------------------------------------------------------------*
*  プログラムＩＤ：  ZFI2020901
*  プログラム名称：  請求書発行（オンキヨー）
*  作    成    者：  ISID Pan Shunyao
*  作    成    日：  2016/02/02
*----------------------------------------------------------------------*
*  変　更　番　号：
*  変　　更　　者：
*  変　　更　　日：
*  変　更　内　容：
*----------------------------------------------------------------------*
REPORT  ZFI2020901.
************************************************************************
* CONSTANTS定義
************************************************************************
CONSTANTS:
CNS_BUK         TYPE CHAR3           VALUE 'BUK',
CNS_TVKO        TYPE CHAR4           VALUE 'TVKO',
CNS_TKA02       TYPE CHAR5           VALUE 'TKA02',
CNS_KNVV        TYPE CHAR4           VALUE 'KNVV',
CNS_X           TYPE CHAR1           VALUE 'X',
CNS_E           TYPE CHAR1           VALUE 'E',
CNS_M           TYPE CHAR1           VALUE 'M',
CNS_P           TYPE CHAR1           VALUE 'P',
CNS_S           TYPE CHAR1           VALUE 'S',
CNS_UG5         TYPE CHAR3           VALUE 'UG5',
CNS_M1          TYPE CHAR2           VALUE 'M1',
CNS_M2          TYPE CHAR2           VALUE 'M2',
CNS_03          TYPE CHAR2           VALUE '03',
CNS_CSV         TYPE CHAR4           VALUE '.CSV',
CNS_SLASH       TYPE CHAR1           VALUE '\',
CNS_ZZFI001     TYPE TDSFNAME        VALUE 'ZZFI001',
CNS_ZZFI002     TYPE TDSFNAME        VALUE 'ZZFI002',
CNS_ZZFI003     TYPE TDSFNAME        VALUE 'ZZFI003',
CNS_FUNCT_MNAME TYPE CHAR24          VALUE 'SSF_FUNCTION_MODULE_NAME',
CNS_P_FILEF     TYPE CHAR7           VALUE 'P_FILEF',
CNS_P_FILEP     TYPE CHAR7           VALUE 'P_FILEP',
CNS_P_G1_1      TYPE CHAR6           VALUE 'P_G1_1',
CNS_P_BUKRS     TYPE CHAR7           VALUE 'P_BUKRS',
CNS_P_CLOSDA    TYPE CHAR8           VALUE 'P_CLOSDA',
CNS_P_G1_2      TYPE CHAR6           VALUE 'P_G1_2',
CNS_P_PADEST    TYPE CHAR8           VALUE 'P_PADEST',
CNS_S_VKBUR_LOW TYPE CHAR11          VALUE 'S_VKBUR-LOW',
CNS_S_KUNNR_LOW TYPE CHAR11          VALUE 'S_KUNNR-LOW',
CNS_AGR_NAME    TYPE ZCAT_MA001-NAME VALUE 'AGR_NAME',
CNS_KSCHL       TYPE ZCAT_MA001-NAME VALUE 'KSCHL'.

************************************************************************
* TYPES定義
************************************************************************
TYPES:
* 汎用モジュールID
BEGIN OF TYP_FM_NAME,
FM_NAME1 TYPE RS38L_FNAM,  "汎用モジュールID（通常請求）
FM_NAME2 TYPE RS38L_FNAM,  "汎用モジュールID（帳端）
FM_NAME3 TYPE RS38L_FNAM,  "汎用モジュールID（品番別）
END OF TYP_FM_NAME,

*  BEGIN OF TYP_MESSAGET,
*
*  END OF TYP_MESSAGET,

* 販売組織
BEGIN OF TYP_TVKO,
VKORG TYPE TVKO-VKORG,  "販売組織
END OF TYP_TVKO,
TYP_TD_TVKO TYPE STANDARD TABLE OF TYP_TVKO,

* 管理領域
BEGIN OF TYP_TKA02,
KOKRS TYPE TKA02-KOKRS, "管理領域
END OF TYP_TKA02,
TYP_TD_TKA02 TYPE STANDARD TABLE OF TYP_TKA02,


* 得意先マスタ
BEGIN OF TYP_KNVV,
KUNNR TYPE KNVV-KUNNR,  "得意先コード
VKORG TYPE KNVV-VKORG,  "販売組織
VKBUR TYPE KNVV-VKBUR,  "営業所
END OF TYP_KNVV,
TYP_TD_KNVV TYPE STANDARD TABLE OF TYP_KNVV,

* 締め請求ヘッダ
BEGIN OF TYP_ISJPHD,
INVSUMNR    TYPE ISJPINVSUMHD-INVSUMNR,    "締め請求番号
INVSUMPAYER TYPE ISJPINVSUMHD-INVSUMPAYER, "締め請求支払人
END OF TYP_ISJPHD,
TYP_TD_ISJPHD TYPE STANDARD TABLE OF TYP_ISJPHD,

* 締め請求明細
BEGIN OF TYP_ISJPIT,
BELNR       TYPE ISJPINVSUMIT-BELNR,         "会計伝票番号
GJAHR       TYPE ISJPINVSUMIT-GJAHR,         "会計年度
BUZEI       TYPE ISJPINVSUMIT-BUZEI,         "会計伝票内の明細番号
INVSUMPAYER TYPE ISJPINVSUMIT-INVSUMPAYER,   "締め請求支払人
MINR        TYPE ISJPINVSUMIT-MINR,          "締め請求番号
END OF TYP_ISJPIT,
TYP_TD_ISJPIT TYPE STANDARD TABLE OF TYP_ISJPIT,

* 帳端データ
BEGIN OF TYP_BSIDAD,
KUNNR TYPE BSAD-KUNNR,   "得意先コード
GJAHR TYPE BSAD-GJAHR,   "会計年度
BELNR TYPE BSAD-BELNR,   "会計伝票番号
BUZEI TYPE BSAD-BUZEI,   "会計伝票内の明細番号
BUDAT TYPE BSAD-BUDAT,   "伝票の転記日付
BLDAT TYPE BSAD-BLDAT,   "伝票の伝票日付
ZFBDT TYPE BSAD-ZFBDT,   "支払基準日
END OF TYP_BSIDAD,
TYP_TD_BSIDAD TYPE STANDARD TABLE OF TYP_BSIDAD,

* 締め請求明細（帳端）
BEGIN OF TYP_ISJPINIT,
BELNR       TYPE ISJPINVSUMIT-BELNR,         "伝票番号
GJAHR       TYPE ISJPINVSUMIT-GJAHR,         "会計年度
BUZEI       TYPE ISJPINVSUMIT-BUZEI,         "明細
INVSUMPAYER TYPE ISJPINVSUMIT-INVSUMPAYER,   "締め請求支払人
END OF TYP_ISJPINIT,
TYP_TD_ISJPINIT TYPE STANDARD TABLE OF TYP_ISJPINIT,

* 会計伝票明細データ
BEGIN OF TYP_BSEG_IT,
BELNR TYPE BSEG-BELNR,   "伝票番号
GJAHR TYPE BSEG-GJAHR,   "会計年度
BUZEI TYPE BSEG-BUZEI,   "会計伝票内の明細番号
VBELN TYPE BSEG-VBELN,   "請求伝票
END OF TYP_BSEG_IT,
TYP_TD_BSEG_IT TYPE STANDARD TABLE OF TYP_BSEG_IT,

* 会計伝票ヘッダデータ
BEGIN OF TYP_BKPF_IT,
BELNR TYPE BKPF-BELNR,   "伝票番号
GJAHR TYPE BKPF-GJAHR,   "会計年度
END OF TYP_BKPF_IT,
TYP_TD_BKPF_IT TYPE STANDARD TABLE OF TYP_BKPF_IT,

* 請求伝票ヘッダデータ
BEGIN OF TYP_VBRK_IT,
VBELN TYPE VBRK-VBELN,   "請求伝票
KNUMV TYPE VBRK-KNUMV,   "伝票条件番号
END OF TYP_VBRK_IT,
TYP_TD_VBRK_IT TYPE STANDARD TABLE OF TYP_VBRK_IT,

* 請求伝票明細データ
BEGIN OF TYP_VBRP_IT,
VBELN TYPE VBRP-VBELN,   "請求伝票
POSNR TYPE VBRP-POSNR,   "請求明細
VGBEL TYPE VBRP-VGBEL,   "参照伝票番号
AUBEL TYPE VBRP-AUBEL,   "販売伝票
AUPOS TYPE VBRP-AUPOS,   "販売伝票明細
END OF TYP_VBRP_IT,
TYP_TD_VBRP_IT TYPE STANDARD TABLE OF TYP_VBRP_IT,

* 出荷伝票ヘッダデータ
BEGIN OF TYP_LIKP_IT,
VBELN TYPE LIKP-VBELN,   "出荷伝票
KUNNR TYPE LIKP-KUNNR,   "出荷先
END OF TYP_LIKP_IT,
TYP_TD_LIKP_IT TYPE STANDARD TABLE OF TYP_LIKP_IT,

* 伝票条件データ
BEGIN OF TYP_KONV_IT,
KNUMV TYPE KONV-KNUMV,   "伝票条件
KPOSN TYPE KONV-KPOSN,   "明細
KSCHL TYPE KONV-KSCHL,   "条件タイプ
END OF TYP_KONV_IT,
TYP_TD_KONV_IT TYPE STANDARD TABLE OF TYP_KONV_IT,

* 伝票条件番号
BEGIN OF TYP_KNUMV_POSNR,
KNUMV TYPE VBRK-KNUMV,   "伝票条件番号
POSNR TYPE VBRP-POSNR,   "請求明細
END OF TYP_KNUMV_POSNR,
TYP_TD_KNUMV_POSNR TYPE STANDARD TABLE OF TYP_KNUMV_POSNR,

* 販売伝票ビジネスデータ
BEGIN OF TYP_VBKD_IT,
VBELN TYPE VBKD-VBELN,   "販売伝票
POSNR TYPE VBKD-POSNR,   "明細
END OF TYP_VBKD_IT,
TYP_TD_VBKD_IT TYPE STANDARD TABLE OF TYP_VBKD_IT,

* 得意先マスタ(一般)データ
BEGIN OF TYP_KNA1_IT,
KUNNR TYPE KNA1-KUNNR,   "得意先コード
ADRNR TYPE KNA1-ADRNR,   "アドレス
END OF TYP_KNA1_IT,
TYP_TD_KNA1_IT TYPE STANDARD TABLE OF TYP_KNA1_IT,

* 得意先マスタ(会社)データ
BEGIN OF TYP_KNB1_IT,
KUNNR TYPE KNB1-KUNNR,   "得意先コード
END OF TYP_KNB1_IT,
TYP_TD_KNB1_IT TYPE STANDARD TABLE OF TYP_KNB1_IT,

* アドレスデータ
BEGIN OF TYP_ADRC,
ADDRNUMBER TYPE ADRC-ADDRNUMBER,  "アドレス番号
DATE_FROM  TYPE ADRC-DATE_FROM,   "開始日
END OF TYP_ADRC,
TYP_TD_ADRC TYPE STANDARD TABLE OF TYP_ADRC,

* タイトル（テキスト）
BEGIN OF TYP_TSAD3T,
TITLE      TYPE TSAD3T-TITLE,      "敬称キー
TITLE_MEDI TYPE TSAD3T-TITLE_MEDI, "タイトル (敬称)
END OF TYP_TSAD3T,
TYP_TD_TSAD3T TYPE STANDARD TABLE OF TYP_TSAD3T,

* 担当部門
BEGIN OF TYP_CEPC,
DATBI TYPE CEPC-DATBI,  "有効終了日
KOKRS TYPE CEPC-KOKRS,  "管理領域
END OF TYP_CEPC,
TYP_TD_CEPC TYPE STANDARD TABLE OF TYP_CEPC,

* 振込先銀行口座
BEGIN OF TYP_ISJPHY,
KUNNR TYPE ISJPHIERARCHY-KUNNR,  "得意先コード
END OF TYP_ISJPHY,
TYP_TD_ISJPHY TYPE STANDARD TABLE OF TYP_ISJPHY,

* 条件タイプ
TYP_RD_KSCHL TYPE RANGE OF KONV-KSCHL.

************************************************************************
* DATA定義
************************************************************************
DATA:
W_FLG_PG1  TYPE CHAR1,
W_FILE     TYPE STRING,

* 画面定義用
W_VKBUR TYPE TVBUR-VKBUR,
W_KUNNR TYPE ISJPHIERP_V-INVSUMPAYER.

************************************************************************
* FIELD-SYMBOLS定義
************************************************************************

************************************************************************
* PARAMETERS/SELECT-OPTIONS定義
************************************************************************
* 選択条件
* 会社コード
PARAMETERS P_BUKRS TYPE T001-BUKRS.

* 営業所
SELECT-OPTIONS S_VKBUR FOR W_VKBUR.

SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.



* 締め日
PARAMETERS P_CLOSDA TYPE ISJPINVSUMHD-CLOSDATE.

* 支払人
SELECT-OPTIONS S_KUNNR FOR W_KUNNR.

SELECTION-SCREEN END OF BLOCK B1.

* 帳票レイアウト
SELECTION-SCREEN BEGIN OF BLOCK B2 WITH FRAME TITLE TEXT-002.

SELECTION-SCREEN BEGIN OF LINE.
*   請求書印刷
PARAMETERS P_G1_1 RADIOBUTTON GROUP G1 DEFAULT 'X'.
SELECTION-SCREEN COMMENT 5(15)   FOR FIELD P_G1_1 .
SELECTION-SCREEN POSITION 30.
*   控えのみ
PARAMETERS P_G1_2 RADIOBUTTON GROUP G1.
SELECTION-SCREEN COMMENT 35(15)  FOR FIELD P_G1_2.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
*   帳端あり
PARAMETERS P_G2_1 RADIOBUTTON GROUP G2 DEFAULT 'X'.
SELECTION-SCREEN COMMENT 5(15)  FOR FIELD P_G2_1.
SELECTION-SCREEN POSITION 30.
*   帳端なし
PARAMETERS P_G2_2 RADIOBUTTON GROUP G2.
SELECTION-SCREEN COMMENT 35(15)  FOR FIELD P_G2_2.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
*   品番別あり
PARAMETERS P_G3_1 RADIOBUTTON GROUP G3 DEFAULT 'X'.
SELECTION-SCREEN COMMENT 5(15)  FOR FIELD P_G3_1.
SELECTION-SCREEN POSITION 30.
*   品番別なし
PARAMETERS P_G3_2 RADIOBUTTON GROUP G3.
SELECTION-SCREEN COMMENT 35(15)  FOR FIELD P_G3_2.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
*   金額訂正あり
PARAMETERS P_G4_1 RADIOBUTTON GROUP G4 DEFAULT 'X'.
SELECTION-SCREEN COMMENT 5(15)  FOR FIELD P_G4_1.
SELECTION-SCREEN POSITION 30.
*   金額訂正なし
PARAMETERS P_G4_2 RADIOBUTTON GROUP G4.
SELECTION-SCREEN COMMENT 35(15)  FOR FIELD P_G4_2.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN END OF BLOCK B2.

* 印刷
SELECTION-SCREEN BEGIN OF BLOCK B3 WITH FRAME TITLE TEXT-003.

* プリンタ名
PARAMETERS P_PADEST TYPE TSP03-PADEST.

SELECTION-SCREEN BEGIN OF LINE.
*   ダイアログなし
SELECTION-SCREEN COMMENT (31) FOR FIELD P_DIALOG.
PARAMETERS P_DIALOG AS CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN END OF BLOCK B3.

* ファイル出力
SELECTION-SCREEN BEGIN OF BLOCK B4 WITH FRAME TITLE TEXT-004.

SELECTION-SCREEN BEGIN OF LINE.
*   出力先
SELECTION-SCREEN COMMENT (10) TEXT-005.
SELECTION-SCREEN POSITION 20.
*   サーバー
PARAMETERS P_G5_1 RADIOBUTTON GROUP G5 DEFAULT 'X' USER-COMMAND UG5.
SELECTION-SCREEN COMMENT 25(10)  FOR FIELD P_G5_1.
SELECTION-SCREEN POSITION 35.
*   ローカル
PARAMETERS P_G5_2 RADIOBUTTON GROUP G5.
SELECTION-SCREEN COMMENT 40(10)  FOR FIELD P_G5_2.
SELECTION-SCREEN POSITION 50.
*   ALV
PARAMETERS P_G5_3 RADIOBUTTON GROUP G5.
SELECTION-SCREEN COMMENT 55(10)  FOR FIELD P_G5_3.
SELECTION-SCREEN END OF LINE.

* CSVファイル名
PARAMETERS P_FILEP TYPE FILEPATH-PATHINTERN MODIF ID M2.
PARAMETERS P_FILEF TYPE FILE_TABLE-FILENAME MODIF ID M1.

SELECTION-SCREEN END OF BLOCK B4.

************************************************************************
* INCLUDE定義
************************************************************************
*INCLUDE ZLG0000I001.  "汎用サブルーチン

************************************************************************
* INITIALIZATIONイベント
************************************************************************
INITIALIZATION.
* 初期処理
PERFORM PROCESS_INIT CHANGING W_FLG_PG1.

************************************************************************
* AT SELECTION-SCREENイベント
************************************************************************
AT SELECTION-SCREEN.
* CSVファイル名 変更
PERFORM CHANGE_FILE_VALUE.

CHECK SY-UCOMM <> CNS_UG5.
* 画面入力チェック
PERFORM CHECK_SCREEN CHANGING W_FILE.

AT SELECTION-SCREEN OUTPUT.
* 画面変更
PERFORM CHANGE_SCREEN USING W_FLG_PG1.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_FILEF.
* 標準 ファイルを開く
PERFORM F4_FILE.

************************************************************************
* START-OF-SELECTIONイベント
************************************************************************
START-OF-SELECTION.
* 主処理
*  PERFORM MAIN_PROCESSING USING W_FILE.

************************************************************************
* END-OF-SELECTIONイベント
************************************************************************
************************************************************************
* AT LINE-SELECTIONイベント
************************************************************************
************************************************************************
* AT USER-COMMANDイベント
************************************************************************
************************************************************************
* TOP-OF-PAGEイベント
************************************************************************
************************************************************************
* END-OF-PAGEイベント
************************************************************************

*&---------------------------------------------------------------------*
*&      Form  PROCESS_INIT
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
*      <--O_FLG_PG1        ”請求書印刷”ラジオボタンを選択不可
*----------------------------------------------------------------------*
FORM PROCESS_INIT CHANGING O_FLG_PG1 TYPE C.
* 初期化
*  CLEAR:

* ユーザパラメータBUKより初期値提案
GET PARAMETER ID CNS_BUK FIELD P_BUKRS.

* 開始メッセージを出力する
* プログラム &1 &2 が開始しました
MESSAGE S000(ZSD001) WITH SY-CPROG SY-TITLE.

* 実行ユーザチェック
PERFORM CHECK_USERS CHANGING O_FLG_PG1.
ENDFORM.                    " PROCESS_INIT
*&---------------------------------------------------------------------*
*&      Form  CHECK_USERS
*&---------------------------------------------------------------------*
*       実行ユーザチェック
*----------------------------------------------------------------------*
*      <--O_FLG_PG1        ”請求書印刷”ラジオボタンを選択不可
*----------------------------------------------------------------------*
FORM CHECK_USERS CHANGING O_FLG_PG1 TYPE C.
DATA:
LTD_ANAME TYPE STANDARD TABLE OF ZCAT_MA001-LOW,
LTH_ANAME TYPE ZCAT_MA001-LOW.

* 実行ユーザに割り当てられているロールを取得
SELECT AGR_NAME    "ロール
INTO TABLE LTD_ANAME
FROM AGR_USERS
WHERE UNAME     = SY-UNAME   "実行ユーザ
AND FROM_DAT <= SY-DATUM   "システム日付
AND TO_DAT   >= SY-DATUM.  "システム日付
IF SY-SUBRC <> 0.
CLEAR LTD_ANAME.
O_FLG_PG1 = CNS_X.
CLEAR P_G1_1.
P_G1_2 = CNS_X.
RETURN.
ELSE.
CLEAR O_FLG_PG1.
ENDIF.

* ロールがアドオン変数管理テーブルに存在するかチェック
SELECT COUNT(*)
FROM ZCAT_MA001
FOR ALL ENTRIES IN LTD_ANAME
WHERE NAME  = CNS_AGR_NAME
AND PRGNM = SY-CPROG
AND LOW   = LTD_ANAME-TABLE_LINE.
IF SY-SUBRC <> 0.
O_FLG_PG1 = CNS_X.
CLEAR P_G1_1.
P_G1_2 = CNS_X.
ELSE.
CLEAR O_FLG_PG1.
ENDIF.
ENDFORM.                    " CHECK_USERS
*&---------------------------------------------------------------------*
*&      Form  F4_FILE
*&---------------------------------------------------------------------*
*       標準 ファイルを開く
*----------------------------------------------------------------------*
FORM F4_FILE .
DATA:
LW_FOLDER TYPE STRING.
* ローカル選択時
CALL METHOD CL_GUI_FRONTEND_SERVICES=>DIRECTORY_BROWSE
CHANGING
SELECTED_FOLDER      = LW_FOLDER
EXCEPTIONS
CNTL_ERROR           = 1
ERROR_NO_GUI         = 2
NOT_SUPPORTED_BY_GUI = 3
OTHERS               = 4.
IF SY-SUBRC <> 0.
*  システムメッセージの出力
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
P_FILEF = LW_FOLDER.
ENDIF.
ENDFORM.                    " F4_FILE
*&---------------------------------------------------------------------*
*&      Form  CHANGE_FILE_VALUE
*&---------------------------------------------------------------------*
*       CSVファイル名 変更
*----------------------------------------------------------------------*
FORM CHANGE_FILE_VALUE.
IF SY-UCOMM = CNS_UG5.
CLEAR:
P_FILEP,
P_FILEF.
ENDIF.
ENDFORM.                    " CHANGE_FILE_VALUE
*&---------------------------------------------------------------------*
*&      Form  CHECK_SCREEN
*&---------------------------------------------------------------------*
*       画面入力チェック
*----------------------------------------------------------------------*
*      <--  O_FILE        CSVファイル名
*----------------------------------------------------------------------*
FORM CHECK_SCREEN CHANGING O_FILE TYPE STRING.
* 会社コードチェック
PERFORM CHECK_BUKRS.

* 営業所チェック
PERFORM CHECK_VKBUR.

* 締め日チェック
PERFORM CHECK_CLOSDATE.

* 支払人チェック
PERFORM CHECK_KUNNR.

* 帳票レイアウトの組み合わせ
PERFORM CHECK_DOCUMENT_LAYOUT.

* 出力方法指定チェック
PERFORM CHECK_OUTPUT_METHOD.

* ファイルパスチェック
PERFORM CHECK_FILEF CHANGING O_FILE.
ENDFORM.                    " CHECK_SCREEN
*&---------------------------------------------------------------------*
*&      Form  CHECK_BUKRS
*&---------------------------------------------------------------------*
*       会社コードチェック
*----------------------------------------------------------------------*
FORM CHECK_BUKRS .
* 入力必須
IF P_BUKRS IS INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     必要な入力項目すべてに入力してください
MESSAGE S055(00).
*     プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*   オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_BUKRS.
*     必要な入力項目すべてに入力してください
MESSAGE E055(00).
ENDIF.
ENDIF.

* 存在チェック
IF P_BUKRS IS NOT INITIAL.
SELECT SINGLE COUNT(*)
FROM T001
WHERE BUKRS = P_BUKRS.
IF SY-DBCNT = 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       会社コード　&　は存在しません
MESSAGE S000(ZFI001) WITH P_BUKRS.
*       プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*     オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_BUKRS.
*       会社コード　&　は存在しません
MESSAGE E000(ZFI001) WITH P_BUKRS.
ENDIF.
ENDIF.
ENDIF.

* 実行ユーザに照会権限チェック
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD P_BUKRS   "会社コード
ID 'ACTVT' FIELD CNS_03.   "アクティビティ
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     会社コード  & を使用する権限がありません
MESSAGE S012(ZFI001) WITH P_BUKRS.
*     プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*   オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_BUKRS.
*     会社コード  & を使用する権限がありません
MESSAGE E012(ZFI001) WITH P_BUKRS.
ENDIF.
ENDIF.
ENDFORM.                    " CHECK_BUKRS
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKBUR
*&---------------------------------------------------------------------*
*       営業所チェック
*----------------------------------------------------------------------*
FORM CHECK_VKBUR .
DATA:
LRH_VKBUR LIKE LINE OF S_VKBUR,
L_MSGV1   TYPE SY-MSGV1.

* 存在チェック
IF S_VKBUR IS NOT INITIAL.
SELECT SINGLE COUNT(*)
FROM TVBUR
WHERE VKBUR IN S_VKBUR.
IF SY-DBCNT = 0.

IF LINES( S_VKBUR ) = 1.
READ TABLE S_VKBUR INTO LRH_VKBUR INDEX 1.
*        IF  LRH_VKBUR-SIGN   = GCNS_SIGN_I
*        AND LRH_VKBUR-OPTION = GCNS_OPTION_EQ.
*          L_MSGV1 = LRH_VKBUR-LOW.
*        ENDIF.
ENDIF.

*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH TEXT-M01 L_MSGV1.
*       プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*     オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_S_VKBUR_LOW.
*       &1 &2 が登録されていません
MESSAGE E002(ZSD001) WITH TEXT-M01 L_MSGV1.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " CHECK_VKBUR
*&---------------------------------------------------------------------*
*&      Form  CHECK_CLOSDATE
*&---------------------------------------------------------------------*
*       締め日チェック
*----------------------------------------------------------------------*
FORM CHECK_CLOSDATE .
* 入力必須
IF P_CLOSDA IS INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     必要な入力項目すべてに入力してください
MESSAGE S055(00).
*     プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*   オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_CLOSDA.
*     必要な入力項目すべてに入力してください
MESSAGE E055(00).
ENDIF.
ENDIF.
ENDFORM.                    " CHECK_CLOSDATE
*&---------------------------------------------------------------------*
*&      Form  CHECK_KUNNR
*&---------------------------------------------------------------------*
*       支払人チェック
*----------------------------------------------------------------------*
FORM CHECK_KUNNR .
DATA:
LRH_KUNNR LIKE LINE OF S_KUNNR,
L_MSGV1   TYPE SY-MSGV1.

* 存在チェック
IF S_KUNNR IS NOT INITIAL.
SELECT COUNT(*)
UP TO 1 ROWS
FROM ISJPHIERP_V
WHERE BUKRS        = P_BUKRS
AND INVSUMPAYER IN S_KUNNR.
IF SY-DBCNT = 0.

IF LINES( S_KUNNR ) = 1.
READ TABLE S_KUNNR INTO LRH_KUNNR INDEX 1.
*        IF  LRH_KUN,
ENDIF.

*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH TEXT-M02 L_MSGV1.
*       プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*     オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_S_KUNNR_LOW.
*       &1 &2 が登録されていません
MESSAGE E002(ZSD001) WITH TEXT-M02 L_MSGV1.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " CHECK_KUNNR
*&---------------------------------------------------------------------*
*&      Form  CHECK_DOCUMENT_LAYOUT
*&---------------------------------------------------------------------*
*       帳票レイアウトの組み合わせ
*----------------------------------------------------------------------*
FORM CHECK_DOCUMENT_LAYOUT .
* 控えのみON、かつ、金額訂正なしONの場合
IF  P_G1_2 IS NOT INITIAL
AND P_G4_2 IS NOT INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     パラメータ &1 &2 と &3 &4 の組合せが不正です
MESSAGE S000(ZMM001) WITH TEXT-M03 SPACE TEXT-M04 SPACE.
*     プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*   オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_G1_2.
*     パラメータ &1 &2 と &3 &4 の組合せが不正です
MESSAGE E000(ZMM001) WITH TEXT-M03 SPACE TEXT-M04 SPACE.
ENDIF.
ENDIF.
ENDFORM.                    " CHECK_DOCUMENT_LAYOUT
*&---------------------------------------------------------------------*
*&      Form  CHECK_OUTPUT_METHOD
*&---------------------------------------------------------------------*
*       出力方法指定チェック
*----------------------------------------------------------------------*
FORM CHECK_OUTPUT_METHOD .
* プリンタ名 = ブランク AND
* 出力先 = サーバー　または　ローカル  AND
* CSVファイル名 = ブランクの場合
IF    P_PADEST IS INITIAL
AND ( P_G5_1   IS NOT INITIAL OR
P_G5_2   IS NOT INITIAL )
AND   P_FILEF  IS INITIAL
AND   P_FILEP  IS INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     出力先が未指定です。
MESSAGE S091(ZFI001).
*     プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*   オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_PADEST.
*     出力先が未指定です。
MESSAGE E091(ZFI001).
ENDIF.
ENDIF.
ENDFORM.                    " CHECK_OUTPUT_METHOD
*&---------------------------------------------------------------------*
*&      Form  CHECK_FILEF
*&---------------------------------------------------------------------*
*       ファイルパスチェック
*----------------------------------------------------------------------*
*      <--O_FILE        CSVファイル名
*----------------------------------------------------------------------*
FORM CHECK_FILEF CHANGING O_FILE TYPE STRING.
DATA:
LW_FLG_WORK TYPE ABAP_BOOL,
LW_DIRECT   TYPE STRING,
LW_FNAME    TYPE STRING,
LW_COUNT1   TYPE I.

*'"請求書発行（オンキヨー）"+<締め日(yyyymmdd)>.csv
CONCATENATE TEXT-F01 P_CLOSDA CNS_CSV INTO LW_FNAME.

CASE CNS_X.
*   サーバー
WHEN P_G5_1.
IF P_FILEP IS NOT INITIAL.
CALL FUNCTION 'FILE_GET_NAME_USING_PATH'
EXPORTING
LOGICAL_PATH               = P_FILEP
FILE_NAME                  = LW_FNAME
IMPORTING
FILE_NAME_WITH_PATH         = O_FILE
EXCEPTIONS
PATH_NOT_FOUND              = 1
MISSING_PARAMETER           = 2
OPERATING_SYSTEM_NOT_FOUND  = 3
FILE_SYSTEM_NOT_FOUND       = 4
OTHERS                      = 5.
IF SY-SUBRC <> 0.
*         バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*           指定した論理パス &1 が存在しません
MESSAGE S010(ZSD001) WITH P_FILEP.
*           プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*         オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_FILEP.
*           指定した論理パス &1 が存在しません
MESSAGE E010(ZSD001) WITH P_FILEP.
ENDIF.
ENDIF.
ENDIF.

*   ローカル
WHEN P_G5_2.
IF P_FILEF IS NOT INITIAL.
LW_DIRECT = P_FILEF.
CALL METHOD CL_GUI_FRONTEND_SERVICES=>DIRECTORY_EXIST
EXPORTING
DIRECTORY            = LW_DIRECT   " ディレクトリ名
RECEIVING
RESULT               = LW_FLG_WORK " 結果(存在する場合：'X')
EXCEPTIONS
CNTL_ERROR           = 1
ERROR_NO_GUI         = 2
WRONG_PARAMETER      = 3
NOT_SUPPORTED_BY_GUI = 4
OTHERS               = 5.
IF SY-SUBRC <> 0
OR LW_FLG_WORK IS INITIAL.
*         バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*           入力ファイルが存在しません
MESSAGE S022(ZSD001).
*           プログラム &1 &2 が異常終了しました
MESSAGE E006(ZSD001) WITH SY-CPROG SY-TITLE.
*         オンライン実行の場合
ELSE.
SET CURSOR FIELD CNS_P_FILEF.
*           入力ファイルが存在しません
MESSAGE E022(ZSD001).
ENDIF.
ELSE.
LW_COUNT1 = STRLEN( LW_DIRECT ) - 1.
IF P_FILEF+LW_COUNT1(1) <> CNS_SLASH.
CONCATENATE CNS_SLASH LW_FNAME INTO LW_FNAME.
ENDIF.
CONCATENATE LW_DIRECT LW_FNAME INTO O_FILE.
ENDIF.
ENDIF.
WHEN OTHERS.
ENDCASE.
ENDFORM.                    " CHECK_FILEF
*&---------------------------------------------------------------------*
*&      Form  CHANGE_SCREEN
*&---------------------------------------------------------------------*
*       画面変更
*----------------------------------------------------------------------*
*      -->I_FLG_PG1        ”請求書印刷”ラジオボタンを選択不可
*----------------------------------------------------------------------*
FORM CHANGE_SCREEN USING I_FLG_PG1 TYPE C.
DATA:
LW_ACTIVE1 TYPE C,
LW_ACTIVE2 TYPE C,
LW_INPUT   TYPE C.

* CSVファイル名 変更
CASE CNS_X.
WHEN P_G5_1.
LW_ACTIVE1 = 0.
LW_ACTIVE2 = 1.
WHEN P_G5_2
OR P_G5_3.
LW_ACTIVE1 = 1.
LW_ACTIVE2 = 0.
WHEN OTHERS.
ENDCASE.

* ”請求書印刷”ラジオボタン
IF I_FLG_PG1 IS NOT INITIAL.
LW_INPUT = 0.
ELSE.
LW_INPUT = 1.
ENDIF.

LOOP AT SCREEN.
*   CSVファイル名 変更
CASE SCREEN-GROUP1.
WHEN CNS_M1.
SCREEN-ACTIVE = LW_ACTIVE1.
MODIFY SCREEN.
WHEN CNS_M2.
SCREEN-ACTIVE = LW_ACTIVE2.
MODIFY SCREEN.
WHEN OTHERS.
ENDCASE.

CASE SCREEN-NAME .
*     ”請求書印刷”ラジオボタン
WHEN CNS_P_G1_1.
SCREEN-INPUT = LW_INPUT.
MODIFY SCREEN.

*     会社コード
WHEN CNS_P_BUKRS.
SCREEN-REQUIRED = 2.
MODIFY SCREEN.

*     締め日
WHEN CNS_P_CLOSDA.
SCREEN-REQUIRED = 2.
MODIFY SCREEN.

WHEN OTHERS.
ENDCASE.
ENDLOOP.
ENDFORM.                    " CHANGE_SCREEN
*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*       対象データ取得
*----------------------------------------------------------------------*
*      <--O_ST_FM_NAME        汎用モジュールID
*      <--O_TD_TVKO           販売組織
*      <--O_TD_TKA02          管理領域
*      <--O_TD_KNVV_ALL       得意先マスタ
*      <--O_TD_KNVV_1         支払人
*      <--O_TD_ISJPHD         締め請求ヘッダ
*      <--O_TD_ISJPIT         締め請求明細
*      <--O_TD_BSIDAG         帳端データ
*      <--O_TD_ISJPINIT       締め請求明細（帳端）
*      <--O_TD_BSEG_IT        会計伝票明細データ
*      <--O_TD_BSEG_INIT      会計伝票明細データ（帳端）
*      <--O_TD_BKPF_IT        会計伝票ヘッダデータ
*      <--O_TD_BKPF_INIT      会計伝票ヘッダデータ（帳端）
*      <--O_TD_VBRK_IT        請求伝票ヘッダデータ
*      <--O_TD_VBRK_INIT      請求伝票ヘッダデータ（帳端）
*      <--O_TD_VBRP_IT        請求伝票明細データ
*      <--O_TD_VBRP_INIT      請求伝票明細データ（帳端）
*      <--O_TD_LIKP_IT        出荷伝票ヘッダデータ
*      <--O_TD_LIKP_INIT      出荷伝票ヘッダデータ（帳端）
*      <--O_TD_KONV_IT        伝票条件データ
*      <--O_TD_KONV_INIT      伝票条件データ（帳端）
*      <--O_TD_VBKD_IT        販売伝票ビジネスデータ
*      <--O_TD_VBKD_INIT      販売伝票ビジネスデータ（帳端）
*      <--O_TD_KNA1_HD        得意先マスタ(一般)データ（請求括り）
*      <--O_TD_KNA1_IT        得意先マスタ(一般)データ
*      <--O_TD_KNA1_INIT      得意先マスタ(一般)データ（帳端）
*      <--O_TD_KNB1_HD        得意先マスタ(会社)データ（請求括り）
*      <--O_TD_KNB1_IT        得意先マスタ(会社)データ
*      <--O_TD_KNB1_INIT      得意先マスタ(会社)データ（帳端）
*      <--O_TD_KNVV_HD        得意先マスタ(販売エリア)データ（請求括り）
*      <--O_TD_KNVV_IT        得意先マスタ(販売エリア)データ
*      <--O_TD_KNVV_INIT      得意先マスタ(販売エリア)データ（帳端）
*      <--O_TD_ADRC           アドレスデータ
*      <--O_TD_TSAD3T         タイトル（テキスト）
*      <--O_TD_CEPC           担当部門
*      <--O_TD_ISJPHY         振込先銀行口座
*      <--O_FLG_END           終了フラグ
*----------------------------------------------------------------------*
FORM GET_DATA CHANGING O_ST_FM_NAME   TYPE TYP_FM_NAME
O_TD_TVKO      TYPE TYP_TD_TVKO
O_TD_TKA02     TYPE TYP_TD_TKA02
O_TD_KNVV_ALL  TYPE TYP_TD_KNVV
O_TD_KNVV_1    TYPE TYP_TD_KNVV
O_TD_ISJPHD    TYPE TYP_TD_ISJPHD
O_TD_ISJPIT    TYPE TYP_TD_ISJPIT
O_TD_BSIDAD    TYPE TYP_TD_BSIDAD
O_TD_ISJPINIT  TYPE TYP_TD_ISJPINIT
O_TD_BSEG_IT   TYPE TYP_TD_BSEG_IT
O_TD_BSEG_INIT TYPE TYP_TD_BSEG_IT
O_TD_BKPF_IT   TYPE TYP_TD_BKPF_IT
O_TD_BKPF_INIT TYPE TYP_TD_BKPF_IT
O_TD_VBRK_IT   TYPE TYP_TD_VBRK_IT
O_TD_VBRK_INIT TYPE TYP_TD_VBRK_IT
O_TD_VBRP_IT   TYPE TYP_TD_VBRP_IT
O_TD_VBRP_INIT TYPE TYP_TD_VBRP_IT
O_TD_LIKP_IT   TYPE TYP_TD_LIKP_IT
O_TD_LIKP_INIT TYPE TYP_TD_LIKP_IT
O_TD_KONV_IT   TYPE TYP_TD_KONV_IT
O_TD_KONV_INIT TYPE TYP_TD_KONV_IT
O_TD_VBKD_IT   TYPE TYP_TD_VBKD_IT
O_TD_VBKD_INIT TYPE TYP_TD_VBKD_IT
O_TD_KNA1_HD   TYPE TYP_TD_KNA1_IT
O_TD_KNA1_IT   TYPE TYP_TD_KNA1_IT
O_TD_KNA1_INIT TYPE TYP_TD_KNA1_IT
O_TD_KNB1_HD   TYPE TYP_TD_KNB1_IT
O_TD_KNB1_IT   TYPE TYP_TD_KNB1_IT
O_TD_KNB1_INIT TYPE TYP_TD_KNB1_IT
O_TD_KNVV_HD   TYPE TYP_TD_KNVV
O_TD_KNVV_IT   TYPE TYP_TD_KNVV
O_TD_KNVV_INIT TYPE TYP_TD_KNVV
O_TD_ADRC      TYPE TYP_TD_ADRC
O_TD_TSAD3T    TYPE TYP_TD_TSAD3T
O_TD_CEPC      TYPE TYP_TD_CEPC
O_TD_ISJPHY    TYPE TYP_TD_ISJPHY
O_FLG_END      TYPE C.
DATA:
LRD_KSCHL TYPE TYP_RD_KSCHL.

* スマートフォームの汎用モジュールIDを取得する
PERFORM GET_MODULE_NAME CHANGING O_ST_FM_NAME "汎用モジュールID
O_FLG_END.

IF O_FLG_END IS INITIAL.
*   アドオン変数管理テーブル
PERFORM GET_ADDON CHANGING LRD_KSCHL  "条件タイプ
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   販売組織取得
PERFORM GET_TVKO CHANGING O_TD_TVKO  "販売組織
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   管理領域取得
PERFORM GET_TKA02 CHANGING O_TD_TKA02 "管理領域
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   得意先マスタ取得
PERFORM GET_KNVV_01 USING O_TD_TVKO     "販売組織
CHANGING O_TD_KNVV_ALL "得意先マスタ
O_TD_KNVV_1   "支払人
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   締め請求ヘッダデータ取得
PERFORM GET_ISJPINVSUMHD USING O_TD_KNVV_1 "支払人
CHANGING O_TD_ISJPHD "締め請求ヘッダ
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   締め請求明細データ取得
PERFORM GET_ISJPINVSUMIT USING O_TD_ISJPHD "締め請求ヘッダ
CHANGING O_TD_ISJPIT "締め請求明細
O_FLG_END.
ENDIF.

IF  O_FLG_END IS INITIAL
* 【選択画面で帳端あり：ONの場合のみ】
AND P_G2_1    IS NOT INITIAL.
*   帳端データ取得
PERFORM GET_BSID_BSAD USING O_TD_KNVV_1 "支払人
O_TD_ISJPIT "締め請求明細
CHANGING O_TD_BSIDAD "帳端データ
O_FLG_END.
ENDIF.

IF  O_FLG_END IS INITIAL
* 【選択画面で帳端あり：ONの場合のみ】
AND P_G2_1    IS NOT INITIAL.
*   締め請求明細データ（帳端分）取得
PERFORM GET_ISJPINVSUMIT_BSIDAD USING O_TD_BSIDAD   "帳端データ
CHANGING O_TD_ISJPINIT "締め請求明細（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   会計伝票明細データの取得
PERFORM GET_BSEG USING O_TD_ISJPIT    "締め請求明細
O_TD_ISJPINIT  "締め請求明細（帳端）
CHANGING O_TD_BSEG_IT   "会計伝票明細データ
O_TD_BSEG_INIT "会計伝票明細データ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   会計伝票ヘッダデータの取得
PERFORM GET_BKPF USING O_TD_ISJPIT    "締め請求明細
O_TD_ISJPINIT  "締め請求明細（帳端）
CHANGING O_TD_BKPF_IT   "会計伝票ヘッダデータ
O_TD_BKPF_INIT "会計伝票ヘッダデータ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   請求伝票ヘッダデータの取得
PERFORM GET_VBRK USING O_TD_BSEG_IT   "会計伝票明細データ
O_TD_BSEG_INIT "会計伝票明細データ（帳端）
CHANGING O_TD_VBRK_IT   "請求伝票ヘッダデータ
O_TD_VBRK_INIT "請求伝票ヘッダデータ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   請求伝票明細データの取得
PERFORM GET_VBRP USING O_TD_BSEG_IT   "会計伝票明細データ
O_TD_BSEG_INIT "会計伝票明細データ（帳端）
CHANGING O_TD_VBRP_IT   "請求伝票明細データ
O_TD_VBRP_INIT "請求伝票明細データ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   出荷伝票ヘッダデータの取得
PERFORM GET_LIKP USING O_TD_VBRP_IT   "請求伝票明細データ
O_TD_VBRP_INIT "請求伝票明細データ（帳端）
CHANGING O_TD_LIKP_IT   "出荷伝票ヘッダデータ
O_TD_LIKP_INIT "出荷伝票ヘッダデータ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   伝票条件データの取得
PERFORM GET_KONV USING LRD_KSCHL      "条件タイプ
O_TD_VBRK_IT   "請求伝票ヘッダデータ
O_TD_VBRK_INIT "請求伝票ヘッダデータ（帳端）
O_TD_VBRP_IT   "請求伝票明細データ
O_TD_VBRP_INIT "請求伝票明細データ（帳端）
CHANGING O_TD_KONV_IT   "伝票条件データ
O_TD_KONV_INIT "伝票条件データ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   販売伝票ビジネスデータの取得
PERFORM GET_VBKD USING O_TD_VBRP_IT   "請求伝票明細データ
O_TD_VBRP_INIT "請求伝票明細データ（帳端）
CHANGING O_TD_VBKD_IT   "販売伝票ビジネスデータ
O_TD_VBKD_INIT "販売伝票ビジネスデータ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   得意先マスタ(一般)データ
PERFORM GET_KNA1 USING O_TD_ISJPHD    "締め請求ヘッダ
O_TD_LIKP_IT   "出荷伝票ヘッダデータ
O_TD_LIKP_INIT "出荷伝票ヘッダデータ（帳端）
CHANGING O_TD_KNA1_HD   "得意先マスタ(一般)データ（請求括り）
O_TD_KNA1_IT   "得意先マスタ(一般)データ
O_TD_KNA1_INIT "得意先マスタ(一般)データ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   得意先マスタ(会社)データ得意先マスタ(会社)データ
PERFORM GET_KNB1 USING O_TD_ISJPHD    "締め請求ヘッダ
O_TD_ISJPIT    "締め請求明細
O_TD_ISJPINIT  "締め請求明細（帳端）
CHANGING O_TD_KNB1_HD   "得意先マスタ(会社)データ（請求括り）
O_TD_KNB1_IT   "得意先マスタ(会社)データ
O_TD_KNB1_INIT "得意先マスタ(会社)データ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   得意先マスタ(販売エリア)データ
PERFORM GET_KNVV_02 USING O_TD_ISJPHD    "締め請求ヘッダ
O_TD_ISJPIT    "締め請求明細
O_TD_ISJPINIT  "締め請求明細（帳端）
O_TD_KNVV_ALL  "得意先マスタ
CHANGING O_TD_KNVV_HD   "得意先マスタ(販売エリア)データ（請求括り）
O_TD_KNVV_IT   "得意先マスタ(販売エリア)データ
O_TD_KNVV_INIT "得意先マスタ(販売エリア)データ（帳端）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   アドレスデータ
PERFORM GET_ADRC USING O_TD_KNA1_HD   "得意先マスタ(一般)データ（請求括り）
O_TD_KNA1_IT   "得意先マスタ(一般)データ
O_TD_KNA1_INIT "得意先マスタ(一般)データ（帳端）
CHANGING O_TD_ADRC      "アドレスデータ
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   タイトル（テキスト）
PERFORM GET_TSAD3T CHANGING O_TD_TSAD3T "タイトル（テキスト）
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   担当部門
PERFORM GET_CEPC USING O_TD_TKA02  "管理領域
CHANGING O_TD_CEPC   "担当部門
O_FLG_END.
ENDIF.

IF O_FLG_END IS INITIAL.
*   振込先銀行口座
PERFORM GET_ISJPHIERARCHY USING O_TD_ISJPHD "締め請求ヘッダ
CHANGING O_TD_ISJPHY "振込先銀行口座
O_FLG_END.
ENDIF.
ENDFORM.                    " GET_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_MODULE_NAME
*&---------------------------------------------------------------------*
*       スマートフォームの汎用モジュールIDを取得する
*----------------------------------------------------------------------*
*      <--O_ST_FM_NAME        汎用モジュールID
*      <--O_FLG_END           終了フラグ
*----------------------------------------------------------------------*
FORM GET_MODULE_NAME CHANGING O_ST_FM_NAME TYPE TYP_FM_NAME
O_FLG_END    TYPE C.
* 汎用モジュールID（通常請求）の取得
PERFORM GET_FUNCTON_ID USING CNS_ZZFI001
CHANGING O_ST_FM_NAME-FM_NAME1
O_FLG_END.

CHECK O_FLG_END IS INITIAL.
* 汎用モジュールID（帳端）の取得
PERFORM GET_FUNCTON_ID USING CNS_ZZFI002
CHANGING O_ST_FM_NAME-FM_NAME2
O_FLG_END.

CHECK O_FLG_END IS INITIAL.
* 汎用モジュールID（品番別）の取得
PERFORM GET_FUNCTON_ID USING CNS_ZZFI003
CHANGING O_ST_FM_NAME-FM_NAME3
O_FLG_END.
ENDFORM.                    " GET_MODULE_NAME
*&---------------------------------------------------------------------*
*&      Form  GET_FUNCTON_ID
*&---------------------------------------------------------------------*
*       汎用モジュールID（通常請求）の取得
*----------------------------------------------------------------------*
*      -->I_FORMNAME  フォーム名称
*      <--O_FM_NAME   汎用モジュールID
*      <--O_FLG_ERR   終了フラグ
*----------------------------------------------------------------------*
FORM GET_FUNCTON_ID USING I_FORMNAME TYPE C
CHANGING O_FM_NAME  TYPE RS38L_FNAM
O_FLG_ERR  TYPE C.
CALL FUNCTION 'SSF_FUNCTION_MODULE_NAME'
EXPORTING
FORMNAME           = I_FORMNAME
IMPORTING
FM_NAME            = O_FM_NAME
EXCEPTIONS
NO_FORM            = 1
NO_FUNCTION_MODULE = 2
OTHERS             = 3.
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     汎用モジュール(&1):(&2)でエラーが発生しました。システム管理者に連絡してください。
MESSAGE S000(ZCA001) WITH CNS_FUNCT_MNAME SY-SUBRC.
O_FLG_ERR = CNS_X.
*   オンライン実行の場合
ELSE.
*     汎用モジュール(&1):(&2)でエラーが発生しました。システム管理者に連絡してください。
MESSAGE S000(ZCA001) WITH CNS_FUNCT_MNAME SY-SUBRC
DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_FUNCTON_ID
*&---------------------------------------------------------------------*
*&      Form  GET_ADDON
*&---------------------------------------------------------------------*
*       アドオン変数管理テーブル
*----------------------------------------------------------------------*
*      <--O_RD_KSCHL  条件タイプ
*      <--O_FLG_END   終了フラグ
*----------------------------------------------------------------------*
FORM GET_ADDON CHANGING O_RD_KSCHL TYPE TYP_RD_KSCHL
O_FLG_END  TYPE C.
DATA:
LTD_ZCAT_MA001 TYPE STANDARD TABLE OF ZCAT_MA001,
LTH_ZCAT_MA001 TYPE ZCAT_MA001,
LRH_KSCHL      TYPE LINE OF TYP_RD_KSCHL.

SELECT *
INTO TABLE LTD_ZCAT_MA001
FROM ZCAT_MA001
WHERE PRGNM = SY-CPROG.
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 が取得できませんでした 検索キー： &2
MESSAGE S046(ZFI001) WITH TEXT-M05 SY-CPROG.
O_FLG_END = CNS_X.
*   オンライン実行の場合
ELSE.
*     &1 が取得できませんでした 検索キー： &2
MESSAGE S046(ZFI001) WITH TEXT-M05 SY-CPROG
DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

LOOP AT LTD_ZCAT_MA001 INTO LTH_ZCAT_MA001.
CASE LTH_ZCAT_MA001-NAME.
*     条件タイプ
WHEN CNS_KSCHL.
*        PERFORM GET_RANGE_LINE_COM USING LTH_ZCAT_MA001
*                                CHANGING LRH_KSCHL.
APPEND LRH_KSCHL TO O_RD_KSCHL.
WHEN OTHERS.
ENDCASE.
ENDLOOP.
ENDFORM.                    " GET_ADDON
*&---------------------------------------------------------------------*
*&      Form  GET_TVKO
*&---------------------------------------------------------------------*
*       販売組織
*----------------------------------------------------------------------*
*      <--O_TD_TVKO  販売組織
*      <--O_FLG_END  終了フラグ
*----------------------------------------------------------------------*
FORM GET_TVKO CHANGING O_TD_TVKO TYPE TYP_TD_TVKO
O_FLG_END TYPE C.
SELECT VKORG  "販売組織
INTO TABLE O_TD_TVKO
FROM TVKO
WHERE BUKRS = P_BUKRS.
IF SY-SUBRC = 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_TVKO TEXT-M06.
O_FLG_END = CNS_X.
*   オンライン実行の場合
ELSE.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_TVKO TEXT-M06
DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_TVKO
*&---------------------------------------------------------------------*
*&      Form  GET_TKA02
*&---------------------------------------------------------------------*
*       管理領域
*----------------------------------------------------------------------*
*      <--O_TD_TKA02  管理領域
*      <--O_FLG_END   終了フラグ
*----------------------------------------------------------------------*
FORM GET_TKA02  CHANGING O_TD_TKA02 TYPE TYP_TD_TKA02
O_FLG_END  TYPE C.
SELECT KOKRS  "管理領域
INTO TABLE O_TD_TKA02
FROM TKA02
WHERE BUKRS = P_BUKRS.
IF SY-SUBRC = 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_TKA02 TEXT-M07.
O_FLG_END = CNS_X.
*   オンライン実行の場合
ELSE.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_TKA02 TEXT-M07
DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_TKA02
*&---------------------------------------------------------------------*
*&      Form  GET_KNVV_01
*&---------------------------------------------------------------------*
*       得意先マスタ取得
*----------------------------------------------------------------------*
*      -->I_TD_TVKO        販売組織
*      <--O_TD_KNVV_ALL    得意先マスタ
*      <--O_TD_KNVV_1      支払人
*      <--O_FLG_END        終了フラグ
*----------------------------------------------------------------------*
FORM GET_KNVV_01 USING I_TD_TVKO     TYPE TYP_TD_TVKO
CHANGING O_TD_KNVV_ALL TYPE TYP_TD_KNVV
O_TD_KNVV_1   TYPE TYP_TD_KNVV
O_FLG_END     TYPE C.
DATA:
LTH_KNVV TYPE TYP_KNVV.

SELECT KUNNR      "支払人
VKORG      "販売組織
VKBUR      "営業所
INTO TABLE O_TD_KNVV_ALL
FROM KNVV
FOR ALL ENTRIES IN I_TD_TVKO
WHERE VKORG  = I_TD_TVKO-VKORG. "販売組織
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_KNVV TEXT-M08.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_KNVV TEXT-M08
DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

LOOP AT O_TD_KNVV_ALL INTO LTH_KNVV
WHERE KUNNR IN S_KUNNR  "営業所
AND VKBUR IN S_VKBUR. "支払人
APPEND LTH_KNVV TO O_TD_KNVV_1.
ENDLOOP.
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_KNVV TEXT-M08.
O_FLG_END = CNS_X.
*   オンライン実行の場合
ELSE.
*     &1 &2 が登録されていません
MESSAGE S002(ZSD001) WITH CNS_KNVV TEXT-M08
DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_KNVV_01
*&---------------------------------------------------------------------*
*&      Form  GET_ISJPINVSUMHD
*&---------------------------------------------------------------------*
*       締め請求ヘッダデータ取得
*----------------------------------------------------------------------*
*      -->I_TD_KNVV_1  支払人
*      <--O_TD_ISJPHD  締め請求ヘッダ
*      <--O_FLG_END    終了フラグ
*----------------------------------------------------------------------*
FORM GET_ISJPINVSUMHD USING I_TD_KNVV_1 TYPE TYP_TD_KNVV
CHANGING O_TD_ISJPHD TYPE TYP_TD_ISJPHD
O_FLG_END   TYPE C.
DATA:
LTD_KNVV TYPE TYP_TD_KNVV.
LTD_KNVV = I_TD_KNVV_1.
SORT LTD_KNVV BY KUNNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_KNVV COMPARING KUNNR.

SELECT INVSUMNR        "締め請求番号
INVSUMPAYER     "締め請求支払人
INTO TABLE O_TD_ISJPHD
FROM ISJPINVSUMHD
FOR ALL ENTRIES IN LTD_KNVV
WHERE BUKRS        = P_BUKRS           "会社コード
AND INVSUMTYPE   = CNS_M             "締め請求タイプ
AND INVSUMPAYER  = LTD_KNVV-KUNNR    "締め請求支払人
AND CLOSDATE     = P_CLOSDA          "締め日
AND CANCELLED    = SPACE.            "取消済
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     表示するデータが存在しません
MESSAGE S002(ZFI001).
O_FLG_END = CNS_X.
*   オンライン実行の場合
ELSE.
*     表示するデータが存在しません
MESSAGE S002(ZFI001) DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_ISJPINVSUMHD
*&---------------------------------------------------------------------*
*&      Form  GET_ISJPINVSUMIT
*&---------------------------------------------------------------------*
*       締め請求明細データ取得
*----------------------------------------------------------------------*
*      -->O_TD_ISJPHD  締め請求ヘッダ
*      <--O_TD_ISJPIT  締め請求明細
*      <--O_FLG_END    終了フラグ
*----------------------------------------------------------------------*
FORM GET_ISJPINVSUMIT USING O_TD_ISJPHD TYPE TYP_TD_ISJPHD
CHANGING O_TD_ISJPIT TYPE TYP_TD_ISJPIT
O_FLG_END   TYPE C.
DATA:
LTD_ISJPHD TYPE TYP_TD_ISJPHD.
SORT LTD_ISJPHD BY INVSUMNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPHD COMPARING INVSUMNR.

SELECT BELNR          "会計伝票番号
GJAHR          "会計年度
BUZEI          "会計伝票内の明細番号
INVSUMPAYER    "締め請求支払人
MINR           "月次請求書番号
INTO TABLE O_TD_ISJPIT
FROM ISJPINVSUMIT
FOR ALL ENTRIES IN LTD_ISJPHD
WHERE BUKRS    = P_BUKRS             "会社コード
AND CLOSDATE = P_CLOSDA            "締め日
AND MINR     = LTD_ISJPHD-INVSUMNR "締め請求番号
AND NOTINCL  = SPACE               "入金関連
AND MIBLOCK  = SPACE.              "請求保留
IF SY-SUBRC <> 0.
*   選択画面で帳端あり：ONの場合
IF P_G2_1 IS NOT INITIAL.
*     &1&2は存在しません
MESSAGE S088(ZFI001) WITH TEXT-M09 SPACE.

*   選択画面で帳端あり：OFFの場合
ELSE.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       表示するデータが存在しません
MESSAGE S002(ZFI001).
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       表示するデータが存在しません
MESSAGE S002(ZFI001) DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_ISJPINVSUMIT
*&---------------------------------------------------------------------*
*&      Form  GET_BSID_BSAD
*&---------------------------------------------------------------------*
*       帳端データ取得
*----------------------------------------------------------------------*
*      -->I_TD_KNVV_1  支払人
*      -->I_TD_ISJPIT  締め請求明細
*      <--O_TD_BSIDAD  帳端データ
*      <--O_FLG_END    終了フラグ
*----------------------------------------------------------------------*
FORM GET_BSID_BSAD USING I_TD_KNVV_1 TYPE TYP_TD_KNVV
I_TD_ISJPIT TYPE TYP_TD_ISJPIT
CHANGING O_TD_BSIDAD TYPE TYP_TD_BSIDAD
O_FLG_END   TYPE C.
DATA:
LTD_KNVV TYPE TYP_TD_KNVV,
L_BUDATB TYPE BSID-BUDAT,
L_BUDATE TYPE BSID-BUDAT.

* 選択画面の[締め日]の月初日
L_BUDATB      = P_CLOSDA.
L_BUDATB+6(2) = '01'.
* 選択画面の[締め日]の月末日
CALL FUNCTION 'RP_LAST_DAY_OF_MONTHS'
EXPORTING
DAY_IN            = P_CLOSDA
IMPORTING
LAST_DAY_OF_MONTH = L_BUDATE
EXCEPTIONS
DAY_IN_NO_DATE    = 1
OTHERS            = 2.
IF SY-SUBRC <> 0.
CLEAR L_BUDATE.
ENDIF.

LTD_KNVV = I_TD_KNVV_1.
SORT LTD_KNVV BY KUNNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_KNVV COMPARING KUNNR.

SELECT KUNNR    "得意先コード
GJAHR    "会計年度
BELNR    "会計伝票番号
BUZEI    "会計伝票内の明細番号
BUDAT    "伝票の転記日付
BLDAT    "伝票の伝票日付
ZFBDT    "支払基準日
INTO TABLE O_TD_BSIDAD
FROM BSID
FOR ALL ENTRIES IN LTD_KNVV
WHERE BUKRS  = P_BUKRS         "会社コード
AND KUNNR  = LTD_KNVV-KUNNR  "得意先コード
AND BUDAT >= L_BUDATB        "選択画面の[締め日]の月初日
AND BUDAT <= L_BUDATE        "選択画面の[締め日]の月末日
AND ZFBDT  > P_CLOSDA.       "選択画面の[締め日]

SELECT KUNNR    "得意先コード
GJAHR    "会計年度
BELNR    "会計伝票番号
BUZEI    "会計伝票内の明細番号
BUDAT    "伝票の転記日付
BLDAT    "伝票の伝票日付
ZFBDT    "支払基準日
APPENDING TABLE O_TD_BSIDAD
FROM BSAD
FOR ALL ENTRIES IN LTD_KNVV
WHERE BUKRS  = P_BUKRS         "会社コード
AND KUNNR  = LTD_KNVV-KUNNR  "得意先コード
AND BUDAT >= L_BUDATB        "選択画面の[締め日]の月初日
AND BUDAT <= L_BUDATE        "選択画面の[締め日]の月末日
AND ZFBDT  > P_CLOSDA.       "選択画面の[締め日]

IF O_TD_BSIDAD IS INITIAL.
*   締め請求明細が１件以上の場合
IF I_TD_ISJPIT IS NOT INITIAL.
*     &1&2は存在しません
MESSAGE S088(ZFI001) WITH TEXT-M10 SPACE.

*   締め請求明細がゼロ件の場合
ELSE.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       表示するデータが存在しません
MESSAGE S002(ZFI001).
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       表示するデータが存在しません
MESSAGE S002(ZFI001) DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_BSID_BSAD
*&---------------------------------------------------------------------*
*&      Form  GET_ISJPINVSUMIT_BSIDAD
*&---------------------------------------------------------------------*
*       締め請求明細データ（帳端分）取得
*----------------------------------------------------------------------*
*      -->I_TD_BSIDAD    帳端データ
*      <--O_TD_ISJPINIT  締め請求明細（帳端）
*      <--O_FLG_END      終了フラグ
*----------------------------------------------------------------------*
FORM GET_ISJPINVSUMIT_BSIDAD USING I_TD_BSIDAD   TYPE TYP_TD_BSIDAD
CHANGING O_TD_ISJPINIT TYPE TYP_TD_ISJPINIT
O_FLG_END     TYPE C.
IF I_TD_BSIDAD IS NOT INITIAL.
SELECT BELNR          "会計伝票番号
GJAHR          "会計年度
BUZEI          "会計伝票内の明細番号
INVSUMPAYER    "締め請求支払人
INTO TABLE O_TD_ISJPINIT
FROM ISJPINVSUMIT
FOR ALL ENTRIES IN I_TD_BSIDAD
WHERE BUKRS = P_BUKRS            "会社コード
AND BELNR = I_TD_BSIDAD-BELNR  "会計伝票番号
AND GJAHR = I_TD_BSIDAD-GJAHR  "会計年度
AND BUZEI = I_TD_BSIDAD-BUZEI. "会計伝票内の明細番号
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       表示するデータが存在しません
MESSAGE S002(ZFI001).
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       表示するデータが存在しません
MESSAGE S002(ZFI001) DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_ISJPINVSUMIT_BSIDAD
*&---------------------------------------------------------------------*
*&      Form  GET_BSEG
*&---------------------------------------------------------------------*
*       会計伝票明細データの取得
*----------------------------------------------------------------------*
*      -->I_TD_ISJPIT     締め請求明細
*      -->I_TD_ISJPINIT   締め請求明細（帳端）
*      <--O_TD_BSEG_IT    会計伝票明細データ
*      <--O_TD_BSEG_INIT  会計伝票明細データ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_BSEG USING I_TD_ISJPIT    TYPE TYP_TD_ISJPIT
I_TD_ISJPINIT  TYPE TYP_TD_ISJPINIT
CHANGING O_TD_BSEG_IT   TYPE TYP_TD_BSEG_IT
O_TD_BSEG_INIT TYPE TYP_TD_BSEG_IT
O_FLG_END      TYPE C.
DATA:
LTD_ISJPIT   TYPE TYP_TD_ISJPIT,
LTD_ISJPINIT TYPE TYP_TD_ISJPINIT.

IF I_TD_ISJPIT IS NOT INITIAL.
LTD_ISJPIT = I_TD_ISJPIT.
SORT LTD_ISJPIT BY BELNR ASCENDING
GJAHR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPIT
COMPARING BELNR
GJAHR.
*   会計伝票明細データ
SELECT BELNR  "伝票番号
GJAHR  "会計年度
BUZEI  "会計伝票内の明細番号
VBELN  "請求伝票
INTO TABLE O_TD_BSEG_IT
FROM BSEG
FOR ALL ENTRIES IN LTD_ISJPIT
WHERE BUKRS = P_BUKRS           "会社コード
AND BELNR = LTD_ISJPIT-BELNR  "伝票番号
AND GJAHR = LTD_ISJPIT-GJAHR. "会計年度
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M11.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M11 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_ISJPINIT IS NOT INITIAL.
LTD_ISJPINIT = I_TD_ISJPINIT.
SORT LTD_ISJPINIT BY BELNR ASCENDING
GJAHR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPINIT
COMPARING BELNR
GJAHR.
*   会計伝票明細データ（帳端）
SELECT BELNR  "伝票番号
GJAHR  "会計年度
BUZEI  "会計伝票内の明細番号
VBELN  "請求伝票
INTO TABLE O_TD_BSEG_INIT
FROM BSEG
FOR ALL ENTRIES IN LTD_ISJPINIT
WHERE BUKRS = P_BUKRS           "会社コード
AND BELNR = LTD_ISJPINIT-BELNR  "伝票番号
AND GJAHR = LTD_ISJPINIT-GJAHR. "会計年度
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M11.
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M11 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_BSEG
*&---------------------------------------------------------------------*
*&      Form  GET_BKPF
*&---------------------------------------------------------------------*
*       会計伝票ヘッダデータの取得
*----------------------------------------------------------------------*
*      -->I_TD_ISJPIT     締め請求明細
*      -->I_TD_ISJPINIT   締め請求明細（帳端）
*      <--O_TD_BKPF_IT    会計伝票ヘッダデータ
*      <--O_TD_BKPF_INIT  会計伝票ヘッダデータ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_BKPF USING I_TD_ISJPIT    TYPE TYP_TD_ISJPIT
I_TD_ISJPINIT  TYPE TYP_TD_ISJPINIT
CHANGING O_TD_BKPF_IT   TYPE TYP_TD_BKPF_IT
O_TD_BKPF_INIT TYPE TYP_TD_BKPF_IT
O_FLG_END      TYPE C.
DATA:
LTD_ISJPIT   TYPE TYP_TD_ISJPIT,
LTD_ISJPINIT TYPE TYP_TD_ISJPINIT.

IF I_TD_ISJPIT IS NOT INITIAL.
LTD_ISJPIT = I_TD_ISJPIT.
SORT LTD_ISJPIT BY BELNR ASCENDING
GJAHR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPIT
COMPARING BELNR
GJAHR.
*   会計伝票ヘッダデータ
SELECT BELNR  "伝票番号
GJAHR  "会計年度
INTO TABLE O_TD_BKPF_IT
FROM BKPF
FOR ALL ENTRIES IN LTD_ISJPIT
WHERE BUKRS = P_BUKRS           "会社コード
AND BELNR = LTD_ISJPIT-BELNR  "伝票番号
AND GJAHR = LTD_ISJPIT-GJAHR. "会計年度
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M12.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M12 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_ISJPINIT IS NOT INITIAL.
LTD_ISJPINIT = I_TD_ISJPINIT.
SORT LTD_ISJPINIT BY BELNR ASCENDING
GJAHR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPINIT
COMPARING BELNR
GJAHR.
*   会計伝票ヘッダデータ（帳端）
SELECT BELNR  "伝票番号
GJAHR  "会計年度
INTO TABLE O_TD_BKPF_INIT
FROM BKPF
FOR ALL ENTRIES IN LTD_ISJPINIT
WHERE BUKRS = P_BUKRS             "会社コード
AND BELNR = LTD_ISJPINIT-BELNR  "伝票番号
AND GJAHR = LTD_ISJPINIT-GJAHR. "会計年度
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M12.
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M12 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_BKPF
*&---------------------------------------------------------------------*
*&      Form  GET_VBRK
*&---------------------------------------------------------------------*
*       請求伝票ヘッダデータの取得
*----------------------------------------------------------------------*
*      -->I_TD_BSEG_IT      会計伝票明細データ
*      -->I_TD_BSEG_INIT    会計伝票明細データ（帳端）
*      <--O_TD_VBRK_IT      請求伝票ヘッダデータ
*      <--O_TD_VBRK_INIT    請求伝票ヘッダデータ（帳端）
*      <--O_FLG_END         終了フラグ
*----------------------------------------------------------------------*
FORM GET_VBRK USING I_TD_BSEG_IT   TYPE TYP_TD_BSEG_IT
I_TD_BSEG_INIT TYPE TYP_TD_BSEG_IT
CHANGING O_TD_VBRK_IT   TYPE TYP_TD_VBRK_IT
O_TD_VBRK_INIT TYPE TYP_TD_VBRK_IT
O_FLG_END      TYPE C.
DATA:
LTD_BSEG_IT   TYPE TYP_TD_BSEG_IT,
LTD_BSEG_INIT TYPE TYP_TD_BSEG_IT.

IF I_TD_BSEG_IT IS NOT INITIAL.
LTD_BSEG_IT = I_TD_BSEG_IT.
SORT LTD_BSEG_IT BY VBELN ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_BSEG_IT COMPARING VBELN.
*   請求伝票ヘッダデータ
SELECT VBELN   "請求伝票
KNUMV   "伝票条件番号
INTO TABLE O_TD_VBRK_IT
FROM VBRK
FOR ALL ENTRIES IN LTD_BSEG_IT
WHERE VBELN = LTD_BSEG_IT-VBELN.  "請求伝票
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M13.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M13 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_BSEG_INIT IS NOT INITIAL.
LTD_BSEG_INIT = I_TD_BSEG_INIT.
SORT LTD_BSEG_INIT BY VBELN ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_BSEG_INIT COMPARING VBELN.
*   請求伝票ヘッダデータ（帳端）
SELECT VBELN   "請求伝票
KNUMV   "伝票条件番号
INTO TABLE O_TD_VBRK_INIT
FROM VBRK
FOR ALL ENTRIES IN LTD_BSEG_INIT
WHERE VBELN = LTD_BSEG_INIT-VBELN.  "請求伝票
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M13.
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M13 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_VBRK
*&---------------------------------------------------------------------*
*&      Form  GET_VBRP
*&---------------------------------------------------------------------*
*       請求伝票明細データの取得
*----------------------------------------------------------------------*
*      -->I_TD_BSEG_IT    会計伝票明細データ
*      -->I_TD_BSEG_INIT  会計伝票明細データ（帳端）
*      <--O_TD_VBRP_IT    請求伝票明細データ
*      <--O_TD_VBRP_INIT  請求伝票明細データ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_VBRP USING I_TD_BSEG_IT   TYPE TYP_TD_BSEG_IT
I_TD_BSEG_INIT TYPE TYP_TD_BSEG_IT
CHANGING O_TD_VBRP_IT   TYPE TYP_TD_VBRP_IT
O_TD_VBRP_INIT TYPE TYP_TD_VBRP_IT
O_FLG_END      TYPE C.
DATA:
LTD_BSEG_IT   TYPE TYP_TD_BSEG_IT,
LTD_BSEG_INIT TYPE TYP_TD_BSEG_IT.

IF I_TD_BSEG_IT IS NOT INITIAL.
LTD_BSEG_IT = I_TD_BSEG_IT.
SORT LTD_BSEG_IT BY VBELN ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_BSEG_IT COMPARING VBELN.
*   請求伝票明細データ
SELECT VBELN    "請求伝票
POSNR    "請求明細
VGBEL    "参照伝票番号
AUBEL    "販売伝票
AUPOS    "販売伝票明細
INTO TABLE O_TD_VBRP_IT
FROM VBRP
FOR ALL ENTRIES IN LTD_BSEG_IT
WHERE VBELN = LTD_BSEG_IT-VBELN.  "請求伝票
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M14.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M14 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_BSEG_INIT IS NOT INITIAL.
LTD_BSEG_INIT = I_TD_BSEG_INIT.
SORT LTD_BSEG_INIT BY VBELN ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_BSEG_INIT COMPARING VBELN.
*   請求伝票明細データ（帳端）
SELECT VBELN    "請求伝票
POSNR    "請求明細
VGBEL    "参照伝票番号
AUBEL    "販売伝票
AUPOS    "販売伝票明細
INTO TABLE O_TD_VBRP_INIT
FROM VBRP
FOR ALL ENTRIES IN LTD_BSEG_INIT
WHERE VBELN = LTD_BSEG_INIT-VBELN.  "請求伝票
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M14.
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M14 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_VBRP
*&---------------------------------------------------------------------*
*&      Form  GET_LIKP
*&---------------------------------------------------------------------*
*       出荷伝票ヘッダデータの取得
*----------------------------------------------------------------------*
*      -->I_TD_VBRP_IT    請求伝票明細データ
*      -->I_TD_VBRP_INIT  請求伝票明細データ（帳端）
*      <--O_TD_LIKP_IT    出荷伝票ヘッダデータ
*      <--O_TD_LIKP_INIT  出荷伝票ヘッダデータ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_LIKP USING I_TD_VBRP_IT   TYPE TYP_TD_VBRP_IT
I_TD_VBRP_INIT TYPE TYP_TD_VBRP_IT
CHANGING O_TD_LIKP_IT   TYPE TYP_TD_LIKP_IT
O_TD_LIKP_INIT TYPE TYP_TD_LIKP_IT
O_FLG_END      TYPE C.
DATA:
LTD_VBRP_IT   TYPE TYP_TD_VBRP_IT,
LTD_VBRP_INIT TYPE TYP_TD_VBRP_IT.

IF I_TD_VBRP_IT IS NOT INITIAL .
LTD_VBRP_IT = I_TD_VBRP_IT.
SORT LTD_VBRP_IT BY VGBEL ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_VBRP_IT COMPARING VGBEL.
*   出荷伝票ヘッダデータ
SELECT VBELN  "出荷伝票
KUNNR  "出荷先
INTO TABLE O_TD_LIKP_IT
FROM LIKP
FOR ALL ENTRIES IN LTD_VBRP_IT
WHERE VBELN = LTD_VBRP_IT-VBELN.
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M15.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M15 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_VBRP_INIT IS NOT INITIAL.
LTD_VBRP_INIT = I_TD_VBRP_INIT.
SORT LTD_VBRP_INIT BY VGBEL ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_VBRP_INIT COMPARING VGBEL.
*   出荷伝票ヘッダデータ（帳端）
SELECT VBELN  "出荷伝票
KUNNR  "出荷先
INTO TABLE O_TD_LIKP_INIT
FROM LIKP
FOR ALL ENTRIES IN LTD_VBRP_INIT
WHERE VBELN = LTD_VBRP_INIT-VBELN.
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M15.
O_FLG_END = CNS_X.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M15 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_LIKP
*&---------------------------------------------------------------------*
*&      Form  GET_KONV
*&---------------------------------------------------------------------*
*       伝票条件データの取得
*----------------------------------------------------------------------*
*      -->I_RD_KSCHL      条件タイプ
*      -->I_TD_VBRK_IT    請求伝票ヘッダデータ
*      -->I_TD_VBRK_INIT  請求伝票ヘッダデータ（帳端）
*      -->I_TD_VBRP_IT    請求伝票明細データ
*      -->I_TD_VBRP_INIT  請求伝票明細データ（帳端）
*      <--O_TD_KONV_IT    伝票条件データ
*      <--O_TD_KONV_INIT  伝票条件データ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_KONV USING I_RD_KSCHL     TYPE TYP_RD_KSCHL
I_TD_VBRK_IT   TYPE TYP_TD_VBRK_IT
I_TD_VBRK_INIT TYPE TYP_TD_VBRK_IT
I_TD_VBRP_IT   TYPE TYP_TD_VBRP_IT
I_TD_VBRP_INIT TYPE TYP_TD_VBRP_IT
CHANGING O_TD_KONV_IT   TYPE TYP_TD_KONV_IT
O_TD_KONV_INIT TYPE TYP_TD_KONV_IT
O_FLG_END      TYPE C.
DATA:
LTH_VBRK_IT TYPE TYP_VBRK_IT,
LTH_VBRP_IT TYPE TYP_VBRP_IT,
LTD_KUNPOS  TYPE TYP_TD_KNUMV_POSNR,
LTH_KUNPOS  TYPE TYP_KNUMV_POSNR.

LOOP AT I_TD_VBRK_IT INTO LTH_VBRK_IT.
LOOP AT I_TD_VBRP_IT INTO LTH_VBRP_IT
WHERE VBELN = LTH_VBRK_IT-VBELN. "請求伝票
LTH_KUNPOS-KNUMV = LTH_VBRK_IT-KNUMV.   "伝票条件番号
LTH_KUNPOS-POSNR = LTH_VBRP_IT-POSNR.   "請求明細
APPEND LTH_KUNPOS TO LTD_KUNPOS.
ENDLOOP.
ENDLOOP.
* 伝票条件データ
IF LTD_KUNPOS IS NOT INITIAL.
SELECT KNUMV   "伝票条件
KPOSN   "明細
KSCHL   "条件タイプ
INTO TABLE O_TD_KONV_IT
FROM KONV
FOR ALL ENTRIES IN LTD_KUNPOS
WHERE KNUMV  = LTD_KUNPOS-KNUMV "伝票条件
AND KPOSN  = LTD_KUNPOS-POSNR "明細
AND KSCHL IN I_RD_KSCHL       "条件タイプ
AND KINAK  = SPACE.           "条件無効
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M16.
ENDIF.
ENDIF.
ENDIF.

CLEAR LTD_KUNPOS.
LOOP AT I_TD_VBRK_INIT INTO LTH_VBRK_IT.
LOOP AT I_TD_VBRP_INIT INTO LTH_VBRP_IT
WHERE VBELN = LTH_VBRK_IT-VBELN. "請求伝票
LTH_KUNPOS-KNUMV = LTH_VBRK_IT-KNUMV.   "伝票条件番号
LTH_KUNPOS-POSNR = LTH_VBRP_IT-POSNR.   "請求明細
APPEND LTH_KUNPOS TO LTD_KUNPOS.
ENDLOOP.
ENDLOOP.
* 伝票条件データ（帳端）
IF LTD_KUNPOS IS NOT INITIAL.
SELECT KNUMV   "伝票条件
KPOSN   "明細
KSCHL   "条件タイプ
INTO TABLE O_TD_KONV_INIT
FROM KONV
FOR ALL ENTRIES IN LTD_KUNPOS
WHERE KNUMV  = LTD_KUNPOS-KNUMV "伝票条件
AND KPOSN  = LTD_KUNPOS-POSNR "明細
AND KSCHL IN I_RD_KSCHL       "条件タイプ
AND KINAK  = SPACE.           "条件無効
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M16.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_KONV
*&---------------------------------------------------------------------*
*&      Form  GET_VBKD
*&---------------------------------------------------------------------*
*       販売伝票ビジネスデータの取得
*----------------------------------------------------------------------*
*      -->I_TD_VBRP_IT    請求伝票明細データ
*      -->I_TD_VBRP_INIT  請求伝票明細データ（帳端）
*      <--O_TD_VBKD_IT    販売伝票ビジネスデータ
*      <--O_TD_VBKD_INIT  販売伝票ビジネスデータ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_VBKD USING I_TD_VBRP_IT   TYPE TYP_TD_VBRP_IT
I_TD_VBRP_INIT TYPE TYP_TD_VBRP_IT
CHANGING O_TD_VBKD_IT   TYPE TYP_TD_VBKD_IT
O_TD_VBKD_INIT TYPE TYP_TD_VBKD_IT
O_FLG_END      TYPE C.
DATA:
LTD_VBRP TYPE TYP_TD_VBRP_IT.

IF I_TD_VBRP_IT IS NOT INITIAL.
LTD_VBRP = I_TD_VBRP_IT.
SORT LTD_VBRP BY AUBEL ASCENDING
AUPOS ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_VBRP
COMPARING AUBEL
AUPOS.
*   販売伝票ビジネスデータ
SELECT VBELN    "販売伝票
POSNR    "販売伝票明細
INTO TABLE O_TD_VBKD_IT
FROM VBKD
FOR ALL ENTRIES IN LTD_VBRP
WHERE VBELN = LTD_VBRP-AUBEL  "販売伝票
AND POSNR = LTD_VBRP-AUPOS. "販売伝票明細
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M17.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_VBRP_INIT IS NOT INITIAL.
LTD_VBRP = I_TD_VBRP_INIT.
SORT LTD_VBRP BY AUBEL ASCENDING
AUPOS ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_VBRP
COMPARING AUBEL
AUPOS.
*   販売伝票ビジネスデータ（帳端）
SELECT VBELN    "販売伝票
POSNR    "販売伝票明細
INTO TABLE O_TD_VBKD_INIT
FROM VBKD
FOR ALL ENTRIES IN LTD_VBRP
WHERE VBELN = LTD_VBRP-AUBEL  "販売伝票
AND POSNR = LTD_VBRP-AUPOS. "販売伝票明細
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M17.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_VBKD
*&---------------------------------------------------------------------*
*&      Form  GET_KNA1
*&---------------------------------------------------------------------*
*       得意先マスタ(一般)データ
*----------------------------------------------------------------------*
*      -->I_TD_ISJPHD     締め請求ヘッダ
*      -->I_TD_LIKP_IT    出荷伝票ヘッダデータ
*      -->I_TD_LIKP_INIT  出荷伝票ヘッダデータ（帳端）
*      <--O_TD_KNA1_HD    得意先マスタ(一般)データ（請求括り）
*      <--O_TD_KNA1_IT    得意先マスタ(一般)データ
*      <--O_TD_KNA1_INIT  得意先マスタ(一般)データ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_KNA1 USING I_TD_ISJPHD    TYPE TYP_TD_ISJPHD
I_TD_LIKP_IT   TYPE TYP_TD_LIKP_IT
I_TD_LIKP_INIT TYPE TYP_TD_LIKP_IT
CHANGING O_TD_KNA1_HD   TYPE TYP_TD_KNA1_IT
O_TD_KNA1_IT   TYPE TYP_TD_KNA1_IT
O_TD_KNA1_INIT TYPE TYP_TD_KNA1_IT
O_FLG_END      TYPE C.
DATA:
LTD_ISJPHD    TYPE TYP_TD_ISJPHD,
LTD_LIKP_IT   TYPE TYP_TD_LIKP_IT,
LTD_LIKP_INIT TYPE TYP_TD_LIKP_IT.

LTD_ISJPHD = I_TD_ISJPHD.
SORT LTD_ISJPHD BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPHD COMPARING INVSUMPAYER.
* 得意先マスタ(一般)データ（請求括り）
SELECT KUNNR   "得意先コード
ADRNR   "アドレス
INTO TABLE O_TD_KNA1_HD
FROM KNA1
FOR ALL ENTRIES IN LTD_ISJPHD
WHERE KUNNR = LTD_ISJPHD-INVSUMPAYER.  "締め請求支払人
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M18.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M18 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

IF I_TD_LIKP_IT IS NOT INITIAL.
LTD_LIKP_IT = I_TD_LIKP_IT.
SORT LTD_LIKP_IT BY KUNNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_LIKP_IT COMPARING KUNNR.
*   得意先マスタ(一般)データ
SELECT KUNNR   "得意先コード
ADRNR   "アドレス
INTO TABLE O_TD_KNA1_IT
FROM KNA1
FOR ALL ENTRIES IN LTD_LIKP_IT
WHERE KUNNR = LTD_LIKP_IT-KUNNR.  "出荷先
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M18.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M18 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_LIKP_INIT IS NOT INITIAL.
LTD_LIKP_INIT = I_TD_LIKP_INIT.
SORT LTD_LIKP_INIT BY KUNNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_LIKP_INIT COMPARING KUNNR.
*   得意先マスタ(一般)データ（帳端）
SELECT KUNNR   "得意先コード
ADRNR   "アドレス
INTO TABLE O_TD_KNA1_INIT
FROM KNA1
FOR ALL ENTRIES IN LTD_LIKP_INIT
WHERE KUNNR = LTD_LIKP_INIT-KUNNR.  "出荷先
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M18.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M18 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_KNA1
*&---------------------------------------------------------------------*
*&      Form  GET_KNB1
*&---------------------------------------------------------------------*
*       得意先マスタ(会社)データ得意先マスタ(会社)データ
*----------------------------------------------------------------------*
*      -->I_TD_ISJPHD     締め請求ヘッダ
*      -->I_TD_ISJPIT     締め請求明細
*      -->I_TD_ISJPINIT   締め請求明細（帳端）
*      <--O_TD_KNB1_HD    得意先マスタ(会社)データ（請求括り）
*      <--O_TD_KNB1_IT    得意先マスタ(会社)データ
*      <--O_TD_KNB1_INIT  得意先マスタ(会社)データ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_KNB1 USING I_TD_ISJPHD    TYPE TYP_TD_ISJPHD
I_TD_ISJPIT    TYPE TYP_TD_ISJPIT
I_TD_ISJPINIT  TYPE TYP_TD_ISJPINIT
CHANGING O_TD_KNB1_HD   TYPE TYP_TD_KNB1_IT
O_TD_KNB1_IT   TYPE TYP_TD_KNB1_IT
O_TD_KNB1_INIT TYPE TYP_TD_KNB1_IT
O_FLG_END      TYPE C.
DATA:
LTD_ISJPHD  TYPE TYP_TD_ISJPHD,
LTD_ISJPIT  TYPE TYP_TD_ISJPIT,
LTD_ISJPINI TYPE TYP_TD_ISJPINIT.

LTD_ISJPHD = I_TD_ISJPHD.
SORT LTD_ISJPHD BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPHD COMPARING INVSUMPAYER.
* 得意先マスタ(会社)データ（請求括り）
SELECT KUNNR   "得意先コード
INTO TABLE O_TD_KNB1_HD
FROM KNB1
FOR ALL ENTRIES IN LTD_ISJPHD
WHERE KUNNR = LTD_ISJPHD-INVSUMPAYER   "締め請求支払人
AND BUKRS = P_BUKRS.                 "会社コード
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M19.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M19 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

IF I_TD_ISJPIT IS NOT INITIAL.
LTD_ISJPIT = I_TD_ISJPIT.
SORT LTD_ISJPIT BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPIT COMPARING INVSUMPAYER.
*   得意先マスタ(会社)データ
SELECT KUNNR   "得意先コード
INTO TABLE O_TD_KNB1_IT
FROM KNB1
FOR ALL ENTRIES IN LTD_ISJPIT
WHERE KUNNR = LTD_ISJPIT-INVSUMPAYER   "締め請求支払人
AND BUKRS = P_BUKRS.                 "会社コード
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M19.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M19 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.

IF I_TD_ISJPINIT IS NOT INITIAL.
LTD_ISJPINI = I_TD_ISJPINIT.
SORT LTD_ISJPINI BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPINI COMPARING INVSUMPAYER.
*   得意先マスタ(会社)データ（帳端）
SELECT KUNNR   "得意先コード
INTO TABLE O_TD_KNB1_INIT
FROM KNB1
FOR ALL ENTRIES IN LTD_ISJPINI
WHERE KUNNR = LTD_ISJPINI-INVSUMPAYER   "締め請求支払人
AND BUKRS = P_BUKRS.                  "会社コード
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M19.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M19 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_KNB1
*&---------------------------------------------------------------------*
*&      Form  GET_KNVV_02
*&---------------------------------------------------------------------*
*       得意先マスタ(販売エリア)データ
*----------------------------------------------------------------------*
*      -->I_TD_ISJPHD     締め請求ヘッダ
*      -->I_TD_ISJPIT     締め請求明細
*      -->I_TD_ISJPINIT   締め請求明細（帳端）
*      <--O_TD_KNVV_HD    得意先マスタ(販売エリア)データ（請求括り）
*      <--O_TD_KNVV_IT    得意先マスタ(販売エリア)データ
*      <--O_TD_KNVV_INIT  得意先マスタ(販売エリア)データ（帳端）
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_KNVV_02 USING I_TD_ISJPHD    TYPE TYP_TD_ISJPHD
I_TD_ISJPIT    TYPE TYP_TD_ISJPIT
I_TD_ISJPINIT  TYPE TYP_TD_ISJPINIT
I_TD_KNVV_ALL  TYPE TYP_TD_KNVV
CHANGING O_TD_KNVV_HD   TYPE TYP_TD_KNVV
O_TD_KNVV_IT   TYPE TYP_TD_KNVV
O_TD_KNVV_INIT TYPE TYP_TD_KNVV
O_FLG_END      TYPE C.

DATA:
LTD_ISJPHD   TYPE TYP_TD_ISJPHD,
LTD_ISJPIT   TYPE TYP_TD_ISJPIT,
LTD_ISJPINI  TYPE TYP_TD_ISJPINIT,
LTH_KNVV_ALL TYPE TYP_KNVV.

LTD_ISJPHD = I_TD_ISJPHD.
SORT LTD_ISJPHD BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPHD COMPARING INVSUMPAYER.

LTD_ISJPIT = I_TD_ISJPIT.
SORT LTD_ISJPIT BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPIT COMPARING INVSUMPAYER.

LTD_ISJPINI = I_TD_ISJPINIT.
SORT LTD_ISJPINI BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPINI COMPARING INVSUMPAYER.

LOOP AT I_TD_KNVV_ALL INTO LTH_KNVV_ALL.
*   得意先マスタ(販売エリア)データ（請求括り）
READ TABLE LTD_ISJPHD TRANSPORTING NO FIELDS
WITH KEY INVSUMPAYER = LTH_KNVV_ALL-KUNNR
BINARY SEARCH .
IF SY-SUBRC = 0.
APPEND LTH_KNVV_ALL TO O_TD_KNVV_HD.
ENDIF.

*   得意先マスタ(販売エリア)データ
READ TABLE LTD_ISJPIT TRANSPORTING NO FIELDS
WITH KEY INVSUMPAYER = LTH_KNVV_ALL-KUNNR
BINARY SEARCH .
IF SY-SUBRC = 0.
APPEND LTH_KNVV_ALL TO O_TD_KNVV_IT.
ENDIF.

*   得意先マスタ(販売エリア)データ（帳端）
READ TABLE LTD_ISJPINI TRANSPORTING NO FIELDS
WITH KEY INVSUMPAYER = LTH_KNVV_ALL-KUNNR
BINARY SEARCH .
IF SY-SUBRC = 0.
APPEND LTH_KNVV_ALL TO O_TD_KNVV_INIT.
ENDIF.
ENDLOOP.

IF O_TD_KNVV_HD IS INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M20.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M20 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

IF  I_TD_ISJPIT  IS NOT INITIAL
AND O_TD_KNVV_IT IS INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M20.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M20 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.

IF  I_TD_ISJPINIT  IS NOT INITIAL
AND O_TD_KNVV_INIT IS INITIAL.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M20.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M20 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_KNVV_02
*&---------------------------------------------------------------------*
*&      Form  GET_ADRC
*&---------------------------------------------------------------------*
*       アドレスデータ
*----------------------------------------------------------------------*
*      -->I_TD_KNA1_HD    得意先マスタ(販売エリア)データ（請求括り）
*      -->I_TD_KNA1_IT    得意先マスタ(販売エリア)データ
*      -->I_TD_KNA1_INIT  得意先マスタ(販売エリア)データ（帳端）
*      <--O_TD_ADRC       アドレスデータ
*      <--O_FLG_END       終了フラグ
*----------------------------------------------------------------------*
FORM GET_ADRC USING I_TD_KNA1_HD   TYPE TYP_TD_KNA1_IT
I_TD_KNA1_IT   TYPE TYP_TD_KNA1_IT
I_TD_KNA1_INIT TYPE TYP_TD_KNA1_IT
CHANGING O_TD_ADRC      TYPE TYP_TD_ADRC
O_FLG_END      TYPE C.
DATA:
LTD_KNA1 TYPE TYP_TD_KNA1_IT.

APPEND LINES OF I_TD_KNA1_HD   TO LTD_KNA1.
APPEND LINES OF I_TD_KNA1_IT   TO LTD_KNA1.
APPEND LINES OF I_TD_KNA1_INIT TO LTD_KNA1.
SORT LTD_KNA1 BY ADRNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_KNA1 COMPARING ADRNR.

IF LTD_KNA1 IS NOT INITIAL.
SELECT ADDRNUMBER    "アドレス番号
DATE_FROM     "開始日
INTO TABLE O_TD_ADRC
FROM ADRC
FOR ALL ENTRIES IN LTD_KNA1
WHERE ADDRNUMBER = LTD_KNA1-ADRNR "アドレス番号
AND DATE_FROM <= P_CLOSDA       "締め日
AND NATION     = SPACE.         "アドレスVersion
IF SY-SUBRC <> 0.
*     バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M21.
O_FLG_END = CNS_X.
RETURN.
*     オンライン実行の場合
ELSE.
*       &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M21 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDIF.
ENDFORM.                    " GET_ADRC
*&---------------------------------------------------------------------*
*&      Form  GET_TSAD3T
*&---------------------------------------------------------------------*
*       タイトル（テキスト）
*----------------------------------------------------------------------*
*      <--O_TD_TSAD3T  タイトル（テキスト）
*      <--O_FLG_END    終了フラグ
*----------------------------------------------------------------------*
FORM GET_TSAD3T CHANGING O_TD_TSAD3T TYPE TYP_TD_TSAD3T
O_FLG_END   TYPE C.
SELECT TITLE       "敬称キー
TITLE_MEDI  "タイトル (敬称)
INTO TABLE O_TD_TSAD3T
FROM TSAD3T
WHERE LANGU = SY-LANGU.  "ログオン言語
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 が取得できませんでした 検索キー： &2
MESSAGE S046(ZFI001) WITH TEXT-M22 SY-LANGU.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S046(ZFI001) WITH TEXT-M22 SY-LANGU DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_TSAD3T
*&---------------------------------------------------------------------*
*&      Form  GET_CEPC
*&---------------------------------------------------------------------*
*       担当部門
*----------------------------------------------------------------------*
*      -->I_TD_TKA02  管理領域
*      <--O_TD_CEPC   担当部門
*      <--O_FLG_END   終了フラグ
*----------------------------------------------------------------------*
FORM GET_CEPC USING I_TD_TKA02 TYPE TYP_TD_TKA02
CHANGING O_TD_CEPC  TYPE TYP_TD_CEPC
O_FLG_END  TYPE C.
DATA:
L_KOKRS   TYPE TKA02-KOKRS,
LTH_TKA02 TYPE TYP_TKA02.

SELECT DATBI   "有効終了日
KOKRS   "管理領域
INTO TABLE O_TD_CEPC
FROM CEPC
FOR ALL ENTRIES IN I_TD_TKA02
WHERE DATBI >= P_CLOSDA          "締め日
AND KOKRS  = I_TD_TKA02-KOKRS. "管理領域
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.

IF LINES( I_TD_TKA02 ) = 1.
READ TABLE I_TD_TKA02 INTO LTH_TKA02 INDEX 1.
L_KOKRS = LTH_TKA02-KOKRS.
ENDIF.

*     &1 が取得できませんでした 検索キー： &2
MESSAGE S046(ZFI001) WITH TEXT-M23 L_KOKRS.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S046(ZFI001) WITH TEXT-M23 L_KOKRS DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_CEPC
*&---------------------------------------------------------------------*
*&      Form  GET_ISJPHIERARCHY
*&---------------------------------------------------------------------*
*       振込先銀行口座
*----------------------------------------------------------------------*
*      -->I_TD_ISJPHD  締め請求ヘッダ
*      <--O_TD_ISJPHY  振込先銀行口座
*      <--O_FLG_END    終了フラグ
*----------------------------------------------------------------------*
FORM GET_ISJPHIERARCHY USING I_TD_ISJPHD TYPE TYP_TD_ISJPHD
CHANGING O_TD_ISJPHY TYPE TYP_TD_ISJPHY
O_FLG_END   TYPE C.
DATA:
LTD_ISJPHD TYPE TYP_TD_ISJPHD.

LTD_ISJPHD = I_TD_ISJPHD.
SORT LTD_ISJPHD BY INVSUMPAYER ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_ISJPHD COMPARING INVSUMPAYER.

* 振込先銀行口座
SELECT KUNNR      "得意先コード
INTO TABLE O_TD_ISJPHY
FROM ISJPHIERARCHY
FOR ALL ENTRIES IN LTD_ISJPHD
WHERE BUKRS = P_BUKRS                  "会社コード
AND KUNNR = LTD_ISJPHD-INVSUMPAYER.  "得意先コード
IF SY-SUBRC <> 0.
*   バックグラウンド実行の場合
IF SY-BATCH = CNS_X.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M24.
O_FLG_END = CNS_X.
RETURN.
*   オンライン実行の場合
ELSE.
*     &1 を取得できませんでした
MESSAGE S040(ZSD001) WITH TEXT-M24 DISPLAY LIKE CNS_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
ENDFORM.                    " GET_ISJPHIERARCHY
*&---------------------------------------------------------------------*
*&      Form  EIDT_DATA
*&---------------------------------------------------------------------*
*       請求書データ編集および出力
*----------------------------------------------------------------------*
*      -->I_XXX  XXX
*      <--O_XXX  XXX
*----------------------------------------------------------------------*
FORM EIDT_DATA .

ENDFORM.                    " EIDT_DATA
