REPORT ZM012300 MESSAGE-ID Z1 .

TABLES : LIKP ,
LIPS ,
ZS0020 ,
VBUP .

DATA : T_ZS0020 TYPE TABLE OF ZS0020 ,
U_ZS0020 TYPE TABLE OF ZS0020 ,
W_ZS0020 TYPE ZS0020 ,
W_COUNT  TYPE I .

SELECT-OPTIONS : S_WERKS FOR LIPS-WERKS ,
S_LFART FOR LIKP-LFART .


START-OF-SELECTION .

PERFORM INIT_SEC .
PERFORM DATA_GET .
PERFORM DATA_SUM .
PERFORM DATA_SET .
DESCRIBE TABLE T_ZS0020 LINES W_COUNT .
MESSAGE S618 WITH W_COUNT .

* 初期処理
FORM INIT_SEC .
REFRESH : T_ZS0020 .
CLEAR : W_ZS0020 .
ENDFORM .

* データ取得
FORM DATA_GET .
SELECT P~MATNR SUM( P~LFIMG ) P~VRKME P~WERKS
FROM LIKP AS K
INNER JOIN LIPS AS P
ON  K~VBELN EQ P~VBELN
INNER JOIN VBUP AS U
ON  U~VBELN EQ K~VBELN
AND  U~POSNR EQ P~POSNR
INTO (W_ZS0020-MATNR ,
W_ZS0020-LFIMG ,
W_ZS0020-VRKME ,
W_ZS0020-WERKS)
WHERE P~WERKS IN S_WERKS
AND  K~LFART IN S_LFART
AND  U~WBSTA NE 'C'
GROUP BY P~MATNR P~WERKS P~VRKME
.
APPEND W_ZS0020 TO T_ZS0020 .
CLEAR : W_ZS0020 .
ENDSELECT .
ENDFORM .

* 数量を基本単位数量に変換し集計
FORM DATA_SUM .
DATA:  LW_MEINS LIKE MARA-MEINS .
CLEAR: W_ZS0020.

LOOP AT T_ZS0020 INTO W_ZS0020 .

* 品目マスタの販売単位を取得
SELECT SINGLE MEINS
FROM MARA
INTO LW_MEINS
WHERE MATNR = W_ZS0020-MATNR .

* 数量変換処理
IF W_ZS0020-VRKME <> LW_MEINS .
CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR              = W_ZS0020-MATNR
I_IN_ME              = W_ZS0020-VRKME
I_OUT_ME             = LW_MEINS
I_MENGE              = W_ZS0020-LFIMG
IMPORTING
E_MENGE              = W_ZS0020-LFIMG
EXCEPTIONS
ERROR_IN_APPLICATION = 1
ERROR                = 2
OTHERS               = 3.

W_ZS0020-VRKME = LW_MEINS .
ENDIF.
COLLECT W_ZS0020 INTO U_ZS0020 .
CLEAR:  W_ZS0020 .
ENDLOOP .
ENDFORM.

* データ更新
FORM DATA_SET .
*2009/03/26 MOD_START
*  DELETE FROM ZS0020 CLIENT SPECIFIED WHERE MANDT EQ SY-MANDT  .
DELETE FROM ZS0020 CLIENT SPECIFIED WHERE MANDT EQ SY-MANDT
AND WERKS IN S_WERKS .
*2009/03/26 MOD_END
INSERT ZS0020 FROM TABLE U_ZS0020 .
ENDFORM .
