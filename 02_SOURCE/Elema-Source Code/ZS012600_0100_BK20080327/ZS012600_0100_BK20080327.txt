*----------------------------------------------------------------------*
*   INCLUDE ZS012600_0100                                              *
*----------------------------------------------------------------------*
TYPES: BEGIN OF TYP_ALV_0100.
INCLUDE STRUCTURE ZSLIST_V21.
TYPES:   STYLES TYPE LVC_T_STYL,
UEPOS  TYPE VBAP-UEPOS,
END OF TYP_ALV_0100.

TYPES: TYP_T_ALV_0100 TYPE STANDARD TABLE OF TYP_ALV_0100.

TYPES: BEGIN OF TYP_PICKING_LIST,
KUNNR(10)	TYPE C,	" 得意先コード
KNAME(35)	TYPE C,	" 得意先名
EDATU(8)	TYPE C,	" 希望納期
BSTNK(23)	TYPE C,	" 得意先発注番号
ZAI(1)	TYPE C,	" 在
MATNR(18)	TYPE C,	" 品目コード
ARKTX(40)	TYPE C,	" 品名
LGPBE(10)	TYPE C,	" 棚番
NUMMS(12)	TYPE C,	" 未出荷数量
NUMSC(12)	TYPE C,	" 送信数量
VBELN(10)	TYPE C,	" 受注番号
POSNR(6)	TYPE C,	" 受注明細番号
ETC(40)	TYPE C,	" 出荷指示備考
LTX01(40)	TYPE C,	" 得意先品目テキスト
AUART(4)	TYPE C,	" 伝票タイプ
ZS01(2)	TYPE C,	" 納品書種別
KDMAT(35)	TYPE C,	" 得意先品目コード
VNETPR(15)	TYPE C,	" 受注単価_小数点4桁
NETWR(15)	TYPE C,	" 受注金額
WAERK(3)	TYPE C,	" 通貨コード
EBELN(10)	TYPE C,	" 発注番号
VRKME(3)	TYPE C,	" 数量単位
WAVWR(15)	TYPE C,	" 原価.
YUSOUTOU(40) TYPE C,	" 輸送手段等
MENGE(11)	TYPE C,	" 発注数量
MEINS(3)    TYPE C,      " 発注単位
HERKL(3)	TYPE C,	" 原産地
STAWN(17)	TYPE C,	" HS-CODE
SYOHIN(40)	TYPE C,	" 商品名
SEIHIN(40)	TYPE C,	" 製品
PRAT1(1)	TYPE C,	" 危険品区分
STOFF(18)	TYPE C,	" 危険物コード
PRAT2(1)	TYPE C,	" 非該当
NTGEW(13)   TYPE C,      " 単重量
WARES_EU(3)	TYPE C,      " 仲介通貨コード
KWERT_EU(15) TYPE C,	" 仲介単価
KUNNR_EU(10) TYPE C,	" エンドユーザコード
KNAME_EU(35) TYPE C,	" エンドユーザ名
MUSYO(1)	TYPE C,	" 無償支給区分
ASNNO(20)	TYPE C,	" ASN番号
SENDID(12)	TYPE C,	" 送信ID
END OF TYP_PICKING_LIST.

TYPES: TYP_T_PICKING_LIST TYPE STANDARD TABLE OF TYP_PICKING_LIST.

DATA : G_FLG_EU     TYPE C.

* ADD-BEG DM00151 DMC 2008/02/26（そのうち削除する）
DATA : G_CHAR_YUSOU(40) TYPE C,
G_CHAR_TMP(100)  TYPE C,
G_CHAR_LEN       TYPE I.
* ADD-END DM00151 DMC 2008/02/26
* ADD-BEG DM00155 DMC 2008/02/26
DATA : G_NUMSC_TMP TYPE ZSLIST_V21-NUMSC.  "販売数量単位変換用
* ADD-END DM00155 DMC 2008/02/26
*----------------------------------------------------------------------*
*       CLASS CLS_EVENT_RECIEVER DEFINITION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS CLS_ALV_HANDLER_0100 DEFINITION.
PUBLIC SECTION.
METHODS HANDLE_DATA_CHANGED
FOR EVENT DATA_CHANGED OF CL_GUI_ALV_GRID
IMPORTING ER_DATA_CHANGED.
METHODS HANDLE_DATA_CHANGED_FINISHED
FOR EVENT DATA_CHANGED_FINISHED OF CL_GUI_ALV_GRID
IMPORTING E_MODIFIED.
ENDCLASS.                    "CLS_EVENT_RECIEVER DEFINITION

*----------------------------------------------------------------------*
*       CLASS CLS_EVENT_RECIEVER IMPLEMENTATION
*----------------------------------------------------------------------*
*
*----------------------------------------------------------------------*
CLASS CLS_ALV_HANDLER_0100 IMPLEMENTATION.
METHOD HANDLE_DATA_CHANGED.
PERFORM CHECK_ALV_INPUT_0100 USING ER_DATA_CHANGED.
ENDMETHOD.                    "HANDLE_DATA_CHANGED
METHOD HANDLE_DATA_CHANGED_FINISHED.
PERFORM CHANGE_ALV_DATA_0100 USING E_MODIFIED.
ENDMETHOD.                    "HANDLE_DATA_CHANGED_FINISHED
ENDCLASS.                    "CLS_EVENT_RECIEVER IMPLEMENTATION

* OK CODE
CONSTANTS: CNS_OK_CODE_TRANSMIT TYPE SY-UCOMM VALUE 'ZUTL'. " 送信

DATA: GT_ALV_0100 TYPE TYP_T_ALV_0100.
DATA: OBJ_ALV_HANDLER_0100 TYPE REF TO CLS_ALV_HANDLER_0100.

DATA: GT_FILE_LIST TYPE STANDARD TABLE OF RLGRAP-FILENAME.

DATA: GT_ALV_0100_WK TYPE TYP_T_ALV_0100.
*&---------------------------------------------------------------------*
*&      Module  STATUS_0100  OUTPUT
*&---------------------------------------------------------------------*
*       ステータス設定
*----------------------------------------------------------------------*
MODULE STATUS_0100 OUTPUT.

SET PF-STATUS '0100'.
SET TITLEBAR '0100'.

ENDMODULE.                 " STATUS_0100  OUTPUT
*&---------------------------------------------------------------------*
*&      Module  EXIT_0100  INPUT
*&---------------------------------------------------------------------*
*       EXIT
*----------------------------------------------------------------------*
MODULE EXIT_0100 INPUT.

PERFORM UNLOCK_OBJECT.
PERFORM BACK_TO_FIRST_SCREEN.

ENDMODULE.                 " EXIT_0100  INPUT
*&---------------------------------------------------------------------*
*&      Module  INITIALIZE_0100  OUTPUT
*&---------------------------------------------------------------------*
*       初期化
*----------------------------------------------------------------------*
MODULE INITIALIZE_0100 OUTPUT.

IF OBJ_GRID IS INITIAL.
*    CREATE OBJECT OBJ_CUSTOM_CONTAINER
*      EXPORTING
*        CONTAINER_NAME    = 'ALV_CONTAINER_0100'.
*    CREATE OBJECT OBJ_SPLITTER_CONTAINER
*      EXPORTING
*        PARENT    = OBJ_CUSTOM_CONTAINER
*        SASH_POSITION      = 100
*        WITH_BORDER  = 0.
CREATE OBJECT OBJ_SPLITTER_CONTAINER
EXPORTING
PARENT    = CL_GUI_CONTAINER=>DEFAULT_SCREEN
SASH_POSITION      = 100
WITH_BORDER  = 0.
PERFORM SET_T_ALV_FIELDCAT_0100.
PERFORM SET_T_ALV_0100.
PERFORM SET_ALV_LAYOUT_0100.
PERFORM SET_ALV_VARIANT_0100.
PERFORM SET_ALV_TOOLBAR_0100.
PERFORM SET_T_ALV_ROID_0100.
CREATE OBJECT OBJ_GRID
EXPORTING
I_PARENT       = OBJ_SPLITTER_CONTAINER->TOP_LEFT_CONTAINER
I_APPLOGPARENT = OBJ_SPLITTER_CONTAINER->BOTTOM_RIGHT_CONTAINER.
CREATE OBJECT OBJ_ALV_HANDLER_0100.
SET HANDLER
OBJ_ALV_HANDLER_0100->HANDLE_DATA_CHANGED
OBJ_ALV_HANDLER_0100->HANDLE_DATA_CHANGED_FINISHED
FOR OBJ_GRID.
CALL METHOD OBJ_GRID->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_ENTER.
*   ALV初期表示
CALL METHOD OBJ_GRID->SET_TABLE_FOR_FIRST_DISPLAY
EXPORTING
IS_VARIANT           = GF_ALV_VARIANT
IS_LAYOUT            = GF_ALV_LAYOUT
IT_TOOLBAR_EXCLUDING = GT_ALV_FUNCTION
I_SAVE               = 'A'
CHANGING
IT_OUTTAB            = GT_ALV_0100
IT_FIELDCATALOG      = GT_ALV_FIELDCAT.
CALL METHOD CL_GUI_CFW=>FLUSH.
ENDIF.

ENDMODULE.                 " INITIALIZE_0100  OUTPUT
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_0100
*&---------------------------------------------------------------------*
*       未受信リスト内部テーブル設定
*----------------------------------------------------------------------*
FORM SET_T_ALV_0100.

CASE G_ORDER_TYPE.
*   通常出荷
WHEN CNS_ORDER_TYPE_NORMAL.
*     ALVデータ設定処理
PERFORM SET_T_ALV_0100_NORMAL.
*   無償支給
WHEN CNS_ORDER_TYPE_FREE.
*     ALVデータ設定処理
PERFORM SET_T_ALV_0100_FREE.
WHEN OTHERS.
ENDCASE.

ENDFORM.                    " SET_T_ALV_0100
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_0100_NORMAL
*&---------------------------------------------------------------------*
*       未受信リスト内部テーブル設定
*----------------------------------------------------------------------*
FORM SET_T_ALV_0100_NORMAL.

DATA: LF_OBJECT LIKE LINE OF GT_OBJECT_NORMAL,
LF_SCHEDULE_DATA TYPE TYP_SCHEDULE_DATA,
LF_SHIPMENT_DATA LIKE LINE OF GT_SHIPMENT_DATA,
LF_SHIPMENT_ADDR TYPE TYP_SHIPMENT_ADDR,
LF_PURCHASE_DATA TYPE TYP_PURCHASE_DATA,
LF_STOCK_DATA LIKE LINE OF GT_STOCK_DATA,
LF_MATERIAL_DATA TYPE TYP_MATERIAL_DATA,
LF_BUSINESS_DATA TYPE TYP_BUSINESS_DATA,
LF_PARTNER_DATA TYPE TYP_PARTNER_DATA,
LF_PRICE_DATA TYPE TYP_PRICE_DATA,
LF_TRANSMIT_QUANTITY LIKE LINE OF GT_TRANSMIT_QUANTITY.
DATA: LF_ALV_0100 LIKE LINE OF GT_ALV_0100,
LF_ALV_0100_CHECKER LIKE LINE OF GT_ALV_0100,
LF_STYLE LIKE LINE OF LF_ALV_0100-STYLES.
DATA: LF_ALV_FIELDCAT LIKE LINE OF GT_ALV_FIELDCAT.
DATA: L_AMOUNT(15) TYPE P DECIMALS 4.

CLEAR GT_ALV_0100[].
CLEAR GT_ALV_0100_WK[].

LOOP AT GT_OBJECT_NORMAL INTO LF_OBJECT.

CLEAR: LF_ALV_0100.
CLEAR: LF_PURCHASE_DATA,
LF_MATERIAL_DATA,
LF_SCHEDULE_DATA,
LF_SHIPMENT_DATA,
LF_STOCK_DATA,
LF_BUSINESS_DATA,
LF_PARTNER_DATA,
LF_PRICE_DATA,
LF_TRANSMIT_QUANTITY.

*   受注在庫情報
READ TABLE GT_STOCK_DATA INTO LF_STOCK_DATA
WITH KEY MATNR = LF_OBJECT-MATNR
WERKS = LF_OBJECT-WERKS
VBELN = LF_OBJECT-VBELN
POSNR = LF_OBJECT-POSNR BINARY SEARCH.

*   営業所
LF_ALV_0100-VKBUR = LF_OBJECT-VKBUR.
*   営業ｸﾞﾙｰﾌﾟ
LF_ALV_0100-VKGRP = LF_OBJECT-VKGRP.
*   得意先ｺｰﾄﾞ
LF_ALV_0100-KUNNR = LF_OBJECT-KUNNR.	
*   伝票日付
LF_ALV_0100-AUDAT = LF_OBJECT-AUDAT.
*   販売伝票番号
LF_ALV_0100-VBELN = LF_OBJECT-VBELN.
*   指定納入期日
LF_ALV_0100-VDATU = LF_OBJECT-VDATU.
*   販売伝票ﾀｲﾌﾟ
LF_ALV_0100-AUART = LF_OBJECT-AUART.
*   明細番号
LF_ALV_0100-POSNR = LF_OBJECT-POSNR.
*   登録者名
LF_ALV_0100-ERNAM = LF_OBJECT-ERNAM.

*   営業所名
PERFORM GET_OFFICE_NAME USING    LF_ALV_0100-VKBUR
CHANGING LF_ALV_0100-BEZEIA.
*   営業ｸﾞﾙｰﾌﾟ名
PERFORM GET_GROUP_NAME USING    LF_ALV_0100-VKGRP
CHANGING LF_ALV_0100-BEZEIB.

*   受注伝票ビジネス情報取得
READ TABLE GT_BUSINESS_DATA INTO LF_BUSINESS_DATA
WITH KEY VBELN = LF_OBJECT-VBELN BINARY SEARCH.
IF SY-SUBRC = 0.
*   得意先回答納期
LF_ALV_0100-TKNR = LF_BUSINESS_DATA-BSTDK_E.
*   受注換算レート
LF_ALV_0100-STCUR = LF_BUSINESS_DATA-KURSK.
*   得意先発注番号
LF_ALV_0100-BSTNK = LF_BUSINESS_DATA-BSTKD.
ENDIF.

*   受注先情報取得
READ TABLE GT_PARTNER_DATA INTO LF_PARTNER_DATA
WITH KEY VBELN = LF_OBJECT-VBELN
POSNR = '000000' BINARY SEARCH.
IF SY-SUBRC = 0.
*     納入区域
LF_ALV_0100-LZONE = LF_PARTNER_DATA-LZONE.
*     得意先名
PERFORM GET_GUEST_NAME USING    LF_PARTNER_DATA-ADRNR_AG
CHANGING LF_ALV_0100-KNAME.
ENDIF.

*   納品書種別
PERFORM GET_DELIVERY_TYPE USING    LF_ALV_0100-KUNNR
CHANGING LF_ALV_0100-ZS01.

*   出荷ポイント
LF_ALV_0100-VSTEL = LF_OBJECT-VSTEL.	
*   品目コード
LF_ALV_0100-MATNR = LF_OBJECT-MATNR.
*   得意先品目ｺｰﾄﾞ
LF_ALV_0100-KDMAT = LF_OBJECT-KDMAT.
*   テキスト
LF_ALV_0100-ARKTX = LF_OBJECT-ARKTX.
*   明細カテゴリ
LF_ALV_0100-PSTYV = LF_OBJECT-PSTYV.
*   受注数量
CASE LF_OBJECT-VBTYP.
WHEN 'H' OR 'K'.
LF_ALV_0100-KWMENG = LF_OBJECT-KWMENG * ( -1 ).
WHEN OTHERS.
LF_ALV_0100-KWMENG = LF_OBJECT-KWMENG.
ENDCASE.
*   販売伝票通貨
LF_ALV_0100-WAERK = LF_OBJECT-WAERK.
*   引当済数量
CASE LF_OBJECT-VBTYP.
WHEN 'H' OR 'K'.
LF_ALV_0100-KBMENG = LF_OBJECT-KBMENG * ( -1 ).
WHEN OTHERS.
LF_ALV_0100-KBMENG = LF_OBJECT-KBMENG.
ENDCASE.
*   販売単位
LF_ALV_0100-VRKME = LF_OBJECT-VRKME.
*   拒否理由
LF_ALV_0100-ABGRU = LF_OBJECT-ABGRU.

*   区
CASE LF_OBJECT-PSTYV.
WHEN 'ZSEO'.
LF_ALV_0100-KU = TEXT-L01.
WHEN 'ZSEK'.
LF_ALV_0100-KU = TEXT-L02.
WHEN OTHERS.
LF_ALV_0100-KU = ' '.
ENDCASE.
*   在
CASE LF_OBJECT-PSTYV.
WHEN 'ZTAN' OR 'TAN' OR 'ZSEK' OR 'ZTMP'.
LF_ALV_0100-ZAI = '*'.
ENDCASE.

*   出荷指示備考
PERFORM GET_SHIPMENT_NOTE USING    LF_OBJECT-VBELN
LF_OBJECT-POSNR
CHANGING LF_ALV_0100-ETC.

*   営業員コード
LF_ALV_0100-PERNR = LF_OBJECT-PERNR.
*   営業員名
PERFORM GET_OPERATOR_NAME USING    LF_OBJECT-PERNR
CHANGING LF_ALV_0100-NACHN.

*   出荷ポイント名
PERFORM GET_SHIPMENT_POINT USING    LF_OBJECT-VSTEL
CHANGING LF_ALV_0100-VTEXT.
*   棚番
PERFORM GET_SHELF_NO USING    LF_OBJECT-MATNR
LF_OBJECT-WERKS
CHANGING LF_ALV_0100-LGPBE.

*   納入日程行情報存在チェック
READ TABLE GT_SCHEDULE_DATA INTO LF_SCHEDULE_DATA
WITH KEY VBELN = LF_OBJECT-VBELN
POSNR = LF_OBJECT-POSNR BINARY SEARCH.
IF SY-SUBRC = 0.
*     希望納期
LF_ALV_0100-EDATU = LF_SCHEDULE_DATA-EDATU.
*     出荷ブロック
LF_ALV_0100-LIFSP = ' '.
ENDIF.

IF NOT LF_SCHEDULE_DATA-BANFN IS INITIAL.
*     購買情報取得
READ TABLE GT_PURCHASE_DATA INTO LF_PURCHASE_DATA
WITH KEY BANFN = LF_SCHEDULE_DATA-BANFN
BNFPO = LF_SCHEDULE_DATA-BNFPO BINARY SEARCH.
IF SY-SUBRC = 0.
*       購買伝票番号
LF_ALV_0100-EBELN = LF_PURCHASE_DATA-EBELN.
*       購買伝票明細
LF_ALV_0100-EBELP = LF_PURCHASE_DATA-EBELP.
*       購買通貨コード
LF_ALV_0100-WAERS = LF_PURCHASE_DATA-WAERS.
*       購買換算レート
LF_ALV_0100-WKURS = LF_PURCHASE_DATA-WKURS.
*       明細納入期日
LF_ALV_0100-EINDT = LF_PURCHASE_DATA-EINDT.
*       購買発注数量
LF_ALV_0100-MENGE = LF_PURCHASE_DATA-MENGE.
*       入庫数量
LF_ALV_0100-WEMNG = LF_PURCHASE_DATA-WEMNG.
*       仕入先名
PERFORM GET_SUPPLIER_NAME USING    LF_PURCHASE_DATA-LIFNR
CHANGING LF_ALV_0100-LNAME.
*       発注単位
LF_ALV_0100-MEINS = LF_PURCHASE_DATA-MEINS.
ENDIF.
ENDIF.

*   出荷数量実績
READ TABLE GT_SHIPMENT_DATA INTO LF_SHIPMENT_DATA
WITH KEY VBELV = LF_OBJECT-VBELN
POSNV = LF_OBJECT-POSNR BINARY SEARCH.
IF SY-SUBRC = 0.
CASE LF_OBJECT-VBTYP.
WHEN 'H' OR 'K'.
LF_ALV_0100-LIFMG = LF_SHIPMENT_DATA-LFIMG * ( -1 ).
WHEN OTHERS.
LF_ALV_0100-LIFMG = LF_SHIPMENT_DATA-LFIMG.
ENDCASE.
ENDIF.

*   受注単価・受注単価(円建て)・受注金額・受注金額(円建て)算出
PERFORM CONVERT_AMOUNT_TO_DISPLAY USING    LF_OBJECT-NETPR
LF_OBJECT-WAERK
CHANGING L_AMOUNT.
IF LF_OBJECT-KPEIN <> 0.
*     受注単価
LF_ALV_0100-VNETPR =  L_AMOUNT / LF_OBJECT-KPEIN.
*     受注単価(円建て)
LF_ALV_0100-JTNKYEN = LF_ALV_0100-VNETPR * LF_ALV_0100-STCUR.
ENDIF.
*   受注金額
PERFORM CONVERT_AMOUNT_TO_DISPLAY USING    LF_OBJECT-NETWR
LF_OBJECT-WAERK
CHANGING LF_ALV_0100-NETWR.
CASE LF_OBJECT-VBTYP.
WHEN 'H' OR 'K'.
LF_ALV_0100-NETWR = LF_ALV_0100-NETWR * ( -1 ).
ENDCASE.
*   受注金額(円建て)
LF_ALV_0100-NUMGF = LF_ALV_0100-NETWR * LF_ALV_0100-STCUR.

*   発注単価・発注単価(円建て)・発注金額(円建て)算出
PERFORM CONVERT_AMOUNT_TO_DISPLAY USING    LF_PURCHASE_DATA-ENETPR
LF_PURCHASE_DATA-WAERS
CHANGING L_AMOUNT.
IF LF_PURCHASE_DATA-PEINH <> 0.
*   発注単価
LF_ALV_0100-ENETPR =  L_AMOUNT / LF_PURCHASE_DATA-PEINH.
*   発注単価（円建て）
LF_ALV_0100-HCTNK =
LF_ALV_0100-ENETPR * LF_PURCHASE_DATA-WKURS.
ENDIF.
*   発注金額（円建て）
LF_ALV_0100-MNYEN = LF_ALV_0100-HCTNK * LF_PURCHASE_DATA-MENGE.

*   原価・原価(円建て)・原価金額(円建て)算出
PERFORM CONVERT_AMOUNT_TO_DISPLAY USING    LF_OBJECT-WAVWR
LF_OBJECT-WAERK
CHANGING L_AMOUNT.
IF LF_OBJECT-KWMENG <> 0.
*     原価
LF_ALV_0100-WAVWR =  L_AMOUNT / LF_OBJECT-KWMENG.
*     原価（円建て）
LF_ALV_0100-GYEN1 =  LF_ALV_0100-WAVWR * LF_ALV_0100-STCUR.
ENDIF.
*   原価金額（円建て）
CASE LF_OBJECT-VBTYP.
WHEN 'H' OR 'K'.
LF_ALV_0100-GYEN2 = L_AMOUNT * LF_ALV_0100-STCUR * ( -1 ).
WHEN OTHERS.
LF_ALV_0100-GYEN2 = L_AMOUNT * LF_ALV_0100-STCUR.
ENDCASE.

*   粗利金額（円建て）
LF_ALV_0100-ARAEYN = LF_ALV_0100-NUMGF - LF_ALV_0100-GYEN2.
IF LF_ALV_0100-NUMGF <> 0.
*     粗利率
LF_ALV_0100-ARAPER = LF_ALV_0100-ARAEYN / LF_ALV_0100-NUMGF * 100.
ENDIF.

*   未出荷数量
LF_ALV_0100-NUMMS = LF_ALV_0100-KWMENG - LF_ALV_0100-LIFMG.
*   発注残数
LF_ALV_0100-HZNUM = LF_ALV_0100-MENGE - LF_ALV_0100-WEMNG.
*   出荷可能数量
CASE LF_OBJECT-PSTYV.
WHEN 'TAB' OR 'ZTAB' OR 'ZTMB'.
* Mod 2008.01.24 --->
*        LF_ALV_0100-NUMSC = LF_STOCK_DATA-KALAB - LF_ALV_0100-LIFMG.
LF_ALV_0100-NUMSC = LF_STOCK_DATA-KALAB .
* Mod 2008.01.24 <---
WHEN OTHERS.
LF_ALV_0100-NUMSC = LF_ALV_0100-KBMENG - LF_ALV_0100-LIFMG.
ENDCASE.

*   得意先品目情報取得
PERFORM GET_GUEST_MATERIAL USING    LF_OBJECT-KUNNR
LF_OBJECT-MATNR
CHANGING LF_ALV_0100-LTX01.

*   出荷先情報取得
PERFORM GET_SHIPMENT_ADDRESS USING    LF_PARTNER_DATA-ADRNR_WE
CHANGING LF_SHIPMENT_ADDR.
*   出荷先コード
LF_ALV_0100-KUNNR_WE = LF_PARTNER_DATA-KUNWE.
*   得意先名
LF_ALV_0100-KNAME_WE = LF_SHIPMENT_ADDR-NAME2.
*   出荷先住所
CONCATENATE LF_SHIPMENT_ADDR-CITY1 LF_SHIPMENT_ADDR-STREET
INTO LF_ALV_0100-ADDNAME.
*   地域
LF_ALV_0100-BEZEI = LF_SHIPMENT_ADDR-BEZEI.

*   輸送手段
PERFORM GET_TRANSFER_WAY USING    LF_OBJECT-VBELN
LF_OBJECT-POSNR
CHANGING LF_ALV_0100-YUSOUTOU.

* ADD-BEG DM00151 DMC 2008/02/26（そのうち削除する）
* 出荷ポイントが'PS90'の場合、「出荷指示備考」と
* 「輸送手段」を入替える
IF LF_OBJECT-VSTEL EQ 'PS90'.
CLEAR : G_CHAR_TMP, G_CHAR_LEN.

* 「輸送手段」の文字バイト数取得
G_CHAR_LEN = STRLEN( LF_ALV_0100-YUSOUTOU ).

* 「輸送手段」の文字バイト数が41バイト以上の場合、
*  41バイト目以降は削除
IF G_CHAR_LEN > 40.
CALL FUNCTION 'STRING_SPLIT_AT_POSITION'
EXPORTING
STRING                  = LF_ALV_0100-YUSOUTOU
POS                     = 40
*       LANGU                   = SY-LANGU
IMPORTING
STRING1                 = G_CHAR_YUSOU
STRING2                 = G_CHAR_TMP
*       POS_NEW                 =
EXCEPTIONS
STRING1_TOO_SMALL       = 1
STRING2_TOO_SMALL       = 2
POS_NOT_VALID           = 3
OTHERS                  = 4.

IF SY-SUBRC <> 0.
*     MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*             WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
ELSE.
G_CHAR_YUSOU = LF_ALV_0100-YUSOUTOU.
ENDIF.

* 「出荷指示備考」と「輸送手段」を入替え
LF_ALV_0100-YUSOUTOU = LF_ALV_0100-ETC.
LF_ALV_0100-ETC      = G_CHAR_YUSOU.
ENDIF.
* ADD-END DM00151 DMC 2008/02/26

*   品目マスタ情報取得
PERFORM GET_MATERIAL_DATA USING    LF_OBJECT-MATNR
LF_OBJECT-WERKS
CHANGING LF_MATERIAL_DATA.

* ADD-BEG DM00155 DMC 2008/02/26（許可を得ていないためコメントアウト）
* ※MSKA-KALABは基本数量単位の数量のため出荷可能数量がおかしい
* ※下記のロジックを有効にした場合、「ADD-BEG DM00155 DMC 2008/02/26」の
*   修正を元に戻す必要がある
*    IF LF_OBJECT-PSTYV EQ 'TAB'  OR
*       LF_OBJECT-PSTYV EQ 'ZTAB' OR
*       LF_OBJECT-PSTYV EQ 'ZTMB'.
*    CLEAR G_NUMSC_TMP.
**   販売数量単位に変換
*    PERFORM GET_VALID_QUANTITY USING    LF_OBJECT-MATNR
*                                        LF_OBJECT-VRKME
*                                        LF_MATERIAL_DATA-MEINS
*                                        LF_ALV_0100-NUMSC
*                               CHANGING G_NUMSC_TMP.
*    LF_ALV_0100-NUMSC = G_NUMSC_TMP.
*    ENDIF.
* ADD-END DM00155 DMC 2008/02/26

*   原産地
LF_ALV_0100-HERKL = LF_MATERIAL_DATA-HERKL.
*   HS CODE
LF_ALV_0100-STAWN = LF_MATERIAL_DATA-STAWN.
*   危険品区分
IF LF_MATERIAL_DATA-PRAT1 IS INITIAL.
LF_ALV_0100-PRAT1 = '2'.
ELSE.
LF_ALV_0100-PRAT1 = '1'.
ENDIF.
*   危険物コード
LF_ALV_0100-STOFF = LF_MATERIAL_DATA-STOFF.
*   非該当
IF LF_MATERIAL_DATA-PRAT2 IS INITIAL.
LF_ALV_0100-PRAT2 = '1'.
ELSE.
LF_ALV_0100-PRAT2 = '2'.
ENDIF.
*   単重量
LF_ALV_0100-NTGEW = LF_MATERIAL_DATA-NTGEW.

*   商品名
PERFORM GET_GOODS_NAME USING    LF_OBJECT-KUNNR
LF_OBJECT-MATNR
CHANGING LF_ALV_0100-SYOHIN.

*   製品
PERFORM GET_PRODUCT_NAME USING    LF_OBJECT-KUNNR
LF_OBJECT-MATNR
CHANGING LF_ALV_0100-SEIHIN.

*   出荷可受注単位数量
PERFORM GET_VALID_QUANTITY USING    LF_OBJECT-MATNR
LF_MATERIAL_DATA-VRKME
LF_OBJECT-VRKME
LF_ALV_0100-NUMSC
CHANGING LF_ALV_0100-NUMSJ.
IF G_RC <> 0.
PERFORM GET_VALID_QUANTITY USING    LF_OBJECT-MATNR
LF_MATERIAL_DATA-MEINS
LF_OBJECT-VRKME
LF_ALV_0100-NUMSC
CHANGING LF_ALV_0100-NUMSJ.
ENDIF.

*   仲介単価情報取得
READ TABLE GT_PRICE_DATA INTO LF_PRICE_DATA
WITH KEY KNUMV = LF_OBJECT-KNUMV
KPOSN = LF_OBJECT-POSNR BINARY SEARCH.
IF SY-SUBRC = 0.
*     仲介通貨コード
LF_ALV_0100-WARES_EU = LF_PRICE_DATA-WAERS.
*     仲介単価
* Mod 2008.03.25 --->
*      LF_ALV_0100-KWERT_EU = LF_PRICE_DATA-KWERT.
LF_ALV_0100-KWERT_EU = LF_PRICE_DATA-KBETR /
LF_PRICE_DATA-KPEIN.
* Mod 2008.03.25 <---
CLEAR G_FLG_EU.
ELSE.
G_FLG_EU = 'X'.
ENDIF.

*   エンドユーザ情報取得
READ TABLE GT_PARTNER_DATA INTO LF_PARTNER_DATA
WITH KEY VBELN = LF_OBJECT-VBELN
POSNR = LF_OBJECT-POSNR BINARY SEARCH.
IF SY-SUBRC <> 0.
READ TABLE GT_PARTNER_DATA INTO LF_PARTNER_DATA
WITH KEY VBELN = LF_OBJECT-VBELN
POSNR = '000000' BINARY SEARCH.
ENDIF.
IF SY-SUBRC = 0.
*     エンドユーザコード
LF_ALV_0100-KUNNR_EU = LF_PARTNER_DATA-KUNZE.
*     エンドユーザ名
PERFORM GET_ENDUSER_NAME USING    LF_PARTNER_DATA-ADRNR_ZE
CHANGING LF_ALV_0100-KNAME_EU.
ENDIF.

*   送信済数
READ TABLE GT_TRANSMIT_QUANTITY INTO LF_TRANSMIT_QUANTITY
WITH KEY VBELN = LF_OBJECT-VBELN
POSNR = LF_OBJECT-POSNR BINARY SEARCH.
IF SY-SUBRC = 0.
LF_ALV_0100-MENGE_ZUMI =
LF_TRANSMIT_QUANTITY-SDMENG - LF_TRANSMIT_QUANTITY-LFIMG.
ENDIF.
* ADD-BEG DM00155 DMC 2008/02/26
CLEAR G_NUMSC_TMP.
* 販売数量単位に変換
PERFORM GET_VALID_QUANTITY USING    LF_OBJECT-MATNR
LF_OBJECT-VRKME
LF_MATERIAL_DATA-MEINS
LF_ALV_0100-NUMSC
CHANGING G_NUMSC_TMP.
* ADD-END DM00155 DMC 2008/02/26
* MOD-BEG DM00155 DMC 2008/02/26
*   送信可能数
*    LF_ALV_0100-MENGE_KANO = LF_ALV_0100-NUMSC - LF_ALV_0100-MENGE_ZUMI
*.
LF_ALV_0100-MENGE_KANO = G_NUMSC_TMP - LF_ALV_0100-MENGE_ZUMI.
* MOD-END DM00155 DMC 2008/02/26
*   送信数量
LF_ALV_0100-MENGE_SEND = LF_ALV_0100-MENGE_KANO.

*   無償支給区分
LF_ALV_0100-MUSYO = '0'.

*   エラー情報
MOVE LF_ALV_0100 TO LF_ALV_0100_CHECKER.
PERFORM CHECK_ALV_0100 USING    LF_ALV_0100_CHECKER
CHANGING LF_ALV_0100-FLG_ERR
LF_ALV_0100-INFO_ERR.

LOOP AT GT_ALV_FIELDCAT INTO LF_ALV_FIELDCAT
WHERE EDIT = 'X'.
LF_STYLE-FIELDNAME = LF_ALV_FIELDCAT-FIELDNAME.
IF LF_ALV_0100-FLG_ERR IS INITIAL.
LF_STYLE-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_ENABLED.
ELSE.
LF_STYLE-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_DISABLED.
ENDIF.
INSERT LF_STYLE INTO TABLE LF_ALV_0100-STYLES.
ENDLOOP.

*   上位レベル明細
LF_ALV_0100-UEPOS = LF_OBJECT-UEPOS.

APPEND LF_ALV_0100 TO GT_ALV_0100.

ENDLOOP.

* ソート：出荷ポイント・営業グループ・得意先・希望納期・得意先発注番号
SORT GT_ALV_0100 BY VSTEL VKGRP KUNNR EDATU BSTNK VBELN POSNR.
ENDFORM.                    " SET_T_ALV_0100_NORMAL
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_0100_FREE
*&---------------------------------------------------------------------*
*       未受信リスト内部テーブル設定
*----------------------------------------------------------------------*
FORM SET_T_ALV_0100_FREE.

DATA: LF_OBJECT LIKE LINE OF GT_OBJECT_FREE,
LF_MATERIAL_DATA TYPE TYP_MATERIAL_DATA,
LF_TRANSMIT_QUANTITY LIKE LINE OF GT_TRANSMIT_QUANTITY.
DATA: LF_ALV_0100 LIKE LINE OF GT_ALV_0100,
LF_ALV_0100_CHECKER LIKE LINE OF GT_ALV_0100,
LF_STYLE  LIKE LINE OF LF_ALV_0100-STYLES.
DATA: LF_ALV_FIELDCAT LIKE LINE OF GT_ALV_FIELDCAT.

CLEAR G_FLG_EU.

CLEAR GT_ALV_0100[].
LOOP AT GT_OBJECT_FREE INTO LF_OBJECT.

CLEAR LF_ALV_0100.
CLEAR LF_MATERIAL_DATA.

*   得意先ｺｰﾄﾞ
LF_ALV_0100-KUNNR = LF_OBJECT-LIFNR.	
*   伝票日付
LF_ALV_0100-AUDAT = LF_OBJECT-BLDAT.
*   品目コード
LF_ALV_0100-MATNR = LF_OBJECT-MATNR.
*   出荷可能数量
LF_ALV_0100-NUMSC = LF_OBJECT-MENGE.
*   伝票番号
LF_ALV_0100-VBELN = LF_OBJECT-MBLNR.
*   明細番号
LF_ALV_0100-POSNR = LF_OBJECT-ZEILE.
*   ユーザ名
LF_ALV_0100-ERNAM = LF_OBJECT-USNAM.
*   出荷ポイント
LF_ALV_0100-VSTEL = LF_OBJECT-WERKS.	

*   在
LF_ALV_0100-ZAI = '*'.

*   品目マスタ情報取得
PERFORM GET_MATERIAL_DATA USING    LF_OBJECT-MATNR
LF_OBJECT-WERKS
CHANGING LF_MATERIAL_DATA.
*   原産地
LF_ALV_0100-HERKL = LF_MATERIAL_DATA-HERKL.
*   HS CODE
LF_ALV_0100-STAWN = LF_MATERIAL_DATA-STAWN.
*   危険品区分
LF_ALV_0100-PRAT1 = LF_MATERIAL_DATA-PRAT1.
*   危険品区分
IF LF_MATERIAL_DATA-PRAT1 IS INITIAL.
LF_ALV_0100-PRAT1 = '2'.
ELSE.
LF_ALV_0100-PRAT1 = '1'.
ENDIF.
*   危険物コード
LF_ALV_0100-STOFF = LF_MATERIAL_DATA-STOFF.
*   非該当
LF_ALV_0100-PRAT2 = LF_MATERIAL_DATA-PRAT2.
*   非該当
IF LF_MATERIAL_DATA-PRAT2 IS INITIAL.
LF_ALV_0100-PRAT2 = '1'.
ELSE.
LF_ALV_0100-PRAT2 = '2'.
ENDIF.
*   単重量
LF_ALV_0100-NTGEW = LF_MATERIAL_DATA-NTGEW.

*   送信済数
READ TABLE GT_TRANSMIT_QUANTITY INTO LF_TRANSMIT_QUANTITY
WITH KEY VBELN = LF_OBJECT-MBLNR
POSNR = LF_OBJECT-ZEILE BINARY SEARCH.
IF SY-SUBRC = 0.
LF_ALV_0100-MENGE_ZUMI =
LF_TRANSMIT_QUANTITY-SDMENG - LF_TRANSMIT_QUANTITY-LFIMG.
ENDIF.
*   送信可能数
LF_ALV_0100-MENGE_KANO = LF_ALV_0100-NUMSC - LF_ALV_0100-MENGE_ZUMI.
*   送信数量
LF_ALV_0100-MENGE_SEND = LF_ALV_0100-MENGE_KANO.

CHECK LF_ALV_0100-MENGE_KANO > 0.

*   無償支給区分
LF_ALV_0100-MUSYO = '1'.

*   得意先名
PERFORM GET_KNAME USING    LF_OBJECT-LIFNR
CHANGING LF_ALV_0100-KNAME.
*   品名
PERFORM GET_ARKTX USING    LF_OBJECT-MATNR
CHANGING LF_ALV_0100-ARKTX.
*2007/08/31 ADD START
*   棚番
PERFORM GET_SHELF_NO USING    LF_OBJECT-MATNR
LF_OBJECT-WERKS
CHANGING LF_ALV_0100-LGPBE.
*2007/08/31 ADD END

*   エラー情報
MOVE LF_ALV_0100 TO LF_ALV_0100_CHECKER.
PERFORM CHECK_ALV_0100 USING    LF_ALV_0100_CHECKER
CHANGING LF_ALV_0100-FLG_ERR
LF_ALV_0100-INFO_ERR.

LOOP AT GT_ALV_FIELDCAT INTO LF_ALV_FIELDCAT
WHERE EDIT = 'X'.
LF_STYLE-FIELDNAME = LF_ALV_FIELDCAT-FIELDNAME.
IF LF_ALV_0100-FLG_ERR IS INITIAL.
LF_STYLE-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_ENABLED.
ELSE.
LF_STYLE-STYLE = CL_GUI_ALV_GRID=>MC_STYLE_DISABLED.
ENDIF.
INSERT LF_STYLE INTO TABLE LF_ALV_0100-STYLES.
ENDLOOP.

APPEND LF_ALV_0100 TO GT_ALV_0100.

ENDLOOP.

IF GT_ALV_0100 IS INITIAL.
*   入出庫伝票に該当するデータがありません
MESSAGE S600 WITH TEXT-M08.
*   選択画面に戻る
PERFORM BACK_TO_FIRST_SCREEN.
ENDIF.

* ソート：得意先・希望納期
SORT GT_ALV_0100 BY KUNNR EDATU VBELN POSNR.

ENDFORM.                    " SET_T_ALV_0100_FREE
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_FIELDCAT_0100
*&---------------------------------------------------------------------*
*       ALV項目入力属性設定
*----------------------------------------------------------------------*
FORM SET_T_ALV_FIELDCAT_0100.

FIELD-SYMBOLS: <FF_ALV_FIELDCAT> LIKE LINE OF GT_ALV_FIELDCAT.

PERFORM CREATE_T_ALV_FIELDCAT.
LOOP AT GT_ALV_FIELDCAT ASSIGNING <FF_ALV_FIELDCAT>.
CASE <FF_ALV_FIELDCAT>-FIELDNAME.
*     №
WHEN 'ZNO'.
<FF_ALV_FIELDCAT>-EDIT = 'X'.
*     ASN №
WHEN 'ASNNO'.
<FF_ALV_FIELDCAT>-EDIT = 'X'.
*     単価
WHEN 'VNETPR'.
IF G_ORDER_TYPE = CNS_ORDER_TYPE_FREE.
<FF_ALV_FIELDCAT>-EDIT = 'X'.
ENDIF.
*     通貨
WHEN 'WAERK'.
IF G_ORDER_TYPE = CNS_ORDER_TYPE_FREE.
<FF_ALV_FIELDCAT>-EDIT = 'X'.
*     送信数量
ENDIF.
WHEN 'MENGE_SEND'.
<FF_ALV_FIELDCAT>-EDIT = 'X'.
ENDCASE.
ENDLOOP.

ENDFORM.                    " SET_T_ALV_FIELDCAT_0100
*&---------------------------------------------------------------------*
*&      Form  SET_ALV_LAYOUT_0100
*&---------------------------------------------------------------------*
*       ALVレイアウト設定
*----------------------------------------------------------------------*
FORM SET_ALV_LAYOUT_0100.

CLEAR GF_ALV_LAYOUT.
GF_ALV_LAYOUT-STYLEFNAME = 'STYLES'.

ENDFORM.                    " SET_ALV_LAYOUT_0100
*&---------------------------------------------------------------------*
*&      Form  SET_ALV_VARIANT_0100
*&---------------------------------------------------------------------*
*       ALVバリアント設定
*----------------------------------------------------------------------*
FORM SET_ALV_VARIANT_0100 .

CLEAR GF_ALV_VARIANT.
GF_ALV_VARIANT-REPORT = SY-REPID.
GF_ALV_VARIANT-HANDLE = SY-DYNNR.

ENDFORM.                    " SET_ALV_VARIANT_0100
*&---------------------------------------------------------------------*
*&      Form  SET_ALV_TOOLBAR_0100
*&---------------------------------------------------------------------*
*       ALVツールバー設定
*----------------------------------------------------------------------*
FORM SET_ALV_TOOLBAR_0100 .

DATA: LF_ALV_FUNCTION LIKE LINE OF GT_ALV_FUNCTION.

CLEAR GT_ALV_FUNCTION[].
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_CHECK.    " エントリチェック
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_REFRESH.  " リフレッシュ
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_MB_PASTE.    " ペーストメニュー
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_MB_FILTER.   " フィルタ
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_MB_VIEW.     " ビューメニュー
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_MB_SUBTOT.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_GRAPH.    " グラフィック
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_INFO.     " 情報
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_APPEND_ROW.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY_ROW.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_CUT.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_DELETE_ROW.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_INSERT_ROW.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_MOVE_ROW.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_PASTE.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_PASTE_NEW_ROW.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.
LF_ALV_FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_UNDO.
APPEND LF_ALV_FUNCTION TO GT_ALV_FUNCTION.

ENDFORM.                    " SET_ALV_TOOLBAR_0100
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_ROID_0100
*&---------------------------------------------------------------------*
*       ALV行番内部テーブル初期設定
*----------------------------------------------------------------------*
FORM SET_T_ALV_ROID_0100 .

DATA: LF_ALV_ROID LIKE LINE OF GT_ALV_ROID.
DATA: L_COUNT TYPE I.

CLEAR GT_ALV_ROID[].
DESCRIBE TABLE GT_ALV_0100 LINES L_COUNT.
DO L_COUNT TIMES.
*   初期の場合、行番 = テーブルインデックス
LF_ALV_ROID-ROW_ID = SY-INDEX.
APPEND LF_ALV_ROID TO GT_ALV_ROID.
ENDDO.

ENDFORM.                    " SET_T_ALV_ROID_0100
*&---------------------------------------------------------------------*
*&      Module  CHECK_INPUT_0100  INPUT
*&---------------------------------------------------------------------*
*       入力チェック
*----------------------------------------------------------------------*
MODULE CHECK_INPUT_0100 INPUT.

* ALV一覧データチェック
PERFORM HANDLE_ALV_DATA.

CHECK G_RC = 0.
CASE OK_CODE.
*   送信押下
WHEN CNS_OK_CODE_TRANSMIT.
*     №入力チェック
PERFORM CHECK_NO_IS_INPUTED.
IF G_RC = 0.
*     得意先、エンドユーザが異なるチェック
PERFORM CHECK_GUEST_HAS_NO_DIFFERENT.
ENDIF.
ENDCASE.

ENDMODULE.                 " CHECK_INPUT_0100  INPUT
*&---------------------------------------------------------------------*
*&      Module  USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
*       USER_COMMAND
*----------------------------------------------------------------------*
MODULE USER_COMMAND_0100 INPUT.

CHECK G_RC = 0.
CASE OK_CODE.
*   UTL送信
WHEN CNS_OK_CODE_TRANSMIT.
*     送信確認
PERFORM CONFIRM_TO_TRANSMIT.
IF G_RC = 0.
*       送信処理
PERFORM TRANSMIT_DATA.
IF G_RC = 0.
*         処理結果出力
PERFORM SET_T_RESULT_0100.
ENDIF.
PERFORM UNLOCK_OBJECT.
LEAVE TO SCREEN 0.
ENDIF.
WHEN CNS_OK_CODE_BACK.
PERFORM UNLOCK_OBJECT.
*     第一画面へ戻る
PERFORM BACK_TO_FIRST_SCREEN.
ENDCASE.

ENDMODULE.                 " USER_COMMAND_0100  INPUT
*&---------------------------------------------------------------------*
*&      Form  CONFIRM_TO_TRANSMIT
*&---------------------------------------------------------------------*
*       送信確認
*----------------------------------------------------------------------*
FORM CONFIRM_TO_TRANSMIT.

DATA: L_ANSWER TYPE C.

CLEAR G_RC.
CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TEXT_QUESTION         = TEXT-P01
DISPLAY_CANCEL_BUTTON = ' '
IMPORTING
ANSWER                = L_ANSWER
EXCEPTIONS
OTHERS                = 0.
CASE L_ANSWER.
WHEN '1'.
WHEN OTHERS.
G_RC = CNS_RC_CODE_CANCEL.
ENDCASE.

ENDFORM.                    " CONFIRM_TO_TRANSMIT
*&---------------------------------------------------------------------*
*&      Form  TRANSMIT_DATA
*&---------------------------------------------------------------------*
*       送信処理
*----------------------------------------------------------------------*
FORM TRANSMIT_DATA.

DATA: LT_ALV_0100_INS TYPE TYP_T_ALV_0100,
LF_ALV_0100 LIKE LINE OF GT_ALV_0100.
DATA: L_SENDID TYPE ZSD002-SENDID,
L_FULLNAME TYPE RLGRAP-FILENAME,
L_VSTEL LIKE LF_ALV_0100-VSTEL,
L_KUNNR LIKE LF_ALV_0100-KUNNR.

CLEAR G_RC.
CLEAR GT_FILE_LIST[].
SORT GT_ALV_0100 BY ZNO VBELN POSNR.
LOOP AT GT_ALV_0100 INTO LF_ALV_0100
WHERE NOT ZNO IS INITIAL.
L_VSTEL = LF_ALV_0100-VSTEL.
L_KUNNR = LF_ALV_0100-KUNNR.
*   ピッキング№ごとに送信
AT NEW ZNO.
CLEAR LT_ALV_0100_INS[].
DO 999 TIMES.
*       送信ID採番
PERFORM GET_NEXT_SEND_ID CHANGING L_SENDID.
*       送信ファイル名取得
PERFORM GET_FILE_FULLNAME USING    L_VSTEL
L_KUNNR
L_SENDID
* {{{{{ 2007/10/30 INSERT -----
LF_ALV_0100-ZNO
* ----- 2007/10/30 INSERT }}}}}
CHANGING L_FULLNAME.
*       ファイル存在チェック
PERFORM CHECK_FILE_IS_EXIST USING L_FULLNAME.
IF G_RC <> 0.
EXIT.
ENDIF.
*       ファイル存在する場合、再採番処理
CLEAR L_FULLNAME.
ENDDO.
*     ファイルOPEN
PERFORM OPEN_FILE USING L_FULLNAME.
IF G_RC <> 0.
EXIT.
ENDIF.
ENDAT.
APPEND LF_ALV_0100 TO LT_ALV_0100_INS.
AT END OF ZNO.
*     ファイル出力
PERFORM OUTPUT_TO_FILE USING L_FULLNAME
L_SENDID
LT_ALV_0100_INS.
*     ファイルCLOSE
PERFORM CLOSE_FILE USING L_FULLNAME.
*     送信ログ登録
PERFORM INSERT_ZSD002 USING L_SENDID
L_FULLNAME
LT_ALV_0100_INS.
IF G_RC <> 0.
EXIT.
ENDIF.
ENDAT.
ENDLOOP.

CHECK G_RC = 0.
COMMIT WORK.

ENDFORM.                    " TRANSMIT_DATA
*&---------------------------------------------------------------------*
*&      Form  CHECK_ALV_INPUT_0100
*&---------------------------------------------------------------------*
*       ALV入力チェック
*----------------------------------------------------------------------*
*      -->IR_DATA_CHANGED  変更されたALVデータ
*----------------------------------------------------------------------*
FORM CHECK_ALV_INPUT_0100
USING IR_DATA_CHANGED TYPE REF TO CL_ALV_CHANGED_DATA_PROTOCOL.

* セット品エラー子品目格納用
TYPES:BEGIN OF TYP_SETERR,
VBELN TYPE VBAP-VBELN,
POSNR TYPE VBAP-POSNR,
END OF TYP_SETERR.
DATA: LF_SETERR  TYPE TYP_SETERR,
LT_SETERR  TYPE TABLE OF TYP_SETERR,
L_FLG_ERR1 TYPE C,
L_FLG_ERR2 TYPE C.
DATA: LF_ALV_0100 LIKE LINE OF GT_ALV_0100.
DATA: LF_MSG1 TYPE LVC_S_MSG1.
DATA: LF_MODIFIED_CELL TYPE LVC_S_MODI,
LF_GOOD_CELL TYPE LVC_S_MODI,
LF_CELL TYPE LVC_S_CELL.
DATA: L_NO TYPE ZSLIST_V21-ZNO,
L_QUANTITY TYPE ZSLIST_V21-MENGE_SEND.
DATA: L_TABIX TYPE SY-TABIX.

* 行番データ更新
GT_ALV_ROID[] = IR_DATA_CHANGED->MT_ROID_FRONT[].

LOOP AT IR_DATA_CHANGED->MT_GOOD_CELLS[] INTO LF_GOOD_CELL.

*   変更項目履歴更新
MODIFY GT_ALV_GOOD_CELL FROM LF_GOOD_CELL TRANSPORTING VALUE
WHERE ROW_ID    = LF_GOOD_CELL-ROW_ID
AND FIELDNAME = LF_GOOD_CELL-FIELDNAME.
IF SY-SUBRC <> 0.
APPEND LF_GOOD_CELL TO GT_ALV_GOOD_CELL.
ENDIF.

ENDLOOP.

LOOP AT GT_ALV_GOOD_CELL INTO LF_GOOD_CELL.

*   変更前の値取得
READ TABLE GT_ALV_ROID TRANSPORTING NO FIELDS
WITH KEY ROW_ID = LF_GOOD_CELL-ROW_ID.
L_TABIX = SY-TABIX.
READ TABLE GT_ALV_0100 INTO LF_ALV_0100 INDEX L_TABIX.

CASE LF_GOOD_CELL-FIELDNAME.
*     №
WHEN 'ZNO'.
L_NO = LF_GOOD_CELL-VALUE.
IF NOT L_NO IS INITIAL.
IF G_ORDER_TYPE = CNS_ORDER_TYPE_FREE.
READ TABLE GT_ALV_GOOD_CELL INTO LF_MODIFIED_CELL
WITH KEY FIELDNAME = 'WAERK'
ROW_ID    = LF_GOOD_CELL-ROW_ID.
IF SY-SUBRC <> 0.
*             通貨コード入力チェック
IF LF_ALV_0100-WAERK IS INITIAL.
*               通貨コードが入力されていない為、送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '630'
I_FIELDNAME = 'WAERK'
I_ROW_ID    = LF_GOOD_CELL-ROW_ID
I_TABIX     = L_TABIX.
ENDIF.
ENDIF.
ENDIF.
ENDIF.

*       セット品のチェック(通常出荷の場合のみ)
IF G_ORDER_TYPE = CNS_ORDER_TYPE_NORMAL  AND
NOT L_NO IS INITIAL.
CASE LF_ALV_0100-PSTYV.
*           親品目の場合
WHEN 'ZSEO'.
CLEAR : L_FLG_ERR1,L_FLG_ERR2.
*             子品目明細が全て送信対象かチェック
PERFORM CHECK_ZSEK USING    LF_ALV_0100-VBELN
LF_ALV_0100-POSNR
L_NO
CHANGING L_FLG_ERR1
L_FLG_ERR2.
IF L_FLG_ERR1 = 'X'.
*             選択されていないセット品の構成情報がある為、送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '642'
I_FIELDNAME = 'ZNO'
I_ROW_ID    = LF_GOOD_CELL-ROW_ID
I_TABIX     = L_TABIX.
ENDIF.

IF L_FLG_ERR2 = 'X'.
*               セット品は分割して送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '643'
I_FIELDNAME = 'ZNO'
I_ROW_ID    = LF_GOOD_CELL-ROW_ID
I_TABIX     = L_TABIX.
ENDIF.
*           子品目の場合
WHEN 'ZSEK'.
CLEAR : L_FLG_ERR1,L_FLG_ERR2.
*             親品目が送信対象かチェック
PERFORM CHECK_ZSEO USING    LF_ALV_0100-VBELN
LF_ALV_0100-UEPOS
L_NO
CHANGING L_FLG_ERR1
L_FLG_ERR2.
IF L_FLG_ERR1 = 'X'.
*             選択されていないセット品の構成情報がある為、送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '642'
I_FIELDNAME = 'ZNO'
I_ROW_ID    = LF_GOOD_CELL-ROW_ID
I_TABIX     = L_TABIX.
ENDIF.

IF L_FLG_ERR2 = 'X'.
*               セット品は分割して送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '643'
I_FIELDNAME = 'ZNO'
I_ROW_ID    = LF_GOOD_CELL-ROW_ID
I_TABIX     = L_TABIX.
ENDIF.
*           それ以外の場合
WHEN OTHERS.
ENDCASE.
ENDIF.

*     通貨コード
WHEN 'WAERK'.
*       入力必須チェック
IF LF_GOOD_CELL-VALUE IS INITIAL.
IF G_ORDER_TYPE = CNS_ORDER_TYPE_FREE.
READ TABLE IR_DATA_CHANGED->MT_MOD_CELLS[]
INTO LF_MODIFIED_CELL
WITH KEY FIELDNAME = 'ZNO'
ROW_ID    = LF_GOOD_CELL-ROW_ID.
IF SY-SUBRC = 0.
READ TABLE IR_DATA_CHANGED->MT_GOOD_CELLS[]
INTO LF_MODIFIED_CELL
WITH KEY FIELDNAME = 'ZNO'
ROW_ID    = LF_GOOD_CELL-ROW_ID.
IF SY-SUBRC = 0.
L_NO = LF_MODIFIED_CELL-VALUE.
ENDIF.
ELSE.
L_NO = LF_ALV_0100-ZNO.
ENDIF.
IF NOT L_NO IS INITIAL.
*             通貨コードが入力されていない為、送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '630'
I_FIELDNAME = LF_GOOD_CELL-FIELDNAME
I_ROW_ID    = LF_GOOD_CELL-ROW_ID.
ENDIF.
ENDIF.
ELSE.
*         存在チェック
PERFORM CHECK_WAERK_IS_EXIST USING LF_GOOD_CELL-VALUE.
IF G_RC <> 0.
*           通貨コードが不正な為、送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '631'
I_FIELDNAME = LF_GOOD_CELL-FIELDNAME
I_ROW_ID    = LF_GOOD_CELL-ROW_ID.
ENDIF.
ENDIF.

*     送信数量
WHEN 'MENGE_SEND'.
L_QUANTITY = LF_GOOD_CELL-VALUE.
IF L_QUANTITY > LF_ALV_0100-MENGE_KANO.
*         送信数量が送信可能数量を超えている為、送信できません
CALL METHOD IR_DATA_CHANGED->ADD_PROTOCOL_ENTRY
EXPORTING
I_MSGID     = 'Z1'
I_MSGTY     = 'E'
I_MSGNO     = '629'
I_FIELDNAME = LF_GOOD_CELL-FIELDNAME
I_ROW_ID    = LF_GOOD_CELL-ROW_ID.
ENDIF.

WHEN OTHERS.
ENDCASE.

ENDLOOP.

* エラーメッセージ表示・非表示
IF IR_DATA_CHANGED->MT_PROTOCOL[] IS INITIAL.
*   エラーなしの場合、非表示
CALL METHOD OBJ_SPLITTER_CONTAINER->SET_SASH_POSITION
EXPORTING
SASH_POSITION = 100.
ELSE.
*   エラーありの場合、表示する
CALL METHOD OBJ_SPLITTER_CONTAINER->SET_SASH_POSITION
EXPORTING
SASH_POSITION = 62.
SORT IR_DATA_CHANGED->MT_PROTOCOL BY ROW_ID.
READ TABLE IR_DATA_CHANGED->MT_PROTOCOL INTO LF_MSG1 INDEX 1.
LF_CELL-ROW_ID = LF_MSG1-ROW_ID.
LF_CELL-COL_ID = LF_MSG1-FIELDNAME.
CALL METHOD OBJ_GRID->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LF_CELL-ROW_ID
IS_COLUMN_ID = LF_CELL-COL_ID.
CALL METHOD OBJ_GRID->SELECT_TEXT_IN_CURR_CELL.
CALL METHOD CL_GUI_CONTROL=>SET_FOCUS
EXPORTING
CONTROL = OBJ_GRID.
ENDIF.

ENDFORM.                    " CHECK_ALV_INPUT_0100
*&---------------------------------------------------------------------*
*&      Form  GET_NEXT_SEND_ID
*&---------------------------------------------------------------------*
*       送信ID採番
*----------------------------------------------------------------------*
FORM GET_NEXT_SEND_ID CHANGING E_SENDID.

DATA: L_SENDID TYPE ZSD002-SENDID,
L_DATE(8) TYPE C,
L_NO(3) TYPE N.

CLEAR G_RC.
CLEAR  E_SENDID.
L_DATE = SY-DATUM.
* 当日の最大の送信ID取得
SELECT SENDID INTO L_SENDID
FROM ZSD002 UP TO 1 ROWS
WHERE SDDATE = SY-DATUM
ORDER BY SENDID DESCENDING.
ENDSELECT.
IF SY-SUBRC = 0.
SPLIT L_SENDID AT '-' INTO  L_DATE L_NO.
ENDIF.
L_NO = L_NO + 1.
CONCATENATE L_DATE L_NO INTO E_SENDID SEPARATED BY '-'.

ENDFORM.                    " GET_NEXT_SEND_ID
*&---------------------------------------------------------------------*
*&      Form  INSERT_ZSD002
*&---------------------------------------------------------------------*
*       送信ログ登録
*----------------------------------------------------------------------*
*      -->I_SENDID     送信ID
*      -->I_FILENAME   ファイル名
*      -->IT_ALV_0100  送信データテーブル
*----------------------------------------------------------------------*
FORM INSERT_ZSD002 USING    I_SENDID
I_FILENAME
IT_ALV_0100 TYPE TYP_T_ALV_0100.

DATA: LT_ZSD002 TYPE STANDARD TABLE OF ZSD002,
LF_ZSD002 LIKE LINE OF LT_ZSD002.
DATA: LF_ALV_0100 LIKE LINE OF IT_ALV_0100.

LOOP AT IT_ALV_0100 INTO LF_ALV_0100.
CLEAR LF_ZSD002.
LF_ZSD002-SENDID = I_SENDID.	" 送信ID
LF_ZSD002-VBELN = LF_ALV_0100-VBELN.		" 販売伝票
LF_ZSD002-POSNR = LF_ALV_0100-POSNR.		" 販売伝票明細
LF_ZSD002-NRFLG = G_ORDER_TYPE.		      " 無償支給フラグ
LF_ZSD002-KUNNR = LF_ALV_0100-KUNNR.		" 得意先コード
LF_ZSD002-MATNR = LF_ALV_0100-MATNR.		" 品目コード
LF_ZSD002-MENGE = LF_ALV_0100-NUMSC.		" 数量
LF_ZSD002-NETPR = LF_ALV_0100-VNETPR.		" 単価
LF_ZSD002-WAERK = LF_ALV_0100-WAERK.		" 販売伝票通貨
LF_ZSD002-VSTEL = LF_ALV_0100-VSTEL.		" 出荷ポイント
LF_ZSD002-PIKNO = LF_ALV_0100-ZNO.		" ピッキング番号
LF_ZSD002-ASNNO = LF_ALV_0100-ASNNO.		" ASN番号
LF_ZSD002-KWMENG = LF_ALV_0100-KWMENG.	" 受注数量（全数）
LF_ZSD002-VDATU = LF_ALV_0100-VDATU.		" 納入期日
LF_ZSD002-SYKSJBKU = LF_ALV_0100-ETC.	      " 出荷指示備考
LF_ZSD002-NOHINTP = LF_ALV_0100-ZS01.		" 納品書種別
LF_ZSD002-TRMTYP = LF_ALV_0100-YUSOUTOU.	" 輸送手段等
LF_ZSD002-SYOHIN = LF_ALV_0100-SYOHIN.	" 商品名
LF_ZSD002-PRODUCT = LF_ALV_0100-SEIHIN.	" 製品
LF_ZSD002-SDMENG = LF_ALV_0100-MENGE_SEND.	" 送信数量
LF_ZSD002-SENDFL = I_FILENAME.		      " 送信ファイル名
LF_ZSD002-SDDATE = SY-DATUM.                " 送信日
LF_ZSD002-SDTIME = SY-UZEIT.                " 送信時刻
LF_ZSD002-SDNAME = SY-UNAME.                " 送信ユーザ
APPEND LF_ZSD002 TO LT_ZSD002.
ENDLOOP.

CLEAR G_RC.
INSERT ZSD002 FROM TABLE LT_ZSD002 ACCEPTING DUPLICATE KEYS.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
*   ファイル削除
PERFORM REMOVE_FILE.
G_RC = CNS_RC_CODE_DB_ERROR.
*   ファイル送信でエラーが発生しました
MESSAGE S637.
ENDIF.

ENDFORM.                    " INSERT_ZSD002
*&---------------------------------------------------------------------*
*&      Form  OPEN_FILE
*&---------------------------------------------------------------------*
*       ファイルOPEN
*----------------------------------------------------------------------*
*      -->I_FILENAME  ファイル名
*----------------------------------------------------------------------*
FORM OPEN_FILE USING    I_FILENAME.

CLEAR G_RC.
OPEN DATASET I_FILENAME FOR OUTPUT IN TEXT MODE.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
PERFORM REMOVE_FILE.
G_RC = CNS_RC_CODE_ERROR.
*   ファイル送信でエラーが発生しました
MESSAGE S637.
ENDIF.

CHECK G_RC = 0.
APPEND I_FILENAME TO GT_FILE_LIST.

ENDFORM.                    " OPEN_FILE
*&---------------------------------------------------------------------*
*&      Form  CLOSE_FILE
*&---------------------------------------------------------------------*
*       ファイルCLOSE
*----------------------------------------------------------------------*
*      -->I_FILENAME  ファイル名
*----------------------------------------------------------------------*
FORM CLOSE_FILE USING    I_FILENAME.

CLOSE DATASET I_FILENAME.

ENDFORM.                    " CLOSE_FILE
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_TO_FILE
*&---------------------------------------------------------------------*
*       送信ファイル出力
*----------------------------------------------------------------------*
*      -->I_FILENAME   ファイル名
*      -->I_SENDID     送信ID
*      -->IT_ALV_0100  送信データテーブル
*----------------------------------------------------------------------*
FORM OUTPUT_TO_FILE USING    I_FILENAME
I_SENDID
IT_ALV_0100 TYPE TYP_T_ALV_0100.

DATA: LF_PICKING_LIST TYPE TYP_PICKING_LIST.
DATA: LF_ALV_0100 LIKE LINE OF IT_ALV_0100.
DATA: L_LINE_STRING(1000) TYPE C.
DATA: L_WAVWR TYPE ZSNETPR111.

LOOP AT IT_ALV_0100 INTO LF_ALV_0100.
CLEAR LF_PICKING_LIST.
*2007/08/31 MOD START
*    LF_PICKING_LIST-KUNNR = LF_ALV_0100-KUNNR.	" 得意先コード
*   前ゼロを取って出力
PERFORM CONV_ALPHA_OUTPUT USING    LF_ALV_0100-KUNNR
CHANGING LF_PICKING_LIST-KUNNR.
*2007/08/31 MOD END
LF_PICKING_LIST-KNAME = LF_ALV_0100-KNAME.	" 得意先名
LF_PICKING_LIST-EDATU = LF_ALV_0100-EDATU.	" 希望納期
LF_PICKING_LIST-BSTNK = LF_ALV_0100-BSTNK.	" 得意先発注番号
LF_PICKING_LIST-ZAI = LF_ALV_0100-ZAI.	" 在
* {{{{{ 2007/10/30 MODIFY -----
*    LF_PICKING_LIST-MATNR = LF_ALV_0100-MATNR.	" 品目コード
WRITE LF_ALV_0100-MATNR TO LF_PICKING_LIST-MATNR
USING EDIT MASK '==MATN1'.
* ----- 2007/10/30 MODIFY }}}}}
LF_PICKING_LIST-ARKTX = LF_ALV_0100-ARKTX.	" 品名
LF_PICKING_LIST-LGPBE = LF_ALV_0100-LGPBE.	" 棚番
LF_PICKING_LIST-NUMMS = LF_ALV_0100-NUMMS.	" 未出荷数量
LF_PICKING_LIST-NUMSC = LF_ALV_0100-MENGE_SEND. " 送信数量
* {{{{{ 2007/10/30 MODIFY -----
*    LF_PICKING_LIST-VBELN = LF_ALV_0100-VBELN.	" 受注番号
WRITE LF_ALV_0100-VBELN TO LF_PICKING_LIST-VBELN
USING EDIT MASK '==ALPHA'.
* ----- 2007/10/30 MODIFY }}}}}
* {{{{{ 2007/10/30 MODIFY -----
LF_PICKING_LIST-POSNR = LF_ALV_0100-POSNR.	" 受注明細番号
*    WRITE LF_ALV_0100-POSNR TO LF_PICKING_LIST-POSNR.
*    SHIFT LF_PICKING_LIST-POSNR LEFT DELETING LEADING '0'.
* ----- 2007/10/30 MODIFY }}}}}
LF_PICKING_LIST-ETC = LF_ALV_0100-ETC.	" 出荷指示備考
LF_PICKING_LIST-LTX01 = LF_ALV_0100-LTX01.	" 得意先品目テキスト
CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
EXPORTING
INPUT  = LF_ALV_0100-AUART
IMPORTING
OUTPUT = LF_PICKING_LIST-AUART. " 伝票タイプ
LF_PICKING_LIST-ZS01 = LF_ALV_0100-ZS01.	" 納品書種別
LF_PICKING_LIST-KDMAT = LF_ALV_0100-KDMAT.	" 得意先品目コード
LF_PICKING_LIST-VNETPR = LF_ALV_0100-VNETPR." 受注単価_小数点4桁
LF_PICKING_LIST-NETWR = LF_ALV_0100-NETWR.	" 受注金額
LF_PICKING_LIST-WAERK = LF_ALV_0100-WAERK.	" 通貨コード
LF_PICKING_LIST-EBELN = LF_ALV_0100-EBELN.	" 発注番号
CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
EXPORTING
INPUT  = LF_ALV_0100-VRKME
IMPORTING
OUTPUT = LF_PICKING_LIST-VRKME
EXCEPTIONS
OTHERS = 0.
L_WAVWR = LF_ALV_0100-WAVWR.	" 原価.
LF_PICKING_LIST-WAVWR = L_WAVWR.
LF_PICKING_LIST-YUSOUTOU = LF_ALV_0100-YUSOUTOU." 輸送手段等
LF_PICKING_LIST-MENGE = LF_ALV_0100-MENGE.	" 発注数量
CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
EXPORTING
INPUT  = LF_ALV_0100-MEINS
IMPORTING
OUTPUT = LF_PICKING_LIST-MEINS
EXCEPTIONS
OTHERS = 0.
LF_PICKING_LIST-HERKL = LF_ALV_0100-HERKL.	" 原産地
LF_PICKING_LIST-STAWN = LF_ALV_0100-STAWN.	" HS-CODE
LF_PICKING_LIST-SYOHIN = LF_ALV_0100-SYOHIN.	" 商品名
LF_PICKING_LIST-SEIHIN = LF_ALV_0100-SEIHIN.	" 製品
LF_PICKING_LIST-PRAT1 = LF_ALV_0100-PRAT1.	" 危険品区分
LF_PICKING_LIST-STOFF = LF_ALV_0100-STOFF.	" 危険物コード
LF_PICKING_LIST-PRAT2 = LF_ALV_0100-PRAT2.	" 非該当
LF_PICKING_LIST-NTGEW = LF_ALV_0100-NTGEW. " 単重量
LF_PICKING_LIST-WARES_EU = LF_ALV_0100-WARES_EU." 仲介通貨コード
LF_PICKING_LIST-KWERT_EU = LF_ALV_0100-KWERT_EU.	" 仲介単価
*2007/08/31 MOD START
*   LF_PICKING_LIST-KUNNR_EU = LF_ALV_0100-KUNNR_EU." エンドユーザコード
*   前ゼロを取って出力
PERFORM CONV_ALPHA_OUTPUT USING    LF_ALV_0100-KUNNR_EU
CHANGING LF_PICKING_LIST-KUNNR_EU.
*2007/08/31 MOD END
LF_PICKING_LIST-KNAME_EU = LF_ALV_0100-KNAME_EU." エンドユーザ名
LF_PICKING_LIST-MUSYO = LF_ALV_0100-MUSYO.	" 無償支給区分
LF_PICKING_LIST-ASNNO = LF_ALV_0100-ASNNO.	" ASN番号
LF_PICKING_LIST-SENDID = I_SENDID.	" 送信ID
*   行編集
PERFORM EDIT_FILE_LINE USING    LF_PICKING_LIST
CHANGING L_LINE_STRING.
TRANSFER L_LINE_STRING TO I_FILENAME.
ENDLOOP.

ENDFORM.                    " OUTPUT_TO_FILE
*&---------------------------------------------------------------------*
*&      Form  EDIT_FILE_LINE
*&---------------------------------------------------------------------*
*       行編集
*----------------------------------------------------------------------*
*      -->IF_STRUCTURE   構造
*      <--E_LINE_STRING  行
*----------------------------------------------------------------------*
FORM EDIT_FILE_LINE USING    IF_STRUCTURE
CHANGING E_LINE_STRING.

CONSTANTS: CNS_TAB_CHAR TYPE X VALUE '09'.
DATA: L_INDEX TYPE SY-INDEX.
FIELD-SYMBOLS: <F_FIELD> TYPE C.

CLEAR E_LINE_STRING.
DO.
L_INDEX = SY-INDEX.
ASSIGN COMPONENT L_INDEX OF STRUCTURE IF_STRUCTURE TO <F_FIELD>.
IF SY-SUBRC <> 0.
EXIT.
ENDIF.
IF L_INDEX = 1.
E_LINE_STRING = <F_FIELD>.
ELSE.
*     <TAB>区切り
CONCATENATE E_LINE_STRING <F_FIELD> INTO E_LINE_STRING
SEPARATED BY CNS_TAB_CHAR.
ENDIF.
ENDDO.

ENDFORM.                    " EDIT_FILE_LINE
*&---------------------------------------------------------------------*
*&      Form  CHECK_NO_IS_INPUTED
*&---------------------------------------------------------------------*
*       ピッキング№入力チェック
*----------------------------------------------------------------------*
FORM CHECK_NO_IS_INPUTED.

G_RC = CNS_RC_CODE_ERROR.
LOOP AT GT_ALV_0100 TRANSPORTING NO FIELDS
WHERE NOT ZNO IS INITIAL.
G_RC = 0.
EXIT.
ENDLOOP.

IF G_RC <> 0.
*   送信データが選択されていません
MESSAGE S628.
ENDIF.

ENDFORM.                    " CHECK_NO_IS_INPUTED
*&---------------------------------------------------------------------*
*&      Form  CHECK_GUEST_HAS_NO_DIFFERENT
*&---------------------------------------------------------------------*
*       得意先、エンドユーザ重複チェック
*----------------------------------------------------------------------*
FORM CHECK_GUEST_HAS_NO_DIFFERENT.

TYPES: BEGIN OF TYP_CHECKER,
NO TYPE ZSLIST_V21-ZNO,
KUNNR TYPE ZSLIST_V21-KUNNR,
KUNNR_EU TYPE ZSLIST_V21-KUNNR_EU,
END OF TYP_CHECKER.

DATA: LT_CHECKER TYPE STANDARD TABLE OF TYP_CHECKER,
LF_CHECKER LIKE LINE OF LT_CHECKER.
DATA: LF_ALV_0100 LIKE LINE OF GT_ALV_0100.
DATA: L_COUNT TYPE I.

CLEAR G_RC.
LOOP AT GT_ALV_0100 INTO LF_ALV_0100
WHERE NOT ZNO IS INITIAL.
CLEAR LF_CHECKER.
LF_CHECKER-NO = LF_ALV_0100-ZNO.
LF_CHECKER-KUNNR = LF_ALV_0100-KUNNR.
LF_CHECKER-KUNNR_EU = LF_ALV_0100-KUNNR_EU.
COLLECT LF_CHECKER INTO LT_CHECKER.
ENDLOOP.

SORT LT_CHECKER BY NO.
LOOP AT LT_CHECKER INTO LF_CHECKER.
AT NEW NO.
CLEAR L_COUNT.
ENDAT.
L_COUNT = L_COUNT + 1.
IF L_COUNT > 1.
G_RC = CNS_RC_CODE_ERROR.
EXIT.
ENDIF.
ENDLOOP.

IF G_RC <> 0.
*   異なる得意先、エンドユーザがグルーピングされている為、送信できません
MESSAGE S627.
ENDIF.

ENDFORM.                    " CHECK_GUEST_HAS_NO_DIFFERENT
*&---------------------------------------------------------------------*
*&      Form  CHECK_WAERK_IS_EXIST
*&---------------------------------------------------------------------*
*       通貨コード存在チェック
*----------------------------------------------------------------------*
*      -->I_WAERK  通貨コード
*----------------------------------------------------------------------*
FORM CHECK_WAERK_IS_EXIST USING    I_WAERK.

CLEAR G_RC.
IF NOT ( I_WAERK IN GS_WAERS ).
G_RC = CNS_RC_CODE_NOT_FOUND.
ENDIF.

ENDFORM.                    " CHECK_WAERK_IS_EXIST
*&---------------------------------------------------------------------*
*&      Form  GET_FILE_FULLNAME
*&---------------------------------------------------------------------*
*       ファイル名取得
*----------------------------------------------------------------------*
*      -->I_SENDID    送信ID
*      <--E_FULLNAME  ファイル名
*----------------------------------------------------------------------*
FORM GET_FILE_FULLNAME USING    I_VSTEL
I_KUNNR
I_SENDID
* {{{{{ 2007/10/30 INSERT -----
I_ZNO
* ----- 2007/10/30 INSERT }}}}}
CHANGING E_FULLNAME.

DATA: L_PATH TYPE STRING,
L_SEPARATOR(1) TYPE C.
DATA: L_LENGTH TYPE I,
L_INDEX TYPE I.
* {{{{{ 2007/10/30 INSERT -----
DATA: L_USER_NAME TYPE ADRP-NAME_TEXT.
SELECT SINGLE NAME_TEXT
INTO L_USER_NAME
FROM ADRP
WHERE PERSNUMBER =
( SELECT PERSNUMBER
FROM USR21
WHERE BNAME = SY-UNAME ).

CONDENSE L_USER_NAME NO-GAPS.
* ----- 2007/10/30 INSERT }}}}}

L_PATH = G_PATH.
DESCRIBE FIELD G_PATH LENGTH L_LENGTH.
DO L_LENGTH TIMES.
L_INDEX = SY-INDEX.
SHIFT L_PATH CIRCULAR RIGHT.
L_SEPARATOR = L_PATH(1).
IF L_SEPARATOR = '\' OR L_SEPARATOR = '/'.
EXIT.
ENDIF.
ENDDO.
IF L_SEPARATOR = '\' OR L_SEPARATOR = '/'.
SHIFT L_PATH CIRCULAR LEFT BY L_INDEX PLACES.
IF L_INDEX > 1.
CONCATENATE L_PATH L_SEPARATOR INTO L_PATH.
ENDIF.
ELSE.
CONCATENATE G_PATH '/' INTO  L_PATH.
ENDIF.

* {{{{{ 2007/10/30 MODIFY -----
*  CONCATENATE I_VSTEL I_KUNNR I_SENDID INTO E_FULLNAME
*    SEPARATED BY '_'.
CONCATENATE L_USER_NAME I_ZNO
I_VSTEL I_KUNNR I_SENDID INTO E_FULLNAME
SEPARATED BY '_'.
* ----- 2007/10/30 MODIFY }}}}}
CONCATENATE L_PATH E_FULLNAME '.txt' INTO E_FULLNAME.

ENDFORM.                    " GET_FILE_FULLNAME
*&---------------------------------------------------------------------*
*&      Form  SET_T_RESULT_0100
*&---------------------------------------------------------------------*
*       処理結果出力
*----------------------------------------------------------------------*
FORM SET_T_RESULT_0100.

DATA: LF_RESULT LIKE LINE OF GT_RESULT.
DATA: LF_ALV_0100 LIKE LINE OF GT_ALV_0100.
DATA: L_COUNT TYPE I.

CLEAR GT_RESULT[].

CLEAR LF_RESULT.
LF_RESULT-FORMAT = 'S'.
APPEND LF_RESULT TO GT_RESULT.
CLEAR LF_RESULT.
* 得意先コード
LF_RESULT-LINE+3(16) = TEXT-R03.
* エンドユーザ
LF_RESULT-LINE+19(16) = TEXT-R04.
* 受注伝票
LF_RESULT-LINE+33(12) = TEXT-R05.
* 明細
LF_RESULT-LINE+45(8) = TEXT-R06.
* 品目コード
LF_RESULT-LINE+53(20) = TEXT-R07.
* 数量
LF_RESULT-LINE+73(12) = TEXT-R08.
APPEND LF_RESULT TO GT_RESULT.
LOOP AT GT_ALV_0100 INTO  LF_ALV_0100
WHERE NOT ZNO IS INITIAL.
L_COUNT = L_COUNT + 1.
CLEAR LF_RESULT.
LF_RESULT-LINE+3(16) = LF_ALV_0100-KUNNR.
LF_RESULT-LINE+19(16) = LF_ALV_0100-KUNNR_EU.
LF_RESULT-LINE+33(12) = LF_ALV_0100-VBELN.
LF_RESULT-LINE+45(8) = LF_ALV_0100-POSNR.
LF_RESULT-LINE+53(20) = LF_ALV_0100-MATNR.
LF_RESULT-LINE+73(12) = LF_ALV_0100-MENGE_SEND.
APPEND LF_RESULT TO GT_RESULT.
ENDLOOP.

* XXXXX 件のデータを送信しました
MESSAGE ID 'Z1' TYPE 'S' NUMBER 636
INTO LF_RESULT-LINE WITH L_COUNT.
INSERT LF_RESULT INTO GT_RESULT INDEX 1.

ENDFORM.                    " SET_T_RESULT_0100
*&---------------------------------------------------------------------*
*&      Form  CHECK_ALV_0100
*&---------------------------------------------------------------------*
*       処理対象データチェック
*----------------------------------------------------------------------*
*      -->IF_ALV_0100      処理対象データ
*      <--E_ERROR_FLAG     エラーフラグ
*      <--E_ERROR_MESSAGE  エラーメッセージ
*----------------------------------------------------------------------*
FORM CHECK_ALV_0100 USING    IF_ALV_0100 TYPE TYP_ALV_0100
CHANGING E_ERROR_FLAG
E_ERROR_MESSAGE.

DATA: L_GUEST_CURRENCY TYPE KNVV-WAERS.
DATA: L_USER_NAME TYPE SY-UNAME.

PERFORM LOCK_OBJECT USING    IF_ALV_0100-VBELN
IF_ALV_0100-POSNR
CHANGING L_USER_NAME.
* ユーザ & が編集中です
IF G_RC <> 0.
E_ERROR_FLAG = '0'.
MESSAGE ID 'Z1' TYPE 'S' NUMBER 640 INTO E_ERROR_MESSAGE
WITH L_USER_NAME.
ENDIF.

CHECK E_ERROR_FLAG IS INITIAL.
* 受注通貨が不正
IF IF_ALV_0100-MUSYO = CNS_ORDER_TYPE_NORMAL.
PERFORM GET_GUEST_CURRENCY USING    IF_ALV_0100-KUNNR
CHANGING L_GUEST_CURRENCY.
IF IF_ALV_0100-WAERK NE L_GUEST_CURRENCY.
E_ERROR_FLAG = '1'.
E_ERROR_MESSAGE = TEXT-E01.
ENDIF.
ENDIF.

CHECK E_ERROR_FLAG IS INITIAL.
* エンドユーザ価格通貨が不正
IF NOT IF_ALV_0100-WARES_EU IS INITIAL.
IF NOT IF_ALV_0100-WARES_EU IN GS_WAERS.
E_ERROR_FLAG = '2'.
E_ERROR_MESSAGE = TEXT-E02.
ENDIF.
ENDIF.

CHECK E_ERROR_FLAG IS INITIAL.
* エンドユーザが不正
IF IF_ALV_0100-KUNNR_EU IS INITIAL AND
( NOT IF_ALV_0100-KWERT_EU IS INITIAL ).
E_ERROR_FLAG = '3'.
E_ERROR_MESSAGE = TEXT-E03.
ENDIF.

CHECK E_ERROR_FLAG IS INITIAL.
* エンドユーザ価格が不正
IF IF_ALV_0100-MUSYO = CNS_ORDER_TYPE_NORMAL.
CASE IF_ALV_0100-PSTYV.
WHEN 'ZSEO'.
WHEN 'ZSEK'.
WHEN OTHERS.
IF G_FLG_EU = 'X' AND
*        IF IF_ALV_0100-KWERT_EU IS INITIAL AND
( NOT IF_ALV_0100-KUNNR_EU IS INITIAL ).
E_ERROR_FLAG = '4'.
E_ERROR_MESSAGE = TEXT-E04.
ENDIF.
ENDCASE.
ENDIF.

*  CHECK E_ERROR_FLAG IS INITIAL.
** 危険品区分が不正
*  IF IF_ALV_0100-PRAT1 = '2' AND
*    ( NOT IF_ALV_0100-STOFF IS INITIAL ).
*    E_ERROR_FLAG = '5'.
*    E_ERROR_MESSAGE = TEXT-E05.
*  ENDIF.

ENDFORM.                    " CHECK_ALV_0100
*&---------------------------------------------------------------------*
*&      Form  CHANGE_ALV_DATA_0100
*&---------------------------------------------------------------------*
*       「ENTER」でチェック
*----------------------------------------------------------------------*
FORM CHANGE_ALV_DATA_0100 USING I_VALID.

IF I_VALID = 'X'.
*   変更項目履歴クリア
CLEAR GT_ALV_GOOD_CELL[].
ENDIF.

ENDFORM.                    " CHANGE_ALV_DATA_0100
*&---------------------------------------------------------------------*
*&      Form  LOCK_OBJECT
*&---------------------------------------------------------------------*
*       処理対象データロック
*----------------------------------------------------------------------*
*      -->I_VBELN      伝票番号
*      -->I_POSNR      明細
*      <--E_USER_NAME  ロックしているユーザ名
*----------------------------------------------------------------------*
FORM LOCK_OBJECT USING    I_VBELN
I_POSNR
CHANGING E_USER_NAME.

CLEAR G_RC.
CLEAR E_USER_NAME.
CALL FUNCTION 'ENQUEUE_EZ_ZSD002'
EXPORTING
VBELN          = I_VBELN
POSNR          = I_POSNR
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
E_USER_NAME = SY-MSGV1.
IF SY-SUBRC <> 0.
G_RC = CNS_RC_CODE_DB_ERROR.
ENDIF.

ENDFORM.                    " LOCK_OBJECT
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_OBJECT
*&---------------------------------------------------------------------*
*       処理対象データロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_OBJECT.

DATA: LF_ALV_0100 LIKE LINE OF GT_ALV_0100.

LOOP AT GT_ALV_0100 INTO LF_ALV_0100
WHERE FLG_ERR <> '0'.
CALL FUNCTION 'DEQUEUE_EZ_ZSD002'
EXPORTING
VBELN = LF_ALV_0100-VBELN
POSNR = LF_ALV_0100-POSNR.
ENDLOOP.
COMMIT WORK.

ENDFORM.                    " UNLOCK_OBJECT
*&---------------------------------------------------------------------*
*&      Form  CHECK_FILE_IS_EXIST
*&---------------------------------------------------------------------*
*       出力ファイル存在チェック
*----------------------------------------------------------------------*
FORM CHECK_FILE_IS_EXIST USING I_FULLNAME.

DATA: L_DIR TYPE BTCH0000-TEXT80,
L_FILENAME TYPE  BTCH0000-TEXT80,
L_SEPARATOR(1) TYPE C.
DATA: L_LENGTH TYPE I,
L_INDEX TYPE I.

* ファイル名とパスをSPLITする
L_FILENAME = I_FULLNAME.
DESCRIBE FIELD I_FULLNAME LENGTH L_LENGTH.
DO L_LENGTH TIMES.
L_INDEX = SY-INDEX.
SHIFT L_FILENAME CIRCULAR RIGHT.
L_SEPARATOR = L_FILENAME(1).
IF L_SEPARATOR = '\' OR L_SEPARATOR = '/'.
EXIT.
ENDIF.
ENDDO.
L_DIR = L_FILENAME+L_INDEX.
L_FILENAME = L_FILENAME(L_INDEX).
SHIFT L_FILENAME.

CLEAR G_RC.
* チェック
CALL FUNCTION 'PFL_CHECK_DIRECTORY'
EXPORTING
DIRECTORY                   = L_DIR
FILNAME                     = L_FILENAME
EXCEPTIONS
PFL_DIR_NOT_EXIST           = 1
PFL_PERMISSION_DENIED       = 2
PFL_CANT_BUILD_DATASET_NAME = 3
PFL_FILE_NOT_EXIST          = 4
OTHERS                      = 5.
IF SY-SUBRC <> 0.
G_RC = CNS_RC_CODE_NOT_FOUND.
ENDIF.

ENDFORM.                    " CHECK_FILE_IS_EXIST
*&---------------------------------------------------------------------*
*&      Form  REMOVE_FILE
*&---------------------------------------------------------------------*
*       ファイル削除
*----------------------------------------------------------------------*
FORM REMOVE_FILE.

DATA: L_FILENAME LIKE LINE OF GT_FILE_LIST.

LOOP AT GT_FILE_LIST INTO L_FILENAME.
DELETE DATASET L_FILENAME.
ENDLOOP.

ENDFORM.                    " REMOVE_FILE
