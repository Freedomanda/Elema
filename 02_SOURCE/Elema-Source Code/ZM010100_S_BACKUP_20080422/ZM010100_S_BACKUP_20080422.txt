************************************************************************
* [プログラム名]
*   ZM010100        発注残一覧
*
* [処理概要]
*   ・発注残の管理帳票の出力
*
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2001/10/31   PSD M.Arai        新規開発　
*  2001/11/26   PSD M.Arai        受注番号抽出条件変更対応
*  2001/12/12   PSD M.Arai        直送区分追加対応
*  2001/12/25   PSD M.Arai        ページ番号対応
*  2001/12/25   PSD M.Arai        ヘッダ表示不具合対応
*  2001/12/25   PSD M.Arai        入力チェック方法変更
*  2002/03/11   PSD M.Arai        返品発注対応
*  2002/04/22   PSD T.SAITOH      レポートＩＤ間違いを修正
*  2002/04/24   PSD T.SAITOH      「発注止め」の発注伝票を対象外
*  2002/04/24   PSD T.SAITOH      選択条件の追加
*  2002/04/24   PSD T.SAITOH      発注番号表示編集内容変更
*  2002/05/27   PSD K.ARAI        パフォーマンス対応
*  2002/06/20   PSD T.SAITOH      再移送
*  2002/06/28   PSD T.SAITOH      購買組織追加
*  2002/07/09   PSD T.SAITOH      購買組織（初期値：ユーザーパラメータ）
*  2002/08/08   カットオーバー ----------------------------------------
*  2002/08/09   PSD T.SAITOH      仕入先ではなく手配先を表示する
*  2002/09/06   PSD T.SAITOH      帳票の行間を開けるように変更
*  2003/04/30   NDSC S.IWAKI      パフォーマンス対応
*  2004/01/20   DMC M.SEIWA       ALV化
*  2004/01/26   DMC M.SEIWA       ALVの文字列不具合対応
*  2004/07/13   DMC K.FURUYA      品名の取得先変更(MAKT -> EKPO)
*  2005/02/16   DMC A.MASUDA      登録者名の項目追加
*  2005/07/05   DMC A.MASUDA      登録者出力不具合のバグ修正
*  2005/10/06   DMC A.MASUDA      ７月修正分の不具合のバグ修正
*  2005/10/07   DMC A.MASUDA      バッチインプットデータにもユーザの抽出
*                                 条件の反映を行った
************************************************************************
*---MODIFY START PSD T.SAITOH 2002/04/22 ---------------------------*
* REPORT  zzsttd30_001 NO STANDARD PAGE HEADING
REPORT zm010100 NO STANDARD PAGE HEADING
*---MODIFY END   PSD T.SAITOH 2002/04/22 ---------------------------*
LINE-SIZE  170
LINE-COUNT 58.

************************************************************************
* TYPES
************************************************************************
TYPE-POOLS slis.

* 購買伝票情報
TYPES: BEGIN OF typ_info,
ebeln     TYPE ekko-ebeln,      " 購買伝票番号
bsart     TYPE ekko-bsart,      " 購買伝票タイプ
ekgrp     TYPE ekko-ekgrp,      " 購買グループ
*         LLIEF     TYPE EKKO-LLIEF,     "
bedat     TYPE ekko-bedat,      " 購買伝票日付
lifnr     TYPE ekko-lifnr,      " 仕入先勘定コード
reswk     TYPE ekko-reswk,      " 供給（出庫）プラント
waers     TYPE ekko-waers,      " 通貨
ebelp     TYPE ekpo-ebelp,      " 購買伝票明細番号
werks     TYPE ekpo-werks,      " プラント
matnr     TYPE ekpo-matnr,      " 品目コード
menge     TYPE ekpo-menge,      " 購買発注数量
netpr     TYPE ekpo-netpr,      " 正味価格
peinh     TYPE ekpo-peinh,      " 価格単位
banfn     TYPE ekpo-banfn,      " 購買依頼番号
bnfpo     TYPE ekpo-bnfpo,      " 購買依頼明細番号
knttp     TYPE ekpo-knttp,      " 勘定伝票カテゴリ
*↓APPEND 2001/12/12 PSD M.Arai 直送区分追加対応
evers     TYPE ekpo-evers,      " 出荷指示
*↑APPEND 2001/12/12 PSD M.Arai
name1     TYPE v_t001w-name1,   " プラント名
eknam     TYPE t024-eknam,      " 購買グループテキスト
*---2004/07/13 MOD START
*         maktx     TYPE makt-maktx,      " 品目テキスト
txz01     TYPE ekpo-txz01,      " 品目テキスト
*---2004/07/13 MOD END
*---APPEND START PSD T.SAITOH 2002/08/09 ---------------------------*
ekorg     TYPE ekko-ekorg,      " 購買グループ
*---APPEND END   PSD T.SAITOH 2002/08/09 ---------------------------*
* Add  2005.08.24 --->
LABNR     Type EKPO-LABNR ,     "請書番号
* Add  2005.08.24 <---

END   OF typ_info.

* 帳票出力用データ
TYPES: BEGIN OF typ_write,
werks     TYPE ekpo-werks,      " 部門
name1     TYPE v_t001w-name1,   " 部門名
ekgrp     TYPE ekko-ekgrp,      " 担当者
eknam     TYPE t024-eknam,      " 担当者名
ztehai    TYPE ekko-lifnr,      " 手配先
zname(35) TYPE c,               " 手配先名
eindt     TYPE eket-eindt,      " 発注納期
bedat     TYPE ekko-bedat,      " 発注日
znum(15)  TYPE c,               " 発注番号
matnr     TYPE ekpo-matnr,      " 品目コード
*---2004/07/13 MOD START
*         maktx     TYPE makt-maktx,      " 品目テキスト
txz01     TYPE ekpo-txz01,      " 品目テキスト
*---2004/07/13 MOD END
menge     TYPE ekpo-menge,      " 発注数
wemng     TYPE ekpo-menge,      " 入荷数
zenge     TYPE ekpo-menge,      " 未納数
zans(14)  TYPE c,               " 納期回答
vbeln     TYPE ebkn-vbeln,      " 受注番号
zmny      TYPE p,               " 未納入金額
ebeln     TYPE ekpo-ebeln,      " 伝票番号(ソート用）
ebelp     TYPE ekpo-ebelp,      " 伝票明細(ソート用）
*↓APPEND 2001/12/12 PSD M.Arai 直送区分追加追加対応
evers     TYPE ekpo-evers,      " 直送区分
*↑APPEND 2001/12/12 PSD M.Arai
*---APPEND START DMC A.MASUDA 2005/02/16 ---------------------------*
TNAME(14) TYPE C,               " 担当者名
*---APPEND END   DMC A.MASUDA 2005/02/16 ---------------------------*
* Add  2005.08.24 --->
LABNR     Type EKPO-LABNR ,     "請書番号
* Add  2005.08.24 <---

END   OF typ_write.


*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
TYPES: BEGIN OF typ_nast,
kappl     TYPE nast-kappl,      " アプリケーション
objky     TYPE nast-objky,      " 対象キー
kschl     TYPE nast-kschl,      " メッセージタイプ
spras     TYPE nast-spras,      " メッセージ言語
parnr     TYPE nast-parnr,      " メッセージ取引先
erdat     TYPE nast-erdat,      " パートナー機能
eruhr     TYPE nast-eruhr,      " 登録日
nacha     TYPE nast-nacha,      " 登録時間
vstat     TYPE nast-vstat,      " 処理ステータス
END OF typ_nast.
* NAST内部テーブル
DATA: gt_nast TYPE HASHED TABLE OF typ_nast
WITH UNIQUE KEY kappl
objky
kschl
spras
parnr
erdat
eruhr
nacha
vstat.
DATA gf_nast TYPE typ_nast.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
DATA:G_VBELN LIKE EKKN-VBELN.
DATA:FLG_TEC TYPE C.
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*
************************************************************************
* DATA
************************************************************************
* 内部テーブル
* 伝票情報内部テーブル
DATA: gf_info    TYPE          typ_info,
gt_info    LIKE TABLE OF gf_info.
**2004.01.20 MOD_S SEIWA
* 帳票出力内部テーブル
*DATA: gf_write   TYPE         typ_write,
DATA: gf_write   TYPE          zslist_v20,
gt_write   LIKE TABLE OF gf_write.
**2004.01.20 MOD_E SEIWA

* 納入日程行内部テーブル
DATA: gf_eket    TYPE          eket,
gt_eket    LIKE TABLE OF gf_eket.

* 総合計
DATA: g_sum      TYPE p.
** 2004.01.20 MOD_S seiwa >>>>>>>

*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
* 登録者名内部テーブル
DATA: GF_EKKO    TYPE          EKKO,
GT_EKKO    LIKE TABLE OF GF_EKKO.
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*

*---APPEND START DMC A.MASUDA  2005/10/07 -----------------------------*
* ユーザー名格納用構造
TYPES:
BEGIN OF TYP_NAME,
NAME_TEXT TYPE ADRP-NAME_TEXT,
END   OF TYP_NAME.
* ユーザー名格納用テーブル
DATA:
GT_NAME_TEXT TYPE STANDARD TABLE OF TYP_NAME,
GW_NAME_TEXT TYPE TYP_NAME.
*---APPEND END   DMC A.MASUDA  2005/10/07 -----------------------------*

************************************************************************
* CONSTANTS
************************************************************************
DATA:cns_x(1)       TYPE c VALUE 'X'.
*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
CONSTANTS:CNS_X_2(1)       TYPE C VALUE 'X',
CNS_VE(2)      TYPE C VALUE 'VE',
CNS_BATCH(8)   TYPE C VALUE 'WF-BATCH',
CNS_EDIAD(8)   TYPE C VALUE 'EDIADMIN',
CNS_TEC0000(7) TYPE C VALUE 'TEC0000'.
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*
************************************************************************
* 　DATA　ALV GRID CONTROL
*********************************************************************
* REUSE_ALV_EVENTS_GET 用[一覧タイプに使用可能イベントの返品テーブル]
DATA:g_repid       LIKE sy-repid,                  "現在のプログラムID
g_top_of_page TYPE slis_formname VALUE 'TOP_OF_PAGE',
gf_layout     TYPE slis_layout_alv,          "レイアウト
gf_variant    LIKE disvariant,               "バリアント
gf_print      TYPE slis_print_alv,           "印刷拒否
gf_event      TYPE slis_alv_event,           "イベント設定
g_data        TYPE sy-datum.                 "システム日付

DATA:g_flg_exit(1)  TYPE c VALUE '0'.     " ＬＯＯＰ終了フラグ


*　ALV表示用内部テーブル
DATA:gt_alv        TYPE TABLE OF zslist_v20  WITH HEADER LINE.
DATA:gf_alv        TYPE zslist_v20.

*　イベント設定内部テーブル
DATA:gt_event      TYPE slis_t_event.
** 2004.01.20 MOD_E　seiwa >>>>>>>

************************************************************************
* 選択画面定義
************************************************************************
*↓DELETE 2001/12/25 PSD M.Arai 入力チェック変更対応
*SELECT-OPTIONS: pr_werks FOR gf_info-werks OBLIGATORY,  " プラント
*↑DELETE 2001/12/25 PSD M.Arai

*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
* 購買組織対応
PARAMETERS: pr_ekorg TYPE ekko-ekorg MEMORY ID eko OBLIGATORY."購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*

*↓APPEND 2001/12/25 PSD M.Arai 入力チェック変更対応
SELECT-OPTIONS: pr_werks FOR gf_info-werks,              " プラント
*↑APPEND 2001/12/25 PSD M.Arai
pr_ekgrp FOR gf_info-ekgrp               " 購買グループ
.
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
SELECT-OPTIONS: pr_lifnr FOR gf_info-lifnr,              " 仕入先
pr_eindt FOR gf_eket-eindt               " 納入期日
.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
SELECT-OPTIONS: PR_ERNAM FOR GF_EKKO-ERNAM.          " ユーザーコード
*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*
************************************************************************
* AT SELECTION-SCREEN
************************************************************************
*↓APPEND 2001/12/25 PSD M.Arai 入力チェック変更対応
AT SELECTION-SCREEN.
IF pr_werks IS INITIAL AND
sy-ucomm+0(1) <> '%'.
MESSAGE e006(z1) WITH text-119.
ENDIF.
*↑APPEND 2001/12/25 PSD M.Arai
*---APPEND START DMC A.MASUDA 2005/10/07 ------------------------------*
PERFORM FRM_CHECK_NAME_DATA.
*---APPEND END   DMC A.MASUDA 2005/10/07 ------------------------------*
************************************************************************
* START-OF-SELECTION
************************************************************************
START-OF-SELECTION.
*　2004.01.20　MOD_S
*--- 初期処理
PERFORM frm_init.
*　2004.01.20　MOD_E

* 対象データ抽出処理
PERFORM frm_get_data.
* 帳票出力用内部テーブル作成処理
PERFORM frm_make_data.
*2004.01.20 DELETE_S
* 帳票出力処理
*  PERFORM frm_write_data.
*2004.01.20 DELETE_E

*---2004.01.20 MOD_S
* ALV 帳票出力
PERFORM write_out.
*--2004.01.20　MOD_E
************************************************************************
* TOP-OF-PAGE
***********************************************************************
*--2004.01.20　MOD_S "動的コール
FORM frm_top_of_page.
*TOP-OF-PAGE.
*--- ヘッダー出力処理
*--　ALV　の場合
*
WRITE:   42      text-100,            " 表題
92      text-101,            " 作成日時
101     sy-datum DD/MM/YY,   " 日付
110     sy-uzeit+0(2),       " 時間
112     ':',
113     sy-uzeit+2(2),       " 分
150     text-118,            " PAGE
156(6)  sy-pagno,
/92      text-102,            " 部門
97(4)   gt_alv-werks,        " 部門コード
103(20) gt_alv-name1,      " 部門名
126     text-103,
133(4)  gt_alv-ekgrp,      " 担当者コード
138(18) gt_alv-eknam.      " 担当者名

WRITE:  /97(26)  sy-uline,
133(23) sy-uline.





**2004.01.20 DELETE＿S
**--　帳票　の場合
*  FORMAT COLOR OFF.
*  WRITE:   42      text-100,
*           92      text-101,
*           101     sy-datum DD/MM/YY,   " 日付
*           110     sy-uzeit+0(2),       " 時間
*           112     ':',
*           113     sy-uzeit+2(2),       " 分
**↓APPEND 2001/12/25 PSD M.Arai ページ番号対応
*           150     text-118,
*           156(6)  sy-pagno,
**↑APPEND 2001/12/25 PSD M.Arai
*          /92      text-102,
*           97(4)   gf_write-werks,      " 部門コード
*           103(20) gf_write-name1,      " 部門名
*           126     text-103,
*           133(4)  gf_write-ekgrp,      " 担当者コード
*           138(18) gf_write-eknam.      " 担当者名
*  FORMAT COLOR OFF.
*
*  WRITE:  /97(26)  sy-uline,
*           133(23) sy-uline.
*
*  FORMAT COLOR 1 ON.
*
*  WRITE:  /1       text-104,
*           11      text-106,
*           20      text-107,
*           36      text-108,
*           55      text-109,
*           98      text-110,
*           109     text-111,
*           120     text-112,
*           130     text-113,
*           144     text-114,
**↓APPEND 2001/12/12 M.Arai 直送区分追加対応
*           154     text-117.
**↑APPEND 2001/12/12 M.Arai
**↓DELETE 2001/12/12 M.Arai 直送区分追加対応
**           155     ' '.
**↑DELETE 2001/12/12 M.Arai
*
*  FORMAT COLOR OFF.
**↓APPEND 2001/12/12 M.Arai 直送区分追加対応
*  WRITE: /1(161) sy-uline.
**↑APPEND 2001/12/12 M.Arai
*
**↓DELETE 2001/12/12 M.Arai 直送区分追加対応
**  WRITE: /1(155)  sy-uline.
**↑DELETE 2001/12/12 M.Arai
*  FORMAT COLOR OFF.
*ENDIF.
*
*2004.01.20　DELETE_E
ENDFORM.
*2004.01.20 MOD_E
************************************************************************
* Form
***********************************************************************
*  2004.01.20 MOD_S
*&---------------------------------------------------------------------*
*& **** Form  FRM_INIT  ALV CALLER_EXIT 動的コール
*&---------------------------------------------------------------------*
FORM frm_caller_exit USING rs_data TYPE slis_data_caller_exit.
rs_data-callback_header_transport = 'FILITEXTS_TEXT_TRANSPORT'.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  FRM_INIT  初期処理
*&---------------------------------------------------------------------*
FORM frm_init.
g_repid             = sy-repid.   " プログラムＩＤ取得
g_data              = sy-datum.   " システム日付取得
ENDFORM.                    " FRM_INIT
*---2004.01.20 MOD_E
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_data
*&---------------------------------------------------------------------*
*       対象データ抽出処理
*----------------------------------------------------------------------*
FORM frm_get_data.

SELECT
a~ebeln   a~bsart   a~ekgrp   a~lifnr   a~bedat
a~reswk   a~waers
b~ebelp   b~werks   b~matnr   b~menge   b~netpr
*    b~peinh   b~banfn   b~bnfpo   b~knttp
*↓APPEND 2001/12/12 PSD M.Arai 直送区分追加のため
b~peinh   b~banfn   b~bnfpo   b~knttp   b~evers
*↑APPEND 2001/12/12 PSD M.Arai
c~eknam
*2004/07/13 MOD START
*    d~maktx   d~matnr
b~txz01   d~matnr
*2004/07/13 MOD END
e~name1
*---APPEND START PSD T.SAITOH 2002/08/09 ---------------------------*
a~ekorg "購買組織
*---APPEND END   PSD T.SAITOH 2002/08/09 ---------------------------*
* Add 2005.08.24 --->
b~LABNR
* Add 2005.08.24 <---
INTO CORRESPONDING FIELDS OF TABLE gt_info
FROM  ( ( ( ekko AS a INNER JOIN ekpo AS b
ON     a~ebeln  = b~ebeln ) LEFT OUTER JOIN t024      AS c
ON     a~ekgrp  = c~ekgrp ) INNER      JOIN makt      AS d
ON     b~matnr  = d~matnr ) LEFT OUTER JOIN t001w     AS e
ON     b~werks  = e~werks
*---APPEND START PSD T.SAITOH 2002/06/28 ---------------------------*
*    WHERE    a~ekgrp IN pr_ekgrp
WHERE    a~ekorg = pr_ekorg  "購買組織
AND      a~ekgrp IN pr_ekgrp
*---APPEND END   PSD T.SAITOH 2002/06/28 ---------------------------*
AND      b~werks IN pr_werks
AND    ( b~knttp = ''
OR       b~knttp = 'M' )
AND      b~elikz = ''
AND      b~loekz = ''
AND      a~loekz = ''
AND      d~spras = 'J'
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
AND      a~lifnr IN pr_lifnr
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
.

* エラー処理
CASE sy-subrc.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE s600(z1) WITH text-006.
STOP.
WHEN 8.    " システムエラー
MESSAGE a603(z1) WITH text-002 text-003 sy-subrc.
STOP.
ENDCASE.

ENDFORM.                    " FRM_GET_data
*
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*       帳票出力用内部テーブル作成処理
*----------------------------------------------------------------------*
FORM frm_make_data.
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
DATA : l_nodata_from_eket TYPE c."納入日程行データ無し時のリターン
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

LOOP AT gt_info INTO gf_info.
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
* NASTに発注止めが存在した場合対象外とする
PERFORM frm_nast_check.
IF sy-subrc = 0.
CONTINUE.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

* 購買伝票情報テーブルを帳票出力用内部テーブルに設定
MOVE-CORRESPONDING gf_info TO gf_write.

* ↓ APPEND 2002.03.12 PSD M.ARAI 返品発注対応
* 発注数量の設定
PERFORM frm_set_menge.
* ↑

* 手配先名称の設定
PERFORM frm_set_tehainame.

* 発注納期、入荷数の設定
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
*    PERFORM frm_set_noki_inptdata.
CLEAR l_nodata_from_eket.
PERFORM frm_set_noki_inptdata CHANGING l_nodata_from_eket.
IF l_nodata_from_eket <> 0.
CONTINUE.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

* 未納数の設定
PERFORM frm_set_minou.

* 発注番号の設定
PERFORM frm_set_hnum.

* 納期回答の設定
PERFORM frm_set_ans.

* 受注番号の設定
PERFORM frm_set_jnum.

* 未納入金額の設定
PERFORM frm_set_minounyuu.

*---APPEND START DMC A.MASUDA  2005/02/16 ---------------------------*
* 販売管理伝票番号の設定
PERFORM FRM_SET_VBELN USING    GF_INFO-EBELN          " 購買伝票
GF_INFO-EBELP          " 購買伝票明細
CHANGING G_VBELN.               " 販売管理伝票
* 販売管理伝票番号、明細が存在しない場合は、在庫品で処理
IF G_VBELN = SPACE.
* 購買伝票ヘッダ(EKKO)の登録者から担当者名の取得
PERFORM FRM_SET_EKKO_ERNAM USING    GF_INFO-EBELN   " 購買伝票
CHANGING GF_WRITE-TNAME. " 担当者名
* 販売管理伝票番号、明細が存在した場合は、個別購買で処理
ELSE.
* 販売伝票ヘッダ(VBAK)の登録者から担当者名の取得
PERFORM FRM_SET_VBAK_ERNAM USING    G_VBELN         " 販売管理伝票
CHANGING GF_WRITE-TNAME. " 担当者名
* 取得された担当者名が 'WF-BATCH' の場合
IF GF_WRITE-TNAME+0(8) = CNS_BATCH
OR GF_WRITE-TNAME+0(8) = CNS_EDIAD
*---APPEND START DMC A.MASUDA 2005/10/06 ---------------------------*
OR GF_WRITE-TNAME+0(7) = CNS_TEC0000.
*---APPEND END   DMC A.MASUDA 2005/10/06 ---------------------------*
CLEAR:GF_WRITE-TNAME.
* 営業員コードから担当者名の取得
PERFORM FRM_SET_PERNR USING    G_VBELN            " 販売管理伝票
CHANGING GF_WRITE-TNAME.    " 担当者名
ENDIF.
ENDIF.
* 担当者名取得時
IF ( GF_WRITE-TNAME <> SPACE ) OR
( GF_WRITE-TNAME = SPACE    AND FLG_TEC = CNS_X_2 ).
* 帳票用内部テーブルにレコード追加
APPEND gf_write TO gt_write.
ENDIF.

*---APPEND END   DMC A.MASUDA  2005/02/16 ---------------------------*

* 帳票用内部テーブルにレコード追加
*    APPEND gf_write TO gt_write.

CLEAR gf_info.
CLEAR gf_write.
ENDLOOP.

* ソート処理
SORT gt_write ASCENDING BY werks   " 部門
ekgrp   " 担当者
ztehai  " 手配先
eindt   " 発注納期
bedat   " 発注日
ebeln   " 発注番号
ebelp   " 明細番号
*                             znum.   " 発注番号
.

ENDFORM.                    " FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*&      Form  frm_write_data
*&---------------------------------------------------------------------*
*       帳票出力処理
*----------------------------------------------------------------------*
*FORM frm_write_data.
*2004.01.20 DELETE_S
*  DATA: lf_break_point(17) TYPE c,              " ﾌﾞﾚｲｸﾎﾟｲﾝﾄ判別用項目
*        lf_tmp_break_point LIKE lf_break_point, " テンプ
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        tmp_write LIKE gf_write,
*        gf_write_org LIKE gf_write.
**↑APPEND 2001/12/25 PSD M.Arai

*
**---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
** ０件処理追加
*  DATA: l_cnt_rec TYPE i."出力用内部テーブルレコード件数
*  DESCRIBE TABLE gt_write LINES l_cnt_rec.
*  IF l_cnt_rec = 0.
*    MESSAGE s600(z1) WITH text-006.
*    STOP.
*  ENDIF.
**---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
*

** 帳票出力処理
*  LOOP AT gt_write INTO gf_write.
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*    gf_write_org = gf_write.
**↑APPEND 2001/12/25 PSD M.Arai
*
** ブレイクポイント判別用項目設定
*    lf_break_point+0(4)  = gf_write-werks.   " 部門
*    lf_break_point+4(3)  = gf_write-ekgrp.   " 担当者
*    lf_break_point+7(10) = gf_write-ztehai.  " 手配先
*
*    IF sy-tabix <> 1.
** 担当者ブレイク時
*      IF lf_break_point+0(7) <> lf_tmp_break_point+0(7).
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = tmp_write.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_break_tehai.       " 手配先合計出力
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = gf_write_org.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_break_tanto.       " 改ページ
*        PERFORM frm_write_tehai.       " 手配先ヘッダ出力
** 手配先ブレイク時
*      ELSEIF lf_break_point <> lf_tmp_break_point.
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = tmp_write.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_break_tehai.       " 手配先合計出力
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*        gf_write = gf_write_org.
**↑APPEND 2001/12/25 PSD M.Arai
*        PERFORM frm_write_tehai.       " 手配先ヘッダ出力
*      ENDIF.
*    ELSE.
*      PERFORM frm_write_tehai.          " 手配先ヘッダ出力
*    ENDIF.
*
** 明細行出力
*    PERFORM frm_write_meisai.
*
*    lf_tmp_break_point = lf_break_point. " ブレイク項目の退避
**↓APPEND 2001/12/25 PSD M.Arai ヘッダ表示不具合修正対応
*    tmp_write = gf_write.
**↑APPEND 2001/12/25 PSD M.Arai
* ENDLOOP.


*  PERFORM frm_break_tehai.   " 手配先合計出力

*ENDFORM.                    " frm_write_data
*--2004.01.20 DELETE_E

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_TEHAINAME
*&---------------------------------------------------------------------*
*       手配先名取得
*----------------------------------------------------------------------*
FORM frm_set_tehainame.

* 購買伝票タイプによる手配先名抽出処理
* ↓ MODIFY 2002.03.12 PSD M.ARAI 返品発注対応
*  IF gf_info-bsart = 'NB'.
IF gf_info-bsart = 'NB' OR
gf_info-bsart = 'ZB'.
* ↑
" 仕入先コード設定
CALL FUNCTION 'Z_MZERO_DELETE'
EXPORTING
change_string = gf_info-lifnr
IMPORTING
string        = gf_write-ztehai.
.

*---APPEND START PSD T.SAITOH 2002/08/09 ---------------------------*
* カットオーバー後仕様変更：EKPAから取引先機能OA(BA・・DB上)で取得
* 手配先を取得
SELECT SINGLE lifn2
INTO gf_info-lifnr
FROM ekpa
WHERE ebeln = gf_info-ebeln
AND ebelp = 0
AND ekorg = gf_info-ekorg
AND parvw = 'BA'."手配先'OA':ＤＢ上は'BA'
*   エラー処理
CASE sy-subrc.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE a603(z1) WITH text-002 'EKPA' sy-subrc.
ENDCASE.
*---APPEND END   PSD T.SAITOH 2002/08/09 ---------------------------*

*    " 仕入先マスタ抽出処理
SELECT SINGLE name1 FROM lfa1
INTO gf_write-zname
WHERE lifnr = gf_info-lifnr.
* エラー処理
CASE sy-subrc.
WHEN 0.
WHEN 4.
MESSAGE s600(z1) WITH text-007.
WHEN OTHERS.
MESSAGE a603(z1) WITH text-002 text-004 sy-subrc.
ENDCASE.

ELSE.
"プラントコード設定
gf_write-ztehai = gf_info-reswk.

" プラント抽出処理
SELECT SINGLE name1
INTO gf_write-zname
FROM t001w
WHERE werks = gf_info-reswk.

* エラー処理
CASE sy-subrc.
WHEN 0.
WHEN 4.
MESSAGE s600(z1) WITH text-008.
WHEN OTHERS.
MESSAGE a603(z1) WITH text-002 text-005 sy-subrc.
ENDCASE.

ENDIF.


ENDFORM.                    " FRM_SET_TEHAINAME
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_NOKI_INPTDATA
*&---------------------------------------------------------------------*
*       納期、入荷数の設定
*----------------------------------------------------------------------*
* <-- NODATA_FROM_EKET EKETテーブル読込みのリターン値
*----------------------------------------------------------------------*
FORM frm_set_noki_inptdata CHANGING p_nodata_from_eket.

DATA: l_sum TYPE eket-wemng.

* 納期、入庫数量の取得
SELECT wemng eindt FROM eket
INTO CORRESPONDING FIELDS OF TABLE gt_eket
WHERE ebeln = gf_info-ebeln
AND   ebelp = gf_info-ebelp
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
AND   eindt IN pr_eindt
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*
.

CASE sy-subrc.
WHEN 0.
WHEN 4.
*---MODIFY START PSD T.SAITOH 2002/04/24 ---------------------------*
*      MESSAGE s600(z1) WITH text-009.
p_nodata_from_eket = sy-subrc.
EXIT.
*---MODIFY END   PSD T.SAITOH 2002/04/24 ---------------------------*
WHEN OTHERS.
MESSAGE a603(z1) WITH text-002 text-010 sy-subrc.
ENDCASE.

* 総入庫数の設定処理
LOOP AT gt_eket INTO gf_eket.
l_sum = l_sum + gf_eket-wemng.
ENDLOOP.
* ↓ MODIFY 2002.03.12 PSD M.ARAI 返品発注対応
*  gf_write-wemng = l_sum.
IF gf_info-bsart = 'ZB'.
gf_write-wemng = l_sum * ( -1 ).   " 返品発注
ELSE.
gf_write-wemng = l_sum.            " 通常
ENDIF.
* ↑
* 明細納入期日の設定
READ TABLE gt_eket INTO gf_eket INDEX 1.
gf_write-eindt = gf_eket-eindt.

ENDFORM.                    " FRM_SET_NOKI_INPTDATA
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MINOU
*&---------------------------------------------------------------------*
*       未納数の設定
*----------------------------------------------------------------------*
FORM frm_set_minou.

gf_write-zenge = gf_write-menge - gf_write-wemng.

ENDFORM.                    " FRM_SET_MINOU
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_HNUM
*&---------------------------------------------------------------------*
*       発注番号の設定
*----------------------------------------------------------------------*
FORM frm_set_hnum.

*---MODIFY START PSD T.SAITOH 2002/04/24 ---------------------------*
gf_write-znum+0(2)  = gf_info-werks+1(2).  "プラント
gf_write-znum+2(1)  = '-'.
*  gf_write-znum+3(8)  = gf_info-ebeln+2(8).  "購買伝票番号
gf_write-znum+3(10)  = gf_info-ebeln.      "購買伝票番号
*  gf_write-znum+11(1) = '-'.
*  gf_write-znum+12(3) = gf_info-ebelp+2(3).  "購買伝票明細番号
gf_write-znum+13(1) = '-'.
gf_write-znum+14(1) = gf_info-ebelp+3(1).  "購買伝票明細番号
*---MODIFY END   PSD T.SAITOH 2002/04/24 ---------------------------*

ENDFORM.                    " FRM_SET_HNUM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_ANS
*&---------------------------------------------------------------------*
*       納期回答の設定
*----------------------------------------------------------------------*
FORM frm_set_ans.

DATA: l_name   TYPE thead-tdname,
lt_tline TYPE TABLE OF tline,
lf_tline TYPE          tline.

* テキスト名称の設定
CONCATENATE gf_info-ebeln gf_info-ebelp INTO l_name.

* 納期回答情報の取得
CALL FUNCTION 'READ_TEXT'
EXPORTING
*      CLIENT                        = SY-MANDT
id                            = 'F04'
language                      = 'J'
name                          = l_name
object                        = 'EKPO'
*     ARCHIVE_HANDLE                = 0
*     LOCAL_CAT                     = ' '
*   IMPORTING
*     HEADER                        =
TABLES
lines                         = lt_tline
EXCEPTIONS
id                            = 1
language                      = 2
name                          = 3
not_found                     = 4
object                        = 5
reference_check               = 6
wrong_access_to_archive       = 7
OTHERS                        = 8
.
CASE sy-subrc.
WHEN 0 OR 4.
WHEN OTHERS.
MESSAGE s001(z1) WITH text-011 sy-subrc.
ENDCASE.

* 納期回答の設定
READ TABLE lt_tline INTO lf_tline INDEX 1.
gf_write-zans+0(1)  = '('.
gf_write-zans+1(12) = lf_tline-tdline+0(12).
gf_write-zans+13(1) = ')'.

ENDFORM.                    " FRM_SET_ANS
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_JNUM
*&---------------------------------------------------------------------*
*       受注番号の設定
*----------------------------------------------------------------------*
FORM frm_set_jnum.

IF gf_info-knttp = 'M'.

* ↓DELETE 2001/11/26 PSD M.Arai 受注番号抽出条件変更対応
*    SELECT SINGLE vbeln FROM ebkn
*      INTO CORRESPONDING FIELDS OF gf_write
*      WHERE banfn = gf_info-banfn
*      AND   bnfpo = gf_info-bnfpo
*      AND   zebkn = '01'
*      AND   loekz = ''.
* ↑DELETE 2001/11/26 PSD M.Arai

* ↓APPEND 2001/11/26 PSD M.Arai
*---2003/04/30 UPDATE START S.IWAKI(NDSC)
*    SELECT SINGLE a~vbeln
*      INTO CORRESPONDING FIELDS OF gf_write
*      FROM ebkn AS a INNER JOIN eban AS b
*      ON   a~banfn = b~banfn
*      AND  a~bnfpo = b~bnfpo
*      WHERE b~ebeln = gf_info-ebeln
*      AND   b~ebelp = gf_info-ebelp
*      AND   a~zebkn = '01'
*      AND   a~loekz = ''.
SELECT SINGLE a~vbeln
INTO CORRESPONDING FIELDS OF gf_write
FROM ( ebkn AS a INNER JOIN eban AS b
ON   a~banfn = b~banfn
AND  a~bnfpo = b~bnfpo )
INNER JOIN eket AS c
ON   a~banfn = c~banfn
AND  a~bnfpo = c~bnfpo
WHERE c~ebeln = gf_info-ebeln
AND   c~ebelp = gf_info-ebelp
AND   c~etenr = '0001'
AND   a~zebkn = '01'
AND   a~loekz = ''.
*---2003/04/30 UPDATE END   S.IWAKI(NDSC)
* ↑APPEND 2001/11/26 PSD M.Arai

CASE sy-subrc.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE s603(z1) WITH text-002 text-012 sy-subrc.
STOP.
ENDCASE.
ENDIF.

ENDFORM.                    " FRM_SET_JNUM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MINOUNYUU
*&---------------------------------------------------------------------*
*       未納入金の設定
*----------------------------------------------------------------------*
FORM frm_set_minounyuu.

DATA l_netpr(255) TYPE n.

CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
currency    = gf_info-waers
sap_amount  = gf_info-netpr
IMPORTING
idoc_amount = l_netpr.

gf_write-zmny = gf_write-zenge * l_netpr / gf_info-peinh.

ENDFORM.                    " FRM_SET_MINOUNYUU
**&---------------------------------------------------------------------
*
**&      Form  FRM_WRITE_MEISAI
**&---------------------------------------------------------------------
*
**       明細行出力
**----------------------------------------------------------------------
*
*FORM frm_write_meisai.
*
*  FORMAT COLOR 2 INTENSIFIED OFF.
*  WRITE: /2       gf_write-eindt DD/MM/YY,       "発注納期
*          11      gf_write-bedat DD/MM/YY,       "発注日
*          20      gf_write-znum.                 "発注番号
*
*  FORMAT COLOR 2 INTENSIFIED OFF.
*
*  WRITE:  36      gf_write-matnr,                "品目コード
*          56      gf_write-maktx,                "品名
*          96(11)  gf_write-menge DECIMALS 2,     "発注数
*          107(11) gf_write-wemng DECIMALS 2,     "入荷数
*          118(11) gf_write-zenge DECIMALS 2,     "未納数
*          129     gf_write-zans,                 "納期回答
*          144     gf_write-vbeln,                "受注番号
**↓APPEND 2001/12/12 M.Arai 直送区分追加対応
*          157     gf_write-evers,                "直送区分
*          161     ' '.
**↑APPEND 2001/12/12 M.Arai 直送区分追加対応
**↓DELETE 2001/12/12 M.Arai 直送区分追加対応
**          155     ' '.
**↑DELETE 2001/12/12 M.Arai
**---APPEND START PSD T.SAITOH 2002/09/06 ---------------------------*
*   SKIP 1.
**---APPEND END   PSD T.SAITOH 2002/09/06 ---------------------------*
* FORMAT COLOR OFF.
*
** 手配先合計計算処理
*  g_sum = g_sum + gf_write-zmny.
*
*ENDFORM.                    " FRM_WRITE_MEISAI
*&---------------------------------------------------------------------*
*&      Form  frm_break_tanto
*&---------------------------------------------------------------------*
*       担当名ブレイク時処理
*----------------------------------------------------------------------*
FORM frm_break_tanto.

NEW-PAGE.

ENDFORM.                    " frm_break_tanto
*&---------------------------------------------------------------------*
*&      Form  frm_break_tehai
*&---------------------------------------------------------------------*
*       手配先合計出力
*----------------------------------------------------------------------*
FORM frm_break_tehai.

SKIP.

FORMAT COLOR 3 ON INTENSIFIED OFF.
WRITE: /101  text-115,
112  g_sum,
161  ' '.
FORMAT COLOR OFF.
CLEAR g_sum.

SKIP.

ENDFORM.                    " frm_break_tehai
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_TEHAI
*&---------------------------------------------------------------------*
*       手配先ヘッダ出力
*----------------------------------------------------------------------*
FORM frm_write_tehai.

FORMAT COLOR 7 INTENSIFIED OFF.

WRITE : /1      text-116,
8(8)   gf_write-ztehai,    " 手配先コード
18(34) gf_write-zname.     " 手配先名
*           155    ' '.
FORMAT COLOR OFF.

ENDFORM.                    " FRM_WRITE_TEHAI
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MENGE
*&---------------------------------------------------------------------*
*       発注数量の設定
*----------------------------------------------------------------------*
FORM frm_set_menge.

IF gf_info-bsart = 'ZB'.
gf_write-menge = gf_write-menge * ( -1 ).
ENDIF.

ENDFORM.                    " FRM_SET_MENGE
*---APPEND START PSD T.SAITOH 2002/04/24 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_NAST_CHECK
*&---------------------------------------------------------------------*
*       NASTに発注止めがあったら対象外とする
*----------------------------------------------------------------------*
FORM frm_nast_check.
* MODIFY PSD K.ARAI 2002/05/28
SELECT SINGLE
kappl
objky
kschl
spras
parnr
erdat
eruhr
nacha
vstat
INTO CORRESPONDING FIELDS OF gf_nast
FROM nast
WHERE kappl = 'EF'
AND objky = gf_info-ebeln
AND kschl = 'NEU'
AND nacha = '8'
AND vstat = '0'.

*  SELECT SINGLE *
*         INTO CORRESPONDING FIELDS OF GF_NAST
*         FROM NAST
*        WHERE KAPPL = 'EF'
*          AND OBJKY = GF_INFO-EBELN
*          AND KSCHL = 'NEU'
*          AND NACHA = '8'
*          AND VSTAT = '0'.
* MODIFY END
ENDFORM.
*---APPEND END   PSD T.SAITOH 2002/04/24 ---------------------------*

*----2004.01.20 ADD_s
*&---------------------------------------------------------------------*
*&      Form  WRITE_OUT         ALV帳票出力
*&---------------------------------------------------------------------*
FORM write_out.
*--- 帳票設定処理
PERFORM frm_write_set.
*--- 表示
*-リスト出力
CALL FUNCTION 'REUSE_ALV_LIST_DISPLAY'          "【単純一覧出力】
EXPORTING
i_callback_program            = g_repid      "レポートID
i_callback_top_of_page        = g_top_of_page "TOP_OF_PAGE
i_structure_name              = 'ZSLIST_V20'  "構造
is_layout                     = gf_layout     "レイアウト設定
i_save                        = 'A'           "レイアウト保存
is_variant                    = gf_variant    "バリアント
it_events                     = gt_event[]    "イベント設定
is_print                      = gf_print      "印刷設定
TABLES
t_outtab                     = gt_alv        "帳票出力用内部テーブル
EXCEPTIONS
program_error                 = 1
OTHERS                        = 2 .
IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " WRITE_OUT


*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_SET　   帳票設定処理
*&---------------------------------------------------------------------*
FORM frm_write_set.
*--- 内部テーブル存在チェック
IF gt_write IS INITIAL.
MESSAGE s204(z1).
STOP.
ENDIF.
*--- 内部テーブル変換処理(ALV用内部テーブルに）
gt_alv[] = gt_write[].

*--- イベント取得処理
PERFORM frm_event_get.

*--- ページ切り替え設定
gf_layout-group_change_edit = cns_x.

*--- ALV一覧ステータス印刷拒否設定
gf_print-no_print_listinfos = cns_x.

*--- バリアント保存設定
gf_variant-variant   = '/TEST_0119'.   " レイアウトをバリアント保存

ENDFORM.                    " FRM_WRITE_SET
*&---------------------------------------------------------------------*
*&      Form  FRM_EVENT_GET  イベント取得処理
*&---------------------------------------------------------------------*
FORM frm_event_get.
*--- イベント取得
CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
EXPORTING
i_list_type     = 0
IMPORTING
et_events       = gt_event
EXCEPTIONS
list_type_wrong = 1
OTHERS          = 2.
IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

*--- 使用イベントに実行するサブルーチン名を設定
LOOP AT gt_event INTO gf_event.
CASE gf_event-name.
WHEN 'TOP_OF_PAGE'.
gf_event-form = 'FRM_TOP_OF_PAGE'.
MODIFY gt_event FROM gf_event.
WHEN 'CALLER_EXIT'.
gf_event-form = 'FRM_CALLER_EXIT'.
MODIFY gt_event FROM gf_event.
ENDCASE.
ENDLOOP.


ENDFORM.                    " FRM_EVENT_GET

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_PRINT_PARAMETERS
*&---------------------------------------------------------------------*
*       ALV印刷強制処理    動的コール
*----------------------------------------------------------------------*
FORM frm_set_print_parameters.

DATA:lf_pri_params LIKE pri_params.
TABLES usr01.

SELECT SINGLE * FROM usr01 WHERE bname = sy-uname.

* プリンタ設定
lf_pri_params-pdest = usr01-spld.
* 書式設定
lf_pri_params-paart = 'X_65_255'.

CALL FUNCTION 'SET_PRINT_PARAMETERS'
EXPORTING
destination = lf_pri_params-pdest
immediately = 'X'
layout      = lf_pri_params-paart
line_count  = 65
line_size   = 255
new_list_id = 'X'
release     = usr01-spda.


ENDFORM.                    " FRM_SET_PRINT_PARAMETERS
*---APPEND START DMC A.MASUDA 2005/02/16 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_EKKO_ERNAM
*&---------------------------------------------------------------------*
*       購買伝票ヘッダ(EKKO)の登録者から担当者名の取得
*----------------------------------------------------------------------*
*      -->P_GF_INFO_EBELN   購買伝票番号
*      <--P_GF_WRITE_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_EKKO_ERNAM USING    P_GF_INFO_EBELN
CHANGING P_GF_WRITE_TNAME.

DATA:L_ERNAM LIKE EKKO-ERNAM.
CLEAR:L_ERNAM,P_GF_WRITE_TNAME,FLG_TEC.

SELECT SINGLE ERNAM
INTO L_ERNAM
FROM EKKO
WHERE EBELN = P_GF_INFO_EBELN
AND ERNAM IN PR_ERNAM.

CASE SY-SUBRC.
WHEN 0. "GET-DATA
IF L_ERNAM = CNS_TEC0000.
CLEAR:P_GF_WRITE_TNAME.
MOVE CNS_X_2 TO FLG_TEC.
ELSE.
PERFORM FRM_GET_TNAME USING    L_ERNAM
CHANGING P_GF_WRITE_TNAME.
ENDIF.
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKO' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_EKKO_ERNAM
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_TNAME
*&---------------------------------------------------------------------*
*       ユーザのテキストを取得する
*----------------------------------------------------------------------*
*      -->P_L_ERNAM  ユーザ
*      <--P_L_TNAME  テキスト
*----------------------------------------------------------------------*
FORM FRM_GET_TNAME USING    P_L_ERNAM
CHANGING P_L_TNAME.

DATA:L_KEY(30) TYPE C.
CLEAR:P_L_TNAME,L_KEY.
CONCATENATE SY-MANDT P_L_ERNAM INTO L_KEY .

SELECT SINGLE ADRP~NAME_TEXT
INTO P_L_TNAME
FROM ADRP
INNER JOIN ADRVP
ON ADRP~PERSNUMBER = ADRVP~PERSNUMBER
WHERE ADRVP~APPL_KEY = L_KEY.

ENDFORM.                    " FRM_GET_TNAME
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_PERNR
*&---------------------------------------------------------------------*
*       営業員コードから担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G_VBELN         販売管理伝票番号
*      <--P_GF_WRITE_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_PERNR USING    P_G_VBELN
CHANGING P_GF_WRITE_TNAME.

DATA:L_PERNR LIKE VBPA-PERNR.
CLEAR:L_PERNR,P_GF_WRITE_TNAME.

SELECT SINGLE PERNR
INTO L_PERNR
FROM VBPA
WHERE VBELN = P_G_VBELN
AND PARVW = CNS_VE.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
* APPEND START DMC A.MASUDA 2005/07/05 -->
FLG_TEC = CNS_X_2.
* APPEND END   DMC A.MASUDA 2005/07/05 <--
EXIT.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'VBPA' SY-SUBRC.
ENDCASE.
*
DATA:L_NACHN LIKE PA0002-NACHN.
DATA:L_VORNA LIKE PA0002-VORNA.
CLEAR:L_NACHN,L_VORNA.

SELECT SINGLE NACHN VORNA
INTO (L_NACHN , L_VORNA)
FROM PA0002
WHERE PERNR = L_PERNR.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
CONCATENATE L_NACHN
'　'
L_VORNA
INTO P_GF_WRITE_TNAME.
REPLACE '　' WITH SPACE INTO P_GF_WRITE_TNAME.

*---APPEND START DMC A.MASUDA 2005/10/07 ------------------------------*
*     検索条件のユーザーに存在しないものは削除する
IF NOT PR_ERNAM IS INITIAL.
READ TABLE GT_NAME_TEXT INTO GW_NAME_TEXT
WITH KEY NAME_TEXT = P_GF_WRITE_TNAME
BINARY SEARCH.
IF SY-SUBRC <> 0.
CLEAR:P_GF_WRITE_TNAME.
ENDIF.
ENDIF.
*---APPEND END   DMC A.MASUDA 2005/10/07 ------------------------------*
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'PA0002' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_PERNR
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_VBAK_ERNAM
*&---------------------------------------------------------------------*
*       販売伝票ヘッダ(VBAK)の登録者から担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G_VBELN         販売管理伝票番号
*      <--P_GF_WRITE_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_VBAK_ERNAM USING    P_G_VBELN
CHANGING P_GF_WRITE_TNAME.

DATA:L_ERNAM LIKE VBAK-ERNAM.
CLEAR:L_ERNAM,P_GF_WRITE_TNAME,FLG_TEC.

SELECT SINGLE ERNAM
INTO L_ERNAM
FROM VBAK
WHERE VBELN = P_G_VBELN
AND ( ERNAM IN PR_ERNAM
*---APPEND START DMC A.MASUDA 2005/07/05 ---------------------------*
OR ERNAM = CNS_BATCH
OR ERNAM = CNS_TEC0000
OR ERNAM = CNS_EDIAD ).
*---APPEND END   DMC A.MASUDA 2005/07/05 ---------------------------*
CASE SY-SUBRC.
WHEN 0. " GET-DATA
IF L_ERNAM = CNS_BATCH.
MOVE L_ERNAM TO P_GF_WRITE_TNAME.
ElseIF L_ERNAM = CNS_EDIAD.
MOVE L_ERNAM TO P_GF_WRITE_TNAME.
ELSEIF L_ERNAM = CNS_TEC0000.
MOVE L_ERNAM TO P_GF_WRITE_TNAME.
*---DELETE START DMC A.MASUDA 2005/10/06 ---------------------------*
*        CLEAR:P_GF_WRITE_TNAME.
*        MOVE CNS_X_2 TO FLG_TEC.
*---DELETE END   DMC A.MASUDA 2005/10/06 ---------------------------*
ELSE.
PERFORM FRM_GET_TNAME USING    L_ERNAM
CHANGING P_GF_WRITE_TNAME.
ENDIF.
WHEN 4. " NO-DATA
CLEAR:P_GF_WRITE_TNAME.
*---DELETE START DMC A.MASUDA 2005/10/06 ---------------------------*
*      PERFORM FRM_SET_PERNR USING    P_G_VBELN           " 販売管理伝票
*                            CHANGING P_GF_WRITE_TNAME.   " 担当者名
*      IF P_GF_WRITE_TNAME IS INITIAL.
*        FLG_TEC = CNS_X_2.
*      ENDIF.
*---DELETE END   DMC A.MASUDA 2005/10/06 ---------------------------*
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'VBAK' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_VBAK_ERNAM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_VBELN
*&---------------------------------------------------------------------*
*       販売管理伝票番号の設定
*----------------------------------------------------------------------*
*      -->P_GF_INFO_EBELN   購買伝票番号
*      -->P_GF_INFO_EBELP   購買伝票明細番号
*      <--P_G_VBELN         販売管理伝票番号
*----------------------------------------------------------------------*
FORM FRM_SET_VBELN USING    P_GF_INFO_EBELN
P_GF_INFO_EBELP
CHANGING P_G_VBELN.

DATA:L_VBELN LIKE EKKN-VBELN.
DATA:L_VBELP LIKE EKKN-VBELP.
CLEAR:L_VBELN,L_VBELP,P_G_VBELN.

SELECT SINGLE VBELN
VBELP
INTO (L_VBELN , L_VBELP )
FROM EKKN
WHERE EBELN = P_GF_INFO_EBELN
AND EBELP = P_GF_INFO_EBELP.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
MOVE L_VBELN TO P_G_VBELN.
WHEN 4. " NO-DATA
CLEAR:P_G_VBELN.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKN' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_VBELN
*---APPEND END   DMC A.MASUDA 2005/02/16 ---------------------------*
*---APPEND START DMC A.MASUDA 2005/10/07 ------------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_NAME_DATA
*&---------------------------------------------------------------------*
*       検索条件ユーザー名の取得処理
*----------------------------------------------------------------------*
FORM FRM_CHECK_NAME_DATA.

* 検索条件作成用RANGE
RANGES:
R_NAMCHECK FOR ADRVP-APPL_KEY.

CLEAR:
R_NAMCHECK.
* 入力されたユーザを文字列結合し新規レンジテーブルの作成
LOOP AT PR_ERNAM.

R_NAMCHECK-SIGN   = PR_ERNAM-SIGN.
R_NAMCHECK-OPTION = PR_ERNAM-OPTION.
*   LOW項目の文字列結合
CONCATENATE SY-MANDT PR_ERNAM-LOW INTO R_NAMCHECK-LOW.
IF NOT PR_ERNAM-HIGH IS INITIAL.
CONCATENATE SY-MANDT PR_ERNAM-HIGH INTO R_NAMCHECK-HIGH.
ENDIF.

APPEND R_NAMCHECK.

ENDLOOP.
IF NOT R_NAMCHECK IS INITIAL.

SELECT ADRP~NAME_TEXT
INTO TABLE GT_NAME_TEXT
FROM ADRP
INNER JOIN ADRVP
ON ADRP~PERSNUMBER = ADRVP~PERSNUMBER
WHERE ADRVP~APPL_KEY IN R_NAMCHECK.
IF SY-SUBRC = 0.
SORT GT_NAME_TEXT BY NAME_TEXT ASCENDING.
ENDIF.

ENDIF.

ENDFORM.
*---APPEND END   DMC A.MASUDA 2005/10/07 ------------------------------*
