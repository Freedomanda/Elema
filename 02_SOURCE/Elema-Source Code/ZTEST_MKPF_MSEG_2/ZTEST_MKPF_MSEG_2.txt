REPORT ZTEST_MKPF_MSEG_1 .

TABLES:MKPF,MSEG.
SELECT-OPTIONS:
S_BUDAT FOR MKPF-BUDAT OBLIGATORY,
S_MBLNR FOR MKPF-MBLNR,
S_MJAHR FOR MKPF-MJAHR,
S_BLDAT FOR MKPF-BLDAT,
S_CPUDT FOR MKPF-CPUDT,
S_CPUTM FOR MKPF-CPUTM,
S_AEDAT FOR MKPF-AEDAT,
S_USNAM FOR MKPF-USNAM,
S_MATNR FOR MSEG-MATNR,
S_WERKS FOR MSEG-WERKS,
S_BWART FOR MSEG-BWART,
S_LIFNR FOR MSEG-LIFNR,
S_KUNNR FOR MSEG-KUNNR.

TYPES:BEGIN OF T_MKPF,
MBLNR  TYPE MKPF-MBLNR,
MJAHR  TYPE MKPF-MJAHR,
BLDAT  TYPE MKPF-BLDAT,
BUDAT  TYPE MKPF-BUDAT,
CPUDT  TYPE MKPF-CPUDT,
CPUTM  TYPE MKPF-CPUTM,
AEDAT  TYPE MKPF-AEDAT,
USNAM  TYPE MKPF-USNAM,
END OF T_MKPF.

TYPES:BEGIN OF T_MSEG,
MBLNR  TYPE MSEG-MBLNR,
MJAHR  TYPE MSEG-MJAHR,
ZEILE  TYPE MSEG-ZEILE,
BWART  TYPE MSEG-BWART,
MATNR  TYPE MSEG-MATNR,
WERKS  TYPE MSEG-WERKS,
LIFNR  TYPE MSEG-LIFNR,
KUNNR  TYPE MSEG-KUNNR,
KDAUF  TYPE MSEG-KDAUF,
DMBTR  TYPE MSEG-DMBTR,
ERFMG  TYPE MSEG-ERFMG,
EBELN  TYPE MSEG-EBELN,
END OF T_MSEG.

types:begin of t_JOIN,
mblnr  type mkpf-mblnr,
mjahr  type mkpf-mjahr,
bldat  type mkpf-bldat,
budat  type mkpf-budat,
cpudt  type mkpf-cpudt,
cputm  type mkpf-cputm,
aedat  type mkpf-aedat,
usnam  type mkpf-usnam,
bwart  type mseg-bwart,
matnr  type mseg-matnr,
werks  type mseg-werks,
lifnr  type mseg-lifnr,
kunnr  type mseg-kunnr,
kdauf  type mseg-kdauf,
dmbtr  type mseg-dmbtr,
erfmg  type mseg-erfmg,
ebeln  type mseg-ebeln,
end of T_JOIN.

DATA:IT_MKPF TYPE TABLE OF T_MKPF,
WA_MKPF TYPE T_MKPF,
IT_MSEG TYPE SORTED TABLE OF T_MSEG
WITH UNIQUE KEY MBLNR MJAHR ZEILE,
WA_MSEG TYPE T_MSEG,
IT_JOIN TYPE TABLE OF T_JOIN,
WA_JOIN TYPE T_JOIN,
CNT     TYPE I.

SELECT MBLNR MJAHR BLDAT BUDAT
CPUDT CPUTM AEDAT USNAM
INTO TABLE IT_MKPF
FROM MKPF
WHERE BUDAT IN S_BUDAT
AND MBLNR IN S_MBLNR
AND MJAHR IN S_MJAHR
AND BLDAT IN S_BLDAT
AND CPUDT IN S_CPUDT
AND CPUTM IN S_CPUTM
AND AEDAT IN S_AEDAT
AND USNAM IN S_USNAM.

CHECK SY-SUBRC = 0.

SELECT MBLNR MJAHR ZEILE BWART
MATNR WERKS LIFNR KUNNR
KDAUF DMBTR ERFMG EBELN
INTO TABLE IT_MSEG
FROM MSEG
FOR ALL ENTRIES IN IT_MKPF
WHERE MBLNR =  IT_MKPF-MBLNR
AND MJAHR =  IT_MKPF-MJAHR
AND MATNR IN S_MATNR
AND WERKS IN S_WERKS
AND BWART IN S_BWART
AND LIFNR IN S_LIFNR
AND KUNNR IN S_KUNNR.



IF SY-SUBRC = 0.
LOOP AT IT_MKPF INTO WA_MKPF.
CLEAR: WA_JOIN,WA_MSEG.
LOOP AT IT_MSEG INTO WA_MSEG
WHERE MBLNR = WA_MKPF-MBLNR
AND MJAHR = WA_MKPF-MJAHR.
MOVE-CORRESPONDING WA_MKPF TO WA_JOIN.
MOVE-CORRESPONDING WA_MSEG TO WA_JOIN.
APPEND WA_JOIN TO IT_JOIN.
CNT = CNT + 1.
ENDLOOP.
ENDLOOP.
WRITE CNT.
ENDIF.
