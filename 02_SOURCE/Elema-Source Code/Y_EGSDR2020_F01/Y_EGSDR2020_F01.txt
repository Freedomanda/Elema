*----------------------------------------------------------------------*
***INCLUDE ZEGSDR2020_F01.
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       A-1-1．入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT.

* A-1-1-1．販売組織(Sales Organization)存在チェック
PERFORM CHECK_VKORG.

* A-1-1-2．流通チャネル(Distribution Channel)存在チェック
PERFORM CHECK_VTWEG.

* A-1-1-3． 販売部門(Division)存在チェック
PERFORM CHECK_SPART.

* A-1-1-4．営業所(Sales Office)存在チェック
PERFORM CHECK_VKBUR.

* A-1-1-5．営業グループ(Sales Group)存在チェック
PERFORM CHECK_VKGRP.

ENDFORM.                    " CHECK_INPUT
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKORG
*&---------------------------------------------------------------------*
*       A-1-1-1．販売組織(Sales Organization)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKORG.

SELECT SINGLE VKORG
FROM TVKO
INTO P_VKORG
WHERE VKORG = P_VKORG.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_VKORG'.
MESSAGE E039(ZMEGSD01) WITH P_VKORG.
*   #售##( &1 )不存在
ENDIF.

ENDFORM.                    " CHECK_VKORG
*&---------------------------------------------------------------------*
*&      Form  CHECK_VTWEG
*&---------------------------------------------------------------------*
*       A-1-1-2．流通チャネル(Distribution Channel)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VTWEG.
TYPES: BEGIN OF LTYP_VTWEG,
VTWEG TYPE TVTW-VTWEG,
END OF LTYP_VTWEG.

DATA:
LTD_VTWEG   TYPE STANDARD TABLE OF LTYP_VTWEG,
LST_VTWEG   TYPE LTYP_VTWEG,
LST_VTWEG_R LIKE LINE OF RD_VTWEG.

SELECT VTWEG
INTO TABLE LTD_VTWEG
FROM TVTW
WHERE VTWEG IN S_VTWEG.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VTWEG-LOW'.
MESSAGE E040(ZMEGSD01) WITH SPACE.
*   流通チャネル&1は存在しません
ENDIF.

REFRESH RD_VTWEG.

LST_VTWEG_R-SIGN = 'I'.
LST_VTWEG_R-OPTION = 'EQ'.
LOOP AT LTD_VTWEG INTO LST_VTWEG.
LST_VTWEG_R-LOW = LST_VTWEG-VTWEG.
APPEND LST_VTWEG_R TO RD_VTWEG.
ENDLOOP.

ENDFORM.                    " CHECK_VTWEG
*&---------------------------------------------------------------------*
*&      Form  CHECK_SPART
*&---------------------------------------------------------------------*
*       A-1-1-3． 販売部門(Division)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_SPART.
TYPES:
BEGIN OF LTYP_SPART,
SPART TYPE TSPA-SPART,
END OF LTYP_SPART.

DATA:
LTD_SPART   TYPE STANDARD TABLE OF LTYP_SPART,
LST_SPART   TYPE LTYP_SPART,
LST_SPART_R LIKE LINE OF RD_SPART.

SELECT SPART
INTO TABLE LTD_SPART
FROM TSPA
WHERE SPART IN S_SPART.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_SPART-LOW'.
MESSAGE E041(ZMEGSD01) WITH SPACE.
*   製品部門&1は存在しません
ENDIF.

REFRESH RD_SPART.
LST_SPART_R-SIGN = 'I'.
LST_SPART_R-OPTION = 'EQ'.
LOOP AT LTD_SPART INTO LST_SPART.
LST_SPART_R-LOW = LST_SPART-SPART.
APPEND LST_SPART_R TO RD_SPART.
ENDLOOP.

ENDFORM.                    " CHECK_SPART
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKBUR
*&---------------------------------------------------------------------*
*       A-1-1-4．営業所(Sales Office)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKBUR.
TYPES:
BEGIN OF LTYP_VKBUR,
VKBUR TYPE TVBUR-VKBUR,
END OF LTYP_VKBUR.

DATA:
LTD_VKBUR   TYPE STANDARD TABLE OF LTYP_VKBUR,
LST_VKBUR   TYPE LTYP_VKBUR,
LST_VKBUR_R LIKE LINE OF RD_VKBUR.

SELECT VKBUR
INTO TABLE LTD_VKBUR
FROM TVBUR
WHERE VKBUR IN S_VKBUR.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKBUR-LOW'.
MESSAGE E042(ZMEGSD01) WITH SPACE.
*   営業所&1は存在しません
ENDIF.

REFRESH RD_VKBUR.
LST_VKBUR_R-SIGN = 'I'.
LST_VKBUR_R-OPTION = 'EQ'.
LOOP AT LTD_VKBUR INTO LST_VKBUR.
LST_VKBUR_R-LOW = LST_VKBUR-VKBUR.
APPEND LST_VKBUR_R TO RD_VKBUR.
ENDLOOP.

ENDFORM.                    " CHECK_VKBUR
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKGRP
*&---------------------------------------------------------------------*
*       A-1-1-5．営業グループ(Sales Group)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKGRP.
TYPES:
BEGIN OF LTYP_VKGRP,
VKGRP TYPE TVKGR-VKGRP,
END OF LTYP_VKGRP.

DATA:
LTD_VKGRP   TYPE STANDARD TABLE OF LTYP_VKGRP,
LST_VKGRP   TYPE LTYP_VKGRP,
LST_VKGRP_R LIKE LINE OF RD_VKGRP.

SELECT VKGRP
INTO TABLE LTD_VKGRP
FROM TVKGR
WHERE VKGRP IN S_VKGRP.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKGRP-LOW'.
MESSAGE E043(ZMEGSD01) WITH SPACE.
*   営業グループ&1は存在しません
ENDIF.

REFRESH RD_VKGRP.
LST_VKGRP_R-SIGN = 'I'.
LST_VKGRP_R-OPTION = 'EQ'.
LOOP AT LTD_VKGRP INTO LST_VKGRP.
LST_VKGRP_R-LOW = LST_VKGRP-VKGRP.
APPEND LST_VKGRP_R TO RD_VKGRP.
ENDLOOP.

ENDFORM.                    " CHECK_VKGRP
*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA
*&---------------------------------------------------------------------*
*       A-1-2-1．販売エリアの整合性チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.

SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
INTO TABLE O_TD_TVTA
FROM TVTA
WHERE VKORG =  P_VKORG                     " 販売組織
AND VTWEG IN S_VTWEG                     " 流通チャネル
AND SPART IN S_SPART.                    " 製品部門

IF SY-SUBRC <> 0.
MESSAGE E044(ZMEGSD01).
*   指定された販売エリアの整合性がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA
*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA_AUTH
*&---------------------------------------------------------------------*
*       A-1-3．権限チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA_AUTH CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.
DATA:
LST_TVTA  TYPE TYP_TVTA,
LW_TABIX  TYPE SY-TABIX.

LOOP AT O_TD_TVTA INTO LST_TVTA.
LW_TABIX = SY-TABIX.
AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
ID 'VKORG' FIELD LST_TVTA-VKORG
ID 'VTWEG' FIELD LST_TVTA-VTWEG
ID 'SPART' FIELD LST_TVTA-SPART
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.
DELETE O_TD_TVTA INDEX LW_TABIX.
ENDIF.
ENDLOOP.

IF O_TD_TVTA IS INITIAL.
MESSAGE E038(ZMEGSD01).
*   販売エリアに対する実行権限がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA_AUTH
*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
FORM MAIN_PROCESS.
DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203,
LW_ERRFLG      TYPE CHAR1.

REFRESH:
TD_ZSEGSD0009,
TD_ITEM_ALV_TEM.

**** START ADD 2015/03/03 iSiD Ruan ****
*     本社及び明細分割情報を取得する
SELECT SINGLE A~ZFLGHEADOFFICE  "本社フラグ
A~ZFLGSOSINGLE    "販売伝票単一明細フラグ
INTO (W_FLGHEADOF,
W_FLGSOSGL )
FROM ZTEGSDT204 AS A
INNER JOIN TVKO  AS B
ON A~BUKRS = B~BUKRS
WHERE B~VKORG   = P_VKORG.

*     存在しない場合、フラグに初期値を設定する
IF SY-SUBRC <> 0.
W_FLGHEADOF = SPACE. "本社フラグ
W_FLGSOSGL  = SPACE. "販売伝票単一明細フラグ
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan     ****

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.

*     A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL.
LEAVE LIST-PROCESSING.
ENDIF.
*     A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.

*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.

*     A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL.
LEAVE LIST-PROCESSING.
ENDIF.
*     A-2-2-2-1．販売伝票タイプの検索
*     A-2-2-2-2．販売伝票タイプの設定処理
PERFORM GET_DATA_205 CHANGING LTD_ZTEGSDT203.

*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.

*     A-2-3-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN1 USING TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL.
LEAVE LIST-PROCESSING.
ENDIF.
WHEN OTHERS.
*     処理なし
ENDCASE.

* 従業員データ取得
PERFORM GET_ZTERM_DATA.

* A-3．画面出力
PERFORM ALV_OUTPUT USING LTD_ZTEGSDT203.

ENDFORM.                    " MAIN_PROCESS
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN
*&---------------------------------------------------------------------*
*       以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_KBUNCC_F       処理区分1
*      -->I_STATUS_F       ステータス1
*      -->I_KBUNCC_S       処理区分2
*      -->I_STATUS_S       ステータス2
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN  USING I_KBUNCC_F     TYPE C
I_STATUS_F     TYPE C
I_KBUNCC_S     TYPE C
I_STATUS_S     TYPE C
I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203
O_W_ERRFLG     TYPE C.
DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
ZTEGSDT203~MATNR                     " 品目コード
**** START DEL 2015/03/03 iSiD Ruan ****
*         ZTEGSDT203~TXZ01                     " テキスト (短)
**** END DEL 2015/03/03 iSiD Ruan ****
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
**** START ADD 2015/03/03 iSiD Ruan ****
ZTEGSDT203~LGORT                     "保管場所
**** END ADD 2015/03/03 iSiD Ruan ****
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1 AS ZNAME1               " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~PERNR                     " 営業員
**** START UPD 2015/03/03 iSiD Ruan ****
*         ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
*         ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~Z_VEND_NAME_DT             "出荷先名（PO）
ZTEGSDT203~Z_ADDRESS1_DT              "出荷先住所1
ZTEGSDT203~Z_ADDRESS2_DT              "出荷先住所2
ZTEGSDT203~Z_ADDRESS3_DT              "出荷先住所3
ZTEGSDT203~Z_ADDRESS4_DT              "出荷先住所4
ZTEGSDT203~Z_TEL_DT                   "出荷先電話番号
ZTEGSDT203~Z_FAX_DT                   "出荷先FAX番号（PO）
ZTEGSDT203~INCO1    	                 "インコタームズ (1)
ZTEGSDT203~INCO2                      "インコタームズ (2)
ZTEGSDT203~Z_PURPOSE_TEXT             "用途（PO）
ZTEGSDT203~ZKUNNR_ZJ                  "最終需要者
KNA1_J~NAME1 AS ZNAME_ZJ                "名称1
ZTEGSDT203~ZKUNNR_ZE AS ZKUNNR_DS     "エンドユーザ（価格）
KNA1_E~NAME1 AS ZNAME_DS                "名称1
ZTEGSDT203~EINDT                      "明細納入期日
ZTEGSDT203~Z_PO_ITEM_TXT              "購買発注明細テキスト
ZTEGSDT203~SUBMI                      "一括番号
**** END UPD 2015/03/03 iSiD Ruan ****
ZTEGSDT203~AUGRU                     " 受注理由 (取引理由)
ZTEGSDT203~ZKBUNCC                   " 処理区分
ZTEGSDT203~STATUS                    " ステータス
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
**** START ADD 2015/03/03 iSiD Ruan ****
LEFT JOIN KNA1 AS KNA1_E
ON ZTEGSDT203~ZKUNNR_ZE  =  KNA1_E~KUNNR " 出荷先
LEFT JOIN KNA1 AS KNA1_J
ON ZTEGSDT203~ZKUNNR_ZJ  =  KNA1_J~KUNNR " 出荷先
**** END ADD 2015/03/03 iSiD Ruan     ****
INTO CORRESPONDING FIELDS OF TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG
" 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART
" 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ( ( ZTEGSDT203~ZKBUNCC    = I_KBUNCC_F
" 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_F )
" ステータス
OR ( ZTEGSDT203~ZKBUNCC  = I_KBUNCC_S
" 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_S ) ).
" ステータス

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
*   対象データが存在しません。(TBL = &1)
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM.
ELSE.
LTD_SDT203[] = O_TD_SDT203[].
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= SY-DATUM                  " 開始日付
AND ENDDA >= SY-DATUM.                 " 終了日付

IF SY-SUBRC = 0.
SORT LTD_PA0001 BY PERNR ASCENDING.     " 営業員
ENDIF.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.
<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.
" 応募者氏名
ENDLOOP.

ENDIF.

ENDFORM.                    " GET_DATA_MAIN
*&---------------------------------------------------------------------*
*&      Form  EDIT_DATA_MAIN
*&---------------------------------------------------------------------*
*       A-2-1-2．承認一覧の関連情報を取得
*----------------------------------------------------------------------*
*      <--O_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM EDIT_DATA_MAIN CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_SDT203   TYPE TYP_TD_ZTEGSDT203,
LTD_PROCESS  TYPE TYP_TD_ZTEGSDT203,
LTD_203      TYPE TYP_TD_ZTEGSDT203,
LTD_KNVP     TYPE STANDARD TABLE OF TYP_KNVP,
LST_KNVP     TYPE TYP_KNVP,
**** START DEL 2015/03/03 iSiD Ruan ****
*    LTD_SDT204   TYPE STANDARD TABLE OF TYP_ZTEGSDT204,
*    LST_SDT204   TYPE TYP_ZTEGSDT204,
**** END DEL 2015/03/03 iSiD Ruan ****
LTD_DATA_205_TEM TYPE TYP_TD_205,
LTD_DATA_205 TYPE TYP_TD_205,
LST_DATA_205 TYPE TYP_DATA_205,
LTD_KALVG    TYPE TYP_TD_KALVG,
LST_KALVG    TYPE TYP_KALVG,
LTD_KALKS    TYPE TYP_TD_KALKS,
LST_KALKS    TYPE TYP_KALKS,
LTD_COND_TYPE TYPE TYP_TD_COND_TYPE,
LST_COND_TYPE TYPE TYP_COND_TYPE,
LTD_ENAME    TYPE STANDARD TABLE OF TYP_ENAME,
LST_ENAME    TYPE TYP_ENAME,
LTD_KNVV     TYPE STANDARD TABLE OF TYP_KNVV,
LST_KNVV     TYPE TYP_KNVV,
LW_PARVW     TYPE KNVP-PARVW.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.

*   A-2-1-2-1．出荷先の情報の検索
AT FIRST.
**** START ADD 2015/03/03 iSiD Ruan ****
IF W_FLGHEADOF IS NOT INITIAL. "本社フラグ
**** END ADD 2015/03/03 iSiD Ruan   ****

LTD_SDT203[] = O_TD_SDT203[].

DELETE LTD_SDT203
WHERE ZKUNNR_S IS NOT INITIAL.         " Ship-to

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門

IF LTD_SDT203 IS NOT INITIAL.

CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = CNS_PAR_SH
IMPORTING
OUTPUT = LW_PARVW.

SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~KUNN2                     " 取引先の得意先コード
KNA1~NAME1                     " 名称1
FROM KNVP
INNER JOIN KNA1
ON KNVP~KUNN2 = KNA1~KUNNR        " 取引先の得意先コード
INTO TABLE LTD_KNVP                 " ITAB:得意先マスタ
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = LW_PARVW.         " 取引先機能

IF SY-SUBRC = 0.
SORT LTD_KNVP BY KUNNR ASCENDING  " 得意先コード
VKORG ASCENDING  " 販売組織
VTWEG ASCENDING  " 流通チャネル
SPART ASCENDING. " 製品部門
ENDIF.
ENDIF.
**** START ADD 2015/03/03 iSiD Ruan ****
ENDIF. "本社フラグ
**** END ADD 2015/03/03 iSiD Ruan   ****

**** START DEL 2015/03/03 iSiD Ruan ****
**   A-2-1-2-2．最終需要者の情報を検索
*      LTD_SDT203[] = O_TD_SDT203[].
*
*      DELETE LTD_SDT203
*       WHERE ZKUNNR_ZJ IS NOT INITIAL.        " 最終需要者
*
*      SORT LTD_SDT203 BY MATNR ASCENDING      " 品目コード
*                         VKORG ASCENDING.     " 販売組織
*
*      DELETE ADJACENT DUPLICATES FROM LTD_SDT203
*                            COMPARING MATNR   " 品目コード
*                                      VKORG.  " 販売組織
*
*      IF LTD_SDT203 IS NOT INITIAL.
*        SELECT ZTEGSDT204~MATNR               " 品目コード
*               TVKO~VKORG                     " 販売組織
*               ZTEGSDT204~ZKUNNR_ZJ           " 最終需要者
*               ZTEGSDT204~ZKUNNR_DS           " 最終需要者(商流)
*          FROM ZTEGSDT204
*         INNER JOIN TVKO
*            ON ZTEGSDT204~BUKRS = TVKO~BUKRS
*          INTO TABLE LTD_SDT204
*           FOR ALL ENTRIES IN LTD_SDT203
*         WHERE ZTEGSDT204~MATNR = LTD_SDT203-MATNR
*                                              " 品目コード
*           AND TVKO~VKORG       = LTD_SDT203-VKORG.
*        " 販売組織
*
*        IF SY-SUBRC = 0.
*          SORT LTD_SDT204 BY MATNR ASCENDING  " 品目コード
*                             VKORG ASCENDING. " 販売組織
*        ENDIF.
*
*      ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****

*   A-2-1-2-3．営業員情報の検索
LTD_SDT203[] = O_TD_SDT203[].

DELETE LTD_SDT203
WHERE ENAME IS NOT INITIAL.            " 応募者氏名

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門

IF LTD_SDT203 IS NOT INITIAL.

CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = CNS_PAR_PE
IMPORTING
OUTPUT = LW_PARVW.

SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~PERNR                     " 従業員番号
PA0001~ENAME                   " 従業員氏名
FROM KNVP
INNER JOIN PA0001
ON KNVP~PERNR = PA0001~PERNR      " 従業員番号
INTO TABLE LTD_ENAME
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = LW_PARVW.         " 取引先機能

IF SY-SUBRC = 0.
SORT LTD_ENAME BY KUNNR ASCENDING   " 得意先コード
VKORG ASCENDING   " 販売組織
VTWEG ASCENDING   " 流通チャネル
SPART ASCENDING.  " 製品部門
ENDIF.

ENDIF.

**** START DEL 2015/03/03 iSiD Ruan ****
**   A-2-1-2-4．出荷プラントの情報を検索
*      LTD_SDT203[] = O_TD_SDT203[].
*
*      DELETE LTD_SDT203
*       WHERE DWERK IS NOT INITIAL.            " 出荷プラント
*
*      SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
*                         VKORG ASCENDING      " 販売組織
*                         VTWEG ASCENDING      " 流通チャネル
*                         SPART ASCENDING.     " 製品部門
*
*      DELETE ADJACENT DUPLICATES FROM LTD_SDT203
*                            COMPARING KUNNR   " 得意先コード
*                                      VKORG   " 販売組織
*                                      VTWEG   " 流通チャネル
*                                      SPART.  " 製品部門
*
*      IF LTD_SDT203 IS NOT INITIAL.
*        SELECT KUNNR                          " 得意先コード
*               VKORG                          " 販売組織
*               VTWEG                          " 流通チャネル
*               SPART                          " 製品部門
*               VWERK                          " 出荷プラント
*          FROM KNVV
*          INTO TABLE LTD_KNVV
*           FOR ALL ENTRIES IN LTD_SDT203
*         WHERE KUNNR = LTD_SDT203-KUNNR       " 得意先コード
*           AND VKORG = LTD_SDT203-VKORG       " 販売組織
*           AND VTWEG = LTD_SDT203-VTWEG       " 流通チャネル
*           AND SPART = LTD_SDT203-SPART.      " 製品部門
*
*        IF SY-SUBRC = 0.
*          SORT LTD_KNVV BY KUNNR ASCENDING    " 得意先コード
*                           VKORG ASCENDING    " 販売組織
*                           VTWEG ASCENDING    " 流通チャネル
*                           SPART ASCENDING.   " 製品部門
*        ENDIF.
*      ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****

*     A-2-1-2-5．販売伝票タイプの検索
PERFORM GET_DATA_205_A USING O_TD_SDT203
CHANGING LTD_DATA_205.

IF LTD_DATA_205 IS NOT INITIAL.

LTD_DATA_205_TEM[] = LTD_DATA_205[].
SORT LTD_DATA_205_TEM BY AUART ASCENDING.
" 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205_TEM
COMPARING AUART." 販売伝票タイプ

SELECT AUART                          " 販売伝票タイプ
KALVG                          " 伝票決定区分
FROM TVAK
INTO TABLE LTD_KALVG
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART." 販売伝票タイプ

IF SY-SUBRC = 0.

SORT LTD_KALVG BY AUART ASCENDING.  " 販売伝票タイプ

ENDIF.

ENDIF.

LTD_203[] = O_TD_SDT203[].
SORT LTD_203 BY     KUNNR ASCENDING     " 得意先コード
VKORG ASCENDING     " 販売組織
VTWEG ASCENDING     " 流通チャネル
SPART ASCENDING.    " 製品部門

SELECT KUNNR                                " 得意先コード
VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALKS                                " 価格決定区分割当
FROM KNVV
INTO TABLE LTD_KALKS
FOR ALL ENTRIES IN LTD_203
WHERE KUNNR = LTD_203-KUNNR                " 得意先コード
AND VKORG = LTD_203-VKORG                " 販売伝票タイプ
AND VTWEG = LTD_203-VTWEG                " 販売組織
AND SPART = LTD_203-SPART.               " 製品部門

IF SY-SUBRC = 0.

SORT LTD_KALKS BY  KUNNR ASCENDING        " 得意先コード
VKORG ASCENDING        " 販売伝票タイプ
VTWEG ASCENDING        " 販売組織
SPART ASCENDING.       " 製品部門

ENDIF.

LTD_PROCESS[] = O_TD_SDT203[].
SORT LTD_PROCESS BY VKORG ASCENDING         " 販売組織
VTWEG ASCENDING         " 流通チャネル
SPART ASCENDING.        " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING VKORG       " 販売組織
VTWEG       " 流通チャネル
SPART.      " 製品部門

SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALVG                                " 伝票決定区分
KALKS                                " 価格決定区分割当
KARTV                                " 条件タイプ
FROM T683V
INTO TABLE LTD_COND_TYPE
FOR ALL ENTRIES IN LTD_PROCESS
WHERE VKORG = LTD_PROCESS-VKORG            " 販売伝票タイプ
AND VTWEG = LTD_PROCESS-VTWEG            " 販売組織
AND SPART = LTD_PROCESS-SPART.           " 製品部門

SORT LTD_COND_TYPE  BY VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING      " 製品部門
KALVG ASCENDING      " 伝票決定区分
KALKS ASCENDING.     " 価格決定区分割当

ENDAT.

*   A-2-1-2-6．出荷先の情報を取得する。
IF <LFS_ST_SDT203>-ZKUNNR_S IS INITIAL.
**** START ADD 2015/03/03 iSiD Ruan ****
IF W_FLGHEADOF IS NOT INITIAL. "本社フラグ
**** END ADD 2015/03/03 iSiD Ruan   ****
CLEAR LST_KNVP.
READ TABLE LTD_KNVP INTO LST_KNVP
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.
**** START ADD 2015/03/03 iSiD Ruan ****
IF SY-SUBRC = 0. "本社フラグ
**** END ADD 2015/03/03 iSiD Ruan   ****
<LFS_ST_SDT203>-ZKUNNR_S = LST_KNVP-KUNN2.
" 出荷先

<LFS_ST_SDT203>-ZNAME1   = LST_KNVP-NAME1.
" 出荷先名称
**** START ADD 2015/03/03 iSiD Ruan ****
ELSE.
<LFS_ST_SDT203>-ZKUNNR_S = <LFS_ST_SDT203>-KUNNR."出荷先
<LFS_ST_SDT203>-ZNAME1   = <LFS_ST_SDT203>-NAME1."出荷先名称
ENDIF.

ELSE.
<LFS_ST_SDT203>-ZKUNNR_S = <LFS_ST_SDT203>-KUNNR."出荷先
<LFS_ST_SDT203>-ZNAME1   = <LFS_ST_SDT203>-NAME1."出荷先名称
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****
ENDIF.

**** START DEL 2015/03/03 iSiD Ruan ****
**   A-2-1-2‐7．最終需要者の情報を取得する。
*    IF <LFS_ST_SDT203>-ZKUNNR_ZJ IS INITIAL.
*      CLEAR LST_SDT204.
*      READ TABLE LTD_SDT204 INTO LST_SDT204
*                        WITH KEY MATNR = <LFS_ST_SDT203>-MATNR
*                                 VKORG = <LFS_ST_SDT203>-VKORG
*                        BINARY SEARCH.
*
*      <LFS_ST_SDT203>-ZKUNNR_ZJ = LST_SDT204-ZKUNNR_ZJ.
*      " 最終需要者
*
*      <LFS_ST_SDT203>-ZKUNNR_DS = LST_SDT204-ZKUNNR_DS.
*      " 最終需要者(商流)
*    ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****

*   A-2-1-2-8．営業員の情報を取得する。
IF <LFS_ST_SDT203>-ENAME IS INITIAL.
CLEAR LST_ENAME.
READ TABLE LTD_ENAME INTO LST_ENAME
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.

<LFS_ST_SDT203>-PERNR = LST_ENAME-PERNR.
" 取引先の得意先コード

<LFS_ST_SDT203>-ENAME = LST_ENAME-ENAME.
" 従業員氏名
ENDIF.

**** START DEL 2015/03/03 iSiD Ruan ****
**   A-2-1-2-9．出荷プラントの情報を検索
*    IF <LFS_ST_SDT203>-DWERK IS INITIAL.
*      CLEAR LST_KNVV.
*      READ TABLE LTD_KNVV INTO LST_KNVV
*                      WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
*                               VKORG = <LFS_ST_SDT203>-VKORG
*                               VTWEG = <LFS_ST_SDT203>-VTWEG
*                               SPART = <LFS_ST_SDT203>-SPART
*                      BINARY SEARCH.
*
*      <LFS_ST_SDT203>-DWERK = LST_KNVV-VWERK.
*    ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****

*   A-2-1-2-10．販売伝票タイプの設定処理
CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = <LFS_ST_SDT203>-BSART
KNTTP = <LFS_ST_SDT203>-KNTTP
BINARY SEARCH.

IF SY-SUBRC = 0.

<LFS_ST_SDT203>-AUART   = LST_DATA_205-AUART.
" 販売伝票タイプ
<LFS_ST_SDT203>-ZABEZEI = LST_DATA_205-BEZEI.
" 販売伝票タイプテキスト
<LFS_ST_SDT203>-VBTYP   = LST_DATA_205-VBTYP.
" 販売管理伝票カテゴリ

*     伝票決定区分の取得処理
CLEAR LST_KALVG.
READ TABLE LTD_KALVG INTO LST_KALVG BINARY SEARCH
WITH KEY AUART = LST_DATA_205-AUART.

IF <LFS_ST_SDT203>-ZKBUNCC = CNS_KBUNCC_1
" 処理区分
AND <LFS_ST_SDT203>-STATUS = CNS_STATUS_C.
" ステータス

<LFS_ST_SDT203>-AUGRU = LST_DATA_205-AUGRU.
" 受注理由
ENDIF.
ENDIF.

*   価格決定区分割当の取得処理
CLEAR LST_KALKS.
READ TABLE LTD_KALKS INTO LST_KALKS BINARY SEARCH
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART.

*   条件タイプの取得処理
CLEAR LST_COND_TYPE.
READ TABLE LTD_COND_TYPE INTO LST_COND_TYPE BINARY SEARCH
WITH KEY VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
KALVG = LST_KALVG-KALVG
KALKS = LST_KALKS-KALKS.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-KARTV = LST_COND_TYPE-KARTV.
ENDIF.

ENDLOOP.

ENDFORM.                    " EDIT_DATA_MAIN
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN1
*&---------------------------------------------------------------------*
*       A-2-3-1．以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN1  USING I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203
O_W_ERRFLG     TYPE C.
DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
ZTEGSDT203~MATNR                     " 品目コード
**** START DEL 2015/03/03 iSiD Ruan ****
*         ZTEGSDT203~TXZ01                     " テキスト (短)
**** END DEL 2015/03/03 iSiD Ruan ****
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
**** START ADD 2015/03/03 iSiD Ruan ****
ZTEGSDT203~LGORT                     "保管場所
**** END ADD 2015/03/03 iSiD Ruan ****
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1 AS ZNAME1               " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~PERNR                     " 営業員
**** START UPD 2015/03/03 iSiD Ruan ****
*         ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
*         ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~Z_VEND_NAME_DT             "出荷先名（PO）
ZTEGSDT203~Z_ADDRESS1_DT              "出荷先住所1
ZTEGSDT203~Z_ADDRESS2_DT              "出荷先住所2
ZTEGSDT203~Z_ADDRESS3_DT              "出荷先住所3
ZTEGSDT203~Z_ADDRESS4_DT              "出荷先住所4
ZTEGSDT203~Z_TEL_DT                   "出荷先電話番号
ZTEGSDT203~Z_FAX_DT                   "出荷先FAX番号（PO）
ZTEGSDT203~INCO1    	                 "インコタームズ (1)
ZTEGSDT203~INCO2                      "インコタームズ (2)
ZTEGSDT203~Z_PURPOSE_TEXT             "用途（PO）
ZTEGSDT203~ZKUNNR_ZJ                  "最終需要者
KNA1~NAME1 AS ZNAME_ZJ                 "名称1
ZTEGSDT203~ZKUNNR_ZE AS ZKUNNR_DS     "エンドユーザ（価格）
KNA1~NAME1 AS ZNAME_DS                 "名称1
ZTEGSDT203~Z_PO_ITEM_TXT              "購買発注明細テキスト
ZTEGSDT203~SUBMI                      "一括番号
**** END UPD 2015/03/03 iSiD Ruan ****
ZTEGSDT203~AUGRU                     " 受注理由 (取引理由)
ZTEGSDT203~ZKBUNCC                   " 処理区分
ZTEGSDT203~STATUS                    " ステータス
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
**** START ADD 2015/03/03 iSiD Ruan ****
LEFT JOIN KNA1 AS KNA1_E
ON ZTEGSDT203~ZKUNNR_ZE  =  KNA1_E~KUNNR " 出荷先
LEFT JOIN KNA1 AS KNA1_J
ON ZTEGSDT203~ZKUNNR_ZJ  =  KNA1_J~KUNNR " 出荷先
**** END ADD 2015/03/03 iSiD Ruan     ****
INTO CORRESPONDING FIELDS OF TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG
" 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART
" 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ZTEGSDT203~ZKBUNCC   = CNS_KBUNCC_2  " 処理区分
AND ZTEGSDT203~STATUS    = CNS_STATUS_C. " ステータス

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
*   対象データが存在しません。(TBL = &1)
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM.
ELSE.
LTD_SDT203[] = O_TD_SDT203[].
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= SY-DATUM                  " 開始日付
AND ENDDA >= SY-DATUM.                 " 終了日付

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.

<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.
" 応募者氏名
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN
*&---------------------------------------------------------------------*
*&      Form  ALV_OUTPUT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM ALV_OUTPUT  USING I_TD_SDT203      TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_FIELDCAT   TYPE LVC_T_FCAT,
LST_LAYOUT     TYPE LVC_S_LAYO,
**** START ADD 2015/03/03 iSiD Ruan ****
LST_VARIANT_E TYPE DISVARIANT.       "Variant
**** END ADD 2015/03/03iSiD Ruan ****

* 項目カタログの編集
PERFORM EDIT_FIELDCAT USING CNS_STNM008
CNS_STNM011
CHANGING LTD_FIELDCAT.

* レイアウト構造の編集
PERFORM EDIT_LAYOUT CHANGING LST_LAYOUT.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING I_TD_SDT203.

* ALV一覧形式で出力する
IF RB_ERR IS INITIAL.

**** START ADD 2015/03/03 iSiD Ruan ****
*   バリアントの管理を分けられそうです
LST_VARIANT_E-REPORT = SY-REPID.
IF RB_APP IS NOT INITIAL.
LST_VARIANT_E-HANDLE = '2001'.
ELSE.
LST_VARIANT_E-HANDLE = '2002'.
ENDIF.
**** END ADD 2015/03/03iSiD Ruan ****

CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
**** START ADD 2015/03/03 iSiD Ruan ****
IS_VARIANT               = LST_VARIANT_E
**** END ADD 2015/03/03iSiD Ruan ****
TABLES
T_OUTTAB                 = TD_APP_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.

ELSE.
**** START ADD 2015/03/03 iSiD Ruan ****
*   バリアントの管理を分けられそうです
LST_VARIANT_E-REPORT = SY-REPID.
LST_VARIANT_E-HANDLE = '2003'.
**** END ADD 2015/03/03iSiD Ruan ****

CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
**** START ADD 2015/03/03 iSiD Ruan ****
IS_VARIANT               = LST_VARIANT_E
**** END ADD 2015/03/03iSiD Ruan ****
TABLES
T_OUTTAB                 = TD_ERR_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.
ENDIF.

ENDFORM.                    " ALV_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_W_STRNM08    構造名
*      -->I_W_STRNM11    構造名
*      <--O_TD_SDT203    ITAB:項目カタログ
*----------------------------------------------------------------------*
FORM EDIT_FIELDCAT USING I_W_STRNM08     TYPE TABNAME
I_W_STRNM11     TYPE TABNAME
CHANGING O_TD_FIELDCAT   TYPE LVC_T_FCAT.
* A-3-1．データのALV一覧出力
DATA:
LST_FIELDCAT TYPE LVC_S_FCAT.

CLEAR O_TD_FIELDCAT.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.

CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = I_W_STRNM08
CHANGING
CT_FIELDCAT            = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

LEAVE LIST-PROCESSING.

ENDIF.

LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.
*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.

CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = I_W_STRNM11
CHANGING
CT_FIELDCAT            = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

LEAVE LIST-PROCESSING.

ENDIF.

LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.
*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.

CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = I_W_STRNM08
CHANGING
CT_FIELDCAT            = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

LEAVE LIST-PROCESSING.

ENDIF.

WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*&      Form  EDIT_LAYOUT
*&---------------------------------------------------------------------*
*       レイアウト構造の編集
*----------------------------------------------------------------------*
*      <--O_W_LAYOUT     レイアウト
*----------------------------------------------------------------------*
FORM EDIT_LAYOUT CHANGING O_ST_LAYOUT   TYPE LVC_S_LAYO.

O_ST_LAYOUT-CWIDTH_OPT = ABAP_ON.
O_ST_LAYOUT-ZEBRA      = ABAP_ON.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.

O_ST_LAYOUT-BOX_FNAME = 'CHK'.
*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.

O_ST_LAYOUT-BOX_FNAME = 'CHK'.
*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
*     処理なし
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " EDIT_LAYOUT
*&---------------------------------------------------------------------*
*&      Form  EDIT_ALVDATA
*&---------------------------------------------------------------------*
*       ALV出力データの編集
*----------------------------------------------------------------------*
*      -->I_TD_SDT203      構造名
*      <--O_TD_APP_ALV    ITAB:承認済受注未登録一覧
*      <--O_TD_ERR_ALV    ITAB:エラー一覧
*----------------------------------------------------------------------*
FORM EDIT_ALVDATA USING I_TD_SDT203  TYPE TYP_TD_ZTEGSDT203.
DATA:
LST_SDT203      TYPE TYP_ZTEGSDT203,
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

**** START ADD 2015/03/03 iSiD Ruan ****
DATA:
LTD_MATERDES   TYPE TYP_TD_MATERDES,
LTD_PLANTINFO  TYPE TYP_TD_PLANTINFO,
LTD_INCOTERM   TYPE TYP_TD_INCOTERM,
LTD_PAYTERMS   TYPE TYP_TD_PAYTERMS,
LTD_ODREASON   TYPE TYP_TD_ODREASON,
LTD_STORELOC   TYPE TYP_TD_STORELOC,
LTD_TVAUT      TYPE TYP_TD_TVAUT,
LTD_T001L      TYPE TYP_TD_T001L.
**** END ADD 2015/03/03 iSiD Ruan   ****

REFRESH:
TD_APP_ALV,
TD_ERR_ALV.

**** START ADD 2015/03/03 iSiD Ruan ****
*  ALV表示用項目を取得する
PERFORM GET_ALV_REFDATA USING    I_TD_SDT203
CHANGING LTD_MATERDES
LTD_PLANTINFO
LTD_INCOTERM
LTD_PAYTERMS
LTD_ODREASON
LTD_STORELOC
LTD_TVAUT
LTD_T001L.
**** END ADD 2015/03/03 iSiD Ruan   ****

LOOP AT I_TD_SDT203 INTO LST_SDT203.
LST_APP_ALVDATA-VKORG   = LST_SDT203-VKORG." 販売組織
LST_APP_ALVDATA-VTWEG   = LST_SDT203-VTWEG." 流通チャネル
LST_APP_ALVDATA-SPART   = LST_SDT203-SPART." 製品部門
LST_APP_ALVDATA-VKBUR   = LST_SDT203-VKBUR." 営業所
LST_APP_ALVDATA-VKGRP   = LST_SDT203-VKGRP." 営業グループ
LST_APP_ALVDATA-KUNNR   = LST_SDT203-KUNNR." 受注先
LST_APP_ALVDATA-NAME1   = LST_SDT203-NAME1." 名称 1
LST_APP_ALVDATA-MATNR   = LST_SDT203-MATNR." 品目コード
**** START DEL 2015/03/03 iSiD Ruan ****
*   LST_APP_ALVDATA-ARKTX   = LST_SDT203-TXZ01." 受注明細のテキスト (短)
**** END DEL 2015/03/03 iSiD Ruan ****
LST_APP_ALVDATA-KWMENG  = LST_SDT203-MENGE." 累積受注数量 (販売単位)
LST_APP_ALVDATA-VRKME   = LST_SDT203-MEINS." 販売単位
LST_APP_ALVDATA-NETPR   = LST_SDT203-NETPR." 正味価格
LST_APP_ALVDATA-WAERK   = LST_SDT203-WAERS." 販売伝票通貨
LST_APP_ALVDATA-KPEIN   = LST_SDT203-PEINH." 価格条件単位
LST_APP_ALVDATA-ZVRKME  = LST_SDT203-BPRME." 販売単位
LST_APP_ALVDATA-NETWR   = LST_SDT203-NETWR." 正味価格
LST_APP_ALVDATA-WERKS   = LST_SDT203-DWERK.
" プラント (自社または外部)
LST_APP_ALVDATA-ZEKUNNR = LST_SDT203-ZKUNNR_S.
" 出荷先
LST_APP_ALVDATA-ZEKNAME = LST_SDT203-ZNAME1.
" 出荷先名称
LST_APP_ALVDATA-EDATU   = LST_SDT203-EINDT.
" 納入日程日付
LST_APP_ALVDATA-ZEEMNAM = LST_SDT203-ENAME.
" 従業員名称
LST_APP_ALVDATA-DZTERM  = LST_SDT203-ZTERM.
" 支払条件キー
LST_APP_ALVDATA-BSTKD   = LST_SDT203-EBELN.
" 得意先発注番号
LST_APP_ALVDATA-BSTDK   = LST_SDT203-AEDAT.
" 得意先発注日付
LST_APP_ALVDATA-EBELP   = LST_SDT203-EBELP.
" 購買伝票の明細番号
LST_APP_ALVDATA-AUART   = LST_SDT203-AUART.
" 販売伝票タイプ
LST_APP_ALVDATA-ZABEZEI = LST_SDT203-ZABEZEI.
" 内容説明
LST_APP_ALVDATA-AUGRU   = LST_SDT203-AUGRU.
" 受注理由 (取引理由)
LST_APP_ALVDATA-PERNR   = LST_SDT203-PERNR.
" 営業員
**** START DEL 2015/03/03 iSiD Ruan ****
*    LST_APP_ALVDATA-ZKUNNR_ZJ   = LST_SDT203-ZKUNNR_ZJ.
*    " 最終需要者
*    LST_APP_ALVDATA-ZKUNNR_DS   = LST_SDT203-ZKUNNR_DS.
*    " 最終需要者(商流)
**** END DEL 2015/03/03 iSiD Ruan ****
LST_APP_ALVDATA-VBTYP       = LST_SDT203-VBTYP.
" 販売管理伝票カテゴリ
LST_APP_ALVDATA-KARTV       = LST_SDT203-KARTV.
" 条件タイプ

**** START ADD 2015/03/03 iSiD Ruan ****
LST_APP_ALVDATA-LGORT          = LST_SDT203-LGORT.
LST_APP_ALVDATA-Z_VEND_NAME_DT = LST_SDT203-Z_VEND_NAME_DT.
"名称 （Master）
LST_APP_ALVDATA-Z_ADDRESS1_DT = LST_SDT203-Z_ADDRESS1_DT.
"出荷先住所1
LST_APP_ALVDATA-Z_ADDRESS2_DT = LST_SDT203-Z_ADDRESS2_DT.
"出荷先住所2
LST_APP_ALVDATA-Z_ADDRESS3_DT = LST_SDT203-Z_ADDRESS3_DT.
"出荷先住所3
LST_APP_ALVDATA-Z_ADDRESS4_DT = LST_SDT203-Z_ADDRESS4_DT.
"出荷先住所4

CONCATENATE LST_SDT203-Z_ADDRESS1_DT
LST_SDT203-Z_ADDRESS2_DT
LST_SDT203-Z_ADDRESS3_DT
LST_SDT203-Z_ADDRESS4_DT
INTO LST_APP_ALVDATA-Z_ADDRESS_DT.
"出荷先住所1~4（PO）
LST_APP_ALVDATA-Z_TEL_DT = LST_SDT203-Z_TEL_DT.
"出荷先電話番号（PO）
LST_APP_ALVDATA-Z_FAX_DT = LST_SDT203-Z_FAX_DT.
"出荷先FAX番号（PO）
LST_APP_ALVDATA-INCO1 = LST_SDT203-INCO1.
"インコタームズ (1)
LST_APP_ALVDATA-INCO2 = LST_SDT203-INCO2.
"インコタームズ (2)
LST_APP_ALVDATA-Z_PURPOSE_TEXT = LST_SDT203-Z_PURPOSE_TEXT.
"用途（PO）
LST_APP_ALVDATA-ZKUNNR_ZJ = LST_SDT203-ZKUNNR_ZJ.
"最終需要者
LST_APP_ALVDATA-ZNAME_ZJ = LST_SDT203-ZNAME_ZJ.
"名称1
LST_APP_ALVDATA-ZKUNNR_DS = LST_SDT203-ZKUNNR_DS.
"最終需要者
LST_APP_ALVDATA-ZNAME_DS = LST_SDT203-ZNAME_DS.
"名称1
LST_APP_ALVDATA-Z_PO_ITEM_TXT = LST_SDT203-Z_PO_ITEM_TXT.
"購買発注明細テキスト
LST_APP_ALVDATA-SUBMI = LST_SDT203-SUBMI.
"一括番号 (見積依頼/見積書)

*    ALV表示用項目の読み込み
PERFORM READ_ALV_REFDATA USING     LST_SDT203
LTD_MATERDES
LTD_PLANTINFO
LTD_INCOTERM
LTD_PAYTERMS
LTD_ODREASON
LTD_STORELOC
LTD_TVAUT
LTD_T001L
CHANGING LST_APP_ALVDATA.
**** END UPD 2015/03/03 iSiD Ruan   ****

IF RB_ERR IS INITIAL.
APPEND LST_APP_ALVDATA TO TD_APP_ALV.
ELSE.
LST_ERR_ALVDATA         = LST_APP_ALVDATA.
LST_ERR_ALVDATA-MSGTX   = LST_SDT203-MSGTX.
" メッセージテキスト
APPEND LST_ERR_ALVDATA TO TD_ERR_ALV.
ENDIF.

CLEAR:
LST_APP_ALVDATA,
LST_ERR_ALVDATA.

ENDLOOP.

SORT TD_APP_ALV BY VKORG ASCENDING          " 販売組織
VTWEG ASCENDING          " 流通チャネル
SPART ASCENDING          " 製品部門
BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

SORT TD_ERR_ALV BY VKORG ASCENDING          " 販売組織
VTWEG ASCENDING          " 流通チャネル
SPART ASCENDING          " 製品部門
BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

ENDFORM.                    " EDIT_ALVDATA
*&---------------------------------------------------------------------*
*&      Form  SET_STATUS
*&---------------------------------------------------------------------*
*       ALV画面のステータスの設定
*----------------------------------------------------------------------*
*      -->I_TD_EXTAB       ITAB:ユーザ例外
*----------------------------------------------------------------------*
FORM SET_STATUS USING I_TD_EXTAB TYPE SLIS_T_EXTAB.
DATA:
LST_EXTAB TYPE SLIS_EXTAB.

REFRESH:
I_TD_EXTAB.

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.

SET TITLEBAR 'TITLE_APP'.
SET PF-STATUS 'STATUS_APP'.

*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.

LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_ERR'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB.

*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.

LST_EXTAB-FCODE = '&ALL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = '&SAL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'MODI'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'DEL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_LIST'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB.

WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " SET_STATUS
*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
*       対象データを選択
*----------------------------------------------------------------------*
*      <--O_TD_SELFIELD     ITAB:選択対象データ
*----------------------------------------------------------------------*
FORM SELECT_DATA CHANGING O_TD_SELFIELD TYPE TYP_TD_ERRALVDATA.
DATA:
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

CASE ABAP_ON.
*   ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.

LOOP AT TD_APP_ALV INTO LST_APP_ALVDATA
WHERE CHK IS NOT INITIAL.
MOVE-CORRESPONDING LST_APP_ALVDATA TO LST_ERR_ALVDATA.
APPEND LST_ERR_ALVDATA TO O_TD_SELFIELD.
CLEAR LST_ERR_ALVDATA.
ENDLOOP.

*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.

O_TD_SELFIELD = TD_ERR_ALV.
DELETE O_TD_SELFIELD WHERE CHK IS INITIAL.

WHEN OTHERS.
*   処理なし
ENDCASE.

ENDFORM.                    " SELECT_DAT
*&---------------------------------------------------------------------*
*&      Form  POP_CONFIRM
*&---------------------------------------------------------------------*
*       POP確認
*----------------------------------------------------------------------*
*      -->I_W_TITLEBAR     TITLEBAR
*      -->I_W_QUESTION     TEXT_QUESTION
*      -->I_W_BUTTON1      TEXT_BUTTON_1
*      -->I_W_BUTTON2      TEXT_BUTTON_2
*      <--O_W_ANSWER       ANSWER
*----------------------------------------------------------------------*
FORM POP_CONFIRM USING I_W_TITLEBAR TYPE ANY
I_W_QUESTION TYPE ANY
I_W_BUTTON1  TYPE ANY
I_W_BUTTON2  TYPE ANY
CHANGING O_W_ANSWER   TYPE C.

CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TITLEBAR              = I_W_TITLEBAR
TEXT_QUESTION         = I_W_QUESTION
TEXT_BUTTON_1         = I_W_BUTTON1
TEXT_BUTTON_2         = I_W_BUTTON2
DISPLAY_CANCEL_BUTTON = SPACE
IMPORTING
ANSWER                = O_W_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND        = 1
OTHERS                = 2.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.

ENDFORM.                    " POP_CONFIRM
*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:ロック処理の対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_W_ERRFLG   TYPE C.
DATA:
LW_EBELN        TYPE EBELN,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LTD_PROCESS_TEM TYPE TYP_TD_ERRALVDATA.

LTD_PROCESS[] = I_TD_PROCESS[].

SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.

LOOP AT LTD_PROCESS INTO LST_PROCESS.

LW_EBELN = LST_PROCESS-BSTKD.

CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS_TEM.

O_W_ERRFLG = ABAP_ON.

RETURN.
ELSE.

APPEND LST_PROCESS TO LTD_PROCESS_TEM.
ENDIF.

ENDLOOP.

ENDFORM.                    " LOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_TD_ALVDATA     ITAB:ロックの解除の対象データ
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203 USING I_TD_ALVDATA TYPE TYP_TD_ERRALVDATA.
DATA:
LST_ALVDATA   TYPE TYP_ERR_ALVDATA,
LW_EBELN      TYPE EBELN.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
LW_EBELN = LST_ALVDATA-BSTKD.
CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN.

ENDLOOP.

ENDFORM.                    " UNLOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203
*&---------------------------------------------------------------------*
*       B-2-2．受発注連携データのステータス更新処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:更新処理の対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_W_ERRFLG   TYPE C.
DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LW_DATE       TYPE SY-DATUM,
LW_TIME       TYPE SY-UZEIT.

LW_DATE = SY-DATUM.
LW_TIME = SY-UZEIT.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2    " 処理区分
STATUS       = CNS_STATUS_D    " ステータス
Z_MOD_YMD    = LW_DATE         " 更新年月日
Z_MOD_HMS    = LW_TIME         " 更新時分秒
Z_MOD_USERID = SY-UNAME        " 更新ユーザ
**** START ADD 2015/03/03 iSiD Ruan ****
DWERK        = LST_PROCESS-WERKS      " 出荷プラント
LGORT_SO     = LST_PROCESS-LGORT       "保管場所
**** END ADD 2015/03/03 iSiD Ruan ****
WHERE EBELN        = LST_PROCESS-BSTKD
" 購買伝票番号
AND EBELP        = LST_PROCESS-EBELP.
" 購買伝票の明細番号

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
ROLLBACK WORK.
*    データ更新に失敗しました(TBL = &1)
MESSAGE S024(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_PROCESS.
ENDIF.

ENDLOOP.

ENDFORM.                    " UPDATE_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_AGAIN
*&---------------------------------------------------------------------*
*       B-3．ALV画面を再表示処理
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_AGAIN.
DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203,
LW_ERRFLG      TYPE C.

*  ラジオボタン「承認一覧(Approve)」を指定した場合
IF RB_APP IS NOT INITIAL.

*   A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL .
CLEAR TD_APP_ALV.
RETURN.
ENDIF.

*   A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.

ENDIF.

* ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
IF RB_ERR IS NOT INITIAL.

*   A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL .
CLEAR TD_ERR_ALV.
RETURN.
ENDIF.

*   販売伝票タイプを取得
PERFORM GET_DATA_205 CHANGING LTD_ZTEGSDT203.

ENDIF.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING LTD_ZTEGSDT203.

ENDFORM.                    " DISPLAY_ALV_AGAIN
*&---------------------------------------------------------------------*
*&      Form  EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*       C-2-1．シミュレーション対象データの補足処理。
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM EDIT_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA.

**** START ADD 2015/03/03 iSiD Ruan ****
IF W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ;ON
RETURN.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****

LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

REFRESH O_TD_PROCESS.

LOOP AT I_TD_APP_ALV INTO LST_APP_ALV.

READ TABLE LTD_PROCESS TRANSPORTING NO FIELDS
WITH KEY BSTKD = LST_APP_ALV-BSTKD
BINARY SEARCH.

IF SY-SUBRC = 0.
MOVE-CORRESPONDING LST_APP_ALV TO LST_PROCESS_TEM.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDIF.

ENDLOOP.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*&      Form  BAPI_SALESORDER_CREAT
*&---------------------------------------------------------------------*
*       C-2-2．受注シミュレーション処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:処理の対象データ
*      <--O_TD_UPDATE      ITAB;更新対象データ
*      <--O_W_ERRFLG       BAPIエラーフラッグ
*      <--O_TD_MESSAGE     ITAB:BAPIエラーメッセージ
*----------------------------------------------------------------------*
FORM BAPI_SALESORDER_CREAT USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_UPDATE  TYPE TYP_TD_ALVDATA
O_W_ERRFLG   TYPE C
O_TD_MESSAGE TYPE TYP_TD_BAPIMSG.
DATA:
LST_PROCESS       TYPE TYP_ERR_ALVDATA,
LST_TEM_PROCESS   TYPE TYP_TEM_ALVDATA,
LST_TEM_PROCESS1  TYPE TYP_TEM_ALVDATA,
LTD_TEM_PROCESS   TYPE TYP_TD_ALVDATA,
LST_HEADER_IN     TYPE BAPISDHD1,
LST_ORDER_PARTNER TYPE BAPIPARNR,
LTD_ORDER_PARTNER TYPE STANDARD TABLE OF BAPIPARNR,
LST_ITEMS_IN      TYPE BAPISDITM,
LTD_ITEMS_IN      TYPE STANDARD TABLE OF BAPISDITM,
LST_SCHEDULES     TYPE BAPISCHDL,
LTD_SCHEDULES     TYPE STANDARD TABLE OF BAPISCHDL,
LST_CONDITIONS    TYPE BAPICOND,
LTD_CONDITIONS    TYPE STANDARD TABLE OF BAPICOND,
**** START ADD 2015/03/03 iSiD Ruan ****
LTD_ORDER_TEXT    TYPE STANDARD TABLE OF BAPISDTEXT,
LST_ORDER_TEXT    TYPE BAPISDTEXT,
LTD_PARTNERADD    TYPE STANDARD TABLE OF BAPIADDR1,
LST_PARTNERADD    TYPE BAPIADDR1,
LW_ADRNR          TYPE KNA1-ADRNR,
LST_ADRC          TYPE ADRC,
**** END ADD 2015/03/03 iSiD Ruan   ****
LW_NUMBER         TYPE POSNR_VA,
LW_COND_VALUE     TYPE BAPICURR-BAPICURR,
LTD_RETURN        TYPE STANDARD TABLE OF BAPIRET2,
LST_RETURN        TYPE BAPIRET2,
LST_MESSAGE       TYPE TYP_BAPIMSG,
LST_SWITCH        TYPE BAPISDLS.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
MOVE-CORRESPONDING LST_PROCESS TO LST_TEM_PROCESS.
**** START ADD 2015/03/03 iSiD Ruan ****
LST_TEM_PROCESS-LGPRO = LST_PROCESS-LGORT."保管場所
**** END ADD 2015/03/03 iSiD Ruan ****
APPEND LST_TEM_PROCESS TO LTD_TEM_PROCESS.
CLEAR LST_TEM_PROCESS.
ENDLOOP.

LOOP AT LTD_TEM_PROCESS INTO LST_TEM_PROCESS1.

LST_TEM_PROCESS = LST_TEM_PROCESS1.

AT NEW BSTKD.
*     @受注伝票ヘッダ
LST_HEADER_IN-DOC_TYPE   = LST_TEM_PROCESS-AUART.
" 販売伝票タイプ
LST_HEADER_IN-SALES_ORG  = LST_TEM_PROCESS-VKORG.
" 販売組織
LST_HEADER_IN-DISTR_CHAN = LST_TEM_PROCESS-VTWEG.
" 流通チャネル
LST_HEADER_IN-DIVISION   = LST_TEM_PROCESS-SPART.
" 製品部門
LST_HEADER_IN-SALES_GRP  = LST_TEM_PROCESS-VKGRP.
" 営業グループ
LST_HEADER_IN-SALES_OFF  = LST_TEM_PROCESS-VKBUR.
" 営業所
LST_HEADER_IN-PURCH_NO_C = LST_TEM_PROCESS-BSTKD.
" 得意先発注番号
LST_HEADER_IN-PURCH_DATE = LST_TEM_PROCESS-BSTDK.
" 得意先発注日付
LST_HEADER_IN-ORD_REASON = LST_TEM_PROCESS-AUGRU.
" 受注理由 (取引理由)
LST_HEADER_IN-CURRENCY   = LST_TEM_PROCESS-WAERK.
" 販売伝票通貨
LST_HEADER_IN-REQ_DATE_H = LST_TEM_PROCESS-EDATU.
" 指定納入期日
**** START ADD 2015/03/03 iSiD Ruan ****
LST_HEADER_IN-COLLECT_NO   = LST_TEM_PROCESS-SUBMI.
" 一括番号
LST_HEADER_IN-INCOTERMS1 = LST_TEM_PROCESS-INCO1.
" インコタームズ
LST_HEADER_IN-INCOTERMS2 = LST_TEM_PROCESS-INCO2.
" インコタームズ
**** END ADD 2015/03/03 iSiD Ruan   ****
ENDAT.

*   B明細データ
LW_NUMBER = LW_NUMBER + 10.
LST_ITEMS_IN-ITM_NUMBER = LW_NUMBER.      " 販売伝票明細
LST_ITEMS_IN-MATERIAL   = LST_TEM_PROCESS-MATNR.
" 品目コード
LST_ITEMS_IN-SHORT_TEXT = LST_TEM_PROCESS-ARKTX.
" 受注明細のテキスト (短)
LST_ITEMS_IN-PLANT      = LST_TEM_PROCESS-WERKS.
" プラント
**** START ADD 2015/03/03 iSiD Ruan ****
LST_ITEMS_IN-STORE_LOC = LST_TEM_PROCESS-LGPRO."保管場所
**** END ADD 2015/03/03 iSiD Ruan ****
LST_ITEMS_IN-SALES_UNIT = LST_TEM_PROCESS-VRKME.
" 販売単位

IF LST_TEM_PROCESS-KWMENG > CNS_MENG_MAX.
LST_ITEMS_IN-TARGET_QTY = CNS_MENG_MAX.
ELSE.
LST_ITEMS_IN-TARGET_QTY = LST_TEM_PROCESS-KWMENG.
ENDIF.
" 販売単位による受注数量
LST_ITEMS_IN-TARGET_QU  = LST_TEM_PROCESS-VRKME.
" 目標数量 (数量単位)
LST_ITEMS_IN-REF_DOC    = LST_TEM_PROCESS-BSTKD.
" 参照伝票番号
LST_ITEMS_IN-REF_DOC_IT = LST_TEM_PROCESS-EBELP.
" 参照明細番号
APPEND LST_ITEMS_IN TO LTD_ITEMS_IN.
CLEAR LST_ITEMS_IN.

*   D納入日程行データ
LST_SCHEDULES-ITM_NUMBER = LW_NUMBER.     " 販売伝票明細
LST_SCHEDULES-SCHED_LINE = CNS_LINE_01.   " 納入日程行
LST_SCHEDULES-REQ_DATE   = LST_TEM_PROCESS-EDATU.
" 納入日程日付
IF LST_TEM_PROCESS-KWMENG > CNS_MENG_MAX.
LST_SCHEDULES-REQ_QTY  = CNS_MENG_MAX.
ELSE.
LST_SCHEDULES-REQ_QTY  = LST_TEM_PROCESS-KWMENG.
ENDIF.
" 販売単位による受注数量
APPEND LST_SCHEDULES TO LTD_SCHEDULES.
CLEAR LST_SCHEDULES.

LST_CONDITIONS-ITM_NUMBER = LW_NUMBER.    " 販売伝票明細
IF LST_TEM_PROCESS-KARTV IS INITIAL.
LST_CONDITIONS-COND_TYPE  = CNS_COND_ZPR0.
ELSE.
LST_CONDITIONS-COND_TYPE = LST_TEM_PROCESS-KARTV.
ENDIF.
" 条件タイプ
CLEAR LW_COND_VALUE.
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = LST_TEM_PROCESS-WAERK
AMOUNT_INTERNAL = LST_TEM_PROCESS-NETPR
IMPORTING
AMOUNT_EXTERNAL = LW_COND_VALUE.      " 条件レート

LST_CONDITIONS-COND_VALUE = LW_COND_VALUE." 条件レート
LST_CONDITIONS-CURRENCY   = LST_TEM_PROCESS-WAERK.
" 通貨コード
LST_CONDITIONS-COND_UNIT  = LST_TEM_PROCESS-ZVRKME.
" 条件単位
LST_CONDITIONS-COND_P_UNT = LST_TEM_PROCESS-KPEIN.
" 販売単位
APPEND LST_CONDITIONS TO LTD_CONDITIONS.
CLEAR LST_CONDITIONS.

APPEND LST_TEM_PROCESS TO O_TD_UPDATE.

**** START ADD 2015/03/03 iSiD Ruan ****
*   テキスト
LST_ORDER_TEXT-ITM_NUMBER = LW_NUMBER."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = '0001'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-ARKTX."テキスト行
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.
**** END ADD 2015/03/03 iSiD Ruan   ****

AT END OF BSTKD.
*     C伝票取引先
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SP.
" 受注先「SP」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-KUNNR.
" 受注先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SH.
" 出荷先「SH」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZEKUNNR.
" 出荷先
**** START ADD 2015/03/03 iSiD Ruan ****
*      海外の場合、出荷先の情報を上書き
IF W_FLGHEADOF IS INITIAL.
LST_ORDER_PARTNER-ADDR_LINK = '1'.      "住所コードへのリンク
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_PE.
" 営業員「PE」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-PERNR.
" 営業員
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZJ.
" 最終需要者「ZJ」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_ZJ.
" 最終需要者
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.

**** START UPD 2015/03/03 iSiD Ruan ****
*      LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZC.
*      " 最終需要者(商流)「ZC」
*      LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_DS.
*      " 最終需要者(商流)
*      APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
*      CLEAR LST_ORDER_PARTNER.

IF LST_TEM_PROCESS-ZKUNNR_DS IS NOT INITIAL.
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZC.
" 最終需要者(商流)「ZC」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_DS.
" 最終需要者(商流)
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
CLEAR LST_ORDER_PARTNER.
ENDIF.

*     本社の場合、ヘッダテキストの設定
IF W_FLGHEADOF IS NOT INITIAL.
*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '01'.     "1行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_VEND_NAME_DT.
"出荷先名（PO）
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '02'.     "1行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS1_DT.
"出荷先住所1
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '03'.     "2行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS2_DT.
"出荷先住所2
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '04'.     "3行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS3_DT.
"出荷先住所3
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '05'.     "4行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS4_DT.
"出荷先住所4
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '06'.     "5行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_TEL_DT.
"出荷先電話
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-FORMAT_COL = '07'.     "6行目
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_FAX_DT.
"出荷先FAX
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.

ELSE.
*      海外の場合、出荷先の情報を上書き

SELECT SINGLE ADRNR
INTO LW_ADRNR
FROM KNA1
WHERE KUNNR = LST_TEM_PROCESS-ZEKUNNR.

SELECT *
INTO LST_ADRC
FROM ADRC UP TO 1 ROWS
WHERE ADDRNUMBER = LW_ADRNR.
ENDSELECT.

LST_PARTNERADD-ADDR_NO    = '1'.
LST_PARTNERADD-NAME     = LST_TEM_PROCESS-Z_VEND_NAME_DT.
"名称 1
LST_PARTNERADD-NAME_2     = LST_TEM_PROCESS-Z_VEND_NAME_DT.
"名称 2
LST_PARTNERADD-STREET     = LST_TEM_PROCESS-Z_ADDRESS1_DT.
"地名
LST_PARTNERADD-CITY       = LST_TEM_PROCESS-Z_ADDRESS2_DT.
"市区町村
LST_PARTNERADD-STR_SUPPL1 = LST_TEM_PROCESS-Z_ADDRESS3_DT.
"地名 2
LST_PARTNERADD-POSTL_COD1 = LST_ADRC-POST_CODE1.
"市区町村の郵便番号
LST_PARTNERADD-HOUSE_NO = LST_ADRC-HOUSE_NUM1.
"番地-号
LST_PARTNERADD-COUNTRY = LST_ADRC-COUNTRY.
"国コード
LST_PARTNERADD-LANGU = LST_ADRC-LANGU.
"言語キー
LST_PARTNERADD-REGION = LST_ADRC-REGION.
"地域 (都道府県)
LST_PARTNERADD-TIME_ZONE = LST_ADRC-TIME_ZONE.
"アドレスタイムゾーン
LST_PARTNERADD-STR_SUPPL2 = LST_TEM_PROCESS-Z_ADDRESS4_DT.
"地名 3
LST_PARTNERADD-TEL1_NUMBR  = LST_TEM_PROCESS-Z_TEL_DT.
"電話番号 1
LST_PARTNERADD-FAX_NUMBER = LST_TEM_PROCESS-Z_FAX_DT.
"FAX 番号
APPEND LST_PARTNERADD TO LTD_PARTNERADD.
CLEAR LST_PARTNERADD.
ENDIF.
**** END UPD 2015/03/03 iSiD Ruan   ****

LST_SWITCH-PRICING = CNS_PRICING_G.
" 価格要素のコピー (変更なし)/税の再決定

DATA LW_VBELN TYPE VBELN.

IF LST_TEM_PROCESS-VBTYP = CNS_VBTYP_C.

CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
EXPORTING
ORDER_HEADER_IN     = LST_HEADER_IN
LOGIC_SWITCH        = LST_SWITCH
*            TESTRUN             = ABAP_ON
IMPORTING
SALESDOCUMENT       = LW_VBELN
TABLES
RETURN              = LTD_RETURN
ORDER_ITEMS_IN      = LTD_ITEMS_IN
ORDER_PARTNERS      = LTD_ORDER_PARTNER
ORDER_SCHEDULES_IN  = LTD_SCHEDULES
ORDER_CONDITIONS_IN = LTD_CONDITIONS
**** START ADD 2015/03/03 iSiD Ruan ****
ORDER_TEXT          = LTD_ORDER_TEXT
PARTNERADDRESSES    = LTD_PARTNERADD.
**** END ADD 2015/03/03 iSiD Ruan   ****
ELSE.

CALL FUNCTION 'SD_SALESDOCUMENT_CREATE'
EXPORTING
SALES_HEADER_IN     = LST_HEADER_IN
LOGIC_SWITCH        = LST_SWITCH
*            TESTRUN             = ABAP_ON
TABLES
RETURN              = LTD_RETURN
SALES_ITEMS_IN      = LTD_ITEMS_IN
SALES_PARTNERS      = LTD_ORDER_PARTNER
SALES_SCHEDULES_IN  = LTD_SCHEDULES
SALES_CONDITIONS_IN = LTD_CONDITIONS
**** START ADD 2015/03/03 iSiD Ruan ****
SALES_TEXT          = LTD_ORDER_TEXT
PARTNERADDRESSES    = LTD_PARTNERADD.
**** END ADD 2015/03/03 iSiD Ruan   ****
ENDIF.

LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E
OR TYPE = CNS_MSG_A.

LOOP AT LTD_ITEMS_IN INTO LST_ITEMS_IN.
LST_MESSAGE-BSTKD   = LST_ITEMS_IN-REF_DOC.
LST_MESSAGE-EBELP   = LST_ITEMS_IN-REF_DOC_IT.
LST_MESSAGE-MESSAGE = LST_RETURN-MESSAGE.
APPEND LST_MESSAGE TO O_TD_MESSAGE.
CLEAR LST_MESSAGE.
ENDLOOP.

O_W_ERRFLG = ABAP_ON.

EXIT.
ENDLOOP.

CLEAR:
LST_HEADER_IN,
LW_NUMBER.

REFRESH:
LTD_ITEMS_IN,
LTD_ORDER_PARTNER,
LTD_SCHEDULES,
LTD_CONDITIONS.
ENDAT.

ENDLOOP.

IF O_TD_MESSAGE IS NOT INITIAL.
SORT O_TD_MESSAGE BY BSTKD ASCENDING
EBELP ASCENDING.
ENDIF.

ENDFORM.                    " BAPI_SALESORDER_CREAT
*&---------------------------------------------------------------------*
*&      Form  CHECK_TD_PROCESS
*&---------------------------------------------------------------------*
*       購買発注番号混在チェック
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      -->I_TD_ERR_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM CHECK_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
I_TD_ERR_ALV TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA,
LTD_APP_ALV     TYPE TYP_TD_APPALVDATA,
LW_CUNT         TYPE I.

LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

DESCRIBE TABLE LTD_PROCESS LINES LW_CUNT.
IF LW_CUNT > 1.
*   変更の場合、同一購買発注のみ指定できます
MESSAGE E047(ZMEGSD01).
ENDIF.

**** START ADD 2015/03/03 iSiD Ruan ****
IF W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ;ON
RETURN.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****

REFRESH O_TD_PROCESS.

READ TABLE LTD_PROCESS INTO LST_PROCESS INDEX 1.

IF RB_APP IS NOT INITIAL.

LTD_APP_ALV[] = I_TD_APP_ALV[].
DELETE LTD_APP_ALV WHERE BSTKD <> LST_PROCESS-BSTKD.

LOOP AT LTD_APP_ALV INTO LST_APP_ALV.
MOVE-CORRESPONDING LST_APP_ALV TO LST_PROCESS_TEM.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDLOOP.

ENDIF.

IF RB_ERR IS NOT INITIAL.
O_TD_PROCESS = I_TD_ERR_ALV.
DELETE O_TD_PROCESS WHERE BSTKD <> LST_PROCESS-BSTKD.
ENDIF.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_205
*&---------------------------------------------------------------------*
*       販売伝票タイプの検索
*----------------------------------------------------------------------*
*      <--O_TD_SDT203      ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM GET_DATA_205 CHANGING O_TD_SDT203 TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_DATA_205     TYPE TYP_TD_205,
LTD_DATA_205_TEM TYPE TYP_TD_205,
LST_DATA_205     TYPE TYP_DATA_205,
LTD_PROCESS      TYPE TYP_TD_ZTEGSDT203,
LTD_203          TYPE TYP_TD_ZTEGSDT203,
LTD_SDT203       TYPE TYP_TD_ZTEGSDT203,
LTD_KALVG        TYPE TYP_TD_KALVG,
LST_KALVG        TYPE TYP_KALVG,
LTD_KALKS        TYPE TYP_TD_KALKS,
LST_KALKS        TYPE TYP_KALKS,
LTD_COND_TYPE    TYPE TYP_TD_COND_TYPE,
LST_COND_TYPE    TYPE TYP_COND_TYPE,
LST_TVAKT        TYPE TYP_TVAKT,
LTD_TVAKT        TYPE STANDARD TABLE OF TYP_TVAKT.

FIELD-SYMBOLS:
<LFS_ST_DATA_205> TYPE TYP_DATA_205,
<LFS_ST_SDT203>   TYPE TYP_ZTEGSDT203.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.

AT FIRST.
LTD_SDT203[] = O_TD_SDT203[].
SORT LTD_SDT203 BY BSART ASCENDING      " 購買伝票タイプ
KNTTP ASCENDING.     " 勘定設定カテゴリ
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING BSART   " 購買伝票タイプ
KNTTP.  " 勘定設定カテゴリ
SELECT ZTEGSDT205~BSART                 " 購買伝票タイプ
ZTEGSDT205~KNTTP                 " 勘定設定カテゴリ
ZTEGSDT205~AUART                 " 販売伝票タイプ
TVAK~VBTYP                       " 販売管理伝票カテゴリ
FROM ZTEGSDT205
INNER JOIN TVAK
ON ZTEGSDT205~AUART = TVAK~AUART
INTO CORRESPONDING FIELDS OF TABLE LTD_DATA_205
FOR ALL ENTRIES IN LTD_SDT203
WHERE ZTEGSDT205~BSART = LTD_SDT203-BSART
" 購買伝票タイプ
AND ZTEGSDT205~KNTTP = LTD_SDT203-KNTTP.
" 勘定設定カテゴリ

IF SY-SUBRC = 0.

LTD_DATA_205_TEM = LTD_DATA_205.
SORT LTD_DATA_205_TEM BY AUART ASCENDING.
" 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205_TEM
COMPARING AUART." 販売伝票タイプ

SELECT AUART                          " 販売伝票タイプ
BEZEI                          " 販売伝票タイプテキスト
FROM TVAKT
INTO TABLE LTD_TVAKT
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART " 販売伝票タイプ
AND SPRAS = SY-LANGU.              " システム言語

IF SY-SUBRC = 0.
SORT LTD_TVAKT BY AUART ASCENDING.
ENDIF.

LOOP AT LTD_DATA_205 ASSIGNING <LFS_ST_DATA_205>.
CLEAR LST_TVAKT.
READ TABLE LTD_TVAKT INTO LST_TVAKT
WITH KEY AUART = <LFS_ST_DATA_205>-AUART
BINARY SEARCH.
<LFS_ST_DATA_205>-BEZEI = LST_TVAKT-BEZEI.
" 販売伝票タイプテキスト
ENDLOOP.
SORT LTD_DATA_205  BY BSART ASCENDING " 購買伝票タイプ
KNTTP ASCENDING." 勘定設定カテゴリ

SELECT AUART                          " 販売伝票タイプ
KALVG                          " 伝票決定区分
FROM TVAK
INTO TABLE LTD_KALVG
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART." 販売伝票タイプ

IF SY-SUBRC = 0.

SORT LTD_KALVG BY AUART ASCENDING.  " 販売伝票タイプ

ENDIF.

ENDIF.

LTD_203[] = O_TD_SDT203[].
SORT LTD_203 BY     KUNNR ASCENDING     " 得意先コード
VKORG ASCENDING     " 販売組織
VTWEG ASCENDING     " 流通チャネル
SPART ASCENDING.    " 製品部門

SELECT KUNNR                                " 得意先コード
VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALKS                                " 価格決定区分割当
FROM KNVV
INTO TABLE LTD_KALKS
FOR ALL ENTRIES IN LTD_203
WHERE KUNNR = LTD_203-KUNNR                " 得意先コード
AND VKORG = LTD_203-VKORG                " 販売伝票タイプ
AND VTWEG = LTD_203-VTWEG                " 販売組織
AND SPART = LTD_203-SPART.               " 製品部門

IF SY-SUBRC = 0.

SORT LTD_KALKS BY  KUNNR ASCENDING        " 得意先コード
VKORG ASCENDING        " 販売伝票タイプ
VTWEG ASCENDING        " 販売組織
SPART ASCENDING.       " 製品部門

ENDIF.

LTD_PROCESS[] = O_TD_SDT203[].
SORT LTD_PROCESS BY VKORG ASCENDING         " 販売組織
VTWEG ASCENDING         " 流通チャネル
SPART ASCENDING.        " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING VKORG       " 販売組織
VTWEG       " 流通チャネル
SPART.      " 製品部門

SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALVG                                " 伝票決定区分
KALKS                                " 価格決定区分割当
KARTV                                " 条件タイプ
FROM T683V
INTO TABLE LTD_COND_TYPE
FOR ALL ENTRIES IN LTD_PROCESS
WHERE VKORG = LTD_PROCESS-VKORG            " 販売伝票タイプ
AND VTWEG = LTD_PROCESS-VTWEG            " 販売組織
AND SPART = LTD_PROCESS-SPART.           " 製品部門

SORT LTD_COND_TYPE  BY VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING      " 製品部門
KALVG ASCENDING      " 伝票決定区分
KALKS ASCENDING.     " 価格決定区分割当

ENDAT.

CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = <LFS_ST_SDT203>-BSART
KNTTP = <LFS_ST_SDT203>-KNTTP
BINARY SEARCH.
IF SY-SUBRC = 0.
<LFS_ST_SDT203>-AUART   = LST_DATA_205-AUART.
" 販売伝票タイプ
<LFS_ST_SDT203>-ZABEZEI = LST_DATA_205-BEZEI.
" 販売伝票タイプテキスト
<LFS_ST_SDT203>-VBTYP   = LST_DATA_205-VBTYP.
" 販売管理伝票カテゴリ
*     伝票決定区分の取得処理
CLEAR LST_KALVG.
READ TABLE LTD_KALVG INTO LST_KALVG BINARY SEARCH
WITH KEY AUART = LST_DATA_205-AUART.
ENDIF.

*   価格決定区分割当の取得処理
CLEAR LST_KALKS.
READ TABLE LTD_KALKS INTO LST_KALKS BINARY SEARCH
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART.

*   条件タイプの取得処理
CLEAR LST_COND_TYPE.
READ TABLE LTD_COND_TYPE INTO LST_COND_TYPE BINARY SEARCH
WITH KEY VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
KALVG = LST_KALVG-KALVG
KALKS = LST_KALKS-KALKS.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-KARTV = LST_COND_TYPE-KARTV.
ENDIF.

ENDLOOP.

ENDFORM.                    " GET_DATA_205
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_BAPI
*&---------------------------------------------------------------------*
*       C-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_W_MESSAGE      メッセージ
*      -->I_ST_ALVDATA     BAPI処理対象
*      -->I_W_DATUM        更新年月日
*      -->I_W_UZEIT        更新時分秒
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_BAPI USING I_KBUNCC      TYPE C
I_STATUS      TYPE C
I_W_MESSAGE   TYPE BAPI_MSG
I_ST_ALVDATA  TYPE TYP_TEM_ALVDATA
I_W_DATUM     TYPE SY-DATUM
I_W_UZEIT     TYPE SY-UZEIT
CHANGING O_W_ERRFLG   TYPE C.

UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC              " 処理区分
STATUS       = I_STATUS              " ステータス
ZKUNNR_S     = I_ST_ALVDATA-ZEKUNNR
" 出荷先
**** START DEL 2015/03/03 iSiD Ruan ****
*         ZKUNNR_ZJ    = I_ST_ALVDATA-ZKUNNR_ZJ
*                                              " 最終需要者
*         ZKUNNR_DS    = I_ST_ALVDATA-ZKUNNR_DS
*                                              " 最終需要者（商流）
**** END DEL 2015/03/03 iSiD Ruan ****

PERNR        = I_ST_ALVDATA-PERNR
" 営業員
AUGRU        = I_ST_ALVDATA-AUGRU    " 受注理由
DWERK        = I_ST_ALVDATA-WERKS
" 出荷プラント
**** START ADD 2015/03/03 iSiD Ruan ****
LGORT_SO     = I_ST_ALVDATA-LGPRO       "保管場所
**** END ADD 2015/03/03 iSiD Ruan ****
MSGTX        = I_W_MESSAGE           " メッセージ
Z_MOD_YMD    = I_W_DATUM             " 更新年月日
Z_MOD_HMS    = I_W_UZEIT             " 更新時分秒
Z_MOD_USERID = SY-UNAME              " 更新ユーザ
WHERE EBELN        = I_ST_ALVDATA-BSTKD
" 購買伝票番号
AND EBELP        = I_ST_ALVDATA-EBELP.
" 購買伝票の明細番号

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_BAPI
*&---------------------------------------------------------------------*
*&      Form  SET_SCREEN_9000
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS      ITAB:ALV処理対象データ
*      <--O_ZSEGSD0009      SCREEN9000ヘッダデータ
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*      <--O_TD_ITEM_ALV_INI SCREEN9000明細データ初期値
*----------------------------------------------------------------------*
FORM SET_SCREEN_9000 USING I_TD_PROCESS      TYPE TYP_TD_ERRALVDATA
CHANGING O_ZSEGSD0009      TYPE ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM
O_TD_ITEM_ALV_INI TYPE TYP_TD_ITEM.
DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LST_ZTERM     TYPE TYP_ZTERM,
LW_NETWR      TYPE NETWR,
**** START ADD 2015/03/03 iSiD Ruan ****
LW_EBELP      TYPE EBELP,
**** END ADD 2015/03/03 iSiD Ruan   ****
LW_VKORGTEXT  TYPE VTXTK,
LW_VTWEGTEXT  TYPE VTXTK,
LW_SPARTTEXT  TYPE VTXTK,
LW_ZESALESTXT TYPE ZESALESTXT,
LST_ITEM_ALV  TYPE TYP_ALV_ITEM,
LST_ALV_ITEM  TYPE TYP_ALV_ITEM,
LW_POSNR      TYPE POSNR_VA.

CLEAR:
LW_NETWR,
O_ZSEGSD0009.

REFRESH:
O_TD_ITEM_ALV,
O_TD_ITEM_ALV_INI.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
IF SY-TABIX = 1.
O_ZSEGSD0009-VKORG    = LST_PROCESS-VKORG.
" 販売組織
O_ZSEGSD0009-VTWEG    = LST_PROCESS-VTWEG.
" 流通チャネル
O_ZSEGSD0009-SPART    = LST_PROCESS-SPART.
" 製品部門
O_ZSEGSD0009-VKBUR    = LST_PROCESS-VKBUR.
" 営業所
O_ZSEGSD0009-VKGRP    = LST_PROCESS-VKGRP.
" 営業グループ
O_ZSEGSD0009-ZEKUNNR1 = LST_PROCESS-KUNNR.
" 受注先
O_ZSEGSD0009-ZEKNAME1 = LST_PROCESS-NAME1.
" 受注先名称
O_ZSEGSD0009-ZEKUNNR  = LST_PROCESS-ZEKUNNR.
" 出荷先
O_ZSEGSD0009-ZEKNAME  = LST_PROCESS-ZEKNAME.
" 出荷先名称
**** START UPD 2015/03/03 iSiD Ruan ****
*      O_ZSEGSD0009-ZEKUNNR2 = LST_PROCESS-ZKUNNR_ZJ.
*      " 最終需要者
*      O_ZSEGSD0009-ZEKUNNR3 = LST_PROCESS-ZKUNNR_DS.
*      " 最終需要者(商流)
O_ZSEGSD0009-Z_ADDRESS1_DT = LST_PROCESS-Z_ADDRESS1_DT.
" 出荷先住所1
O_ZSEGSD0009-Z_ADDRESS2_DT = LST_PROCESS-Z_ADDRESS2_DT.
" 出荷先住所2
O_ZSEGSD0009-Z_ADDRESS3_DT = LST_PROCESS-Z_ADDRESS3_DT.
" 出荷先住所3
O_ZSEGSD0009-Z_ADDRESS4_DT = LST_PROCESS-Z_ADDRESS4_DT.
" 出荷先住所4
O_ZSEGSD0009-Z_VEND_NAME_DT = LST_PROCESS-Z_VEND_NAME_DT.
" 出荷先名（PO）
O_ZSEGSD0009-Z_ADDRESS_DT   = LST_PROCESS-Z_ADDRESS_DT.
" 出荷先住所（PO）
O_ZSEGSD0009-Z_TEL_DT  = LST_PROCESS-Z_TEL_DT.
" 出荷先電話番号（PO）
O_ZSEGSD0009-Z_FAX_DT  = LST_PROCESS-Z_FAX_DT.
" 出荷先FAX番号（PO）
O_ZSEGSD0009-INCO1     = LST_PROCESS-INCO1.
" インコタームズ (1)
O_ZSEGSD0009-INCO2 = LST_PROCESS-INCO2.
" インコタームズ (2)
O_ZSEGSD0009-ZBEZEI_IC = LST_PROCESS-ZBEZEI_IC.
" テキスト
O_ZSEGSD0009-SUBMI     = LST_PROCESS-SUBMI.
" 一括番号
O_ZSEGSD0009-ZKUNNR_ZJ = LST_PROCESS-ZKUNNR_ZJ.
" 最終需要者
O_ZSEGSD0009-ZNAME_ZJ  = LST_PROCESS-ZNAME_ZJ.
" 名称 1
O_ZSEGSD0009-ZKUNNR_DS = LST_PROCESS-ZKUNNR_DS.
" 最終需要者(価格)
O_ZSEGSD0009-ZNAME_DS = LST_PROCESS-ZNAME_DS.
" 名称 1
**** END UPD 2015/03/03 iSiD Ruan ****
O_ZSEGSD0009-PERNR    = LST_PROCESS-PERNR.
" 営業員
O_ZSEGSD0009-ENAME    = LST_PROCESS-ZEEMNAM.
" 営業員氏名
O_ZSEGSD0009-BSTKD    = LST_PROCESS-BSTKD.
" 購買発注番号
**** START ADD 2015/03/03 iSiD Ruan ****
IF W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ;ON
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT         = LST_PROCESS-EBELP
IMPORTING
OUTPUT        = LW_EBELP
.
" 購買発注番号
CONCATENATE LST_PROCESS-BSTKD
'/'
LW_EBELP
INTO O_ZSEGSD0009-BSTKD.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****
O_ZSEGSD0009-BSTDK    = LST_PROCESS-BSTDK.
" 購買発注伝票日付
O_ZSEGSD0009-AUART    = LST_PROCESS-AUART.
" 販売伝票タイプ
O_ZSEGSD0009-ZABEZEI  = LST_PROCESS-ZABEZEI.
" 販売伝票タイプテキスト
O_ZSEGSD0009-AUGRU    = LST_PROCESS-AUGRU.
" 受注理由 (取引理由)

*     D-2-1-3．販売エリアのテキストの設定処理。
SELECT SINGLE VTEXT
INTO LW_VKORGTEXT
FROM TVKOT
WHERE SPRAS = SY-LANGU
AND VKORG = LST_PROCESS-VKORG.

IF SY-SUBRC = 0
AND LW_VKORGTEXT IS NOT INITIAL.
LW_ZESALESTXT = LW_VKORGTEXT.
ENDIF.

*     D-2-1-3-2．流通チャネルの名称の取得処理
SELECT SINGLE VTEXT
INTO LW_VTWEGTEXT
FROM TVTWT
WHERE SPRAS = SY-LANGU
AND VTWEG = LST_PROCESS-VTWEG.

IF SY-SUBRC = 0
AND LW_VTWEGTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_VTWEGTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_VTWEGTEXT.
ENDIF.
ENDIF.

*     D-2-1-3-3．製品部門の名称の取得処理
SELECT SINGLE VTEXT
INTO LW_SPARTTEXT
FROM TSPAT
WHERE SPRAS = SY-LANGU
AND SPART = LST_PROCESS-SPART.

IF SY-SUBRC = 0
AND LW_SPARTTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_SPARTTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_SPARTTEXT.
ENDIF.
ENDIF.

O_ZSEGSD0009-ZESALESTXT = LW_ZESALESTXT." 販売エリアテキスト

*     D-2-1-4．営業所のテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = LST_PROCESS-VKBUR.

*     D-2-1-5．営業グループのテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = LST_PROCESS-VKGRP.

*     D-2-1-5．最終需要者の名称の設定処理。
SELECT SINGLE NAME1
**** START UPD 2015/03/03 iSiD Ruan ****
*               INTO O_ZSEGSD0009-ZEKNAME2
INTO O_ZSEGSD0009-ZNAME_ZJ
**** END UPD 2015/03/03 iSiD Ruan ****
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_ZJ.

*     D-2-1-6．最終需要者(商流)の名称の設定処理。
SELECT SINGLE NAME1
**** START UPD 2015/03/03 iSiD Ruan ****
*               INTO O_ZSEGSD0009-ZEKNAME3
INTO O_ZSEGSD0009-ZNAME_DS
**** END UPD 2015/03/03 iSiD Ruan ****
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_DS.

*     D-2-1-7．受注総額の設定処理。
*     通貨単位を設定
O_ZSEGSD0009-WAERK = LST_PROCESS-WAERK.

ENDIF.

*   各明細の受注額(Net Value)を合計
CATCH SYSTEM-EXCEPTIONS ARITHMETIC_ERRORS = 4.
LW_NETWR = LW_NETWR + LST_PROCESS-NETWR.
ENDCATCH.

IF SY-SUBRC <> 0.
LW_NETWR        = CNS_NETWR_MAX.
ENDIF.

LST_ITEM_ALV-MATNR  = LST_PROCESS-MATNR.  " 品目コード
LST_ITEM_ALV-ARKTX  = LST_PROCESS-ARKTX.  " 品目テキスト
LST_ITEM_ALV-KWMENG = LST_PROCESS-KWMENG. " 数量
LST_ITEM_ALV-VRKME  = LST_PROCESS-VRKME.  " 単位
LST_ITEM_ALV-NETPR  = LST_PROCESS-NETPR.  " 単価
LST_ITEM_ALV-WAERK  = LST_PROCESS-WAERK.  " 通貨
LST_ITEM_ALV-KPEIN  = LST_PROCESS-KPEIN.  " /
LST_ITEM_ALV-ZVRKME = LST_PROCESS-ZVRKME. " UoM
LST_ITEM_ALV-NETWR  = LST_PROCESS-NETWR.  " 受注額
LST_ITEM_ALV-WERKS  = LST_PROCESS-WERKS.  " 出荷プラント
LST_ITEM_ALV-EDATU  = LST_PROCESS-EDATU.  " 納入期日
LST_ITEM_ALV-ZTERM  = LST_PROCESS-DZTERM. " 支払条件
**** START ADD 2015/03/03 iSiD Ruan ****
LST_ITEM_ALV-BSTKD  = LST_PROCESS-BSTKD.   " 購買伝票番号
LST_ITEM_ALV-EBELP  = LST_PROCESS-EBELP.   " 購買伝票の明細番号
LST_ITEM_ALV-Z_PO_ITEM_TXT = LST_PROCESS-Z_PO_ITEM_TXT." テキスト行
LST_ITEM_ALV-LGORT  = LST_PROCESS-LGORT.   " 保管場所
LST_ITEM_ALV-LGOBE  = LST_PROCESS-LGOBE.   " 保管場所テキスト
**** END ADD 2015/03/03 iSiD Ruan   ****

*   D-2-2-2．明細番号(Item)の設定処理。
CLEAR LST_ALV_ITEM.
READ TABLE TD_ITEM_ALV_TEM INTO LST_ALV_ITEM
WITH KEY BSTKD = LST_PROCESS-BSTKD
EBELP = LST_PROCESS-EBELP
BINARY SEARCH.
IF SY-SUBRC <> 0.
LW_POSNR            = LW_POSNR + 10.
LST_ITEM_ALV-POSNR  = LW_POSNR.         " 明細番号
ELSE.
LST_ITEM_ALV-POSNR = LST_ALV_ITEM-POSNR." 明細番号
ENDIF.

LST_ITEM_ALV-BSTKD  = LST_PROCESS-BSTKD.  " 購買発注番号
LST_ITEM_ALV-EBELP  = LST_PROCESS-EBELP.  " 購買伝票の明細番号


*   D-2-2-3-2．支払条件テキストの設定処理。
**** START UPD 2015/03/03 iSiD Ruan ****
*    READ TABLE TD_ZTERM INTO LST_ZTERM
*                        WITH KEY ZTERM = LST_PROCESS-DZTERM
*                        BINARY SEARCH.
*
*    IF SY-SUBRC = 0.
*      LST_ITEM_ALV-TEXT1 = LST_ZTERM-TEXT1.
*    ENDIF.
LST_ITEM_ALV-TEXT1 = LST_PROCESS-TEXT1.
**** END UPD 2015/03/03 iSiD Ruan ****

LST_ITEM_ALV-VBTYP = LST_PROCESS-VBTYP.
" 販売管理伝票カテゴリ
LST_ITEM_ALV-KARTV = LST_PROCESS-KARTV.
" 条件タイプ
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV.
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV_INI.
CLEAR LST_ITEM_ALV.
ENDLOOP.

O_ZSEGSD0009-NETWR = LW_NETWR.

ENDFORM.                    " SET_SCREEN_9000
*&---------------------------------------------------------------------*
*&      Form  ALV_9000_OUPUT
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_ITEM_ALV     ITAB:SCREEN9000ALV処理対象データ
*----------------------------------------------------------------------*
FORM ALV_9000_OUPUT.
DATA:
LTD_EXCLUDE        TYPE UI_FUNCTIONS,
LST_VARIANT        TYPE DISVARIANT,
LST_LAYOUT         TYPE LVC_S_LAYO,
LTD_FIELDCAT       TYPE LVC_T_FCAT,
LST_FIELDCAT       TYPE LVC_S_FCAT,
LTD_F4             TYPE LVC_T_F4,
LST_F4             TYPE LVC_S_F4,
LCL_EVENT_RECEIVER TYPE REF TO CL_EVENT_RECEIVER,
LW_VALID           TYPE C,
LW_COL             TYPE LVC_S_COL,
LW_ROW             TYPE LVC_S_ROW.

IF W_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

IF CI_ALV IS NOT INITIAL.
CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
IF LW_VALID IS INITIAL.
RETURN.
ENDIF.
ENDIF.

IF CI_ALV IS INITIAL.
*   容器の作成
CREATE OBJECT: CI_CCONTAINER
EXPORTING
CONTAINER_NAME = CNS_CONTA.

CREATE OBJECT CI_ALV
EXPORTING
I_PARENT = CI_CCONTAINER.

*   ALVレイアウトの設定
LST_LAYOUT-CWIDTH_OPT = ABAP_ON.

*   ALV項目定義
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = CNS_STNM010
CHANGING
CT_FIELDCAT            = LTD_FIELDCAT[]
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ENDIF.

LOOP AT LTD_FIELDCAT INTO LST_FIELDCAT.
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_WAERK
" 通貨
OR LST_FIELDCAT-FIELDNAME = CNS_FNM_NETWR
" 受注額
**** START ADD 2015/03/03 iSiD Ruan ****
OR LST_FIELDCAT-FIELDNAME = CSN_POSNR "販売伝票明細
OR LST_FIELDCAT-FIELDNAME = CSN_MATNR "品目コード
OR LST_FIELDCAT-FIELDNAME = CSN_ZTDLINE_M"テキスト行
OR LST_FIELDCAT-FIELDNAME = CSN_WERKS "プラント
OR LST_FIELDCAT-FIELDNAME = CSN_EBELN "購買伝票番号
OR LST_FIELDCAT-FIELDNAME = CSN_EBELP "購買伝票の明細番号
OR LST_FIELDCAT-FIELDNAME = CSN_TDLINE"テキスト行
OR LST_FIELDCAT-FIELDNAME = CSN_LGOBE "保管場所テキスト
**** END ADD 2015/03/03 iSiD Ruan   ****
OR LST_FIELDCAT-FIELDNAME = CNS_FNM_TEXT1.
" 支払条件テキスト
CONTINUE.
ENDIF.
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_ZTERM.
LST_FIELDCAT-F4AVAILABL = ABAP_ON.
ENDIF.
**** START ADD 2015/03/03 iSiD Ruan ****
IF LST_FIELDCAT-FIELDNAME = CSN_VRKME
OR LST_FIELDCAT-FIELDNAME = CSN_ZVRKME.
LST_FIELDCAT-F4AVAILABL = ABAP_ON.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****
LST_FIELDCAT-EDIT = ABAP_ON.
**** START ADD 2015/03/03 iSiD Ruan ****
IF LST_FIELDCAT-FIELDNAME = CNS_FNM_ZTERM.
LST_FIELDCAT-EDIT = SPACE.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****
MODIFY LTD_FIELDCAT FROM LST_FIELDCAT.
ENDLOOP.

PERFORM EXCLUDE_TB_FUNCTIONS CHANGING LTD_EXCLUDE.

LST_VARIANT-REPORT  = SY-REPID.
**** START ADD 2015/03/03 iSiD Ruan ****
IF RB_ERR IS INITIAL.
LST_VARIANT-HANDLE = '2004'.
ELSE.
LST_VARIANT-HANDLE = '2005'.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****
CALL METHOD CI_ALV->SET_TABLE_FOR_FIRST_DISPLAY
EXPORTING
IS_VARIANT                    = LST_VARIANT
IS_LAYOUT                     = LST_LAYOUT
IT_TOOLBAR_EXCLUDING          = LTD_EXCLUDE
CHANGING
IT_OUTTAB                     = TD_ITEM_ALV
IT_FIELDCATALOG               = LTD_FIELDCAT
EXCEPTIONS
INVALID_PARAMETER_COMBINATION = 1
PROGRAM_ERROR                 = 2
TOO_MANY_LINES                = 3
OTHERS                        = 4.
ELSE.

CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
ES_ROW_ID = LW_ROW
ES_COL_ID = LW_COL.

CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.

CALL METHOD CI_ALV->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LW_ROW
IS_COLUMN_ID = LW_COL.

ENDIF.

CREATE OBJECT LCL_EVENT_RECEIVER.

* 画面値が変更される時事件
SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED
FOR ALL INSTANCES.
* 画面値が変更された後事件
SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED_FINISHED
FOR ALL INSTANCES.

CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_MODIFIED.

CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_ENTER.

* 検索F4
REFRESH LTD_F4.
CLEAR LST_F4.
LST_F4-FIELDNAME  = CNS_FNM_ZTERM.
LST_F4-REGISTER   = ABAP_ON.
LST_F4-GETBEFORE  = ABAP_ON.
LST_F4-CHNGEAFTER = ABAP_ON.
LST_F4-INTERNAL   = SPACE.
APPEND LST_F4 TO LTD_F4.

CALL METHOD CI_ALV->REGISTER_F4_FOR_FIELDS
EXPORTING
IT_F4 = LTD_F4.

SET HANDLER LCL_EVENT_RECEIVER->HANDLE_F4 FOR CI_ALV.

ENDFORM.                    " ALV_9000_OUPUT
*&---------------------------------------------------------------------*
*&      Form  EXCLUDE_TB_FUNCTIONS
*&---------------------------------------------------------------------*
*       ユーザ事件を除く
*----------------------------------------------------------------------*
*      <--O_TD_EXCLUDE     ITAB:SCREEN9000ALVユーザ事件
*----------------------------------------------------------------------*
FORM EXCLUDE_TB_FUNCTIONS CHANGING O_TD_EXCLUDE TYPE UI_FUNCTIONS.
DATA:
LST_EXCLUDE TYPE UI_FUNC.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_DELETE_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_INSERT_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_APPEND_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_UNDO.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_REFRESH.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_CHECK.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_CUT.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_MB_PASTE.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

ENDFORM.                    " EXCLUDE_TB_FUNCTIONS
*&---------------------------------------------------------------------*
*&      Form  CHECK_9000_ALV
*&---------------------------------------------------------------------*
*       ALV画面項目チェック
*----------------------------------------------------------------------*
FORM CHECK_9000_ALV CHANGING O_TD_MODI TYPE LVC_T_CELL.
DATA:
LST_MODI       TYPE LVC_S_CELL,
LST_ALV        TYPE TYP_ALV_ITEM,
LW_INDEX       TYPE SY-INDEX.

CLEAR W_ERRFLG.

LOOP AT TD_ITEM_ALV INTO LST_ALV.
LW_INDEX = SY-TABIX.

**** START DEL 2015/03/03 iSiD Ruan ****
*    IF LST_ALV-POSNR IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_POSNR.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
*
*    IF LST_ALV-MATNR IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_MATNR.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
*
*    IF LST_ALV-ARKTX IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_ARKTX.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****

IF LST_ALV-KWMENG IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_KWMENG.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

IF LST_ALV-VRKME IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_VRKME.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

*   無償の場合、正味価格がゼロ
*    IF LST_ALV-NETPR IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_NETPR.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.

IF LST_ALV-KPEIN IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_KPEIN.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

IF LST_ALV-ZVRKME IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_ZVRKME.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

**** START DEL 2015/03/03 iSiD Ruan ****
*    IF LST_ALV-WERKS IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_WERKS.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
*
*    IF LST_ALV-EDATU IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_EDATU.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****
ENDLOOP.

ENDFORM.                    " CHECK_9000_ALV
*&---------------------------------------------------------------------*
*&      Form  GET_9000_AGAIN
*&---------------------------------------------------------------------*
*       E-2．データ設定処理
*----------------------------------------------------------------------*
*      <--O_ZSEGSD0009      SCREEN9000ALVヘッダデータ変更値_TEM
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM GET_9000_AGAIN CHANGING O_ZSEGSD0009      TYPE ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM
O_W_ERRFLG        TYPE C.

DATA:
LW_KWMENG    TYPE EKPO-MENGE,
LW_MENG_ALV  TYPE EKPO-MENGE,
LW_NETWR     TYPE NETWR.

**** START ADD 2015/03/03 iSiD Ruan ****
DATA:
L_TD_ITEM_ALV TYPE TYP_TD_ITEM,
LTD_STORELOC TYPE HASHED TABLE OF TYP_STORELOC
WITH UNIQUE KEY WERKS LGPRO, "保管場所
LST_STORELOC TYPE TYP_STORELOC.
**** END ADD 2015/03/03 iSiD Ruan   ****

FIELD-SYMBOLS:
<LFS_ALV>    TYPE TYP_ALV_ITEM,
<LFS_ALV1>   TYPE TYP_ALV_ITEM.

IF SY-DATAR = ABAP_ON.
W_CHANGED_9000 = ABAP_ON.
ENDIF.

**** START DEL 2015/03/03 iSiD Ruan ****
** E-2-1-1．営業所のテキストの再設定処理。
*  SELECT SINGLE BEZEI
*           INTO O_ZSEGSD0009-ZVBEZEI
*           FROM TVKBT
*          WHERE SPRAS = SY-LANGU
*            AND VKBUR = O_ZSEGSD0009-VKBUR.
*
*  IF SY-SUBRC <> 0.
*    CLEAR:
*      O_ZSEGSD0009-ZVBEZEI.
*  ENDIF.
**** END DEL 2015/03/03 iSiD Ruan ****

* E-2-1-2．営業グループのテキストの再設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = O_ZSEGSD0009-VKGRP.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZTBEZEI.
ENDIF.

* E-2-1-3．受注先の名称の再設定処理。
SELECT NAME1 UP TO 1 ROWS                   " 受注先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR1.       " 受注先
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKNAME1.
ENDIF.

* E-2-1-4．出荷先の名称の再設定処理。
SELECT NAME1 UP TO 1 ROWS                   " 出荷先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR.       " 出荷先
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKNAME.
ENDIF.

* E-2-1-5．最終需要者の名称の再設定処理。
SELECT SINGLE NAME1
**** START UPD 2015/03/03 iSiD Ruan ****
*           INTO O_ZSEGSD0009-ZEKNAME2         " 最終需要者名称
*           FROM KNA1
*          WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR2.
INTO O_ZSEGSD0009-ZNAME_ZJ         " 最終需要者名称
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZKUNNR_ZJ.
**** END UPD 2015/03/03 iSiD Ruan ****
" 最終需要者

IF SY-SUBRC <> 0.
CLEAR:
**** START UPD 2015/03/03 iSiD Ruan ****
*      O_ZSEGSD0009-ZEKNAME2.
O_ZSEGSD0009-ZNAME_ZJ.
**** END UPD 2015/03/03 iSiD Ruan ****
ENDIF.

* E-2-1-6．最終需要者(商流)の名称の再設定処理。
SELECT SINGLE NAME1
**** START UPD 2015/03/03 iSiD Ruan ****
*           INTO O_ZSEGSD0009-ZEKNAME3         " 最終需要者(商流)名称
*           FROM KNA1
*          WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR3.
INTO O_ZSEGSD0009-ZNAME_DS         " 最終需要者(商流)名称
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZKUNNR_DS.
**** END UPD 2015/03/03 iSiD Ruan ****
" 最終需要者(商流)

IF SY-SUBRC <> 0.
CLEAR:
**** START UPD 2015/03/03 iSiD Ruan ****
*      O_ZSEGSD0009-ZEKNAME3.
O_ZSEGSD0009-ZNAME_DS.
**** END UPD 2015/03/03 iSiD Ruan ****
ENDIF.

* E-2-1-7．営業員の氏名の再設定処理。
SELECT ENAME UP TO 1 ROWS
INTO O_ZSEGSD0009-ENAME            " 営業員の氏名
FROM PA0001
WHERE PERNR =  O_ZSEGSD0009-PERNR   " 営業員
AND BEGDA <= SY-DATUM             " 開始日付
AND ENDDA >= SY-DATUM.            " 終了日付
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ENAME.
ENDIF.

* 通貨チェック
PERFORM CHK_WAERK CHANGING O_W_ERRFLG.

**** START ADD 2015/03/03 iSiD Ruan ****
* 保管場所のテキストの設定処理
L_TD_ITEM_ALV = O_TD_ITEM_ALV.
SORT L_TD_ITEM_ALV BY WERKS LGORT.
DELETE ADJACENT DUPLICATES FROM L_TD_ITEM_ALV
COMPARING WERKS LGORT.
IF L_TD_ITEM_ALV IS NOT INITIAL.
SELECT WERKS
LGORT AS LGPRO
LGOBE
INTO TABLE LTD_STORELOC
FROM T001L
FOR ALL ENTRIES IN L_TD_ITEM_ALV
WHERE WERKS = L_TD_ITEM_ALV-WERKS
AND LGORT = L_TD_ITEM_ALV-LGORT.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****

*  E-2-2-2．明細の数量と金額項目が変更された場合、
*  受注額の再計算処理を行う。
CLEAR LW_NETWR.
LOOP AT O_TD_ITEM_ALV ASSIGNING <LFS_ALV>.

CLEAR:
LW_KWMENG,
LW_MENG_ALV.

IF <LFS_ALV>-KWMENG > CNS_MENG_MAX.
LW_MENG_ALV = CNS_MENG_MAX.
ELSE.
LW_MENG_ALV = <LFS_ALV>-KWMENG.
ENDIF.

CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR              = <LFS_ALV>-MATNR
I_IN_ME              = <LFS_ALV>-VRKME
I_OUT_ME             = <LFS_ALV>-ZVRKME
I_MENGE              = LW_MENG_ALV
IMPORTING
E_MENGE              = LW_KWMENG
EXCEPTIONS
ERROR_IN_APPLICATION = 1
ERROR                = 2
OTHERS               = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.

EXIT.

ELSE.

IF <LFS_ALV>-KPEIN = 0.
<LFS_ALV>-NETWR = 0.
ELSE.

CATCH SYSTEM-EXCEPTIONS ARITHMETIC_ERRORS = 4.

<LFS_ALV>-NETWR = LW_KWMENG
* <LFS_ALV>-NETPR
/ <LFS_ALV>-KPEIN.
LW_NETWR = <LFS_ALV>-NETWR + LW_NETWR.
ENDCATCH.

IF SY-SUBRC <> 0.
<LFS_ALV>-NETWR = CNS_NETWR_MAX.
LW_NETWR        = CNS_NETWR_MAX.
ENDIF.

ENDIF.

ENDIF.

**** START ADD 2015/03/03 iSiD Ruan ****
*   保管場所のテキストの設定処理
READ TABLE LTD_STORELOC INTO LST_STORELOC
WITH TABLE KEY WERKS = <LFS_ALV>-WERKS
LGPRO = <LFS_ALV>-LGORT.
IF SY-SUBRC = 0.
<LFS_ALV>-LGOBE = LST_STORELOC-LGOBE.
ELSE.
<LFS_ALV>-LGOBE = SPACE.
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****

ENDLOOP.

O_ZSEGSD0009-NETWR = LW_NETWR.

*  E-2-2-3．ヘッダの通貨項目が変更された場合、
* 「FS:明細」-通貨は同様に設定
IF O_W_ERRFLG IS INITIAL.
LOOP AT O_TD_ITEM_ALV ASSIGNING <LFS_ALV1>.
<LFS_ALV1>-WAERK = O_ZSEGSD0009-WAERK.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_9000_AGAIN
*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE ZSEGSD0009
CHANGING O_W_ERRFLG   TYPE C.

DATA:
LW_EBELN TYPE ZTEGSDT203-EBELN.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.

IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.

O_W_ERRFLG = ABAP_ON.

ENDIF.

ENDFORM.                    " LOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE ZSEGSD0009.
DATA:
LW_EBELN TYPE ZTEGSDT203-EBELN.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN.

ENDFORM.                    " LOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       F-2．データ更新処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_H USING I_ST_ZSEGSD0009 TYPE ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
CHANGING O_W_ERRFLG      TYPE C.
DATA:
LST_ALV  TYPE TYP_ALV_ITEM,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_DATUM TYPE SY-DATUM,
LW_UZEIT TYPE SY-UZEIT,
LW_MENG  TYPE BSTMG.

LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CLEAR LW_MENG.
IF LST_ALV-KWMENG > CNS_MENG_MAX.
LW_MENG = CNS_MENG_MAX.
ELSE.
LW_MENG = LST_ALV-KWMENG.
ENDIF.

UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2        " 処理区分
STATUS       = CNS_STATUS_A        " ステータス
VKBUR        = I_ST_ZSEGSD0009-VKBUR
" 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP
" 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1
" 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR
" 出荷先
**** START UPD 2015/03/03 iSiD Ruan ****

*           ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2
*                                              " 最終需要者
*           ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3
*                                              " 最終需要者(商流)
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZKUNNR_ZJ
" 最終需要者
ZKUNNR_ZE    = I_ST_ZSEGSD0009-ZKUNNR_DS
" 最終需要者(商流)
**** END UPD 2015/03/03 iSiD Ruan ****

PERNR        = I_ST_ZSEGSD0009-PERNR
" 営業員
AUGRU        = I_ST_ZSEGSD0009-AUGRU
" 受注理由 (取引理由)
**** START DEL 2015/03/03 iSiD Ruan ****
*           MATNR        = LST_ALV-MATNR      " 品目コード
*           TXZ01        = LST_ALV-ARKTX      " テキスト (短)
**** END DEL 2015/03/03 iSiD Ruan ****
MENGE        = LW_MENG            " 購買発注量
MEINS        = LST_ALV-VRKME      " 発注単位
NETPR        = LST_ALV-NETPR      " 正味価格
**** START DEL 2015/03/03 iSiD Ruan ****
*           WAERS        = LST_ALV-WAERK      " 通貨コード
**** END DEL 2015/03/03 iSiD Ruan ****
PEINH        = LST_ALV-KPEIN      " 価格単位
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
**** START UPD 2015/03/03 iSiD Ruan ****
*           ZTERM        = LST_ALV-ZTERM      " 支払条件キー
LGORT_SO     = LST_ALV-LGORT       "保管場所
**** END UPD 2015/03/03 iSiD Ruan ****
Z_MOD_YMD    = LW_DATUM           " 更新年月日
Z_MOD_HMS    = LW_UZEIT           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新者
WHERE EBELN = LW_EBELN
AND EBELP = LST_ALV-EBELP.

IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.

ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
O_W_ERRFLG = ABAP_ON.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
*   データ更新に失敗しました(TBL = &1)
MESSAGE S024(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  APP_9000_DATA
*&---------------------------------------------------------------------*
*       G.Approve
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009    SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV      SCREEN9000明細データ
*      <--O_TD_PROCESS       ITAB:ALV処理対象データ
*----------------------------------------------------------------------*
FORM APP_9000_DATA USING I_ST_ZSEGSD0009   TYPE ZSEGSD0009
I_TD_ITEM_ALV     TYPE TYP_TD_ITEM
CHANGING O_TD_PROCESS      TYPE TYP_TD_ERRALVDATA.
DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LST_ITEM_ALV  TYPE TYP_ALV_ITEM.

LOOP AT I_TD_ITEM_ALV INTO LST_ITEM_ALV.

LST_PROCESS-VKORG     = I_ST_ZSEGSD0009-VKORG.
" 販売組織
LST_PROCESS-VTWEG     = I_ST_ZSEGSD0009-VTWEG.
" 流通チャネル
LST_PROCESS-SPART     = I_ST_ZSEGSD0009-SPART.
" 製品部門
LST_PROCESS-VKBUR     = I_ST_ZSEGSD0009-VKBUR.
" 営業所
LST_PROCESS-VKGRP     = I_ST_ZSEGSD0009-VKGRP.
" 営業グループ
LST_PROCESS-KUNNR     = I_ST_ZSEGSD0009-ZEKUNNR1.
" 受注先
LST_PROCESS-NAME1     = I_ST_ZSEGSD0009-ZEKNAME1.
" 受注先名称
LST_PROCESS-ZEKUNNR   = I_ST_ZSEGSD0009-ZEKUNNR.
" 出荷先
LST_PROCESS-ZEKNAME   = I_ST_ZSEGSD0009-ZEKNAME.
" 出荷先名称
**** START UPD 2015/03/03 iSiD Ruan ****
*    LST_PROCESS-ZKUNNR_ZJ = I_ST_ZSEGSD0009-ZEKUNNR2.
*    " 最終需要者
*    LST_PROCESS-ZKUNNR_DS = I_ST_ZSEGSD0009-ZEKUNNR3.
*    " 最終需要者(商流)
LST_PROCESS-ZKUNNR_ZJ = I_ST_ZSEGSD0009-ZKUNNR_ZJ.
" 最終需要者
LST_PROCESS-ZKUNNR_DS = I_ST_ZSEGSD0009-ZKUNNR_DS.
" 最終需要者(商流)
LST_PROCESS-Z_VEND_NAME_DT = I_ST_ZSEGSD0009-Z_VEND_NAME_DT.
" 出荷先名称
LST_PROCESS-Z_ADDRESS1_DT = I_ST_ZSEGSD0009-Z_ADDRESS1_DT.
" 出荷先住所1
LST_PROCESS-Z_ADDRESS2_DT = I_ST_ZSEGSD0009-Z_ADDRESS2_DT.
" 出荷先住所2
LST_PROCESS-Z_ADDRESS3_DT = I_ST_ZSEGSD0009-Z_ADDRESS3_DT.
" 出荷先住所3
LST_PROCESS-Z_ADDRESS4_DT = I_ST_ZSEGSD0009-Z_ADDRESS4_DT.
" 出荷先住所4
LST_PROCESS-Z_TEL_DT = I_ST_ZSEGSD0009-Z_TEL_DT.
" 出荷先電話番号（PO）
LST_PROCESS-Z_FAX_DT = I_ST_ZSEGSD0009-Z_FAX_DT.
" 出荷先FAX番号（PO）
LST_PROCESS-INCO1 = I_ST_ZSEGSD0009-INCO1.
" インコタームズ (1)
LST_PROCESS-INCO2 = I_ST_ZSEGSD0009-INCO2.
" インコタームズ (2)
LST_PROCESS-SUBMI = I_ST_ZSEGSD0009-SUBMI.
" 一括番号
**** END UPD 2015/03/03 iSiD Ruan ****
LST_PROCESS-PERNR     = I_ST_ZSEGSD0009-PERNR.
" 営業員
LST_PROCESS-ZEEMNAM   = I_ST_ZSEGSD0009-ENAME.
" 営業員氏名
LST_PROCESS-BSTKD     = I_ST_ZSEGSD0009-BSTKD.
" 購買発注番号
LST_PROCESS-BSTDK     = I_ST_ZSEGSD0009-BSTDK.
" 購買発注伝票日付
LST_PROCESS-AUART     = I_ST_ZSEGSD0009-AUART.
" 販売伝票タイプ
LST_PROCESS-ZABEZEI   = I_ST_ZSEGSD0009-ZABEZEI.
" 内容説明
LST_PROCESS-AUGRU     = I_ST_ZSEGSD0009-AUGRU.
" 受注理由 (取引理由)
LST_PROCESS-MATNR     = LST_ITEM_ALV-MATNR.
" 品目コード
LST_PROCESS-ARKTX     = LST_ITEM_ALV-ARKTX.
" 品目テキスト
LST_PROCESS-KWMENG    = LST_ITEM_ALV-KWMENG.
" 数量
LST_PROCESS-VRKME     = LST_ITEM_ALV-VRKME.
" 単位
LST_PROCESS-NETPR     = LST_ITEM_ALV-NETPR.
" 単価
LST_PROCESS-WAERK     = LST_ITEM_ALV-WAERK.
" 通貨
LST_PROCESS-KPEIN     = LST_ITEM_ALV-KPEIN.
" /
LST_PROCESS-ZVRKME    = LST_ITEM_ALV-ZVRKME.
" UoM
LST_PROCESS-NETWR     = LST_ITEM_ALV-NETWR.
" 受注額
LST_PROCESS-WERKS     = LST_ITEM_ALV-WERKS.
" 出荷プラント
LST_PROCESS-EDATU     = LST_ITEM_ALV-EDATU.
" 納入期日
LST_PROCESS-DZTERM    = LST_ITEM_ALV-ZTERM.
" 支払条件
**** START UPD 2015/03/03 iSiD Ruan ****
LST_PROCESS-LGORT    = LST_ITEM_ALV-LGORT.
" 保管場所
**** END UPD 2015/03/03 iSiD Ruan ****
LST_PROCESS-EBELP     = LST_ITEM_ALV-EBELP.
" 購買伝票の明細番号
LST_PROCESS-VBTYP     = LST_ITEM_ALV-VBTYP.
" 販売管理伝票カテゴリ
LST_PROCESS-KARTV     = LST_ITEM_ALV-KARTV.
" 条件タイプ
APPEND LST_PROCESS TO O_TD_PROCESS.
CLEAR LST_PROCESS.

ENDLOOP.

ENDFORM.                    " APP_9000_DATA
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_9000
*&---------------------------------------------------------------------*
*       G-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_9000 USING I_KBUNCC        TYPE C
I_STATUS        TYPE C
I_ST_ZSEGSD0009 TYPE ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
CHANGING O_W_ERRFLG   TYPE C.
DATA:
LST_ALV  TYPE TYP_ALV_ITEM,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_DATUM TYPE SY-DATUM,
LW_UZEIT TYPE SY-UZEIT,
LW_MENG  TYPE BSTMG.

LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.

LW_EBELN = I_ST_ZSEGSD0009-BSTKD.

CLEAR LW_MENG.
IF LST_ALV-KWMENG > CNS_MENG_MAX.
LW_MENG = CNS_MENG_MAX.
ELSE.
LW_MENG = LST_ALV-KWMENG.
ENDIF.

UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC            " 処理区分
STATUS       = I_STATUS            " ステータス
MSGTX        = SPACE               " メッセージ
VKBUR        = I_ST_ZSEGSD0009-VKBUR
" 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP
" 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1
" 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR
" 出荷先
**** START UPD 2015/03/03 iSiD Ruan ****
*           ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2
*                                              " 最終需要者
*           ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3
*                                              " 最終需要者(商流)
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZKUNNR_ZJ
" 最終需要者
ZKUNNR_ZE    = I_ST_ZSEGSD0009-ZKUNNR_DS
" 最終需要者(商流)
**** END UPD 2015/03/03 iSiD Ruan ****

PERNR        = I_ST_ZSEGSD0009-PERNR
" 営業員
AUGRU        = I_ST_ZSEGSD0009-AUGRU
" 受注理由 (取引理由)
**** START DEL 2015/03/03 iSiD Ruan ****
*           MATNR        = LST_ALV-MATNR      " 品目コード
*           TXZ01        = LST_ALV-ARKTX      " テキスト (短)
**** END DEL 2015/03/03 iSiD Ruan ****
MENGE        = LW_MENG            " 購買発注量
MEINS        = LST_ALV-VRKME      " 発注単位
NETPR        = LST_ALV-NETPR      " 正味価格
**** START DEL 2015/03/03 iSiD Ruan ****
*           WAERS        = LST_ALV-WAERK      " 通貨コード
**** END DEL 2015/03/03 iSiD Ruan ****
PEINH        = LST_ALV-KPEIN      " 価格単位
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
**** START UPD 2015/03/03 iSiD Ruan ****
*           ZTERM        = LST_ALV-ZTERM      " 支払条件キー
LGORT_SO     = LST_ALV-LGORT      " 保管場所
**** END UPD 2015/03/03 iSiD Ruan ****
Z_MOD_YMD    = LW_DATUM           " 更新年月日
Z_MOD_HMS    = LW_UZEIT           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新者
WHERE EBELN = LW_EBELN
AND EBELP = LST_ALV-EBELP.

IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.

ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
O_W_ERRFLG = ABAP_ON.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
*   データ更新に失敗しました(TBL = &1)
MESSAGE S024(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  FRM_F4_SHOW
*&---------------------------------------------------------------------*
*       検索F4
*----------------------------------------------------------------------*
FORM FRM_F4_SHOW.
DATA:
LTD_RETURN TYPE STANDARD TABLE OF DDSHRETVAL,
LST_RETURN TYPE DDSHRETVAL,
L_ROW      TYPE I,
LST_STAB   TYPE LVC_S_STBL,
LST_ZTERM  TYPE TYP_ZTERM,
LST_ITEM   TYPE TYP_ALV_ITEM,
LW_ZTERM   TYPE DZTERM.

CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
EXPORTING
RETFIELD        = CNS_FNM_ZTERM
VALUE_ORG       = CNS_ORG_S
TABLES
VALUE_TAB       = TD_ZTERM
RETURN_TAB      = LTD_RETURN
EXCEPTIONS
PARAMETER_ERROR = 1
NO_VALUES_FOUND = 2
OTHERS          = 3.

* エラー
IF SY-SUBRC <> 0.

MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

ELSE.

READ TABLE LTD_RETURN INTO LST_RETURN INDEX 1.

IF SY-SUBRC = 0.
CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
E_ROW = L_ROW.

READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX L_ROW.

IF SY-SUBRC = 0.
CLEAR LST_ZTERM.
LW_ZTERM = LST_RETURN-FIELDVAL.
READ TABLE TD_ZTERM INTO LST_ZTERM
WITH KEY ZTERM = LW_ZTERM
BINARY SEARCH.
LST_ITEM-ZTERM = LW_ZTERM.
LST_ITEM-TEXT1 = LST_ZTERM-TEXT1.
MODIFY TD_ITEM_ALV FROM LST_ITEM INDEX L_ROW.
ENDIF.

LST_STAB-ROW = ABAP_ON.
LST_STAB-COL = ABAP_ON.

CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY
EXPORTING
IS_STABLE = LST_STAB.

ENDIF.

ENDIF.

ENDFORM.                    " FRM_F4_SHOW
*&---------------------------------------------------------------------*
*&      Form  CHK_WAERK
*&---------------------------------------------------------------------*
*       通貨チェック
*----------------------------------------------------------------------*
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM CHK_WAERK CHANGING O_W_ERRFLG   TYPE C.

SELECT SINGLE WAERS
FROM TCURC
INTO ST_ZSEGSD0009-WAERK
WHERE WAERS = ST_ZSEGSD0009-WAERK.

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
*    通貨コード & は存在しません
MESSAGE S641(Z1) WITH ST_ZSEGSD0009-WAERK
DISPLAY LIKE CNS_MSG_E.
SET CURSOR FIELD 'ST_ZSEGSD0009-WAERK'.

ENDIF.

ENDFORM.                    " CHK_WAERK
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_205_A
*&---------------------------------------------------------------------*
*       A-2-1-2-5．販売伝票タイプの検索
*----------------------------------------------------------------------*
*      -->I_TD_SDT203      ITAB:承認対象データ
*      <--O_TD_DATA_205    ITAB:販売伝票タイプ
*----------------------------------------------------------------------*
FORM GET_DATA_205_A USING I_TD_SDT203   TYPE TYP_TD_ZTEGSDT203
CHANGING O_TD_DATA_205 TYPE TYP_TD_205.
DATA:
LTD_SDT203       TYPE TYP_TD_ZTEGSDT203,
LTD_DATA_205_TEM TYPE TYP_TD_205,
LST_TVAKT        TYPE TYP_TVAKT,
LTD_TVAKT        TYPE STANDARD TABLE OF TYP_TVAKT.

FIELD-SYMBOLS:
<LFS_ST_DATA_205> TYPE TYP_DATA_205.

LTD_SDT203 = I_TD_SDT203.
SORT LTD_SDT203 BY BSART ASCENDING          " 購買伝票タイプ
KNTTP ASCENDING.         " 勘定設定カテゴリ

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING BSART       " 購買伝票タイプ
KNTTP.      " 勘定設定カテゴリ

SELECT ZTEGSDT205~BSART                     " 購買伝票タイプ
ZTEGSDT205~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT205~AUART                     " 販売伝票タイプ
ZTEGSDT205~AUGRU                     " 受注理由
TVAK~VBTYP                           " 販売管理伝票カテゴリ
FROM ZTEGSDT205
INNER JOIN TVAK
ON ZTEGSDT205~AUART = TVAK~AUART
INTO TABLE O_TD_DATA_205
FOR ALL ENTRIES IN LTD_SDT203
WHERE ZTEGSDT205~BSART = LTD_SDT203-BSART  " 購買伝票タイプ
AND ZTEGSDT205~KNTTP = LTD_SDT203-KNTTP. " 勘定設定カテゴリ

IF SY-SUBRC = 0.

LTD_DATA_205_TEM = O_TD_DATA_205.
SORT LTD_DATA_205_TEM BY AUART ASCENDING.
" 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205_TEM
COMPARING AUART.    " 販売伝票タイプ

SELECT AUART                              " 販売伝票タイプ
BEZEI                              " 販売伝票タイプテキスト
FROM TVAKT
INTO TABLE LTD_TVAKT
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART     " 販売伝票タイプ
AND SPRAS = SY-LANGU.                  " システム言語

IF SY-SUBRC = 0.
SORT LTD_TVAKT BY AUART ASCENDING.
ENDIF.

LOOP AT O_TD_DATA_205 ASSIGNING <LFS_ST_DATA_205>.
CLEAR LST_TVAKT.
READ TABLE LTD_TVAKT INTO LST_TVAKT
WITH KEY AUART = <LFS_ST_DATA_205>-AUART
BINARY SEARCH.
<LFS_ST_DATA_205>-BEZEI = LST_TVAKT-BEZEI.
" 販売伝票タイプテキスト
ENDLOOP.

SORT O_TD_DATA_205  BY BSART ASCENDING    " 購買伝票タイプ
KNTTP ASCENDING.   " 勘定設定カテゴリ

ENDIF.

ENDFORM.                    " GET_DATA_205_A
*&---------------------------------------------------------------------*
*&      Form  GET_ZTERM_DATA
*&---------------------------------------------------------------------*
*       従業員データ取得
*----------------------------------------------------------------------*
FORM GET_ZTERM_DATA.

SELECT ZTERM
TEXT1
FROM T052U
INTO TABLE TD_ZTERM
WHERE SPRAS = SY-LANGU.

IF SY-SUBRC = 0.
SORT TD_ZTERM BY ZTERM ASCENDING.
ENDIF.

ENDFORM.                    " GET_ZTERM_DATA
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_ITEM
*&---------------------------------------------------------------------*
*       C-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_TD_MESSAGE     ITAB:BAPIメッセージ
*      -->I_TD_ALVDATA     ITAB:BAPI処理対象
*      -->I_TD_UNLOCK      ITAB:UNLOCK処理対象データ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_ITEM USING I_TD_MESSAGE  TYPE TYP_TD_BAPIMSG
I_TD_ALVDATA  TYPE TYP_TD_ALVDATA
I_TD_UNLOCK   TYPE TYP_TD_ERRALVDATA.
DATA:
LST_ALVDATA TYPE TYP_TEM_ALVDATA,
LST_MESSAGE TYPE TYP_BAPIMSG,
LW_DATUM    TYPE SY-DATUM,
LW_UZEIT    TYPE SY-UZEIT,
LFG_ERR     TYPE C.

LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.

CLEAR LST_MESSAGE.
READ TABLE I_TD_MESSAGE INTO LST_MESSAGE
WITH KEY BSTKD = LST_ALVDATA-BSTKD
EBELP = LST_ALVDATA-EBELP
BINARY SEARCH.

IF SY-SUBRC <> 0.
*  C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_C
LST_MESSAGE-MESSAGE
LST_ALVDATA
LW_DATUM
LW_UZEIT
CHANGING LFG_ERR.
ELSE.
*  C-3-1．承認エラーの場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_E
LST_MESSAGE-MESSAGE
LST_ALVDATA
LW_DATUM
LW_UZEIT
CHANGING LFG_ERR.

ENDIF.

IF LFG_ERR IS NOT INITIAL.
EXIT.
ENDIF.

ENDLOOP.

IF LFG_ERR IS INITIAL.
* C-3-3．データ更新に全件成功した場合、コミットし、ロックを解除
COMMIT WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
ELSE.
ROLLBACK WORK.
*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
*  データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_ITEM
*&---------------------------------------------------------------------*
*&      Form  MODIFY_9000
*&---------------------------------------------------------------------*
*       SCREEN 9000再表示処理
*----------------------------------------------------------------------*
FORM MODIFY_9000.
DATA:
LST_ZSEGSD0009  TYPE ZSEGSD0009,
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

DELETE TD_ZSEGSD0009 WHERE BSTKD = ST_ZSEGSD0009-BSTKD.
APPEND ST_ZSEGSD0009 TO TD_ZSEGSD0009.

DELETE TD_ITEM_ALV_TEM WHERE BSTKD = ST_ZSEGSD0009-BSTKD.
APPEND LINES OF TD_ITEM_ALV TO TD_ITEM_ALV_TEM.

SORT TD_ITEM_ALV_TEM BY BSTKD ASCENDING
EBELP ASCENDING.

LOOP AT TD_ZSEGSD0009 INTO LST_ZSEGSD0009.

IF RB_ERR IS INITIAL.

READ TABLE TD_APP_ALV TRANSPORTING NO FIELDS
WITH KEY VKORG = LST_ZSEGSD0009-VKORG
VTWEG = LST_ZSEGSD0009-VTWEG
SPART = LST_ZSEGSD0009-SPART
BSTKD = LST_ZSEGSD0009-BSTKD
BINARY SEARCH.

IF SY-SUBRC = 0.

LST_APP_ALVDATA-VKBUR     = LST_ZSEGSD0009-VKBUR.
LST_APP_ALVDATA-VKGRP     = LST_ZSEGSD0009-VKGRP.
LST_APP_ALVDATA-KUNNR     = LST_ZSEGSD0009-ZEKUNNR1.
LST_APP_ALVDATA-NAME1     = LST_ZSEGSD0009-ZEKNAME1.
LST_APP_ALVDATA-ZEKUNNR   = LST_ZSEGSD0009-ZEKUNNR.
LST_APP_ALVDATA-ZEKNAME   = LST_ZSEGSD0009-ZEKNAME.
**** START UPD 2015/03/03 iSiD Ruan ****
*        LST_APP_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZEKUNNR2.
*        LST_APP_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZEKUNNR3.
LST_APP_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZKUNNR_ZJ.
LST_APP_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZKUNNR_DS.
**** END UPD 2015/03/03 iSiD Ruan ****
LST_APP_ALVDATA-PERNR     = LST_ZSEGSD0009-PERNR.
LST_APP_ALVDATA-ZEEMNAM   = LST_ZSEGSD0009-ENAME.
LST_APP_ALVDATA-AUGRU     = LST_ZSEGSD0009-AUGRU.

MODIFY TD_APP_ALV FROM LST_APP_ALVDATA
TRANSPORTING VKBUR
VKGRP
KUNNR
NAME1
ZEKUNNR
ZEKNAME
ZKUNNR_ZJ
ZKUNNR_DS
PERNR
ZEEMNAM
AUGRU
WHERE BSTKD = LST_ZSEGSD0009-BSTKD.

ENDIF.

ELSE.

READ TABLE TD_ERR_ALV TRANSPORTING NO FIELDS
WITH KEY VKORG = LST_ZSEGSD0009-VKORG
VTWEG = LST_ZSEGSD0009-VTWEG
SPART = LST_ZSEGSD0009-SPART
BSTKD = LST_ZSEGSD0009-BSTKD
BINARY SEARCH.

IF SY-SUBRC = 0.

LST_ERR_ALVDATA-VKBUR     = LST_ZSEGSD0009-VKBUR.
LST_ERR_ALVDATA-VKGRP     = LST_ZSEGSD0009-VKGRP.
LST_ERR_ALVDATA-KUNNR     = LST_ZSEGSD0009-ZEKUNNR1.
LST_ERR_ALVDATA-NAME1     = LST_ZSEGSD0009-ZEKNAME1.
LST_ERR_ALVDATA-ZEKUNNR   = LST_ZSEGSD0009-ZEKUNNR.
LST_ERR_ALVDATA-ZEKNAME   = LST_ZSEGSD0009-ZEKNAME.
**** START UPD 2015/03/03 iSiD Ruan ****
*        LST_ERR_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZEKUNNR2.
*        LST_ERR_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZEKUNNR3.
LST_ERR_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZKUNNR_ZJ.
LST_ERR_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZKUNNR_DS.
**** END UPD 2015/03/03 iSiD Ruan ****
LST_ERR_ALVDATA-PERNR     = LST_ZSEGSD0009-PERNR.
LST_ERR_ALVDATA-ZEEMNAM   = LST_ZSEGSD0009-ENAME.
LST_ERR_ALVDATA-AUGRU     = LST_ZSEGSD0009-AUGRU.

MODIFY TD_ERR_ALV FROM LST_ERR_ALVDATA
TRANSPORTING VKBUR
VKGRP
KUNNR
NAME1
ZEKUNNR
ZEKNAME
ZKUNNR_ZJ
ZKUNNR_DS
PERNR
ZEEMNAM
AUGRU
WHERE BSTKD = LST_ZSEGSD0009-BSTKD.
ENDIF.

ENDIF.

ENDLOOP.

ENDFORM.                    " MODIFY_9000
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&---------------------------------------------------------------------*
*       ALV画面の事件
*----------------------------------------------------------------------*
*      -->I_W_UCOMM       　ユーザ事件
*      -->I_ST_SELFIELD     information cursor position ALV
*----------------------------------------------------------------------*
FORM USER_COMMAND USING I_W_UCOMM     TYPE SY-UCOMM
I_ST_SELFIELD TYPE SLIS_SELFIELD.

DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LTD_UPDATE      TYPE TYP_TD_ALVDATA,
LW_QUESTION     TYPE CHAR72,
LW_ANSWER       TYPE CHAR1,
LW_ERRFLG       TYPE CHAR1,
*    LW_DATA_ERRFLG  TYPE CHAR1,
LTD_MESSAGE     TYPE TYP_TD_BAPIMSG.

I_ST_SELFIELD-REFRESH = ABAP_ON.

CLEAR LTD_PROCESS.
* A-4．ボタンイベント処理
CASE I_W_UCOMM.
*   A-4-1-1．　「Delete」ボタン押下時の処理
*   A-4-2-1．「Delete」ボタン押下時の処理
WHEN CNS_USER_DEL.

*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.

IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ELSE.
*       削除しますか？
MESSAGE S034(ZMEGSD01) INTO LW_QUESTION.

*       POP確認
PERFORM POP_CONFIRM USING TEXT-B01
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.
IF LW_ANSWER <> 1.
RETURN.
ENDIF.
ENDIF.

*     B-2-1．ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     B-2-2．受発注連携データのステータス更新処理を行う。
CLEAR LW_ERRFLG.
PERFORM UPDATE_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS INITIAL.
COMMIT WORK AND WAIT.
*       B-2-3．ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS.
ENDIF.

*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*   A-4-1-2．　「Approve」ボタン押下時の処理
WHEN CNS_USER_APP.

*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.

*     C-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.

*     C-1-3．ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     C-2．受注シミュレーション処理
*     C-2-1．シミュレーション対象データの補足処理。
PERFORM EDIT_TD_PROCESS USING TD_APP_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG.
*     受注シミュレーション処理を行う
PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LTD_MESSAGE.

*     C-3．データ更新処理
PERFORM UPDATE_ZTEGSDT203_ITEM USING LTD_MESSAGE
LTD_UPDATE
LTD_PROCESS.

*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*     C-4-2．メッセージを表示する。
IF LW_ERRFLG IS INITIAL.
*       指定された対象が全て承認されました
MESSAGE S045(ZMEGSD01).
ELSE.
*       承認失敗のデータが存在します。エラーリカバリ一覧をご確認ください
MESSAGE S046(ZMEGSD01).
ENDIF.

*   A-4-1-3．　「Change」ボタン押下時の処理
*   A-4-2-2．　「Change」ボタン押下時の処理
WHEN CNS_USER_MOD.

*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.

*     D-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.

**** START ADD 2015/03/03 iSiD Ruan ****
*     販売伝票単一明細フラグ立っている場合、一明細しか選択できないようにする
IF W_FLGSOSGL IS NOT INITIAL
AND LINES( LTD_PROCESS ) > 1.
*       一つの明細のみが指定できます。
MESSAGE E102(ZMEGSD01).
ENDIF.
**** END ADD 2015/03/03 iSiD Ruan   ****

*     購買発注番号混在チェック
PERFORM CHECK_TD_PROCESS USING TD_APP_ALV
TD_ERR_ALV
CHANGING LTD_PROCESS.

*     D-2．データ設定処理
CLEAR:
TD_ITEM_ALV,
TD_ITEM_ALV_INI,
ST_ZSEGSD0009,
W_ERRFLG.

PERFORM SET_SCREEN_9000 USING LTD_PROCESS
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
TD_ITEM_ALV_INI.

CLEAR W_CHANGED_9000.

CALL SCREEN 9000.

WHEN CNS_USER_BACK
OR CNS_USER_EXIT.

LEAVE TO SCREEN 0.

WHEN OTHERS.
*     処理なし

ENDCASE.

ENDFORM.                    " USER_COMMAND
*&---------------------------------------------------------------------*
*&      Form  COMMAND_EXIT
*&---------------------------------------------------------------------*
*       EXIT 事件
*----------------------------------------------------------------------*
FORM COMMAND_EXIT.
DATA:
LW_VALID    TYPE C,
LW_QUESTION TYPE CHAR72,
LW_ANSWER   TYPE C.

CASE OK_CODE.
WHEN CNS_USER_BACK
OR CNS_USER_EXIT.
CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.

IF SY-DATAR = ABAP_ON.
W_CHANGED_9000 = ABAP_ON.
ENDIF.

IF LW_VALID IS INITIAL
OR W_CHANGED_9000 IS NOT INITIAL
OR TD_ITEM_ALV <> TD_ITEM_ALV_INI.

*       終了しますか？
MESSAGE S050(ZMEGSD01) INTO LW_QUESTION.

*       POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.

IF LW_ANSWER <> 1.
RETURN.
ELSE.
CLEAR:
W_CHANGED_9000.

CLEAR TD_ITEM_ALV.

CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.

LEAVE TO SCREEN 0.
ENDIF.
ELSE.
LEAVE TO SCREEN 0.
ENDIF.
WHEN OTHERS.

ENDCASE.

ENDFORM.                    " COMMAND_EXIT
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND_9000
*&---------------------------------------------------------------------*
*       画面9000のボタンイベント処理
*----------------------------------------------------------------------*
FORM USER_COMMAND_9000.
DATA:
LW_VALID       TYPE C,
LW_SAVE_OK     TYPE SY-UCOMM,
LW_ERRFLG      TYPE C,
LST_MESSAGE    TYPE TYP_BAPIMSG,
LTD_MESSAGE    TYPE TYP_TD_BAPIMSG,
LTD_UPDATE     TYPE TYP_TD_ALVDATA,
LTD_PROCESS    TYPE TYP_TD_ERRALVDATA,
LTD_MODI       TYPE LVC_T_CELL.

CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.

IF LW_VALID IS INITIAL.
RETURN.
ENDIF.

LW_SAVE_OK = OK_CODE.

CASE LW_SAVE_OK.
WHEN CNS_USER_ENTR.

*     E-2．データ設定処理
PERFORM GET_9000_AGAIN CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
LW_ERRFLG.

*     ALV画面項目チェック
PERFORM CHECK_9000_ALV CHANGING LTD_MODI.

IF W_ERRFLG = ABAP_ON.
CALL METHOD CI_ALV->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

*       必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
RETURN.

ENDIF.


WHEN CNS_USER_SAPP.
*     ALV画面項目チェック
PERFORM CHECK_9000_ALV CHANGING LTD_MODI.

IF W_ERRFLG = ABAP_ON.
CALL METHOD CI_ALV->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

*       必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
RETURN.

ENDIF.

CLEAR LW_ERRFLG.
PERFORM GET_9000_AGAIN CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     G.Approve
PERFORM APP_9000_DATA USING ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG.

PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LTD_MESSAGE.

IF LW_ERRFLG IS NOT INITIAL.
READ TABLE LTD_MESSAGE INTO LST_MESSAGE INDEX 1.
MESSAGE LST_MESSAGE-MESSAGE TYPE CNS_MSG_S
DISPLAY LIKE CNS_MSG_E.
RETURN.
ENDIF.

*     G-3-1．ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203_H USING ST_ZSEGSD0009
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*    C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
CLEAR LW_ERRFLG.
PERFORM UPDATE_ZTEGSDT203_9000 USING CNS_KBUNCC_2
CNS_STATUS_C
ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*     C-4-2．メッセージを表示する。
*      データ承認しました。(購買発注 = &1)
MESSAGE S049(ZMEGSD01) WITH ST_ZSEGSD0009-BSTKD.
LEAVE TO SCREEN 0.

WHEN CNS_USER_SHOD
OR CNS_USER_SAVE.

*     ALV画面項目チェック
PERFORM CHECK_9000_ALV CHANGING LTD_MODI.

IF W_ERRFLG = ABAP_ON.
CALL METHOD CI_ALV->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

*       必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
RETURN.

ENDIF.

*     E-2．データ設定処理
PERFORM GET_9000_AGAIN CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     F-1-3．ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203_H USING ST_ZSEGSD0009
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     F-2．データ更新処理
PERFORM UPDATE_ZTEGSDT203_H USING ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*     SCREEN 9000再表示処理
PERFORM MODIFY_9000.

*     更新成功のメッセージを表示する
*     データ更新しました。(購買発注 = &1)
MESSAGE S048(ZMEGSD01) WITH ST_ZSEGSD0009-BSTKD.
LEAVE TO SCREEN 0.

WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " USER_COMMAND_9000
**** START ADD 2015/03/03 iSiD Ruan ****
*&---------------------------------------------------------------------*
*&      Form  GET_ALV_REFDATA
*&---------------------------------------------------------------------*
*       ALV表示用項目を取得する
*----------------------------------------------------------------------*
*      -->I_TD_ZTEGSDT203  対象データテーブル
*      <--O_LTD_MATERDES   品目テキストテーブル
*      <--O_LTD_PLANTINFO  出荷プラントテーブル
*      <--O_LTD_INCOTERM  インコタームズテーブル
*      <--O_LTD_PAYTERMS  支払条件テーブル
*      <--O_LTD_ODREASON  受注理由テーブル
*      <--O_LTD_STORELOC  保管場所テーブル
*      <--O_TD_TVAUT     受注理由マスタ
*      <--O_TD_T001L     保管場所マスタ
*----------------------------------------------------------------------*
FORM GET_ALV_REFDATA USING    I_TD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203
CHANGING O_TD_MATERDES  TYPE TYP_TD_MATERDES
O_TD_PLANTINFO TYPE TYP_TD_PLANTINFO
O_TD_INCOTERM  TYPE TYP_TD_INCOTERM
O_TD_PAYTERMS  TYPE TYP_TD_PAYTERMS
O_TD_ODREASON  TYPE TYP_TD_ODREASON
O_TD_STORELOC  TYPE TYP_TD_STORELOC
O_TD_TVAUT     TYPE TYP_TD_TVAUT
O_TD_T001L     TYPE TYP_TD_T001L.

DATA:
LTD_ZTEGSDT203      TYPE TYP_TD_ZTEGSDT203,
LST_ZTEGSDT203      TYPE TYP_ZTEGSDT203,
LST_PLANTINFO_SB    TYPE TYP_PLANTINFO,
LST_PLANTINFO       TYPE TYP_PLANTINFO,
LTD_PLANTINFO       TYPE STANDARD TABLE OF TYP_PLANTINFO.

CLEAR:
O_TD_MATERDES,
O_TD_PLANTINFO,
O_TD_INCOTERM,
O_TD_PAYTERMS,
O_TD_ODREASON,
O_TD_STORELOC,
O_TD_TVAUT,
O_TD_T001L.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY MATNR.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING MATNR.

* 品目テキストを取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT MATNR
MAKTX
INTO TABLE O_TD_MATERDES
FROM MAKT
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE MATNR = LTD_ZTEGSDT203-MATNR
AND SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY KUNNR
VKORG
VTWEG
SPART.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING KUNNR
VKORG
VTWEG
SPART.

* 出荷プラントの情報を取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT KUNNR
VKORG
VTWEG
SPART
VWERK
INTO TABLE O_TD_PLANTINFO
FROM KNVV
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE KUNNR = LTD_ZTEGSDT203-KUNNR
AND VKORG = LTD_ZTEGSDT203-VKORG
AND VTWEG = LTD_ZTEGSDT203-VTWEG
AND SPART = LTD_ZTEGSDT203-SPART.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY INCO1.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING INCO1.

* インコタームズのテキストを取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT INCO1
BEZEI
INTO TABLE O_TD_INCOTERM
FROM TINCT
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE INCO1 = LTD_ZTEGSDT203-INCO1
AND SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY ZTERM.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING ZTERM.

* 支払条件のテキストを取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT ZTERM
TEXT1
INTO TABLE O_TD_PAYTERMS
FROM T052U
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE ZTERM = LTD_ZTEGSDT203-ZTERM
AND SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY BSART
KNTTP.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING BSART
KNTTP.

* 受注理由を取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT A~BSART
A~KNTTP
A~AUART
B~AUGRU
B~BEZEI
INTO TABLE O_TD_ODREASON
FROM ZTEGSDT205 AS A
INNER JOIN TVAUT AS B
ON A~AUGRU = B~AUGRU
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE A~BSART = LTD_ZTEGSDT203-BSART
AND A~KNTTP = LTD_ZTEGSDT203-KNTTP
AND B~SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
LOOP AT I_TD_ZTEGSDT203 INTO LST_ZTEGSDT203.
IF LST_ZTEGSDT203-DWERK IS NOT INITIAL.
LST_PLANTINFO-VWERK =  LST_ZTEGSDT203-DWERK.
ELSE.
CLEAR LST_PLANTINFO_SB.
READ TABLE O_TD_PLANTINFO INTO LST_PLANTINFO_SB
WITH TABLE KEY KUNNR = LST_ZTEGSDT203-KUNNR
VKORG = LST_ZTEGSDT203-VKORG
VTWEG = LST_ZTEGSDT203-VTWEG
SPART = LST_ZTEGSDT203-SPART.
LST_PLANTINFO-VWERK =  LST_PLANTINFO_SB-VWERK.
ENDIF.

COLLECT LST_PLANTINFO INTO LTD_PLANTINFO.
CLEAR LST_PLANTINFO.
ENDLOOP.

* 保管場所を取得する
IF LTD_PLANTINFO IS NOT INITIAL.
SELECT A~WERKS
A~LGPRO
B~LGOBE
INTO TABLE O_TD_STORELOC
FROM MARC AS A
INNER JOIN T001L AS B
ON A~WERKS = B~WERKS
AND A~LGPRO = B~LGORT
FOR ALL ENTRIES IN LTD_PLANTINFO
WHERE A~WERKS = LTD_PLANTINFO-VWERK.
ENDIF.

* 受注理由マスタ
SELECT AUGRU
BEZEI
INTO TABLE O_TD_TVAUT
FROM TVAUT
WHERE SPRAS = SY-LANGU.

* 保管場所マスタ
SELECT WERKS
LGORT
LGOBE
INTO TABLE O_TD_T001L
FROM T001L.
ENDFORM.                    " GET_ALV_REFDATA
*&---------------------------------------------------------------------*
*&      Form  READ_ALV_REFDATA
*&---------------------------------------------------------------------*
*       ALV表示用項目の読み込み
*----------------------------------------------------------------------*
*      -->I_ST_SDT203   対象データ
*      -->I_TD_MATERDES   品目テキストテーブル
*      -->I_TD_PLANTINFO  出荷プラントテーブル
*      -->I_TD_INCOTERM  インコタームズテーブル
*      -->I_LTD_PAYTERMS  支払条件テーブル
*      -->I_TD_PAYTERMS  受注理由テーブル
*      -->I_TD_STORELOC  保管場所テーブル
*      -->I_TD_TVAUT     受注理由マスタ
*      -->I_TD_T001L     保管場所マスタ
*      <--O_ST_APP_ALVDATA  ALV表示用データ
*----------------------------------------------------------------------*
FORM READ_ALV_REFDATA  USING    I_ST_SDT203    TYPE TYP_ZTEGSDT203
I_TD_MATERDES  TYPE TYP_TD_MATERDES
I_TD_PLANTINFO TYPE TYP_TD_PLANTINFO
I_TD_INCOTERM  TYPE TYP_TD_INCOTERM
I_TD_PAYTERMS  TYPE TYP_TD_PAYTERMS
I_TD_ODREASON  TYPE TYP_TD_ODREASON
I_TD_STORELOC  TYPE TYP_TD_STORELOC
I_TD_TVAUT     TYPE TYP_TD_TVAUT
I_TD_T001L     TYPE TYP_TD_T001L
CHANGING O_ST_APP_ALVDATA TYPE TYP_APP_ALVDATA.

DATA:
LST_MATERDES  TYPE TYP_MATERDES,
LST_PLANTINFO TYPE TYP_PLANTINFO,
LST_INCOTERM  TYPE TYP_INCOTERM,
LST_PAYTERMS  TYPE TYP_PAYTERMS,
LST_ODREASON  TYPE TYP_ODREASON,
LST_STORELOC  TYPE TYP_STORELOC,
LW_NAME       TYPE THEAD-TDNAME,
LTD_LINES     TYPE TABLE OF TLINE,
LST_LINES     TYPE TLINE,
LST_TVAUT     TYPE TYP_TVAUT,
LST_T001L     TYPE TYP_T001L.

* 品目テキストを取得する
CONCATENATE I_ST_SDT203-MATNR
I_ST_SDT203-VKORG
I_ST_SDT203-VTWEG INTO LW_NAME RESPECTING BLANKS.

CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                            = '0001'
LANGUAGE                      = SY-LANGU
NAME                          = LW_NAME
OBJECT                        = 'MVKE'
TABLES
LINES                         = LTD_LINES
EXCEPTIONS
ID                            = 1
LANGUAGE                      = 2
NAME                          = 3
NOT_FOUND                     = 4
OBJECT                        = 5
REFERENCE_CHECK               = 6
WRONG_ACCESS_TO_ARCHIVE       = 7
OTHERS                        = 8
.
IF SY-SUBRC = 0.
READ TABLE LTD_LINES INTO LST_LINES INDEX 1.
O_ST_APP_ALVDATA-ARKTX = LST_LINES-TDLINE. "品目テキスト
ELSE.
READ TABLE I_TD_MATERDES INTO LST_MATERDES
WITH TABLE KEY MATNR = I_ST_SDT203-MATNR.
IF SY-SUBRC = 0.
O_ST_APP_ALVDATA-ARKTX = LST_MATERDES-MAKTX."品目テキスト
ENDIF.
ENDIF.

IF I_ST_SDT203-DWERK IS INITIAL.
*   出荷プラントの情報を取得する
READ TABLE I_TD_PLANTINFO INTO LST_PLANTINFO
WITH TABLE KEY KUNNR = I_ST_SDT203-KUNNR
VKORG = I_ST_SDT203-VKORG
VTWEG = I_ST_SDT203-VTWEG
SPART = I_ST_SDT203-SPART.

O_ST_APP_ALVDATA-WERKS = LST_PLANTINFO-VWERK."出荷プラント
ENDIF.

* インコタームズのテキストを取得する
READ TABLE I_TD_INCOTERM INTO LST_INCOTERM
WITH TABLE KEY INCO1 = I_ST_SDT203-INCO1.
O_ST_APP_ALVDATA-ZBEZEI_IC = LST_INCOTERM-BEZEI.
"インコタームズのテキスト

* 支払条件のテキストを取得する
READ TABLE I_TD_PAYTERMS INTO LST_PAYTERMS
WITH TABLE KEY ZTERM = I_ST_SDT203-ZTERM.
O_ST_APP_ALVDATA-TEXT1 = LST_PAYTERMS-TEXT1."支払条件のテキスト

* 受注理由を取得する
IF I_ST_SDT203-ZKBUNCC = '1'
AND I_ST_SDT203-STATUS  = 'C'.

READ TABLE I_TD_ODREASON INTO LST_ODREASON
WITH TABLE KEY BSART = I_ST_SDT203-BSART
KNTTP = I_ST_SDT203-KNTTP.
O_ST_APP_ALVDATA-AUGRU = LST_ODREASON-AUGRU. "受注理由
O_ST_APP_ALVDATA-ZBEZEI_OR = LST_ODREASON-BEZEI."テキスト
ELSE.

*   受注理由テキスト
READ TABLE I_TD_TVAUT INTO LST_TVAUT
WITH TABLE KEY AUGRU = I_ST_SDT203-AUGRU.
O_ST_APP_ALVDATA-ZBEZEI_OR = LST_TVAUT-BEZEI."テキスト
ENDIF.

* 保管場所を取得する
IF I_ST_SDT203-ZKBUNCC = '1'
AND I_ST_SDT203-STATUS  = 'C'.
READ TABLE I_TD_STORELOC INTO LST_STORELOC
WITH TABLE KEY WERKS = O_ST_APP_ALVDATA-WERKS.
O_ST_APP_ALVDATA-LGORT = LST_STORELOC-LGPRO."出庫保管場所
O_ST_APP_ALVDATA-LGOBE = LST_STORELOC-LGOBE."保管場所テキスト
ELSE.
READ TABLE I_TD_T001L INTO LST_T001L
WITH TABLE KEY WERKS = O_ST_APP_ALVDATA-WERKS
LGORT = O_ST_APP_ALVDATA-LGORT.
O_ST_APP_ALVDATA-LGOBE = LST_T001L-LGOBE."保管場所テキスト
ENDIF.

ENDFORM.                    " READ_ALV_REFDATA
**** END ADD 2015/03/03 iSiD Ruan   ****
