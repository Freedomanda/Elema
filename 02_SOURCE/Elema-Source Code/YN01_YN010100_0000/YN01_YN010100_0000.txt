*&---------------------------------------------------------------------*
*&  INCLUDE           YN01_YN010100_0000
*&---------------------------------------------------------------------*

DATA: TBL_YNEIAJ1101 LIKE YNEIAJ1101 OCCURS 0  " 構造 EIAJ1101
WITH HEADER LINE.

DATA: TBL_YN110 LIKE YN110 OCCURS 0     " YN110
WITH HEADER LINE.

DATA: TBL_YNEIAJ1102 LIKE YNEIAJ1102 OCCURS 0  " 構造 EIAJ1102
WITH HEADER LINE.

DATA: TBL_YN210 LIKE YN210 OCCURS 0     " YN210
WITH HEADER LINE.

DATA: TBL_YNYN110 LIKE YNYN110 OCCURS 0        " 構造 YN110
WITH HEADER LINE.

DATA: TBL_YNYN210 LIKE YNYN210 OCCURS 0        " 構造 YN210
WITH HEADER LINE.

DATA : TBL_ERR LIKE STANDARD TABLE OF SY-TABIX.

DATA: BEGIN OF TBL_EXIT OCCURS 0,       " EXIT
INDEX   TYPE I,                     " TABLE INDEX
EXIT    LIKE YN130-OUTEXITDOC,      " EXIT
*elematec 対応 INSERT START 2011/12/08
WERKS   TYPE MARC-WERKS,  "プラント
LIFNR   TYPE WYT3-LIFNR,  "発注先
LIFN2   TYPE WYT3-LIFN2,  "請求先
EKGRP   TYPE EKKO-EKGRP,  "購買グループ
EBELN   TYPE EKKO-EBELN,  "購買伝票
BELNR   TYPE RSEG-BELNR,  "インボイス
WAERS   TYPE EKKO-WAERS,  "通貨コード
MWSKZ   TYPE EKPO-MWSKZ,  "税コード
LIST1   TYPE WYT3-LIFNR,  "発注仕入先
*elematec 対応 INSERT END   2011/12/08
END OF TBL_EXIT.
*&Ver2 対応 2007/02/28 >>>
DATA:WK_MSGTEXT TYPE STRING.
DATA: OK_CODE LIKE SY-UCOMM,
RC_CODE LIKE SY-SUBRC,
COUNTER LIKE SY-DBCNT,
YNTEXT LIKE SY-TITLE.
*&Ver2 対応 2007/02/28 <<<
*-- 20090113 INS STA
TYPES : BEGIN OF T_TBL_T001,
BUKRS TYPE YN110-BUKRS,
END OF T_TBL_T001.
*-- データ内の重複削除後の会社コード格納用
DATA : TBL_BUKRS TYPE SORTED TABLE OF T_TBL_T001
WITH NON-UNIQUE KEY BUKRS.
DATA : W_BUKRS TYPE T_TBL_T001.
*-- 会社コードマスタ一括取得用（存在チェックで使用）
DATA : TBL_T001 TYPE HASHED TABLE OF T_TBL_T001
WITH UNIQUE KEY BUKRS.
DATA : W_T001 TYPE T_TBL_T001.

TYPES : BEGIN OF T_TBL_XXB1,
VRFCTON TYPE YN110-VRFCTON,
BUKRS   TYPE YN110-BUKRS,
ZTERM   TYPE KNB1-ZTERM,
WAERS   TYPE KNVV-WAERS,
END OF T_TBL_XXB1.
*-- データ内の重複削除後の取引先コード、会社コード格納用
DATA : TBL_VRFCTON TYPE SORTED TABLE OF T_TBL_XXB1
WITH NON-UNIQUE KEY VRFCTON BUKRS.
DATA : W_VRFCTON TYPE T_TBL_XXB1.
*-- KNB1、LFB1一括取得用（存在チェック及び支払条件キーの取得で使用）
DATA : TBL_XXB1 TYPE HASHED TABLE OF T_TBL_XXB1
WITH UNIQUE KEY VRFCTON BUKRS.
DATA : W_XXB1 TYPE T_TBL_XXB1.

*-- 照合マスタ一括取得用（外部EXIT番号の取得で使用）
TYPES : BEGIN OF T_TBL_YNX30,
VRFCTON TYPE YN130-VRFCTON,
BUKRS   TYPE YN130-BUKRS,
OUTEXITDOC TYPE YN130-OUTEXITDOC,
END OF T_TBL_YNX30.
DATA : TBL_YNX30 TYPE HASHED TABLE OF T_TBL_YNX30
WITH UNIQUE KEY VRFCTON BUKRS.
DATA : W_YNX30 TYPE T_TBL_YNX30.

*-- 通貨コード一括取得用（通貨コード存在チェックで使用）
TYPES : BEGIN OF T_TBL_TCURC,
WAERS TYPE TCURC-WAERS,
END OF T_TBL_TCURC.
DATA : TBL_TCURC TYPE HASHED TABLE OF T_TBL_TCURC
WITH UNIQUE KEY WAERS.
DATA : W_TCURC TYPE T_TBL_TCURC.

*-- 利益センタマスタ一括取得用（利益センタ存在チェックで使用）
TYPES : BEGIN OF T_TBL_CEPC,
PRCTR TYPE CEPC-PRCTR,
BUKRS TYPE TKA02-BUKRS,
END OF T_TBL_CEPC.
DATA : TBL_PRCTR TYPE SORTED TABLE OF T_TBL_CEPC
WITH NON-UNIQUE KEY PRCTR BUKRS.
DATA : W_PRCTR TYPE T_TBL_CEPC.
DATA : TBL_CEPC TYPE STANDARD TABLE OF T_TBL_CEPC
WITH NON-UNIQUE KEY PRCTR BUKRS.
DATA : W_CEPC TYPE T_TBL_CEPC.
*-- 20090113 INS END
*elematec 対応 INSERT START 2011/12/08
TYPES : BEGIN OF T_KNVV_KNVI,
KUNNR TYPE KNA1-KUNNR,"得意先コード
LAND1 TYPE KNA1-LAND1,"国コード
KALKS TYPE KNVV-KALKS,"得意先に対する価格決定区分割当	
WAERS TYPE KNVV-WAERS,"通貨コード	
ZTERM TYPE KNVV-ZTERM,"支払条件キー	
VKGRP TYPE KNVV-VKGRP,"営業グループ	
VKBUR TYPE KNVV-VKBUR,"営業所	
TAXKD TYPE KNVI-TAXKD,"得意先の税分類	
END   OF T_KNVV_KNVI.
DATA : TBL_KNVV_KNVI TYPE HASHED TABLE OF T_KNVV_KNVI
WITH UNIQUE KEY KUNNR.
DATA : W_KNVV_KNVI   TYPE T_KNVV_KNVI.
*
TYPES : BEGIN OF T_KNVP_KNVV,
KUNNR TYPE KNVP-KUNNR,"得意先コード	
KUNN2 TYPE KNVP-KUNN2,"取引先の得意先コード	
ZTERM TYPE KNVV-ZTERM,"支払条件キー	
END   OF T_KNVP_KNVV.
DATA : TBL_KNVP_KNVV TYPE HASHED TABLE OF T_KNVP_KNVV
WITH UNIQUE KEY KUNNR.
DATA : W_KNVP_KNVV   TYPE T_KNVP_KNVV.
*
TYPES : BEGIN OF T_A078_KONP,
KSCHL TYPE A078-KSCHL,"条件タイプ
LLAND TYPE A078-LLAND,"仕向国
DATBI TYPE A078-DATBI,"条件マスタ有効終了日
DATAB TYPE A078-DATAB,"条件マスタ有効開始日
MWSK1 TYPE KONP-MWSK1,"税コード
END   OF T_A078_KONP.
DATA : TBL_A078_KONP TYPE TABLE OF T_A078_KONP.
DATA : W_A078_KONP   TYPE T_A078_KONP.
*
TYPES : BEGIN OF T_A002_KONP,
KSCHL TYPE A002-KSCHL,"条件タイプ
TAXK1 TYPE A002-TAXK1,"得意先税分類 1
TAXM1 TYPE A002-TAXM1,"品目の税分類
DATBI TYPE A002-DATBI,"条件マスタ有効終了日
DATAB TYPE A002-DATAB,"条件マスタ有効開始日
MWSK1 TYPE KONP-MWSK1,"税コード
END   OF T_A002_KONP.
DATA : TBL_A002_KONP TYPE TABLE OF T_A002_KONP.
DATA : W_A002_KONP   TYPE T_A002_KONP.
*
TYPES : BEGIN OF T_LFM1_WYT3,
LIFNR TYPE LFM1-LIFNR,"仕入先勘定コード	
ZTERM TYPE LFM1-ZTERM,"支払条件キー	
WAERS TYPE LFM1-WAERS,"通貨コード	
LIFN2 TYPE WYT3-LIFN2,"他の仕入先への参照	
END OF T_LFM1_WYT3.
DATA : TBL_LFM1_WYT3 TYPE HASHED TABLE OF T_LFM1_WYT3
WITH UNIQUE KEY LIFNR.
DATA : W_LFM1_WYT3 TYPE T_LFM1_WYT3.

*
TYPES : BEGIN OF T_ZN001,
LIFNR TYPE ZN001-LIFNR, "仕入先コード
EDATE TYPE ZN001-EDATE, "照合終了日
END OF T_ZN001.
DATA : TBL_ZN001  TYPE HASHED TABLE OF T_ZN001
WITH UNIQUE KEY LIFNR.
DATA : W_ZN001  TYPE T_ZN001.
*
TYPES : BEGIN OF T_RSEG,
BELNR TYPE RSEG-BELNR, "会計伝票番号
GJAHR TYPE RSEG-GJAHR, "会計年度
BUZEI TYPE RSEG-BUZEI, "請求書伝票内伝票明細
EBELN TYPE RSEG-EBELN, "購買伝票番号
EBELP TYPE RSEG-EBELP, "購買伝票の明細番号
WERKS TYPE RSEG-WERKS, "プラント
END OF T_RSEG.
DATA :   TBL_RSEG  TYPE TABLE OF T_RSEG.
DATA : W_RSEG    TYPE T_RSEG.

TYPES : BEGIN OF T_TBL_ZN004,
KUNNR TYPE ZN004-KUNNR, "得意先コード
EDATE TYPE ZN004-EDATE, "照合終了日
END OF T_TBL_ZN004.
DATA : TBL_ZN004  TYPE HASHED TABLE OF T_TBL_ZN004
WITH UNIQUE KEY KUNNR.
DATA : W_ZN004  TYPE T_TBL_ZN004.

TYPES : BEGIN OF T_TBL_YN00007,
YN00007 TYPE YNEIAJ1102-YN00007,
END OF T_TBL_YN00007.
*-- データ内の重複削除後の会社コード格納用
DATA : TBL_YN00007 TYPE SORTED TABLE OF T_TBL_YN00007
WITH NON-UNIQUE KEY YN00007.
DATA : W_YN00007 TYPE T_TBL_YN00007.
TYPES:BEGIN OF TY_EKPO,
EBELN TYPE EKPO-EBELN,
EBELP TYPE EKPO-EBELP,
WERKS TYPE EKPO-WERKS,
MWSKZ TYPE EKPO-MWSKZ,
END OF TY_EKPO.
DATA: T_EKPO TYPE TABLE OF TY_EKPO,
W_EKPO TYPE TY_EKPO.

*
DATA GW_LIFN2 TYPE EKPA-LIFN2.
DATA GW_LIFNR TYPE EKKO-LIFNR.
DATA GW_EKGRP TYPE EKKO-EKGRP.
DATA GW_WAERS TYPE EKKO-WAERS.
DATA GW_EBELN TYPE EKKO-EBELN.
DATA GW_BELNR TYPE RSEG-BELNR.
DATA GW_LIST1 TYPE EKKO-LIFNR.
DATA GW_MWSKZ TYPE EKPO-MWSKZ.

*elematec 対応 INSERT END   2011/12/08

INCLUDE YN01_YN010100_0001.
INCLUDE YN01_YN010100_0002.
INCLUDE YN01_YN010100_0003.
INCLUDE YN01_YN010100_0004.
INCLUDE ZN090100.
DATA W_LOCK TYPE TYP_LOCK.
DATA:LW_LOCK   TYPE TYP_LOCK.
*
*&---------------------------------------------------------------------*
*&      Form  CASE_STRUCTUR
*&---------------------------------------------------------------------*
*       CASE_STRUCTUR
*----------------------------------------------------------------------*
FORM CASE_STRUCTUR .

DATA: L_SEPARATOR TYPE STRING,
L_FIX_FLG TYPE C,
L_EXIT LIKE YN130-OUTEXITDOC.

DATA: L_TAB TYPE X,
L_ERR_MSG(128) TYPE C.

* conversion 対応 2010/12/13 UPD >>>
*  L_TAB = '09'.
L_TAB = '09'.
* conversion 対応 2010/12/13 UPD <<<

IF P_TAB = 'X'.
* conversion 対応 2010/12/13 UPD >>>
*    L_SEPARATOR = CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
L_SEPARATOR = L_TAB.
* conversion 対応 2010/12/13 UPD <<<
L_FIX_FLG = ''.
ENDIF.
IF P_FIX = 'X'.
L_SEPARATOR = ''.
L_FIX_FLG = 'X'.
ENDIF.
IF P_PAUSE = 'X'.
L_SEPARATOR = P_PAUSEC.
L_FIX_FLG = ''.
ENDIF.
**elematec 対応 INSERT START 2011/12/08
*存在チェック等に使用するマスタデータの一括取得
PERFORM GET_CHECK_DATA.
*elematec 対応 INSERT END   2011/12/08
CASE P_TBNAME.
*=============================================================
WHEN 'YNEIAJ1101'.
*elematec 対応 INSERT START 2011/12/08
* 入力ファイルの取得
PERFORM GET_T_CSV_DATA_COMM  TABLES TBL_YNEIAJ1101
USING  L_SEPARATOR
''
L_FIX_FLG
P_TBNAME.

CHECK G_ERR_COUNT = 0.
*各種チェック
PERFORM F_CHECK_YNEIAJ1101.
CHECK G_ERR_COUNT = 0.
* テーブルのロック
PERFORM LOCK_PRCHS_SALES.
* 取引先別のEXIT番号の取得
PERFORM GET_EXIT_YNEIAJ1101.
* YNEIAJ1101のEXIT番号処理
PERFORM EXIT_YNEIAJ1101.
* テーブルのロック解除
PERFORM UNLOCK_PRCHS_SALES.
*elematec 対応 INSERT END   2011/12/08
*elematec 対応 DELETE START 2011/12/08
*      IF P_SALES <> 'X'.
** 指定された構造は処理できません
*        MESSAGE I771.
*        STOP.
*      ENDIF.
* 入力ファイルの取得
*      PERFORM GET_T_CSV_DATA  TABLES TBL_YNEIAJ1101
*                              USING  L_SEPARATOR
*                                     ''
*                                     L_FIX_FLG.
** 権限チェック ; テーブルのロック ;  EXIT番号の取得
*      PERFORM STRUCTURE_COMM  TABLES TBL_YNEIAJ1101 USING P_TBNAME.
** YNEIAJ1101のEXIT番号処理
*      PERFORM EXIT_YNEIAJ1101.
** テーブルのロック解除
*      PERFORM UNLOCK_COMM  TABLES TBL_YNEIAJ1101.
*elematec 対応 DELETE END   2011/12/08
*=============================================================
WHEN 'YNEIAJ1102'.
*elematec 対応 INSERT START 2011/12/08
* 入力ファイルの取得
PERFORM GET_T_CSV_DATA_COMM  TABLES TBL_YNEIAJ1102
USING  L_SEPARATOR
''
L_FIX_FLG
P_TBNAME.

CHECK G_ERR_COUNT = 0.
*各種チェック
PERFORM F_CHECK_YNEIAJ1102.
CHECK G_ERR_COUNT = 0.
* テーブルのロック
PERFORM LOCK_PRCHS_SALES.
* 取引先別のEXIT番号の取得
PERFORM GET_EXIT_YNEIAJ1102.
* YNEIAJ1101のEXIT番号処理
PERFORM EXIT_YNEIAJ1102.
* テーブルのロック解除
PERFORM UNLOCK_PRCHS_SALES.
*elematec 対応 INSERT END   2011/12/08

*elematec 対応 DELETE START 2011/12/08
*      IF P_PRCHS <> 'X'.
** 指定された構造は処理できません
*        MESSAGE I771.
*        STOP.
*      ENDIF.
*elematec 対応 DELETE END T 2011/12/08

* 入力ファイルの取得
*      PERFORM GET_T_CSV_DATA  TABLES TBL_YNEIAJ1102
*                              USING  L_SEPARATOR
*                                     ''
*                                     L_FIX_FLG.
* 権限チェック ; テーブルのロック ;  EXIT番号の取得
*      PERFORM STRUCTURE_COMM  TABLES TBL_YNEIAJ1102 USING P_TBNAME.
* YNEIAJ1102のEXIT番号処理
*      PERFORM EXIT_YNEIAJ1102.
* テーブルのロック解除
*      PERFORM UNLOCK_COMM  TABLES TBL_YNEIAJ1102.
*=============================================================
WHEN 'YNYN110'.
*elematec 対応 INSERT START 2011/12/08
* 入力ファイルの取得
PERFORM GET_T_CSV_DATA_COMM  TABLES TBL_YNYN110
USING  L_SEPARATOR
''
L_FIX_FLG
P_TBNAME.
CHECK G_ERR_COUNT = 0.
*各種チェック
PERFORM F_CHECK_YNYN110. "各種チェック
CHECK G_ERR_COUNT = 0.
* テーブルのロック
PERFORM LOCK_PRCHS_SALES.
* 取引先別のEXIT番号の取得
PERFORM GET_EXIT_YNYN110.
* YNYN110のEXIT番号処理
PERFORM EXIT_YNYN110.
* テーブルのロック解除
PERFORM UNLOCK_PRCHS_SALES.
*elematec 対応 INSERT END   2011/12/08

*elematec 対応 DELETE START 2011/12/08
*      IF P_SALES <> 'X'.
** 指定された構造は処理できません
*        MESSAGE I771.
*        STOP.
*      ENDIF.
** 入力ファイルの取得
*      PERFORM GET_T_CSV_DATA  TABLES TBL_YNYN110
*                              USING  L_SEPARATOR
*                                     ''
*                                     L_FIX_FLG.
** 権限チェック ; テーブルのロック ;  EXIT番号の取得
*      PERFORM STRUCTURE_COMM  TABLES TBL_YNYN110 USING P_TBNAME.
** YNYN110のEXIT番号処理
*      PERFORM EXIT_YNYN110.
** テーブルのロック解除
*      PERFORM UNLOCK_COMM  TABLES TBL_YNYN110.
*elematec 対応 DELETE END T 2011/12/08
*=============================================================
WHEN 'YNYN210'.
*elematec 対応 INSERT START 2011/12/08
* 入力ファイルの取得
PERFORM GET_T_CSV_DATA_COMM  TABLES TBL_YNYN210
USING  L_SEPARATOR
''
L_FIX_FLG
P_TBNAME.
CHECK G_ERR_COUNT = 0.
*各種チェック
PERFORM F_CHECK_YNYN210. "各種チェック
CHECK G_ERR_COUNT = 0.
* テーブルのロック
PERFORM LOCK_PRCHS_SALES.
* 取引先別のEXIT番号の取得
PERFORM GET_EXIT_YNYN210.
* YNYN110のEXIT番号処理
PERFORM EXIT_YNYN210.
* テーブルのロック解除
PERFORM UNLOCK_PRCHS_SALES.
*elematec 対応 INSERT END   2011/12/08

*elematec 対応 DELETE START 2011/12/08
*      IF P_PRCHS <> 'X'.
** 指定された構造は処理できません
*        MESSAGE I771.
*        STOP.
*      ENDIF.
* 入力ファイルの取得
*      PERFORM GET_T_CSV_DATA  TABLES TBL_YNYN210
*                              USING  L_SEPARATOR
*                                     ''
*                                     L_FIX_FLG.
* 権限チェック ; テーブルのロック ;  EXIT番号の取得
*      PERFORM STRUCTURE_COMM  TABLES TBL_YNYN210 USING P_TBNAME.
* YNYN210のEXIT番号処理
*      PERFORM EXIT_YNYN210.
* テーブルのロック解除
*      PERFORM UNLOCK_COMM  TABLES TBL_YNYN210.
*elematec 対応 DELETE END T 2011/12/08

WHEN OTHERS.
* 指定されたレイアウトは処理できません
MESSAGE I771.
STOP.
ENDCASE.

ENDFORM.                    " CASE_STRUCTUR
*=======================================================================
*&---------------------------------------------------------------------*
*&      Form  EXIT_YNEIAJ1101
*&---------------------------------------------------------------------*
*       YNEIAJ1101のEXIT番号処理
*----------------------------------------------------------------------*
FORM EXIT_YNEIAJ1101 .
*
DATA: LW_YNEIAJ1101 LIKE YNEIAJ1101,
L_RUN_FLG TYPE C,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING,
L_ERR_FLG TYPE C,
L_RC TYPE C.
*elematec 対応 INSERT START 2011/12/08
CHECK G_ERR_COUNT = 0.
*elematec 対応 INSERT END   2011/12/08

LOOP AT TBL_EXIT .
READ TABLE TBL_YNEIAJ1101 INDEX TBL_EXIT-INDEX
INTO LW_YNEIAJ1101.
*elematec 対応 DELETE START 2011/12/08
** 属性チェック
*    PERFORM CHECK_ATTRIBUTE_YNEIAJ1101 USING LW_YNEIAJ1101
*                                             L_RC.
*    IF L_RC ='X'.
*      CONTINUE.
*    ENDIF.
*elematec 対応 DELETE END   2011/12/08
CASE TBL_EXIT-EXIT.
*elematec 対応 DELETE START 2011/12/08
*    WHEN '0001'.
*elematec 対応 DELETE END   2011/12/08
*elematec 対応 INSERT START 2011/12/08
WHEN '1001'.
*elematec 対応 INSERT END   2011/12/08

*登録
IF P_CRT = 'X'.
L_RUN_FLG = 'X'.
*EXIT番号0001処理->1001
PERFORM YNEIAJ1101_0001 USING LW_YNEIAJ1101.
ENDIF.
*変更
IF P_UPD = 'X'.
MESSAGE I773 WITH TEXT-M08.
STOP.
ENDIF.
*削除
IF P_DLT = 'X'.
MESSAGE I773 WITH TEXT-M09.
STOP.
ENDIF.
WHEN OTHERS.
* EXIT番号 & は定義されていません
CLEAR: L_ERR_MSG.
MESSAGE I760 INTO L_ERR_MSG WITH TBL_EXIT-EXIT.
*elematec 対応 INSERT START 2011/12/08
PERFORM F_ERR_LOG_FILE_SET USING TBL_EXIT-INDEX
TBL_YNEIAJ1101-YN00004
L_ERR_MSG.
*elematec 対応 INSERT END   2011/12/08
*elematec 対応 DELETE START 2011/12/08
*      PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                               LW_YNEIAJ1101-YNVRFCTON
*                               LW_YNEIAJ1101-YNBUKRS
*                               L_ERR_MSG.
*      READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*      PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*      G_ERR_COUNT = G_ERR_COUNT  + 1.
*elematec 対応 DELETE END   2011/12/08
ENDCASE.
ENDLOOP.
G_TBLID = 'YN110'.
*&Ver2 対応 2007/02/28 >>>
IF P_TEST <> 'X' AND G_ERR_COUNT = 0.
*&Ver2 対応 2007/02/28 <<<
* 外部番号の取得
PERFORM GET_NUMBER_YN110.
* テーブルの更新
IF P_CRT = 'X'.
PERFORM INSERT_YN110.
ENDIF.
ENDIF.
*
ENDFORM.                    " EXIT_YNEIAJ1101
*&---------------------------------------------------------------------*
*&      Form  EXIT_YNEIAJ1102
*&---------------------------------------------------------------------*
*       YNEIAJ1102のEXIT番号処理
*----------------------------------------------------------------------*
FORM EXIT_YNEIAJ1102 .

DATA: LW_YNEIAJ1102 LIKE YNEIAJ1102,
L_RUN_FLG TYPE C,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING,
L_ERR_FLG TYPE C,
L_RC TYPE C.

*elematec 対応 INSERT START 2011/12/08
CHECK G_ERR_COUNT = 0.
*elematec 対応 INSERT END   2011/12/08

LOOP AT TBL_EXIT .
READ TABLE TBL_YNEIAJ1102 INDEX TBL_EXIT-INDEX
INTO LW_YNEIAJ1102.
*elematec 対応 DELETE START 2011/12/08
* 属性チェック
*    PERFORM CHECK_ATTRIBUTE_YNEIAJ1102 USING LW_YNEIAJ1102
*                                             L_RC.
*    IF L_RC ='X'.
*      CONTINUE.
*    ENDIF.
*elematec 対応 DELETE START 2011/12/08

CASE TBL_EXIT-EXIT.
*elematec 対応 UPDATE START 2011/12/08
*    WHEN '0002'.
WHEN '2001'.
*elematec 対応 UPDATE END   2011/12/08
* 登録
IF P_CRT = 'X'.
L_RUN_FLG = 'X'.
* EXIT番号0002処理->2001
PERFORM YNEIAJ1102_0002 USING LW_YNEIAJ1102.
ENDIF.
* 変更
IF P_UPD = 'X'.
MESSAGE I773 WITH TEXT-M08.
STOP.
ENDIF.
* 削除
IF P_DLT = 'X'.
MESSAGE I773 WITH TEXT-M09.
STOP.
ENDIF.
WHEN OTHERS.
* EXIT番号 & は定義されていません
CLEAR: L_ERR_MSG.
MESSAGE I760 INTO L_ERR_MSG WITH TBL_EXIT-EXIT.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
ENDCASE.
ENDLOOP.
G_TBLID = 'YN210'.
*&Ver2 対応 2007/02/28 >>>
IF P_TEST <> 'X' AND G_ERR_COUNT = 0.
*&Ver2 対応 2007/02/28 <<<
* 外部番号の取得
PERFORM GET_NUMBER_YN210.
IF P_CRT = 'X'.
* テーブルの更新
PERFORM INSERT_YN210.
ENDIF.
ENDIF.

ENDFORM.                    " EXIT_YNEIAJ1102
*&---------------------------------------------------------------------*
*&      Form  EXIT_YNYN110
*&---------------------------------------------------------------------*
*       YNYN110のEXIT番号処理
*----------------------------------------------------------------------*
FORM EXIT_YNYN110 .

DATA: LW_YNYN110 LIKE YNYN110,
L_RUN_FLG TYPE C,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING,
L_ERR_FLG TYPE C,
L_RC TYPE C.
*elematec 対応 INSERT START 2011/12/08
CHECK G_ERR_COUNT = 0.
*elematec 対応 INSERT END   2011/12/08

LOOP AT TBL_EXIT .
READ TABLE TBL_YNYN110 INDEX TBL_EXIT-INDEX
INTO LW_YNYN110.
*elematec 対応 DETELE START 2011/12/08
** 属性チェック
*    PERFORM CHECK_ATTRIBUTE_YNYN110 USING LW_YNYN110
*                                          L_RC.
*    IF L_RC ='X'.
*      CONTINUE.
*    ENDIF.
*elematec 対応 DELETE END   2011/12/08

CASE TBL_EXIT-EXIT.
*elematec 対応 DELETE START 2011/12/08
*    WHEN '0003'.
* EXIT番号0003処理
*elematec 対応 DELETE END   2011/12/08
*elematec 対応 INSERT START 2011/12/08
WHEN '1001' OR '1002' OR '1003'.
*elematec 対応 INSERT END   2011/12/08
L_RUN_FLG = 'X'.
* 登録
IF P_CRT = 'X'.
PERFORM YNYN110_0003 USING LW_YNYN110.
ENDIF.
* 変更
IF P_UPD = 'X'.
* 存在チェック
CLEAR L_RC.
PERFORM CHECK_YNYN110 USING LW_YNYN110 L_RC.
IF L_RC ='X'.
CONTINUE.
ENDIF.

PERFORM YNYN110_0003 USING LW_YNYN110.
ENDIF.
* 削除
IF P_DLT = 'X'.
* 存在チェック
L_RUN_FLG = 'X'.
CLEAR L_RC.
PERFORM CHECK_YNYN110 USING LW_YNYN110 L_RC.
IF L_RC ='X'.
CONTINUE.
ENDIF.
PERFORM YNYN110_0003_DEL USING LW_YNYN110.
ENDIF.
WHEN OTHERS.
* EXIT番号 & は定義されていません
CLEAR: L_ERR_MSG.
MESSAGE I760 INTO L_ERR_MSG WITH TBL_EXIT-EXIT.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*elematec 対応 DELETE START 2011/12/08
*                               LW_YNYN110-YNVRFCTON
*                               LW_YNYN110-YNBUKRS
*elematec 対応 DELETE END   2011/12/08
*elematec 対応 INSERT START 2011/12/08
LW_YNYN110-YNLIST1
P_BUKRS
*elematec 対応 INSERT END   2011/12/08
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
ENDCASE.
ENDLOOP.
G_TBLID = 'YN110'.
*&Ver2 対応 2007/02/28 >>>
IF P_TEST <> 'X' AND G_ERR_COUNT = 0.
*&Ver2 対応 2007/02/28 <<<
* 登録
IF P_CRT = 'X'.
* 外部番号の取得
PERFORM GET_NUMBER_YN110.
PERFORM INSERT_YN110.
ENDIF.
* 変更
IF P_UPD = 'X'.
PERFORM UPDATE_YN110.
ENDIF.
* 削除
IF P_DLT = 'X'.
PERFORM DELETE_YN110.
ENDIF.
ENDIF.
ENDFORM.                    " EXIT_YNYN110
*&---------------------------------------------------------------------*
*&      Form  EXIT_YNYN210
*&---------------------------------------------------------------------*
*       YNYN210のEXIT番号処理
*----------------------------------------------------------------------*
FORM EXIT_YNYN210 .

DATA: LW_YNYN210 LIKE YNYN210,
L_RUN_FLG TYPE C,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING,
L_ERR_FLG TYPE C,
L_RC TYPE C.
*elematec 対応 INSERT START 2011/12/08
CHECK G_ERR_COUNT = 0.
*elematec 対応 INSERT END   2011/12/08

LOOP AT TBL_EXIT .
READ TABLE TBL_YNYN210 INDEX TBL_EXIT-INDEX
INTO LW_YNYN210.
*elematec 対応 DETELE START 2011/12/08
** 属性チェック
*    CLEAR L_RC.
*    PERFORM CHECK_ATTRIBUTE_YNYN210 USING LW_YNYN210
*                                          L_RC.
*    IF L_RC ='X'.
*      CONTINUE.
*    ENDIF.
*elematec 対応 DELETE END   2011/12/08

CASE TBL_EXIT-EXIT.
*elematec 対応 UPDATE START 2011/12/08
*    WHEN '0004'.
WHEN '2001' OR '2002' OR '2003'.
*elematec 対応 UPDATE END   2011/12/08
L_RUN_FLG = 'X'.
*登録
IF P_CRT = 'X'.
*EXIT番号0004処理->2001,2002,2003
PERFORM YNYN210_0004 USING LW_YNYN210.
ENDIF.
*変更
IF P_UPD = 'X'.
* 存在チェック
CLEAR L_RC.
PERFORM CHECK_YNYN210 USING LW_YNYN210
L_RC.
IF L_RC ='X'.
CONTINUE.
ENDIF.

PERFORM YNYN210_0004 USING LW_YNYN210.
ENDIF.
* 削除
IF P_DLT = 'X'.
*EXIT番号0004削除処理
* 存在チェック
CLEAR L_RC.
PERFORM CHECK_YNYN210 USING LW_YNYN210
L_RC.
IF L_RC ='X'.
CONTINUE.
ENDIF.
PERFORM YNYN210_0004_DEL USING LW_YNYN210.
ENDIF.
WHEN OTHERS.
* EXIT番号 & は定義されていません
CLEAR: L_ERR_MSG.
MESSAGE I760 INTO L_ERR_MSG WITH TBL_EXIT-EXIT.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN210-YNVRFCTON
LW_YNYN210-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
ENDCASE.
ENDLOOP.
G_TBLID = 'YN210'.
*&Ver2 対応 2007/02/28 >>>
IF P_TEST <> 'X' AND G_ERR_COUNT = 0.
*&Ver2 対応 2007/02/28 <<<
* 登録
IF P_CRT = 'X'.
* 外部番号の取得
PERFORM GET_NUMBER_YN210.
PERFORM INSERT_YN210.
ENDIF.
* 変更
IF P_UPD = 'X'.
PERFORM UPDATE_YN210.
ENDIF.
* 削除
IF P_DLT = 'X'.
PERFORM DELETE_YN210.
ENDIF.
ENDIF.
ENDFORM.                    " EXIT_YNYN210
*=======================================================================
*&---------------------------------------------------------------------*
*&      Form  GET_T_CSV_DATA
*&---------------------------------------------------------------------*
*       データ取得
*----------------------------------------------------------------------*
*      <--P_T_CSV_DATA  CSVデータ内部テーブル
*      -->P_T_CSV_LINE  CSV LINE 内部テーブル
*----------------------------------------------------------------------*
FORM GET_T_CSV_DATA  TABLES   P_T_CSV_DATA
USING    P_SEPARATOR
P_FIXER
P_FIX_FLG.

DATA: L_TABIX LIKE SY-TABIX,
L_INDEX LIKE SY-INDEX.
DATA: L_T_FIELD TYPE STANDARD TABLE OF STRING,
L_FIELD TYPE STRING,
L_FIELD_COUNT TYPE I.
DATA: L_LEN_FIXER TYPE I,
L_LEN_FIXER2 TYPE I.

DATA: L_LEN TYPE I,
L_FLEN TYPE I,
L_OFFLEN TYPE I,
L_CURRENT_LEN TYPE I,
L_LINE_LEN TYPE I,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING.

FIELD-SYMBOLS <FS_CSV_FIELD>.
FIELD-SYMBOLS <FS_YNBUKRS>.
FIELD-SYMBOLS <FS_YNVRFCTON>.

IF P_FIX_FLG <> 'X'.
L_LEN_FIXER = STRLEN( P_FIXER ).
L_LEN_FIXER2 = L_LEN_FIXER * 2.

REFRESH P_T_CSV_DATA.
LOOP AT TBL_CSV.
L_TABIX = SY-TABIX.
SPLIT TBL_CSV AT P_SEPARATOR INTO TABLE L_T_FIELD.
CLEAR: P_T_CSV_DATA, L_FIELD_COUNT.
DO.
L_INDEX = SY-INDEX.
ASSIGN COMPONENT L_INDEX OF STRUCTURE P_T_CSV_DATA
TO <FS_CSV_FIELD>.
CASE SY-SUBRC.
WHEN 0.
L_FIELD_COUNT = L_FIELD_COUNT + 1.
READ TABLE L_T_FIELD INTO L_FIELD INDEX L_INDEX.
IF SY-SUBRC = 0.
SHIFT L_FIELD RIGHT CIRCULAR BY L_LEN_FIXER PLACES.
L_LEN = STRLEN( L_FIELD ).
IF L_LEN < L_LEN_FIXER2 OR
L_FIELD(L_LEN_FIXER) <> P_FIXER OR
L_FIELD+L_LEN_FIXER(L_LEN_FIXER) <> P_FIXER.
*   [項目名]の桁数が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNBUKRS>.
ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*elematec 対応 UPDATE START 2011/12/08
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*                <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
SHIFT L_FIELD LEFT BY L_LEN_FIXER2 PLACES.
IF <FS_CSV_FIELD> CP '* #'.
ENDIF.
L_FLEN = SY-FDPOS.
L_LEN = STRLEN( L_FIELD ).
IF L_FLEN >= L_LEN .
CATCH SYSTEM-EXCEPTIONS  CONVT_NO_NUMBER = 1 .
<FS_CSV_FIELD> = L_FIELD.
ENDCATCH.
IF SY-SUBRC = 1.
*   [項目名]の属性が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH L_FIELD.
ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNBUKRS>.
ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*elematec 対応 UPDATE START 2011/12/08
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*                  <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
ELSE.
*   [項目名]の桁数が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNBUKRS>.
ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*elematec 対応 UPDATE START 2011/12/08
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*                  <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
ENDIF.
WHEN OTHERS.
EXIT.
ENDCASE.
ENDDO.
APPEND P_T_CSV_DATA.
ENDLOOP.
ELSE.
* 固定長
REFRESH P_T_CSV_DATA.
LOOP AT TBL_CSV.
L_OFFLEN = 0.
L_TABIX = SY-TABIX.
DO.
L_INDEX = SY-INDEX.
ASSIGN COMPONENT L_INDEX OF STRUCTURE P_T_CSV_DATA
TO <FS_CSV_FIELD>.
CASE SY-SUBRC.
WHEN 0.
L_FIELD_COUNT = L_FIELD_COUNT + 1.
IF <FS_CSV_FIELD> CP '* #'.
ENDIF.
L_FLEN = SY-FDPOS.
L_CURRENT_LEN =  L_OFFLEN + L_FLEN.
* UPDATE 2007/04/19 IWAKI(DMC) {
*            L_LINE_LEN = STRLEN( TBL_CSV ).
* conversion 対応 2010/12/13 UPD >>>
*            L_LINE_LEN = cl_abap_list_utilities=>dynamic_output_length(
* TBL_CSV ).
* Mod ES-UP 2012/10/31 -->
*            L_LINE_LEN = STRLEN( TBL_CSV ).
L_LINE_LEN = cl_abap_list_utilities=>dynamic_output_length( TBL_CSV ).
* Mod ES-UP 2012/10/31 <--
* conversion 対応 2010/12/13 UPD <<<
* } UPDATE 2007/04/19 IWAKI(DMC)
IF L_CURRENT_LEN > L_LINE_LEN.
*   [項目名]の桁数が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNBUKRS>.
ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*elematec 対応 UPDATE START 2011/12/08
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*              <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
* UPDATE 2007/04/20 IWAKI(DMC) {
*            L_FIELD = TBL_CSV+L_OFFLEN(L_FLEN).
* conversion 対応 2010/12/13 UPD >>>
*             CL_ABAP_LIST_UTILITIES=>READ_FROM_DISPLAY_LAYOUT(
*                                          EXPORTING DISPLAY_DATA =
*TBL_CSV
*                                                    DISPLAY_OFFSET =
*L_OFFLEN
*                                                    DISPLAY_LENGTH =
*L_FLEN
*                                          IMPORTING FIELD = L_FIELD ).
* Mod ES-UP 2012/10/31 -->
*            L_FIELD = TBL_CSV+L_OFFLEN(L_FLEN).
CL_ABAP_LIST_UTILITIES=>READ_FROM_DISPLAY_LAYOUT(
EXPORTING DISPLAY_DATA = TBL_CSV
DISPLAY_OFFSET = L_OFFLEN
DISPLAY_LENGTH = L_FLEN
IMPORTING FIELD = L_FIELD ).
* Mod ES-UP 2012/10/31 <--
* conversion 対応 2010/12/13 UPD <<<

* } UPDATE 2007/04/20 IWAKI(DMC)
L_OFFLEN = L_OFFLEN + L_FLEN.
CATCH SYSTEM-EXCEPTIONS  CONVT_NO_NUMBER = 1 .
<FS_CSV_FIELD> = L_FIELD.
ENDCATCH.
IF SY-SUBRC = 1.
*[項目名]の属性が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH L_FIELD.
ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNBUKRS>.
ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*elematec 対応 UPDATE START 2011/12/08
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*              <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
WHEN OTHERS.
EXIT.
ENDCASE.
ENDDO.
APPEND P_T_CSV_DATA.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_T_CSV_DATA
*&---------------------------------------------------------------------*
*&      Form  CHECK_BUKRS
*&---------------------------------------------------------------------*
*       会社コードのチェック
*----------------------------------------------------------------------*
FORM CHECK_BUKRS USING P_YNBUKRS.
*elematec 対応 INSERT START 2012/01/23
*-- 会社コードマスタの一括取得
SELECT BUKRS INTO TABLE TBL_T001
FROM T001
WHERE BUKRS = P_YNBUKRS.
IF SY-SUBRC <> 0.
*  会社コード & はありません
MESSAGE E750 WITH P_YNBUKRS.
ENDIF.
*elematec 対応 INSERT END   2012/01/23
*elematec 対応 DELETE START 2012/01/23
**-- 20090113 UPD STA 存在チェックをREADに変更
*  READ TABLE TBL_T001 INTO W_T001
*                 WITH TABLE KEY BUKRS = P_YNBUKRS.
**-- 20090113 UPD END
*  IF SY-SUBRC <> 0.
*    MESSAGE I750 WITH P_YNBUKRS.
**&Ver2 対応 2007/02/28 >>>
*      CLEAR:WK_MSGTEXT.
*      MESSAGE I750 WITH P_YNBUKRS INTO WK_MSGTEXT.
*      SKIP.
*      SKIP.
*      ULINE.
*      WRITE:/004 W_FILENAME.
*      ULINE.
*      SKIP.
*      WRITE:/004 WK_MSGTEXT.
**&Ver2 対応 2007/02/28 <<<
*    STOP.
*  ENDIF.
*elematec 対応 DELETE END   2012/01/23
ENDFORM.                    " CHECK_BUKRS
*&---------------------------------------------------------------------*
*&      Form  CHECK_VRFCT
*&---------------------------------------------------------------------*
*       取引先コードのチェック
*----------------------------------------------------------------------*
FORM CHECK_VRFCT USING P_YNBUKRS
P_YNVRFCT.

DATA: L_VRFCT LIKE KNB1-KUNNR.         " 取引先コード

* [売上照合]が選択された場合
IF P_SALES = 'X'.
*-- 20090113 UPD STA 存在チェックをREADに変更
CLEAR : W_XXB1.
READ TABLE TBL_XXB1 INTO W_XXB1
WITH TABLE KEY VRFCTON = P_YNVRFCT
BUKRS   = P_YNBUKRS.
*-- 20090113 UPD END
IF SY-SUBRC <> 0.
MESSAGE I752 WITH P_YNVRFCT.
*&Ver2 対応 2007/02/28 >>>
CLEAR:WK_MSGTEXT.
MESSAGE I752 WITH P_YNVRFCT INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
*&Ver2 対応 2007/02/28 <<<
STOP.
ENDIF.
ENDIF.
* [仕入照合]が選択された場合
IF P_PRCHS = 'X'.
*-- 20090113 UPD STA 存在チェックをREADに変更
CLEAR : W_XXB1.
READ TABLE TBL_XXB1 INTO W_XXB1
WITH TABLE KEY VRFCTON = P_YNVRFCT
BUKRS   = P_YNBUKRS.
*-- 20090113 UPD END
IF SY-SUBRC <> 0.
MESSAGE I753 WITH P_YNVRFCT.
*&Ver2 対応 2007/02/28 >>>
CLEAR:WK_MSGTEXT.
MESSAGE I753 WITH P_YNVRFCT INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
*&Ver2 対応 2007/02/28 <<<
STOP.
ENDIF.
ENDIF.

ENDFORM.                    " CHECK_VRFCT
*&---------------------------------------------------------------------*
*&      Form  AUTHOR_CHECK
*&---------------------------------------------------------------------*
*       権限チェック
*----------------------------------------------------------------------*
FORM AUTHOR_CHECK USING P_YNBUKRS.

* [売上照合]が選択された場合
IF P_SALES = 'X'.
AUTHORITY-CHECK OBJECT 'F_KNA1_BUK'
ID 'BUKRS' FIELD P_YNBUKRS
ID 'ACTVT' DUMMY.
ENDIF.
* [仕入照合]が選択された場合
IF P_PRCHS = 'X'.
AUTHORITY-CHECK OBJECT 'F_LFA1_BUK'
ID 'BUKRS' FIELD P_YNBUKRS
ID 'ACTVT' DUMMY.
ENDIF.
*elematec 対応 INSERT START 2012/01/23
IF SY-SUBRC <> 0.
*会社コード & を処理する権限がありません
MESSAGE E751 WITH P_YNBUKRS.
ENDIF.
*elematec 対応 INSERT END   2012/01/23

*elematec 対応 DELETE START 2012/01/23
*  IF SY-SUBRC <> 0.
*    MESSAGE I751 WITH P_YNBUKRS.
**&Ver2 対応 2007/02/28 >>>
*      CLEAR:WK_MSGTEXT.
*      MESSAGE I751 WITH P_YNBUKRS INTO WK_MSGTEXT.
*      SKIP.
*      SKIP.
*      ULINE.
*      WRITE:/004 W_FILENAME.
*      ULINE.
*      SKIP.
*      WRITE:/004 WK_MSGTEXT.
**&Ver2 対応 2007/02/28 <<<
*    STOP.
*  ENDIF.
*elematec 対応 DELETE END   2012/01/23


ENDFORM.                    " AUTHOR_CHECK
*&---------------------------------------------------------------------*
*&      Form  LOCK_TABLE
*&---------------------------------------------------------------------*
*       テーブルのロック
*----------------------------------------------------------------------*
FORM LOCK_TABLE USING P_VRFCTON
P_BUKRS.

DATA: L_USER LIKE SY-MSGV1,
L_BUKRS LIKE YN110-BUKRS,
L_VRFCTON LIKE YN110-VRFCTON.

L_VRFCTON = P_VRFCTON.
L_BUKRS   = P_BUKRS.
IF P_SALES = 'X'.
* [売上照合]が選択された場合
* テーブルYN110のロック
CALL FUNCTION 'ENQUEUE_EY_YN110'
EXPORTING
VRFCTON = L_VRFCTON
BUKRS   = L_BUKRS
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
L_USER = SY-MSGV1.
IF SY-SUBRC <> 0.
MESSAGE I756  WITH TEXT-M01 L_USER.
*&Ver2 対応 2007/02/28 >>>
CLEAR:WK_MSGTEXT.
MESSAGE I756 WITH TEXT-M01 L_USER INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
*&Ver2 対応 2007/02/28 <<<
STOP.
ENDIF.
ENDIF.
IF P_PRCHS = 'X'.
* [仕入照合]が選択された場合
* テーブルYN210のロック
CALL FUNCTION 'ENQUEUE_EY_YN210'
EXPORTING
VRFCTON = L_VRFCTON
BUKRS   = L_BUKRS
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
L_USER = SY-MSGV1.
IF SY-SUBRC <> 0.
MESSAGE I756  WITH TEXT-M02 L_USER.
*&Ver2 対応 2007/02/28 >>>
CLEAR:WK_MSGTEXT.
MESSAGE I756 WITH TEXT-M02 L_USER INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
*&Ver2 対応 2007/02/28 <<<
STOP.
ENDIF.
ENDIF.

ENDFORM.                    " LOCK_TABLE
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_TABLE
*&---------------------------------------------------------------------*
*       テーブルのアンロック
*----------------------------------------------------------------------*
FORM UNLOCK_TABLE USING P_VRFCTON
P_BUKRS.

DATA: L_BUKRS LIKE YN110-BUKRS,
L_VRFCTON LIKE YN110-VRFCTON.

L_VRFCTON = P_VRFCTON.
L_BUKRS   = P_BUKRS.
IF P_SALES = 'X'.
* [売上照合]が選択された場合
* テーブルYN110のアンロック
CALL FUNCTION 'DEQUEUE_EY_YN110'
EXPORTING
VRFCTON = L_VRFCTON
BUKRS   = L_BUKRS
EXCEPTIONS
OTHERS         = 1.
IF SY-SUBRC <> 0.
MESSAGE I763 WITH TEXT-M01.
STOP.
ENDIF.
ENDIF.
IF P_PRCHS = 'X'.
* [仕入照合]が選択された場合
* テーブルYN210のアンロック
CALL FUNCTION 'DEQUEUE_EY_YN210'
EXPORTING
VRFCTON = L_VRFCTON
BUKRS   = L_BUKRS
EXCEPTIONS
OTHERS         = 1.
IF SY-SUBRC <> 0.
MESSAGE I763 WITH TEXT-M02.
STOP.
ENDIF.
ENDIF.

ENDFORM.                    " UNLOCK_TABLE

*&---------------------------------------------------------------------*
*&      Form  GET_EXIT
*&---------------------------------------------------------------------*
*       EXIT番号の取得
*----------------------------------------------------------------------*
FORM GET_EXIT USING P_VRFCTON
P_BUKRS
P_INDEX.
DATA: L_OUTEXITDOC LIKE YN130-OUTEXITDOC,
L_TBLID(5)   TYPE C.
*-- 20090113 INS STA
DATA: L_INDEX TYPE SY-TABIX.

L_INDEX = P_INDEX.
CLEAR W_YNX30.
*-- 20090113 INS END

* TDNAME
READ TABLE TBL_YNX30 INTO W_YNX30 WITH KEY VRFCTON = P_VRFCTON
BUKRS   = P_BUKRS.
IF SY-SUBRC <> 0.
* DEfAULT
READ TABLE TBL_YNX30 INTO W_YNX30 WITH KEY VRFCTON = 'DEFAULT'
BUKRS   = P_BUKRS.
IF SY-SUBRC <> 0.
*-- 20090113 MOV STA テーブルIDはメッセージ出力時のみ必要な為、移動
IF P_SALES = 'X'.
* [売上照合]が選択された場合
L_TBLID = 'YN130'.
ENDIF.
IF P_PRCHS = 'X'.
* [仕入照合]が選択された場合
L_TBLID = 'YN230'.
ENDIF.
*-- 20090113 MOV END
MESSAGE I754 WITH L_TBLID.
*&Ver2 対応 2007/02/28 >>>
CLEAR:WK_MSGTEXT.
MESSAGE I754 WITH L_TBLID INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
*&Ver2 対応 2007/02/28 <<<
STOP.
ENDIF.
ENDIF.
*-- 20090113 UPD STA
TBL_EXIT-EXIT = W_YNX30-OUTEXITDOC.
TBL_EXIT-INDEX = L_INDEX.
*-- 20090113 UPD END
APPEND TBL_EXIT.

ENDFORM.                    " GET_EXIT

*&---------------------------------------------------------------------*
*&      Form  GET_NUMBER_YN110
*&---------------------------------------------------------------------*
*       外部番号の取得
*----------------------------------------------------------------------*
FORM GET_NUMBER_YN110 .

DATA: LW_YN110 LIKE YN110,
LW_DTLDOC LIKE YN110-DTLDOC.

SORT TBL_YN110 BY BUKRS GJAHR.
* [売上照合]が選択された場合
IF P_SALES = 'X'.
LOOP AT TBL_YN110.
IF TBL_YN110-GJAHR <> LW_YN110-GJAHR
OR TBL_YN110-BUKRS <> LW_YN110-BUKRS.
LW_YN110-GJAHR = TBL_YN110-GJAHR.
LW_YN110-BUKRS = TBL_YN110-BUKRS.
LW_DTLDOC = 1.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = '10'
OBJECT                  = 'YNOUTDOC1'
QUANTITY                = '1'
SUBOBJECT               = TBL_YN110-BUKRS
TOYEAR                  = TBL_YN110-GJAHR
IMPORTING
NUMBER                  = LW_YN110-SLPDOC
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 5
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
OTHERS                  = 7.
IF SY-SUBRC <> 0.
*       外部番号得エラー
MESSAGE I754 WITH TEXT-M07.
STOP.
ENDIF.
ENDIF.
TBL_YN110-SLPDOC = LW_YN110-SLPDOC.
TBL_YN110-DTLDOC = LW_DTLDOC.
LW_DTLDOC = LW_DTLDOC + 1.
MODIFY  TBL_YN110.
ENDLOOP.
ENDIF.
* [仕入照合]が選択された場合
IF P_PRCHS = 'X'.
LOOP AT TBL_YN110.
IF TBL_YN110-GJAHR <> LW_YN110-GJAHR
OR TBL_YN110-BUKRS <> LW_YN110-BUKRS.
LW_YN110-GJAHR = TBL_YN110-GJAHR.
LW_YN110-BUKRS = TBL_YN110-BUKRS.
LW_DTLDOC = 1.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = '10'
OBJECT                  = 'YNOUTDOC2'
QUANTITY                = '1'
SUBOBJECT               = TBL_YN110-BUKRS
TOYEAR                  = TBL_YN110-GJAHR
IMPORTING
NUMBER                  = LW_YN110-SLPDOC
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 5
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
OTHERS                  = 7.
IF SY-SUBRC <> 0.
*       外部番号得エラー
MESSAGE I754 WITH TEXT-M07.
STOP.
ENDIF.
ENDIF.
TBL_YN110-SLPDOC = LW_YN110-SLPDOC.
TBL_YN110-DTLDOC = LW_DTLDOC.
LW_DTLDOC = LW_DTLDOC + 1.
MODIFY  TBL_YN110.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_NUMBER_YN110

*&---------------------------------------------------------------------*
*&      Form  GET_NUMBER_YN210
*&---------------------------------------------------------------------*
*       外部番号の取得
*----------------------------------------------------------------------*
FORM GET_NUMBER_YN210 .

DATA: LW_YN210 LIKE YN210,
LW_DTLDOC LIKE YN210-DTLDOC.

SORT TBL_YN210 BY BUKRS GJAHR.
* [売上照合]が選択された場合
IF P_SALES = 'X'.
LOOP AT TBL_YN210.
IF TBL_YN210-GJAHR <> LW_YN210-GJAHR
OR TBL_YN210-BUKRS <> LW_YN210-BUKRS.
LW_YN210-GJAHR = TBL_YN210-GJAHR.
LW_YN210-BUKRS = TBL_YN210-BUKRS.
LW_DTLDOC = 1.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = '10'
OBJECT                  = 'YNOUTDOC1'
QUANTITY                = '1'
SUBOBJECT               = TBL_YN210-BUKRS
TOYEAR                  = TBL_YN210-GJAHR
IMPORTING
NUMBER                  = LW_YN210-SLPDOC
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 5
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
OTHERS                  = 7.
IF SY-SUBRC <> 0.
*       外部番号得エラー
MESSAGE I754 WITH TEXT-M07.
STOP.
ENDIF.
ENDIF.
TBL_YN210-SLPDOC = LW_YN210-SLPDOC.
TBL_YN210-DTLDOC = LW_DTLDOC.
LW_DTLDOC = LW_DTLDOC + 1.
MODIFY TBL_YN210.
ENDLOOP.
ENDIF.
* [仕入照合]が選択された場合
IF P_PRCHS = 'X'.
LOOP AT TBL_YN210.
IF TBL_YN210-GJAHR <> LW_YN210-GJAHR
OR TBL_YN210-BUKRS <> LW_YN210-BUKRS.
LW_YN210-GJAHR = TBL_YN210-GJAHR.
LW_YN210-BUKRS = TBL_YN210-BUKRS.
LW_DTLDOC = 1.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = '10'
OBJECT                  = 'YNOUTDOC2'
QUANTITY                = '1'
SUBOBJECT               = TBL_YN210-BUKRS
TOYEAR                  = TBL_YN210-GJAHR
IMPORTING
NUMBER                  = LW_YN210-SLPDOC
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 5
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
OTHERS                  = 7.
IF SY-SUBRC <> 0.
*       外部番号得エラー
MESSAGE I754 WITH TEXT-M07.
STOP.
ENDIF.
ENDIF.
TBL_YN210-SLPDOC = LW_YN210-SLPDOC.
TBL_YN210-DTLDOC = LW_DTLDOC.
LW_DTLDOC = LW_DTLDOC + 1.
MODIFY TBL_YN210.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_NUMBER_YN210

*&---------------------------------------------------------------------*
*&      Form  INSERT_YN110
*&---------------------------------------------------------------------*
*      YN110テーブルの更新
*----------------------------------------------------------------------*
FORM INSERT_YN110 .

*-- 20090113 UPD STA INSERT処理を一括化
* 登録
INSERT YN110 FROM TABLE TBL_YN110 ACCEPTING DUPLICATE KEYS.

IF SY-SUBRC <> 0.
* YN110更新エラー
ROLLBACK WORK.
MESSAGE I758 WITH TEXT-M10.
STOP.
ELSE.
DESCRIBE TABLE TBL_YN110 LINES G_INSERT_COUNT.
ENDIF.
*-- 20090113 UPD END

ENDFORM.                    " INSERT_YN110
*&---------------------------------------------------------------------*
*&      Form  INSERT_YN210
*&---------------------------------------------------------------------*
*       YN210テーブルの更新
*----------------------------------------------------------------------*
FORM INSERT_YN210 .

*-- 20090113 UPD STA INSERT処理を一括化
* 登録
INSERT YN210 FROM TABLE TBL_YN210 ACCEPTING DUPLICATE KEYS.

IF SY-SUBRC <> 0.
* YN210更新エラー
ROLLBACK WORK.
MESSAGE I758 WITH TEXT-M11.
STOP.
ELSE.
DESCRIBE TABLE TBL_YN210 LINES G_INSERT_COUNT.
ENDIF.
*-- 20090113 UPD END

ENDFORM.                    " INSERT_YN210
*&---------------------------------------------------------------------*
*&      Form  CURRENCY_CONV_TO_INTERNAL
*&---------------------------------------------------------------------*
*       金額編集
*----------------------------------------------------------------------*
FORM CURRENCY_CONV_TO_INTERNAL USING P_CURRENCY
P_AMOUNT_EXTERNAL
P_KNTAXAMT
P_YNVRFCTON
				     P_YNBUKRS
P_ERR_FLG.

DATA: L_RETURN LIKE BAPIRETURN,               " MSG
L_WAERS LIKE TCURC-WAERS,               " 通貨コード
L_BAPICURR LIKE BAPICURR-BAPICURR,      " 消費税額
L_LINE TYPE STRING,
L_ERR_MSG(128) TYPE C.

L_WAERS = P_CURRENCY.
L_BAPICURR = P_AMOUNT_EXTERNAL.
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_INTERNAL'
EXPORTING
CURRENCY             = L_WAERS
AMOUNT_EXTERNAL      = L_BAPICURR
MAX_NUMBER_OF_DIGITS = '20'
IMPORTING
AMOUNT_INTERNAL      = P_KNTAXAMT
RETURN               = L_RETURN
EXCEPTIONS
OTHERS                 = 1.
IF NOT L_RETURN IS INITIAL.
CLEAR: L_ERR_MSG.
MESSAGE ID L_RETURN-CODE+0(2) TYPE L_RETURN-TYPE
NUMBER L_RETURN-CODE+2(3) INTO L_ERR_MSG
WITH L_RETURN-MESSAGE_V1 L_RETURN-MESSAGE_V2
L_RETURN-MESSAGE_V3 L_RETURN-MESSAGE_V4.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
P_YNVRFCTON
P_YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
P_ERR_FLG = 'X'.
ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CHECK_YNYN110
*&---------------------------------------------------------------------*
*       存在チェック
*----------------------------------------------------------------------*
FORM CHECK_YNYN110  USING    LW_YNYN110 LIKE YNYN110
L_RC.

DATA:  L_ERR_FLG TYPE C,
L_LINE TYPE STRING,
L_ERR_MSG(128) TYPE C.

SELECT COUNT( * )
FROM YN110
WHERE BUKRS = LW_YNYN110-YNBUKRS
AND GJAHR = LW_YNYN110-YNGJAHR
AND SLPDOC = LW_YNYN110-YNSLPDOC
AND DTLDOC = LW_YNYN110-YNDTLDOC.
IF SY-SUBRC <> 0.
L_RC = 'X'.
* 対象データはありません
CLEAR: L_ERR_MSG.
MESSAGE I762 INTO L_ERR_MSG.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_YNYN110
*&---------------------------------------------------------------------*
*&      Form  CHECK_YNYN210
*&---------------------------------------------------------------------*
*       存在チェック
*----------------------------------------------------------------------*
FORM CHECK_YNYN210  USING    LW_YNYN210 LIKE YNYN210
L_RC.
DATA:  L_ERR_FLG TYPE C,
L_LINE TYPE STRING,
L_ERR_MSG(128) TYPE C.

SELECT COUNT( * )
FROM YN210
WHERE BUKRS = LW_YNYN210-YNBUKRS
AND GJAHR = LW_YNYN210-YNGJAHR
AND SLPDOC = LW_YNYN210-YNSLPDOC
AND DTLDOC = LW_YNYN210-YNDTLDOC.
IF SY-SUBRC <> 0.
L_RC = 'X'.
* 対象データはありません
CLEAR: L_ERR_MSG.
MESSAGE I762 INTO L_ERR_MSG.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN210-YNVRFCTON
LW_YNYN210-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_YNYN210

*&---------------------------------------------------------------------*
*&      STRUCTURE_COMM
*&---------------------------------------------------------------------*
*       共通機能
*----------------------------------------------------------------------*
FORM STRUCTURE_COMM  TABLES   PTBL_STRUCTURE USING P_TBNAME.

FIELD-SYMBOLS <FS_YNBUKRS>.
FIELD-SYMBOLS <FS_YNVRFCTON>.
FIELD-SYMBOLS <FS_YNPRCTR>.

*-- 20090113 UPD STA
*-- マスタ存在チェックと権限チェックを最小限の回数で行う為、処理を分割
LOOP AT PTBL_STRUCTURE.
*elematec 対応 INSERT DELETE START 2011/12/08
*        ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
*                          PTBL_STRUCTURE TO <FS_YNBUKRS>.
*        ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
*                          PTBL_STRUCTURE TO <FS_YNVRFCTON>.
*        ASSIGN COMPONENT 'YNPRCTR' OF STRUCTURE
*                          PTBL_STRUCTURE TO <FS_YNPRCTR>.
*elematec 対応 INSERT DELETE END 2011/12/08
*elematec 対応 INSERT DELETE START 2011/12/08
*        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*"取引先コードの変換
*          EXPORTING
*            INPUT = <FS_YNVRFCTON>
*          IMPORTING
*            OUTPUT = <FS_YNVRFCTON>
*          EXCEPTIONS
*            OTHERS = 0.
*        IF <FS_YNPRCTR> <> ''.
*          CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*"利益センタコード
*            EXPORTING
*              INPUT = <FS_YNPRCTR>
*            IMPORTING
*              OUTPUT = <FS_YNPRCTR>
*            EXCEPTIONS
*              OTHERS = 0.
*           CLEAR : W_PRCTR.
*           W_PRCTR-PRCTR = <FS_YNPRCTR>.
*           W_PRCTR-BUKRS = <FS_YNBUKRS>.
*           INSERT W_PRCTR INTO TABLE TBL_PRCTR.
*        ENDIF.
*        MODIFY PTBL_STRUCTURE.
*
*        CLEAR : W_BUKRS ,W_VRFCTON.
*        W_BUKRS-BUKRS = <FS_YNBUKRS>.
*        W_VRFCTON-BUKRS = <FS_YNBUKRS>.
*        W_VRFCTON-VRFCTON = <FS_YNVRFCTON>.
*        INSERT W_BUKRS INTO TABLE TBL_BUKRS.
*        INSERT W_VRFCTON INTO TABLE TBL_VRFCTON.
*elematec 対応 INSERT DELETE END 2011/12/08

ENDLOOP.

*-- 利益センタと会社コードと取引先コードの重複を削除
DELETE ADJACENT DUPLICATES FROM TBL_PRCTR COMPARING PRCTR BUKRS.
DELETE ADJACENT DUPLICATES FROM TBL_BUKRS COMPARING BUKRS.
DELETE ADJACENT DUPLICATES FROM TBL_VRFCTON COMPARING VRFCTON BUKRS.
*elematec 対応 INSERT START 2011/12/08
DELETE ADJACENT DUPLICATES FROM TBL_YN00007 COMPARING YN00007.
*elematec 対応 INSERT END   2011/12/08

*-- 存在チェック等に使用するマスタデータの一括取得
PERFORM GET_CHECK_DATA.
*-- 会社コードの存在チェックと権限チェック
LOOP AT TBL_BUKRS INTO W_BUKRS.
IF W_BUKRS-BUKRS <> 'ERR'.
*         存在チェック
PERFORM CHECK_BUKRS USING W_BUKRS-BUKRS.
*         権限チェック
PERFORM AUTHOR_CHECK USING W_BUKRS-BUKRS.
ENDIF.
ENDLOOP.
IF P_TEST <> 'X'.
* テーブルのロック
*-- 20090113 UPD STA
*-- データ全件ではなく、取引先コード重複削除後をループ
LOOP AT TBL_VRFCTON INTO W_VRFCTON.
*-- 20090113 UPD END
IF W_VRFCTON-BUKRS <> 'ERR'.
PERFORM LOCK_TABLE USING W_VRFCTON-VRFCTON
W_VRFCTON-BUKRS.
ENDIF.
ENDLOOP.
ENDIF.

* 取引先別のEXIT番号の取得
LOOP AT PTBL_STRUCTURE.
ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
PTBL_STRUCTURE TO <FS_YNBUKRS>.
ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
PTBL_STRUCTURE TO <FS_YNVRFCTON>.
IF <FS_YNBUKRS> <> 'ERR'.
PERFORM GET_EXIT USING <FS_YNVRFCTON>
<FS_YNBUKRS>
SY-TABIX.
ENDIF.
ENDLOOP.
*-- 20090113 UPD END

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  UPDATE_YN110
*&---------------------------------------------------------------------*
*       YN110変更
*----------------------------------------------------------------------*
FORM UPDATE_YN110 .

LOOP AT TBL_YN110.
UPDATE YN110 FROM TBL_YN110.
IF SY-SUBRC <> 0.
*更新エラー
ROLLBACK WORK.
MESSAGE I758 WITH TEXT-M10.
STOP.
ELSE.
G_UPDATE_COUNT = G_UPDATE_COUNT + 1.
ENDIF.
ENDLOOP.

ENDFORM.                    " UPDATE_YN110
*&---------------------------------------------------------------------*
*&      Form  DELETE_YN110
*&---------------------------------------------------------------------*
*       YN110削除
*----------------------------------------------------------------------*
FORM DELETE_YN110 .
*elematec 対応 INSERT START 2011/12/08
DATA :
L_UPDDAT TYPE YN110-UPDDAT,
L_UPDTIM TYPE YN110-UPDTIM,
L_UPDUSR TYPE YN110-UPDUSR,
L_UPDPRG TYPE YN110-UPDPRG.
*
L_UPDDAT = SY-DATUM.
L_UPDTIM = SY-UZEIT.
L_UPDUSR = SY-UNAME.
L_UPDPRG = 'YN010100'.
*elematec 対応 INSERT END   2011/12/08
LOOP AT TBL_YN110.

UPDATE YN110
SET DELFLG = 'X'
*elematec 対応 INSERT START 2011/12/08
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
*elematec 対応 INSERT END   2011/12/08
WHERE BUKRS = TBL_YN110-BUKRS
AND GJAHR = TBL_YN110-GJAHR
AND SLPDOC = TBL_YN110-SLPDOC
AND DTLDOC = TBL_YN110-DTLDOC.
IF SY-SUBRC <> 0.
*更新エラー
ROLLBACK WORK.
MESSAGE I758 WITH TEXT-M10.
STOP.
ELSE.
G_DELETE_COUNT = G_DELETE_COUNT + 1.
ENDIF.
ENDLOOP.

ENDFORM.                    " DELETE_YN110
*&---------------------------------------------------------------------*
*&      Form  UPDATE_YN210
*&---------------------------------------------------------------------*
*       YN210変更
*----------------------------------------------------------------------*
FORM UPDATE_YN210 .

LOOP AT TBL_YN210.
UPDATE YN210 FROM TBL_YN210.
IF SY-SUBRC <> 0.
*更新エラー
ROLLBACK WORK.
MESSAGE I758 WITH TEXT-M11.
STOP.
ELSE.
G_UPDATE_COUNT = G_UPDATE_COUNT + 1.
ENDIF.
ENDLOOP.

ENDFORM.                    " UPDATE_YN210
*&---------------------------------------------------------------------*
*&      Form  DELETE_YN210
*&---------------------------------------------------------------------*
*       YN210削除
*----------------------------------------------------------------------*
FORM DELETE_YN210 .
*elematec 対応 INSERT START 2011/12/08
DATA :
L_UPDDAT TYPE YN210-UPDDAT,
L_UPDTIM TYPE YN210-UPDTIM,
L_UPDUSR TYPE YN210-UPDUSR,
L_UPDPRG TYPE YN210-UPDPRG.
*
L_UPDDAT = SY-DATUM.
L_UPDTIM = SY-UZEIT.
L_UPDUSR = SY-UNAME.
L_UPDPRG = 'YN010100'.
*elematec 対応 INSERT END   2011/12/08
LOOP AT TBL_YN210.

UPDATE YN210
SET DELFLG = 'X'
*elematec 対応 INSERT START 2011/12/08
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
*elematec 対応 INSERT END   2011/12/08
WHERE BUKRS = TBL_YN210-BUKRS
AND GJAHR = TBL_YN210-GJAHR
AND SLPDOC = TBL_YN210-SLPDOC
AND DTLDOC = TBL_YN210-DTLDOC.
IF SY-SUBRC <> 0.
*更新エラー
ROLLBACK WORK.
MESSAGE I758 WITH TEXT-M11.
STOP.
ELSE.
G_DELETE_COUNT = G_DELETE_COUNT + 1.
ENDIF.
ENDLOOP.

ENDFORM.                    " DELETE_YN210
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_COMM
*&---------------------------------------------------------------------*
*       テーブルのロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_COMM  TABLES   PTBL_STRUCTURE.

IF P_TEST <> 'X'.
* テーブルのアンロック
*-- 20090113 UPD STA
*-- データ全件ではなく、取引先コード重複削除後をループ
LOOP AT TBL_VRFCTON INTO W_VRFCTON.
PERFORM UNLOCK_TABLE USING W_VRFCTON-VRFCTON
W_VRFCTON-BUKRS.
ENDLOOP.
*-- 20090113 UPD END
ENDIF.
ENDFORM.                    " UNLOCK_COMM

*&---------------------------------------------------------------------*
*&      Form  CHECK_NUMBER
*&---------------------------------------------------------------------*
*       数値妥当性チェック
*----------------------------------------------------------------------*
*      -->P_VAL   値
*      <--P_RC    リターンコード
*----------------------------------------------------------------------*
FORM CHECK_NUMBER  USING    P_VAL
P_RC.

DATA: L_VAL(10) TYPE P DECIMALS 5.

CATCH SYSTEM-EXCEPTIONS CONVT_NO_NUMBER = 1.
L_VAL = P_VAL.
ENDCATCH.
IF SY-SUBRC <> 0.
P_RC = 'X'.
ENDIF.

ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  CHECK_DATE
*&---------------------------------------------------------------------*
*       日付妥当性チェック
*----------------------------------------------------------------------*
*      -->P_DAT  日付
*----------------------------------------------------------------------*
FORM CHECK_DATE  USING    P_DAT
P_RC.

CALL FUNCTION 'CONVERT_DATE_TO_INTERNAL'
EXPORTING
DATE_EXTERNAL                  = P_DAT
EXCEPTIONS
DATE_EXTERNAL_IS_INVALID       = 1
OTHERS                         = 2
.
IF SY-SUBRC <> 0.
P_RC = 'X'.
ENDIF.

ENDFORM.                    " CHECK_DATE

*&---------------------------------------------------------------------*
*&      Form  CHECK_ATTRIBUTE_YNEIAJ1101
*&---------------------------------------------------------------------*
*       属性チェック
*----------------------------------------------------------------------*
FORM CHECK_ATTRIBUTE_YNEIAJ1101  USING   LW_YNEIAJ1101 LIKE YNEIAJ1101
L_RC TYPE C.
*削除開始　2011/1/23
*  DATA: L_LINE_LEN TYPE I,
*        L_ERR_MSG(128) TYPE C,
*        L_LINE TYPE STRING.
*
** 日付
*  CLEAR: L_RC.
*  PERFORM CHECK_DATE  USING  LW_YNEIAJ1101-YN00051
*                             L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M21.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNEIAJ1101-YNVRFCTON
*                             LW_YNEIAJ1101-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*
** 数量
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1101-YN00050
*                               L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M15.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNEIAJ1101-YNVRFCTON
*                             LW_YNEIAJ1101-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*
** 単価
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1101-YN00285
*                               L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M16.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNEIAJ1101-YNVRFCTON
*                             LW_YNEIAJ1101-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*
** 消費税額
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1101-YN00287
*                               L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M17.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNEIAJ1101-YNVRFCTON
*                             LW_YNEIAJ1101-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*
** 税込金額
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1101-YN00288
*                               L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M18.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNEIAJ1101-YNVRFCTON
*                             LW_YNEIAJ1101-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*削除終了 2011/1/23
ENDFORM.                    " CHECK_ATTRIBUTE_YNEIAJ1101

*&---------------------------------------------------------------------*
*&      Form  CHECK_ATTRIBUTE_YNEIAJ1102
*&---------------------------------------------------------------------*
*       属性チェック
*----------------------------------------------------------------------*
FORM CHECK_ATTRIBUTE_YNEIAJ1102  USING   LW_YNEIAJ1102 LIKE YNEIAJ1102
L_RC TYPE C.
DATA: L_LINE_LEN TYPE I,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING.

DATA:L_DATA TYPE SY-DATUM.
DATA:L_DD(2) TYPE N.
DATA:L_ZFBDT TYPE YK210-ZFBDT.
DATA LW_TYPE TYPE DATATYPE_D.

* 日付
*売掛日
CLEAR: L_RC.
PERFORM CHECK_DATE  USING  LW_YNEIAJ1102-YN00141
L_RC.
*
IF L_RC = 'X'.
*elematec 対応 INSERT START 2011/12/08
*売掛日のエラー対応
L_DD = SY-DATUM+6(2).
IF L_DD < '20'.
L_DATA = SY-DATUM.
L_DATA+6(02) = '01'.
L_DATA = L_DATA - 1.
LW_YNEIAJ1102-YN00141 = L_DATA+2(6).
ELSE.
*
CALL FUNCTION 'LAST_DAY_OF_MONTHS'
EXPORTING
DAY_IN                 = SY-DATUM
IMPORTING
LAST_DAY_OF_MONTH       = L_DATA
EXCEPTIONS
DAY_IN_NO_DATE          = 1
OTHERS                  = 2.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ELSE.
LW_YNEIAJ1102-YN00141 = L_DATA+2(6).
ENDIF.
ENDIF.
ENDIF.
*elematec 対応 INSERT END   2011/12/08
*elematec 対応 DELETE START 2011/12/08
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M21.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNEIAJ1102-YNVRFCTON
*                             LW_YNEIAJ1102-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*   ENDIF.
*elematec 対応 DELETE END   2011/12/08

* 数量
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1102-YN00137
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M15.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 単価
CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1102-YN00297
*                               L_RC.
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN = LW_YNEIAJ1102-YN00297
IMPORTING
HTYPE     = LW_TYPE.
IF LW_TYPE <> 'NUMC'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M16.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 消費税額
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1102-YN00287
*                               L_RC.
*  IF L_RC = 'X'.
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN = LW_YNEIAJ1102-YN00287
IMPORTING
HTYPE     = LW_TYPE.
IF LW_TYPE <> 'NUMC'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M17.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 税込金額
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNEIAJ1102-YN00288
*                               L_RC.
*  IF L_RC = 'X'.
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN = LW_YNEIAJ1102-YN00288
IMPORTING
HTYPE     = LW_TYPE.
IF LW_TYPE <> 'NUMC'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M18.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_ATTRIBUTE_YNEIAJ1102

*&---------------------------------------------------------------------*
*&      Form  CHECK_ATTRIBUTE_YNYN110
*&---------------------------------------------------------------------*
*       属性チェック
*----------------------------------------------------------------------*
FORM CHECK_ATTRIBUTE_YNYN110  USING   LW_YNYN110 LIKE YNYN110
L_RC TYPE C.
DATA: L_LINE_LEN TYPE I,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING.

* 会計年度
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN110-YNGJAHR
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M20.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 日付
CLEAR: L_RC.
PERFORM CHECK_DATE  USING  LW_YNYN110-YNZFBDT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M21.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 数量
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN110-YNKNQUAN
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M15.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 単価
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN110-YNKNUNTPRC
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M16.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 消費税額
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN110-YNKNTAXAMT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M17.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 税抜金額
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN110-YNKNITXAMT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M19.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 税込金額
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN110-YNKNETXAMT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M18.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
LW_YNYN110-YNVRFCTON
LW_YNYN110-YNBUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_ATTRIBUTE_YNYN110

*&---------------------------------------------------------------------*
*&      Form  CHECK_ATTRIBUTE_YNYN210
*&---------------------------------------------------------------------*
*       属性チェック
*----------------------------------------------------------------------*
FORM CHECK_ATTRIBUTE_YNYN210  USING   LW_YNYN210 LIKE YNYN210
L_RC TYPE C.
DATA: L_LINE_LEN TYPE I,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING.
*elematec 対応 DELETE START 2011/12/08

* 会計年度
*  CLEAR: L_RC.
*  PERFORM CHECK_NUMBER  USING  LW_YNYN210-YNGJAHR
*                               L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M20.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNYN210-YNVRFCTON
*                             LW_YNYN210-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*
** 日付
*  CLEAR: L_RC.
*  PERFORM CHECK_DATE  USING  LW_YNYN210-YNZFBDT
*                             L_RC.
*  IF L_RC = 'X'.
*    CLEAR: L_ERR_MSG.
*    MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M21.
*    PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
*                             LW_YNYN210-YNVRFCTON
*                             LW_YNYN210-YNBUKRS
*                             L_ERR_MSG.
*    READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
*    PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
*    G_ERR_COUNT = G_ERR_COUNT  + 1.
*    EXIT.
*  ENDIF.
*elematec 対応 DELETE END   2011/12/08
*elematec 対応 INSERT START 2011/12/08
*請求日
CLEAR: L_RC.
PERFORM CHECK_DATE  USING  LW_YNYN210-YNLDATE1
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M27.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.
*elematec 対応 INSERT END   2011/12/08

* 数量
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN210-YNKNQUAN
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M15.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 単価
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN210-YNKNUNTPRC
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M16.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 消費税額
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN210-YNKNTAXAMT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M17.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 税抜金額
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN210-YNKNITXAMT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M19.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.

* 税込金額
CLEAR: L_RC.
PERFORM CHECK_NUMBER  USING  LW_YNYN210-YNKNETXAMT
L_RC.
IF L_RC = 'X'.
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH TEXT-M18.
PERFORM SET_ERRLOG USING TBL_EXIT-INDEX
TBL_EXIT-LIFN2
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX TBL_EXIT-INDEX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
EXIT.
ENDIF.
*
ENDFORM.                    " CHECK_ATTRIBUTE_YNYN210
*&---------------------------------------------------------------------*
*&      Form  GET_CHECK_DATA
*&---------------------------------------------------------------------*
*       存在チェック等に使用するマスタデータの一括取得
*----------------------------------------------------------------------*

FORM GET_CHECK_DATA .
*elematec 対応 DELETE START 2011/12/08
*-- 会社コードマスタの一括取得
*  SELECT BUKRS INTO TABLE TBL_T001
*    FROM T001
*    FOR ALL ENTRIES IN TBL_BUKRS
*      WHERE BUKRS = TBL_BUKRS-BUKRS.
*
**-- 通貨コードの一括取得
*  SELECT WAERS INTO TABLE TBL_TCURC FROM TCURC.
*elematec 対応 DELETE END   2011/12/08

*-- 利益センタマスタの一括取得
*elematec 対応 UPDATE START 2011/12/08
* conversion 対応 2010/12/13 UPD >>>
*  IF TBL_PRCTR[] IS NOT INITIAL.
*  IF NOT TBL_PRCTR[] IS INITIAL.
** conversion 対応 2010/12/13 UPD <<<
*    SELECT CEPC~PRCTR TKA02~BUKRS
*      INTO TABLE TBL_CEPC
*      FROM CEPC
*      INNER JOIN TKA02
*      ON TKA02~KOKRS = CEPC~KOKRS
*      FOR ALL ENTRIES IN TBL_PRCTR
*        WHERE CEPC~PRCTR  = TBL_PRCTR-PRCTR
*          AND TKA02~BUKRS = TBL_PRCTR-BUKRS.
*  ENDIF.
SELECT CEPC~PRCTR TKA02~BUKRS
INTO TABLE TBL_CEPC
FROM CEPC
INNER JOIN TKA02
ON TKA02~KOKRS = CEPC~KOKRS
WHERE TKA02~BUKRS = P_BUKRS.
*elematec 対応 UPDATE END   2011/12/08
* [売上照合]が選択された場合
IF P_SALES = 'X'.
*elematec 対応 UPDATE START 2011/12/08
**-- 取引先マスタ（KNB1）の一括取得
*    SELECT KUNNR BUKRS ZTERM INTO TABLE TBL_XXB1
*      FROM KNB1
*      FOR ALL ENTRIES IN TBL_VRFCTON
*        WHERE KUNNR = TBL_VRFCTON-VRFCTON
*          AND BUKRS = TBL_VRFCTON-BUKRS.
**-- 照合マスタ（YN130）の一括取得
*      SELECT VRFCTON BUKRS OUTEXITDOC
*        INTO TABLE TBL_YNX30
*        FROM YN130
*        FOR ALL ENTRIES IN TBL_VRFCTON
*          WHERE VRFCTON = TBL_VRFCTON-VRFCTON
*            AND BUKRS   = TBL_VRFCTON-BUKRS
*             OR VRFCTON = 'DEFAULT'.

PERFORM GET_KNVV_KNVI. "得意先マスタ（KNVV・KNVI）を一括取得する
PERFORM GET_KNVP_KNVV. "得意先マスタ（KNVP・KNVV）を一括取得する
PERFORM GET_YN130.     "売上照合マスタ（YN130）を取得する。
PERFORM GET_ZN004.     "照合期間（売上）マスタ（ZN004）を取得する。
*elematec 対応 UPDATE END   2011/12/08
ENDIF.

* [仕入照合]が選択された場合
IF P_PRCHS = 'X'.
*elematec 対応 UPDATE START 2011/12/08
**-- 取引先マスタ（LFB1）の一括取得
*    SELECT LIFNR BUKRS ZTERM INTO TABLE TBL_XXB1
*      FROM LFB1
*      FOR ALL ENTRIES IN TBL_VRFCTON
*        WHERE LIFNR = TBL_VRFCTON-VRFCTON
*          AND BUKRS = TBL_VRFCTON-BUKRS.
*
**-- 照合マスタ（YN230）の一括取得
*      SELECT VRFCTON BUKRS OUTEXITDOC
*        INTO TABLE TBL_YNX30
*        FROM YN230
*        FOR ALL ENTRIES IN TBL_VRFCTON
*          WHERE VRFCTON = TBL_VRFCTON-VRFCTON
*            AND BUKRS   = TBL_VRFCTON-BUKRS
*             OR VRFCTON = 'DEFAULT'.
PERFORM GET_LFM1_WYT3. "仕入先マスタ（LFM1・WYT3）を一括取得する
PERFORM GET_YN230.     "仕入照合マスタ（YN230）を一括取得する。
PERFORM GET_ZN001.     "照合期間（仕入）(ZN001)の一括取得
*
*    PERFORM GET_LFB1_LFM1. "仕入先マスタ（LFM1・WYT3）を一括取得する
**取引先機能
*    PERFORM GET_WYT3.
*elematec 対応 UPDATE END   2011/12/08
ENDIF.

ENDFORM.                    " GET_CHECK_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_WERKS
*&---------------------------------------------------------------------*
*       プラントの取得
*----------------------------------------------------------------------*
FORM GET_WERKS.

*
ENDFORM.                    " GET_WERKS
*&---------------------------------------------------------------------*
*&      Form  GET_YN230
*&---------------------------------------------------------------------*
*       仕入照合マスタ
*----------------------------------------------------------------------*
FORM GET_YN230.
*
SELECT VRFCTON BUKRS OUTEXITDOC
INTO TABLE TBL_YNX30
FROM YN230
WHERE BUKRS   = P_BUKRS.
*
ENDFORM.                    " GET_YN230
*&---------------------------------------------------------------------*
*&      Form  GET_ZN001
*&---------------------------------------------------------------------*
*       照合期間（仕入）
*----------------------------------------------------------------------*
FORM GET_ZN001.
*
SELECT LIFNR	"仕入先コード
EDATE	"照合終了日
INTO TABLE TBL_ZN001
FROM ZN001
WHERE BUKRS = P_BUKRS.
*
ENDFORM.                    " GET_ZN001
**&---------------------------------------------------------------------
**
**&      Form  STRUCTURE_YNEIAJ1102
**&---------------------------------------------------------------------
**
**       YNEIAJ1102
**----------------------------------------------------------------------
**
*FORM STRUCTURE_YNEIAJ1102 TABLES PTBL_STRUCTURE.
*DATA L_OUTEXITDOC TYPE YN130-OUTEXITDOC.
*DATA L_WERKS      TYPE MARC-WERKS.
*DATA L_TABIX TYPE SY-TABIX.
*DATA: L_USER LIKE SY-MSGV1.
*
**
*  FIELD-SYMBOLS <FS_YN00004>.  "発注者コード
*  FIELD-SYMBOLS <FS_YN00005>.  "受注者コード
*  FIELD-SYMBOLS <FS_YN00006>.  "発注部門コード
*  FIELD-SYMBOLS <FS_YN00007>.  "注文番号
**
*  LOOP AT PTBL_STRUCTURE.
*         CLEAR:GW_LIFNR,GW_LIFN2,
*               GW_EKGRP,L_WERKS,L_OUTEXITDOC.
*
*        L_TABIX = SY-TABIX.
*
*        ASSIGN COMPONENT 'YN00004' OF STRUCTURE   "発注者コード
*                          PTBL_STRUCTURE TO <FS_YN00004>.
*        ASSIGN COMPONENT 'YN00005' OF STRUCTURE   "受注者コード
*                          PTBL_STRUCTURE TO <FS_YN00005>.
*        ASSIGN COMPONENT 'YN00006' OF STRUCTURE   "発注部門コード
*                          PTBL_STRUCTURE TO <FS_YN00006>.
*        ASSIGN COMPONENT 'YN00007' OF STRUCTURE   "注文番号
*                          PTBL_STRUCTURE TO <FS_YN00007>.
**--発注先
*        PERFORM GET_EKKO USING <FS_YN00007>+2(10) L_TABIX
*                         CHANGING GW_LIFNR GW_EKGRP GW_WAERS.
**--請求先
*        PERFORM GET_EKPA USING <FS_YN00007>+2(10) L_TABIX
*                                                  CHANGING GW_LIFN2.
**取引先別のEXIT番号の取得
*        PERFORM GET_OUTEXITDOC USING L_OUTEXITDOC L_TABIX.
**プラントの取得
*        CASE L_OUTEXITDOC.
*          WHEN '2001'.
*            CONCATENATE 'P' <FS_YN00007>+0(2) '0' INTO L_WERKS.
*            PERFORM GET_T001K USING L_WERKS.
*            IF SY-SUBRC <> 0.
*              PERFORM GET_EDMMS USING <FS_YN00005>
*                                      <FS_YN00004>
*                                      <FS_YN00006>
*                                      CHANGING L_WERKS.
*              IF L_WERKS IS INITIAL.
*                 PERFORM GET_EKPO USING <FS_YN00007>+2(10)
*                                   CHANGING L_WERKS GW_MWSKZ.
*                 IF L_WERKS IS INITIAL.
**LINE No &1 : プラントが決定できませんでした &
*                   PERFORM ERR_MESSAGE USING '803' L_TABIX
*                              <FS_YN00007>+2(10) '' '' .
*                 ENDIF.
*              ENDIF.
*            ENDIF.
*          WHEN '2002'.
**LINE No &1 : EXIT=2002による受信対象外データ &
*              PERFORM ERR_MESSAGE USING '804' L_TABIX
*                              <FS_YN00007>+2(10) '' '' .
*          WHEN '2003'.
**LINE No &1 : EXIT=2003による受信対象外データ &
*              PERFORM ERR_MESSAGE USING '805' L_TABIX
*                              <FS_YN00007>+2(10) '' '' .
*        ENDCASE.
**
*        TBL_EXIT-EXIT  = L_OUTEXITDOC.
*        TBL_EXIT-WERKS = L_WERKS.  "プラント
*        TBL_EXIT-LIFNR = GW_LIFNR. "発注先
*        TBL_EXIT-LIFN2 = GW_LIFN2. "請求先
*        TBL_EXIT-EKGRP = GW_EKGRP. "購買グループ
*        TBL_EXIT-INDEX =  L_TABIX.
*        APPEND TBL_EXIT.
**
*        LW_LOCK-BUKRS = P_BUKRS.
*        LW_LOCK-LIFNR = GW_LIFNR.
*        LW_LOCK-WERKS = L_WERKS.
*        COLLECT LW_LOCK INTO TAB_LOCK.
**
*  ENDLOOP.
*
*  IF P_TEST <> 'X'.
*
** テーブルのロック
*    PERFORM TABLE_LOCK_901.
*    L_USER = SY-MSGV1.
*    IF RC_CODE_LOCK <> 0.
**901(YN210)) ロックエラー & がロックしています
*      MESSAGE I756  WITH TEXT-M25 L_USER.
*      CLEAR:WK_MSGTEXT.
*      MESSAGE I756 WITH TEXT-M25 L_USER INTO WK_MSGTEXT.
*      SKIP.
*      SKIP.
*      ULINE.
*      WRITE:/004 W_FILENAME.
*      ULINE.
*      SKIP.
*      WRITE:/004 WK_MSGTEXT.
*      STOP.
*    ENDIF.
*  ENDIF.
*
*ENDFORM.                    " STRUCTURE_YNEIAJ1102
*&---------------------------------------------------------------------*
*&      Form  F_ALPHA_INPUT
*&---------------------------------------------------------------------*
*       ALPHA 変換 Exit: 外部->内部
*----------------------------------------------------------------------*
FORM F_ALPHA_INPUT CHANGING P_INOUT.
*
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT   = P_INOUT
IMPORTING
OUTPUT  = P_INOUT.
*
ENDFORM.                    " F_ALPHA_INPUT
**&---------------------------------------------------------------------
**
**&      Form  GET_EKPA
**&---------------------------------------------------------------------
**
**       購買管理における取引先機能
**----------------------------------------------------------------------
**
*FORM GET_EKPA USING P_EBELN P_TABIX
*              CHANGING P_LIFN2.
**
*  SELECT SINGLE LIFN2 INTO P_LIFN2
*        FROM EKPA
*        WHERE EBELN = P_EBELN
*        AND   EBELP = SPACE
*        AND   EKORG = P_EKORG
*        AND   LTSNR = SPACE
*        AND   WERKS = SPACE
*        AND   PARVW = P_PARVWL
*        AND   PARZA = SPACE.
**
* IF SY-SUBRC <> 0.
**LINE No &1 : 注文番号 &2 はありません
*    MESSAGE I802 WITH P_TABIX P_EBELN.
*      CLEAR:WK_MSGTEXT.
*      MESSAGE I802 WITH P_TABIX P_EBELN INTO WK_MSGTEXT.
*      SKIP.
*      SKIP.
*      ULINE.
*      WRITE:/004 W_FILENAME.
*      ULINE.
*      SKIP.
*      WRITE:/004 WK_MSGTEXT.
*    STOP.
* ENDIF.
**
*ENDFORM.                    " GET_EKPA
*&---------------------------------------------------------------------*
*&      Form  GET_OUTEXITDOC
*&---------------------------------------------------------------------*
*       EXIT番号
*----------------------------------------------------------------------*
FORM GET_OUTEXITDOC USING P_OUTEXITDOC P_TABIX.
DATA L_VRFCTON    TYPE YN230-VRFCTON.
*
IF P_PRCHS = 'X'.
READ TABLE TBL_YNX30 WITH TABLE KEY VRFCTON = GW_LIFN2 "請求先
BUKRS   = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
READ TABLE TBL_LFM1_WYT3 WITH TABLE KEY LIFNR = GW_LIFN2
INTO W_LFM1_WYT3.
IF SY-SUBRC <> 0.
*LINE No &1 : &2 取得エラー
PERFORM ERR_MESSAGE USING '806' P_TABIX 'LFM1' '' '' .
ELSE.
CONCATENATE 'D-' W_LFM1_WYT3-WAERS INTO L_VRFCTON.
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = L_VRFCTON
BUKRS  = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
*LINE No &1 : &2 取得エラー
PERFORM ERR_MESSAGE USING '806' P_TABIX 'YN230' '' '' .
ENDIF.
ENDIF.
ENDIF.
P_OUTEXITDOC = W_YNX30-OUTEXITDOC.
ENDIF.
ENDFORM.                    " GET_OUTEXITDOC
*&---------------------------------------------------------------------*
*&      Form  GET_T001K
*&---------------------------------------------------------------------*
*       評価レベル
*----------------------------------------------------------------------*
FORM GET_T001K USING P_BWKEY.
*
SELECT COUNT( * )
FROM T001K
WHERE BWKEY = P_BWKEY.
*
ENDFORM.                    " GET_T001K
*&---------------------------------------------------------------------*
*&      Form  GET_EDMMS
*&---------------------------------------------------------------------*
*       購買組織とプラントに対する EDI パートナ の割当
*----------------------------------------------------------------------*
FORM GET_EDMMS USING P_LIFNR P_KUNAG P_KUNWE
CHANGING P_WERKS.
*
SELECT SINGLE WERKS
INTO P_WERKS
FROM EDMMS
WHERE LIFNR = P_LIFNR
AND   KUNAG = P_KUNAG
AND   KUNWE = P_KUNWE.
IF SY-SUBRC <> 0.
CLEAR:P_WERKS.
ENDIF.
*
ENDFORM.                    " GET_EDMMS
*&---------------------------------------------------------------------*
*&      Form  GET_EKPO
*&---------------------------------------------------------------------*
*       購買伝票明細
*----------------------------------------------------------------------*
FORM GET_EKPO USING P_EBELN CHANGING P_WERKS P_MWSKZ.
*
REFRESH T_EKPO.
*
SELECT EBELN EBELP WERKS MWSKZ INTO TABLE T_EKPO
FROM EKPO
WHERE EBELN = P_EBELN
AND   LOEKZ = SPACE.
SORT T_EKPO BY EBELP.
READ TABLE T_EKPO INDEX 1 INTO W_EKPO.
IF SY-SUBRC <> 0.
CLEAR:P_WERKS,P_MWSKZ.
ELSE.
P_WERKS = W_EKPO-WERKS.
P_MWSKZ = W_EKPO-MWSKZ.
ENDIF.
*
ENDFORM.                    " GET_EKPO
*&---------------------------------------------------------------------*
*&      Form  ERR_MESSAGE
*&---------------------------------------------------------------------*
*       エラーメッセージ出力
*----------------------------------------------------------------------*
FORM ERR_MESSAGE USING P_MSGNO P_MSGV1 P_MSGV2 P_MSGV3 P_MSGV4.

MESSAGE ID 'YN01' TYPE 'I' NUMBER P_MSGNO
WITH P_MSGV1 P_MSGV2 P_MSGV3 P_MSGV4.
*
CLEAR:WK_MSGTEXT.
MESSAGE ID 'YN01' TYPE 'I' NUMBER P_MSGNO
WITH P_MSGV1 P_MSGV2 P_MSGV3 P_MSGV4 INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.

ENDFORM.                    "ERR_MESSAGE_754
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_PRCHS
*&---------------------------------------------------------------------*
*       テーブルのロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_PRCHS_SALES.
*
IF P_TEST <> 'X'.
IF P_SALES = 'X'.
PERFORM TABLE_UNLOCK_902.
ENDIF.
IF P_PRCHS = 'X'.
PERFORM TABLE_UNLOCK_901.
ENDIF.
ENDIF.
*
ENDFORM.                    " UNLOCK_PRCHS_SALES
*&---------------------------------------------------------------------*
*&      Form  GET_RSEG
*&---------------------------------------------------------------------*
*       伝票明細: 請求書受領
*----------------------------------------------------------------------*
FORM GET_RSEG USING P_BELNR.
*
REFRESH TBL_RSEG.
*
SELECT BELNR
GJAHR
BUZEI
EBELN
EBELP
WERKS
INTO TABLE TBL_RSEG
FROM RSEG
WHERE BELNR = P_BELNR
AND   BUKRS = P_BUKRS.
*
ENDFORM.                    " GET_RSEG
*&---------------------------------------------------------------------*
*&      Form  GET_T_CSV_DATA_YNEIAJ1102
*&---------------------------------------------------------------------*
*       YNEIAJ1102
*----------------------------------------------------------------------*
*FORM GET_T_CSV_DATA_YNEIAJ1102  TABLES   P_T_CSV_DATA
*                     USING    P_SEPARATOR
*                              P_FIXER
*                              P_FIX_FLG.
*
*  DATA: L_TABIX LIKE SY-TABIX,
*        L_INDEX LIKE SY-INDEX.
*  DATA: L_T_FIELD TYPE STANDARD TABLE OF STRING,
*        L_FIELD TYPE STRING,
*        L_FIELD_COUNT TYPE I.
*  DATA: L_LEN_FIXER TYPE I,
*        L_LEN_FIXER2 TYPE I.
*
*  DATA: L_LEN TYPE I,
*        L_FLEN TYPE I,
*        L_OFFLEN TYPE I,
*        L_CURRENT_LEN TYPE I,
*        L_LINE_LEN TYPE I,
*        L_ERR_MSG(128) TYPE C,
*        L_LINE TYPE STRING.
*
*  FIELD-SYMBOLS <FS_CSV_FIELD>.
*  FIELD-SYMBOLS <FS_YN00007>.
*
*  IF P_FIX_FLG <> 'X'.
*    L_LEN_FIXER = STRLEN( P_FIXER ).
*    L_LEN_FIXER2 = L_LEN_FIXER * 2.
*
*    REFRESH P_T_CSV_DATA.
*    LOOP AT TBL_CSV.
*      L_TABIX = SY-TABIX.
*      SPLIT TBL_CSV AT P_SEPARATOR INTO TABLE L_T_FIELD.
*      CLEAR: P_T_CSV_DATA, L_FIELD_COUNT.
*      DO.
*        L_INDEX = SY-INDEX.
*        ASSIGN COMPONENT L_INDEX OF STRUCTURE P_T_CSV_DATA
*          TO <FS_CSV_FIELD>.
*        CASE SY-SUBRC.
*          WHEN 0.
*            L_FIELD_COUNT = L_FIELD_COUNT + 1.
*            READ TABLE L_T_FIELD INTO L_FIELD INDEX L_INDEX.
*            IF SY-SUBRC = 0.
*              SHIFT L_FIELD RIGHT CIRCULAR BY L_LEN_FIXER PLACES.
*              L_LEN = STRLEN( L_FIELD ).
*              IF L_LEN < L_LEN_FIXER2 OR
*                L_FIELD(L_LEN_FIXER) <> P_FIXER OR
*                L_FIELD+L_LEN_FIXER(L_LEN_FIXER) <> P_FIXER.
**   [項目名]の桁数が正しくありません
*                CLEAR: L_ERR_MSG.
*                MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
*                ASSIGN COMPONENT 'YN00007' OF STRUCTURE
*                       P_T_CSV_DATA TO <FS_YN00007>.
*                PERFORM SET_ERRLOG USING L_TABIX
*                                         <FS_YN00007>+2(10)
*                                          P_BUKRS
*                                         L_ERR_MSG.
*                PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
*                G_ERR_COUNT = G_ERR_COUNT  + 1.
*                EXIT.
*              ENDIF.
*              SHIFT L_FIELD LEFT BY L_LEN_FIXER2 PLACES.
*              IF <FS_CSV_FIELD> CP '* #'.
*              ENDIF.
*              L_FLEN = SY-FDPOS.
*              L_LEN = STRLEN( L_FIELD ).
*              IF L_FLEN >= L_LEN .
*                CATCH SYSTEM-EXCEPTIONS  CONVT_NO_NUMBER = 1 .
*                  <FS_CSV_FIELD> = L_FIELD.
*                ENDCATCH.
*                IF SY-SUBRC = 1.
**   [項目名]の属性が正しくありません
*                  CLEAR: L_ERR_MSG.
*                  MESSAGE I778 INTO L_ERR_MSG WITH L_FIELD.
*                  ASSIGN COMPONENT 'YN00007' OF STRUCTURE
*                         P_T_CSV_DATA TO <FS_YN00007>.
*                  PERFORM SET_ERRLOG USING L_TABIX
*                                           <FS_YN00007>+2(10)
*                                           P_BUKRS
*                                           L_ERR_MSG.
*                  PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
*                  G_ERR_COUNT = G_ERR_COUNT  + 1.
** ERR LINE FLG
**                  <FS_YNBUKRS> = 'ERR'.
*                  EXIT.
*                ENDIF.
*              ELSE.
**   [項目名]の桁数が正しくありません
*                  CLEAR: L_ERR_MSG.
*                  MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
*                  ASSIGN COMPONENT 'YN00007' OF STRUCTURE
*                         P_T_CSV_DATA TO <FS_YN00007>.
*                  PERFORM SET_ERRLOG USING L_TABIX
*                                           <FS_YN00007>+2(10)
*                                          P_BUKRS
*                                           L_ERR_MSG.
*                  PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
*                  G_ERR_COUNT = G_ERR_COUNT  + 1.
*                  EXIT.
*              ENDIF.
*            ENDIF.
*          WHEN OTHERS.
*            EXIT.
*        ENDCASE.
*      ENDDO.
*      APPEND P_T_CSV_DATA.
*    ENDLOOP.
*  ELSE.
** 固定長
*    REFRESH P_T_CSV_DATA.
*    LOOP AT TBL_CSV.
*      L_OFFLEN = 0.
*      L_TABIX = SY-TABIX.
*      DO.
*        L_INDEX = SY-INDEX.
*        ASSIGN COMPONENT L_INDEX OF STRUCTURE P_T_CSV_DATA
*          TO <FS_CSV_FIELD>.
*        CASE SY-SUBRC.
*          WHEN 0.
*            L_FIELD_COUNT = L_FIELD_COUNT + 1.
*            IF <FS_CSV_FIELD> CP '* #'.
*            ENDIF.
*            L_FLEN = SY-FDPOS.
*            L_CURRENT_LEN =  L_OFFLEN + L_FLEN.
*            L_LINE_LEN = STRLEN( TBL_CSV ).
*            IF L_CURRENT_LEN > L_LINE_LEN.
**   [項目名]の桁数が正しくありません
*              CLEAR: L_ERR_MSG.
*              MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
*              ASSIGN COMPONENT 'YN00007' OF STRUCTURE
*                     P_T_CSV_DATA TO <FS_YN00007>.
*              PERFORM SET_ERRLOG USING L_TABIX
*                                       <FS_YN00007>+2(10)
*                                          P_BUKRS
*                                       L_ERR_MSG.
*              PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
*              G_ERR_COUNT = G_ERR_COUNT  + 1.
*              EXIT.
*            ENDIF.
*            L_FIELD = TBL_CSV+L_OFFLEN(L_FLEN).
*            L_OFFLEN = L_OFFLEN + L_FLEN.
*            CATCH SYSTEM-EXCEPTIONS  CONVT_NO_NUMBER = 1 .
*              <FS_CSV_FIELD> = L_FIELD.
*            ENDCATCH.
*            IF SY-SUBRC = 1.
**[項目名]の属性が正しくありません
*              CLEAR: L_ERR_MSG.
*              MESSAGE I778 INTO L_ERR_MSG WITH L_FIELD.
*              ASSIGN COMPONENT 'YN00007' OF STRUCTURE
*                     P_T_CSV_DATA TO <FS_YN00007>.
*              PERFORM SET_ERRLOG USING L_TABIX
*                                       <FS_YN00007>+2(10)
*                                          P_BUKRS
*                                       L_ERR_MSG.
*              PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
*              G_ERR_COUNT = G_ERR_COUNT  + 1.
*              EXIT.
*            ENDIF.
*          WHEN OTHERS.
*            EXIT.
*        ENDCASE.
*      ENDDO.
*      APPEND P_T_CSV_DATA.
*    ENDLOOP.
*  ENDIF.
*
*ENDFORM.                    " GET_T_CSV_DATA_YNEIAJ1102
*&---------------------------------------------------------------------*
*&      Form  GET_KNVV_KNVI
*&---------------------------------------------------------------------*
*       得意先マスタ（KNVV・KNVI）を一括取得する
*----------------------------------------------------------------------*
FORM   GET_KNVV_KNVI.
*
SELECT KNA1~KUNNR
KNA1~LAND1
KNVV~KALKS
KNVV~WAERS
KNVV~ZTERM
KNVV~VKGRP
KNVV~VKBUR
KNVI~TAXKD
INTO TABLE TBL_KNVV_KNVI
FROM KNA1
JOIN KNVV ON KNVV~KUNNR = KNA1~KUNNR
JOIN KNVI ON KNVI~KUNNR = KNA1~KUNNR
WHERE KNVV~VKORG = P_VKORG
AND   KNVV~VTWEG = P_VTWEG
AND   KNVV~SPART = P_SPART
AND   KNVI~ALAND = CNS_JP
AND   KNVI~TATYP = CNS_MWST.
*
ENDFORM.                    " GET_KNVV_KNVI
*&---------------------------------------------------------------------*
*&      Form  GET_KNVP_KNVV
*&---------------------------------------------------------------------*
*       得意先マスタ（KNVP・KNVV）を一括取得する
*----------------------------------------------------------------------*
FORM GET_KNVP_KNVV.

SELECT KNVP~KUNNR "得意先コード	
KNVP~KUNN2 "取引先の得意先コード	
KNVV~ZTERM "支払条件キー	
INTO TABLE TBL_KNVP_KNVV
FROM KNVP
JOIN KNVV ON KNVV~KUNNR = KNVP~KUNN2
WHERE KNVP~VKORG = P_VKORG
AND   KNVP~VTWEG = P_VTWEG
AND   KNVP~SPART = P_SPART
AND   KNVP~PARVW = P_PARVWK
AND   KNVP~PARZA = '000'.

ENDFORM.                    " GET_KNVP_KNVV
*&---------------------------------------------------------------------*
*&      Form  GET_YN130
*&---------------------------------------------------------------------*
*       売上照合マスタ（YN130）を取得する。
*----------------------------------------------------------------------*
FORM GET_YN130.
*
SELECT VRFCTON BUKRS OUTEXITDOC
INTO TABLE TBL_YNX30
FROM YN130
WHERE BUKRS = P_BUKRS.
*
ENDFORM.                    " GET_YN130
*&---------------------------------------------------------------------*
*&      Form  GET_ZN004
*&---------------------------------------------------------------------*
*       照合期間（売上）マスタ（ZN004）を取得する。
*----------------------------------------------------------------------*
FORM GET_ZN004.
*
SELECT KUNNR EDATE
INTO TABLE TBL_ZN004
FROM ZN004
WHERE BUKRS = P_BUKRS.
*
ENDFORM.                    " GET_ZN004
*&---------------------------------------------------------------------*
*&      Form  GET_LFM1_WYT3
*&---------------------------------------------------------------------*
*       仕入先マスタ（LFM1・WYT3）を一括取得する
*----------------------------------------------------------------------*
FORM GET_LFM1_WYT3.
*
SELECT LFM1~LIFNR "仕入先勘定コード	
LFM1~ZTERM "支払条件キー	
LFM1~WAERS "通貨コード	
WYT3~LIFN2 "他の仕入先への参照	
INTO TABLE TBL_LFM1_WYT3
FROM LFM1
JOIN WYT3 ON WYT3~LIFNR = LFM1~LIFNR
AND WYT3~EKORG = LFM1~EKORG
WHERE WYT3~EKORG = P_EKORG
AND   WYT3~LTSNR = SPACE     "　★固定値
AND   WYT3~WERKS = SPACE     "　★固定値
AND   WYT3~PARVW = P_PARVWL  "  選択画面の請求先取引先機能
AND   WYT3~PARZA = '000'.    "　★固定値
*
ENDFORM.                    " GET_LFM1_WYT3
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_YNEIAJ1101
*&---------------------------------------------------------------------*
*       各種チェック
*----------------------------------------------------------------------*
FORM F_CHECK_YNEIAJ1101.
DATA:
*** 2012/05/21 INSERT START ***
L_NUMC(17)     TYPE C,
*** 2012/05/21 INSERT END ***
L_TABIX        TYPE SY-TABIX,
L_ERR_MSG(128) TYPE C,
L_LINE         TYPE STRING,
L_SUBRC        TYPE SY-SUBRC,
L_YYMM(4)      TYPE C,
L_YYYYMMDD(8)  TYPE C,
L_VKORG        TYPE EDSDC-VKORG,
L_VTWEG        TYPE EDSDC-VTWEG,
L_SPAKU        TYPE TVTA-SPAKU.

*
REFRESH TAB_LOCK.
*
LOOP AT TBL_YNEIAJ1101.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*** 2012/07/04 DEL START ***
**---注文番号
*    IF TBL_YNEIAJ1101-YN00007 IS INITIAL.
*      CLEAR: L_ERR_MSG.
**     注文番号が、存在しません
*      MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M28.
*      PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNEIAJ1101-YN00004
*                                       L_ERR_MSG.
*      CONTINUE.
*    ENDIF.
*** 2012/07/04 DEL END ***
*---検収数量
IF TBL_YNEIAJ1101-YN00050 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1101-YN00050
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1101-YN00050.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M33 L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---検収日:YYMMDD
IF TBL_YNEIAJ1101-YN00051 <> SPACE.
*** 2012/07/17 INSERT START *** 売上・検収日
IF  TBL_YNEIAJ1101-YN00051 <> '0'
AND TBL_YNEIAJ1101-YN00051 <> '000000'.
*** 2012/07/17 INSERT END ***
PERFORM F_DATE_CHECK USING TBL_YNEIAJ1101-YN00051
TEXT-M34 L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
*** 2012/07/17 INSERT START *** 売上・検収日
ENDIF.
*** 2012/07/17 INSERT END ***
ENDIF.
*---計上月度:YYMM
IF TBL_YNEIAJ1101-YN00142 <> SPACE.
*** 2012/07/17 INSERT START *** 売上・計上月度
IF  TBL_YNEIAJ1101-YN00142 <> '0'
AND TBL_YNEIAJ1101-YN00142 <> '0000'.
*** 2012/07/17 INSERT END ***
L_YYMM = TBL_YNEIAJ1101-YN00142.
CONCATENATE '20' L_YYMM '01' INTO L_YYYYMMDD.
PERFORM F_DATE_CHECK USING L_YYYYMMDD
TEXT-M35  L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
*** 2012/07/17 INSERT START *** 売上・計上月度
ENDIF.
*** 2012/07/17 INSERT END ***
ENDIF.
*---検収単価（外貨）
IF TBL_YNEIAJ1101-YN00285 <> SPACE.
PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1101-YN00285
TEXT-M36 L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---検収金額（外貨）
IF TBL_YNEIAJ1101-YN00286 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1101-YN00286
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1101-YN00286.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M37 L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---消費税額(外貨)
IF TBL_YNEIAJ1101-YN00287 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1101-YN00287
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1101-YN00287.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M38 L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---合計額(外貨)
IF TBL_YNEIAJ1101-YN00288 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1101-YN00288
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1101-YN00288.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M39 L_TABIX
TBL_YNEIAJ1101-YN00004
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---発注者コード
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = TBL_YNEIAJ1101-YN00004(10)  "発注者コード
IMPORTING
OUTPUT        = TBL_YNEIAJ1101-YN00004(10).
*
READ TABLE TBL_KNVV_KNVI WITH
TABLE KEY KUNNR = TBL_YNEIAJ1101-YN00004
INTO W_KNVV_KNVI.
L_SUBRC = SY-SUBRC.
IF L_SUBRC = 0.
*---通貨コードチェック
IF TBL_YNEIAJ1101-YN00281 IS INITIAL.
TBL_YNEIAJ1101-YN00281 = W_KNVV_KNVI-WAERS.
ELSE.
IF TBL_YNEIAJ1101-YN00281 <> W_KNVV_KNVI-WAERS.
L_SUBRC = 9.
ENDIF.
ENDIF.
ENDIF.
IF L_SUBRC = 0.
READ TABLE TBL_KNVP_KNVV WITH
TABLE KEY KUNNR = TBL_YNEIAJ1101-YN00004
INTO W_KNVP_KNVV.
L_SUBRC = SY-SUBRC.
ENDIF.
IF L_SUBRC <> 0.
CLEAR: L_ERR_MSG.
*     得意先コード[入力ファイルの発注者コード]はありません
MESSAGE I816 INTO L_ERR_MSG WITH TBL_YNEIAJ1101-YN00004.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNEIAJ1101-YN00004
L_ERR_MSG.
CONTINUE.
ENDIF.
*プラントの取得・営業所の再取得
*販売組織、流通チャネル、製品部門の取得
PERFORM GET_EDSDC_TVTA USING TBL_YNEIAJ1101-YN00004    "受注先
TBL_YNEIAJ1101-YNBUKRS(10) "受注者コード
P_VKORG                    "販売組織
P_VTWEG                    "流通チャネル
P_SPART                    "製品部門
CHANGING L_VKORG L_VTWEG L_SPAKU L_SUBRC.

IF L_SUBRC <> 0.
CLEAR: L_ERR_MSG.
*** 2012/05/21 MOD START 2***
*     得意先コード[入力ファイルの発注者コード]はありません
*      MESSAGE I816 INTO L_ERR_MSG WITH TBL_YNEIAJ1101-YN00004.
*      PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNEIAJ1101-YN00004
*                                       L_ERR_MSG.
*      CONTINUE.
MESSAGE I999 INTO L_ERR_MSG WITH
'テーブル：EDSDCのエントリを確認して下さい'.
PERFORM F_ERR_LOG_FILE_SET2 USING L_TABIX TBL_YNEIAJ1101-YN00004
L_ERR_MSG.
*** 2012/05/21 MOD END 2***
ENDIF.
*追加チェック
*
LW_LOCK-BUKRS = P_BUKRS.
LW_LOCK-LIFNR = TBL_YNEIAJ1101-YN00004.
LW_LOCK-WERKS = W_KNVV_KNVI-VKBUR.
COLLECT LW_LOCK INTO TAB_LOCK.
*
*** 2012/03/22 MOD START @ ***
*    MODIFY TBL_YNEIAJ1101 TRANSPORTING YN00004. "発注者コード
MODIFY TBL_YNEIAJ1101. "発注者コード
*** 2012/03/22 MOD END @ ***
*
ENDLOOP.
*
ENDFORM.                    " F_CHECK_YNEIAJ1101
*&---------------------------------------------------------------------*
*&      Form  GET_T_CSV_DATA_COMM
*&---------------------------------------------------------------------*
*       データ取得(COPY:GET_T_CSV_DATA)+P_TBNAME
*----------------------------------------------------------------------*
*      <--P_T_CSV_DATA  CSVデータ内部テーブル
*      -->P_T_CSV_LINE  CSV LINE 内部テーブル
*----------------------------------------------------------------------*
FORM GET_T_CSV_DATA_COMM TABLES   P_T_CSV_DATA
USING    P_SEPARATOR
P_FIXER
P_FIX_FLG
P_TBNAME.

DATA: L_TABIX LIKE SY-TABIX,
L_INDEX LIKE SY-INDEX.
DATA: L_T_FIELD TYPE STANDARD TABLE OF STRING,
L_FIELD TYPE STRING,
L_FIELD_COUNT TYPE I.
DATA: L_LEN_FIXER TYPE I,
L_LEN_FIXER2 TYPE I.

DATA: L_LEN TYPE I,
L_FLEN TYPE I,
L_OFFLEN TYPE I,
L_CURRENT_LEN TYPE I,
L_LINE_LEN TYPE I,
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING.

FIELD-SYMBOLS <FS_CSV_FIELD>.
FIELD-SYMBOLS <FS_YNBUKRS>.
FIELD-SYMBOLS <FS_YNVRFCTON>.
**elematec 対応 INSERT START 2011/12/08
DATA L_TAB TYPE X.
L_TAB = '09'.
*elematec 対応 INSERT  END   2011/12/08

IF P_FIX_FLG <> 'X'.
L_LEN_FIXER = STRLEN( P_FIXER ).
L_LEN_FIXER2 = L_LEN_FIXER * 2.

REFRESH P_T_CSV_DATA.
LOOP AT TBL_CSV.
L_TABIX = SY-TABIX.
**elematec 対応 UPDATE START 2011/12/08
IF P_SEPARATOR = L_TAB.
* Mod ES-UP 2012/10/11 -->
*        SPLIT TBL_CSV AT L_TAB INTO TABLE L_T_FIELD.
SPLIT TBL_CSV AT CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB INTO TABLE L_T_FIELD.
* Mod ES-UP 2012/10/11 <--
ELSE.
SPLIT TBL_CSV AT P_SEPARATOR INTO TABLE L_T_FIELD.
ENDIF.
*elematec 対応 UPDATE  END   2011/12/08
CLEAR: P_T_CSV_DATA, L_FIELD_COUNT.
DO.
L_INDEX = SY-INDEX.
ASSIGN COMPONENT L_INDEX OF STRUCTURE P_T_CSV_DATA
TO <FS_CSV_FIELD>.
CASE SY-SUBRC.
WHEN 0.
L_FIELD_COUNT = L_FIELD_COUNT + 1.
READ TABLE L_T_FIELD INTO L_FIELD INDEX L_INDEX.
IF SY-SUBRC = 0.
SHIFT L_FIELD RIGHT CIRCULAR BY L_LEN_FIXER PLACES.
L_LEN = STRLEN( L_FIELD ).
IF L_LEN < L_LEN_FIXER2 OR
L_FIELD(L_LEN_FIXER) <> P_FIXER OR
L_FIELD+L_LEN_FIXER(L_LEN_FIXER) <> P_FIXER.
*   [項目名]の桁数が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
*elematec 対応 UPDATE START 2011/12/08
*                ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
*                       P_T_CSV_DATA TO <FS_YNBUKRS>.
*                ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
*                       P_T_CSV_DATA TO <FS_YNVRFCTON>.
CASE P_TBNAME.
WHEN 'YNEIAJ1101'.
ASSIGN COMPONENT 'YN00004' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNEIAJ1102'.
ASSIGN COMPONENT 'YN00005' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNYN110' OR 'YNYN210'.
ASSIGN COMPONENT 'YNLIST1' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
ENDCASE.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*                <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
SHIFT L_FIELD LEFT BY L_LEN_FIXER2 PLACES.
IF <FS_CSV_FIELD> CP '* #'.
ENDIF.
L_FLEN = SY-FDPOS.
L_LEN = STRLEN( L_FIELD ).
IF L_FLEN >= L_LEN .
CATCH SYSTEM-EXCEPTIONS  CONVT_NO_NUMBER = 1 .
<FS_CSV_FIELD> = L_FIELD.
ENDCATCH.
IF SY-SUBRC = 1.
*   [項目名]の属性が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH L_FIELD.
*elematec 対応 UPDATE START 2011/12/08
*                  ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
*                         P_T_CSV_DATA TO <FS_YNBUKRS>.
*                  ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
*                         P_T_CSV_DATA TO <FS_YNVRFCTON>.
CASE P_TBNAME.
WHEN 'YNEIAJ1101'.
ASSIGN COMPONENT 'YN00004' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNEIAJ1102'.
ASSIGN COMPONENT 'YN00005' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNYN110' OR 'YNYN210'.
ASSIGN COMPONENT 'YNLIST1' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
ENDCASE.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*                  <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
ELSE.
*   [項目名]の桁数が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
*elematec 対応 UPDATE START 2011/12/08
*                  ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
*                         P_T_CSV_DATA TO <FS_YNBUKRS>.
*                  ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
*                         P_T_CSV_DATA TO <FS_YNVRFCTON>.
CASE P_TBNAME.
WHEN 'YNEIAJ1101'.
ASSIGN COMPONENT 'YN00004' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNEIAJ1102'.
ASSIGN COMPONENT 'YN00005' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNYN110' OR 'YNYN210'.
ASSIGN COMPONENT 'YNLIST1' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
ENDCASE.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*                  <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
ENDIF.
WHEN OTHERS.
EXIT.
ENDCASE.
ENDDO.
APPEND P_T_CSV_DATA.
ENDLOOP.
ELSE.
* 固定長
REFRESH P_T_CSV_DATA.
LOOP AT TBL_CSV.
L_OFFLEN = 0.
L_TABIX = SY-TABIX.
* 2012/05/18 ADD START
CLEAR: P_T_CSV_DATA,L_FIELD_COUNT.
* 2012/05/18 ADD END
DO.
L_INDEX = SY-INDEX.
ASSIGN COMPONENT L_INDEX OF STRUCTURE P_T_CSV_DATA
TO <FS_CSV_FIELD>.
CASE SY-SUBRC.
WHEN 0.
L_FIELD_COUNT = L_FIELD_COUNT + 1.
IF <FS_CSV_FIELD> CP '* #'.
ENDIF.
L_FLEN = SY-FDPOS.
L_CURRENT_LEN =  L_OFFLEN + L_FLEN.
* UPDATE 2007/04/19 IWAKI(DMC) {
*            L_LINE_LEN = STRLEN( TBL_CSV ).
* conversion 対応 2010/12/13 UPD >>>
*            L_LINE_LEN = cl_abap_list_utilities=>dynamic_output_length(
* TBL_CSV ).
* Mod ES-UP 2012/10/31 -->
*            L_LINE_LEN = STRLEN( TBL_CSV ).
L_LINE_LEN = cl_abap_list_utilities=>dynamic_output_length( TBL_CSV ).
* Mod ES-UP 2012/10/31 <--
* conversion 対応 2010/12/13 UPD <<<
* } UPDATE 2007/04/19 IWAKI(DMC)
IF L_CURRENT_LEN > L_LINE_LEN.
*   [項目名]の桁数が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I779 INTO L_ERR_MSG WITH L_FIELD.
*elematec 対応 UPDATE START 2011/12/08
*              ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
*                     P_T_CSV_DATA TO <FS_YNBUKRS>.
*              ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
*                     P_T_CSV_DATA TO <FS_YNVRFCTON>.
CASE P_TBNAME.
WHEN 'YNEIAJ1101'.
ASSIGN COMPONENT 'YN00004' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNEIAJ1102'.
ASSIGN COMPONENT 'YN00005' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNYN110' OR 'YNYN210'.
ASSIGN COMPONENT 'YNLIST1' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
ENDCASE.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*              <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
* UPDATE 2007/04/20 IWAKI(DMC) {
*            L_FIELD = TBL_CSV+L_OFFLEN(L_FLEN).
* conversion 対応 2010/12/13 UPD >>>
*             CL_ABAP_LIST_UTILITIES=>READ_FROM_DISPLAY_LAYOUT(
*                                          EXPORTING DISPLAY_DATA =
*TBL_CSV
*                                                    DISPLAY_OFFSET =
*L_OFFLEN
*                                                    DISPLAY_LENGTH =
*L_FLEN
*                                          IMPORTING FIELD = L_FIELD ).
* Mod ES-UP 2012/10/31 -->
*            L_FIELD = TBL_CSV+L_OFFLEN(L_FLEN).
CL_ABAP_LIST_UTILITIES=>READ_FROM_DISPLAY_LAYOUT(
EXPORTING DISPLAY_DATA = TBL_CSV
DISPLAY_OFFSET = L_OFFLEN
DISPLAY_LENGTH = L_FLEN
IMPORTING FIELD = L_FIELD ).
* Mod ES-UP 2012/10/31 <--
* conversion 対応 2010/12/13 UPD <<<

* } UPDATE 2007/04/20 IWAKI(DMC)
L_OFFLEN = L_OFFLEN + L_FLEN.
CATCH SYSTEM-EXCEPTIONS  CONVT_NO_NUMBER = 1 .
<FS_CSV_FIELD> = L_FIELD.
ENDCATCH.
IF SY-SUBRC = 1.
*[項目名]の属性が正しくありません
CLEAR: L_ERR_MSG.
MESSAGE I778 INTO L_ERR_MSG WITH L_FIELD.
*elematec 対応 UPDATE START 2011/12/08
*              ASSIGN COMPONENT 'YNBUKRS' OF STRUCTURE
*                     P_T_CSV_DATA TO <FS_YNBUKRS>.
*              ASSIGN COMPONENT 'YNVRFCTON' OF STRUCTURE
*                     P_T_CSV_DATA TO <FS_YNVRFCTON>.
CASE P_TBNAME.
WHEN 'YNEIAJ1101'.
ASSIGN COMPONENT 'YN00004' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNEIAJ1102'.
ASSIGN COMPONENT 'YN00005' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
WHEN 'YNYN110' OR 'YNYN210'.
ASSIGN COMPONENT 'YNLIST1' OF STRUCTURE
P_T_CSV_DATA TO <FS_YNVRFCTON>.
ENDCASE.
PERFORM SET_ERRLOG USING L_TABIX
<FS_YNVRFCTON>
*                                         <FS_YNBUKRS>
P_BUKRS
*elematec 対応 UPDATE END   2011/12/08
L_ERR_MSG.
PERFORM SET_ERRFILE USING TBL_CSV L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
* ERR LINE FLG
*              <FS_YNBUKRS> = 'ERR'.
EXIT.
ENDIF.
WHEN OTHERS.
EXIT.
ENDCASE.
ENDDO.
APPEND P_T_CSV_DATA.
ENDLOOP.
ENDIF.
*
ENDFORM.                    " GET_T_CSV_DATA_COMM
*&---------------------------------------------------------------------*
*&      Form  F_NUMERIC_CHECK
*&---------------------------------------------------------------------*
*       数値チェック
*----------------------------------------------------------------------*
FORM F_NUMERIC_CHECK USING P_STRING_IN
P_TEXT
P_TABIX
P_VRFCTON
CHANGING P_SUBRC.
DATA:
L_HTYPE TYPE DD01V-DATATYPE,
L_ERR_MSG(128) TYPE C.
*
CLEAR:P_SUBRC.

*
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN        = P_STRING_IN
IMPORTING
*     STRING_OUT       =
HTYPE            = L_HTYPE.
*
IF L_HTYPE <> 'NUMC'.
P_SUBRC = 9.
CLEAR: L_ERR_MSG.
*    の入力値が不正です。
MESSAGE I815 INTO L_ERR_MSG WITH P_TEXT.
PERFORM F_ERR_LOG_FILE_SET USING P_TABIX P_VRFCTON
L_ERR_MSG.
ENDIF.
*
ENDFORM.                    " F_NUMERIC_CHECK
*&---------------------------------------------------------------------*
*&      Form  F_DATE_CHECK
*&---------------------------------------------------------------------*
*       日付チェック
*----------------------------------------------------------------------*
FORM F_DATE_CHECK        USING P_DATE
P_TEXT
P_TABIX
P_VRFCTON
CHANGING P_SUBRC.
DATA:
L_ERR_MSG(128) TYPE C,
L_LINE TYPE STRING.
*
CLEAR:P_SUBRC.
*
CALL FUNCTION 'CONVERT_DATE_TO_INTERNAL'
EXPORTING
DATE_EXTERNAL                  = P_DATE
EXCEPTIONS
DATE_EXTERNAL_IS_INVALID       = 1
OTHERS                         = 2.
*
P_SUBRC = SY-SUBRC.
IF SY-SUBRC <> 0.
CLEAR: L_ERR_MSG.
*    の入力値が不正です。
MESSAGE I815 INTO L_ERR_MSG WITH P_TEXT.
PERFORM SET_ERRLOG USING P_TABIX
P_VRFCTON
P_BUKRS
L_ERR_MSG.
READ TABLE TBL_CSV INDEX P_TABIX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE L_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
ENDIF.

*
ENDFORM.                    " F_DATE_CHECK
*&---------------------------------------------------------------------*
*&      Form  GET_EDSDC_TVTA
*&---------------------------------------------------------------------*
*       販売組織、流通チャネル、製品部門の取得
*&---------------------------------------------------------------------*
FORM GET_EDSDC_TVTA USING P_KUNNR P_LIFNR L_VKORG L_VTWEG L_SPART
CHANGING P_VKORG P_VTWEG P_SPAKU P_SUBRC.
*
SELECT SINGLE
EDSDC~VKORG
EDSDC~VTWEG
TVTA~SPAKU
INTO (P_VKORG, P_VTWEG, P_SPAKU)
FROM EDSDC
JOIN TVTA  ON TVTA~VKORG = EDSDC~VKORG
AND TVTA~VTWEG = EDSDC~VTWEG
AND TVTA~SPART = EDSDC~SPART
WHERE EDSDC~KUNNR = P_KUNNR
AND   EDSDC~LIFNR = P_LIFNR.

P_SUBRC = SY-SUBRC.
*** 2012/05/21 INSERT START 2***
IF SY-SUBRC <> 0.
P_VKORG = L_VKORG.
P_VTWEG = L_VTWEG.
P_SPAKU = L_SPART.
ENDIF.
*** 2012/05/21 INSERT END 2***
*

ENDFORM.                    " GET_EDSDC_TVTA
*&---------------------------------------------------------------------*
*&      Form  GET_EXIT_YNEIAJ1101
*&---------------------------------------------------------------------*
*         EXIT番号の取得
*----------------------------------------------------------------------*
FORM GET_EXIT_YNEIAJ1101.
DATA:
L_SUBRC TYPE SY-SUBRC,
L_TABIX TYPE SY-TABIX,
L_VRFCTON TYPE YN130-VRFCTON.
*
LOOP AT TBL_YNEIAJ1101.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*
READ TABLE TBL_KNVP_KNVV
WITH TABLE KEY KUNNR = TBL_YNEIAJ1101-YN00004
INTO W_KNVP_KNVV.
*
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = W_KNVP_KNVV-KUNN2 "支払人
BUKRS   = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CONCATENATE 'D-' TBL_YNEIAJ1101-YN00281          "通貨コード
INTO L_VRFCTON.
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = L_VRFCTON
BUKRS  = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CLEAR:WK_MSGTEXT.
*          & 取得エラー
MESSAGE I754 WITH 'YN130' INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.
ENDIF.
ENDIF.
*
TBL_EXIT-EXIT  = W_YNX30-OUTEXITDOC.
*
TBL_EXIT-INDEX = L_TABIX.
APPEND TBL_EXIT.
*
ENDLOOP.
ENDFORM.                    " GET_EXIT_YNEIAJ1101
*&---------------------------------------------------------------------*
*&      Form  F_ERR_LOG_FILE_SET
*&---------------------------------------------------------------------*
*       エラー表示とファイル出力
*----------------------------------------------------------------------*
FORM F_ERR_LOG_FILE_SET USING P_TABIX P_VRFCTON P_ERR_MSG.
DATA :
L_LINE         TYPE STRING.
*
CLEAR:L_LINE.
PERFORM SET_ERRLOG USING P_TABIX
P_VRFCTON
P_BUKRS
P_ERR_MSG.
READ TABLE TBL_CSV INDEX P_TABIX INTO L_LINE.
PERFORM SET_ERRFILE USING L_LINE P_ERR_MSG.
G_ERR_COUNT = G_ERR_COUNT  + 1.
*
ENDFORM.                    " F_ERR_LOG_FILE_SET
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_YNYN110
*&---------------------------------------------------------------------*
*       各種チェック
*----------------------------------------------------------------------*
FORM   F_CHECK_YNYN110.
DATA:
L_TABIX        TYPE SY-TABIX,
L_ERR_MSG(128) TYPE C,
L_LINE         TYPE STRING,
L_SUBRC        TYPE SY-SUBRC,
L_YYMM(4)      TYPE C,
L_YYYYMMDD(8)  TYPE C,
L_VKORG        TYPE EDSDC-VKORG,
L_VTWEG        TYPE EDSDC-VTWEG,
L_SPAKU        TYPE TVTA-SPAKU,
L_NUMC(20)     TYPE C,
L_LENG         TYPE DD03L-LENG,
L_DECIMALS     TYPE TCURX-CURRDEC.
*
REFRESH TAB_LOCK.
*
LOOP AT TBL_YNYN110.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*---営業所
IF TBL_YNYN110-YNDVSON IS INITIAL.
CLEAR: L_ERR_MSG.
*     営業所が、存在しません*
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M40.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
PERFORM GET_TVBUR USING TBL_YNYN110-YNDVSON
CHANGING L_SUBRC.
IF SY-SUBRC <> 0.
CLEAR: L_ERR_MSG.
*       営業所が、マスタに存在しません
MESSAGE I817 INTO L_ERR_MSG WITH TEXT-M40.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---数量:YNKNQUAN
IF TBL_YNYN110-YNKNQUAN IS INITIAL.
CLEAR: L_ERR_MSG.
*     数量が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M41.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNQUAN.
TRANSLATE L_NUMC USING '. - '.
CONDENSE L_NUMC NO-GAPS.
*     数量の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M41 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
L_NUMC = TBL_YNYN110-YNKNQUAN.
TRANSLATE L_NUMC USING '- '.
CONDENSE L_NUMC NO-GAPS.
*     数量の桁数が、不適切です
PERFORM F_DEC_LENG_CHECK USING 'YN110' 'KNQUAN' L_NUMC
TEXT-M41 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---単価:YNKNUNTPRC
IF TBL_YNYN110-YNKNUNTPRC IS INITIAL.
CLEAR: L_ERR_MSG.
*     単価が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M42.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNUNTPRC.
TRANSLATE L_NUMC USING '. '.
CONDENSE L_NUMC NO-GAPS.
*     単価の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M42 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
L_NUMC = TBL_YNYN110-YNKNUNTPRC.
CONDENSE L_NUMC NO-GAPS.
*     単価の桁数が、不適切です
PERFORM F_DEC_LENG_CHECK USING 'YN110' 'KNUNTPRC' L_NUMC
TEXT-M42 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---消費税額:YNKNTAXAMT
IF NOT TBL_YNYN110-YNKNTAXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNTAXAMT.
TRANSLATE L_NUMC USING '. '.
*** 2012/05/15 INSERT START ***
TRANSLATE L_NUMC USING '- '.
*** 2012/05/15 INSERT END ***
CONDENSE L_NUMC NO-GAPS.
*     消費税額の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M43 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---税抜金額:YNKNITXAMT
IF TBL_YNYN110-YNKNQUAN = 0. "数量
IF TBL_YNYN110-YNKNITXAMT IS INITIAL.
CLEAR: L_ERR_MSG.
*       税抜金額が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M44.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNITXAMT.
TRANSLATE L_NUMC USING '. '.
*** 2012/05/15 INSERT START ***
TRANSLATE L_NUMC USING '- '.
*** 2012/05/15 INSERT END ***
CONDENSE L_NUMC NO-GAPS.
*       税抜金額の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M44 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
ENDIF.
*---税込金額:YNKNETXAMT
IF NOT TBL_YNYN110-YNKNETXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNETXAMT.
TRANSLATE L_NUMC USING '. '.
*** 2012/05/15 INSERT START ***
TRANSLATE L_NUMC USING '- '.
*** 2012/05/15 INSERT END ***
CONDENSE L_NUMC NO-GAPS.
*     税込金額の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M45 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---得意先コード(受注先）:YNLIST1
IF TBL_YNYN110-YNLIST1 IS INITIAL.
CLEAR: L_ERR_MSG.
*     得意先コード(受注先)が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M46.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
*---受注伝票:YNLIST3
IF NOT TBL_YNYN110-YNLIST3 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN110-YNLIST3 ).
IF L_LENG > 10.
CLEAR: L_ERR_MSG.
*        受注伝票の桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M48.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---営業グループ:YNLIST4
IF NOT TBL_YNYN110-YNLIST4 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN110-YNLIST4 ).
IF L_LENG > 3.
CLEAR: L_ERR_MSG.
*        営業グループの桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M49.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---品目コード:YNLIST5
IF NOT TBL_YNYN110-YNLIST5 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN110-YNLIST5 ).
IF L_LENG > 18.
CLEAR: L_ERR_MSG.
*        品目コードの桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M50.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---品目テキスト:YNLIST6
IF NOT TBL_YNYN110-YNLIST6 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN110-YNLIST6 ).
IF L_LENG > 40.
CLEAR: L_ERR_MSG.
*        品目テキストの桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M51.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---得意先品目:YNLIST7
IF NOT TBL_YNYN110-YNLIST7 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN110-YNLIST7 ).
IF L_LENG > 35.
CLEAR: L_ERR_MSG.
*        得意先品目の桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M52.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---検収日:LDATE1
IF TBL_YNYN110-YNLDATE1 IS INITIAL.
CLEAR: L_ERR_MSG.
*      検収日が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M54.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
*      検収日の入力値が不正です。
PERFORM F_DATE_CHECK USING TBL_YNYN110-YNLDATE1
TEXT-M54 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*マスタチェック
*得意先コード（受注先・支払人）の取得
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = TBL_YNYN110-YNLIST1(10)  "得意先コード（受注先）
IMPORTING
OUTPUT        = TBL_YNYN110-YNLIST1(10).
*
READ TABLE TBL_KNVV_KNVI WITH TABLE KEY KUNNR = TBL_YNYN110-YNLIST1
INTO W_KNVV_KNVI.
L_SUBRC = SY-SUBRC.
IF L_SUBRC = 0.
*---通貨コードチェック
IF TBL_YNYN110-YNWAERS IS INITIAL.
TBL_YNYN110-YNWAERS = W_KNVV_KNVI-WAERS.
ELSE.
IF TBL_YNYN110-YNWAERS <> W_KNVV_KNVI-WAERS.
L_SUBRC = 9.
ENDIF.
ENDIF.
ENDIF.
IF L_SUBRC = 0.
READ TABLE TBL_KNVP_KNVV WITH
TABLE KEY KUNNR = TBL_YNYN110-YNLIST1
INTO W_KNVP_KNVV.
L_SUBRC = SY-SUBRC.
ENDIF.
IF L_SUBRC <> 0.
CLEAR: L_ERR_MSG.
*     得意先コード[入力ファイルの得意先コード(受注先)]はありません
MESSAGE I816 INTO L_ERR_MSG WITH TBL_YNYN110-YNLIST1.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
*追加チェック
*通貨コードに対する桁数
CALL FUNCTION 'FWOS_CURRENCY_DECIMALS_READ'
EXPORTING
I_CURRENCY               = W_KNVV_KNVI-WAERS
IMPORTING
E_DECIMALS               = L_DECIMALS
EXCEPTIONS
I_CURRENCY_INITIAL       = 1
OTHERS                   = 2.
*消費税額:通貨コードに対する桁数チェック
IF NOT TBL_YNYN110-YNKNTAXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNTAXAMT.
PERFORM F_CURRENCY_LENG_CHECK USING 'YN110' 'KNTAXAMT'
L_NUMC L_DECIMALS
TEXT-M43 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*税抜金額:通貨コードに対する桁数チェック
IF NOT TBL_YNYN110-YNKNITXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNITXAMT.
PERFORM F_CURRENCY_LENG_CHECK USING 'YN110' 'KNITXAMT'
L_NUMC L_DECIMALS
TEXT-M44 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*税込金額:通貨コードに対する桁数チェック
IF NOT TBL_YNYN110-YNKNETXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN110-YNKNETXAMT.
PERFORM F_CURRENCY_LENG_CHECK USING 'YN110' 'KNETXAMT'
L_NUMC L_DECIMALS
TEXT-M45 L_TABIX
TBL_YNYN110-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*
LW_LOCK-BUKRS = P_BUKRS.
LW_LOCK-LIFNR = TBL_YNYN110-YNLIST1.
LW_LOCK-WERKS = TBL_YNYN110-YNDVSON.
COLLECT LW_LOCK INTO TAB_LOCK.
*
*** 2012/03/22 MOD START @ ***
*    MODIFY TBL_YNYN110 TRANSPORTING YNLIST1. "得意先コード(受注先)
MODIFY TBL_YNYN110.  "得意先コード(受注先)
*** 2012/03/22 MOD END @ ***
*
ENDLOOP.
*
ENDFORM.                    " F_CHECK_YNYN110
*&---------------------------------------------------------------------*
*&      Form  GET_TVBUR
*&---------------------------------------------------------------------*
*       組織単位: 営業所
*----------------------------------------------------------------------*
FORM GET_TVBUR USING P_VKBUR
CHANGING P_SUBRC.
*
SELECT SINGLE COUNT( * )
FROM TVBUR
WHERE VKBUR = P_VKBUR.
P_SUBRC = SY-SUBRC.
*
ENDFORM.                    " GET_TVBUR
*&---------------------------------------------------------------------*
*&      Form  F_DEC_LENG_CHECK
*&---------------------------------------------------------------------*
*       ＤＥＣ桁数チェック
*----------------------------------------------------------------------*
FORM F_DEC_LENG_CHECK USING P_TABNAME P_FIELDNAME P_DEC
P_TEXT P_TABIX P_VRFCTON
CHANGING P_SUBRC.
DATA :
L_LENG         TYPE DD03L-LENG,
L_LENGA        TYPE DD03L-LENG,
L_LENGB        TYPE DD03L-LENG,
L_DECIMALS     TYPE DD03L-DECIMALS,
L_NUMA(20)     TYPE C,
L_NUMB(20)     TYPE C,
L_ERR_MSG(128) TYPE C.
*
SELECT LENG DECIMALS INTO (L_LENG, L_DECIMALS)
FROM DD03L
WHERE TABNAME   = P_TABNAME
AND   FIELDNAME = P_FIELDNAME
AND   AS4LOCAL  = 'A'.
EXIT.
ENDSELECT.
*
IF SY-SUBRC <> 0.
CLEAR:L_LENG, L_DECIMALS.
ELSE.
L_LENG = L_LENG - L_DECIMALS.
ENDIF.
*数値を.で整数と小数に分割する
SPLIT P_DEC AT '.' INTO L_NUMA L_NUMB.
L_LENGA = STRLEN( L_NUMA ).
L_LENGB = STRLEN( L_NUMB ).
IF L_LENGA > L_LENG OR
L_LENGB > L_DECIMALS.
CLEAR: L_ERR_MSG.
*    の桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH P_TEXT.
PERFORM F_ERR_LOG_FILE_SET USING P_TABIX P_VRFCTON
L_ERR_MSG.
P_SUBRC = 9.
ENDIF.
*
ENDFORM.                    " F_DEC_LENG_CHECK
*&---------------------------------------------------------------------*
*&      Form  F_CURRENCY_LENG_CHECK
*&---------------------------------------------------------------------*
*       金額項目の桁数チェック
*----------------------------------------------------------------------*
FORM F_CURRENCY_LENG_CHECK USING    P_TABNAME
P_FIELDNAME
P_CURR
P_DECIMALS
P_TEXT
P_TABIX
P_VRFCTON
CHANGING P_SUBRC.
DATA :
L_LENG         TYPE DD03L-LENG,
L_LENGA        TYPE DD03L-LENG,
L_LENGB        TYPE DD03L-LENG,
L_LENGSUM      TYPE DD03L-LENG,
L_DECIMALS     TYPE DD03L-DECIMALS,
L_NUMA(20)     TYPE C,
L_NUMB(20)     TYPE C,
L_ERR_MSG(128) TYPE C.
*
SELECT LENG DECIMALS INTO (L_LENG, L_DECIMALS)
FROM DD03L
WHERE TABNAME   = P_TABNAME
AND   FIELDNAME = P_FIELDNAME
AND   AS4LOCAL  = 'A'.
EXIT.
ENDSELECT.
*
IF SY-SUBRC <> 0.
CLEAR:L_LENG, L_DECIMALS.
ENDIF.
*金額を小数点.で整数と小数に分割する
SPLIT P_CURR AT '.' INTO L_NUMA L_NUMB.
L_LENGA = STRLEN( L_NUMA ).   "整数部桁数
L_LENGB = STRLEN( L_NUMB ).   "小数部桁数
L_LENGSUM = L_LENGA + L_LENGB.
IF L_LENGB   > P_DECIMALS OR    "小数部桁数チェック
L_LENGSUM > L_LENG.          "全体桁数チェック
CLEAR: L_ERR_MSG.
*    の桁数が、マスタ設定の通貨コードと適合しません
MESSAGE I819 INTO L_ERR_MSG WITH P_TEXT.
PERFORM F_ERR_LOG_FILE_SET USING P_TABIX P_VRFCTON
L_ERR_MSG.
P_SUBRC = 9.
ENDIF.
*
ENDFORM.                    " F_CURRENCY_LENG_CHECK
*&---------------------------------------------------------------------*
*&      Form  GET_EXIT_YNYN110
*&---------------------------------------------------------------------*
*       EXIT番号の取得
*----------------------------------------------------------------------*
FORM GET_EXIT_YNYN110.
DATA:
L_SUBRC TYPE SY-SUBRC,
L_TABIX TYPE SY-TABIX,
L_VRFCTON TYPE YN130-VRFCTON,
L_ERR_MSG(128) TYPE C.

*
LOOP AT TBL_YNYN110.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*
READ TABLE TBL_KNVP_KNVV WITH TABLE KEY KUNNR = TBL_YNYN110-YNLIST1
INTO W_KNVP_KNVV.
*
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = W_KNVP_KNVV-KUNN2 "支払人
BUKRS   = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CONCATENATE 'D-' TBL_YNYN110-YNWAERS          "通貨コード
INTO L_VRFCTON.
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = L_VRFCTON
BUKRS  = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CLEAR:WK_MSGTEXT.
*          & 取得エラー
MESSAGE I754 WITH 'YN130' INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.
ENDIF.
ENDIF.
*
CASE W_YNX30-OUTEXITDOC.
WHEN '1001'.
IF TBL_YNYN110-YNLIST2 IS INITIAL.
CLEAR: L_ERR_MSG.
*         得意先発注番号が設定されていません
MESSAGE I820 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
WHEN '1002'.
IF TBL_YNYN110-YNLIST8 IS INITIAL.
CLEAR: L_ERR_MSG.
*         インボイスNoが設定されていません
MESSAGE I821 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
WHEN '1003'.
IF TBL_YNYN110-YNLIST2 IS INITIAL OR
TBL_YNYN110-YNLIST8 IS INITIAL.
CLEAR: L_ERR_MSG.
*         得意先発注番号、インボイスNoが設定されていません
MESSAGE I822 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN110-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDCASE.
*
TBL_EXIT-EXIT  = W_YNX30-OUTEXITDOC.
*
TBL_EXIT-INDEX = L_TABIX.
APPEND TBL_EXIT.
*
ENDLOOP.
ENDFORM.                    " GET_EXIT_YNYN110
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_YNEIAJ1102
*&---------------------------------------------------------------------*
*       各種チェック
*----------------------------------------------------------------------*
FORM F_CHECK_YNEIAJ1102.
DATA:
*** 2012/05/21 INSERT START ***
L_NUMC(17)     TYPE C,
*** 2012/05/21 INSERT END ***
L_TABIX        TYPE SY-TABIX,
L_ERR_MSG(128) TYPE C,
L_LINE         TYPE STRING,
L_SUBRC        TYPE SY-SUBRC,
L_YYMM(4)      TYPE C,
L_YYYYMMDD(8)  TYPE C,
L_VKORG        TYPE EDSDC-VKORG,
L_VTWEG        TYPE EDSDC-VTWEG,
L_SPAKU        TYPE TVTA-SPAKU,
L_WERKS        TYPE T001W-WERKS.

*
REFRESH TAB_LOCK.
*
LOOP AT TBL_YNEIAJ1102.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*** 2012/07/04 DEL START ***
**---注文番号
*    IF TBL_YNEIAJ1102-YN00007 IS INITIAL.
*      CLEAR: L_ERR_MSG.
**     注文番号が、存在しません
*      MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M28.
*      PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNEIAJ1102-YN00005
*                                       L_ERR_MSG.
*      CONTINUE.
*    ENDIF.
*** 2012/07/04 DEL END ***
*---売掛数量
IF TBL_YNEIAJ1102-YN00137 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1102-YN00137
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1102-YN00137.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M55 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*** 2012/05/21 INSERT START 3***
*---出荷日:YYMMDD
IF TBL_YNEIAJ1102-YN00039 <> SPACE.
*** 2012/07/17 INSERT START *** 仕入・出荷日
IF  TBL_YNEIAJ1102-YN00039 <> '0'
AND TBL_YNEIAJ1102-YN00039 <> '000000'.
*** 2012/07/17 INSERT END ***
PERFORM F_DATE_CHECK USING TBL_YNEIAJ1102-YN00039
TEXT-M67 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
*** 2012/07/17 INSERT START *** 仕入・出荷日
ENDIF.
*** 2012/07/17 INSERT END ***
ENDIF.
*** 2012/05/21 INSERT END 3***
*---売掛日:YYMMDD
IF TBL_YNEIAJ1102-YN00141 <> SPACE.
*** 2012/07/17 INSERT START *** 仕入・売掛日
IF  TBL_YNEIAJ1102-YN00141 <> '0'
AND TBL_YNEIAJ1102-YN00141 <> '000000'.
*** 2012/07/17 INSERT END ***
PERFORM F_DATE_CHECK USING TBL_YNEIAJ1102-YN00141
TEXT-M56 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
*** 2012/07/17 INSERT START *** 仕入・売掛日
ENDIF.
*** 2012/07/17 INSERT END ***
ENDIF.
*---計上月度:YYMM
IF TBL_YNEIAJ1102-YN00142 <> SPACE.
*** 2012/07/17 INSERT START *** 仕入・計上月度
IF  TBL_YNEIAJ1102-YN00142 <> '0'
AND TBL_YNEIAJ1102-YN00142 <> '0000'.
*** 2012/07/17 INSERT END ***
L_YYMM = TBL_YNEIAJ1102-YN00142.
CONCATENATE '20' L_YYMM '01' INTO L_YYYYMMDD.
PERFORM F_DATE_CHECK USING L_YYYYMMDD
TEXT-M35  L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
*** 2012/07/17 INSERT START *** 仕入・計上月度
ENDIF.
*** 2012/07/17 INSERT END ***
ENDIF.
*---単価(外貨)
IF TBL_YNEIAJ1102-YN00282 <> SPACE.
PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1102-YN00282
TEXT-M57 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---消費税額(外貨)
IF TBL_YNEIAJ1102-YN00287 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1102-YN00287
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1102-YN00287.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M38 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---合計額(外貨)
IF TBL_YNEIAJ1102-YN00288 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1102-YN00288
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1102-YN00288.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M39 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---売掛金額(外貨）
IF TBL_YNEIAJ1102-YN00298 <> SPACE.
*** 2012/05/21 MOD START ***
*      PERFORM F_NUMERIC_CHECK USING TBL_YNEIAJ1102-YN00298
CLEAR L_NUMC.
L_NUMC = TBL_YNEIAJ1102-YN00298.
TRANSLATE L_NUMC USING '- '.
PERFORM F_NUMERIC_CHECK USING L_NUMC
*** 2012/05/21 MOD END ***
TEXT-M58 L_TABIX
TBL_YNEIAJ1102-YN00005
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---受注者コード
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = TBL_YNEIAJ1102-YN00005(10)  "受注者コード
IMPORTING
OUTPUT        = TBL_YNEIAJ1102-YN00005(10).
*
READ TABLE TBL_LFM1_WYT3 WITH
TABLE KEY LIFNR = TBL_YNEIAJ1102-YN00005
INTO W_LFM1_WYT3.
L_SUBRC = SY-SUBRC.
IF L_SUBRC = 0.
*---通貨コードチェック
IF TBL_YNEIAJ1102-YN00281 IS INITIAL.
TBL_YNEIAJ1102-YN00281 = W_LFM1_WYT3-WAERS.
ELSE.
IF TBL_YNEIAJ1102-YN00281 <> W_LFM1_WYT3-WAERS.
L_SUBRC = 9.
ENDIF.
ENDIF.
ENDIF.
IF L_SUBRC <> 0.
CLEAR: L_ERR_MSG.
*     仕入先コード[入力ファイルの受注者コード]はありません
MESSAGE I823 INTO L_ERR_MSG WITH TBL_YNEIAJ1102-YN00005.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNEIAJ1102-YN00005
L_ERR_MSG.
CONTINUE.
ENDIF.
*プラントの取得・営業所の再取得
*"注文番号
* Mod ES-UP 2012/10/11 -->
*    CONCATENATE 'P' TBL_YNEIAJ1102-YN00007+(2) '0' INTO L_WERKS.
CONCATENATE 'P' TBL_YNEIAJ1102-YN00007(2) '0' INTO L_WERKS.
* Mod ES-UP 2012/10/11 <--
PERFORM GET_T001W USING L_WERKS
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CLEAR: L_ERR_MSG.
*     注文番号より、プラントが取得できませんでした
MESSAGE I824 INTO L_ERR_MSG.
*** 2012/07/04 MOD START ***
*      PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNEIAJ1102-YN00005
*                                       L_ERR_MSG.
*      CONTINUE.
* エラーログを出力する。
PERFORM F_ERR_LOG_FILE_SET2 USING L_TABIX TBL_YNEIAJ1102-YN00005
L_ERR_MSG.
L_WERKS = 'PS00' .
*** 2012/07/04 MOD END ***
ENDIF.

*追加チェック
*
LW_LOCK-BUKRS = P_BUKRS.
LW_LOCK-LIFNR = TBL_YNEIAJ1102-YN00005.
LW_LOCK-WERKS = L_WERKS.
COLLECT LW_LOCK INTO TAB_LOCK.
*
*** 2012/03/22 MOD START @ ***
*    MODIFY TBL_YNEIAJ1102 TRANSPORTING YN00005. "受注者コード
MODIFY TBL_YNEIAJ1102. "受注者コード
*** 2012/03/22 MOD END @ ***
*
ENDLOOP.
*
ENDFORM.                    " F_CHECK_YNEIAJ1102
*&---------------------------------------------------------------------*
*&      Form  GET_T001W
*&---------------------------------------------------------------------*
*       プラント/支店の取得
*----------------------------------------------------------------------*
FORM GET_T001W  USING P_WERKS
CHANGING L_SUBRC.
*
SELECT SINGLE COUNT( * )
FROM T001W
WHERE WERKS = P_WERKS.
L_SUBRC = SY-SUBRC.
*
ENDFORM.                    " GET_T001W
*&---------------------------------------------------------------------*
*&      Form  LOCK_PRCHS_SALES
*&---------------------------------------------------------------------*
*       売上、仕入ロック
*----------------------------------------------------------------------*
FORM LOCK_PRCHS_SALES.
DATA :
L_USER TYPE SY-UNAME.
*
IF P_TEST <> 'X'.
* テーブルのロック
IF P_SALES = 'X'.
PERFORM TABLE_LOCK_902.
L_USER = SY-MSGV1.
IF RC_CODE_LOCK <> 0.
*ZN902 ロックエラー & がロックしています
MESSAGE I756  WITH TEXT-M29 L_USER.
CLEAR:WK_MSGTEXT.
MESSAGE I756 WITH TEXT-M29 L_USER INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.
ENDIF.
ENDIF.
*
IF P_PRCHS = 'X'.
PERFORM TABLE_LOCK_901.
L_USER = SY-MSGV1.
IF RC_CODE_LOCK <> 0.
*ZN901 ロックエラー & がロックしています
MESSAGE I756  WITH TEXT-M25 L_USER.
CLEAR:WK_MSGTEXT.
MESSAGE I756 WITH TEXT-M25 L_USER INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.
ENDIF.
ENDIF.
ENDIF.
*
ENDFORM.                    " LOCK_PRCHS_SALES
*&---------------------------------------------------------------------*
*&      Form  GET_EXIT_YNEIAJ1102
*&---------------------------------------------------------------------*
*       YNEIAJ1102のEXIT番号取得
*----------------------------------------------------------------------*
FORM GET_EXIT_YNEIAJ1102.
DATA:
L_SUBRC TYPE SY-SUBRC,
L_TABIX TYPE SY-TABIX,
L_VRFCTON TYPE YN230-VRFCTON.
*
LOOP AT TBL_YNEIAJ1102.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*
READ TABLE TBL_LFM1_WYT3
WITH TABLE KEY LIFNR = TBL_YNEIAJ1102-YN00005
INTO W_LFM1_WYT3.
*
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = W_LFM1_WYT3-LIFN2 "請求先
BUKRS   = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CONCATENATE 'D-' TBL_YNEIAJ1102-YN00281          "通貨コード
INTO L_VRFCTON.
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = L_VRFCTON
BUKRS  = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CLEAR:WK_MSGTEXT.
*          & 取得エラー
MESSAGE I754 WITH 'YN230' INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.
ENDIF.
ENDIF.
*
TBL_EXIT-EXIT  = W_YNX30-OUTEXITDOC.
*
TBL_EXIT-INDEX = L_TABIX.
APPEND TBL_EXIT.
*
ENDLOOP.
*
ENDFORM.                    " GET_EXIT_YNEIAJ1102
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_YNYN210
*&---------------------------------------------------------------------*
*       各種チェック
*----------------------------------------------------------------------*
FORM F_CHECK_YNYN210.
DATA:
L_TABIX        TYPE SY-TABIX,
L_ERR_MSG(128) TYPE C,
L_LINE         TYPE STRING,
L_SUBRC        TYPE SY-SUBRC,
L_YYMM(4)      TYPE C,
L_YYYYMMDD(8)  TYPE C,
L_NUMC(20)     TYPE C,
L_LENG         TYPE DD03L-LENG,
L_DECIMALS     TYPE TCURX-CURRDEC.
*
REFRESH TAB_LOCK.
*
LOOP AT TBL_YNYN210.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*---プラント
IF TBL_YNYN210-YNDVSON IS INITIAL.
* 2012/04/09 MOD START
*      CLEAR: L_ERR_MSG.
**     プラントが、存在しません*
*      MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M61.
*      PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
*                                       L_ERR_MSG.
*      CONTINUE.
*-- プラント未入力の場合、発注明細からプラントを取得
CLEAR:TBL_YNYN210-YNDVSON.
IF NOT TBL_YNYN210-YNLIST2 IS INITIAL.
SELECT WERKS
FROM EKPO
INTO TBL_YNYN210-YNDVSON
WHERE EBELN = TBL_YNYN210-YNLIST2
AND LOEKZ = SPACE.
IF TBL_YNYN210-YNDVSON IS INITIAL.
EXIT.
ENDIF.
ENDSELECT.
ENDIF.
*     発注明細からプラントが取れなかったら以下エラー
IF TBL_YNYN210-YNDVSON IS INITIAL.
CLEAR: L_ERR_MSG.
*       プラントが、存在しません
MESSAGE I939 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
* 2012/04/09 MOD END
ELSE.
PERFORM GET_T001W USING TBL_YNYN210-YNDVSON
CHANGING L_SUBRC.
IF SY-SUBRC <> 0.
CLEAR: L_ERR_MSG.
*       プラントが、マスタに存在しません
MESSAGE I817 INTO L_ERR_MSG WITH TEXT-M61.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---数量:YNKNQUAN
IF TBL_YNYN210-YNKNQUAN IS INITIAL.
CLEAR: L_ERR_MSG.
*     数量が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M41.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNQUAN.
TRANSLATE L_NUMC USING '. - '.
CONDENSE L_NUMC NO-GAPS.
*     数量の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M41 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
L_NUMC = TBL_YNYN110-YNKNQUAN.
TRANSLATE L_NUMC USING '- '.
CONDENSE L_NUMC NO-GAPS.
*     数量の桁数が、不適切です
PERFORM F_DEC_LENG_CHECK USING 'YN210' 'KNQUAN' L_NUMC
TEXT-M41 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---単価:YNKNUNTPRC
IF TBL_YNYN210-YNKNUNTPRC IS INITIAL.
CLEAR: L_ERR_MSG.
*     単価が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M42.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNUNTPRC.
TRANSLATE L_NUMC USING '. '.
CONDENSE L_NUMC NO-GAPS.
*     単価の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M42 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
L_NUMC = TBL_YNYN210-YNKNUNTPRC.
CONDENSE L_NUMC NO-GAPS.
*     単価の桁数が、不適切です
PERFORM F_DEC_LENG_CHECK USING 'YN210' 'KNUNTPRC' L_NUMC
TEXT-M42 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---消費税額:YNKNTAXAMT
IF NOT TBL_YNYN210-YNKNTAXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNTAXAMT.
TRANSLATE L_NUMC USING '. '.
*** 2012/05/15 INSERT START ***
TRANSLATE L_NUMC USING '- '.
*** 2012/05/15 INSERT END ***
CONDENSE L_NUMC NO-GAPS.
*     消費税額の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M43 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---税抜金額:YNKNITXAMT
IF TBL_YNYN210-YNKNQUAN = 0. "数量
IF TBL_YNYN210-YNKNITXAMT IS INITIAL.
CLEAR: L_ERR_MSG.
*       税抜金額が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M44.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNITXAMT.
TRANSLATE L_NUMC USING '. '.
*** 2012/05/15 INSERT START ***
TRANSLATE L_NUMC USING '- '.
*** 2012/05/15 INSERT END ***
CONDENSE L_NUMC NO-GAPS.
*       税抜金額の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M44 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
ENDIF.
*---税込金額:YNKNETXAMT
IF NOT TBL_YNYN210-YNKNETXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNETXAMT.
TRANSLATE L_NUMC USING '. '.
*** 2012/05/15 INSERT START ***
TRANSLATE L_NUMC USING '- '.
*** 2012/05/15 INSERT END ***
CONDENSE L_NUMC NO-GAPS.
*     税込金額の入力値が不正です。
PERFORM F_NUMERIC_CHECK USING L_NUMC
TEXT-M45 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*---仕入先コード(発注先）:YNLIST1
IF TBL_YNYN210-YNLIST1 IS INITIAL.
CLEAR: L_ERR_MSG.
*     仕入先コード(発注先)が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M62.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
*---発注明細番号:YNLIST3
IF NOT TBL_YNYN210-YNLIST3 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN210-YNLIST3 ).
IF L_LENG > 5.
CLEAR: L_ERR_MSG.
*        発注明細番号の桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M63.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---購買グループ:YNLIST4
IF NOT TBL_YNYN210-YNLIST4 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN210-YNLIST4 ).
IF L_LENG > 3.
CLEAR: L_ERR_MSG.
*        購買グループの桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M64.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---品目コード:YNLIST5
IF NOT TBL_YNYN210-YNLIST5 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN210-YNLIST5 ).
IF L_LENG > 18.
CLEAR: L_ERR_MSG.
*        品目コードの桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M50.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---品目テキスト:YNLIST6
IF NOT TBL_YNYN210-YNLIST6 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN210-YNLIST6 ).
IF L_LENG > 40.
CLEAR: L_ERR_MSG.
*        品目テキストの桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M51.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---仕入先品目:YNLIST7
IF NOT TBL_YNYN210-YNLIST7 IS INITIAL.
L_LENG = STRLEN( TBL_YNYN210-YNLIST7 ).
IF L_LENG > 35.
CLEAR: L_ERR_MSG.
*        仕入先品目の桁数が、不適切です
MESSAGE I818 INTO L_ERR_MSG WITH TEXT-M65.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDIF.
*---請求日:LDATE1
IF TBL_YNYN210-YNLDATE1 IS INITIAL.
CLEAR: L_ERR_MSG.
*      請求日が、存在しません
MESSAGE I814 INTO L_ERR_MSG WITH TEXT-M66.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ELSE.
*      請求日の入力値が不正です。
PERFORM F_DATE_CHECK USING TBL_YNYN210-YNLDATE1
TEXT-M66 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*マスタチェック
*仕入先コード（発注先・請求先）の取得
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = TBL_YNYN210-YNLIST1(10)  "仕入先(発注先)
IMPORTING
OUTPUT        = TBL_YNYN210-YNLIST1(10).
*
READ TABLE TBL_LFM1_WYT3 WITH TABLE KEY LIFNR = TBL_YNYN210-YNLIST1
INTO W_LFM1_WYT3.
L_SUBRC = SY-SUBRC.
IF L_SUBRC = 0.
*---通貨コードチェック
IF TBL_YNYN210-YNWAERS IS INITIAL.
TBL_YNYN210-YNWAERS = W_LFM1_WYT3-WAERS.
ELSE.
IF TBL_YNYN210-YNWAERS <> W_LFM1_WYT3-WAERS.
L_SUBRC = 9.
ENDIF.
ENDIF.
ENDIF.
IF L_SUBRC <> 0.
CLEAR: L_ERR_MSG.
*     仕入先コード[入力ファイルの仕入先コード(発注先)]はありません
MESSAGE I823 INTO L_ERR_MSG WITH TBL_YNYN210-YNLIST1.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
*追加チェック
*通貨コードに対する桁数
CALL FUNCTION 'FWOS_CURRENCY_DECIMALS_READ'
EXPORTING
I_CURRENCY               = W_LFM1_WYT3-WAERS
IMPORTING
E_DECIMALS               = L_DECIMALS
EXCEPTIONS
I_CURRENCY_INITIAL       = 1
OTHERS                   = 2.
*消費税額:通貨コードに対する桁数チェック
IF NOT TBL_YNYN210-YNKNTAXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNTAXAMT.
PERFORM F_CURRENCY_LENG_CHECK USING 'YN210' 'KNTAXAMT'
L_NUMC L_DECIMALS
TEXT-M43 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*税抜金額:通貨コードに対する桁数チェック
IF NOT TBL_YNYN210-YNKNITXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNITXAMT.
PERFORM F_CURRENCY_LENG_CHECK USING 'YN210' 'KNITXAMT'
L_NUMC L_DECIMALS
TEXT-M44 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*税込金額:通貨コードに対する桁数チェック
IF NOT TBL_YNYN210-YNKNETXAMT IS INITIAL.
CLEAR:L_NUMC.
L_NUMC = TBL_YNYN210-YNKNETXAMT.
PERFORM F_CURRENCY_LENG_CHECK USING 'YN210' 'KNETXAMT'
L_NUMC L_DECIMALS
TEXT-M45 L_TABIX
TBL_YNYN210-YNLIST1
CHANGING L_SUBRC.
IF L_SUBRC <> 0.
CONTINUE.
ENDIF.
ENDIF.
*
LW_LOCK-BUKRS = P_BUKRS.
LW_LOCK-LIFNR = TBL_YNYN210-YNLIST1.
LW_LOCK-WERKS = TBL_YNYN210-YNDVSON.
COLLECT LW_LOCK INTO TAB_LOCK.
*
*** 2012/03/22 MOD START @ ***
*    MODIFY TBL_YNYN210 TRANSPORTING YNLIST1. "仕入先コード(発注先)
MODIFY TBL_YNYN210.  "仕入先コード(発注先)
*** 2012/03/22 MOD END @ ***
*
ENDLOOP.
*
ENDFORM.                    " F_CHECK_YNYN210
*&---------------------------------------------------------------------*
*&      Form  GET_EXIT_YNYN210
*&---------------------------------------------------------------------*
*       EXIT番号必須チェック
*----------------------------------------------------------------------*
FORM GET_EXIT_YNYN210.
DATA:
L_SUBRC TYPE SY-SUBRC,
L_TABIX TYPE SY-TABIX,
L_VRFCTON TYPE YN130-VRFCTON,
L_ERR_MSG(128) TYPE C.

*
LOOP AT TBL_YNYN210.
CLEAR:L_SUBRC.
L_TABIX = SY-TABIX.
*
READ TABLE TBL_LFM1_WYT3 WITH TABLE KEY LIFNR = TBL_YNYN210-YNLIST1
INTO W_LFM1_WYT3.
*
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = W_LFM1_WYT3-LIFN2 "請求先
BUKRS   = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CONCATENATE 'D-' TBL_YNYN210-YNWAERS          "通貨コード
INTO L_VRFCTON.
READ TABLE TBL_YNX30
WITH TABLE KEY VRFCTON = L_VRFCTON
BUKRS  = P_BUKRS
INTO W_YNX30.
IF SY-SUBRC <> 0.
CLEAR:WK_MSGTEXT.
*          & 取得エラー
MESSAGE I754 WITH 'YN230' INTO WK_MSGTEXT.
SKIP.
SKIP.
ULINE.
WRITE:/004 W_FILENAME.
ULINE.
SKIP.
WRITE:/004 WK_MSGTEXT.
STOP.
ENDIF.
ENDIF.
*
CASE W_YNX30-OUTEXITDOC.
WHEN '2001'.
IF TBL_YNYN210-YNLIST2 IS INITIAL.
CLEAR: L_ERR_MSG.
*         購買発注番号が設定されていません
MESSAGE I826 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
WHEN '2002'.
IF TBL_YNYN210-YNLIST8 IS INITIAL.
CLEAR: L_ERR_MSG.
*         インボイスNoが設定されていません
MESSAGE I821 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
WHEN '2003'.
IF TBL_YNYN210-YNLIST2 IS INITIAL OR
TBL_YNYN210-YNLIST8 IS INITIAL.
CLEAR: L_ERR_MSG.
*         購買発注番号、インボイスNoが設定されていません
MESSAGE I827 INTO L_ERR_MSG.
PERFORM F_ERR_LOG_FILE_SET USING L_TABIX TBL_YNYN210-YNLIST1
L_ERR_MSG.
CONTINUE.
ENDIF.
ENDCASE.
*
TBL_EXIT-EXIT  = W_YNX30-OUTEXITDOC.
*
TBL_EXIT-INDEX = L_TABIX.
APPEND TBL_EXIT.
*
ENDLOOP.
*
ENDFORM.                    " GET_EXIT_YNYN210
*&---------------------------------------------------------------------*
*&      Form  F_ERR_LOG_FILE_SET2
*&---------------------------------------------------------------------*
*       エラー表示とファイル出力 *
*　　　 ★エラーログを出力するが、エラーレコードとしない。
*----------------------------------------------------------------------*
FORM F_ERR_LOG_FILE_SET2 USING    P_TABIX P_VRFCTON P_ERR_MSG.
DATA :
L_LINE         TYPE STRING.
*
CLEAR:L_LINE.
PERFORM SET_ERRLOG USING P_TABIX
P_VRFCTON
P_BUKRS
P_ERR_MSG.
*  READ TABLE TBL_CSV INDEX P_TABIX INTO L_LINE.
*  PERFORM SET_ERRFILE USING L_LINE P_ERR_MSG.
*  G_ERR_COUNT = G_ERR_COUNT  + 1.
*

ENDFORM.                    " F_ERR_LOG_FILE_SET2
