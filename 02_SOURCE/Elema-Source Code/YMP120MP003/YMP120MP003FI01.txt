*----------------------------------------------------------------------*
***INCLUDE YMP120MP003FI01 .
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  GET_MATNR_DATA
*&---------------------------------------------------------------------*
*       品目情報取得
*----------------------------------------------------------------------*
*      -->I_MATNR  品目情報テーブル
*----------------------------------------------------------------------*
*FORM GET_MATNR_DATA TABLES   I_MATNR STRUCTURE ST_MATNR.
FORM GET_MATNR_DATA.

* ローカルデータ宣言
DATA:
LST_MATNR TYPE TYP_MATNR.

SELECT MARA~MATNR      "品目コード
**** START DEL 2015/07/17 ISID18 ****
*         MAKT~MAKTX      "品目テキスト
**** END DEL 2015/07/17 ISID18 ****
MARA~MTART      "品目タイプ
MARA~MATKL      "品目グループ
T023T~WGBEZ     "品目グループテキスト
MARA~MEINS      "基本数量単位
MARA~BSTME      "発注単位
MARA~NTGEW      "正味質量
MARA~STOFF      "危険物コード
MARA~SPART      "製品部門
MARA~PRDHA      "品目階層
* Append By Mis-Ohno
MARA~WRKST      "主構成物質
MARA~NORMT      "標準テキスト
* END Append
T179T~VTEXT     "品目階層テキスト
INTO CORRESPONDING FIELDS OF LST_MATNR
FROM MARA
**** START DEL 2015/07/17 ISID18 ****
*          INNER JOIN MAKT
*            ON MARA~MATNR = MAKT~MATNR
**** END DEL 2015/07/17 ISID18 ****
LEFT JOIN T023T
ON MARA~MATKL = T023T~MATKL
**** START ADD 2014/09/01 ISID･喩 ****
AND T023T~SPRAS = SY-LANGU
**** END ADD 2014/09/01 ISID･喩 ****
LEFT JOIN T179T
ON MARA~PRDHA = T179T~PRODH
**** START ADD 2014/09/01 ISID･喩 ****
AND T179T~SPRAS = SY-LANGU
**** END ADD 2014/09/01 ISID･喩 ****
WHERE MARA~MATNR = /A1F/YMNS0001-YM_MATNR.
**** START ADD 2014/09/01ISID･喩 ****
**** START DEL 2015/07/17 ISID18 ****
*            AND MAKT~SPRAS = SY-LANGU.
**** END DEL 2015/07/17 ISID18 ****
**** END ADD 2014/09/01 ISID･喩 ****
ENDSELECT.

IF SY-SUBRC = 0.
**** START DEL 2015/07/17 ISID18 ****
*    /A1F/YMNS0001-YM_MAKTX      = LST_MATNR-MAKTX.   "品目テキスト
**** END DEL 2015/07/17 ISID18 ****
/A1F/YMNS0001-YM_HNMKTYP    = LST_MATNR-MTART.   "品目タイプ
/A1F/YMNS0001-YM_MATKL      = LST_MATNR-MATKL.   "品目グループ
/A1F/YMNS0001-YM_MATKL_TEXT = LST_MATNR-WGBEZ.   "品目GRPテキスト
/A1F/YMNS0001-YM_MEINS      = LST_MATNR-MEINS.   "基本数量単位
/A1F/YMNS0001-YM_BSTME      = LST_MATNR-BSTME.   "発注単位
/A1F/YMNS0001-YM_NTGEW      = LST_MATNR-NTGEW.   "正味質量
/A1F/YMNS0001-YM_STOFF      = LST_MATNR-STOFF.   "危険物コード
**** START UPD 2015/05/29 ISID18 ****
*    /A1F/YMNS0001-SPART         = LST_MATNR-SPART.   "製品部門
IF /A1F/YMNS0001-SPART IS INITIAL.
/A1F/YMNS0001-SPART = LST_MATNR-SPART.
ENDIF.
**** END UPD 2015/05/29 ISID18 ****
/A1F/YMNS0001-YM_PRDHA      = LST_MATNR-PRDHA.   "品目階層
/A1F/YMNS0001-YM_PRDHA_TEXT = LST_MATNR-VTEXT.   "品目階層テキスト
* Append By Mis-Ohno
/A1F/YMNS0001-YM_WRKST      = LST_MATNR-WRKST.   "主構成物質
/A1F/YMNS0001-YM_NORMT      = LST_MATNR-NORMT.   "標準テキスト
* END Append
ENDIF.

IF NOT ( /A1F/YMNS0001-YM_MEINS IS INITIAL ).
* 基本数量単位（販売）
/A1F/YMNS0001-YM_MEINSS = /A1F/YMNS0001-YM_MEINS.
* 基本数量単位（発注）
/A1F/YMNS0001-YM_MEINSP = /A1F/YMNS0001-YM_MEINS.
ENDIF.

**** START ADD 2015/07/17 ISID18 ****
PERFORM GET_MAKTX_ACCOD_LANG
USING    /A1F/YMNS0001-YM_MATNR
CHANGING /A1F/YMNS0001-YM_MAKTX_LANG
/A1F/YMNS0001-YM_MAKTX
A1F_INIT_FLG_MAKTX.
**** END ADD 2015/07/17 ISID18 ****

ENDFORM.                    " GET_MATNR_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_MARM_DATA
*&---------------------------------------------------------------------*
*       品目数量単位情報取得
*----------------------------------------------------------------------*
FORM GET_MARM_DATA.

* ローカルデータ宣言
DATA:
LST_MARM TYPE TYP_MARM.

* 基本数量単位と発注単位が違うデータのみ取得
IF /A1F/YMNS0001-YM_BSTME NE /A1F/YMNS0001-YM_MEINS.
SELECT SINGLE
MEINH               "在庫単位の代替数量単位
UMREZ               "基本数量単位への換算分子
UMREN               "分母: 基本数量単位へ変換する場合
INTO LST_MARM
FROM MARM
WHERE MATNR = /A1F/YMNS0001-YM_MATNR
AND MEINH = /A1F/YMNS0001-YM_BSTME.

IF SY-SUBRC = 0.
* 基本数量単位と販売単位が同じ場合は画面に出力しない
*    /A1F/YMNS0001-YM_VRKME = LST_MARM-MEINH.    "販売数量単位
/A1F/YMNS0001-YM_UMRENP = LST_MARM-UMREN.   "分母（販売）
/A1F/YMNS0001-YM_UMREZP = LST_MARM-UMREZ.   "分子（販売）
ENDIF.
ENDIF.

ENDFORM.                    " GET_MARM_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_MARC_DATA
*&---------------------------------------------------------------------*
*       プラント情報取得
*----------------------------------------------------------------------*
FORM GET_MARC_DATA.

* ローカルデータ宣言
DATA:
LST_MARC TYPE TYP_MARC.

SELECT SINGLE
WEBAZ               "入庫処理日数
STAWN               "貿易: 統計品目コード/輸入コード番号
HERKL               "品目の原産国
**** START ADD 2015/07/17 ISID18 ****
LGPRO               "出庫保管場所
LGFSB               "外部調達保管場所
**** END ADD 2015/07/17 ISID18 ****
INTO LST_MARC
FROM MARC
WHERE MATNR = /A1F/YMNS0001-YM_MATNR   "品目コード
AND WERKS = /A1F/YMNS0001-WERKS.     "プラント

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_WEBAZ = LST_MARC-WEBAZ.       "入庫処理日数
/A1F/YMNS0001-YM_STAWN = LST_MARC-STAWN.       "HSコード
/A1F/YMNS0001-YM_HERKL = LST_MARC-HERKL.       "原産地
**** START ADD 2015/07/17 ISID18 ****
/A1F/YMNS0001-YM_LGFSB = LST_MARC-LGFSB.       "外部調達保管場所
/A1F/YMNS0001-YM_LGPRO = LST_MARC-LGPRO.       "出庫保管場所
**** END ADD 2015/07/17 ISID18 ****
ELSE.
MESSAGE E306(/A1F/YLMS0100) WITH /A1F/YMNS0001-YM_MATNR
/A1F/YMNS0001-WERKS.
ENDIF.
ENDFORM.                    " GET_MARC_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_MARD_DATA
*&---------------------------------------------------------------------*
*       保管場所情報取得
*----------------------------------------------------------------------*
FORM GET_MARD_DATA.

* ローカルデータ宣言
DATA:
LW_LGPBE TYPE MARD-LGPBE.

SELECT SINGLE
LGPBE                                  "棚番
INTO LW_LGPBE
FROM MARD
WHERE MATNR = /A1F/YMNS0001-YM_MATNR   "品目コード
AND WERKS = /A1F/YMNS0001-WERKS      "プラント
AND LGORT = /A1F/YMNS0001-LGORT.     "保管場所

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_LGPBE = LW_LGPBE.         "棚番
ENDIF.
ENDFORM.                    " GET_MARD_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_MBEW_DATA
*&---------------------------------------------------------------------*
*       品目評価情報取得
*----------------------------------------------------------------------*
FORM GET_MBEW_DATA.

* ローカルデータ宣言
DATA:
**** START ADD BY ISID REN 2015/08/18 ****
LW_VERPR TYPE /A1F/YMDE_VERPR, "金額
**** END ADD BY ISID REN 2015/08/18 ****
LST_MBEW TYPE TYP_MBEW.

SELECT VERPR                    "移動平均原価/期間単位価格
PEINH                    "価格単位
INTO LST_MBEW
UP TO 1 ROWS
FROM MBEW
WHERE MATNR = /A1F/YMNS0001-YM_MATNR    "品目コード
AND BWKEY = /A1F/YMNS0001-WERKS.      "プラント
ENDSELECT.

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_VERPR    = LST_MBEW-VERPR.     "移動平均原価
/A1F/YMNS0001-YM_PEINH    = LST_MBEW-PEINH.     "価格単位

**** START UPD BY ISID REN 2015/08/18 ****
*    IF /A1F/YMNS0001-YM_WAERS IS INITIAL.
** システム通貨取得
*      SELECT SINGLE
*             MWAER
*             INTO /A1F/YMNS0001-YM_WAERS
*             FROM T000
*             WHERE MANDT = SY-MANDT.
*    ENDIF.
*   通貨取得
SELECT SINGLE
WAERS      "通貨コード
INTO /A1F/YMNS0001-YM_WAERS
FROM T001  "会社コード
WHERE BUKRS = /A1F/YMNS0001-BUKRS.
**** END UPD BY ISID REN 2015/08/18 ****

* 小数点変換
* 移動平均原価(簡易)
*   /A1F/YMNS0001-YM_VERPR_CH = /A1F/YMNS0001-YM_VERPR * 100.
**** START UPD BY ISID REN 2015/08/18 ****
*    /A1F/YMNS0001-YM_VERPR_CH
*      = /A1F/YMNS0001-YM_VERPR * LST_MBEW-PEINH.
LW_VERPR = /A1F/YMNS0001-YM_VERPR * LST_MBEW-PEINH.
WRITE      LW_VERPR
TO /A1F/YMNS0001-YM_VERPR_CH
CURRENCY /A1F/YMNS0001-YM_WAERS.
**** END UPD BY ISID REN 2015/08/18 ****
ENDIF.

ENDFORM.                    " GET_MBEW_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_MVKE_DATA
*&---------------------------------------------------------------------*
*       販売情報取得
*----------------------------------------------------------------------*
FORM GET_MVKE_DATA.

* ローカルデータ宣言
DATA:
LST_MVKE TYPE TYP_MVKE,
LST_MARM TYPE TYP_MARM.

SELECT SINGLE
VRKME                 "販売単位
MVGR1                 "商品グループ
MVGR2                 "最終製品
MVGR3                 "商品分類
MVGR4                 "開発部販売実績
PRAT1                 "危険品区分
PRAT2                 "該非判定
* 2010/10/14 DMW2286品目グループ5 - start
MVGR5                 "ｲﾆｼｬﾙ(金型等)
* 2010/10/14 DMW2286品目グループ5 - end
INTO LST_MVKE
FROM MVKE
WHERE MATNR = /A1F/YMNS0001-YM_MATNR    "品目コード
AND VKORG = /A1F/YMNS0001-VKORG       "販売組織
AND VTWEG = /A1F/YMNS0001-VTWEG.      "流通チャネル

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_VRKME       = LST_MVKE-VRKME.  "単位（販売価格）
/A1F/YMNS0001-YM_MVGR1       = LST_MVKE-MVGR1.  "商品グループ
/A1F/YMNS0001-YM_MVGR2       = LST_MVKE-MVGR2.  "最終製品
/A1F/YMNS0001-YM_MVGR3       = LST_MVKE-MVGR3.  "商品分類
/A1F/YMNS0001-YM_KIHTBHBIJSK = LST_MVKE-MVGR4.  "開発部販売実績
/A1F/YMNS0001-PROD_ATT_1     = LST_MVKE-PRAT1.  "危険品区分
/A1F/YMNS0001-PROD_ATT_2     = LST_MVKE-PRAT2.  "該非判定
* 2010/10/14 DMW2286品目グループ5 - start
/A1F/YMNS0001-YM_INITIAL     = LST_MVKE-MVGR5.  "ｲﾆｼｬﾙ(金型等)
* 2010/10/14 DMW2286品目グループ5 - end

**** START ADD 2015/07/17 ISID18 ****
PERFORM GET_SALES_TEXT
USING    /A1F/YMNS0001-YM_MATNR
/A1F/YMNS0001-VKORG
/A1F/YMNS0001-VTWEG
CHANGING /A1F/YMNS0001-YM_HANBAI_LANG
/A1F/YMNS0001-YM_HANBAI_TEXT
A1F_INIT_FLG_HANBAI.
**** END ADD 2015/07/17 ISID18 ****
ENDIF.

* 基本数量単位と販売単位が違うデータのみ取得
IF /A1F/YMNS0001-YM_VRKME NE /A1F/YMNS0001-YM_MEINS.
SELECT SINGLE
MEINH               "在庫単位の代替数量単位
UMREZ               "基本数量単位への換算分子
UMREN               "分母: 基本数量単位へ変換する場合
INTO LST_MARM
FROM MARM
WHERE MATNR = /A1F/YMNS0001-YM_MATNR
AND MEINH = /A1F/YMNS0001-YM_VRKME.

IF SY-SUBRC = 0.
* 基本数量単位と販売単位が同じ場合は画面に出力しない
*      /A1F/YMNS0001-YM_VRKME = LST_MARM-MEINH.    "販売数量単位
/A1F/YMNS0001-YM_UMRENS = LST_MARM-UMREN.   "分母（販売）
/A1F/YMNS0001-YM_UMREZS = LST_MARM-UMREZ.   "分子（販売）
ENDIF.
ENDIF.


ENDFORM.                    " GET_MVKE_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_LIFNR_DATA
*&---------------------------------------------------------------------*
*       仕入先情報の取得
*----------------------------------------------------------------------*
FORM GET_LIFNR_DATA.

* ローカルデータ宣言
DATA:
LST_LIFNR TYPE TYP_LIFNR.

SELECT SINGLE
NAME1                                              "名称1
LOEVM                "削除フラグ
INTO LST_LIFNR
FROM LFA1
WHERE LIFNR = /A1F/YMNS0001-YM_LIFNR.

IF SY-SUBRC = 0.
IF LST_LIFNR-LOEVM = CNS_X.
MESSAGE E303(/A1F/YLMS0100) WITH
/A1F/YMNS0001-YM_LIFNR .
ELSE.
/A1F/YMNS0001-YM_SIRSKNM = LST_LIFNR-NAME1.           "名称1

ENDIF.
ENDIF.

ENDFORM.                    " GET_LIFNR_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_PO_OTHER
*&---------------------------------------------------------------------*
*       購買情報取得(BAPI以外)
*----------------------------------------------------------------------*
FORM GET_PO_DATA_OTHER.

* ローカルデータ宣言
DATA:
LW_INFNR TYPE EINA-INFNR.         "購買情報番号


* 購買情報取得
PERFORM GET_BAPI_PO_DATA CHANGING LW_INFNR.

* 購買テキスト情報取得
PERFORM GET_PO_TEXT USING LW_INFNR.



ENDFORM.                    " GET_PO_OTHER
*&---------------------------------------------------------------------*
*&      Form  GET_BAPI_PO_DATA
*&---------------------------------------------------------------------*
*       購買情報取得(BAPI)
*----------------------------------------------------------------------*
*      <--O_INFNR  購買情報番号
*----------------------------------------------------------------------*
FORM GET_BAPI_PO_DATA CHANGING O_INFNR TYPE EINA-INFNR.

* ローカルデータ宣言
DATA:
LTD_PO_OTHER TYPE TABLE OF TYP_PO_OTHER,
LST_PO_OTHER TYPE TYP_PO_OTHER.

SELECT EINA~INFNR                  "購買情報番号
EINE~ESOKZ                  "購買情報区分
EINE~EVERS                  "出荷指示
INTO TABLE LTD_PO_OTHER
FROM EINA
INNER JOIN EINE
ON EINE~INFNR = EINA~INFNR
WHERE EINA~MATNR = /A1F/YMNS0001-YM_MATNR  "品目コード
AND EINA~LIFNR = /A1F/YMNS0001-YM_LIFNR  "仕入先コード
AND EINA~LOEKZ = SPACE
AND EINE~LOEKZ = SPACE
**** START ADD 2014/08/27 ISID・喩 ****
AND EINE~EKORG = /A1F/YMNS0001-EKORG.
**** END ADD 2014/08/27 ISID・喩 ****

IF SY-SUBRC = 0.
LOOP AT LTD_PO_OTHER INTO LST_PO_OTHER.
O_INFNR = LST_PO_OTHER-INFNR.              "購買情報番号
IF LST_PO_OTHER-ESOKZ = CNS_3.
/A1F/YMNS0001-YM_SIRSKKBN1 = CNS_X.      "外注加工の場合
ENDIF.
IF NOT ( LST_PO_OTHER-EVERS IS INITIAL ).  "直送
/A1F/YMNS0001-YM_SIRSKKBN2 = CNS_X.
ENDIF.
ENDLOOP.
ELSE.
**** START UPD 2014/08/27 ISID･喩 ****
*    MESSAGE E314(06).
MESSAGE E314(06) WITH SPACE.
**** END UPD 2014/08/27 ISID･喩 ****
ENDIF.


ENDFORM.                    " GET_BAPI_PO_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_PO_TEXT
*&---------------------------------------------------------------------*
*       購買テキスト情報取得
*----------------------------------------------------------------------*
*      -->I_INFNR  購買情報番号
*----------------------------------------------------------------------*
FORM GET_PO_TEXT USING    I_INFNR TYPE EINA-INFNR.

* ローカルデータ宣言
DATA:
LTD_STXL TYPE TABLE OF TYP_STXL,
LST_STXL TYPE TYP_STXL.
DATA:
LW_INFNR TYPE STXL-TDNAME.                "検索条件
* テキスト取得テーブル
DATA:
LTD_INLINES TYPE TABLE OF TLINE,         "テキスト読込の第一行
LST_INLINES TYPE TLINE,
LTD_LINES TYPE TABLE OF TLINE,           "読込テキスト行
LTS_LINES TYPE TLINE.

* 購買情報番号を含む条件で検索'購買情報番号+'*''
CONCATENATE I_INFNR CNS_PERCENT INTO LW_INFNR.

* テキスト取得用情報取得
SELECT TDOBJECT                 "オブジェクト
TDNAME                   "名称
TDID                     "テキスト ID
TDSPRAS                  "言語キー
INTO TABLE LTD_STXL
FROM STXL
WHERE TDNAME LIKE LW_INFNR
**** START ADD 2014/09/01 ISID･喩 ****
AND TDSPRAS = SY-LANGU.
**** END ADD 2014/09/01 ISID･喩 ****

* 検索できなかった場合はテキスト取得いかない
CHECK SY-SUBRC = 0.

* 購買情報注記テキスト情報取得
READ TABLE LTD_STXL WITH KEY TDOBJECT = CNS_EINA
INTO LST_STXL.

* 検索できなかった場合はテキスト取得いかない
IF SY-SUBRC = 0.

PERFORM READ_TEXT_INLINE TABLES LTD_INLINES         "テキスト第一行
LTD_LINES           "テキスト行
USING  LST_STXL-TDID       "テキスト ID
LST_STXL-TDSPRAS    "言語キー
LST_STXL-TDNAME     "名称
LST_STXL-TDOBJECT.  "オブジェクト

* 取得したテキストを1行目と2行目に分解
READ TABLE LTD_INLINES INDEX 1 INTO LST_INLINES.
DELETE TABLE LTD_LINES FROM LST_INLINES.
READ TABLE LTD_LINES INDEX 1 INTO LTS_LINES.

* 購買情報注記1行目
/A1F/YMNS0001-YM_KUBIJUHUTYUK = LST_INLINES-TDLINE.
* 購買情報注記2行目
/A1F/YMNS0001-YM_KUBIJUHUTYUK2 = LTS_LINES-TDLINE.
ENDIF.

REFRESH:LTD_INLINES,
LTD_LINES.

* 購買情報テキスト情報取得
READ TABLE LTD_STXL WITH KEY TDOBJECT = CNS_EINE
INTO LST_STXL.

* 検索できなかった場合はテキスト取得いかない
IF SY-SUBRC = 0.

PERFORM READ_TEXT_INLINE TABLES LTD_INLINES         "テキスト第一行
LTD_LINES           "テキスト行
USING  LST_STXL-TDID       "テキスト ID
LST_STXL-TDSPRAS    "言語キー
LST_STXL-TDNAME     "名称
LST_STXL-TDOBJECT.  "オブジェクト

IF SY-SUBRC = 0.
* 購買情報テキスト
READ TABLE LTD_INLINES INDEX 1 INTO LST_INLINES.
/A1F/YMNS0001-YM_KUBUJUHUTEXT = LST_INLINES-TDLINE.
ENDIF.
ENDIF
.
ENDFORM.                    " GET_PO_TEXT
*&---------------------------------------------------------------------*
*&      Form  READ_TEXT_INLINE
*&---------------------------------------------------------------------*
*       汎用モジュールでの購買テキスト情報取得
*----------------------------------------------------------------------*
*      -->I_INLINES   テキスト第一行
*      -->I_LINES     テキスト行
*      -->I_TDID      テキスト ID
*      -->I_TDSPRAS   言語キー
*      -->I_TDNAME    名称
*      -->I_TDOBJECT  オブジェクト
*----------------------------------------------------------------------*
FORM READ_TEXT_INLINE TABLES   I_INLINES  STRUCTURE TLINE
I_LINES    STRUCTURE TLINE
USING    I_TDID     TYPE STXL-TDID
I_TDSPRAS  TYPE STXL-TDSPRAS
I_TDNAME   TYPE STXL-TDNAME
I_TDOBJECT TYPE STXL-TDOBJECT.

CALL FUNCTION CNS_READ_TEXT_INLINE
EXPORTING
ID                    = I_TDID        "テキスト ID
INLINE_COUNT          = CNS_1         "インラインテーブルの行数
LANGUAGE              = I_TDSPRAS     "言語
NAME                  = I_TDNAME      "テキスト名
OBJECT                = I_TDOBJECT    "オブジェクト
*   LOCAL_CAT             = ' '
* IMPORTING
*   HEADER                =
TABLES
INLINES               = I_INLINES     "テキスト第一行
LINES                 = I_LINES.      "読込テキスト行


ENDFORM.                    " READ_TEXT_INLINE
*&---------------------------------------------------------------------*
*&      Form  GET_LFM1_DATA
*&---------------------------------------------------------------------*
*       購買組織データ情報の取得
*----------------------------------------------------------------------*
FORM GET_LFM1_DATA.

* ローカルデータ宣言
DATA:
LST_LFM1 TYPE TYP_LFM1.

SELECT SINGLE
LOEVM                   "購買組織レベルの仕入先削除フラグ
WAERS                   "購買発注通貨
INTO LST_LFM1
FROM LFM1
WHERE LIFNR = /A1F/YMNS0001-YM_LIFNR   "仕入先コード
AND EKORG = /A1F/YMNS0001-EKORG.     "購買組織

IF SY-SUBRC = 0.
IF LST_LFM1-LOEVM = CNS_X.
MESSAGE E303(/A1F/YLMS0100) WITH
/A1F/YMNS0001-YM_LIFNR .
ELSE.
/A1F/YMNS0001-YM_PWAERS = LST_LFM1-WAERS.   "購買発注通貨

ENDIF.
ENDIF.


ENDFORM.                    " GET_LFM1_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_INFORECORD_DATA
*&---------------------------------------------------------------------*
*       購買情報取得
*----------------------------------------------------------------------*
FORM GET_INFORECORD_DATA.

* ローカルデータ宣言
DATA:
LTD_GENERAL  TYPE TABLE OF BAPIEINA,     "購買情報: 一般データ
LTD_PURCHORG TYPE TABLE OF BAPIEINE,     "購買情報: 購買組織データ
LTD_RETURN   TYPE TABLE OF BAPIRETURN,   "リターンメッセージ
LST_RETURN   TYPE BAPIRETURN,
**** START ADD 2014/08/27 ISID･喩 ****
LW_FLG       TYPE CHAR1.
**** END ADD 2014/08/27 ISID･喩 ****

DATA:
LCTR_LINE TYPE I.


CALL FUNCTION CNS_BAPI_INFORECORD_GETLIST
EXPORTING
VENDOR              = /A1F/YMNS0001-YM_LIFNR    "仕入先コード
MATERIAL            = /A1F/YMNS0001-YM_MATNR    "品目コード
*     MAT_GRP             =
*     VEND_MAT            =
*     VEND_PART           =
*     VEND_MATG           =
PURCH_ORG           = /A1F/YMNS0001-EKORG       "購買組織
*     INFO_TYPE           =
*     PLANT               =
*     PUR_GROUP           =
*     PURCHASINGINFOREC   =
*     DELETED_INFORECORDS = ' '
PURCHORG_DATA       = CNS_X
GENERAL_DATA        = CNS_X
TABLES
INFORECORD_GENERAL  = LTD_GENERAL             "一般データ
INFORECORD_PURCHORG = LTD_PURCHORG            "購買組織データ
RETURN              = LTD_RETURN.
**** START UPD 2014/08/27 ISID･喩 ****
*  IF SY-SUBRC = 0.
CLEAR: LW_FLG.

LOOP AT LTD_RETURN INTO LST_RETURN WHERE TYPE = 'A' OR TYPE = 'E'.
LW_FLG = 'X'.
EXIT.
ENDLOOP.

IF LW_FLG <> 'X'.
**** END UPD 2014/08/27 ISID･喩 ****
DESCRIBE TABLE LTD_GENERAL LINES LCTR_LINE.

CASE LCTR_LINE.
WHEN 0.
* 未取得
CLEAR:LTD_GENERAL.

WHEN 1.
* 購買情報: 一般データをセット
PERFORM SET_INFORECORD_GENERAL TABLES LTD_GENERAL.

WHEN OTHERS.
* 複数情報取得時エラー
MESSAGE W256(/A1F/YLMS0100) WITH
/A1F/YMNS0001-YM_MATNR
/A1F/YMNS0001-YM_LIFNR
LCTR_LINE.
ENDCASE.

* 購買情報: 購買組織データをセット
PERFORM SET_INFORECORD_PURCHORG TABLES LTD_PURCHORG.

ENDIF.

ENDFORM.                    " GET_INFORECORD_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_A017_DATA
*&---------------------------------------------------------------------*
*       価格情報(購買)取得
*----------------------------------------------------------------------*
FORM GET_A017_DATA.

* ローカルデータ宣言
DATA:
LW_KNUMH TYPE A017-KNUMH,
LW_DATAB TYPE A017-DATAB,
LW_DATBI TYPE A017-DATBI,
LST_KONP TYPE TYP_KONP,
LTD_KONM TYPE TABLE OF TYP_KONM,
LST_KONM TYPE TYP_KONM,
LW_SUBRC TYPE SY-SUBRC,
WL_ESOKZ TYPE A017-ESOKZ,
**** START ADD 2014/09/01 ISID･喩 ****
LW_WAERS TYPE WAERS,
LW_BAPICURR LIKE BAPICURR-BAPICURR .
**** END ADD 2014/09/01 ISID･喩 ****

IF /A1F/YMNS0001-YM_SIRSKKBN1 IS INITIAL.
WL_ESOKZ = '0'.
ELSE.
WL_ESOKZ = '3'.
ENDIF.

SELECT KNUMH DATAB DATBI                      "条件レコード番号
INTO (LW_KNUMH,LW_DATAB,LW_DATBI)
FROM A017
WHERE KAPPL = CNS_M                    "アプリケーション
AND LIFNR = /A1F/YMNS0001-YM_LIFNR   "仕入先勘定コード
AND MATNR = /A1F/YMNS0001-YM_MATNR   "品目コード
AND EKORG = /A1F/YMNS0001-EKORG      "購買組織
AND ESOKZ = WL_ESOKZ                 "購買情報区分
AND DATBI    >= SY-DATUM
AND DATAB    <= SY-DATUM.

ENDSELECT.

CHECK SY-SUBRC = 0.
/A1F/YMNS0001-YM_PDATAB = LW_DATAB.
/A1F/YMNS0001-YM_PDATBI = LW_DATBI.

* 条件情報取得
PERFORM GET_KONP_KONM TABLES   LTD_KONM
USING    LW_KNUMH
'M'
CHANGING LST_KONP
LW_SUBRC.
IF LW_SUBRC = 0.
/A1F/YMNS0001-YM_PSKONMS1 = LST_KONP-KONMS.  "数量単位(仕入)
/A1F/YMNS0001-YM_PSKMEIN1 = LST_KONP-KMEIN.  "単位(仕入)
/A1F/YMNS0001-YM_PSKPEIN1 = LST_KONP-KPEIN.  "価格単位(仕入)

* スケール数量と条件レート
LOOP AT LTD_KONM INTO LST_KONM.
CASE SY-TABIX.
WHEN 1.
/A1F/YMNS0001-YM_PSKSTBM1 = LST_KONM-KSTBM.    "スケール数量
/A1F/YMNS0001-YM_PSKBETR1 = LST_KONM-KBETR.    "条件レート
WHEN 2.
/A1F/YMNS0001-YM_PSKSTBM2 = LST_KONM-KSTBM.
/A1F/YMNS0001-YM_PSKBETR2 = LST_KONM-KBETR.
WHEN 3.
/A1F/YMNS0001-YM_PSKSTBM3 = LST_KONM-KSTBM.
/A1F/YMNS0001-YM_PSKBETR3 = LST_KONM-KBETR.
WHEN 4.
/A1F/YMNS0001-YM_PSKSTBM4 = LST_KONM-KSTBM.
/A1F/YMNS0001-YM_PSKBETR4 = LST_KONM-KBETR.
WHEN 5.
/A1F/YMNS0001-YM_PSKSTBM5 = LST_KONM-KSTBM.
/A1F/YMNS0001-YM_PSKBETR5 = LST_KONM-KBETR.
ENDCASE.
ENDLOOP.
ENDIF.

* 通貨が取得できなかった場合、%対応
IF /A1F/YMNS0001-YM_PWAERS IS INITIAL.
**** START ADD 2014/09/01 ISID･喩 ****
*    /A1F/YMNS0001-YM_PSKBETR1 = /A1F/YMNS0001-YM_PSKBETR1 * 100.
*    /A1F/YMNS0001-YM_PSKBETR2 = /A1F/YMNS0001-YM_PSKBETR2 * 100.
*    /A1F/YMNS0001-YM_PSKBETR3 = /A1F/YMNS0001-YM_PSKBETR3 * 100.
*    /A1F/YMNS0001-YM_PSKBETR4 = /A1F/YMNS0001-YM_PSKBETR4 * 100.
*    /A1F/YMNS0001-YM_PSKBETR5 = /A1F/YMNS0001-YM_PSKBETR5 * 100.

CLEAR: LW_WAERS,
LW_BAPICURR.

SELECT SINGLE WAERS
INTO LW_WAERS
FROM T001
WHERE BUKRS = /A1F/YMNS0001-BUKRS.

PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_PSKBETR1
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_PSKBETR1 = LW_BAPICURR.

CLEAR: LW_BAPICURR.
PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_PSKBETR2
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_PSKBETR2 = LW_BAPICURR.

CLEAR: LW_BAPICURR.
PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_PSKBETR3
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_PSKBETR3 = LW_BAPICURR.

CLEAR: LW_BAPICURR.
PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_PSKBETR4
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_PSKBETR4 = LW_BAPICURR.

CLEAR: LW_BAPICURR.
PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_PSKBETR5
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_PSKBETR5 = LW_BAPICURR.
**** END ADD 2014/09/01 ISID･喩 ****
ENDIF.


ENDFORM.                    " GET_A017_DATA
*&---------------------------------------------------------------------*
*&      Form  SET_INFORECORD_GENERAL
*&---------------------------------------------------------------------*
*       購買情報: 一般データをセット
*----------------------------------------------------------------------*
*      -->  I_GENERAL  購買情報: 一般データ
*----------------------------------------------------------------------*
FORM SET_INFORECORD_GENERAL TABLES   I_GENERAL STRUCTURE BAPIEINA.

* ローカルデータ宣言
DATA:
LST_GENERAL  TYPE BAPIEINA.

LOOP AT I_GENERAL INTO LST_GENERAL.
* 基本数量単位と発注単位が同じ場合は出力しない
IF NOT ( /A1F/YMNS0001-YM_VRKME IS INITIAL ).
/A1F/YMNS0001-YM_UMRENP = LST_GENERAL-CONV_DEN1.   "分母（発注）
/A1F/YMNS0001-YM_UMREZP = LST_GENERAL-CONV_NUM1.   "分子（発注）
ENDIF.
/A1F/YMNS0001-YM_INDLF  = LST_GENERAL-VEND_MAT.    "仕入先品目コード
/A1F/YMNS0001-YM_URZTP  = LST_GENERAL-CERT_TYPE.   "証明書区分

ENDLOOP.
ENDFORM.                    " SET_INFORECORD_GENERAL
*&---------------------------------------------------------------------*
*&      Form  SET_INFORECORD_PURCHORG
*&---------------------------------------------------------------------*
*       購買情報: 購買組織データをセット
*----------------------------------------------------------------------*
*      -->I_PURCHORG  text
*----------------------------------------------------------------------*
FORM SET_INFORECORD_PURCHORG TABLES   I_PURCHORG STRUCTURE BAPIEINE.

* ローカルデータ宣言
DATA:
LST_PURCHORG TYPE BAPIEINE,
**** START ADD 2014/09/01 ISID･喩 ****
LW_BAPICURR  LIKE BAPICURR-BAPICURR.
**** END ADD 2014/09/01 ISID･喩 ****

LOOP AT I_PURCHORG INTO LST_PURCHORG.
/A1F/YMNS0001-EKGRP     = LST_PURCHORG-PUR_GROUP.  "購買グループ
/A1F/YMNS0001-YM_MWSKZ  = LST_PURCHORG-TAX_CODE.   "税コード
/A1F/YMNS0001-YM_PKBETR = LST_PURCHORG-NET_PRICE.  "正味価格(仕入)
* 仕入価格：簡易入力用
**** START UPD 2014/09/01 ISID･喩 ****
*    /A1F/YMNS0001-YM_PKBETR_CH = /A1F/YMNS0001-YM_PKBETR * 100.
CLEAR: LW_BAPICURR.
PERFORM CONV_CURR_TO_EXTER USING /A1F/YMNS0001-YM_PWAERS
/A1F/YMNS0001-YM_PKBETR
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_PKBETR_CH = LW_BAPICURR.
**** END UPD 2014/09/01 ISID･喩 ****
/A1F/YMNS0001-YM_PKPEIN = LST_PURCHORG-PRICE_UNIT. "価格単位(仕入)
/A1F/YMNS0001-YM_PKMEIN = LST_PURCHORG-ORDERPR_UN. "単位(仕入)
/A1F/YMNS0001-YM_PDATAB = LST_PURCHORG-CREATED_AT. "有効開始(仕入)
/A1F/YMNS0001-YM_PDATBI = LST_PURCHORG-PRICE_DATE. "有効終了(仕入)
/A1F/YMNS0001-YM_APLFZ  = LST_PURCHORG-PLND_DELRY. "納入予定日数
ENDLOOP.

IF NOT ( /A1F/YMNS0001-EKGRP IS INITIAL ).
* 購買グループ→営業グループ
/A1F/YMNS0001-YM_VKGRP = /A1F/YMNS0001-EKGRP.
ENDIF.

ENDFORM.                    " SET_INFORECORD_PURCHORG
*&---------------------------------------------------------------------*
*&      Form  GET_KNVV_DATA
*&---------------------------------------------------------------------*
*       得意先マスタ: 販売データ取得
*----------------------------------------------------------------------*
FORM GET_KNVV_DATA.

* ローカルデータ宣言
DATA:
LW_WAERS TYPE KNVV-WAERS.

SELECT SINGLE
WAERS                                 "通貨コード
INTO LW_WAERS
FROM KNVV
WHERE KUNNR = /A1F/YMNS0001-YM_KUNNR  "得意先コード
AND VKORG = /A1F/YMNS0001-VKORG     "販売組織
AND VTWEG = /A1F/YMNS0001-VTWEG     "流通チャネル
AND SPART = /A1F/YMNS0001-SPART.    "製品部門

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_SWAERS = LW_WAERS.        "通貨（販売）
ELSE.
**** START ADD 2015/05/29 ISID18 ****
SELECT WAERS
UP TO 1 ROWS
INTO LW_WAERS
FROM KNVV
WHERE KUNNR = /A1F/YMNS0001-YM_KUNNR   "得意先コード
AND VKORG = /A1F/YMNS0001-VKORG      "販売組織
AND VTWEG = /A1F/YMNS0001-VTWEG.     "流通チャネル
ENDSELECT.
IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_SWAERS = LW_WAERS.   "通貨（販売）
ELSE.
**** END ADD 2015/05/29 ISID18 ****
MESSAGE E251(/A1F/YLMS0100) WITH
/A1F/YMNS0001-YM_KUNNR .
**** START ADD 2015/05/29 ISID18 ****
ENDIF.
**** END ADD 2015/05/29 ISID18 ****
ENDIF.

ENDFORM.                    " GET_KNVV_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_KNMT_DATA
*&---------------------------------------------------------------------*
*       得意先/品目情報取得
*----------------------------------------------------------------------*
FORM GET_KNMT_DATA.

* ローカルデータ宣言
DATA:
LTS_KNMT TYPE TYP_KNMT.


SELECT SINGLE
KNMT~KDMAT               "得意先品目コード
KNMT~POSTX               "得意先の品目テキスト
KNMT~VWPOS               "明細用途
KNA1~NAME1                                         "名称1
INTO LTS_KNMT
FROM KNMT
INNER JOIN KNA1
ON KNMT~KUNNR = KNA1~KUNNR
WHERE KNMT~VKORG = /A1F/YMNS0001-VKORG       "販売組織
AND KNMT~VTWEG = /A1F/YMNS0001-VTWEG       "流通チャネル
AND KNMT~KUNNR = /A1F/YMNS0001-YM_KUNNR    "得意先コード
AND KNMT~MATNR = /A1F/YMNS0001-YM_MATNR.   "品目コード

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_KDMAT = LTS_KNMT-KDMAT.       "客先型番
/A1F/YMNS0001-YM_POSTX = LTS_KNMT-POSTX.       "得意先品目テキスト
/A1F/YMNS0001-YM_TKISKNM = LTS_KNMT-NAME1.     "得意先名
IF NOT ( LTS_KNMT-VWPOS IS INITIAL ).
/A1F/YMNS0001-YM_TMPSRYHS = CNS_X.           "添付資料必須
ENDIF.
ELSE.
MESSAGE E150(/A1F/YLMS0100) WITH /A1F/YMNS0001-YM_KUNNR
/A1F/YMNS0001-YM_MATNR.
ENDIF.

ENDFORM.                    " GET_KNMT_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_CU_TEXT
*&---------------------------------------------------------------------*
*       得意先/品目情報テキスト情報取得
*----------------------------------------------------------------------*
FORM GET_CU_TEXT.

* ローカルデータ宣言
DATA:
LTD_CUINFO     TYPE TABLE OF BAPI_BUS3033_BOID,
LST_CUINFO     TYPE BAPI_BUS3033_BOID,
LTD_CUINFOTEXT TYPE TABLE OF BAPI_BUS3033_TLINEKOM_DISP,
LTS_CUINFOTEXT TYPE BAPI_BUS3033_TLINEKOM_DISP.

LST_CUINFO-SALESORG   = /A1F/YMNS0001-VKORG.      "販売組織
LST_CUINFO-DISTR_CHAN = /A1F/YMNS0001-VTWEG.      "流通チャネル
LST_CUINFO-CUSTOMER   = /A1F/YMNS0001-YM_KUNNR.   "得意先コード
LST_CUINFO-MATERIAL   = /A1F/YMNS0001-YM_MATNR.   "得意先名
APPEND LST_CUINFO TO LTD_CUINFO.


CALL FUNCTION CNS_BAPI_CUSTMATINFO_GET
TABLES
CUSTOMERMATERIALINFO       = LTD_CUINFO
*     CUSTOMERMATERIALINFODETAIL =
CUSTOMERMATERIALINFOTEXT   = LTD_CUINFOTEXT.  "伝票テキスト
*            RETURN =.

**** START DEL 2014/08/27 ISID･喩 ****
*  IF SY-SUBRC = 0.
**** END DEL 2014/08/27 ISID･喩 ****
* 出荷指示備考
READ TABLE LTD_CUINFOTEXT
WITH KEY TEXT_ID = CNS_0001
INTO LTS_CUINFOTEXT.

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_SKSJBKU = LTS_CUINFOTEXT-TEXT_LINE+2(132).
ENDIF.
* 商品名
READ TABLE LTD_CUINFOTEXT
WITH KEY TEXT_ID = CNS_0003
INTO LTS_CUINFOTEXT.

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_SUHNNAM = LTS_CUINFOTEXT-TEXT_LINE+2(132).
ENDIF.
* 用途
READ TABLE LTD_CUINFOTEXT
WITH KEY TEXT_ID = CNS_0004
INTO LTS_CUINFOTEXT.

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_YOUTO = LTS_CUINFOTEXT-TEXT_LINE+2(132).
ENDIF.
**** START DEL 2014/08/27 ISID･喩 ****
*  ENDIF.
**** END DEL 2014/08/27 ISID･喩 ****

ENDFORM.                    " GET_CU_TEXT
*&---------------------------------------------------------------------*
*&      Form  GET_A901_DATA
*&---------------------------------------------------------------------*
*       価格情報(販売)取得
*----------------------------------------------------------------------*
FORM GET_A901_DATA.
* ローカルデータ宣言
DATA:
LST_A901 TYPE TYP_A901,
LST_KONP TYPE TYP_KONP,
LTD_KONM TYPE TABLE OF TYP_KONM,
LST_KONM TYPE TYP_KONM,
LW_SUBRC TYPE SY-SUBRC,
**** START ADD 2014/08/29 ISID･喩 ****
LW_WAERS    TYPE WAERS,
LW_BAPICURR LIKE  BAPICURR-BAPICURR.
**** END ADD 2014/08/29 ISID･喩 ****

SELECT DATBI                                  "条件マスタ有効終了日
DATAB                                  "条件マスタ有効開始日
KNUMH                                  "条件レコード番号
INTO LST_A901
FROM A901
WHERE KAPPL    = CNS_V                    "アプリケーション
AND VTWEG    = /A1F/YMNS0001-VTWEG      "流通チャネル
AND SPART    = /A1F/YMNS0001-SPART      "製品部門
AND KUNNR    = /A1F/YMNS0001-YM_KUNNR   "得意先コード
AND ZZZKDMAT = /A1F/YMNS0001-YM_KDMAT   "客先型番
AND DATBI    >= SY-DATUM
AND DATAB    <= SY-DATUM
**** START ADD 2014/08/29 ISID･喩 ****
AND VKORGAU = /A1F/YMNS0001-VKORG.   "受注伝票の販売組織
**** END ADD 2014/08/29 ISID･喩 ****
ENDSELECT.

IF SY-SUBRC = 0.
/A1F/YMNS0001-YM_SDATAB = LST_A901-DATAB.      "有効開始（販売価格）
/A1F/YMNS0001-YM_SDATBI = LST_A901-DATBI.      "有効終了（販売価格）
ENDIF.

* 条件情報取得
PERFORM GET_KONP_KONM TABLES   LTD_KONM
USING    LST_A901-KNUMH
'S'
CHANGING LST_KONP
LW_SUBRC.
IF LW_SUBRC = 0.
/A1F/YMNS0001-YM_SKPEIN   = LST_KONP-KPEIN.  "価格単位(販売)
/A1F/YMNS0001-YM_SKMEIN   = LST_KONP-KMEIN.  "単位(販売)
/A1F/YMNS0001-YM_SSKONMS1 = LST_KONP-KONMS.  "数量単位(販売スケール)
/A1F/YMNS0001-YM_SSKMEIN1 = LST_KONP-KMEIN.  "単位(販売スケール)
/A1F/YMNS0001-YM_SSKPEIN1 = LST_KONP-KPEIN.  "価格単位(販売スケール)

* スケール数量と条件レート
LOOP AT LTD_KONM INTO LST_KONM.
CASE SY-TABIX.
WHEN 1.
/A1F/YMNS0001-YM_SKBETR = LST_KONM-KBETR.      "正味価格(販売)
* 販売価格：簡易入力用
*         /A1F/YMNS0001-YM_SKBETR_CH = /A1F/YMNS0001-YM_SKBETR * 100.
/A1F/YMNS0001-YM_SSKSTBM1 = LST_KONM-KSTBM.    "スケール数量
/A1F/YMNS0001-YM_SSKBETR1 = LST_KONM-KBETR.    "条件レート
WHEN 2.
/A1F/YMNS0001-YM_SSKSTBM2 = LST_KONM-KSTBM.    "スケール数量
/A1F/YMNS0001-YM_SSKBETR2 = LST_KONM-KBETR.    "条件レート
WHEN 3.
/A1F/YMNS0001-YM_SSKSTBM3 = LST_KONM-KSTBM.    "スケール数量
/A1F/YMNS0001-YM_SSKBETR3 = LST_KONM-KBETR.    "条件レート
WHEN 4.
/A1F/YMNS0001-YM_SSKSTBM4 = LST_KONM-KSTBM.    "スケール数量
/A1F/YMNS0001-YM_SSKBETR4 = LST_KONM-KBETR.    "条件レート

WHEN 5.
/A1F/YMNS0001-YM_SSKSTBM5 = LST_KONM-KSTBM.    "スケール数量
/A1F/YMNS0001-YM_SSKBETR5 = LST_KONM-KBETR.    "条件レート
ENDCASE.
ENDLOOP.
ENDIF.

* 通貨が取得できなかった場合、%対応
IF /A1F/YMNS0001-YM_SWAERS IS INITIAL.
**** START UPD 2014/09/01 ISID･喩 ****
*    /A1F/YMNS0001-YM_SSKBETR1 = /A1F/YMNS0001-YM_SSKBETR1 * 100.
*    /A1F/YMNS0001-YM_SSKBETR2 = /A1F/YMNS0001-YM_SSKBETR2 * 100.
*    /A1F/YMNS0001-YM_SSKBETR3 = /A1F/YMNS0001-YM_SSKBETR3 * 100.
*    /A1F/YMNS0001-YM_SSKBETR4 = /A1F/YMNS0001-YM_SSKBETR4 * 100.
*    /A1F/YMNS0001-YM_SSKBETR5 = /A1F/YMNS0001-YM_SSKBETR5 * 100.

SELECT SINGLE WAERS
INTO LW_WAERS
FROM T001
WHERE BUKRS = /A1F/YMNS0001-BUKRS.

CLEAR: LW_BAPICURR.

PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_SSKBETR1
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_SSKBETR1 = LW_BAPICURR.

CLEAR: LW_BAPICURR.

PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_SSKBETR2
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_SSKBETR2 = LW_BAPICURR.

CLEAR: LW_BAPICURR.

PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_SSKBETR3
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_SSKBETR3 = LW_BAPICURR.

CLEAR: LW_BAPICURR.

PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_SSKBETR4
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_SSKBETR4 = LW_BAPICURR.

CLEAR: LW_BAPICURR.

PERFORM CONV_CURR_TO_EXTER USING LW_WAERS
/A1F/YMNS0001-YM_SSKBETR5
CHANGING LW_BAPICURR.

/A1F/YMNS0001-YM_SSKBETR5 = LW_BAPICURR.
**** END UPD 2014/09/01 ISID･喩 ****
ENDIF.

ENDFORM.                    " GET_A901_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_KONP_KONM
*&---------------------------------------------------------------------*
*       条件情報取得
*----------------------------------------------------------------------*
*      -->I_KONM    条件 (一次元の数量スケール)情報
*      -->I_KNUMH   条件レコード番号
*      <--O_KONP    条件 (明細)情報
*      <--O_SUBRC   処理結果
*----------------------------------------------------------------------*
FORM GET_KONP_KONM TABLES   I_KONM STRUCTURE ST_KONM
USING    I_KNUMH TYPE A017-KNUMH
I_FLG   TYPE C
CHANGING O_KONP  TYPE TYP_KONP
O_SUBRC TYPE SY-SUBRC.

*DMW4785 2012.11.15 MIS INSERT START
DATA : A1F_WL_TMP_VALUE LIKE BAPICURR-BAPICURR .
CLEAR : A1F_WL_TMP_VALUE .
*DMW4785 2012.11.15 MIS INSERT END

* 条件 (明細)情報取得
SELECT KONMS                   "条件スケール単位
KPEIN                   "価格条件単位
KMEIN                   "条件単位
KBETR
INTO O_KONP
FROM KONP
WHERE KNUMH = I_KNUMH.
ENDSELECT.

IF I_FLG = 'M'.
*DMW4785 2012.11.15 MIS DELETE START
*    /A1F/YMNS0001-YM_PKBETR_CH = O_KONP-KBETR * 100.
*DMW4785 2012.11.15 MIS DELETE END
*DMW4785 2012.11.15 MIS INSERT START
**** START ADD 2014/08/27 ISID･喩 ****
CLEAR /A1F/YMNS0001-YM_PKBETR_CH .
**** END ADD 2014/08/27 ISID･喩 ****
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YMNS0001-YM_PWAERS
AMOUNT_INTERNAL = O_KONP-KBETR
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
**** START DEL 2014/08/27 ISID･喩 ****
*    IF SY-SUBRC = 0 .
**** END DEL 2014/08/27 ISID･喩 ****
/A1F/YMNS0001-YM_PKBETR_CH = A1F_WL_TMP_VALUE .
**** START DEL 2014/08/27 ISID･喩 ****
*    ELSE .
*      CLEAR /A1F/YMNS0001-YM_PKBETR_CH .
*    ENDIF .
**** END DEL 2014/08/27 ISID･喩 ****
*DMW4785 2012.11.15 MIS INSERT END
/A1F/YMNS0001-YM_PSKPEIN1  = O_KONP-KPEIN.
IF NOT /A1F/YMNS0001-YM_PSKPEIN1 IS INITIAL.
/A1F/YMNS0001-YM_PKBETR_CH =
/A1F/YMNS0001-YM_PKBETR_CH /
/A1F/YMNS0001-YM_PSKPEIN1.
ENDIF.
ELSEIF I_FLG = 'S'.
**** START ADD 2015/05/29 ISID18 ****
/A1F/YMNS0001-YM_SKBETR = O_KONP-KBETR.      "正味価格(販売)
**** END ADD 2015/05/29 ISID18 ****
*DMW4785 2012.11.15 MIS DELETE START
*    /A1F/YMNS0001-YM_SKBETR_CH = O_KONP-KBETR * 100.
*DMW4785 2012.11.15 MIS DELETE END
*DMW4785 2012.11.15 MIS INSERT START
**** START ADD 2014/08/27 ISID･喩 ****
CLEAR /A1F/YMNS0001-YM_SKBETR_CH .
**** END ADD 2014/08/27 ISID･喩 ****
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YMNS0001-YM_SWAERS
AMOUNT_INTERNAL = O_KONP-KBETR
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
**** START DEL 2014/08/27 ISID･喩 ****
*    IF SY-SUBRC = 0 .
**** END DEL 2014/08/27 ISID･喩 ****
/A1F/YMNS0001-YM_SKBETR_CH = A1F_WL_TMP_VALUE .
**** START DEL 2014/08/27 ISID･喩 ****
*    ELSE .
*      CLEAR /A1F/YMNS0001-YM_SKBETR_CH .
*    ENDIF .
**** END DEL 2014/08/27 ISID･喩 ****

*DMW4785 2012.11.15 MIS INSERT END
/A1F/YMNS0001-YM_SKPEIN = O_KONP-KPEIN.
/A1F/YMNS0001-YM_SKMEIN = O_KONP-KMEIN.
IF NOT /A1F/YMNS0001-YM_SKPEIN IS INITIAL.
/A1F/YMNS0001-YM_SKBETR_CH =
/A1F/YMNS0001-YM_SKBETR_CH /
/A1F/YMNS0001-YM_SKPEIN.
ENDIF.
ENDIF.

O_SUBRC = SY-SUBRC.

* 条件 (一次元の数量スケール)情報取得
SELECT KSTBM                   "条件スケール数量
KBETR                   "条件レート (条件金額/パーセント)
INTO TABLE I_KONM
FROM KONM
WHERE KNUMH = I_KNUMH.
O_SUBRC = SY-SUBRC.


ENDFORM.                    " GET_KONP_KONM
**** START ADD 2014/09/01 ISID･喩 ****
*&---------------------------------------------------------------------*
*&      Form  CHK_BUKRS
*&---------------------------------------------------------------------*
*       会社コードの関連チェック
*----------------------------------------------------------------------*
FORM CHK_BUKRS .

DATA: LW_BUKRS   TYPE BUKRS,
LW_VKORG   TYPE VKORG,
LW_EKORG   TYPE EKORG,
LW_WERKS   TYPE WERKS,
LW_LAND1   TYPE LAND1,
LW_KALSM   TYPE KALSM_D.

* 会社コードの存在チェック
SELECT SINGLE BUKRS
LAND1
INTO (LW_BUKRS, LW_LAND1)
FROM T001
WHERE BUKRS = /A1F/YMNS0001-BUKRS.

IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YMNS0001-BUKRS'.
MESSAGE E016(Z3) WITH /A1F/YMNS0001-BUKRS.
ENDIF.

SELECT SINGLE KALSM
INTO LW_KALSM
FROM T005
WHERE LAND1 = LW_LAND1.

/A1F/YMNS0001-KALSM = LW_KALSM.

* 会社コードの権限チェック
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD /A1F/YMNS0001-BUKRS
ID 'ACTVT' FIELD '03'.

IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YMNS0001-BUKRS'.
MESSAGE E015(Z3) WITH /A1F/YMNS0001-BUKRS.
ENDIF.

IF /A1F/YMNS0001-WERKS IS NOT INITIAL.
LW_WERKS = /A1F/YMNS0001-WERKS.

*   会社コードとプラントの関連チェック
CALL FUNCTION 'ZEG_ZZ_WERKS_CHK'
EXPORTING
IMPBUKRS           = /A1F/YMNS0001-BUKRS
IMPWERKS           = LW_WERKS
*       IMPRNGWERKS        =
*      IMPORTING
*        EXPWERKS           =
*       EXPTABRET          =
EXCEPTIONS
WERKS_NOT_EXIST    = 1
WERKS_NO_AUTHORITY = 2
WERKS_BUKRS_ERROR  = 3
OTHERS             = 4.
IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YMNS0001-WERKS'.
MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
ENDIF.

* 会社コードと販売組織の関連チェック
IF /A1F/YMNS0001-VKORG IS NOT INITIAL.
SELECT SINGLE VKORG
INTO LW_VKORG
FROM TVKO
WHERE BUKRS = /A1F/YMNS0001-BUKRS
AND VKORG = /A1F/YMNS0001-VKORG.

IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YMNS0001-BUKRS'.
MESSAGE E077(Z3) WITH /A1F/YMNS0001-BUKRS /A1F/YMNS0001-VKORG.
ENDIF.
ENDIF.

* 会社コードと購買組織の関連チェック
IF /A1F/YMNS0001-EKORG IS NOT INITIAL.
SELECT SINGLE EKORG
INTO LW_EKORG
FROM T024E
WHERE BUKRS = /A1F/YMNS0001-BUKRS
AND EKORG = /A1F/YMNS0001-EKORG.

IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YMNS0001-BUKRS'.
MESSAGE E078(Z3) WITH /A1F/YMNS0001-BUKRS /A1F/YMNS0001-EKORG.
ENDIF.
ENDIF.

ENDFORM.                    " CHK_BUKRS

*&---------------------------------------------------------------------*
*&      Form  CONV_CURR_TO_EXTER
*&---------------------------------------------------------------------*
*       外部金額へ変換
*----------------------------------------------------------------------*
*      -->P_WAERS         通貨
*      -->P_YM_PSKBETR1H  内部金額
*      <--P_LW_BAPICURR   外部金額
*----------------------------------------------------------------------*
FORM CONV_CURR_TO_EXTER  USING P_WAERS        TYPE WAERS
P_YM_PSKBETR1H TYPE /A1F/YMDE_VERPR
CHANGING P_LW_BAPICURR  TYPE BAPICURR-BAPICURR.

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = P_WAERS
AMOUNT_INTERNAL = P_YM_PSKBETR1H
IMPORTING
AMOUNT_EXTERNAL = P_LW_BAPICURR.

ENDFORM.                    " CONV_CURR_TO_EXTER
**** END ADD 2014//09/01 ISID･喩 ****
**** START ADD 2015/05/29 ISID18 ****
*&---------------------------------------------------------------------*
*&      Form  GET_MLAN_DATA
*&---------------------------------------------------------------------*
*       税分類情報取得
*----------------------------------------------------------------------*
FORM GET_MLAN_DATA .

DATA: LST_MLAN TYPE MLAN,
LW_ALAND TYPE MLAN-ALAND.

* 出荷国決定
PERFORM SET_DEPCOUNTRY
USING    /A1F/YMNS0001-VKORG
CHANGING LW_ALAND.

* 税分類取得
SELECT SINGLE * FROM MLAN
INTO LST_MLAN
WHERE MATNR = /A1F/YMNS0001-YM_MATNR
AND ALAND = LW_ALAND.

IF SY-SUBRC = 0.
/A1F/YMNS0001-TAXCLASS_1 = LST_MLAN-TAXM1.
ELSE.
CLEAR /A1F/YMNS0001-TAXCLASS_1.
ENDIF.

ENDFORM.                    " GET_MLAN_DATA
*&---------------------------------------------------------------------*
*&      Form  SET_DEPCOUNTRY
*&---------------------------------------------------------------------*
*       出荷国設定
*----------------------------------------------------------------------*
*      -->I_VKORG       販売組織
*      <--O_DEPCOUNTRY  出荷国
*----------------------------------------------------------------------*
FORM SET_DEPCOUNTRY
USING    I_VKORG      TYPE VKORG
CHANGING O_DEPCOUNTRY TYPE ALAND.

SELECT ADRC~COUNTRY
UP TO 1 ROWS
INTO O_DEPCOUNTRY
FROM TVKO AS TVKO
INNER JOIN ADRC AS ADRC
ON TVKO~ADRNR = ADRC~ADDRNUMBER
WHERE TVKO~VKORG = I_VKORG.
ENDSELECT.

ENDFORM.                    " SET_DEPCOUNTRY
**** END ADD 2015/05/29 ISID18 ****
**** START ADD 2015/07/17 ISID18 ****
*&---------------------------------------------------------------------*
*&      Form  GET_SALES_TEXT
*&---------------------------------------------------------------------*
*       販売テキスト取得
*----------------------------------------------------------------------*
*      -->I_MATNR  品目コード
*      -->I_VKORG  販売組織
*      -->I_VTWEG  流通チャンネル
*      -->I_LANGU  言語キー
*      <--O_TEXT   販売テキスト
*      <--O_FLAG   初回フラグ
*----------------------------------------------------------------------*
FORM GET_SALES_TEXT
USING    I_MATNR TYPE MATNR
I_VKORG TYPE MVKE-VKORG
I_VTWEG TYPE MVKE-VTWEG
CHANGING O_LANGU TYPE SY-LANGU
O_TEXT  TYPE TEXT100
O_FLAG  TYPE CHAR01.

DATA:
LTH_STXH   TYPE STXH,
LW_NAME    TYPE THEAD-TDNAME,
LTH_LINES  TYPE TLINE,
LTD_LINES  TYPE STANDARD TABLE OF TLINE.

LW_NAME+0(18) = I_MATNR.
LW_NAME+18(4) = I_VKORG.
LW_NAME+22(2) = I_VTWEG.

* Get Language
IF O_LANGU IS INITIAL AND
O_FLAG  IS INITIAL.
O_LANGU = SY-LANGU.
ENDIF.

CLEAR O_TEXT.
SELECT SINGLE *
FROM STXH
INTO LTH_STXH
WHERE TDOBJECT = CNS_MVKE
AND TDNAME   = LW_NAME
AND TDID     = CNS_0001
AND TDSPRAS  = O_LANGU.
IF SY-SUBRC <> 0.
IF O_FLAG IS INITIAL.
SELECT *
UP TO 1 ROWS
FROM STXH
INTO LTH_STXH
WHERE TDOBJECT = CNS_MVKE
AND TDNAME   = LW_NAME
AND TDID     = CNS_0001.
EXIT.
ENDSELECT.
IF SY-SUBRC = 0.
O_LANGU = LTH_STXH-TDSPRAS.
ELSE.
O_FLAG = ABAP_ON.
RETURN.
ENDIF.
ELSE.
O_FLAG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.
O_FLAG = ABAP_ON.

* Get text
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = CNS_0001
LANGUAGE                = O_LANGU
NAME                    = LW_NAME
OBJECT                  = CNS_MVKE
TABLES
LINES                   = LTD_LINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

CASE SY-SUBRC.
WHEN 0.
LOOP AT LTD_LINES INTO LTH_LINES.
CONCATENATE O_TEXT LTH_LINES-TDLINE
INTO O_TEXT.
ENDLOOP.
WHEN 4.
WHEN OTHERS.
MESSAGE ID SY-MSGID
TYPE 'E'
NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDCASE.

ENDFORM.                    " GET_SALES_TEXT
*&---------------------------------------------------------------------*
*&      Form  GET_MAKTX_ACCOD_LANG
*&---------------------------------------------------------------------*
*       品目テキスト取得
*----------------------------------------------------------------------*
*      -->I_MATNR  品目コード
*      <--O_LANGU  言語
*      <--O_MAKTX  品目テキスト
*      <--O_FLAG   初回フラグ
*----------------------------------------------------------------------*
FORM GET_MAKTX_ACCOD_LANG
USING    I_MATNR TYPE MAKT-MATNR
CHANGING O_LANGU TYPE MAKT-SPRAS
O_MAKTX TYPE MAKT-MAKTX
O_FLAG  TYPE CHAR01.

IF O_FLAG IS INITIAL AND
O_LANGU IS INITIAL.
O_LANGU = SY-LANGU.
ENDIF.

CLEAR O_MAKTX.
SELECT SINGLE MAKTX
INTO O_MAKTX
FROM MAKT
WHERE MATNR = I_MATNR
AND SPRAS = O_LANGU.
IF SY-SUBRC <> 0.
IF O_FLAG IS INITIAL.
SELECT MAKTX SPRAS
UP TO 1 ROWS
INTO (O_MAKTX, O_LANGU)
FROM MAKT
WHERE MATNR = I_MATNR.
EXIT.
ENDSELECT.
ENDIF.
ENDIF.
O_FLAG = ABAP_ON.

ENDFORM.                    " GET_MAKTX_ACCOD_LANG
**** END ADD 2015/07/17 ISID18 ****
