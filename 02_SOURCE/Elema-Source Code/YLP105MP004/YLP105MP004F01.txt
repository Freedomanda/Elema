*&---------------------------------------------------------------------*
*&  INCLUDE           /A1F/YLP105MP004F01                              *
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  A1Ff_GET_STOCK_INFO
*&---------------------------------------------------------------------*
*       在庫情報取得処理
*----------------------------------------------------------------------*
FORM A1F_GET_STOCK_INFO .

DATA : A1F_WL_ECRPES LIKE CRPES ,
A1F_WL_IMT61D LIKE MT61D .                         "#EC NEEDED
DATA : A1F_TL_MDPSX LIKE TABLE OF MDPS WITH HEADER LINE ,
A1F_TL_MDEZX LIKE TABLE OF MDEZ WITH HEADER LINE ,
A1F_TL_MDSUX LIKE TABLE OF MDSU WITH HEADER LINE ,
A1F_TL_PLAFM LIKE TABLE OF PLAF WITH HEADER LINE ,
A1F_TL_PLAFD LIKE TABLE OF PLAF WITH HEADER LINE ,
A1F_TL_MDFAM LIKE TABLE OF MDFA WITH HEADER LINE ,
A1F_TL_MDFAD LIKE TABLE OF MDFA WITH HEADER LINE ,
A1F_TL_MDRSM LIKE TABLE OF MDRS WITH HEADER LINE ,
A1F_TL_MDRSD LIKE TABLE OF MDRS WITH HEADER LINE .

IF /A1F/YLNS0011-YL_DWERK IS INITIAL
OR /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
EXIT .
ENDIF .

A1F_WL_ECRPES-KZUMT = 'X' .
*>>> ES-UP 課題№263 2013/01/25
CALL FUNCTION 'Z_PRE_MD_ABBL_REPORTING'.
*<<< ES-UP 課題№263 2013/01/25
* Mod ES-UP 2012/09/07 -->
*  CALL FUNCTION 'Y_MD_ABBL_REPORTING'
CALL FUNCTION 'MD_ABBL_REPORTING'
* Mod ES-UP 2012/09/07 <--
EXPORTING
EMATNR          = /A1F/YLNS0011-YL_MATNR_SALE
EWERKS          = /A1F/YLNS0011-YL_DWERK
ECRPES          = A1F_WL_ECRPES
IMPORTING
IMT61D          = A1F_WL_IMT61D
TABLES
MDPSX           = A1F_TL_MDPSX
MDEZX           = A1F_TL_MDEZX
MDSUX           = A1F_TL_MDSUX
PLAFM           = A1F_TL_PLAFM
PLAFD           = A1F_TL_PLAFD
MDFAM           = A1F_TL_MDFAM
MDFAD           = A1F_TL_MDFAD
MDRSM           = A1F_TL_MDRSM
MDRSD           = A1F_TL_MDRSD
EXCEPTIONS
ERROR_MATMASTER = 1
OTHERS          = 2.

IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.


IF SY-SUBRC <> 0.
MESSAGE E161(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK .
ENDIF.

* 手元在庫の設定
READ TABLE A1F_TL_MDPSX WITH KEY DELKZ = 'WB' .
IF SY-SUBRC = 0 .
/A1F/YLNS0011-YL_TMTZIK = A1F_TL_MDPSX-MNG01 .
ELSE .
MESSAGE E161(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK .
ENDIF .

CLEAR : /A1F/YLNS0011-YL_JTYUGUKI ,
/A1F/YLNS0011-YL_HTYUGUKI .
LOOP AT A1F_TL_MDPSX
WHERE KNTTP = SPACE.

* 受注数量合計の設定
IF A1F_TL_MDPSX-DELKZ = 'MB'      "出庫
OR A1F_TL_MDPSX-DELKZ = 'VC'   "指図
OR A1F_TL_MDPSX-DELKZ = 'VJ'   "納入
OR A1F_TL_MDPSX-DELKZ = 'WA' . "出庫
/A1F/YLNS0011-YL_JTYUGUKI = /A1F/YLNS0011-YL_JTYUGUKI
+ A1F_TL_MDPSX-MNG01 .
ENDIF .

* 発注数量合計の設定
IF A1F_TL_MDPSX-DELKZ = 'BE'      "購買発注明細日程計画行
OR A1F_TL_MDPSX-DELKZ = 'E1'   "外注発注
OR A1F_TL_MDPSX-DELKZ = 'LA'   "出荷通知
OR A1F_TL_MDPSX-DELKZ = 'MR'   "入出庫予定
OR A1F_TL_MDPSX-DELKZ = 'VH'   "得意先からの受託品/預託品の戻り
OR A1F_TL_MDPSX-DELKZ = 'VT'   "返品 (利用可能在庫確認)
OR A1F_TL_MDPSX-DELKZ = 'WE' . "入庫
/A1F/YLNS0011-YL_HTYUGUKI = /A1F/YLNS0011-YL_HTYUGUKI
+ A1F_TL_MDPSX-MNG01 .
ENDIF .

IF A1F_TL_MDPSX-DELKZ = 'RP' . "返品明細
/A1F/YLNS0011-YL_HTYUGUKI = /A1F/YLNS0011-YL_HTYUGUKI
- A1F_TL_MDPSX-MNG01 .
ENDIF .
ENDLOOP .

* 未引当在庫の計算
/A1F/YLNS0011-YL_MHKATZIK = /A1F/YLNS0011-YL_TMTZIK
+ /A1F/YLNS0011-YL_HTYUGUKI
- /A1F/YLNS0011-YL_JTYUGUKI .

* 総在庫数の計算
/A1F/YLNS0011-YL_SUZIKSU = /A1F/YLNS0011-YL_TMTZIK
+ /A1F/YLNS0011-YL_HTYUGUKI .

*  IF /A1F/YLNS0011-YL_VBELN IS INITIAL
*     AND /A1F/YLNS0011-YL_EBELN IS INITIAL .

* 発注後未引当在庫の計算
* 2009/10/26 照会時は発注後の引当数量は算出しない
* 発注後数量は未引き当て数量と同値にする
/A1F/YLNS0011-YL_HTYUGSU = /A1F/YLNS0011-YL_MHKATZIK.
*                           + /A1F/YLNS0011-YL_HTYUSU
*                           - /A1F/YLNS0011-YL_JTYUSU .

*  ENDIF .

ENDFORM.                    " A1F_GET_STOCK_INFO
*&---------------------------------------------------------------------*
*&      Form  a1f_get_initial_data
*&---------------------------------------------------------------------*
*       表示データ取得処理
*----------------------------------------------------------------------*
FORM A1F_GET_INITIAL_DATA .

*ローカル定義
DATA : A1F_TH_INLINES TYPE TLINE ,
A1F_TD_INLINES TYPE TABLE OF TLINE .

DATA : A1F_WL_NAME    TYPE THEAD-TDNAME.


IF NOT ( /A1F/YLNS0011-YL_TKISKCD IS INITIAL ) .
*   得意先名称取得
SELECT SINGLE
NAME1
INTO /A1F/YLNS0011-YL_TKISKNM
FROM KNA1
WHERE KUNNR = /A1F/YLNS0011-YL_TKISKCD .
IF SY-SUBRC <> 0 .
MESSAGE W097(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_TKISKCD .
*     得意先 &1 の名称が取得できません
ENDIF .

*   得意先マスタ：販売ビューの取得
SELECT SINGLE * FROM  KNVV
INTO A1F_WG_KNVV
WHERE  KUNNR  = /A1F/YLNS0011-YL_TKISKCD
AND  VKORG  = /A1F/YLNS0011-VKORG
AND  VTWEG  = /A1F/YLNS0011-VTWEG
AND  SPART  = /A1F/YLNS0011-SPART.
IF SY-SUBRC NE 0 .
MESSAGE W155(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD .
ENDIF .

*   品目マスタ：会計ビューの取得
SELECT * FROM  MBEW
INTO A1F_WG_MBEW
UP TO 1 ROWS
WHERE MATNR = /A1F/YLNS0011-YL_MATNR_SALE
AND BWKEY = /A1F/YLNS0011-YL_DWERK .
ENDSELECT .
IF SY-SUBRC NE 0 .
MESSAGE W158(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
ENDIF .

*   BAPIによる受注関連データの取得
CLEAR : A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM .

A1F_WG_ORDER_HEADER_IN_SIM-DOC_TYPE   = /A1F/YLNS0011-YL_AUART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_ORG  = /A1F/YLNS0011-VKORG .
A1F_WG_ORDER_HEADER_IN_SIM-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
A1F_WG_ORDER_HEADER_IN_SIM-DIVISION   = /A1F/YLNS0011-SPART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_GRP  = /A1F/YLNS0011-VKGRP .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_OFF  = /A1F/YLNS0011-VKBUR .
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = SY-DATUM .
ELSE .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
ENDIF .

CLEAR A1F_TG_ORDER_PARTNERS_SIM .
REFRESH A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'SP' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .
A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
*>>>【ES-UP】 課題№263 2013/01/25
*    A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = 1.
*<<<【ES-UP】 課題№263 2013/01/25
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CALL FUNCTION 'BAPI_SALESORDER_SIMULATE'
EXPORTING
ORDER_HEADER_IN     = A1F_WG_ORDER_HEADER_IN_SIM
CONVERT_PARVW_AUART = 'X'
IMPORTING
BILLING_PARTY       = A1F_WG_BILLING_PARTY_SIM
RETURN              = A1F_WG_RETURN_SIM
TABLES
ORDER_ITEMS_IN      = A1F_TG_ORDER_ITEMS_IN_SIM
ORDER_PARTNERS      = A1F_TG_ORDER_PARTNERS_SIM.

LOOP AT A1F_TG_MESSAGETABLE_SIM .
MESSAGE ID A1F_TG_MESSAGETABLE_SIM-ID
TYPE A1F_TG_MESSAGETABLE_SIM-TYPE
NUMBER A1F_TG_MESSAGETABLE_SIM-NUMBER
WITH A1F_TG_MESSAGETABLE_SIM-MESSAGE_V1
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V2
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V3
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V4 .
ENDLOOP .

*   与信金額（売上額）の取得
PERFORM A1F_EXIT_GET_SAUFT
CHANGING A1F_WG_BILLING_PARTY_SIM .

*   更新タイプの設定
/A1F/YLNS0011-YL_KUSNTYP = TEXT-100. "受注照会' .

*   明細カテゴリタイプの設定
CASE /A1F/YLNS0011-YL_MISIKTGRTYP .
WHEN A1F_CNS_PSTYV_2 OR
A1F_CNS_PSTYV_4 .
/A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110 . "個別購買発注' .
WHEN A1F_CNS_PSTYV_1 OR
A1F_CNS_PSTYV_3 .
/A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 . "在庫品' .
ENDCASE .

*   与信限度額の設定
**** START ADD 2014/11/13 ISID11 ****
*   与信通貨コード
SELECT SINGLE WAERS
INTO /A1F/YLNS0011-YL_YSNWAERS
FROM T014
WHERE KKBER = A1F_WG_BILLING_PARTY_SIM-C_CTR_AREA.
**** END ADD 2014/11/13 ISID11 ****
*   CRED_LIMIT 得意先与信限度額
/A1F/YLNS0011-YL_YSNGK = A1F_WG_BILLING_PARTY_SIM-CRED_LIMIT .
*   与信残高の設定
*   ORDER_VALS 与信限度チェックにおける売上金額合計
*   RCVBL_VALS 債権合計 (与信限度チェック用)
*   CRED_LIAB  与信限度チェックのための関連特殊仕訳債権額
/A1F/YLNS0011-YL_YSNZNDK = A1F_WG_BILLING_PARTY_SIM-CRED_LIMIT
- A1F_WG_BILLING_PARTY_SIM-ORDER_VALS
- A1F_WG_BILLING_PARTY_SIM-RCVBL_VALS
- A1F_WG_BILLING_PARTY_SIM-CRED_LIAB .

*   テキスト名作成(受注伝票用)
A1F_WL_NAME = /A1F/YLNS0011-YL_VBELN .

*   納品書備考の取得
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_NHN
A1F_CNS_OBJECT_VBBK
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_NUHNSYBKU = A1F_TH_INLINES-TDLINE .

*   社内備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SYNI
A1F_CNS_OBJECT_VBBK
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_SYNIBKU = A1F_TH_INLINES-TDLINE .

*   テキスト名作成(受注伝票明細用)
CONCATENATE /A1F/YLNS0011-YL_VBELN
A1F_CNS_NUMBER_S
INTO A1F_WL_NAME .

*   出荷指示備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SYK
A1F_CNS_OBJECT_VBBP
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_SYKSJBKU = A1F_TH_INLINES-TDLINE .
ENDIF .

IF NOT ( /A1F/YLNS0011-YL_SIRSKCD IS INITIAL ) .
*   仕入先名の取得
SELECT SINGLE
NAME1
INTO /A1F/YLNS0011-YL_SIRSKNM
FROM LFA1
WHERE LIFNR = /A1F/YLNS0011-YL_SIRSKCD .
IF SY-SUBRC <> 0 .
MESSAGE W094(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_SIRSKCD.
*     仕入先 &1 の名称が取得できません
ENDIF .

*   無商品判定
IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
/A1F/YLNS0011-YL_MSYUFLG = 'X' .
ELSE .
CLEAR /A1F/YLNS0011-YL_MSYUFLG .
ENDIF.

*   テキスト名作成(購買伝票用)
CONCATENATE /A1F/YLNS0011-YL_EBELN
A1F_CNS_NUMBER_P
INTO A1F_WL_NAME .

*   EDI用備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_EDI
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_EDIBKU = A1F_TH_INLINES-TDLINE .
CLEAR A1F_TH_INLINES.

READ TABLE A1F_TD_INLINES INDEX 2 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_EDIBKU2 = A1F_TH_INLINES-TDLINE .

*   EDI用その他の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SNT
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_EDISNT = A1F_TH_INLINES-TDLINE .

*   注文書用備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_TYMN
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_TUMNSYBKU = A1F_TH_INLINES-TDLINE .

*   住電EDI備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SMDN
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_SMDNEDIBKU = A1F_TH_INLINES-TDLINE .

*   発注残一覧備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_HTY
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_HTYUZNITRNBKU = A1F_TH_INLINES-TDLINE .
ENDIF.

ENDFORM.                    " a1f_get_initial_data
*&---------------------------------------------------------------------*
*&      Form  A1F_CALCULATION_SALES_AMOUNT
*&---------------------------------------------------------------------*
*       販売金額計算処理
*----------------------------------------------------------------------*
FORM A1F_CALCULATION_SALES_AMOUNT .

DATA : A1F_WL_T685A LIKE T685A .
DATA : A1F_WL_NETWR TYPE P DECIMALS 3 .

IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL
OR /A1F/YLNS0011-YL_TKISKCD IS INITIAL .
EXIT .
ENDIF .

DATA : A1F_WL_EXCH_RATE LIKE BAPI1093_0 ,
A1F_WL_RETURN_EXCH LIKE BAPIRET1 .

* 売上金額（国内通貨）
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_JTYTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
**** START UPD 2014/09/17 ISID11 ****
*  IF SY-SUBRC NE 0
*    OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
IF A1F_WL_RETURN_EXCH-TYPE = 'E' .
**** END UPD 2014/09/17 ISID11 ****
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
MESSAGE E202(/A1F/YLMS0100) WITH
A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_JTYTUK
/A1F/YLNS0011-YL_WAERS.
ENDIF .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK
* A1F_WL_EXCH_RATE-EXCH_RATE.

** 売上原価（伝票から取得するために不要となった）
*  IF NOT ( /A1F/YLNS0011-YL_JTYUSU IS INITIAL ) .
*   /A1F/YLNS0011-YL_URAGGNK = ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
*                                            * /A1F/YLNS0011-YL_JTYUSU.
*  ENDIF .

* 粗利
/A1F/YLNS0011-YL_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- /A1F/YLNS0011-YL_URAGGNK .

* 購買金額の計算
IF /A1F/YLNS0011-YL_MSYUFLG NE SPACE .
CLEAR /A1F/YLNS0011-YL_HTYUTNK .
ENDIF .

CLEAR A1F_WL_NETWR .
IF NOT ( /A1F/YLNS0011-YL_HTYUTNK IS INITIAL ) .
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_PEINH' .
MESSAGE E194(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_PEINH NE 100
AND /A1F/YLNS0011-YL_PEINH NE 1000
AND /A1F/YLNS0011-YL_PEINH NE 10000
AND /A1F/YLNS0011-YL_PEINH NE 1 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_PEINH' .
MESSAGE E195(/A1F/YLMS0100) .
ENDIF .
SELECT SINGLE * FROM  T685A
INTO A1F_WL_T685A
WHERE  KAPPL  = 'M'
AND    KSCHL  = A1F_CNS_KSCHL_P.
IF SY-SUBRC NE 0 .
MESSAGE E160(/A1F/YLMS0100) WITH A1F_CNS_KSCHL_P .
ENDIF .

IF A1F_WL_T685A-TXPRF = SPACE . "四捨五入
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) .
ELSEIF A1F_WL_T685A-TXPRF = 'A' . "切上
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) + '0.005' .
ELSEIF A1F_WL_T685A-TXPRF = 'B' . "切捨て
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) - '0.005' .
ENDIF .
ENDIF .

* 発注金額
/A1F/YLNS0011-YL_HTYUKNGK = A1F_WL_NETWR .

* 購買金額（国内通貨）
IF /A1F/YLNS0011-YL_HTYUTUK NE /A1F/YLNS0011-YL_WAERS
AND NOT ( /A1F/YLNS0011-YL_HTYUKNGK IS INITIAL ) .
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_HTYUTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
**** START UPD 2014/09/17 ISID11 ****
*    IF SY-SUBRC NE 0
*      OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
IF A1F_WL_RETURN_EXCH-TYPE = 'E' .
**** END UPD 2014/09/17 ISID11 ****
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK .
MESSAGE E202(/A1F/YLMS0100) WITH
A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_HTYUTUK
/A1F/YLNS0011-YL_WAERS.
ENDIF .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK
* A1F_WL_EXCH_RATE-EXCH_RATE.
ELSE .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK .
ENDIF .

DATA : A1F_WL_MARM LIKE MARM .

* 販売数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_VRKME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
/A1F/YLNS0011-YL_JTYUSU_C = /A1F/YLNS0011-YL_JTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    MEINH  = /A1F/YLNS0011-YL_VRKME .
IF SY-SUBRC NE 0 .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_VRKME.
ENDIF .

/A1F/YLNS0011-YL_JTYUSU_C = ( /A1F/YLNS0011-YL_JTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

* 購買数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_HTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME .
ENDIF .

/A1F/YLNS0011-YL_HTYUSU_C = ( /A1F/YLNS0011-YL_HTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " A1F_CALCULATION_SALES_AMOUNT
*&---------------------------------------------------------------------*
*&      Form  a1f_clear_all
*&---------------------------------------------------------------------*
*       画面項目初期化
*----------------------------------------------------------------------*
FORM A1F_CLEAR_ALL .

CLEAR : /A1F/YLNS0011-VKBUR,
/A1F/YLNS0011-VKGRP,
/A1F/YLNS0011-YL_DWERK,
/A1F/YLNS0011-EKGRP,
/A1F/YLNS0011-YL_AUART,
/A1F/YLNS0011-YL_BSTKD,
/A1F/YLNS0011-YL_KDMAT,
/A1F/YLNS0011-YL_POSTX,
/A1F/YLNS0011-YL_AUDAT,
/A1F/YLNS0011-YL_MATNR_SALE,
/A1F/YLNS0011-YL_MAKTX_SALE,
/A1F/YLNS0011-YL_JTYUSU,
/A1F/YLNS0011-YL_VDATU,
/A1F/YLNS0011-YL_KUSNTYP,
/A1F/YLNS0011-YL_MISIKTGRTYP,
/A1F/YLNS0011-YL_TKISKCD,
/A1F/YLNS0011-YL_SYKSKCD,
/A1F/YLNS0011-YL_VBELN,
**** START ADD 2014/11/13 ISID11 ****
/A1F/YLNS0011-YL_YSNWAERS,          "与信通貨
**** END ADD 2014/11/13 ISID11 ****
/A1F/YLNS0011-YL_YSNGK,
/A1F/YLNS0011-YL_YSNZNDK,
/A1F/YLNS0011-YL_TKISKNM,
/A1F/YLNS0011-YL_LIFSK,
/A1F/YLNS0011-YL_KPEIN,
/A1F/YLNS0011-YL_VRKME,
/A1F/YLNS0011-YL_JTYUTNK,
/A1F/YLNS0011-YL_JYYUKNGK,
/A1F/YLNS0011-YL_JTYTUK,
/A1F/YLNS0011-YL_URAGGNK,
/A1F/YLNS0011-YL_ARARI,
/A1F/YLNS0011-YL_SYKSJBKU,
/A1F/YLNS0011-YL_NUHNSYBKU,
/A1F/YLNS0011-YL_SYNIBKU,
/A1F/YLNS0011-YL_TMTZIK,
/A1F/YLNS0011-YL_JTYUGUKI,
/A1F/YLNS0011-YL_HTYUGUKI,
/A1F/YLNS0011-YL_SUZIKSU,
/A1F/YLNS0011-YL_HTYUGSU,
/A1F/YLNS0011-YL_MHKATZIK,
/A1F/YLNS0011-YL_MEINS,
/A1F/YLNS0011-YL_SIRSKCD,
/A1F/YLNS0011-YL_SIRSKNM,
/A1F/YLNS0011-YL_BEDAT,
/A1F/YLNS0011-YL_EEIND,
/A1F/YLNS0011-YL_HTYUNSKBN,
/A1F/YLNS0011-YL_EBELN,
/A1F/YLNS0011-YL_MATNR_PURC,
/A1F/YLNS0011-YL_MAKTX_PURC,
/A1F/YLNS0011-YL_IDNLF,
/A1F/YLNS0011-YL_TXZ01,
/A1F/YLNS0011-YL_HTYUSU,
/A1F/YLNS0011-YL_BSTME,
/A1F/YLNS0011-YL_HTYUTNK,
/A1F/YLNS0011-YL_HTYUKNGK,
/A1F/YLNS0011-YL_HTYUTUK,
/A1F/YLNS0011-YL_PEINH,
/A1F/YLNS0011-YL_EDIBKU,
/A1F/YLNS0011-YL_EDIBKU2,
/A1F/YLNS0011-YL_EDISNT,
/A1F/YLNS0011-YL_TUMNSYBKU,
/A1F/YLNS0011-YL_SMDNEDIBKU,
/A1F/YLNS0011-YL_HTYUZNITRNBKU ,
/A1F/YLNS0011-YL_MSYUFLG ,
/A1F/YLNS0011-YL_TYKSUKBN ,
/A1F/YLNS0011-YL_SYKSKNM ,
/A1F/YLNS0011-YL_TKISKHCDT .


CLEAR : A1F_WG_MBEW ,
A1F_WG_T001 ,
A1F_WG_KNVV ,
A1F_WG_ORDER_HEADER_IN_SIM ,
A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM .

CLEAR : A1F_TG_ORDER_ITEMS_IN_SIM ,
A1F_TG_ORDER_PARTNERS_SIM ,
A1F_TG_MESSAGETABLE_SIM .

REFRESH : A1F_TG_ORDER_ITEMS_IN_SIM ,
A1F_TG_ORDER_PARTNERS_SIM ,
A1F_TG_MESSAGETABLE_SIM .

CLEAR : A1F_WG_FES_ADDR1_COMPLETE ,
A1F_WG_FES_VBADR ,
A1F_WG_FEF_ATTRIBUTES ,
A1F_WG_ADDR1_OUT .

* パラメータIDクリア
PERFORM A1F_CLEAR_PARAMETER_ID .

ENDFORM.                    " a1f_clear_all
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_md04
*&---------------------------------------------------------------------*
*       在庫所要量一覧呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MD04 .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.

CALL TRANSACTION 'MD04' AND SKIP FIRST SCREEN .

ENDFORM.                    " a1f_call_tran_md04
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_mmbe
*&---------------------------------------------------------------------*
*       在庫状況照会呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MMBE .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD SPACE.
SET PARAMETER ID 'LAG' FIELD SPACE.
SET PARAMETER ID 'CHA' FIELD SPACE.

CALL TRANSACTION 'MMBE' AND SKIP FIRST SCREEN .

ENDFORM.                    " a1f_call_tran_mmbe
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_mb51
*&---------------------------------------------------------------------*
*       入出庫伝票一覧呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MB51 .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
SET PARAMETER ID 'LAG' FIELD SPACE.
SET PARAMETER ID 'CHA' FIELD SPACE.
SET PARAMETER ID 'LIF' FIELD SPACE.
SET PARAMETER ID 'KUN' FIELD SPACE.
SET PARAMETER ID 'BWA' FIELD SPACE.
SET PARAMETER ID 'USR' FIELD SPACE.
*>>> ES-UP 課題№263 2013/01/25
SET PARAMETER ID 'AUN' FIELD SPACE.
SET PARAMETER ID 'KPO' FIELD SPACE.
*<<< ES-UP 課題№263 2013/01/25

CALL TRANSACTION 'MB51' AND SKIP FIRST SCREEN .

ENDFORM.                    " a1f_call_tran_mb51
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_migo
*&---------------------------------------------------------------------*
*       発注伝票登録呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MIGO .

SET PARAMETER ID 'BSA' FIELD 'UB'.

CALL TRANSACTION 'ME21N' .

ENDFORM.                    " a1f_call_tran_migo
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_VA03
*&---------------------------------------------------------------------*
*       受注伝票照会呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_VA03 .

SET PARAMETER ID 'AUN' FIELD /A1F/YLNS0011-YL_VBELN.

CALL TRANSACTION 'VA03' AND SKIP FIRST SCREEN .

ENDFORM.                    " A1F_CALL_TRAN_VA03
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_ME23N
*&---------------------------------------------------------------------*
*       発注伝票照会呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_ME23N .

SET PARAMETER ID 'BES' FIELD /A1F/YLNS0011-YL_EBELN.

CALL TRANSACTION 'ME23N' .

ENDFORM.                    " A1F_CALL_TRAN_ME23N
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_SAUFT
*&---------------------------------------------------------------------*
*       与信金額（売上額）の取得
*----------------------------------------------------------------------*
*      <--P_A1F_WG_BILLING_PARTY_SIM  支払人情報
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_SAUFT
CHANGING P_BILLING_PARTY STRUCTURE BAPIPAYER.

IF NOT ( P_BILLING_PARTY-ORDER_VALS IS INITIAL ) .
EXIT .
ENDIF .

DATA A1F_WL_OLIKW LIKE S067-OLIKW .
CLEAR A1F_WL_OLIKW .
SELECT OLIKW FROM  S067
INTO A1F_WL_OLIKW
UP TO 1 ROWS
WHERE KKBER = P_BILLING_PARTY-C_CTR_AREA
AND KNKLI = P_BILLING_PARTY-CRED_ACCNT.
ENDSELECT .
IF SY-SUBRC = 0 .
P_BILLING_PARTY-ORDER_VALS = A1F_WL_OLIKW .
ELSE.
CLEAR P_BILLING_PARTY-ORDER_VALS .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_SAUFT
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_YMP120TC001
*&---------------------------------------------------------------------*
*       品目マスタメンテ呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_YMP120TC001.

CALL TRANSACTION 'ZMP1' .

ENDFORM.                    " A1F_CALL_TRAN_YMP120TC001
*&---------------------------------------------------------------------*
*&      Form  A1F_CHECK_AND_PICK_DATA
*&---------------------------------------------------------------------*
*       出荷先住所変更対応
*----------------------------------------------------------------------*

FORM A1F_CHECK_AND_PICK_DATA.

DATA: A1F_WL_CURSORFIELD(100).

GET CURSOR FIELD A1F_WL_CURSORFIELD.

IF A1F_WL_CURSORFIELD = '/A1F/YLNS0011-YL_SYKSKCD'
AND NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .

PERFORM A1F_POPUP_SYKSKDATA USING A1F_WL_ADRNR_SH.

ENDIF .

ENDFORM.                    " A1F_CHECK_AND_PICK_DATA
*&---------------------------------------------------------------------*
*&      Form  a1f_popup_sykskdata
*&---------------------------------------------------------------------*
*       出荷先住所変更対応
*----------------------------------------------------------------------*
*       --> アドレス番号
*----------------------------------------------------------------------*
FORM A1F_POPUP_SYKSKDATA  USING P_WL_ADRNR TYPE KNA1-ADRNR.

TYPES: BEGIN OF LV09A_ATTRIBUTES_SHOW_WA,
ABLAD TYPE XFLAG,
STCEG TYPE XFLAG,
STCD1 TYPE XFLAG,
STCD2 TYPE XFLAG,
STCD3 TYPE XFLAG,
STCD4 TYPE XFLAG,
STCDT TYPE XFLAG,
STKZN TYPE XFLAG,
J_1KFREPRE TYPE XFLAG,
J_1KFTBUS TYPE XFLAG,
J_1KFTIND TYPE XFLAG           .
TYPES: END OF LV09A_ATTRIBUTES_SHOW_WA.
DATA A1F_WL_FIF_ATTRIBUTES_S TYPE LV09A_ATTRIBUTES_SHOW_WA .

A1F_WL_FIF_ATTRIBUTES_S-ABLAD = 'X' .
A1F_WL_FIF_ATTRIBUTES_S-STCEG = 'X' .

CALL FUNCTION 'SD_PARTNER_ADDR_DIALOG_INTERN'
EXPORTING
FIF_ADDRESS_NUMBER           = P_WL_ADRNR
FIF_ADRDA                    = 'B'
FIF_ADDRESS_HANDLE_TO_CREATE = 'WE $0001'
FIF_ATTRIBUTES               = A1F_WG_FEF_ATTRIBUTES
FIF_ATTRIBUTES_SHOWN         = A1F_WL_FIF_ATTRIBUTES_S
FIF_TITLE_PARVW              = 'WE'
FIF_DISPLAY_ONLY             = 'X'
IMPORTING
FES_ADDR1_COMPLETE           = A1F_WG_FES_ADDR1_COMPLETE
FES_VBADR                    = A1F_WG_FES_VBADR
FEF_ATTRIBUTES               = A1F_WG_FEF_ATTRIBUTES
FES_NEW_ADDRESS              = A1F_WG_ADDR1_OUT
EXCEPTIONS
INTERNAL_ERROR               = 1
NO_ADDRESS                   = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " a1f_popup_sykskdata
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_VA01
*&---------------------------------------------------------------------*
*       受注伝票登録呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_VA01.

CALL TRANSACTION 'VA01' .

ENDFORM.                    " A1F_CALL_TRAN_VA01
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_CO06
*&---------------------------------------------------------------------*
*       バックオーダ呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_CO06.

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
SET PARAMETER ID 'PRR' FIELD SPACE.

CALL TRANSACTION 'CO06' AND SKIP FIRST SCREEN .

ENDFORM.                    " A1F_CALL_TRAN_CO06
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_ACCOUNT_ASSIGN
*&---------------------------------------------------------------------*
*       紐付け伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_ACCOUNT_ASSIGN.

* 受注伝票番号を入力されていた場合
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
*   購買伝票勘定設定から発注伝票番号を取得
SELECT EBELN                              "購買伝票番号
INTO /A1F/YLNS0011-YL_EBELN
FROM EKKN UP TO 1 ROWS                  "購買伝票勘定設定
WHERE VBELN = /A1F/YLNS0011-YL_VBELN     "販売管理伝票番号
AND VBELP = '000010'                   "販売伝票明細
AND VETEN = '0001' .                   "納入日程行
ENDSELECT.
IF SY-SUBRC <> 0 .
*     受注伝票のみの表示
CLEAR /A1F/YLNS0011-YL_EBELN .
ENDIF .
ENDIF .

* 発注伝票番号を入力されていた場合
IF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
*   購買伝票勘定設定から発注伝票番号を取得
SELECT SINGLE
VBELN                              "販売管理伝票番号
INTO /A1F/YLNS0011-YL_VBELN
FROM EKKN                               "購買伝票勘定設定
WHERE EBELN = /A1F/YLNS0011-YL_EBELN     "販売伝票番号
AND EBELP = '00010'                    "販売伝票明細番号
AND ZEKKN = '01'                       "勘定設定の連続番号
AND VBELN <> SPACE .                   "販売管理伝票番号
IF SY-SUBRC <> 0 .
*     発注伝票のみの表示
CLEAR /A1F/YLNS0011-YL_VBELN .
ENDIF .
ENDIF .

ENDFORM.                    " A1F_GET_ACCOUNT_ASSIGN
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_SALES_DATA
*&---------------------------------------------------------------------*
*       受注伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_SALES_DATA.

* 受注伝票情報取得
SELECT SINGLE
K~AUDAT                        "伝票日付 (受信日/送信日)
K~AUART                        "販売伝票タイプ
K~LIFSK                        "出荷ブロック (伝票ヘッダ)
K~VKORG                        "販売組織
K~VTWEG                        "流通チャネル
K~SPART                        "製品部門
K~VKGRP                        "営業グループ
K~VKBUR                        "営業所
K~VDATU                        "指定納入期日
K~BSTNK                        "得意先発注番号
K~BSTDK                        "得意先発注日付
K~KUNNR                        "受注先
P~PSTYV                        "取引タイプ
P~KDMAT                        "得意先品目コード
P~ARKTX                        "得意先品目テキスト
P~MATNR                        "品目コード
P~KWMENG                       "受注数量
P~VRKME                        "受注単位
P~KPEIN                        "Per
P~WAERK                        "受注通貨
P~NETWR                        "受注金額
P~NETPR                        "受注単価
P~WERKS                        "プラント
K~KNUMV                        "伝票条件番号
INTO (/A1F/YLNS0011-YL_AUDAT,       /A1F/YLNS0011-YL_AUART,
/A1F/YLNS0011-YL_LIFSK,       /A1F/YLNS0011-VKORG,
/A1F/YLNS0011-VTWEG,          /A1F/YLNS0011-SPART,
/A1F/YLNS0011-VKGRP,          /A1F/YLNS0011-VKBUR,
/A1F/YLNS0011-YL_VDATU,       /A1F/YLNS0011-YL_BSTKD,
/A1F/YLNS0011-YL_TKISKHCDT,   /A1F/YLNS0011-YL_TKISKCD,
/A1F/YLNS0011-YL_MISIKTGRTYP, /A1F/YLNS0011-YL_KDMAT,
/A1F/YLNS0011-YL_MAKTX_SALE,  /A1F/YLNS0011-YL_MATNR_SALE,
/A1F/YLNS0011-YL_JTYUSU,      /A1F/YLNS0011-YL_VRKME,
/A1F/YLNS0011-YL_KPEIN,       /A1F/YLNS0011-YL_JTYTUK,
/A1F/YLNS0011-YL_JYYUKNGK,    /A1F/YLNS0011-YL_JTYUTNK,
/A1F/YLNS0011-YL_DWERK,       A1F_WG_KNUMV_S)
FROM VBAK AS K
INNER JOIN VBAP AS P
ON K~VBELN = P~VBELN
WHERE K~VBELN = /A1F/YLNS0011-YL_VBELN
**** START ADD 2014/09/17 ISID11 ****
AND K~BUKRS_VF = /A1F/YLNS0011-BUKRS
**** END ADD 2014/09/17 ISID11 ****
AND P~POSNR = A1F_CNS_NUMBER_S.

IF SY-SUBRC <> 0 .
MESSAGE S099(/A1F/YLMS0100) .
*   受注情報が取得できません
EXIT .
ENDIF .

*DMW2762 得意先発注番号対応 2011.1.31 M.hasebe(MIS) - START
SELECT SINGLE BSTKD FROM VBKD INTO /A1F/YLNS0011-YL_BSTKD
WHERE VBELN = /A1F/YLNS0011-YL_VBELN .
*DMW2762 得意先発注番号対応 2011.1.31 M.hasebe(MIS) - E N D

DATA : A1F_WL_JTYUTNK_C(12) TYPE C .
DATA : A1F_WL_KWERT LIKE KONV-KWERT.

* 売上原価を取得
SELECT SINGLE KWERT FROM KONV
INTO A1F_WL_KWERT
WHERE KNUMV = A1F_WG_KNUMV_S
AND KPOSN = A1F_CNS_NUMBER_S
AND KSCHL = A1F_CNS_KSCHL_A.

/A1F/YLNS0011-YL_URAGGNK = A1F_WL_KWERT.

* 指定納期を取得
SELECT SINGLE EDATU FROM VBEP
INTO /A1F/YLNS0011-YL_VDATU
WHERE VBELN = /A1F/YLNS0011-YL_VBELN
AND POSNR = A1F_CNS_NUMBER_S
AND ETENR = '0001'
AND WMENG > 0.

*   品目テキストの取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
SELECT SINGLE MAKTX FROM  MAKT
INTO /A1F/YLNS0011-YL_POSTX
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    SPRAS  = SY-LANGU.
ENDIF .

* 受注伝票の取引先(出荷先)を取得
SELECT SINGLE
KUNNR
ADRNR
INTO (/A1F/YLNS0011-YL_SYKSKCD, A1F_WL_ADRNR_SH)
FROM VBPA
WHERE VBELN = /A1F/YLNS0011-YL_VBELN
AND POSNR = '000000'
AND PARVW = A1F_CNS_PARVW_SHIP .

IF SY-SUBRC <> 0 .
MESSAGE W096(/A1F/YLMS0100) .
*   出荷先の情報が取得できません
ENDIF .

* 基本数量単位の取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
PERFORM A1F_GET_MEINS USING    /A1F/YLNS0011-YL_MATNR_SALE
CHANGING /A1F/YLNS0011-YL_MEINS.
ENDIF .

ENDFORM.                    " A1F_GET_SALES_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PURCHASE_DATA
*&---------------------------------------------------------------------*
*       発注伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_PURCHASE_DATA.

* 発注伝票情報取得
SELECT SINGLE
K~LIFNR                  "仕入先勘定コード
K~EKORG                  "購買組織
K~EKGRP                  "購買グループ
K~WAERS                  "通貨コード
K~BEDAT                  "購買伝票日付
P~TXZ01                  "テキスト（短）
P~MATNR                  "品目コード
P~WERKS                  "プラント
P~IDNLF                  "仕入先の品目コード
P~MENGE                  "購買発注数量
P~MEINS                  "発注単位
P~NETPR                  "購買伝票における正味価格 (伝票通貨)
P~PEINH                  "価格単位
P~NETWR                  "購買発注通貨による正味発注額
P~EVERS                  "出荷指示
INTO (/A1F/YLNS0011-YL_SIRSKCD,    /A1F/YLNS0011-EKORG,
/A1F/YLNS0011-EKGRP,         /A1F/YLNS0011-YL_HTYUTUK,
/A1F/YLNS0011-YL_BEDAT,      /A1F/YLNS0011-YL_MAKTX_PURC,
/A1F/YLNS0011-YL_MATNR_PURC, /A1F/YLNS0011-YL_DWERK,
/A1F/YLNS0011-YL_IDNLF,      /A1F/YLNS0011-YL_HTYUSU,
/A1F/YLNS0011-YL_BSTME,      /A1F/YLNS0011-YL_HTYUTNK,
/A1F/YLNS0011-YL_PEINH,      /A1F/YLNS0011-YL_HTYUKNGK,
/A1F/YLNS0011-YL_TYKSUKBN)
FROM EKKO AS K
INNER JOIN EKPO AS P
ON K~EBELN = P~EBELN
WHERE K~EBELN = /A1F/YLNS0011-YL_EBELN
**** START ADD 2014/09/17 ISID11 ****
AND K~BUKRS = /A1F/YLNS0011-BUKRS
**** END ADD 2014/09/17 ISID11 ****
AND P~EBELP = A1F_CNS_NUMBER_P.

IF SY-SUBRC <> 0 .
MESSAGE S100(/A1F/YLMS0100).
*   発注情報が取得できません
EXIT .
ENDIF .

* 納入日程情報の取得
SELECT SINGLE
EINDT
INTO /A1F/YLNS0011-YL_EEIND
FROM EKET
WHERE EBELN = /A1F/YLNS0011-YL_EBELN
AND EBELP = A1F_CNS_NUMBER_P
AND ETENR = A1F_CNS_COUNTER.

IF SY-SUBRC <> 0 .
MESSAGE S095(/A1F/YLMS0100).
*   納入日程行情報が取得できません
EXIT .
ENDIF .

* 基本数量単位の取得
IF /A1F/YLNS0011-YL_MEINS IS INITIAL .
PERFORM A1F_GET_MEINS USING    /A1F/YLNS0011-YL_MATNR_PURC
CHANGING /A1F/YLNS0011-YL_MEINS.
ENDIF .

* 在庫情報用に受注側の品目コードに発注の品目コードをセット
IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
/A1F/YLNS0011-YL_MATNR_SALE = /A1F/YLNS0011-YL_MATNR_PURC .
ENDIF.

ENDFORM.                    " A1F_GET_PURCHASE_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_MEINS
*&---------------------------------------------------------------------*
*       基本数量単位取得処理
*----------------------------------------------------------------------*
*      -->P_/A1F/YLNS0011_YL_MATNR_SALE  品目コード
*      <--P_/A1F/YLNS0011_YL_MEINS       基本数量単位
*----------------------------------------------------------------------*
FORM A1F_GET_MEINS USING    P_MATNR  TYPE MARA-MATNR
CHANGING P_MEINS  TYPE MARA-MEINS.

SELECT SINGLE
MEINS
INTO P_MEINS
FROM MARA
WHERE MATNR = P_MATNR .

IF SY-SUBRC <> 0 .
MESSAGE W152(/A1F/YLMS0100) WITH P_MATNR.
*   品目コード &1 の品目マスタ：基本ビューが取得できません（マスターエラ
ENDIF .

ENDFORM.                    " A1F_GET_MEINS
*&---------------------------------------------------------------------*
*&      Form  A1F_READ_TEXT
*&---------------------------------------------------------------------*
*       テキスト読み込み処理
*----------------------------------------------------------------------*
*      -->P_INLINES  テキストデータ
*      -->P_ID       テキストID
*      -->P_OBJECT   テキストオブジェクト
*      -->P_NAME     テキスト名
*----------------------------------------------------------------------*
FORM A1F_READ_TEXT TABLES   P_INLINES  STRUCTURE TLINE
USING    P_ID       TYPE THEAD-TDID
P_OBJECT   TYPE THEAD-TDOBJECT
P_NAME     TYPE THEAD-TDNAME.

* テキスト読み込み
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = P_ID
LANGUAGE                = SY-LANGU
NAME                    = P_NAME
OBJECT                  = P_OBJECT
TABLES
LINES                   = P_INLINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.
IF SY-SUBRC <> 0.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " A1F_READ_TEXT
*&---------------------------------------------------------------------*
*&      Form  A1F_CLEAR_SALES_DATA
*&---------------------------------------------------------------------*
*       受注伝票情報初期化
*----------------------------------------------------------------------*
FORM A1F_CLEAR_SALES_DATA.

CLEAR : /A1F/YLNS0011-VKORG,                "販売組織
/A1F/YLNS0011-VTWEG,                "流通チャネル
/A1F/YLNS0011-SPART,                "製品部門
/A1F/YLNS0011-VKBUR,                "営業所
/A1F/YLNS0011-VKGRP,                "営業グループ
/A1F/YLNS0011-YL_DWERK,             "プラント
/A1F/YLNS0011-EKGRP,                "購買グループ
/A1F/YLNS0011-YL_AUART,             "受注タイプ
/A1F/YLNS0011-YL_BSTKD,             "得意先発注番号
/A1F/YLNS0011-YL_KDMAT,             "得意先品目コード
/A1F/YLNS0011-YL_POSTX,             "得意先品目テキスト
/A1F/YLNS0011-YL_AUDAT,             "受注日付
/A1F/YLNS0011-YL_MATNR_SALE,        "品目コード
/A1F/YLNS0011-YL_MAKTX_SALE,        "品目テキスト
/A1F/YLNS0011-YL_JTYUSU,            "受注数量
/A1F/YLNS0011-YL_VDATU,             "指定出荷日付
/A1F/YLNS0011-YL_KUSNTYP,           "更新タイプ
/A1F/YLNS0011-YL_MISIKTGRTYP,       "明細カテゴリタイプ
/A1F/YLNS0011-YL_TKISKCD,           "得意先コード
/A1F/YLNS0011-YL_SYKSKCD,           "出荷先コード
/A1F/YLNS0011-YL_VBELN,             "受注伝票番号
**** START ADD 2014/11/13 ISID11 ****
/A1F/YLNS0011-YL_YSNWAERS,          "与信通貨
**** END ADD 2014/11/13 ISID11 ****
/A1F/YLNS0011-YL_YSNGK,             "与信額
/A1F/YLNS0011-YL_YSNZNDK,           "与信残高
/A1F/YLNS0011-YL_TKISKNM,           "得意先名
/A1F/YLNS0011-YL_LIFSK,             "出荷ブロック
/A1F/YLNS0011-YL_KPEIN,             "Per
/A1F/YLNS0011-YL_VRKME,             "単位
/A1F/YLNS0011-YL_JTYUTNK,           "受注単価
/A1F/YLNS0011-YL_JYYUKNGK,          "受注金額
/A1F/YLNS0011-YL_JTYTUK,            "受注通貨
/A1F/YLNS0011-YL_URAGGNK,           "売上原価
/A1F/YLNS0011-YL_ARARI,             "粗利
/A1F/YLNS0011-YL_SYKSJBKU,          "出荷指示備考
/A1F/YLNS0011-YL_NUHNSYBKU,         "納品書備考
/A1F/YLNS0011-YL_SYNIBKU,           "社内備考
/A1F/YLNS0011-YL_TMTZIK,            "実在庫
/A1F/YLNS0011-YL_JTYUGUKI,          "受注数量
/A1F/YLNS0011-YL_HTYUGUKI,          "発注数量
/A1F/YLNS0011-YL_MHKATZIK,          "未引当在庫
/A1F/YLNS0011-YL_SUZIKSU,           "総在庫数量
/A1F/YLNS0011-YL_SYKSKNM,           "出荷先名
/A1F/YLNS0011-YL_TKISKHCDT.         "得意先発注日付

ENDFORM.                    " A1F_CLEAR_SALES_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_CLEAR_PURCHASE_DATA
*&---------------------------------------------------------------------*
*       発注伝票情報初期化
*----------------------------------------------------------------------*
FORM A1F_CLEAR_PURCHASE_DATA.

CLEAR :
/A1F/YLNS0011-EKORG,                "購買組織
/A1F/YLNS0011-EKGRP,                "購買グループ
/A1F/YLNS0011-YL_TMTZIK,            "実在庫
/A1F/YLNS0011-YL_JTYUGUKI,          "受注数量
/A1F/YLNS0011-YL_HTYUGUKI,          "発注数量
/A1F/YLNS0011-YL_MHKATZIK,          "未引当在庫
/A1F/YLNS0011-YL_SUZIKSU,           "総在庫数量
/A1F/YLNS0011-YL_SIRSKCD,           "仕入先コード
/A1F/YLNS0011-YL_SIRSKNM,           "仕入先名
/A1F/YLNS0011-YL_BEDAT,             "発注日付
/A1F/YLNS0011-YL_EEIND,             "納入日付
/A1F/YLNS0011-YL_EBELN,             "発注伝票番号
/A1F/YLNS0011-YL_MATNR_PURC,        "品目コード
/A1F/YLNS0011-YL_MAKTX_PURC,        "品目テキスト
/A1F/YLNS0011-YL_IDNLF,             "仕入先品目コード
/A1F/YLNS0011-YL_TXZ01,             "仕入先品目名
/A1F/YLNS0011-YL_HTYUSU,            "発注数量
/A1F/YLNS0011-YL_BSTME,             "発注単位
/A1F/YLNS0011-YL_HTYUTNK,           "発注単価
/A1F/YLNS0011-YL_HTYUKNGK,          "発注金額
/A1F/YLNS0011-YL_HTYUTUK,           "発注通貨
/A1F/YLNS0011-YL_PEINH,             "Per
/A1F/YLNS0011-YL_EDIBKU,            "EDI備考
/A1F/YLNS0011-YL_EDIBKU2,           "EDI備考(２行目)
/A1F/YLNS0011-YL_EDISNT,            "EDIその他
/A1F/YLNS0011-YL_TUMNSYBKU,         "注文書用備考
/A1F/YLNS0011-YL_SMDNEDIBKU,        "住電EDI備考
/A1F/YLNS0011-YL_HTYUZNITRNBKU ,    "発注残一覧備考
/A1F/YLNS0011-YL_MSYUFLG ,          "無償フラグ
/A1F/YLNS0011-YL_TYKSUKBN.          "直送区分

ENDFORM.                    " A1F_CLEAR_PURCHASE_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_VIEW
*&---------------------------------------------------------------------*
*       照会 <-> 変更 切り替え処理
*----------------------------------------------------------------------*
FORM A1F_VIEW.

* ローカル定義
DATA : A1F_WL_NUMBER  TYPE SY-TABIX .


* 引き渡しパラメータ判定
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
PERFORM  A1F_READ_ENQUEUE_NUM  USING    /A1F/YLNS0011-YL_VBELN
'VBAK'
CHANGING A1F_WL_NUMBER.
IF A1F_WL_NUMBER <> 0 .
MESSAGE S601(MC) WITH SY-UNAME.
*     要求オブジェクトは現在ユーザ & にロックされています
EXIT .
ENDIF .
SET PARAMETER ID 'ZVBN' FIELD /A1F/YLNS0011-YL_VBELN.
SET PARAMETER ID 'ZEBN' FIELD A1F_EBELN_INI.
ELSEIF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
PERFORM  A1F_READ_ENQUEUE_NUM  USING    /A1F/YLNS0011-YL_EBELN
'EKKO'
CHANGING A1F_WL_NUMBER.
IF A1F_WL_NUMBER <> 0 .
MESSAGE S601(MC) WITH SY-UNAME.
*     要求オブジェクトは現在ユーザ & にロックされています
EXIT .
ENDIF .
SET PARAMETER ID 'ZEBN' FIELD /A1F/YLNS0011-YL_EBELN.
SET PARAMETER ID 'ZVBN' FIELD A1F_VBELN_INI.
ELSE .
EXIT .
ENDIF .

LEAVE TO TRANSACTION 'ZLP2_LINK' .

ENDFORM.                                                    " A1F_VIEW
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_DATA_9000
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_GET_DATA_9000.

* 伝票番号の入力状況確認
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) AND
NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
MESSAGE E098(/A1F/YLMS0100) .
*   伝票番号は受注または発注のどちらか一つを入力してください
ENDIF .

* 紐付け伝票情報取得
PERFORM A1F_GET_ACCOUNT_ASSIGN .

* 受注伝票番号入力確認
IF /A1F/YLNS0011-YL_VBELN IS INITIAL .
*   受注伝票情報初期化
PERFORM A1F_CLEAR_SALES_DATA .
ELSE .
*   受注伝票情報取得
PERFORM A1F_GET_SALES_DATA .
ENDIF .

* 発注伝票番号入力確認
IF /A1F/YLNS0011-YL_EBELN IS INITIAL .
*   発注伝票情報初期化
PERFORM A1F_CLEAR_PURCHASE_DATA .
ELSE .
* 　発注伝票情報取得
PERFORM A1F_GET_PURCHASE_DATA .
ENDIF .

* 伝票番号がどちらも未入力の場合、基本数量単位を初期化
IF /A1F/YLNS0011-YL_VBELN IS INITIAL AND
/A1F/YLNS0011-YL_EBELN IS INITIAL .
CLEAR /A1F/YLNS0011-YL_MEINS .             "基本数量単位
ENDIF .

ENDFORM.                    " A1F_GET_DATA_9000
*&---------------------------------------------------------------------*
*&      Form  A1F_SET_PARAMETER_ID
*&---------------------------------------------------------------------*
*       パラメータID設定処理
*----------------------------------------------------------------------*
FORM A1F_SET_PARAMETER_ID.

SET PARAMETER ID 'ZVBN' FIELD /A1F/YLNS0011-YL_VBELN.
SET PARAMETER ID 'ZEBN' FIELD /A1F/YLNS0011-YL_EBELN.

ENDFORM.                    " A1F_SET_PARAMETER_ID
*&---------------------------------------------------------------------*
*&      Form  A1F_CLEAR_PARAMETER_ID
*&---------------------------------------------------------------------*
*       パラメータID初期化処理
*----------------------------------------------------------------------*
FORM A1F_CLEAR_PARAMETER_ID.

* パラメータIDクリア
SET PARAMETER ID 'ZEBN' FIELD A1F_EBELN_INI.
SET PARAMETER ID 'ZVBN' FIELD A1F_VBELN_INI.

ENDFORM.                    " A1F_CLEAR_PARAMETER_ID
*&---------------------------------------------------------------------*
*&      Form  A1F_READ_ENQUEUE_NUM
*&---------------------------------------------------------------------*
*       ロック件数確認処理
*----------------------------------------------------------------------*
*      -->P_DATA_NUM  伝票番号
*      -->P_GNAME     テーブル名
*      <--P_NUMBER    件数
*----------------------------------------------------------------------*
FORM A1F_READ_ENQUEUE_NUM USING    P_DATA_NUM  TYPE ANY
P_GNAME     TYPE SEQG3-GNAME
CHANGING P_NUMBER    TYPE SY-TABIX .

* ローカル定義
DATA : A1F_WL_GARG  TYPE SEQG3-GARG ,
A1F_TL_ENQ   TYPE STANDARD TABLE OF SEQG3.


* キー項目編集
CONCATENATE  SY-MANDT P_DATA_NUM
INTO  A1F_WL_GARG .

* ロック件数取得
CALL FUNCTION 'ENQUEUE_READ'
EXPORTING
GNAME  = P_GNAME
GARG   = A1F_WL_GARG
IMPORTING
NUMBER = P_NUMBER
TABLES
ENQ    = A1F_TL_ENQ.
IF SY-SUBRC <> 0.
*   MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*           WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " A1F_READ_ENQUEUE_NUM
**** START ADD 2014/09/17 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  A1F_CHK_BUKRS_INPUT
*&---------------------------------------------------------------------*
*       画面更新、会社コード変更の場合、チェックを処理する
*----------------------------------------------------------------------*
*  -->  P_BUKRS        会社コード
*----------------------------------------------------------------------*
FORM A1F_CHK_BUKRS_INPUT USING P_BUKRS TYPE /A1F/YLNS0011-BUKRS.
DATA:
A1F_WL_VKORG TYPE TVKO-VKORG,
A1F_WL_EKORG TYPE T024E-EKORG.

* 選択画面の会社コードの存在チェックを行う
* PBO初めで処理同じ
SELECT SINGLE * FROM  T001
INTO A1F_WG_T001
WHERE  BUKRS  = /A1F/YLNS0011-BUKRS.
IF SY-SUBRC <> 0 .
SET CURSOR FIELD '/A1F/YLNS0011-BUKRS'.
MESSAGE E200(/A1F/YLMS0100) WITH /A1F/YLNS0011-BUKRS .
*   システムエラー：会社コードデータ（&1）が取得できませんでした。
ENDIF .
* 国内通貨を格納
/A1F/YLNS0011-YL_WAERS = A1F_WG_T001-WAERS .

* 選択画面の会社コードの権限チェックを行う
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD /A1F/YLNS0011-BUKRS          "対象会社コード
ID 'ACTVT' FIELD '03'.
IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YLNS0011-BUKRS'.
MESSAGE E015(Z3) WITH /A1F/YLNS0011-BUKRS.
*   会社コード & では実行する権限がありません。
ENDIF.
ENDFORM.                    " A1F_CHK_BUKRS_INPUT
**** END ADD 2014/09/17 ISID11 ****
