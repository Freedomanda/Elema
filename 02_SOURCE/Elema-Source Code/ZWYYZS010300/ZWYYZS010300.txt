************************************************************************
* [プログラム名]
*   ZS010300        出荷指示リスト
*
* [処理概要]
*   ・品揃えの指示及び確認
*   ・出荷登録済・未出庫データの確認
*
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2002/01/10   PSD H.Tanaka      新規開発
*  2002/01/15   PSD C.YAMAGUCHI   改定
*  2002/01/22   PSD C.YAMAGUCHI   仕様変更（追加項目）
*  2002/01/29   PSD C.YAMAGUCHI   仕様変更（追加項目）
*  2002/02/01   PSD C.YAMAGUCHI   バグ修正（追加項目）
*  2002/03/01   PSD T.SAITOH      仕様変更400-SD-02：未出荷数計算式変更
*  2002/03/14   PSD T.SAITOH      テキスト修正
*  2002/04/05   PSD T.SAITOH      NAST更新エラー時メッセージ追加
*  2002/04/05   PSD T.SAITOH      NAST更新時更新項目追加
*  2002/04/05   PSD T.SAITOH      NASTオブジェクトキーが明細レベルの時
*                                 処理対象外とする。
*  2002/05/01   PSD K.Arai        出荷指示備考項目セットデータ修正
*  2002/05/07   PSD K.Arai        再出力処理機能追加
*  2002/05/09   PSD T.SAITOH      得意先解答納期取得方法変更
*  2002/06/11   PSD T.SAITOH      得意先品目テキスト追加
*  2002/06/20   PSD T.SAITOH      再移送
*  2002/06/21   PSD T.SAITOH      得意先品目テキスト変更
*  2002/06/25   PSD T.SATIOH      販売伝票カテゴリ'H'を返品伝票と判断
*  2002/07/14   PSD T.SAITOH      得意先発注伝票（３５桁）取得元変更
*  2002/07/17   PSD T.SAITOH      READ_TEXT エラーハンドリング対応
*  2002/07/25   PSD T.SAITOH      入力チェック修正
*  2002/07/30   PSD T.SAITOH      ロック条件変更、メッセージ変更
*  2002/07/31   PSD T.SAITOH      流通チャネル／製品部門　参照場所変更
*  2002/07/31   PSD T.SAITOH      納入区域:得意先機能：受注先→出荷先:変
*  2002/08/01   PSD T.SAITOH      得意先ＣＤの０をサプレイス、と小数点対
*  2002/08/08   カットオーバー ---------------------------------------*
*  2002/08/08   PSD T.SAITOH          ページ番号付加
*  2002/09/20   PSD T.SAITOH      納品書種別を追加
*  2003/01/17   NDSC ABE          得意先発注日を追加
*  2003/04/30   NDSC S.IWAKI      パフォーマンス対応
*  2004/04/21   NDSC A.MASUDA     出力項目新規追加
*  2005/06/16   DMC  S.MIKAMI     伝票抽出条件変更
*  2005/09/22   NDSC S.SHIGEMITU  出力項目新規追加
*  2005/09/23   DMC  R.HATA       パフォーマンス対応
*  2010/03/26   SOLFIS R.HATA     預託品対応
************************************************************************
REPORT  ZWYYZS010300 NO STANDARD PAGE HEADING.   "標準ヘッダーなし
*---------------------------------------------------------------------
* TYPES
*---------------------------------------------------------------------
*--- ALV用のデータ型
TYPE-POOLS SLIS.

*--- ＮＡＳＴオブジェクトキーデータ型
TYPES: BEGIN OF  TYP_NAST,
OBJKY     TYPE NAST-OBJKY,       " オブジェクトキー
END   OF  TYP_NAST.

*--- 出荷伝票データ型
TYPES: BEGIN OF  TYP_INFO,
VBELN     TYPE LIKP-VBELN,       " 出荷伝票
VSTEL     TYPE LIKP-VSTEL,       " 出荷ポイント
*---MODIFY START DMC S.MIKAMI 2005/06/16 ---------------------------*
*         LFDAT     TYPE LIKP-LFDAT,       " 納入期日
VDATU     TYPE VBAK-VDATU,       " 納入期日
*---MODIFY END   DMC S.MIKAMI 2005/06/16 ---------------------------*
KUNNR     TYPE LIKP-KUNNR,       " 得意先CD
WADAT     TYPE LIKP-WADAT,       " 出庫日
POSNR     TYPE LIPS-POSNR,       " 出荷伝票明細
PSTYV     TYPE LIPS-PSTYV,       " 明細カテゴリ
MATNR     TYPE LIPS-MATNR,       " 品目CD
KDMAT     TYPE LIPS-KDMAT,       " 得意先品目CD
LFIMG     TYPE LIPS-LFIMG,       " 出荷数量
VRKME     TYPE LIPS-VRKME,       " 販売単位
VKGRP     TYPE LIPS-VKGRP,       " 営業GP
LGPBE     TYPE LIPS-LGPBE,       " 棚番
VGBEL     TYPE LIPS-VGBEL,       " 受注番号
VGPOS     TYPE LIPS-VGPOS,       " 参照明細
**** START ADD 2015/11/16 ISID21 ****
KCMENG   TYPE LIPS-KCMENG,    " 累積ロット数量
**** END ADD 2015/11/16 ISID21 ****
END   OF  TYP_INFO.

*--- 販売伝票取引先データ型
TYPES: BEGIN OF  TYP_VBPA,
VBELN     TYPE VBPA-VBELN,       " 販売伝票
POSNR     TYPE VBPA-POSNR,       " 明細（ＳＤ）
PERNR     TYPE VBPA-PERNR,       " 従業員番号
LZONE     TYPE VBPA-LZONE,       " 納入区域
END   OF  TYP_VBPA.

*--- 販売伝票
TYPES : BEGIN OF VB_TABLE,
VKGRP      TYPE VBAK-VKGRP,     " 営業GP
VKBUR      TYPE VBAK-VKBUR,     " 営業所
BSTNK      TYPE VBAK-BSTNK,     " 得意先発注番号
VBTYP      TYPE VBAK-VBTYP,     " 伝票カテゴリ

*---APPEND START NDSC S.SHIGEMITU 2005/09/22 alv_st--------------------*
AUART      TYPE VBAK-AUART,     " 販売伝票タイプ
*---APPEND END   NDSC S.SHIGEMITU 2005/09/22 --------------------------*

AUDAT      TYPE VBAK-AUDAT,     " 受注日
*          KUNNR      TYPE VBAK-KUNNR,     " 受注先
WAERK      TYPE VBAP-WAERK,     " 通貨コード
VBELN      TYPE VBAP-VBELN,     " 販売伝票
POSNR      TYPE VBAP-POSNR,     " 販売伝票明細
ARKTX      TYPE VBAP-ARKTX,     " 得意先品目TX
KWMENG     TYPE VBAP-KWMENG,    " 受注数量
PSTYV      TYPE VBAP-PSTYV,     " 明細カテゴリ
WAVWR      TYPE VBAP-WAVWR,     " 原価金額
*          STCUR      TYPE VBAP-STCUR,     " 換算レート
NETPR      TYPE VBAP-NETPR,     " 受注単価
*--- 2002/02/01 PSD C.YAMAGUCHI MOD ↓
*    価格条件単価取得追加
KPEIN      TYPE VBAP-KPEIN,     " 価格条件単価
*--- 2002/02/01 PSD C.YAMAGUCHI MOD ↑
END   OF VB_TABLE.

*     個人データ情報
TYPES : BEGIN OF PA0002_TABLE,
PERNR       TYPE PA0002-PERNR,  " 従業員CD
SEQNR       TYPE PA0002-SEQNR,  " レコード番号
NACHN       TYPE PA0002-NACHN,  " 姓
END   OF PA0002_TABLE.


*---------------------------------------------------------------------
* DATA
*---------------------------------------------------------------------
*--- ＮＡＳＴオブジェクト内部テーブル
DATA : GT_NAST   TYPE TABLE OF TYP_NAST.
DATA : GF_NAST   TYPE TYP_NAST.

*--- 出荷伝票内部テーブル
DATA : GF_INFO   TYPE TYP_INFO.
DATA : GT_INFO   LIKE TABLE OF GF_INFO.

*--- 販売伝票構造
DATA : GF_VB     TYPE VB_TABLE.
DATA : GT_VB     TYPE TABLE OF VB_TABLE.

*--- 個人データ情報構造
DATA : GF_PA0002 TYPE PA0002_TABLE.

*--- 帳票出力用内部テーブル
DATA : GF_WRITE  TYPE          ZSLIST_V03_1,
GT_WRITE  TYPE TABLE OF ZSLIST_V03_1 WITH HEADER LINE.

*--- REUSE_ALV_EVENTS_GET 用
DATA : GT_EVENT  TYPE SLIS_T_EVENT.
DATA : GF_EVENT  TYPE SLIS_ALV_EVENT.
DATA : GF_LAYOUT TYPE SLIS_LAYOUT_ALV,    "レイアウト構造
GF_VARIANT LIKE DISVARIANT,        "バリアント
G_TOP_OF_PAGE TYPE SLIS_FORMNAME VALUE 'TOP_OF_PAGE'.

DATA : G_REPID   TYPE SY-REPID.           " プログラムＩＤ
DATA : G_DATA    TYPE SY-DATUM.           " 処理日付
DATA : FLG_SUB   TYPE P.                  " フラグSY-SUBRC
DATA : KURSK     TYPE VBKD-KURSK.         " 換算レート

*---APPEND START PSD T.SAITOH 2002/03/12 alv_st---------------------*
DATA: GF_PRINT      TYPE SLIS_PRINT_ALV.
*---APPEND END   PSD T.SAITOH 2002/03/12 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
DATA: GT_SEQG3 LIKE TABLE OF SEQG3 WITH HEADER LINE,
GF_SEQG3 LIKE SEQG3.
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*


CONSTANTS : CNS_V2(2)     TYPE C VALUE  'V2',
CNS_ZS10(4)   TYPE C VALUE  'ZS10',
CNS_J(1)      TYPE C VALUE  'J',
CNS_0(1)      TYPE C VALUE  '0',
CNS_1(1)      TYPE C VALUE  '1',
CNS_X(1)      TYPE C VALUE  'X',
CNS_MOTHER(2) TYPE C VALUE  '親',
CNS_CHILD(2)  TYPE C VALUE  '子',
CNS_ZSEO(4)   TYPE C VALUE  'ZSEO',
CNS_ZSEK(4)   TYPE C VALUE  'ZSEK',
* Add 20100326 --->
CNS_KBN(4)    TYPE C VALUE  'KBN' ,
* Add 20100326 <---
CNS_000000(6) TYPE N VALUE  000000,
CNS_AG(2)     TYPE C VALUE  'AG',
CNS_VE(2)     TYPE C VALUE  'VE',
*---APPEND START NDSC A.MASUDA 2004/04/08 --------------------------*
CNS_WE(2)     TYPE C VALUE 'WE',
*---APPEND END   NDSC A.MASUDA 2004/04/08 --------------------------*
CNS_TAN(3)    TYPE C VALUE  'TAN',
CNS_ZTAN(8)   TYPE C VALUE  'ZTAN',
CNS_ZTMP(4)   TYPE C VALUE  'ZTMP',
CNS_*(1)      TYPE C VALUE  '*',
CNS_H(1)      TYPE C VALUE  'H',
CNS_O(1)      TYPE C VALUE  'O',
CNS_RG(2)     TYPE C VALUE  'RG'.
*---MODIFY START PSD T.SAITOH 2002/04/04 ---------------------------*
CONSTANTS : CNS_NAST(4)   TYPE C VALUE  'NAST'.
*---MODIFY END   PSD T.SAITOH 2002/04/04 ---------------------------*
*---------------------------------------------------------------------
* 選択画面定義
*---------------------------------------------------------------------
*---APPEND START PSD T.SAITOH 2002/06/11 ---------------------------*
*   販売組織
PARAMETERS: PR_VKORG TYPE TVKO-VKORG MEMORY ID VKO OBLIGATORY,
*   流通チャネル
PR_VTWEG TYPE TVTW-VTWEG MEMORY ID VTW OBLIGATORY,
*   製品部門
PR_SPART TYPE TSPA-SPART MEMORY ID SPA OBLIGATORY.

*---APPEND END   PSD T.SAITOH 2002/06/11 ---------------------------*

*--- 納入期日
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 3(25) TEXT-015.
*---MODIFY START DMC S.MIKAMI 2005/06/16 ---------------------------*
*SELECT-OPTIONS: S_LFDAT FOR GF_INFO-LFDAT.
SELECT-OPTIONS: S_LFDAT FOR GF_INFO-VDATU.
*---MODIFY END   DMC S.MIKAMI 2005/06/16 ---------------------------*
SELECTION-SCREEN END   OF LINE.

*--- 出荷ポイント
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 3(25) TEXT-001.
SELECT-OPTIONS: S_VSTEL FOR GF_INFO-VSTEL OBLIGATORY.
SELECTION-SCREEN END   OF LINE.
*--- 営業グループ
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: R_VKGRP RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 3(25) TEXT-002 FOR FIELD R_VKGRP.
SELECT-OPTIONS: S_VKGRP FOR GF_INFO-VKGRP.
SELECTION-SCREEN END   OF LINE.
*--- 営業員コード
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: R_PERNR RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 3(25) TEXT-003 FOR FIELD R_PERNR.
SELECT-OPTIONS: S_PERNR FOR GF_PA0002-PERNR.
SELECTION-SCREEN END   OF LINE.
*--- 得意先コード
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 3(25) TEXT-004.
SELECT-OPTIONS: S_KUNNR FOR GF_INFO-KUNNR.
SELECTION-SCREEN END   OF LINE.

*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
*   再出力処理機能追加
SELECTION-SCREEN SKIP 1.
*--- 通常出力--- R_NMOUT
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: R_NMOUT RADIOBUTTON GROUP RDOG.
SELECTION-SCREEN COMMENT 3(33) TEXT-019.
SELECTION-SCREEN END   OF LINE.

*--- 再出力--- R_REOUT
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: R_REOUT RADIOBUTTON GROUP RDOG.
SELECTION-SCREEN COMMENT 3(33) TEXT-020.
SELECTION-SCREEN END   OF LINE.

*--- 出力日付--- S_DATVR
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 3(25) TEXT-021.
SELECT-OPTIONS: S_DATVR FOR SY-DATUM.
SELECTION-SCREEN END   OF LINE.

*--- 出力時間--- S_UHRVR
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN COMMENT 3(25) TEXT-022.
SELECT-OPTIONS: S_UHRVR FOR SY-UZEIT.
SELECTION-SCREEN END   OF LINE.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*


*---------------------------------------------------------------------
* AT SELECTION-SCREEN
*---------------------------------------------------------------------
AT SELECTION-SCREEN.
*---APPEND START PSD K.ARAI   2002/05/07 サブルーチン化--------------*
*--- 入力後データチェック
PERFORM FRM_DATA_CHECK.
*---APPEND END   PSD K.ARAI   2002/05/07

*---------------------------------------------------------------------
* START-OF-SELECTION
*---------------------------------------------------------------------
START-OF-SELECTION.
*--- 内部テーブルデータ取得処理
PERFORM FRM_MAKE_DATA.

*--- 帳票内部テーブル作成処理
PERFORM FRM_MAKE_TBL.

*--- NASTテーブル更新処理
*---MODIFY START PSD K.ARAI   2002/05/07 ----------------------------*
*   再出力時はNAST更新しない
IF R_NMOUT = CNS_X.
PERFORM FRM_NAST_NEW.
ENDIF.
* PERFORM FRM_NAST_NEW.
*---MODIFY END   PSD K.ARAI   2002/05/07 ----------------------------*

PERFORM FRM_SUM_QUANTITY_DATA.
*--- 帳票出力処理
PERFORM FRM_WRITE_DATA.

************************************************************************
* TOP-OF-PAGE
************************************************************************
FORM FRM_TOP_OF_PAGE.
*--- ヘッダー出力処理
WRITE:  50      TEXT-009,
/1      TEXT-010,GT_WRITE-VSTEL,TEXT-011,GT_WRITE-VTEXT.

IF R_VKGRP = 'X'.
WRITE :  TEXT-012,GT_WRITE-VKGRP,TEXT-011,GT_WRITE-BEZEIB.
ELSE.
WRITE :  TEXT-016,GT_WRITE-PERNR,TEXT-011,GT_WRITE-NACHIN.
ENDIF.

IF S_LFDAT-HIGH IS INITIAL.                       " 入力が下限値のみ
WRITE:          TEXT-013, GF_WRITE-FDAT.        " 日付FROM
*                    TEXT-014, GF_WRITE-FDAT.        " 日付T0
ELSEIF NOT ( S_LFDAT IS INITIAL ).                "
WRITE:          TEXT-013, GF_WRITE-FDAT,        " 日付FROM
TEXT-014, GF_WRITE-TDAT.        " 日付TO
ENDIF.

*---APPEND START PSD T.SAITOH 2002/08/08 ---------------------------*
*   ページ番号付加
WRITE: 140 'PAGE:',SY-PAGNO.
*---APPEND END   PSD T.SAITOH 2002/08/08 ---------------------------*

ENDFORM.                    "FRM_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*       対象データ抽出処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_MAKE_DATA.


*---DELETE START PSD T.SAITOH 2002/07/30 ---------------------------*
**--- ロック処理
*  PERFORM FRM_ENQUEUE.
*---DELETE END   PSD T.SAITOH 2002/07/30 ---------------------------*

*--- NASTオブジェクトキー内部TBL作成
*---APPEND START PSD K.ARAI   2002/05/07 サブルーチン化
PERFORM FRM_SELECT_NAST.
*---APPEND END   PSD K.ARAI   2002/05/07

*--- 出荷伝票情報内部テーブル作成
*---APPEND START PSD K.ARAI   2002/05/07 サブルーチン化
PERFORM FRM_SELECT_INFO.
*---APPEND END   PSD K.ARAI   2002/05/07

*   対象データなしの場合
IF GT_INFO IS INITIAL.
MESSAGE S600(Z1) WITH TEXT-006.
STOP.
ENDIF.
*---APPEND START PSD T.SAITOH 2002/03/01 400-SD-02---------------------*
* 未出荷数の計算式変更対応のためのソート処理
SORT GT_INFO ASCENDING BY VBELN
POSNR.
*---APPEND END   PSD T.SAITOH 2002/03/01 400-SD-02---------------------*
ENDFORM.                    " FRM_MAKE_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_TBL
*&---------------------------------------------------------------------*
*       帳票内部テーブル作成処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_MAKE_TBL.
*--- ①NAST内部テーブルループ処理
*  LOOP AT GT_NAST INTO GF_NAST.

*--- ②出荷伝票内部テーブルループ処理＆設定
LOOP AT GT_INFO INTO GF_INFO.

*     区取得処理
CASE GF_INFO-PSTYV.                      " 区
WHEN CNS_ZSEO.
GF_WRITE-KU = CNS_MOTHER.
WHEN CNS_ZSEK.
GF_WRITE-KU = CNS_CHILD.
WHEN OTHERS.
GF_WRITE-KU = ' '.
ENDCASE.

GF_WRITE-VSTEL  =  GF_INFO-VSTEL.        " 出荷ポイント
*---MODIFY START DMC S.MIKAMI 2005/06/16 ---------------------------*
*    GF_WRITE-LFDAT  =  GF_INFO-LFDAT.        " 納入期日
GF_WRITE-LFDAT  =  GF_INFO-VDATU.        " 納入期日
*---MODIFY END   DMC S.MIKAMI 2005/06/16 ---------------------------*
GF_WRITE-LFIMG  =  GF_INFO-LFIMG.        " 出荷指示数
GF_WRITE-VRKME  =  GF_INFO-VRKME.        " 数量単位
*    GF_WRITE-PSTYV  =  GF_INFO-PSTYV.        " 明細カテゴリ
GF_WRITE-LGPBE  =  GF_INFO-LGPBE.        " 棚番
GF_WRITE-VGBEL  =  GF_INFO-VGBEL.        " 受注番号
GF_WRITE-VBELN  =  GF_INFO-VBELN.        " 出荷伝票番号
GF_WRITE-POSNR  =  GF_INFO-POSNR.        " 出荷伝票明細
GF_WRITE-VGPOS  =  GF_INFO-VGPOS.        " 参照明細番号
GF_WRITE-FDAT   =  S_LFDAT-LOW.          " 選択年月日FROM
GF_WRITE-TDAT   =  S_LFDAT-HIGH.         " 選択年月日TO
GF_WRITE-KUNNR  =  GF_INFO-KUNNR.        " 得意先CD（出荷先）
*---APPEND START PSD T.SAITOH 2002/09/20 ---------------------------*
*   納品書種別
PERFORM FRM_READ_TEXT_KNB1 USING GF_WRITE-KUNNR
CHANGING GF_WRITE-ZS01.
*---APPEND END   PSD T.SAITOH 2002/09/20 ---------------------------*
GF_WRITE-KUNNRC =  GF_INFO-KDMAT.        " 得意先品目CD
GF_WRITE-KDMAT  =  GF_INFO-MATNR.        " 品目CD
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↓
GF_WRITE-WADAT = GF_INFO-WADAT.          " 出庫日
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↑

*--- ③出荷ポイントテキスト取得
PERFORM FRM_MAKE_VTXT.

*--- ④販売伝票取引先取得（納入区域）
PERFORM FRM_MAKE_LZONE.

*--- ⑤個人データ情報取得（営業員CD・営業員名）
PERFORM FRM_MAKE_PA0002.
IF R_PERNR = CNS_X.                        " 営業員ラジオ押下
IF FLG_SUB = 4.                          " 次レコード処理
CONTINUE.
ELSE.
ENDIF.
ENDIF.
*--- 2002/02/02 PSD C.YAMAGUCHI MOD ↓
*    換算レート取得設定
SELECT SINGLE KURSK FROM VBKD
INTO KURSK
WHERE VBELN = GF_INFO-VGBEL
AND   POSNR = CNS_000000.
IF SY-SUBRC <> 0.
GF_WRITE-STCUR = 0.
ELSE.
GF_WRITE-STCUR = KURSK.                     " 換算レート
ENDIF.
*--- 2002/02/01 PSD C.YAMAGUCHI MOD ↑

*--- ⑥販売伝票取得設定（受注数量・出荷指示数量・未出荷数
*        営業グループコード・ 営業所コード・ 得意先発注番号
*        伝票カテゴリ・ 品目名・受注数量・在庫）
*--- 2002/01/22 PSD C.YAMAGUCHI MOD ↓
*    （原価・原価（円建て）・原価金額・原価金額（円建て）追加
*--- 2002/01/22 PSD C.YAMAGUCHI MOD ↑
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↓
*     (受注単価・受注単価（円建て）・ 受注日・ 出荷金額
*     ・出荷金額（円建て）・通貨コード・ 受注金額（円建て）)
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↑
*--- 2002/02/01 PSD C.YAMAGUCHI MOD ↓
*    価格条件単価取得追加
*--- 2002/02/01 PSD C.YAMAGUCHI MOD ↑
PERFORM FRM_MAKE_VB.

*--- ⑦営業グループ名の取得
PERFORM FRM_MAKE_BEZEIB.

*--- ⑧営業所名の取得
PERFORM FRM_MAKE_BEZEIA.

*--- ⑨受注先取得
PERFORM FRM_KUNAG.

*--- ⑩出荷指示（直送）の取得
PERFORM FRM_EVERS.

*--- ⑪得意先名（出荷先）の取得
PERFORM FRM_TOKUI_NAME.

*--- ⑫出荷指示備考取得
PERFORM FRM_SYUKKASIJI.

*--- ⑬受注先名取得
PERFORM FRM_JYUTYU_NAME.

*--- ⑭社内用備考取得
PERFORM FRM_COM.

*--- ⑮得意先回答納期取得＋得意先発注番号（３５桁）追加2002/07/14
*---MODIFY START PSD T.SAITOH 2002/05/09 ---------------------------*
*   手段変更
*    PERFORM FRM_TOKUISAKI.
PERFORM FRM_DELIVERY_DATE.
*---MODIFY END   PSD T.SAITOH 2002/05/09 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/06/11 ---------------------------*
*--- 得意先品目テキストの取得
PERFORM FRM_LTX01.
*---APPEND END   PSD T.SAITOH 2002/06/11 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/08/01 ---------------------------*
* 得意先コード
DATA:L_KUNNR TYPE KNA1-KUNNR. "
L_KUNNR = GF_WRITE-KUNNR.
WRITE L_KUNNR TO GF_WRITE-KUNNR.
*    PERFORM FRM_RIGHT_JUSTIFIED USING GF_WRITE-KUNNR
*                             CHANGING GF_WRITE-KUNNR_MAIN.
*---APPEND END   PSD T.SAITOH 2002/08/01 ---------------------------*

*---APPEND START NDSC A.MASUDA 2004/04/08 --------------------------*
*   出荷先住所取得
PERFORM FRM_WE_ADRC_GET.
*---APPEND END   NDSC A.MASUDA 2004/04/08 --------------------------*

*--- ⑯帳票内部テーブルに追加
APPEND GF_WRITE TO GT_WRITE.

*--- 帳票内部テーブルクリア処理
*    CLEAR GF_WRITE.

ENDLOOP.
*  ENDLOOP.
ENDFORM.                    " FRM_MAKE_TBL
*&---------------------------------------------------------------------*
*&      Form  FRM_ADDRESS
*&---------------------------------------------------------------------*
*       汎用モジュール『ADDR_GET』
*----------------------------------------------------------------------*
*      -->P_ADRNR  住所
*      <--P_NAME2  受注先名／得意先名
*----------------------------------------------------------------------*
FORM FRM_ADDR_GET USING    P_ADDR
CHANGING P_NAME.
DATA L_ADDR1_SEL TYPE ADDR1_SEL.
DATA L_SADR      TYPE SADR.

L_ADDR1_SEL-ADDRNUMBER = P_ADDR.
*--- 汎用モジュール『ADDR_GET』
CALL FUNCTION 'ADDR_GET'
EXPORTING
ADDRESS_SELECTION = L_ADDR1_SEL
IMPORTING
SADR              = L_SADR
EXCEPTIONS
PARAMETER_ERROR   = 1
ADDRESS_NOT_EXIST = 2
VERSION_NOT_EXIST = 3
INTERNAL_ERROR    = 4
OTHERS            = 5.

IF SY-SUBRC <> 0.
P_NAME = ' '.              " 処理エラーの場合ブランク
ELSE.
P_NAME = L_SADR-NAME1.
ENDIF.

ENDFORM.                    " FRM_ADDR_GET
*&---------------------------------------------------------------------*
*&      Form  FRM_NAST_UP
*&---------------------------------------------------------------------*
*       NAST更新処理
*----------------------------------------------------------------------*
FORM FRM_NAST_NEW.
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
*   NAST更新のオブジェクトキー(明細単位)
DATA : L_OBJKY TYPE NAST-OBJKY.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*

*--- テーブル更新処理
LOOP AT GT_WRITE INTO GF_WRITE.
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
CONCATENATE GF_WRITE-VBELN
GF_WRITE-POSNR INTO L_OBJKY.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*

*---APPEND START PSD T.SAITOH 2002/07/30 ---------------------------*
*--- ロック処理
PERFORM FRM_ENQUEUE USING L_OBJKY.
*---APPEND END   PSD T.SAITOH 2002/07/30 ---------------------------*

UPDATE NAST CLIENT SPECIFIED
SET    VSTAT  =  CNS_1              " 処理ステータス'1'に更新
*---APPEND START PSD T.SAITOH 2002/04/05 ---------------------------*
*   更新日、更新時間、ユーザ名も更新する
DATVR  =  SY-DATUM
UHRVR  =  SY-UZEIT
USNAM  =  SY-UNAME
*---APPEND END   PSD T.SAITOH 2002/04/05 ---------------------------*
WHERE  MANDT  =  SY-MANDT
*---MODIFY START PSD K.ARAI   2002/05/07 ----------------------------*
*   NAST更新は明細レベルで行う
AND    OBJKY  =  L_OBJKY
*          AND    OBJKY  =  GF_WRITE-VBELN
*---MODIFY END   PSD K.ARAI   2002/05/07 ----------------------------*
AND    KAPPL  =  CNS_V2
AND    KSCHL  =  CNS_ZS10
AND    SPRAS  =  CNS_J.

*---MODIFY START PSD T.SAITOH 2002/04/04 ---------------------------*
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE A753(Z1) WITH CNS_NAST."更新できませんでした
*        ROLLBACK WORK.
*        STOP.
WHEN OTHERS.
MESSAGE A753(Z1) WITH CNS_NAST.
ENDCASE.
*    IF SY-SUBRC <> 0.                        " 処理エラーの場合
*      ROLLBACK WORK.
*      STOP.
*    ENDIF.
ENDLOOP.
*
*  IF SY-SUBRC = 0.                           " 正常に更新できた場合
*    COMMIT WORK.
*  ENDIF.
*---MODIFY END   PSD T.SAITOH 2002/04/04 ---------------------------*


*--- ロック解除処理
PERFORM FRM_DEQUEUE.

ENDFORM.                    " FRM_NAST_NEW
*&---------------------------------------------------------------------*
*&      Form  FRM_ENQUEUE
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
FORM FRM_ENQUEUE USING P_OBJKY.

DATA:L_UNAME LIKE SY-UNAME."ユーザーＩＤ

CALL FUNCTION 'ENQUEUE_EZNAST'
EXPORTING
MODE_NAST      = 'E'
MANDT          = SY-MANDT
KAPPL          = 'V2'
OBJKY          = P_OBJKY
KSCHL          = 'ZS10'
SPRAS          = 'J'
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
CASE SY-SUBRC.
WHEN 0.
WHEN 1.                                  " ロック済みの場合
*--- 2002/05/10 MODIFY PSD K.ARAI
*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
PERFORM FRM_ENQ_CHECK USING P_OBJKY L_UNAME.
MESSAGE S023(Z1) WITH L_UNAME.     " ユーザＩＤ
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*
*---DELETE START PSD T.SAITOH 2002/08/06 ---------------------------*
*      MESSAGE S023(Z1) WITH SY-TITLE.
*---DELETE END   PSD T.SAITOH 2002/08/06 ---------------------------*
ROLLBACK WORK. "<<< APPEND 2002/08/05 PSD T.SAITOH
*      MESSAGE S004(Z1) WITH TEXT-005.
*--- 2002/05/10 END
STOP.
WHEN OTHERS.                             " システムエラーの場合
MESSAGE S502(Z1) WITH TEXT-008 SY-SUBRC.
STOP.
ENDCASE.
ENDFORM.                    " FRM_ENQUEUE

*---APPEND START PSD T.SAITOH 2002/08/06 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_ENQ_CHECK
*&---------------------------------------------------------------------*
*       ロックユーザーＩＤ取得
*----------------------------------------------------------------------*
FORM FRM_ENQ_CHECK USING P_OBJKY P_UNAME.

DATA:L_GARG TYPE SEQG3-GARG."キー

CONCATENATE SY-MANDT
'V2'
P_OBJKY
'*'
'ZS10'
'J'
INTO L_GARG.

CALL FUNCTION 'ENQUEUE_READ'
EXPORTING
GCLIENT       = SY-MANDT
GNAME         = 'NAST'
GARG          = L_GARG
GUNAME        = SPACE
*  IMPORTING
*   NUMBER        =
*   SUBRC         =
TABLES
ENQ           = GT_SEQG3
.
LOOP AT GT_SEQG3 INTO GF_SEQG3.
P_UNAME = GF_SEQG3-GUNAME.
IF GF_SEQG3-GUNAME <> SPACE.
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    "FRM_ENQ_CHECK
*---APPEND END   PSD T.SAITOH 2002/08/06 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_DEQUEUE
*&---------------------------------------------------------------------*
*       ロック解除処理
*----------------------------------------------------------------------*
FORM FRM_DEQUEUE.

CALL FUNCTION 'DEQUEUE_ALL'
* EXPORTING
*   _SYNCHRON       = ' '
.

IF SY-SUBRC <> 0.
MESSAGE E001(Z1) WITH 'DEQUEUE_ALL' SY-SUBRC.
ENDIF.


*  CALL FUNCTION 'DEQUEUE_EZNAST'
*   EXPORTING
*     MODE_NAST       = 'E'
*     MANDT           = SY-MANDT
*     KAPPL           = 'V2'
**   OBJKY           =
*     KSCHL           = 'ZS10'
*     SPRAS           = 'J'
**   PARNR           =
**   PARVW           =
**   ERDAT           =
**   ERUHR           =
**   X_KAPPL         = ' '
**   X_OBJKY         = ' '
**   X_KSCHL         = ' '
**   X_SPRAS         = ' '
**   X_PARNR         = ' '
**   X_PARVW         = ' '
**   X_ERDAT         = ' '
**   X_ERUHR         = ' '
**   _SCOPE          = '3'
**   _SYNCHRON       = ' '
**   _COLLECT        = ' '
*            .

ENDFORM.                    " FRM_DEQUEUE
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_DATA
*&---------------------------------------------------------------------*
*       帳票出力処理
*----------------------------------------------------------------------*
FORM FRM_WRITE_DATA.
G_REPID = SY-REPID.   " プログラムＩＤ取得
G_DATA  = SY-DATUM.   " システム日付取得
*--- 帳票設定処理
PERFORM FRM_WRITE_SET.

*--- リストの出力
CALL FUNCTION 'REUSE_ALV_LIST_DISPLAY'
EXPORTING
I_CALLBACK_PROGRAM             = G_REPID        "レポートID
*   I_CALLBACK_TOP_OF_PAGE          = G_TOP_OF_PAGE  "TOP_OF_PAGE

*---APPEND START NDSC A.MASUDA 2004/04/08 --------------------------*
I_STRUCTURE_NAME               = 'ZSLIST_V03_1'   "構造
*---APPEND END   NDSC A.MASUDA 2004/04/08 --------------------------*

*    I_STRUCTURE_NAME               = 'ZSLIST_V03_1'   "構造
IS_LAYOUT                      = GF_LAYOUT      "レイアウト設定
I_SAVE                         = 'A'            "レイアウト保存
IS_VARIANT                     = GF_VARIANT
IT_EVENTS                      = GT_EVENT[]     "イベント設定
*---APPEND START PSD T.SAITOH 2002/03/12 ---------------------------*
IS_PRINT                       = GF_PRINT      "印刷設定
*---APPEND END   PSD T.SAITOH 2002/03/12 ---------------------------*
TABLES
T_OUTTAB                       = GT_WRITE       " 帳票出力用内部TBL

EXCEPTIONS
PROGRAM_ERROR                  = 1
OTHERS                         = 2
.
IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " FRM_WRITE_DATA
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_SET
*&---------------------------------------------------------------------*
*       帳票設定処理
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_WRITE_SET.
*--- イベント取得
CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
EXPORTING
I_LIST_TYPE     = 0
IMPORTING
ET_EVENTS       = GT_EVENT
EXCEPTIONS
LIST_TYPE_WRONG = 1
OTHERS          = 2.

IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

*--- 使用イベントに実行するサブルーチン名を設定
LOOP AT GT_EVENT INTO GF_EVENT.

CASE GF_EVENT-NAME.
WHEN 'TOP_OF_PAGE'.
GF_EVENT-FORM = 'FRM_TOP_OF_PAGE'.
MODIFY GT_EVENT FROM GF_EVENT.
*      WHEN 'CALLER_EXIT'.
*        GF_EVENT-FORM = 'FRM_CALLER_EXIT'.
*        MODIFY GT_EVENT FROM GF_EVENT.
ENDCASE.

ENDLOOP.
*--- ページ切り替え設定
GF_LAYOUT-GROUP_CHANGE_EDIT = CNS_X.

*---APPEND START PSD T.SAITOH 2002/03/12 alv_st---------------------*
GF_PRINT-NO_PRINT_LISTINFOS = 'X'.
*---APPEND END   PSD T.SAITOH 2002/03/12 ---------------------------*
*--- バリアント保存設定
IF R_VKGRP = CNS_X.
GF_VARIANT-VARIANT = '/ZS010300_01'.
ELSE.
GF_VARIANT-VARIANT = '/ZS010300_02'.
ENDIF.
ENDFORM.                    " FRM_WRITE_SET

*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_VTXT
*&---------------------------------------------------------------------*
*       出荷ポイント取得処理
*----------------------------------------------------------------------*
FORM FRM_MAKE_VTXT.

SELECT SINGLE VTEXT FROM TVSTT
INTO GF_WRITE-VTEXT  " 出荷ポイントTX
WHERE VSTEL = GF_INFO-VSTEL
AND   SPRAS = CNS_J.
CASE SY-SUBRC.
WHEN 0.                                " 取得できたら
WHEN 4.                                " 取得できなかったら
GF_WRITE-VTEXT  =  ' '.              " ブランク
WHEN OTHERS.                           " システムエラーだったら
MESSAGE A603(Z1).                    " メッセージ
ENDCASE.

ENDFORM.                    " FRM_MAKE_VTXT
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_LZONE
*&---------------------------------------------------------------------*
*       納入区域取得処理
*----------------------------------------------------------------------*

FORM FRM_MAKE_LZONE.
SELECT SINGLE LZONE FROM VBPA
INTO GF_WRITE-LZONE       " 納入区域
WHERE VBELN = GF_INFO-VGBEL
AND   POSNR = CNS_000000
*---MODIFY START PSD T.SAITOH 2002/07/31 ---------------------------*
*                 AND   PARVW = CNS_AG.       " (表示上SP：受注先)
AND   PARVW = 'WE'.       " (表示上SH：出荷先)
*---MODIFY END   PSD T.SAITOH 2002/07/31 ---------------------------*
CASE SY-SUBRC.
WHEN 0.                                " 取得できたら
WHEN 4.                                " 取得できなかったら
GF_WRITE-LZONE  =  ' '.              " ブランク
WHEN OTHERS.                           " システムエラーだったら
MESSAGE A603(Z1).
ENDCASE.
ENDFORM.                    " FRM_MAKE_LZONE
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_PA0002
*&---------------------------------------------------------------------*
*       営業員CD・営業員名取得処理
*----------------------------------------------------------------------*

FORM FRM_MAKE_PA0002.
SELECT SINGLE A~PERNR A~SEQNR A~NACHN INTO GF_PA0002
FROM PA0002 AS A INNER JOIN VBPA AS B
ON     A~PERNR =  B~PERNR
WHERE  B~VBELN   =  GF_INFO-VGBEL
AND    B~POSNR   =  CNS_000000
AND    B~PARVW   =  CNS_VE
AND    B~PERNR   IN S_PERNR.
FLG_SUB = SY-SUBRC.                      " フラグ
CASE FLG_SUB.
WHEN 0.                                " 取得できたら
GF_WRITE-PERNR  =  GF_PA0002-PERNR.  " 営業員CD
GF_WRITE-NACHIN =  GF_PA0002-NACHN.  " 営業員名
WHEN 4.                                " 取得できなかったら
IF R_PERNR = CNS_X. " 営業員CD選択時（次レコード処理）
EXIT.
ELSE.               " 営業員CD選択していない時（ブランク設定）
GF_WRITE-PERNR  =  ' '.
GF_WRITE-NACHIN =  ' '.
ENDIF.
WHEN OTHERS.                           " システムエラーだったら
MESSAGE A603(Z1).
ENDCASE.

ENDFORM.                    " FRM_MAKE_PA0002
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_VB
*&---------------------------------------------------------------------*
*      受注数量・出荷指示数量・未出荷数・営業グループコード・
*      営業所コード・得意先発注番号・得意先コード・ 品目名・
*      受注数量取得処理
*----------------------------------------------------------------------*
FORM FRM_MAKE_VB.

*A~KUNNR
SELECT SINGLE A~VKGRP A~VKBUR A~BSTNK A~VBTYP A~AUART A~AUDAT
B~WAERK B~VBELN B~POSNR B~ARKTX B~KWMENG
B~PSTYV B~WAVWR B~NETPR B~KPEIN
*                B~STCUR
INTO GF_VB
FROM VBAK AS A INNER JOIN VBAP AS B
ON     A~VBELN  =  B~VBELN
WHERE  B~VBELN  =  GF_INFO-VGBEL
AND    B~POSNR  =  GF_INFO-VGPOS.
CASE SY-SUBRC.
WHEN 0.                                          " 取得できたら
*    在庫取得処理

IF ( GF_VB-PSTYV = CNS_ZSEK ) OR ( GF_VB-PSTYV = CNS_TAN ) OR
( GF_VB-PSTYV = CNS_ZTAN ) OR ( GF_VB-PSTYV = CNS_ZTMP ) OR
* Add 20100326 --->
( GF_VB-PSTYV = CNS_KBN ) .
* Add 20100326 <---
GF_WRITE-ZAIKO = CNS_*.                     " 在庫
ELSE.
GF_WRITE-ZAIKO = ' '.
ENDIF.
*    受注数量・出荷指示数量算出処理（伝票カテゴリがHの時）
*---MODIFY START PSD T.SAITOH 2002/06/24 ---------------------------*
IF ( GF_VB-VBTYP = CNS_H ).
*---MODIFY END   PSD T.SAITOH 2002/06/24 ---------------------------*
GF_WRITE-KWMENG =  GF_VB-KWMENG * -1.        " 受注数量
GF_WRITE-LFIMG = GF_INFO-LFIMG * -1.         " 出荷指示数量
ELSE.
GF_WRITE-KWMENG =  GF_VB-KWMENG .            " 受注数量
GF_WRITE-LFIMG = GF_INFO-LFIMG.              " 出荷指示数量
ENDIF.
*---MODIFY START PSD T.SAITOH 2002/03/01 400-SD-02---------------------*
*    未出荷数算出処理
*      GF_WRITE-LFIMGN = GF_WRITE-KWMENG - GF_WRITE-LFIMG. " 未出荷数
PERFORM FRM_LFIMGN.

*---MODIFY END   PSD T.SAITOH 2002/03/01 400-SD-02---------------------*
* ↓DELETE 2002/02/15 M.Arai 原価設定不具合対応
*      DATA: L_WAVWR  TYPE ZSLIST_V03_1-COST,
* ↑
* ↓APPEND 2002/02/15 M.Arai 原価設定不具合対応
DATA: L_WAVWR(12)  TYPE P DECIMALS 2,
* ↑
L_NETPR  TYPE ZSLIST_V03_1-NETPR.
*    原価金額・受注単価変換
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↓
PERFORM FRM_KINGAKU_HENKAN USING    GF_VB-WAVWR
GF_VB-WAERK
CHANGING L_WAVWR.
GF_WRITE-COST = L_WAVWR.                          " 原価金額

PERFORM FRM_KINGAKU_HENKAN USING     GF_VB-NETPR
GF_VB-WAERK
CHANGING L_NETPR.
IF GF_VB-KPEIN = 0.
GF_WRITE-NETPR = 0.
ELSE.
GF_WRITE-NETPR  =  L_NETPR / GF_VB-KPEIN.         " 受注単価
ENDIF.
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↑
*--- 2002/01/22 PSD C.YAMAGUCHI MOD ↓
*    原価・原価（円建て）・原価金額（円建て）算出処理
IF GF_VB-KWMENG = 0.
GF_WRITE-WAVWRC = 0.
GF_WRITE-WAVWR  = 0.
ELSE.
GF_WRITE-WAVWRC = GF_WRITE-COST / GF_WRITE-KWMENG." 原価
GF_WRITE-WAVWR = GF_WRITE-COST * GF_WRITE-STCUR /
GF_WRITE-KWMENG.
" 原価（円建て）
ENDIF.
GF_WRITE-COSTY  = GF_WRITE-COST * GF_WRITE-STCUR.
" 原価金額(円建て）
*--- 2002/01/22 PSD C.YAMAGUCHI MOD ↑

*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↓
*     (換算レート・受注単価・受注単価（円建て）・ 受注日・出荷金額
*      出荷金額（円建て）・通貨コード・ 受注金額（円建て）
*      粗利金額（円建て）・粗利率　)
*      GF_WRITE-STCUR = GF_VB-STCUR.                     " 換算レート

IF GF_VB-KPEIN = 0.
GF_WRITE-JTNKYN = 0.
ELSE.
GF_WRITE-JTNKYN  = ( L_NETPR / GF_VB-KPEIN ) * GF_WRITE-STCUR.
ENDIF.                                        " 受注単価（円建て）
GF_WRITE-AUDAT  = GF_VB-AUDAT.                    " 受注日
GF_WRITE-SHMNT = GF_WRITE-LFIMG * GF_WRITE-NETPR. " 出荷金額
GF_WRITE-SHMNY = GF_WRITE-LFIMG * GF_WRITE-JTNKYN.
" 出荷金額（円建て）
GF_WRITE-WAERK  =  GF_VB-WAERK.                   " 通貨コード
GF_WRITE-NUMGF  =  GF_WRITE-JTNKYN * GF_WRITE-KWMENG.
" 受注金額（円建て）
GF_WRITE-GRMRY  =  GF_WRITE-NUMGF - GF_WRITE-COSTY.
" 粗利金額（円建て）
IF GF_WRITE-NUMGF = 0.
GF_WRITE-GRMRP = 0.
ELSE.
GF_WRITE-GRMRP  =  GF_WRITE-GRMRY / GF_WRITE-NUMGF.
ENDIF.                                        " 粗利率
*--- 2002/01/29 PSD C.YAMAGUCHI MOD ↑

GF_WRITE-VKGRP  =  GF_VB-VKGRP.               " 営業GPCD
GF_WRITE-VKBUR  =  GF_VB-VKBUR.               " 営業所CD
GF_WRITE-BSTNK  =  GF_VB-BSTNK.               " 得意先発注番号
*      GF_WRITE-VBTYP  =  GF_VB-VBTYP.               " 伝票カテゴリ

*---APPEND START NDSC S.SHIGEMITU 2005/09/22 --------------------------*
GF_WRITE-AUART = GF_VB-AUART.                 "販売伝票タイプ
*---APPEND END   NDSC S.SHIGEMITU 2005/09/22 --------------------------*

GF_WRITE-ARKTX  =  GF_VB-ARKTX.               " 品目名
GF_WRITE-PSTYV  =  GF_VB-PSTYV.               " 明細カテゴリ
WHEN 4.                             " 取得できなかったら
MESSAGE S600(Z1) WITH TEXT-007.   " メッセージ
STOP.
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

ENDFORM.                    " FRM_MAKE_VB
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_VKGRP
*&---------------------------------------------------------------------*
*       営業グループ名取得処理
*----------------------------------------------------------------------*

FORM FRM_MAKE_BEZEIB.
SELECT SINGLE BEZEI FROM TVGRT
INTO GF_WRITE-BEZEIB
WHERE SPRAS  =  CNS_J
AND   VKGRP  =  GF_VB-VKGRP.
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
WHEN 4.                             " 取得できなかったら
GF_WRITE-BEZEIB  =  ' '.          " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

ENDFORM.                    " FRM_MAKE_BEZEIB
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_BEZEIB
*&---------------------------------------------------------------------*
*       営業所取得処理
*----------------------------------------------------------------------*

FORM FRM_MAKE_BEZEIA.
SELECT SINGLE BEZEI FROM TVKBT
INTO GF_WRITE-BEZEIA   " 営業所GP名称
WHERE SPRAS  =  CNS_J
AND   VKBUR  =  GF_VB-VKBUR.
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
WHEN 4.                             " 取得できなかったら
GF_WRITE-BEZEIA  =  ' '.          " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

ENDFORM.                    " FRM_MAKE_BEZEIA
*&---------------------------------------------------------------------*
*&      Form  FRM_EVERS
*&---------------------------------------------------------------------*
*       出荷指示取得処理
*----------------------------------------------------------------------*

FORM FRM_EVERS.
*--- 購買依頼・購買依頼の明細取得
DATA :  R_BANFN TYPE VBEP-BANFN,                    " 購買依頼
R_BNFPO TYPE VBEP-BNFPO.                    " 購買依頼の明細
SELECT SINGLE BANFN BNFPO INTO (R_BANFN, R_BNFPO)
FROM VBEP
WHERE VBELN  =  GF_VB-VBELN
AND   POSNR  =  GF_VB-POSNR.
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
WHEN 4.                             " 取得できなかったら
GF_WRITE-EVERS  =  ' '.           " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.
*--- 購買発注番号・購買発注明細取得
DATA : R_EBELN TYPE EBAN-EBELN,                     " 購買発注番号
R_EBELP TYPE EBAN-EBELP.                     " 購買発注明細
SELECT SINGLE EBELN EBELP INTO (R_EBELN, R_EBELP)
FROM EBAN
WHERE BANFN  = R_BANFN
AND   BNFPO  = R_BNFPO .
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
WHEN 4.                             " 取得できなかったら
GF_WRITE-EVERS  =  ' '.           " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.
*--- 出荷指示（直送）取得
SELECT SINGLE EVERS FROM EKPO
INTO GF_WRITE-EVERS            " 出荷指示
WHERE EBELN  =  R_EBELN
AND   EBELP  =  R_EBELP .
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
IF GF_WRITE-EVERS <> 'Z1'.
GF_WRITE-EVERS  =  ' '.           " ブランク
ENDIF.
WHEN 4.                             " 取得できなかったら
*      GF_WRITE-EVERS  =  ' '.           " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

ENDFORM.                    " FRM_EVERS
*&---------------------------------------------------------------------*
*&      Form  FRM_MAKE_KNAME
*&---------------------------------------------------------------------*
*       得意先名取得処理
*----------------------------------------------------------------------*

FORM FRM_TOKUI_NAME.
DATA : R_TOKUI(35)    TYPE C.                      " 項目（住所）
SELECT SINGLE ADRNR FROM VBPA
INTO    R_TOKUI
WHERE  VBELN  =  GF_VB-VBELN
AND    POSNR  =  CNS_000000
AND    PARVW  =  CNS_RG.
CASE SY-SUBRC.
WHEN 0.                              " 取得できたら
*    得意先名取得
PERFORM FRM_ADDR_GET USING    R_TOKUI
CHANGING GF_WRITE-KNAME.  " 得意先名
WHEN 4.                             " 取得できなかったら
GF_WRITE-KNAME  =  ' '.           " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

ENDFORM.                    " FRM_TOKUI_NAME

*&---------------------------------------------------------------------*
*&      Form  FRM_READ_TEXT
*&---------------------------------------------------------------------*
*       出荷指示備考取得
*----------------------------------------------------------------------*
FORM FRM_SYUKKASIJI.

DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_VBELN     LIKE THEAD-TDNAME.

CONCATENATE  GF_INFO-VGBEL            " 参照伝票番号
GF_INFO-VGPOS            " 参照伝票明細
INTO L_VBELN.
*     "READ_TEXT"汎用モジュール
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID        = '9001'
LANGUAGE  = 'J'
NAME      = L_VBELN
OBJECT    = 'VBBP'
TABLES
LINES     = LT_TLINE
EXCEPTIONS
NOT_FOUND = 4
*---APPEND START PSD T.SAITOH 2002/07/17 ---------------------------*
REFERENCE_CHECK = 5
*---APPEND END   PSD T.SAITOH 2002/07/17 ---------------------------*
OTHERS    = 8.
CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
*--- ↓ 2002.05.02 MODIFY PSD K.Arai
GF_WRITE-ETC = LF_TLINE-TDLINE+0(40).         " 出荷指示備考
*     GF_WRITE-ETC = LF_TLINE+0(40).                " 出荷指示備考
*--- ↑
WHEN 4 OR 5."<<<MODIFY 2002/07/17 PSD T.SAITOH "OR 5"
GF_WRITE-ETC = ' '.                           " ブランク設定
WHEN 8.
MESSAGE E001(Z1) WITH TEXT-016
SY-SUBRC.
ENDCASE.
ENDFORM.                    " FRM_SYUKKASIJI
*&---------------------------------------------------------------------*
*&      Form  FRM_KINGAKU_HENKAN
*&---------------------------------------------------------------------*
*       価格変換
*----------------------------------------------------------------------*
*      -->P_GF_WRITE_WAVWR  text
*      -->P_GF_VB_WAERK  text
*      <--P_L_NETWRA  text
*----------------------------------------------------------------------*
FORM FRM_KINGAKU_HENKAN USING    P_KINGAKU
P_WAERK
CHANGING P_KEKKA.
DATA L_IDOC_AMOUNT(255) TYPE C.
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = P_WAERK
SAP_AMOUNT  = P_KINGAKU
IMPORTING
IDOC_AMOUNT = L_IDOC_AMOUNT
EXCEPTIONS
OTHERS      = 1.
IF SY-SUBRC <> 1.
P_KEKKA = L_IDOC_AMOUNT.
ENDIF.
ENDFORM.                    " FRM_KINGAKU_HENKAN
*&---------------------------------------------------------------------*
*&      Form  FRM_JYUTYU_NAME
*&---------------------------------------------------------------------*
*       受注先名取得
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_JYUTYU_NAME.
DATA : R_JYUTYU(35)    TYPE C.                      " 項目（住所）
SELECT SINGLE ADRNR FROM VBPA
INTO    R_JYUTYU
WHERE  VBELN  =  GF_VB-VBELN
AND    POSNR  =  CNS_000000
AND    PARVW  =  CNS_AG.
CASE SY-SUBRC.
WHEN 0.                                          " 取得できたら
*    受注先名取得
PERFORM FRM_ADDR_GET USING    R_JYUTYU
CHANGING GF_WRITE-KUNNRB. " 受注先名
WHEN 4.                             " 取得できなかったら
GF_WRITE-KUNNRB  =  ' '.           " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.


ENDFORM.                    " FRM_JYUTYU_NAME
*&---------------------------------------------------------------------*
*&      Form  FRM_COM
*&---------------------------------------------------------------------*
*       社内用備考取得
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_COM.
DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_VBELN     LIKE THEAD-TDNAME.

*  CONCATENATE  GF_VB-VBELN            " 販売伝票番号
*               GF_VB-POSNR            " 販売伝票明細
*               INTO L_VBELN.
L_VBELN =   GF_VB-VBELN.                 " 販売伝票番号
*     "READ_TEXT"汎用モジュール
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID        = '0001'
LANGUAGE  = 'J'
NAME      = L_VBELN
OBJECT    = 'VBBK'
TABLES
LINES     = LT_TLINE
EXCEPTIONS
NOT_FOUND = 4
*---APPEND START PSD T.SAITOH 2002/07/17 ---------------------------*
REFERENCE_CHECK = 5
*---APPEND END   PSD T.SAITOH 2002/07/17 ---------------------------*
OTHERS    = 8.
CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
*---MODIFY START PSD K.ARAI   2002/05/07 ----------------------------*
GF_WRITE-ETC2 = LF_TLINE-TDLINE+0(40).         " 社内用備考
*     GF_WRITE-ETC2 = LF_TLINE+0(40).                " 社内用備考
*---MODIFY END   PSD K.ARAI   2002/05/07 ----------------------------*
WHEN 4 OR 5."<<<MODIFY 2002/07/17 PSD T.SAITOH
GF_WRITE-ETC2 = ' '.                           " ブランク設定
WHEN 8.
MESSAGE E001(Z1) WITH TEXT-016
SY-SUBRC.
ENDCASE.
ENDFORM.                    " FRM_COM
*&---------------------------------------------------------------------*
*&      Form  FRM_TOKUISAKI
*&---------------------------------------------------------------------*
*       得意先回答納期取得
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_TOKUISAKI.
DATA : R_STKNK   LIKE GF_WRITE-STKNK.
DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_VBELN     LIKE THEAD-TDNAME.

CONCATENATE   GF_VB-VBELN            " 販売伝票番号
GF_VB-POSNR            " 販売伝票明細
INTO L_VBELN.
*     "READ_TEXT"汎用モジュール
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID        = '9002'
LANGUAGE  = 'J'
NAME      = L_VBELN
OBJECT    = 'VBBP'
TABLES
LINES     = LT_TLINE
EXCEPTIONS
NOT_FOUND = 4
*---APPEND START PSD T.SAITOH 2002/07/17 ---------------------------*
REFERENCE_CHECK = 5
*---APPEND END   PSD T.SAITOH 2002/07/17 ---------------------------*
OTHERS    = 8.
CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
GF_WRITE-STKNK = LF_TLINE+0(40).                 " 得意先回答納期
WHEN 4 OR 5."<<<MODIFY 2002/07/17 PSD T.SAITOH "OR 5"
GF_WRITE-STKNK  = ' '.                           " ブランク設定
WHEN 8.
MESSAGE E001(Z1) WITH TEXT-016
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_TOKUISAKI

*&---------------------------------------------------------------------*
*&      Form  FRM_KUNAG
*&---------------------------------------------------------------------*
*       受注先取得
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_KUNAG.
DATA : R_VBELN TYPE VBRP-VBELN.
*---2003/04/30 UPDATE START S.IWAKI(NDSC)
SELECT SINGLE VBELN FROM VBFA
INTO R_VBELN
WHERE  VBTYP_N  =  'M'
AND    VBELV    =  GF_VB-VBELN
AND    POSNV    =  GF_VB-POSNR.
*  SELECT SINGLE VBELN FROM VBRP
*                      INTO R_VBELN
*                      WHERE  AUBEL  =  GF_VB-VBELN
*                      AND    AUPOS  =  GF_VB-POSNR.
*---2003/04/30 UPDATE END   S.IWAKI(NDSC)
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
WHEN 4.                             " 取得できなかったら
GF_WRITE-KUNAG  =  ' '.           " ブランク
EXIT.
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

SELECT SINGLE KUNAG FROM VBRK
INTO GF_WRITE-KUNAG                   " 受注先
WHERE  VBELN  =  R_VBELN.

CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
WHEN 4.                             " 取得できなかったら
GF_WRITE-KUNAG  =  ' '.           " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ
ENDCASE.

ENDFORM.                    " FRM_KUNAG
*---APPEND START PSD T.SAITOH 2002/03/01 400-SD-02---------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_LFIMGN
*&---------------------------------------------------------------------*
*       未出荷数の計算(仕様変更対応)
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_LFIMGN.
DATA: LF_WRITE LIKE GT_WRITE,          "ローカル作業用 GT_WRITE型
LT_WRITE LIKE TABLE OF GT_WRITE."ローカル作業用 GT_WRITE型

LOOP AT GT_WRITE INTO LF_WRITE
WHERE NOT ( VBELN = GF_WRITE-VBELN
AND POSNR = GF_WRITE-POSNR )
AND     VGBEL =  GF_WRITE-VGBEL
AND     VGPOS =  GF_WRITE-VGPOS.
APPEND LF_WRITE TO LT_WRITE.
ENDLOOP.

IF SY-SUBRC = 0.
SORT LT_WRITE DESCENDING BY VBELN
POSNR.

READ TABLE LT_WRITE INTO LF_WRITE INDEX 1.
*    未出荷数算出処理
*     未出荷数　＝　残数　－　出荷済数
GF_WRITE-LFIMGN = LF_WRITE-LFIMGN - GF_WRITE-LFIMG. " 未出荷数
ELSE.
*    未出荷数算出処理
*     未出荷数　＝　受注数量　－　出荷済数
GF_WRITE-LFIMGN = GF_WRITE-KWMENG - GF_WRITE-LFIMG. " 未出荷数
ENDIF.

ENDFORM.                    " FRM_LFIMGN
*---APPEND END   PSD T.SAITOH 2002/03/01 400-SD-02---------------------*

*&---------------------------------------------------------------------*
*&      Form  FRM_DATA_CHECK
*&---------------------------------------------------------------------*
*       入力後データチェック
*----------------------------------------------------------------------*
FORM FRM_DATA_CHECK.
*--- 営業GPボタン押下
IF R_VKGRP = CNS_X.
IF NOT ( S_PERNR IS INITIAL ).         " 営業員CDに値が入ってた場合
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
REFRESH S_PERNR.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
MESSAGE S607(Z1) WITH TEXT-017 TEXT-003.
STOP.
*---DELETE START PSD T.SAITOH 2002/07/25 ---------------------------*
*    ELSEIF S_VKGRP-LOW IS INITIAL.         " 営業GP下限値未入力の場合
*      MESSAGE S006(Z1) WITH TEXT-002.
*      STOP.
*---DELETE END   PSD T.SAITOH 2002/07/25 ---------------------------*
ENDIF.
*--- 営業員CDボタン押下
ELSEIF R_PERNR = CNS_X.
IF NOT ( S_VKGRP IS INITIAL ).         " 営業員GPに値が入ってた場合
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
REFRESH S_VKGRP.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
MESSAGE S607(Z1) WITH TEXT-018 TEXT-002.
STOP.
*---DELETE START PSD T.SAITOH 2002/07/25 ---------------------------*
*    ELSEIF S_PERNR-LOW IS INITIAL.         " 営業CD下限値未入力の場合
*      MESSAGE S006(Z1) WITH TEXT-003.
*      STOP.
*---DELETE END   PSD T.SAITOH 2002/07/25 ---------------------------*
ENDIF.
ENDIF.
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
*--- 通常出力ボタン押下
IF R_NMOUT = CNS_X.
PERFORM FRM_NMOUT_CHECK.
ENDIF.
*--- 再出力ボタン押下
IF R_REOUT = CNS_X.
PERFORM FRM_REOUT_CHECK.
ENDIF.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*

ENDFORM.                    " FRM_DATA_CHECK
*&---------------------------------------------------------------------*
*&      Form  FRM_NMOUT_CHECK
*&---------------------------------------------------------------------*
*       通常出力ボタン押下時データチェック
*----------------------------------------------------------------------*
FORM FRM_NMOUT_CHECK.
IF NOT ( S_DATVR IS INITIAL ).         " 出力日付に値が入ってた場合
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
REFRESH S_DATVR.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
MESSAGE S607(Z1) WITH TEXT-023 TEXT-021.
STOP.
ENDIF.
IF NOT ( S_UHRVR IS INITIAL ).         " 出力時間に値が入ってた場合
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
REFRESH S_UHRVR.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
MESSAGE S607(Z1) WITH TEXT-023 TEXT-022.
STOP.
ENDIF.
ENDFORM.                    " FRM_NMOUT_CHECK
*&---------------------------------------------------------------------*
*&      Form  FRM_REOUT_CHECK
*&---------------------------------------------------------------------*
*       再出力ボタン押下時データチェック
*----------------------------------------------------------------------*
FORM FRM_REOUT_CHECK.
IF ( S_DATVR IS INITIAL ).            " 出力日付に値が入ってない場合
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
REFRESH S_DATVR.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
MESSAGE S700(Z1) WITH TEXT-024 TEXT-021.
STOP.
ELSEIF S_DATVR-LOW IS INITIAL.         " 出力日付下限値未入力の場合
MESSAGE S006(Z1) WITH TEXT-021.
STOP.
ENDIF.
ENDFORM.                    " FRM_REOUT_CHECK
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_NAST
*&---------------------------------------------------------------------*
*       NASTの読み込み処理
*----------------------------------------------------------------------*
FORM FRM_SELECT_NAST.
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
*--- 通常出力時
IF R_NMOUT = CNS_X.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
SELECT OBJKY FROM   NAST INTO TABLE GT_NAST
WHERE VSTAT  =  CNS_0      " 処理ステータス
AND   KAPPL  =  CNS_V2     " アプリケーションキー
AND   VSZTP  EQ '1'
AND   AKTIV  EQ  ''
AND   KSCHL  =  CNS_ZS10   " 出力タイプ
AND   NACHA    EQ '1'
AND   SPRAS  =  CNS_J      " 言語タイプ

.
*---APPEND START PSD K.ARAI   2002/05/07 ----------------------------*
*--- 再出力時
ELSEIF R_REOUT = CNS_X.
SELECT OBJKY FROM   NAST INTO TABLE GT_NAST
WHERE  KAPPL  =  CNS_V2     " アプリケーションキー
AND    KSCHL  =  CNS_ZS10   " 出力タイプ
AND    SPRAS  =  CNS_J      " 言語タイプ
AND    VSTAT  =  CNS_1      " 処理ステータス
AND    DATVR  IN S_DATVR    " 更新日付
AND    UHRVR  IN S_UHRVR.   " 更新時間
ENDIF.
*---APPEND END   PSD K.ARAI   2002/05/07 ----------------------------*
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*---MODIFY START PSD T.SAITOH 2002/07/30 ---------------------------*
*      MESSAGE S600(Z1) WITH TEXT-005.
MESSAGE S616(Z1).
*---MODIFY END   PSD T.SAITOH 2002/07/30 ---------------------------*
STOP.
WHEN OTHERS.
MESSAGE A603(Z1).
ENDCASE.

ENDFORM.                    " FRM_SELECT_NAST
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_INFO
*&---------------------------------------------------------------------*
*       出荷伝票情報内部テーブル作成
*----------------------------------------------------------------------*
FORM FRM_SELECT_INFO.
LOOP AT GT_NAST INTO GF_NAST.

*---MODIFY START PSD K.ARAI   2002/05/07 -----------------------------*
*   NASTの読み込みを明細レベルにする。
IF GF_NAST-OBJKY+10(6) = SPACE.
***---APPEND START PSD T.SAITOH 2002/04/05 ----------------------------*
***   オブジェクトキーが明細レベルで存在する場合、対象外とする。
***  IF GF_NAST-OBJKY+10(6) <> SPACE.
CONTINUE.
ENDIF.
**---APPEND END   PSD T.SAITOH  2002/04/05 ---------------------------*
*---MODIFY END   PSD K.ARAI    2002/05/07 ----------------------------*

*---DELETE START DMC S.MIKAMI 2005/06/16 ---------------------------*
* ※↓見にくくなるので書き直します
*    SELECT  A~VBELN A~VSTEL A~LFDAT A~KUNNR A~WADAT B~POSNR B~PSTYV
*            B~MATNR B~KDMAT B~LFIMG B~VRKME B~VKGRP B~LGPBE
*            B~VGBEL B~VGPOS APPENDING TABLE GT_INFO
*              FROM LIKP AS A INNER JOIN LIPS AS B
*                ON       A~VBELN   =   B~VBELN
*---MODIFY START PSD K.ARAI     2002/05/07 ---------------------------*
*   処理を明細単位にする。
*               WHERE    B~VBELN   =   GF_NAST-OBJKY  " オブジェクトキー
*                WHERE    B~VBELN   =   GF_NAST-OBJKY+0(10)  "ｵﾌﾞｼﾞｪｸﾄｷｰ
*                AND      B~POSNR   =   GF_NAST-OBJKY+10(6)  "明細
*---MODIFY END   PSD K.ARAI    2002/05/07 ----------------------------*
*---APPEND START PSD T.SAITOH 2002/07/30 ---------------------------*
*                AND      A~VKORG   =   PR_VKORG "販売組織
*                AND      B~VTWEG   =   PR_VTWEG "流通チャネル
*                AND      B~SPART   =   PR_SPART "製品部門
*---APPEND END   PSD T.SAITOH 2002/07/30 ---------------------------*
*                AND      A~VSTEL   IN  S_VSTEL       " パラ出荷ポイント
*                AND      A~LFDAT   IN  S_LFDAT       " パラ納入期日
*                AND      B~VKGRP   IN  S_VKGRP       " パラ営業GP
*                AND      A~KUNNR   IN  S_KUNNR.      " パラ得意先CD
*---DELETE END   DMC S.MIKAMI 2005/06/16 ---------------------------*

*---DELETE START DMC R.HATA   2006/09/22 ---------------------------*
*---INSERT START DMC S.MIKAMI 2005/06/16 ---------------------------*
*    SELECT  A~VBELN A~VSTEL C~VDATU A~KUNNR A~WADAT B~POSNR B~PSTYV
*            B~MATNR B~KDMAT B~LFIMG B~VRKME B~VKGRP B~LGPBE
*            B~VGBEL B~VGPOS APPENDING TABLE GT_INFO
*              FROM LIKP AS A INNER JOIN LIPS AS B
*                                     ON A~VBELN   =   B~VBELN
*                             INNER JOIN VBAK AS C
*                                     ON B~VGBEL   =   C~VBELN
*                WHERE    B~VBELN   =   GF_NAST-OBJKY+0(10)  "ｵﾌﾞｼﾞｪｸﾄｷｰ
*                AND      B~POSNR   =   GF_NAST-OBJKY+10(6)  "明細
*                AND      A~VKORG   =   PR_VKORG "販売組織
*                AND      B~VTWEG   =   PR_VTWEG "流通チャネル
*                AND      B~SPART   =   PR_SPART "製品部門
*                AND      A~VSTEL   IN  S_VSTEL       " パラ出荷ポイント
*                AND      C~VDATU   IN  S_LFDAT       " パラ納入期日
*                AND      B~VKGRP   IN  S_VKGRP       " パラ営業GP
*                AND      A~KUNNR   IN  S_KUNNR.      " パラ得意先CD
*---INSERT END   DMC S.MIKAMI 2005/06/16 ---------------------------*
*---DELETE END   DMC R.HATA   2006/09/22 ---------------------------*

*---INSERT START DMC R.HATA   2006/09/22 ---------------------------*

SELECT SINGLE VBELN VSTEL KUNNR WADAT
FROM LIKP
INTO CORRESPONDING FIELDS OF GF_INFO
WHERE VBELN   EQ  GF_NAST-OBJKY+0(10)  "ｵﾌﾞｼﾞｪｸﾄｷｰ
AND  VKORG   EQ  PR_VKORG "販売組織
AND  VSTEL   IN  S_VSTEL
AND  KUNNR   IN  S_KUNNR
.
IF SY-SUBRC NE 0 .
CLEAR GF_INFO .
CONTINUE .
ENDIF .

SELECT SINGLE POSNR PSTYV MATNR KDMAT
LFIMG VRKME VKGRP LGPBE
VGBEL VGPOS KCMENG
FROM LIPS
INTO CORRESPONDING FIELDS OF GF_INFO
WHERE VBELN   EQ  GF_NAST-OBJKY+0(10)  "ｵﾌﾞｼﾞｪｸﾄｷｰ
AND  POSNR   EQ  GF_NAST-OBJKY+10(6)  "ｵﾌﾞｼﾞｪｸﾄｷｰ
AND  VTWEG   EQ  PR_VTWEG "流通チャネル
AND  SPART   EQ  PR_SPART "製品部門
AND  VKGRP   IN  S_VKGRP       " パラ営業GP
**** START ADD 2015/10/28 ISID21 ****
AND UECHA = SPACE.
**** START ADD 2015/10/28 ISID21 ****
IF SY-SUBRC NE 0 .
CLEAR GF_INFO .
CONTINUE .
ENDIF .

SELECT SINGLE VDATU
FROM VBAK
INTO CORRESPONDING FIELDS OF GF_INFO
WHERE VBELN EQ  GF_INFO-VGBEL
AND  VDATU IN S_LFDAT
.

IF SY-SUBRC NE 0 .
CLEAR GF_INFO .
CONTINUE .
ENDIF .


APPEND GF_INFO TO GT_INFO .

*---INSERT END   DMC R.HATA   2006/09/22 ---------------------------*
*   システムエラーの場合
IF NOT ( ( SY-SUBRC = 0 ) OR ( SY-SUBRC = 4 ) ).
MESSAGE A603(Z1).
ENDIF.
ENDLOOP.
LOOP AT GT_INFO INTO GF_INFO.
GF_INFO-LFIMG = GF_INFO-LFIMG +  GF_INFO-KCMENG.
MODIFY GT_INFO FROM GF_INFO.
ENDLOOP.
ENDFORM.                    " FRM_SELECT_INFO
*---APPEND START PSD T.SAITOH 2002/05/09 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_delivery_date
*&---------------------------------------------------------------------*
*       解答納期設定/得意先発注番号（３５桁）の設定
*----------------------------------------------------------------------*
FORM FRM_DELIVERY_DATE.

SELECT SINGLE
*---MODIFY START PSD T.SAITOH 2002/07/14 ---------------------------*
*         BSTDK_E
*         INTO (GF_WRITE-STKNK)
* 2003/01/17 NDSC ABE MOD-S
*         BSTDK_E BSTKD
*         INTO (GF_WRITE-STKNK,GF_WRITE-BSTNK)
BSTDK_E BSTKD BSTDK
INTO (GF_WRITE-STKNK,GF_WRITE-BSTNK,GF_WRITE-BSTDK)
* 2003/01/17 NDSC ABE MOD-S
*---MODIFY END   PSD T.SAITOH 2002/07/14 ---------------------------*
FROM VBKD
WHERE VBELN = GF_INFO-VGBEL
AND POSNR = 0.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1).
ENDCASE.

ENDFORM.                    " FRM_delivery_date
*---APPEND END   PSD T.SAITOH 2002/05/09 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_LTX01
*&---------------------------------------------------------------------*
*       READ_TEXTで得意先品目情報テキストを取得する
*----------------------------------------------------------------------*
FORM FRM_LTX01.

DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_NAME      LIKE THEAD-TDNAME.

*---APPEND START PSD T.SAITOH 2002/06/21 ---------------------------*
CONCATENATE GF_WRITE-VBELN GF_WRITE-POSNR
INTO L_NAME.
*---APPEND END   PSD T.SAITOH 2002/06/21 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/06/21 ---------------------------*
*  L_NAME+0()   = PR_VKORG.       "販売組織
*  L_NAME+4(2)   = PR_VTWEG.       "流通チャネル
*  L_NAME+6(10)  = GF_WRITE-KUNNR. "得意先コード
*  L_NAME+16(18) = GF_WRITE-KDMAT. "品目コード
*     "READ_TEXT"汎用モジュール
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID        = '0001'
LANGUAGE  = 'J'
NAME      = L_NAME
OBJECT    = 'VBBP'
TABLES
LINES     = LT_TLINE
EXCEPTIONS
NOT_FOUND = 4
*---APPEND START PSD T.SAITOH 2002/07/17 ---------------------------*
REFERENCE_CHECK = 5
*---APPEND END   PSD T.SAITOH 2002/07/17 ---------------------------*
OTHERS    = 8.
*---MODIFY END   PSD T.SAITOH 2002/06/21 ---------------------------*
CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
GF_WRITE-LTX01 = LF_TLINE-TDLINE+0(20).        "得意先回答納期
WHEN 4 OR 5."<<<MODIFY 2002/07/17 PSD T.SAITOH "OR 5"
GF_WRITE-LTX01 = ' '.                   "ブランク設定
WHEN 8.
MESSAGE E001(Z1) WITH 'READ_TEXT'
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_LTX01
*&--------------------------------------------------------------------*
*&      Form  FRM_RIGHT_JUSTIFIED
*&--------------------------------------------------------------------*
*       仕入先コード／得意先コード　右寄せ(コードは１０バイト固定)
*---------------------------------------------------------------------*
*      -->P_TEXT     ０埋め仕入先コード／得意先コード
*      <--P_NEW_TEXT 右寄せされたコード
*---------------------------------------------------------------------*
FORM FRM_RIGHT_JUSTIFIED USING    P_TEXT
CHANGING P_NEW_TEXT.

DATA: L_LEN   TYPE I,"文字サイズ
L_OFF   TYPE I."オフセット

IF P_TEXT IS INITIAL.
EXIT.
ENDIF.

CLEAR: P_NEW_TEXT.

L_LEN = STRLEN( P_TEXT ).
L_OFF = 10 - L_LEN.
P_NEW_TEXT+L_OFF(L_LEN) = P_TEXT.

ENDFORM.                    " FRM_RIGHT_JUSTIFIED
*&---------------------------------------------------------------------*
*&      Form  FRM_READ_TEXT_KNB1
*&---------------------------------------------------------------------*
*       納品書種別設定
*----------------------------------------------------------------------*
*      -->P_KUNNR    NAME
*      <--P_TDLINE   納品書種別
*----------------------------------------------------------------------*
FORM FRM_READ_TEXT_KNB1 USING    P_KUNNR
CHANGING P_TDLINE.

DATA: LT_TLINE    TYPE TABLE OF TLINE,
LF_TLINE    TYPE TLINE,
L_KUNNR     LIKE THEAD-TDNAME.

CONCATENATE P_KUNNR
'C001' INTO L_KUNNR.


CALL FUNCTION 'READ_TEXT'
EXPORTING
CLIENT                        = SY-MANDT
ID                            = 'ZS01'
LANGUAGE                      = 'J'
NAME                          = L_KUNNR
OBJECT                        = 'KNB1'
*     ARCHIVE_HANDLE                = 0
*     LOCAL_CAT                     = ' '
*   IMPORTING
*     HEADER                        =
TABLES
LINES           = LT_TLINE
EXCEPTIONS
ID                            = 1
LANGUAGE                      = 2
NAME                          = 3
NOT_FOUND                     = 4
OBJECT                        = 5
REFERENCE_CHECK               = 6
WRONG_ACCESS_TO_ARCHIVE       = 7
OTHERS                        = 8.

CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TLINE INTO LF_TLINE INDEX 1.
P_TDLINE = LF_TLINE-TDLINE+0(2).
WHEN OTHERS.
P_TDLINE = SPACE.
ENDCASE.


ENDFORM.                    " FRM_READ_TEXT_KNB1
*---APPEND START NDSC A.MASUDA 2004/04/08 --------------------------*
*&---------------------------------------------------------------------
*&      Form  FRM_WE_ADRC_GET
*&---------------------------------------------------------------------
*       出荷先住所取得処理
*----------------------------------------------------------------------
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------
FORM FRM_WE_ADRC_GET.

*---APPEND START NDSC A.MASUDA 2004/04/21 --------------------------*
DATA:LF_KUNNR  LIKE VBPA-KUNNR,    " 得意先コード
LF_KNAME  LIKE ADRC-NAME2,    " 名称２
LF_CITY1  LIKE ADRC-CITY1,    " 市区町村
LF_STREET LIKE ADRC-STREET,   " 都道府県
LF_BEZEI  LIKE T005U-BEZEI,   " 地域(名称)
LF_ADDNAME LIKE ZSLIST_V03_1-ADDNAME.

*--- 出荷先住所取得
SELECT SINGLE A~KUNNR B~NAME2 B~CITY1 B~STREET C~BEZEI
INTO (LF_KUNNR,LF_KNAME,LF_CITY1,LF_STREET,LF_BEZEI)
FROM VBPA AS A
INNER JOIN ADRC AS B
ON B~ADDRNUMBER = A~ADRNR
INNER JOIN T005U AS C
ON C~BLAND = B~REGION
WHERE A~VBELN = GF_INFO-VBELN
AND A~POSNR = '000000'
AND A~PARVW = CNS_WE
AND C~SPRAS = CNS_J
AND C~LAND1 = 'JP'.
*---APPEND END   NDSC A.MASUDA 2004/04/21 --------------------------*
*--- エラー処理
CASE SY-SUBRC.
WHEN 0.                             " 取得できたら
*---APPEND START NDSC A.MASUDA 2004/04/21 --------------------------*
CONCATENATE LF_CITY1 LF_STREET
INTO LF_ADDNAME.
GF_WRITE-KUNNR_WE =  LF_KUNNR.
GF_WRITE-KNAME_WE =  LF_KNAME.
GF_WRITE-ADDNAME  =  LF_ADDNAME.
GF_WRITE-BEZEI    =  LF_BEZEI.
*---APPEND END   NDSC A.MASUDA 2004/04/21 --------------------------*
WHEN 4.                             " 取得できなかったら
GF_WRITE-KUNNR_WE =  ' '.         " ブランク
GF_WRITE-KNAME_WE =  ' '.         " ブランク
GF_WRITE-ADDNAME  =  ' '.         " ブランク
GF_WRITE-BEZEI    =  ' '.         " ブランク
WHEN OTHERS.                        " システムエラーだったら
MESSAGE A603(Z1).                 " メッセージ

ENDCASE.
ENDFORM.                    " FRM_VBPA_GET3
*---APPEND END   NDSC A.MASUDA 2004/04/08 --------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SUM_QUANTITY_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_SUM_QUANTITY_DATA .
*  DATA LV_TABIX TYPE I.
*  DATA LV_SUM TYPE LFIMG.
*  DATA LT_MERGED_DATA TYPE TABLE OF ZSLIST_V03_1.
*  DATA LS_DATA LIKE LINE OF GT_WRITE.
*  DATA LS_DATA_NEXT LIKE LINE OF GT_WRITE.
*
*  SORT GT_WRITE BY VBELN VGBEL VGPOS POSNR DESCENDING.
*
*
*  LOOP AT GT_WRITE INTO LS_DATA.
*    LV_TABIX = SY-TABIX .
*    LV_SUM = LV_SUM + LS_DATA-LFIMG.
*    LV_TABIX = LV_TABIX + 1.
*    CLEAR LS_DATA_NEXT.
*    READ TABLE GT_WRITE INTO LS_DATA_NEXT INDEX LV_TABIX.
*    IF LS_DATA_NEXT-VBELN = LS_DATA-VBELN
*     AND  LS_DATA_NEXT-VGBEL = LS_DATA-VGBEL
*     AND  LS_DATA_NEXT-VGPOS = LS_DATA-VGPOS.
*      CONTINUE.
*    ELSE.
*      LS_DATA-LFIMG = LV_SUM.
*      LS_DATA-LFIMGN =  LS_DATA-KWMENG -  LV_SUM.
*      APPEND LS_DATA TO LT_MERGED_DATA.
*      CLEAR LV_SUM.
*    ENDIF.
*  ENDLOOP.
*
DATA: LT_LFIMG TYPE TABLE OF LIPS,
LW_LFIMG  TYPE LIPS,
GF_LFIMG TYPE LIPS-LFIMG,
LV_TABIX TYPE INT4.

IF GT_WRITE[] IS NOT INITIAL.
SELECT VBELN POSNR VGBEL VGPOS LFIMG
INTO CORRESPONDING FIELDS OF  TABLE LT_LFIMG
FROM LIPS
FOR ALL ENTRIES IN GT_WRITE
WHERE VGBEL = GT_WRITE-VGBEL
AND VGPOS = GT_WRITE-VGPOS.
ENDIF.
LOOP AT GT_WRITE INTO GF_WRITE.
LV_TABIX = SY-TABIX.
LOOP AT LT_LFIMG INTO  LW_LFIMG
WHERE VGBEL = GF_WRITE-VGBEL
AND VGPOS = GF_WRITE-VGPOS .
GF_LFIMG = GF_LFIMG + LW_LFIMG-LFIMG .
ENDLOOP.
IF  SY-SUBRC = 0.
GF_WRITE-LFIMGN = GF_WRITE-KWMENG - GF_LFIMG .
ELSE.
GF_WRITE-LFIMGN = GF_WRITE-KWMENG - GF_WRITE-LFIMG .
ENDIF.
MODIFY  GT_WRITE  FROM GF_WRITE INDEX LV_TABIX.
CLEAR:GF_WRITE,GF_LFIMG .

ENDLOOP.


ENDFORM.                    " FRM_SUM_QUANTITY_DATA
