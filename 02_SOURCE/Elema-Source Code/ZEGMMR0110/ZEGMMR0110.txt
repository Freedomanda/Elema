*&---------------------------------------------------------------------*
*& プログラムID  : ZEGMMR0110
*&                 Purchase Order Report Output
*& 作成者        : ISID Zhu
*& 作成日        : 2014/11/14
*& 処理概要      : ・Purchase Orderの帳票出力を行う。
*&                 ・帳票出力は、帳票ツール（Paples）にて行うため、
*&                   SAPでは所定のフォルダへのファイル出力までを行う。
*&                ・個別のフォーマットに対応するため、帳票ツールを
*&                  使用しないケースも想定されるため、データの
*&                  ダウンロードを可能とする。
*& 変更履歴
*& No   DATE       MODIFYED BY   SUMMARY
*& 1    2014/12/25 iSiD Chen     プロトタイプのGAP対応
*& 2    2014/12/29 iSiD Chen     GAP対応の汎用モジュール化対応
*& 3    2015/01/21 ISID Chen     Codepage対応
*& 4    2015/02/03 ISID18        ダウンロード場合のコードページ対応
*& 5    2015/02/10 ISID18        プロトタイプのGAP対応
*& 6    2015/02/25 ISID18        SalesCoordinator対応
*&                               出力メッセージ対応
*& 7    2015/02/26 ISID18        DataInputUser対応
*& 8    2015/03/09 ISID18        テーブルEKKNを外部連結に変更
*& 9    2015/03/11 ISID18        支払条件取得ロジック
*&                               Remark取得ロジック
*&                               出荷先住所取得ロジック
*& 10   2015/04/29 ISID17        購買発注明細情報取得の実行条件を変更
*& 11   2015/05/25 ISID18        言語別に出力ファイル名を切り替える
*&                               EndUser編集ロジック追加
*&                               FinalDestination(在庫購買)編集
*& 12   2015/06/05 ISID18        削除明細を考慮する
*& 13   2015/06/12 ISID18        REPRINTの削除明細を考慮する
*& 14   2015/07/06 ISID18        品目テキスト対応
*& 15   2015/07/07 ISID18        ソート順対応
*& 16   2015/07/30 ISID18        ShippintTerms対応
*& 17   2015/08/24 ISID21        Final Destination対応
*& 18   2015/09/07 ISID17        品目関連情報の取得元対応
*& 19   2015/10/19 ISID18        PODateにPO伝票日付を設定するよう変更
*& 20   2015/12/3  ISID18         帳票項目追加
*& 21   2016/3/4   ISID18         複数のPOを同時に印刷する場合、enduser不正
*&---------------------------------------------------------------------*
***********************************************************************
REPORT ZEGMMR0110
LINE-SIZE 153
LINE-COUNT 58
NO STANDARD PAGE HEADING
MESSAGE-ID ZMEGSD01.

************************************************************************
* CONSTANTS定義
************************************************************************
CONSTANTS:
CNS_SPRAS_EN       TYPE SPRAS VALUE 'E',    " 英語
**** START DEL 2015/02/10 ISID18 ****
*  CNS_PARVW_ZJ       TYPE PARVW VALUE 'ZJ',   " 取引先機能
**** END DEL 2015/02/10 ISID18 ****
CNS_PARVW_PE       TYPE PARVW VALUE 'PE',   " 取引先機能
CNS_BSART_NB       TYPE BSART VALUE 'NB',   " 伝票タイプ
CNS_BSART_UB       TYPE BSART VALUE 'UB',   " 伝票タイプ
CNS_BSART_ZB       TYPE BSART VALUE 'ZB',   " 伝票タイプ
CNS_REPORT_10(2)   TYPE C     VALUE '10',   " レポートフォーマット
CNS_REPORT_20(2)   TYPE C     VALUE '20',   " レポートフォーマット
CNS_REPORT_30(2)   TYPE C     VALUE '30',   " レポートフォーマット
**** START ADD 2015/05/25 ISID18 ****
CNS_NAME TYPE ZTEGZZM999-NAME VALUE 'ENDUSER_DISPLAY',
**** END ADD 2015/05/25 ISID18 ****
CNS_LOCK_MODE(1)   TYPE C     VALUE 'E',    " Lock mode
CNS_TXT(4)         TYPE C     VALUE '.txt', " text file
CNS_MODE_P(1)      TYPE C     VALUE 'P',    " Print/Reprint
CNS_MODE_D(1)      TYPE C     VALUE 'D'.    " Download

************************************************************************
* TYPES定義
************************************************************************
* 購買発注データ
TYPES:
BEGIN OF TYP_TH_PO,
**** START ADD 2015/02/10 ISID18 ****
BUKRS      TYPE EKKO-BUKRS,   " 会社コード
**** END ADD 2015/02/10 ISID18 ****
BSART      TYPE EKKO-BSART,   " 購買伝票タイプ
AEDAT      TYPE EKKO-AEDAT,   " レコード登録日
ERNAM      TYPE EKKO-ERNAM,   " オブジェクト登録者
LIFNR      TYPE EKKO-LIFNR,   " 仕入先コード
**** START ADD 2015/03/11 ISID18 ****
SPRAS      TYPE EKKO-SPRAS,   " 言語キー
**** END ADD 2015/03/11 ISID18 ****
ZTERM      TYPE EKKO-ZTERM,   " 支払条件キー
EKORG      TYPE EKKO-EKORG,   " 購買組織
EKGRP      TYPE EKKO-EKGRP,   " 購買グループ
WAERS      TYPE EKKO-WAERS,   " 通貨
BEDAT      TYPE EKKO-BEDAT,   " 伝票日付
**** START ADD 2015/02/10 ISID18 ****
VERKF      TYPE EKKO-VERKF,   " 仕入先営業担当者
**** START ADD 2015/05/25 ISID18 ****
INCO2      TYPE EKKO-INCO2,   " インコタームズ (2)
**** END ADD 2015/05/25 ISID18 ****
SUBMI      TYPE EKKO-SUBMI,   " 一括番号 (見積依頼/見積書)
**** END ADD 2015/02/10 ISID18 ****
EBELN      TYPE EKPO-EBELN,   " 購買伝票番号
EBELP      TYPE EKPO-EBELP,   " 購買伝票の明細番号
TXZ01      TYPE EKPO-TXZ01,   " テキスト (短)
MATNR      TYPE EKPO-MATNR,   " 品目コード
WERKS      TYPE EKPO-WERKS,   " プラント
LGORT      TYPE EKPO-LGORT,   " 保管場所
IDNLF      TYPE EKPO-IDNLF,   " 仕入先品目コード
MENGE      TYPE EKPO-MENGE,   " 購買発注量
MEINS      TYPE EKPO-MEINS,   " 発注単位
NETPR      TYPE EKPO-NETPR,   " 購買伝票の正味価格 (伝票通貨)
PEINH      TYPE EKPO-PEINH,   " 価格単位
NETWR      TYPE EKPO-NETWR,   " 正味発注額 (購買発注通貨)
**** START ADD 2015/02/10 ISID18 ****
MWSKZ      TYPE EKPO-MWSKZ,   " 消費税コード
**** END ADD 2015/02/10 ISID18 ****
PSTYP      TYPE EKPO-PSTYP,   " 購買伝票の明細カテゴリ
KNTTP      TYPE EKPO-KNTTP,   " 勘定設定カテゴリ
**** START ADD 2015/02/10 ISID18 ****
EVERS      TYPE EKPO-EVERS,   " 出荷指示
**** END ADD 2015/02/10 ISID18 ****
INCO1      TYPE EKPO-INCO1,   " インコタームズ (1)
**** START ADD 2015/07/30 ISID18 ****
INCO2_ITEM TYPE EKPO-INCO2,   " インコタームズ (2)
**** END ADD 2015/07/30 ISID18 ****
ADRN2      TYPE EKPO-ADRN2,   " 納入先住所コード
XERSY      TYPE EKPO-XERSY,   " ERS（入庫/請求自動決済）
RETPO      TYPE EKPO-RETPO,   " 返品明細
EINDT      TYPE EKET-EINDT,   " 明細納入期日
VBELN      TYPE EKKN-VBELN,   " 販売管理伝票番号
VBELP      TYPE EKKN-VBELP,   " 販売伝票明細
END OF TYP_TH_PO,
TYP_TD_PO  TYPE STANDARD TABLE OF TYP_TH_PO.

TYPES:
BEGIN OF TYP_TH_ZTEGMMT011,
Z_OUTPUT_MODE TYPE ZEOUTPUTMODE,  " 出力モード
EBELN         TYPE EKKO-EBELN,    " 購買伝票番号
END OF TYP_TH_ZTEGMMT011,
TYP_TD_ZTEGMMT011 TYPE STANDARD TABLE OF TYP_TH_ZTEGMMT011.

TYPES:
BEGIN OF TYP_TH_LFA1_ADRC,
LIFNR      TYPE LFA1-LIFNR,       " 仕入先コード
**** START UPD 2015/02/10 ISID18 ****
*    NAME1      TYPE ADRC-NAME1,       " 名称１
NAME1      TYPE TEXT80,           " 名称１
**** END UPD 2015/02/10 ISID18 ****
CITY1      TYPE ADRC-CITY1,       " 市区町村
STREET     TYPE ADRC-STREET,      " 地名
**** START ADD 2014/12/26 ISID11 ****
STR_SUPPL1 TYPE ADRC-STR_SUPPL1,  "地名 2
STR_SUPPL2 TYPE ADRC-STR_SUPPL2,  "地名 3
**** END ADD 2014/12/26 ISID11 ****
TEL_NUMBER TYPE ADRC-TEL_NUMBER,  " 第一電話番号
FAX_NUMBER TYPE ADRC-FAX_NUMBER,  " 第一 FAX 番号
END OF TYP_TH_LFA1_ADRC,
TYP_TD_LFA1_ADRC TYPE STANDARD TABLE OF TYP_TH_LFA1_ADRC.

**** START DEL 2015/02/10 ISID18 ****
*TYPES:
*  BEGIN OF TYP_TH_TWLAD_ADRC,
*    WERKS      TYPE TWLAD-WERKS,      " プラント
*    LGORT      TYPE TWLAD-LGORT,      " 保管場所
*    LFDNR      TYPE TWLAD-LFDNR,      " 連続アドレス番号
*    ADRNR      TYPE TWLAD-ADRNR,      " アドレス番号
*    NAME1      TYPE ADRC-NAME1,       " 名称１
*    CITY1      TYPE ADRC-CITY1,       " 市区町村
*    STREET     TYPE ADRC-STREET,      " 地名
***** START ADD 2014/12/26 ISID11 ****
*    STR_SUPPL1 TYPE ADRC-STR_SUPPL1,  " 地名 2
*    STR_SUPPL2 TYPE ADRC-STR_SUPPL2,  " 地名 3
***** END ADD 2014/12/26 ISID11 ****
*    TEL_NUMBER TYPE ADRC-TEL_NUMBER,  " 第一電話番号
*    FAX_NUMBER TYPE ADRC-FAX_NUMBER,  " 第一 FAX 番号
*  END OF TYP_TH_TWLAD_ADRC,
*  TYP_TD_TWLAD_ADRC TYPE STANDARD TABLE OF TYP_TH_TWLAD_ADRC.
*
*TYPES:
*  BEGIN OF TYP_TH_ADRC,
*    ADDRNUMBER TYPE ADRC-ADDRNUMBER,  " アドレス番号
*    NAME1      TYPE ADRC-NAME1,       " 名称１
*    CITY1      TYPE ADRC-CITY1,       " 市区町村
*    STREET     TYPE ADRC-STREET,      " 地名
***** START ADD 2014/12/26 ISID11 ****
*    STR_SUPPL1 TYPE ADRC-STR_SUPPL1,  "地名 2
*    STR_SUPPL2 TYPE ADRC-STR_SUPPL2,  "地名 3
***** END ADD 2014/12/26 ISID11 ****
*    TEL_NUMBER TYPE ADRC-TEL_NUMBER,  " 第一電話番号
*    FAX_NUMBER TYPE ADRC-FAX_NUMBER,  " 第一 FAX 番号
*    END OF TYP_TH_ADRC,
*    TYP_TD_ADRC TYPE STANDARD TABLE OF TYP_TH_ADRC.
**** END DEL 2015/02/10 ISID18 ****

**** START ADD 2014/12/29 ISID11 ****
TYPES:
BEGIN OF TYP_TH_LFA1,
LIFNR      TYPE LFA1-LIFNR,       " 仕入先
ADRNR      TYPE LFA1-ADRNR,       " アドレス
END OF TYP_TH_LFA1,
TYP_TD_LFA1 TYPE STANDARD TABLE OF TYP_TH_LFA1.

**** START DEL 2015/02/10 ISID18 ****
*  BEGIN OF TYP_TH_TWLAD,
*    WERKS      TYPE TWLAD-WERKS,      " プラント
*    LGORT      TYPE TWLAD-LGORT,      " 保管場所
*    LFDNR      TYPE TWLAD-LFDNR,      " 連続アドレス番号
*    ADRNR      TYPE TWLAD-ADRNR,      " アドレス番号
*  END OF TYP_TH_TWLAD,
*  TYP_TD_TWLAD TYPE STANDARD TABLE OF TYP_TH_TWLAD,
*
*  BEGIN OF TYP_TH_VBELN,
*    VBELN      TYPE VBPA-VBELN ,
*    POSNR      TYPE VBPA-POSNR ,
*    ADRNR      TYPE VBPA-ADRNR ,
*  END OF TYP_TH_VBELN,
*  TYP_TD_VBELN TYPE STANDARD TABLE OF TYP_TH_VBELN.
**** END DEL 2015/02/10 ISID18 ****
**** END ADD 2014/12/29 ISID11 ****

TYPES:
BEGIN OF TYP_TH_EINA_T069T,
LIFNR      TYPE EINA-LIFNR,       " 仕入先コード
MATNR      TYPE EINA-MATNR,       " 品目コード
URZTX      TYPE T069T-URZTX,      " 証明書テキスト
END OF TYP_TH_EINA_T069T,
TYP_TD_EINA_T069T TYPE STANDARD TABLE OF TYP_TH_EINA_T069T.

**** START ADD 2015/02/10 ISID18 ****
TYPES:
BEGIN OF TYP_TH_TVKO,
VKORG      TYPE TVKO-VKORG,       " 販売組織
BUKRS      TYPE TVKO-BUKRS,       " 会社コード
VTWEG      TYPE TVKOV-VTWEG,      " 流通チャンネル
END OF TYP_TH_TVKO,
TYP_TD_TVKO TYPE STANDARD TABLE OF TYP_TH_TVKO.

TYPES:
BEGIN OF TYP_TH_VBAK_KNA1,
VBELN      TYPE VBAK-VBELN,       " 販売伝票
NAME1      TYPE TEXT80,           " 名称
END OF TYP_TH_VBAK_KNA1,
TYP_TD_VBAK_KNA1 TYPE STANDARD TABLE OF TYP_TH_VBAK_KNA1.
**** END ADD 2015/02/10 ISID18 ****

TYPES:
BEGIN OF TYP_TH_T024,
EKGRP      TYPE T024-EKGRP,       " 購買グループ
EKNAM      TYPE T024-EKNAM,       " 購買グループテキスト
END OF TYP_TH_T024,
TYP_TD_T024 TYPE STANDARD TABLE OF TYP_TH_T024.

TYPES:
BEGIN OF TYP_TH_T052U,
**** START UPD 2015/03/11 ISID18 ****
*    ZTERM      TYPE EKKO-ZTERM,       " 支払条件キー
*    TEXT1      TYPE T052U-TEXT1,      " 支払条件の固有テキスト
ZTERM   TYPE ZTEGSDM011-ZTERM,          " 支払条件キー
TEXT1   TYPE ZTEGSDM011-Z_PAYMENT_TEXT, " 支払条件の固有テキスト
**** END UPD 2015/03/11 ISID18 ****
END OF TYP_TH_T052U,
TYP_TD_T052U TYPE STANDARD TABLE OF TYP_TH_T052U.

**** START DEL 2015/02/10 ISID18 ****
*TYPES:
*  BEGIN OF TYP_TH_T001K,
*    WERKS      TYPE T001W-WERKS,      " プラント
*    BUKRS      TYPE T001-BUKRS,       " 会社コード
*    END OF TYP_TH_T001K,
*    TYP_TD_T001K TYPE STANDARD TABLE OF TYP_TH_T001K.
**** END DE 2015/02/10 ISID18 ****

TYPES:
BEGIN OF TYP_TH_ZTEGMMM001,
MATNR          TYPE EKPO-MATNR,    " 品目コード
BUKRS          TYPE T001-BUKRS,    " 会社コード
**** START ADD 2015/02/10 ISID18 ****
Z_ENDUSER_CD   TYPE ZEENDUSERCD,   " EndUser
Z_ENDUSER      TYPE ZEENDUSER,     " EndUser
**** END ADD 2015/02/10 ISID18 ****
Z_PURPOSE_TEXT TYPE ZEPURPOSETEXT, " Purpose
**** START ADD 2015/08/24 ISID21 ****
LANDX          TYPE T005T-LANDX,   " Country name
**** END ADD 2015/08/24 ISID21 ****
END OF TYP_TH_ZTEGMMM001,
TYP_TD_ZTEGMMM001 TYPE STANDARD TABLE OF TYP_TH_ZTEGMMM001.

**** START ADD 2015/05/25 ISID18 ****
TYPES:
BEGIN OF TYP_TH_LFB1,
LIFNR      TYPE LFB1-LIFNR,        " 仕入先コード
BUKRS      TYPE LFB1-BUKRS,        " 会社コード
FDGRV      TYPE LFB1-FDGRV,        " 計画グループ
END OF TYP_TH_LFB1,
TYP_TD_LFB1 TYPE STANDARD TABLE OF TYP_TH_LFB1.

TYPES:
BEGIN OF TYP_TH_ZTEGZZM999,
LOW        TYPE ZTEGZZM999-LOW,
END OF TYP_TH_ZTEGZZM999.
**** END ADD 2015/05/25 ISID18 ****

TYPES:
BEGIN OF TYP_TH_VBPA,
VBELN      TYPE VBPA-VBELN,        " 販売管理伝票番号
POSNR      TYPE VBPA-POSNR,        " 明細番号 (販売管理伝票)
PERNR      TYPE VBPA-PERNR,        " 従業員番号
END OF TYP_TH_VBPA,
TYP_TD_VBPA TYPE STANDARD TABLE OF TYP_TH_VBPA.

**** START ADD 2015/02/10 ISID18 ****
TYPES:
BEGIN OF TYP_TH_EKPA,
EBELN      TYPE EKPA-EBELN,       " 購買伝票
PERNR      TYPE EKPA-PERNR,       " 従業員番号
END OF TYP_TH_EKPA,
TYP_TD_EKPA TYPE STANDARD TABLE OF TYP_TH_EKPA.

TYPES:
BEGIN OF TYP_TH_VBPA_T005T,
VBELN      TYPE VBPA-VBELN,       " 販売管理伝票番号
LANDX      TYPE T005T-LANDX,      " 出荷先国名
END OF TYP_TH_VBPA_T005T,
TYP_TD_VBPA_T005T TYPE STANDARD TABLE OF TYP_TH_VBPA_T005T.
**** END AD 2015/02/10 ISID18 ****

TYPES:
BEGIN OF TYP_TH_PA0001,
PERNR      TYPE PA0001-PERNR,      " 従業員番号
BEGDA      TYPE PA0001-BEGDA,      " 開始日付
**** START UPD 2015/02/25 ISID18 ****
*    SNAME      TYPE PA0001-SNAME,      " 従業員名
ENAME      TYPE PA0001-ENAME,      " 従業員名
**** END UPD 2015/02/25 ISID18 ****
END OF TYP_TH_PA0001,
TYP_TD_PA0001 TYPE STANDARD TABLE OF TYP_TH_PA0001.

**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
TYPES:
BEGIN OF TYP_TH_USR21_ADRP,
BNAME      TYPE USR21-BNAME,       " ユーザマスタのユーザ名
NAME_TEXT  TYPE ADRP-NAME_TEXT,    " 氏名 (省略なし)
END OF TYP_TH_USR21_ADRP,
TYP_TD_USR21_ADRP TYPE STANDARD TABLE OF TYP_TH_USR21_ADRP.
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****

TYPES:
BEGIN OF TYP_TH_VBKD,
VBELN      TYPE VBKD-VBELN,        " 販売管理伝票番号
POSNR      TYPE VBKD-POSNR,        " 明細番号 (販売管理伝票)
BSTKD      TYPE VBKD-BSTKD,        " 得意先発注番号
END OF TYP_TH_VBKD,
TYP_TD_VBKD TYPE STANDARD TABLE OF TYP_TH_VBKD.

**** START DEL 2015/02/10 ISID18 ****
*TYPES:
*  BEGIN OF TYP_TH_VBPA_ADRC,
*    VBELN      TYPE VBPA-VBELN,        " 販売管理伝票番号
*    POSNR      TYPE VBPA-POSNR,        " 明細番号 (販売管理伝票)
*    NAME1      TYPE ADRC-NAME1,        " 名称１
*    END OF TYP_TH_VBPA_ADRC,
*    TYP_TD_VBPA_ADRC TYPE STANDARD TABLE OF TYP_TH_VBPA_ADRC.
**** END DEL 2015/02/10 ISID18 ****

TYPES:
BEGIN OF TYP_TH_ZTEGZZM002,
WAERS      TYPE WAERS,             " 変換前通貨コード
Z_WAERS    TYPE ZEWAERS,           " 変換後通貨コード
END OF TYP_TH_ZTEGZZM002,
TYP_TD_ZTEGZZM002 TYPE STANDARD TABLE OF TYP_TH_ZTEGZZM002.

TYPES:
BEGIN OF TYP_TH_LFA1_T005X,
LIFNR      TYPE LFA1-LIFNR,        " 仕入先コード
LAND1      TYPE LFA1-LAND1,        " 国コード
XDEZP      TYPE T005X-XDEZP,       " 小数点書式
DATFM      TYPE T005X-DATFM,       " 日付書式
END OF TYP_TH_LFA1_T005X,
TYP_TD_LFA1_T005X TYPE STANDARD TABLE OF TYP_TH_LFA1_T005X.

TYPES:
BEGIN OF TYP_TH_MSG,
TYPE(15)   TYPE C,                 " メッセージタイプ
TEXT(128)  TYPE C,                 " メッセージ内容
END OF TYP_TH_MSG,
TYP_TD_MSG TYPE STANDARD TABLE OF TYP_TH_MSG,
TYP_TD_ZSEGMM0001 TYPE STANDARD TABLE OF ZSEGMM0001.

TYPES:
BEGIN OF TYP_TH_FILENAME,
BUKRS    TYPE T001K-BUKRS,         " 会社コード
FILENAME TYPE STRING,              " ファイル名
CODEPAGE TYPE ZEOUTPUTCP,          " コードページ名
END OF TYP_TH_FILENAME,
TYP_TD_FILENAME TYPE STANDARD TABLE OF TYP_TH_FILENAME.

TYPES:
BEGIN OF TYP_TH_FILE,
INCLUDE TYPE ZSEGMM0001.
TYPES BUKRS TYPE T001-BUKRS.
TYPES END OF TYP_TH_FILE.
TYPES TYP_TD_FILE TYPE STANDARD TABLE OF TYP_TH_FILE.
TYPES TYP_TD_ZTEGMMT012 TYPE STANDARD TABLE OF ZTEGMMT012.
************************************************************************
* DATA定義
************************************************************************
* 画面パラメータ参照変数定義
DATA:
W_WERKS     TYPE T001W-WERKS,        " Plant
W_EKORG     TYPE EKKO-EKORG,         " Purch. Org.
W_EKGRP     TYPE EKKO-EKGRP,         " Purch. Group
W_BEDAT     TYPE EKKO-BEDAT,         " Doc. Date
W_LIFNR     TYPE EKKO-LIFNR,         " Vendor
**** START ADD 2015/03/11 ISID18 ****
W_SPRAS     TYPE EKKO-SPRAS,         " Language
**** END ADD 2015/03/11 ISID18 ****
W_BSART     TYPE EKKO-BSART,         " Order Type
W_EBELN     TYPE EKKO-EBELN,         " Purchase Order
W_MATNR     TYPE EKPO-MATNR,         " Material
W_EINDT     TYPE EKET-EINDT,         " Delivery Date
W_PSTYP     TYPE EKPO-PSTYP,         " Item Category
W_KNTTP     TYPE EKPO-KNTTP,         " Acct Assgt Cat.
W_AEDAT     TYPE EKKO-AEDAT,         " Created on
W_ERNAM     TYPE EKKO-ERNAM.         " Created by

* ワーク変数
DATA:
W_RECORD_TOT TYPE I,                 " 処理件数
W_RECORD_OK  TYPE I,                 " 成功件数
W_RECORD_ERR TYPE I.                 " エラー件数

* 内部テーブル定義
DATA:
**** START ADD 2015/05/25 ISID18 ****
TH_ZTEGZZM999 TYPE TYP_TH_ZTEGZZM999,
**** END ADD 2015/05/25 ISID18 ****
TD_PO         TYPE TYP_TD_PO,
TD_ZTEGMMT011 TYPE TYP_TD_ZTEGMMT011,
TD_LFA1_ADRC  TYPE TYP_TD_LFA1_ADRC,
**** START DEL 2015/02/10 ISID18 ****
*  TD_TWLAD_ADRC TYPE TYP_TD_TWLAD_ADRC,
*  TD_ADRC       TYPE TYP_TD_ADRC,
**** END DEL 2015/02/10 ISID18 ****
TD_EINA_T069T TYPE TYP_TD_EINA_T069T,
**** START ADD 2015/02/10 ISID18 ****
TD_TVKO       TYPE TYP_TD_TVKO,
TD_VBAK_KNA1  TYPE TYP_TD_VBAK_KNA1,
TD_EKPA       TYPE TYP_TD_EKPA,
TD_VBPA_T005T TYPE TYP_TD_VBPA_T005T,
**** END ADD 2015/02/10 ISID18 ****
TD_T024       TYPE TYP_TD_T024,
TD_T052U      TYPE TYP_TD_T052U,
**** START DEL 2015/02/10 ISID18 ****
*  TD_T001K      TYPE TYP_TD_T001K,
**** END DE 2015/02/10 ISID18 ****
TD_ZTEGMMM001 TYPE TYP_TD_ZTEGMMM001,
**** START ADD 2015/05/25 ISID18 ****
TD_LFB1       TYPE TYP_TD_LFB1,
**** END ADD 2015/05/25 ISID18 ****
TD_VBPA       TYPE TYP_TD_VBPA,
TD_PA0001     TYPE TYP_TD_PA0001,
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
TD_USR21_ADRP TYPE TYP_TD_USR21_ADRP,
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****
TD_VBKD       TYPE TYP_TD_VBKD,
**** START DEL 2015/02/10 ISID18 ****
*  TD_VBPA_ADRC  TYPE TYP_TD_VBPA_ADRC,
**** END DEL 2015/02/10 ISID18 ****
TD_ZTEGZZM002 TYPE TYP_TD_ZTEGZZM002,
TD_LFA1_T005X TYPE TYP_TD_LFA1_T005X,
TD_SFILE      TYPE TYP_TD_ZSEGMM0001,
TD_FILENAME   TYPE TYP_TD_FILENAME,
TD_FILE_BUKRS TYPE TYP_TD_FILE,
TD_MSG        TYPE TYP_TD_MSG.
************************************************************************
* 選択画面定義
************************************************************************
* Mode(Print/Reprint/Download)
SELECTION-SCREEN BEGIN OF BLOCK B1 WITH FRAME TITLE TEXT-001.
SELECTION-SCREEN BEGIN OF LINE.
SELECTION-SCREEN POSITION 32.
PARAMETERS RB_PRINT RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 34(15) TEXT-002 FOR FIELD RB_PRINT.
SELECTION-SCREEN POSITION 52.
PARAMETERS RB_REPNT RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 54(15) TEXT-003 FOR FIELD RB_REPNT.
SELECTION-SCREEN POSITION 72.
PARAMETERS RB_DOWNL RADIOBUTTON GROUP RB1.
SELECTION-SCREEN COMMENT 74(15) TEXT-004 FOR FIELD RB_DOWNL.
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK B1.

* Print option(Printer/tray)
SELECTION-SCREEN BEGIN OF BLOCK B2 WITH FRAME TITLE TEXT-005.
PARAMETERS P_TRAY TYPE TSP03L-LNAME.
SELECTION-SCREEN END OF BLOCK B2.

* Download option(File path)
SELECTION-SCREEN BEGIN OF BLOCK B3 WITH FRAME TITLE TEXT-006.
PARAMETERS P_FILE TYPE RLGRAP-FILENAME.
SELECTION-SCREEN END OF BLOCK B3.

* Purchase Order
SELECTION-SCREEN BEGIN OF BLOCK B4 WITH FRAME TITLE TEXT-007.
SELECT-OPTIONS:
S_WERKS FOR W_WERKS OBLIGATORY MEMORY ID WRK,  " Plant
S_EKORG FOR W_EKORG MEMORY ID EKO,             " Purch. Org.
S_EKGRP FOR W_EKGRP MEMORY ID EKG,             " Purch. Group
S_BEDAT FOR W_BEDAT,                           " Doc. Date
S_LIFNR FOR W_LIFNR,                           " Vendor
**** START ADD 2015/03/11 ISID18 ****
S_SPRAS FOR W_SPRAS,                           " Language
**** END ADD 2015/03/11 ISID18 ****
S_BSART FOR W_BSART MEMORY ID BSA,             " Order Type
S_EBELN FOR W_EBELN,                           " Purchase Order
S_MATNR FOR W_MATNR,                           " Material
S_EINDT FOR W_EINDT,                           " Delivery Date
S_PSTYP FOR W_PSTYP,                           " Item Category
S_KNTTP FOR W_KNTTP MEMORY ID KNT,             " Acct Assgt Cat.
S_AEDAT FOR W_AEDAT,                           " Created on
S_ERNAM FOR W_ERNAM                            " Created by
MATCHCODE OBJECT USER_COMP.
SELECTION-SCREEN END OF BLOCK B4.

* Report Parameter
SELECTION-SCREEN BEGIN OF BLOCK B5 WITH FRAME TITLE TEXT-008.
PARAMETERS P_CNAME  TYPE ZTEGMMT012-Z_COMP_NAME.    " Company Name
PARAMETERS P_CADD1  TYPE ZTEGMMT012-Z_COMP_ADDRESS1." Company Address1
PARAMETERS P_CADD2  TYPE ZTEGMMT012-Z_COMP_ADDRESS2." Company Address2
PARAMETERS P_CTEL   TYPE ZTEGMMT012-Z_COMP_TEL.     " Company Tel
PARAMETERS P_CFAX   TYPE ZTEGMMT012-Z_COMP_FAX.     " Company Fax
PARAMETERS P_XDEZP  TYPE T005X-XDEZP.             " Decimals notation
PARAMETERS P_DATFM  TYPE T005X-DATFM.             " Date format
**** START ADD 2014/12/26 ISID11 ****
PARAMETERS P_LANGU  TYPE T002-SPRAS.         "Report Language
PARAMETERS P_TITLE  TYPE ZTEGMMT012-Z_REPORT_TITLE.  "Report Title
**** END ADD 2014/12/26 ISID11 ****
SELECTION-SCREEN END OF BLOCK B5.
************************************************************************
* 初期値定義
************************************************************************
INITIALIZATION.

**** START ADD 2015/02/10 ISID18 ****
PERFORM GET_DEFAULT_PRINTER.
**** END ADD 2015/02/10 ISID18 ****

************************************************************************
* File Pathの検索ヘルプ
************************************************************************
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_FILE.

DATA:
LW_FILENAME   TYPE STRING,
LW_PATH       TYPE STRING,
LW_FULLPATH   TYPE STRING.

CALL METHOD CL_GUI_FRONTEND_SERVICES=>FILE_SAVE_DIALOG
CHANGING
FILENAME             = LW_FILENAME
PATH                 = LW_PATH
FULLPATH             = LW_FULLPATH
EXCEPTIONS
CNTL_ERROR           = 1
ERROR_NO_GUI         = 2
NOT_SUPPORTED_BY_GUI = 3
OTHERS               = 4.

IF SY-SUBRC = 0.
P_FILE = LW_FULLPATH.
ENDIF.

************************************************************************
* 選択画面チェック
************************************************************************
AT SELECTION-SCREEN.

* 入力項目チェック
PERFORM SEL_VALIDATE.

************************************************************************
* メイン処理
************************************************************************
START-OF-SELECTION.

* データ抽出処理
PERFORM READ_DATA
CHANGING TD_PO               " 購買発注伝票のデータ
TD_ZTEGMMT011       " Output Management
TD_LFA1_ADRC        " 仕入先情報
**** START DEL 2015/02/10 ISID18 ****
*             TD_TWLAD_ADRC       " 保管場所住所情報
*             TD_ADRC             " 納入先住所情報
**** END DEL 2015/02/10 ISID18 ****
TD_EINA_T069T       " 証明書カテゴリテキスト
**** START ADD 2015/02/10 ISID18 ****
TD_TVKO             " 販売組織
**** END ADD 2015/02/10 ISID18 ****
TD_T024             " 購買グループテキスト
TD_T052U            " 支払条件テキスト
**** START DEL 2015/02/10 ISID18 ****
*             TD_T001K            " 会社コード
**** END DEL 2015/02/10 ISID18 ****
TD_ZTEGMMM001       " Purpose
**** START ADD 2015/02/10 ISID18 ****
**** START ADD 2015/05/25 ISID18 ****
TD_LFB1
TH_ZTEGZZM999
**** END ADD 2015/05/25 ISID18 ****
TD_VBAK_KNA1
TD_EKPA
**** END ADD 2015/02/10 ISID18 ****
TD_VBPA             " 従業員番号
TD_PA0001           " 従業員名
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
TD_USR21_ADRP       " 氏名
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****
TD_VBKD             " CustomerPONo
**** START ADD 2015/02/10 ISID18 ****
TD_VBPA_T005T
**** END ADD 2015/02/10 ISID18 ****
**** START DEL 2015/02/10 ISID18 ****
*             TD_VBPA_ADRC        " EndUser
**** END DEL 2015/02/10 ISID18 ****
TD_ZTEGZZM002       " 通貨コード
TD_LFA1_T005X       " 小数点書式、日付書式
TD_FILENAME.        " ファイル名

* Edit the extracted data
PERFORM EDIT_DATA
USING    TD_PO               " 購買発注伝票のデータ
TD_ZTEGMMT011       " Output Management
TD_LFA1_ADRC        " 仕入先情報
**** START DEL 2015/02/10 ISID18 ****
*             TD_TWLAD_ADRC       " 保管場所住所情報
*             TD_ADRC             " 納入先住所情報
**** END DEL 2015/02/10 ISID18 ****
TD_EINA_T069T       " 証明書カテゴリテキスト
**** START ADD 2015/02/10 ISID18 ****
TD_TVKO             " 販売組織
**** END ADD 2015/02/10 ISID18 ****
TD_T024             " 購買グループテキスト
TD_T052U            " 支払条件テキスト
**** START DEL 2015/02/10 ISID18 ****
*             TD_T001K            " 会社コード
**** END DEL 2015/02/10 ISID18 ****
TD_ZTEGMMM001       " Purpose
**** START ADD 2015/02/10 ISID18 ****
**** START ADD 2015/05/25 ISID18 ****
TD_LFB1
TH_ZTEGZZM999
**** END ADD 2015/05/25 ISID18 ****
TD_VBAK_KNA1
TD_EKPA
**** END ADD 2015/02/10 ISID18 ****
TD_VBPA             " 従業員番号
TD_PA0001           " 従業員名
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
TD_USR21_ADRP       " 氏名
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****
TD_VBKD             " CustomerPONo
**** START ADD 2015/02/10 ISID18 ****
TD_VBPA_T005T
**** END ADD 2015/02/10 ISID18 ****
**** START DEL 2015/02/10 ISID18 ****
*             TD_VBPA_ADRC        " EndUser
**** END DEL 2015/02/10 ISID18 ****
TD_ZTEGZZM002       " 通貨コード
TD_LFA1_T005X       " 小数点書式、日付書式
TD_FILENAME         " ファイル名
CHANGING TD_SFILE            " 出力ファイル
TD_FILE_BUKRS       " 出力ファイル(会社コード)
TD_MSG              " メッセージ
W_RECORD_TOT        " 処理件数
W_RECORD_ERR        " エラー件数
W_RECORD_OK.        " 成功件数

* File output
PERFORM OUTPUT_DATA
USING    TD_FILE_BUKRS       " 出力ファイル(会社コード)
TD_FILENAME         " ファイル名
CHANGING TD_SFILE            " 出力ファイル
TD_MSG.             " メッセージ

************************************************************************
* END-OF-SELECTION
************************************************************************
END-OF-SELECTION.

* Write result screen.
PERFORM WRITE_OUT
USING TD_FILENAME         " ファイル名
W_RECORD_TOT        " 処理件数
W_RECORD_ERR        " エラー件数
W_RECORD_OK         " 成功件数
TD_MSG.

************************************************************************
* TOP-OF-PAGE
************************************************************************
TOP-OF-PAGE.

* ヘッダ部
PERFORM HEADER_OUT.

************************************************************************
*      Form  sel_validate
************************************************************************
*     選択画面入力項目チェック
************************************************************************
FORM SEL_VALIDATE.

TYPES:
BEGIN OF LTYP_T001W,
WERKS TYPE T001W-WERKS,
END OF LTYP_T001W.
DATA:
LTH_T001W TYPE LTYP_T001W,
LTD_T001W TYPE STANDARD TABLE OF LTYP_T001W.

* プラントの存在チェック
SELECT WERKS
INTO TABLE LTD_T001W
FROM T001W
WHERE WERKS IN S_WERKS.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
MESSAGE E004 WITH S_WERKS-LOW.
ENDIF.

* 条件必須チェック
* 選択画面「Print」「Reprint」が選択されている場合
* 選択画面の「Printer/Tray」が未入力の場合
IF RB_PRINT = 'X' OR
RB_REPNT = 'X'.
IF P_TRAY IS INITIAL.
SET CURSOR FIELD 'P_TRAY'.
MESSAGE E031 WITH TEXT-009.
ENDIF.
ENDIF.

* 選択画面「Download」が選択されている場合
* 選択画面の「File Path」が未入力の場合
IF RB_DOWNL = 'X'.
IF P_FILE IS INITIAL.
SET CURSOR FIELD 'P_FILE'.
MESSAGE E031 WITH TEXT-010.
ENDIF.
ENDIF.

* プラントの権限チェック
LOOP AT LTD_T001W INTO LTH_T001W.
AUTHORITY-CHECK OBJECT 'M_MSEG_WMB'
ID 'WERKS' FIELD LTH_T001W-WERKS
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
MESSAGE E003.
ENDIF.
ENDLOOP.

ENDFORM.                    "GS_SELVALIDATE
************************************************************************
*       Form  read_data
************************************************************************
*      データ抽出処理
************************************************************************
*      <--O_TD_DATA             購買発注伝票データ
*      <--O_TD_ZTEGMMT011       Output Management(PurchaseOrder)
*      <--O_TD_LFA1_ADRC        仕入先情報
*      <--O_TD_TWLAD_ADRC       保管場所住所情報
*      <--O_TD_ADRC             納入先住所情報
*      <--O_TD_EINA_T069T       証明書カテゴリテキスト
*      <--O_TD_T024             購買グループテキスト
*      <--O_TD_T052U            支払条件テキスト
*      <--O_TD_T001K            会社コード
*      <--O_TD_ZTEGMMM001       Purpose
*      <--O_TD_VBPA             従業員番号
*      <--O_TD_PA0001           従業員名
*      <--O_TD_USR21_ADRP       氏名
*      <--O_TD_VBKD             CustomerPONo
*      <--O_TD_VBPA_ADRC        EndUser
*      <--O_TD_ZTEGZZM002       通貨コード
*      <--O_TD_LFA1_T005X       小数点書式、日付書式
*      <--O_TD_FILENAME         ファイル名
************************************************************************
FORM READ_DATA
CHANGING O_TD_PO         TYPE TYP_TD_PO
O_TD_ZTEGMMT011 TYPE TYP_TD_ZTEGMMT011
O_TD_LFA1_ADRC  TYPE TYP_TD_LFA1_ADRC
**** START DEL 2015/02/10 ISID18 ****
*           O_TD_TWLAD_ADRC TYPE TYP_TD_TWLAD_ADRC
*           O_TD_ADRC       TYPE TYP_TD_ADRC
**** END DEL 2015/02/10 ISID18 ****
O_TD_EINA_T069T TYPE TYP_TD_EINA_T069T
**** START ADD 2015/02/10 ISID18 ****
O_TD_TVKO       TYPE TYP_TD_TVKO
**** END ADD 2015/02/10 ISID18 ****
O_TD_T024       TYPE TYP_TD_T024
O_TD_T052U      TYPE TYP_TD_T052U
**** START DEL 2015/02/10 ISID18 ****
*           O_TD_T001K      TYPE TYP_TD_T001K
**** END DEL 2015/02/10 ISID18 ****
O_TD_ZTEGMMM001 TYPE TYP_TD_ZTEGMMM001
**** START ADD 2015/02/10 ISID18 ****
**** START ADD 2015/05/25 ISID18 ****
O_TD_LFB1       TYPE TYP_TD_LFB1
O_TH_ZTEGZZM999 TYPE TYP_TH_ZTEGZZM999
**** END ADD 2015/05/25 ISID18 ****
O_TD_VBAK_KNA1  TYPE TYP_TD_VBAK_KNA1
O_TD_EKPA       TYPE TYP_TD_EKPA
**** END ADD 2015/02/10 ISID18 ****
O_TD_VBPA       TYPE TYP_TD_VBPA
O_TD_PA0001     TYPE TYP_TD_PA0001
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
O_TD_USR21_ADRP TYPE TYP_TD_USR21_ADRP
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****
O_TD_VBKD       TYPE TYP_TD_VBKD
**** START ADD 2015/02/10 ISID18 ****
O_TD_VBPA_T005T TYPE TYP_TD_VBPA_T005T
**** END ADD 2015/02/10 ISID18 ****
**** START DEL 2015/02/10 ISID18 ****
*           O_TD_VBPA_ADRC  TYPE TYP_TD_VBPA_ADRC
**** END DEL 2015/02/10 ISID18 ****
O_TD_ZTEGZZM002 TYPE TYP_TD_ZTEGZZM002
O_TD_LFA1_T005X TYPE TYP_TD_LFA1_T005X
O_TD_FILENAME   TYPE TYP_TD_FILENAME.

* 購買発注伝票データ取得
PERFORM GET_PO_DATA
CHANGING O_TD_PO.

* Output Management(PurchaseOrder)データ取得
PERFORM GET_ZTEGMMT011
USING    O_TD_PO
CHANGING O_TD_ZTEGMMT011.

**** START ADD 2015/02/10 ISID18 ****
* 購買発注データ限定
PERFORM GET_PRINT_DATA
USING    O_TD_ZTEGMMT011
CHANGING O_TD_PO.
**** END ADD 2015/02/10 ISID18 ****

* 仕入先住所情報の取得
PERFORM GET_LFA1_ADRC
USING    O_TD_PO
CHANGING O_TD_LFA1_ADRC.

**** START DEL 2015/02/10 ISID18 ****
** 保管場所住所情報の取得
*  PERFORM GET_TWLAD_ADRC
*    USING    O_TD_PO
*    CHANGING O_TD_TWLAD_ADRC.
*
** 納入先住所情報の取得
*  PERFORM GET_ADRC
*    USING    O_TD_PO
*    CHANGING O_TD_ADRC.
**** END DEL 2015/02/10 ISID18 ****

* 証明書カテゴリテキスト取得
PERFORM GET_EINA_T069T
USING    O_TD_PO
CHANGING O_TD_EINA_T069T.

**** START ADD 2015/02/10 ISID18 ****
PERFORM GET_TVKO
USING    O_TD_PO
CHANGING O_TD_TVKO.
**** END ADD 2015/02/10 ISID18 ****

* 購買グループテキスト取得
PERFORM GET_T024
USING    O_TD_PO
CHANGING O_TD_T024.

* 支払条件テキスト取得
PERFORM GET_T052U
USING    O_TD_PO
CHANGING O_TD_T052U.

* 実需マスタ情報の取得
PERFORM GET_ZTEGMMM001
USING    O_TD_PO
**** START UPD 2015/02/10 ISID18 ****
*    CHANGING O_TD_T001K
*             O_TD_ZTEGMMM001.
CHANGING O_TD_ZTEGMMM001
**** END UPD 2015/02/10 ISID18 ****
**** START ADD 2015/05/25 ISID18 ****
O_TD_LFB1
O_TH_ZTEGZZM999.
**** END ADD 2015/05/25 ISID18 ****

**** START ADD 2015/02/10 ISID18 ****
PERFORM GET_VBAK_KNA1
USING    O_TD_PO
CHANGING O_TD_VBAK_KNA1.
**** END ADD 2015/02/10 ISID18 ****

* 受注関連情報取得
**** START UPD 2015/02/10 ISID18 ****
*  PERFORM GET_SO_DATA
*    USING    O_TD_PO
*    CHANGING O_TD_VBPA
*             O_TD_PA0001
*             O_TD_USR21_ADRP
*             O_TD_VBKD
*             O_TD_VBPA_ADRC.
PERFORM GET_SO_DATA
USING    O_TD_PO
CHANGING O_TD_VBPA
O_TD_PA0001
**** START ADD 2015/02/26 ISID18 ****
O_TD_USR21_ADRP
**** END ADD 2015/02/26 ISID18 ****
O_TD_EKPA
O_TD_VBKD.
**** END UPD 2015/02/10 ISID18 ****

**** START ADD 2015/02/10 ISID18 ****
PERFORM GET_VBPA_T005T
USING    O_TD_PO
CHANGING O_TD_VBPA_T005T.
**** END ADD 2015/02/10 ISID18 ****

* 通貨コード変換
PERFORM GET_ZTEGZZM002
USING    O_TD_PO
CHANGING O_TD_ZTEGZZM002.

* 小数点書式、日付書式取得
PERFORM GET_LFA1_T005X
USING    O_TD_PO
CHANGING O_TD_LFA1_T005X.

* 帳票用ファイル名取得
PERFORM GET_SERVER_FILE
**** START UPD 2015/02/10 ISID18 ****
*    USING    O_TD_T001K
USING    O_TD_PO
**** END UPD 2015/02/10 ISID18 ****
CHANGING O_TD_FILENAME.

ENDFORM.                    "read_data
************************************************************************
*       Form  GET_PO_DATA
************************************************************************
*       購買発注伝票データ取得
************************************************************************
*      <--O_TD_DATA  購買発注伝票データ
************************************************************************
FORM GET_PO_DATA
CHANGING O_TD_DATA TYPE TYP_TD_PO.

REFRESH O_TD_DATA.
CASE 'X'.
*   選択画面「Print」「Download」が選択されている場合
WHEN RB_PRINT
OR RB_DOWNL.
SELECT
**** START ADD 2015/02/10 ISID18 ****
EKKO~BUKRS               " 会社コード
**** END ADD 2015/02/10 ISID18 ****
EKKO~BSART               " 購買伝票タイプ
EKKO~AEDAT               " レコード登録日
EKKO~ERNAM               " オブジェクト登録者
EKKO~LIFNR               " 仕入先コード
**** START ADD 2015/03/11 ISID18 ****
EKKO~SPRAS               " 言語キー
**** END ADD 2015/03/11 ISID18 ****
EKKO~ZTERM               " 支払条件キー
EKKO~EKORG               " 購買組織
EKKO~EKGRP               " 購買グループ
EKKO~WAERS               " 通貨
EKKO~BEDAT               " 伝票日付
**** START ADD 2015/02/10 ISID18 ****
EKKO~VERKF               " 仕入先営業担当者
**** START ADD 2015/05/25 ISID18 ****
EKKO~INCO2               " インコタームズ
**** END ADD 2015/05/25 ISID18 ****
EKKO~SUBMI               " 一括番号 (見積依頼/見積書)
**** END ADD 2015/02/10 ISID18 ****
EKPO~EBELN               " 購買伝票番号
EKPO~EBELP               " 購買伝票の明細番号
EKPO~TXZ01               " テキスト (短)
EKPO~MATNR               " 品目コード
EKPO~WERKS               " プラント
EKPO~LGORT               " 保管場所
EKPO~IDNLF               " 仕入先品目コード
EKPO~MENGE               " 購買発注量
EKPO~MEINS               " 発注単位
EKPO~NETPR               " 購買伝票の正味価格 (伝票通貨)
EKPO~PEINH               " 価格単位
EKPO~NETWR               " 正味発注額 (購買発注通貨)
**** START ADD 2015/02/10 ISID18 ****
EKPO~MWSKZ               " 消費税コード
**** END ADD 2015/02/10 ISID18 ****
EKPO~PSTYP               " 購買伝票の明細カテゴリ
EKPO~KNTTP               " 勘定設定カテゴリ
**** START ADD 2015/02/10 ISID18 ****
EKPO~EVERS               " 出荷指示
**** END ADD 2015/02/10 ISID18 ****
EKPO~INCO1               " インコタームズ (1)
**** START ADD 2015/07/30 ISID18 ****
EKPO~INCO2 AS INCO2_ITEM " インコタームズ (2)
**** END ADD 2015/07/30 ISID18 ****
EKPO~ADRN2               " 納入先住所コード
EKPO~XERSY               " ERS（入庫/請求自動決済）
EKPO~RETPO               " 返品明細
EKET~EINDT               " 明細納入期日
EKKN~VBELN               " 販売管理伝票番号
EKKN~VBELP               " 販売伝票明細
INTO TABLE O_TD_DATA
FROM EKKO AS EKKO
INNER JOIN EKPO AS EKPO
ON EKKO~EBELN = EKPO~EBELN
INNER JOIN EKET AS EKET
ON EKPO~EBELN = EKET~EBELN
AND EKPO~EBELP = EKET~EBELP
AND EKET~ETENR = 1
**** START UPD 2015/03/09 ISID18 ****
*       INNER JOIN EKKN AS EKKN
LEFT OUTER JOIN EKKN AS EKKN
**** END UPD 2015/03/09 ISID18 ****
ON EKPO~EBELN = EKKN~EBELN
AND EKPO~EBELP = EKKN~EBELP
AND EKKN~ZEKKN = 1
WHERE EKKO~EKORG IN S_EKORG     " 購買組織
AND EKKO~EKGRP IN S_EKGRP     " 購買グループ
AND EKKO~BEDAT IN S_BEDAT     " 伝票日付
AND EKKO~LIFNR IN S_LIFNR     " 仕入先コード
**** START ADD 2015/03/11 ISID18 ****
AND EKKO~SPRAS IN S_SPRAS     " 言語キー
**** END ADD 2015/03/11 ISID18 ****
AND EKKO~BSART IN S_BSART     " 購買伝票タイプ
AND EKKO~EBELN IN S_EBELN     " 購買伝票番号
AND EKPO~MATNR IN S_MATNR     " 品目コード
AND EKPO~WERKS IN S_WERKS     " プラント
AND EKET~EINDT IN S_EINDT     " 納入日付
AND EKPO~PSTYP IN S_PSTYP     " 購買伝票の明細カテゴリ
AND EKPO~KNTTP IN S_KNTTP     " 勘定設定カテゴリ
**** START ADD 2015/06/10 ISID18 ****
AND EKPO~LOEKZ =  SPACE       " 削除フラグ
AND EKKO~LOEKZ =  SPACE       " 削除フラグ
**** END ADD 2015/06/10 ISID18 *****
AND EKKO~AEDAT IN S_AEDAT     " レコード登録日
AND EKKO~ERNAM IN S_ERNAM.    " オブジェクト登録者
IF SY-SUBRC <> 0.
MESSAGE S006 WITH 'EKKO&EKPO'.
LEAVE LIST-PROCESSING.
ENDIF.

*   選択画面「Reprint」が選択されている場合
WHEN RB_REPNT.
SELECT
**** START ADD 2015/02/10 ISID18 ****
EKKO~BUKRS               " 会社コード
**** END ADD 2015/02/10 ISID18 ****
EKKO~BSART               " 購買伝票タイプ
EKKO~AEDAT               " レコード登録日
EKKO~ERNAM               " オブジェクト登録者
EKKO~LIFNR               " 仕入先コード
**** START ADD 2015/03/11 ISID18 ****
EKKO~SPRAS               " 言語キー
**** END ADD 2015/03/11 ISID18 ****
EKKO~ZTERM               " 支払条件キー
EKKO~EKORG               " 購買組織
EKKO~EKGRP               " 購買グループ
EKKO~WAERS               " 通貨
EKKO~BEDAT               " 伝票日付
**** START ADD 2015/02/10 ISID18 ****
EKKO~VERKF               " 仕入先営業担当者
**** START ADD 2015/05/25 ISID18 ****
EKKO~INCO2               " インコタームズ
**** END ADD 2015/05/25 ISID18 ****
EKKO~SUBMI               " 一括番号 (見積依頼/見積書)
**** END ADD 2015/02/10 ISID18 ****
EKPO~EBELN               " 購買伝票番号
EKPO~EBELP               " 購買伝票の明細番号
EKPO~TXZ01               " テキスト (短)
EKPO~MATNR               " 品目コード
EKPO~WERKS               " プラント
EKPO~LGORT               " 保管場所
EKPO~IDNLF               " 仕入先品目コード
EKPO~MENGE               " 購買発注量
EKPO~MEINS               " 発注単位
EKPO~NETPR               " 購買伝票の正味価格 (伝票通貨)
EKPO~PEINH               " 価格単位
EKPO~NETWR               " 正味発注額 (購買発注通貨)
**** START ADD 2015/02/10 ISID18 ****
EKPO~MWSKZ               " 消費税コード
**** END ADD 2015/02/10 ISID18 ****
EKPO~PSTYP               " 購買伝票の明細カテゴリ
EKPO~KNTTP               " 勘定設定カテゴリ
**** START ADD 2015/02/10 ISID18 ****
EKPO~EVERS               " 出荷指示
**** END ADD 2015/02/10 ISID18 ****
EKPO~INCO1               " インコタームズ (1)
**** START ADD 2015/07/30 ISID18 ****
EKPO~INCO2 AS INCO2_ITEM " インコタームズ (2)
**** END ADD 2015/07/30 ISID18 ****
EKPO~ADRN2               " 納入先住所コード
EKPO~XERSY               " ERS（入庫/請求自動決済）
EKPO~RETPO               " 返品明細
EKET~EINDT               " 明細納入期日
EKKN~VBELN               " 販売管理伝票番号
EKKN~VBELP               " 販売伝票明細
INTO TABLE O_TD_DATA
FROM EKKO AS EKKO
INNER JOIN EKPO AS EKPO
ON EKKO~EBELN = EKPO~EBELN
INNER JOIN EKET AS EKET
ON EKPO~EBELN = EKET~EBELN
AND EKPO~EBELP = EKET~EBELP
AND EKET~ETENR = 1
**** START UPD 2015/03/09 ISID18 ****
*       INNER JOIN EKKN AS EKKN
LEFT OUTER JOIN EKKN AS EKKN
**** END UPD 2015/03/09 ISID18 ****
ON EKPO~EBELN = EKKN~EBELN
AND EKPO~EBELP = EKKN~EBELP
AND EKKN~ZEKKN = 1
INNER JOIN ZTEGMMT011 AS T011
ON EKKO~EBELN = T011~EBELN
AND EKKO~AEDAT = T011~AEDAT
WHERE EKKO~EKORG IN S_EKORG     " 購買組織
AND EKKO~EKGRP IN S_EKGRP     " 購買グループ
AND EKKO~BEDAT IN S_BEDAT     " 伝票日付
AND EKKO~LIFNR IN S_LIFNR     " 仕入先コード
**** START ADD 2015/03/11 ISID18 ****
AND EKKO~SPRAS IN S_SPRAS     " 言語キー
**** END ADD 2015/03/11 ISID18 ****
AND EKKO~BSART IN S_BSART     " 購買伝票タイプ
AND EKKO~EBELN IN S_EBELN     " 購買伝票番号
AND EKPO~MATNR IN S_MATNR     " 品目コード
AND EKPO~WERKS IN S_WERKS     " プラント
AND EKET~EINDT IN S_EINDT     " 納入日付
AND EKPO~PSTYP IN S_PSTYP     " 購買伝票の明細カテゴリ
AND EKPO~KNTTP IN S_KNTTP     " 勘定設定カテゴリ
**** START ADD 2015/06/12 ISID18 ****
AND EKPO~LOEKZ =  SPACE       " 削除フラグ
AND EKKO~LOEKZ =  SPACE       " 削除フラグ
**** END ADD 2015/06/12 ISID18 *****
AND EKKO~AEDAT IN S_AEDAT     " レコード登録日
AND EKKO~ERNAM IN S_ERNAM     " オブジェクト登録者
AND T011~Z_OUTPUT_MODE = CNS_MODE_P.
IF SY-SUBRC <> 0.
MESSAGE S006 WITH 'ZTEGMMT011'.
LEAVE LIST-PROCESSING.
ENDIF.
WHEN OTHERS.
ENDCASE.

ENDFORM.                    " GET_PO_DATA
************************************************************************
*       Form  GET_ZTEGMMT011
************************************************************************
*       Output Management(PurchaseOrder)データ取得
*----------------------------------------------------------------------*
*      -->I_TD_DATA  購買発注データ
*      <--O_TD_DATA  Output Management(PurchaseOrder)データ
************************************************************************
FORM GET_ZTEGMMT011
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_ZTEGMMT011.

DATA LTD_I_DATA TYPE TYP_TD_PO.
DATA LW_MODE    TYPE ZEOUTPUTMODE.

* 重複キー削除
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY EBELN.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING EBELN.

REFRESH O_TD_DATA.
IF LTD_I_DATA[] IS NOT INITIAL.
CASE 'X'.
WHEN RB_PRINT
OR RB_REPNT.
LW_MODE = CNS_MODE_P.
WHEN RB_DOWNL.
LW_MODE = CNS_MODE_D.
WHEN OTHERS.
ENDCASE.
SELECT
Z_OUTPUT_MODE
EBELN
INTO TABLE O_TD_DATA
FROM ZTEGMMT011
FOR ALL ENTRIES IN LTD_I_DATA
WHERE Z_OUTPUT_MODE = LW_MODE
AND EBELN = LTD_I_DATA-EBELN.
ENDIF.

* ソート
SORT O_TD_DATA BY Z_OUTPUT_MODE EBELN.

ENDFORM.                    " GET_ZTEGMMT011
************************************************************************
*       Form  GET_LFA1_ADRC
************************************************************************
*       仕入先住所情報の取得
************************************************************************
*      -->I_TD_DATA  購買発注データ
*      <--O_TD_DATA  仕入先住所情報
************************************************************************
FORM GET_LFA1_ADRC
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_LFA1_ADRC.

**** START UPD 2014/12/29 ISID11 ****
* 重複キー削除
*  DATA LTD_I_DATA TYPE TYP_TD_PO.
DATA:
LTD_I_DATA    TYPE TYP_TD_PO,
LTD_LFA1      TYPE TYP_TD_LFA1,
LST_LFA1      TYPE TYP_TH_LFA1,
LRD_ADRC      TYPE BUADDRNRRNG,
LST_RNG_ADRC  TYPE BUS_ADDRNUMBER_RANGE,
LTD_ADRC      TYPE ZTEGZZ002,
LST_ADRC      TYPE ZSEGZZ0002,
LST_LFA1_ADRC TYPE TYP_TH_LFA1_ADRC.

* 重複キー削除
**** END UPD 2014/12/29 ISID11 ****

LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY LIFNR.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING LIFNR.

REFRESH O_TD_DATA.
IF LTD_I_DATA[] IS NOT INITIAL.

**** START UPD 2014/12/29 ISID11 ****
*    SELECT
*      LFA1~LIFNR          " 仕入先コード
*      ADRC~NAME1          " 名称１
*      ADRC~CITY1          " 市区町村
*      ADRC~STREET         " 地名
***** START ADD 2014/12/26 ISID11 ****
*      ADRC~STR_SUPPL1     "地名 2
*      ADRC~STR_SUPPL2     "地名 3
***** END ADD 2014/12/26 ISID11 ****
*      ADRC~TEL_NUMBER     " 第一電話番号
*      ADRC~FAX_NUMBER     " 第一 FAX 番号
*      INTO TABLE O_TD_DATA
*      FROM LFA1 AS LFA1
*     INNER JOIN ADRC AS ADRC
*        ON LFA1~ADRNR = ADRC~ADDRNUMBER
*       FOR ALL ENTRIES IN LTD_I_DATA
*     WHERE LFA1~LIFNR = LTD_I_DATA-LIFNR.

*   アドレス番号を取得
SELECT LIFNR
ADRNR
INTO TABLE LTD_LFA1
FROM LFA1
FOR ALL ENTRIES IN LTD_I_DATA
WHERE LIFNR = LTD_I_DATA-LIFNR.

IF SY-SUBRC <> 0.

RETURN.

ENDIF.

SORT LTD_LFA1 BY ADRNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_LFA1
COMPARING ADRNR.

LST_RNG_ADRC-SIGN   = 'I'.
LST_RNG_ADRC-OPTION = 'EQ'.

LOOP AT LTD_LFA1 INTO LST_LFA1.

LST_RNG_ADRC-LOW = LST_LFA1-ADRNR.
APPEND LST_RNG_ADRC TO LRD_ADRC.

ENDLOOP.

*   Get ADRC address and name
CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
EXPORTING
IMPMULTITFLG     = '2'
IMPRNGADDRNUMBER = LRD_ADRC
IMPORTING
EXPTABADRC       = LTD_ADRC.

SORT LTD_ADRC BY ADDRNUMBER ASCENDING.
LOOP AT LTD_LFA1 INTO LST_LFA1.

CLEAR:
LST_ADRC,
LST_LFA1_ADRC.

READ TABLE LTD_ADRC INTO LST_ADRC
WITH KEY ADDRNUMBER = LST_LFA1-ADRNR
BINARY SEARCH.

IF SY-SUBRC = 0.

LST_LFA1_ADRC-LIFNR      = LST_LFA1-LIFNR.       "仕入先コード
LST_LFA1_ADRC-NAME1      = LST_ADRC-Z_NAME.      "名称１
LST_LFA1_ADRC-STREET     = LST_ADRC-Z_ADDRESS1.  "地名
LST_LFA1_ADRC-CITY1      = LST_ADRC-Z_ADDRESS2.  "市区町村
LST_LFA1_ADRC-STR_SUPPL1 = LST_ADRC-Z_ADDRESS3.  "地名 2
LST_LFA1_ADRC-STR_SUPPL2 = LST_ADRC-Z_ADDRESS4.  "地名 3
LST_LFA1_ADRC-TEL_NUMBER = LST_ADRC-TEL_NUMBER.  "電話番号
LST_LFA1_ADRC-FAX_NUMBER = LST_ADRC-FAX_NUMBER.  "番号
APPEND LST_LFA1_ADRC TO O_TD_DATA.

ENDIF.

ENDLOOP.

ENDIF.

* ソート
SORT O_TD_DATA BY LIFNR.

ENDFORM.                    " GET_LFA1_ADRC
**** START DEL 2015/02/10 ISID18 ****
************************************************************************
*
**       Form  GET_TWLAD_ADRC
************************************************************************
*
**       保管場所住所情報の取得
************************************************************************
*
**      <--I_TD_DATA  購買発注データ
**      <--O_TD_DATA  保管場所住所情報
************************************************************************
*
*FORM GET_TWLAD_ADRC
*  USING    I_TD_DATA TYPE TYP_TD_PO
*  CHANGING O_TD_DATA TYPE TYP_TD_TWLAD_ADRC.
*
***** START ADD 2014/12/29 ISID11 ****
*  DATA:
*    LTD_TWLAD      TYPE TYP_TD_TWLAD,
*    LTD_DUPTWLAD   TYPE TYP_TD_TWLAD,
*    LST_DUPTWLAD   TYPE TYP_TH_TWLAD,
*    LRD_ADRC       TYPE BUADDRNRRNG,
*    LST_RNG_ADRC   TYPE BUS_ADDRNUMBER_RANGE,
*    LTD_ADRC       TYPE ZTEGZZ002,
*    LST_ADRC       TYPE ZSEGZZ0002,
*    LST_TWLAD_ADRC TYPE TYP_TH_TWLAD_ADRC.
*
***** END ADD 2014/12/29 ISID11 ****
*
*  FIELD-SYMBOLS <LFS_TWLAD_ADRC> TYPE TYP_TH_TWLAD_ADRC.
*  DATA LTD_I_DATA TYPE TYP_TD_PO.
*
** 重複キー削除
*  LTD_I_DATA[] = I_TD_DATA[].
*  SORT LTD_I_DATA BY WERKS LGORT.
*  DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
*    COMPARING WERKS LGORT.
*
*  REFRESH O_TD_DATA.
*  IF LTD_I_DATA[] IS NOT INITIAL.
*
***** START UPD 2014/12/29 ISID11 ****
**    SELECT
**      TWLAD~WERKS           " プラント
**      TWLAD~LGORT           " 保管場所
**      TWLAD~LFDNR           " 連続アドレス番号
**      TWLAD~ADRNR           " アドレス番号
**      ADRC~NAME1            " 名称１
**      ADRC~CITY1            " 市区町村
**      ADRC~STREET           " 地名
****** START ADD 2014/12/26 ISID11 ****
**      ADRC~STR_SUPPL1     "地名 2
**      ADRC~STR_SUPPL2     "地名 3
****** END ADD 2014/12/26 ISID11 ****
**      ADRC~TEL_NUMBER       " 第一電話番号
**      ADRC~FAX_NUMBER       " 第一 FAX 番号
**      INTO TABLE O_TD_DATA
**      FROM TWLAD AS TWLAD
**     INNER JOIN ADRC AS ADRC
**        ON TWLAD~ADRNR = ADRC~ADDRNUMBER
**       FOR ALL ENTRIES IN LTD_I_DATA
**     WHERE TWLAD~WERKS = LTD_I_DATA-WERKS
**       AND TWLAD~LGORT = LTD_I_DATA-LGORT.
*
*    SELECT
*      WERKS           " プラント
*      LGORT           " 保管場所
*      LFDNR           " 連続アドレス番号
*      ADRNR           " アドレス番号
*      INTO TABLE LTD_TWLAD
*      FROM TWLAD
*       FOR ALL ENTRIES IN LTD_I_DATA
*     WHERE WERKS = LTD_I_DATA-WERKS
*       AND LGORT = LTD_I_DATA-LGORT.
*
*    IF SY-SUBRC <> 0.
*
*      RETURN.
*
*    ENDIF.
*
*    LTD_DUPTWLAD = LTD_TWLAD.
*    SORT LTD_DUPTWLAD BY ADRNR ASCENDING.
*    DELETE ADJACENT DUPLICATES FROM LTD_DUPTWLAD
*                          COMPARING ADRNR.
*
*    LST_RNG_ADRC-SIGN   = 'I'.
*    LST_RNG_ADRC-OPTION = 'EQ'.
*
*    LOOP AT LTD_DUPTWLAD INTO LST_DUPTWLAD.
*
*      LST_RNG_ADRC-LOW = LST_DUPTWLAD-ADRNR.
*      APPEND LST_RNG_ADRC TO LRD_ADRC.
*
*    ENDLOOP.
*
**   Get ADRC address and name
*    CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
*      EXPORTING
*        IMPMULTITFLG     = '2'
*        IMPRNGADDRNUMBER = LRD_ADRC
*      IMPORTING
*        EXPTABADRC       = LTD_ADRC.
*
*    SORT LTD_ADRC BY ADDRNUMBER.
*
*    LOOP AT LTD_TWLAD INTO LST_DUPTWLAD.
*
*      CLEAR:
*        LST_ADRC.
*
*      READ TABLE LTD_ADRC INTO LST_ADRC
*        WITH KEY ADDRNUMBER = LST_DUPTWLAD-ADRNR
*        BINARY SEARCH.
*
*      IF SY-SUBRC = 0.
*
*        LST_TWLAD_ADRC-WERKS       = LST_DUPTWLAD-WERKS. "プラント
*        LST_TWLAD_ADRC-LGORT       = LST_DUPTWLAD-LGORT. "保管場所
*        LST_TWLAD_ADRC-LFDNR       = LST_DUPTWLAD-LFDNR. "アドレス番号
*        LST_TWLAD_ADRC-ADRNR       = LST_DUPTWLAD-ADRNR. "アドレス番号
*        LST_TWLAD_ADRC-NAME1       = LST_ADRC-Z_NAME.      "名称１
*        LST_TWLAD_ADRC-CITY1       = LST_ADRC-Z_ADDRESS1.  "地名
*        LST_TWLAD_ADRC-STREET      = LST_ADRC-Z_ADDRESS2.  "市区町村
*        LST_TWLAD_ADRC-STR_SUPPL1  = LST_ADRC-Z_ADDRESS3.  "地名 2
*        LST_TWLAD_ADRC-STR_SUPPL2  = LST_ADRC-Z_ADDRESS4.  "地名 3
*        LST_TWLAD_ADRC-TEL_NUMBER  = LST_ADRC-TEL_NUMBER.  "電話番号
*        LST_TWLAD_ADRC-FAX_NUMBER  = LST_ADRC-FAX_NUMBER.  "番号
*        APPEND LST_TWLAD_ADRC TO O_TD_DATA.
*
*      ENDIF.
*
*    ENDLOOP.
***** END UPD 2014/12/29 ISID11 ****
*
*  ENDIF.
*
** 連続番号最小のレコードの取得
*  SORT O_TD_DATA BY WERKS LGORT LFDNR.
*  LOOP AT O_TD_DATA ASSIGNING <LFS_TWLAD_ADRC>.
*    AT NEW LGORT.
*      DELETE O_TD_DATA
*        WHERE WERKS =  <LFS_TWLAD_ADRC>-WERKS
*          AND LGORT =  <LFS_TWLAD_ADRC>-LGORT
*          AND LFDNR <> <LFS_TWLAD_ADRC>-LFDNR.
*    ENDAT.
*  ENDLOOP.
*
*ENDFORM.                    " GET_TWLAD_ADRC
************************************************************************
*
**       Form  GET_ADRC
************************************************************************
*
**       納入先住所情報の取得
************************************************************************
*
**      <--I_TD_DATA  購買発注データ
**      <--O_TD_DATA  納入先住所情報
************************************************************************
*
*FORM GET_ADRC
*  USING    I_TD_DATA TYPE TYP_TD_PO
*  CHANGING O_TD_DATA TYPE TYP_TD_ADRC.
*
***** START ADD 2014/12/29 ISID11 ****
*  DATA:
*    LST_I_DATA   TYPE TYP_TH_PO,
*    LST_DATA     TYPE TYP_TH_ADRC,
*    LRD_ADRC  TYPE BUADDRNRRNG,
*    LST_RNG_ADRC  TYPE BUS_ADDRNUMBER_RANGE,
*    LTD_ADRC  TYPE ZTEGZZ002,
*    LST_ADRC  TYPE ZSEGZZ0002.
*
***** END ADD 2014/12/29 ISID11 ****
*
** 重複キー削除
*  DATA LTD_I_DATA TYPE TYP_TD_PO.
*  LTD_I_DATA[] = I_TD_DATA[].
*  SORT LTD_I_DATA BY ADRN2.
*  DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
*    COMPARING ADRN2.
*
*  REFRESH O_TD_DATA.
*  IF LTD_I_DATA[] IS NOT INITIAL.
*
***** START UPD 2014/12/29 ISID11 ****
**    SELECT
**      ADDRNUMBER       " アドレス番号
**      NAME1            " 名称１
**      CITY1            " 市区町村
**      STREET           " 地名
****** START ADD 2014/12/26 ISID11 ****
**      STR_SUPPL1     "地名 2
**      STR_SUPPL2     "地名 3
****** END ADD 2014/12/26 ISID11 ****
**      TEL_NUMBER       " 第一電話番号
**      FAX_NUMBER       " 第一 FAX 番号
**      INTO TABLE O_TD_DATA
**      FROM ADRC
**       FOR ALL ENTRIES IN LTD_I_DATA
**     WHERE ADDRNUMBER = LTD_I_DATA-ADRN2.
*
*    LST_RNG_ADRC-SIGN   = 'I'.
*    LST_RNG_ADRC-OPTION = 'EQ'.
*
*    LOOP AT LTD_I_DATA INTO LST_I_DATA.
*
*      LST_RNG_ADRC-LOW = LST_I_DATA-ADRN2.
*      APPEND LST_RNG_ADRC TO LRD_ADRC.
*
*    ENDLOOP.
*
**   Get ADRC address and name
*    CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
*      EXPORTING
*        IMPMULTITFLG     = '2'
*        IMPRNGADDRNUMBER = LRD_ADRC
*      IMPORTING
*        EXPTABADRC       = LTD_ADRC.
*
*    LOOP AT LTD_ADRC INTO LST_ADRC.
*
*      CLEAR:
*        LST_DATA.
*
*      LST_DATA-ADDRNUMBER = LST_ADRC-ADDRNUMBER.  "アドレス番号
*      LST_DATA-NAME1      = LST_ADRC-Z_NAME.      "名称１
*      LST_DATA-STREET     = LST_ADRC-Z_ADDRESS1.  "地名
*      LST_DATA-CITY1      = LST_ADRC-Z_ADDRESS2.  "市区町村
*      LST_DATA-STR_SUPPL1 = LST_ADRC-Z_ADDRESS3.  "地名 2
*      LST_DATA-STR_SUPPL2 = LST_ADRC-Z_ADDRESS4.  "地名 3
*      LST_DATA-TEL_NUMBER = LST_ADRC-TEL_NUMBER.  "電話番号
*      LST_DATA-FAX_NUMBER = LST_ADRC-FAX_NUMBER.  "番号
*      APPEND LST_DATA TO O_TD_DATA.
*
*    ENDLOOP.
***** END UPD 2014/12/29 ISID11 ****
*
*  ENDIF.
*
** ソート
*  SORT O_TD_DATA BY ADDRNUMBER.
*
*ENDFORM.                    " GET_ADRC
**** END DEL 2015/02/10 ISID18 ****
************************************************************************
*       Form  GET_EINA_T069T
************************************************************************
*       証明書カテゴリテキスト取得
************************************************************************
*      <--I_TD_DATA  購買発注データ
*      <--O_TD_DATA  証明書カテゴリテキスト
************************************************************************
FORM GET_EINA_T069T
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_EINA_T069T.

* ローカルタイプ定義
TYPES:BEGIN OF LTYP_TH_T069T,
URZTP TYPE T069T-URZTP,
URZTX TYPE T069T-URZTX,
END OF LTYP_TH_T069T,
BEGIN OF LTYP_TH_EINA,
LIFNR TYPE EINA-LIFNR,
MATNR TYPE EINA-MATNR,
URZTP TYPE EINA-URZTP,
END OF LTYP_TH_EINA.

* ローカル構造定義
DATA: LTH_EINA       TYPE LTYP_TH_EINA,
LTH_T069T      TYPE LTYP_TH_T069T,
LTH_EINA_T069T TYPE TYP_TH_EINA_T069T,
LTD_EINA       TYPE STANDARD TABLE OF LTYP_TH_EINA,
LTD_EINA2      TYPE STANDARD TABLE OF LTYP_TH_EINA,
LTD_T069T      TYPE STANDARD TABLE OF LTYP_TH_T069T,
LTD_I_DATA     TYPE TYP_TD_PO.

* 重複キー削除
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY LIFNR MATNR.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING LIFNR MATNR.
REFRESH O_TD_DATA.

* 証明書カテゴリ取得
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT
LIFNR          " 仕入先コード
MATNR          " 品目コード
URZTP          " 証明書カテゴリ
INTO TABLE LTD_EINA
FROM EINA
FOR ALL ENTRIES IN LTD_I_DATA
WHERE LIFNR = LTD_I_DATA-LIFNR
AND MATNR = LTD_I_DATA-MATNR.
ENDIF.

* 証明書カテゴリテキスト取得
LTD_EINA2[] = LTD_EINA[].
SORT LTD_EINA2 BY URZTP.
DELETE ADJACENT DUPLICATES FROM LTD_EINA2
COMPARING URZTP.
IF LTD_EINA2[] IS NOT INITIAL.
SELECT
URZTP          " 証明書カテゴリ
URZTX          " 証明書テキスト
INTO TABLE LTD_T069T
FROM T069T
FOR ALL ENTRIES IN LTD_EINA2
WHERE URZTP = LTD_EINA2-URZTP
AND SPRAS = CNS_SPRAS_EN.
ENDIF.
SORT LTD_T069T BY URZTP.

* 内部テーブル格納
LOOP AT LTD_EINA INTO LTH_EINA.
CLEAR LTH_EINA_T069T.
MOVE-CORRESPONDING LTH_EINA TO LTH_EINA_T069T.
CLEAR LTH_T069T.
READ TABLE LTD_T069T INTO LTH_T069T
WITH KEY URZTP = LTH_EINA-URZTP
BINARY SEARCH.
LTH_EINA_T069T-URZTX = LTH_T069T-URZTX.
APPEND LTH_EINA_T069T TO O_TD_DATA.
ENDLOOP.

* ソート
SORT O_TD_DATA BY LIFNR MATNR.

ENDFORM.                    " GET_EINA_T069T
**** START ADD 2015/02/10 ISID18 ****
************************************************************************
*&      Form  GET_TVKO
************************************************************************
*       販売組織取得
************************************************************************
*      -->I_TD_DATA  購買発注データ
*      <--O_TD_DATA  販売組織
************************************************************************
FORM GET_TVKO
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_TVKO.

* 重複キー削除
DATA LTD_I_DATA TYPE TYP_TD_PO.
DATA LTH_TVKO   TYPE TYP_TH_TVKO.
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY BUKRS.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING BUKRS.

REFRESH O_TD_DATA.
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT
TVKO~VKORG
TVKO~BUKRS
TVKV~VTWEG
INTO TABLE O_TD_DATA
FROM TVKO AS TVKO
INNER JOIN TVKOV AS TVKV
ON TVKO~VKORG = TVKV~VKORG
FOR ALL ENTRIES IN LTD_I_DATA
WHERE TVKO~BUKRS = LTD_I_DATA-BUKRS.
ENDIF.

* ソート
SORT O_TD_DATA BY BUKRS VKORG VTWEG.
LOOP AT O_TD_DATA INTO LTH_TVKO.
DELETE O_TD_DATA
WHERE VKORG <> LTH_TVKO-VKORG
AND BUKRS =  LTH_TVKO-BUKRS
AND VTWEG <> LTH_TVKO-VTWEG.
ENDLOOP.

ENDFORM.                    " GET_TVKO
**** END ADD 2015/02/10 ISID18 ****
************************************************************************
*&      Form  GET_T024
************************************************************************
*       購買グループテキスト取得
************************************************************************
*      <--I_TD_DATA  購買発注データ
*      <--O_TD_DATA  購買グループテキスト
************************************************************************
FORM GET_T024
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_T024.

* 重複キー削除
DATA LTD_I_DATA TYPE TYP_TD_PO.
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY EKGRP.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING EKGRP.

REFRESH O_TD_DATA.
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT
EKGRP
EKNAM
FROM T024
INTO TABLE O_TD_DATA
FOR ALL ENTRIES IN LTD_I_DATA
WHERE EKGRP = LTD_I_DATA-EKGRP.
ENDIF.

* ソート
SORT O_TD_DATA BY EKGRP.

ENDFORM.                    " GET_T024
************************************************************************
*       Form  GET_T052U
************************************************************************
*       支払条件テキスト
************************************************************************
*      <--I_TD_DATA  購買発注データ
*      <--O_TD_DATA  支払条件テキスト
************************************************************************
FORM GET_T052U
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_T052U.

**** START ADD 2015/03/11 ISID18 ****
DATA LW_SPRAS TYPE EKKO-SPRAS.
IF P_LANGU IS NOT INITIAL.
LW_SPRAS = P_LANGU.
ELSE.
LW_SPRAS = SY-LANGU.
ENDIF.
**** END ADD 2015/03/11 ISID18 ****

* 重複キー削除
DATA LTD_I_DATA TYPE TYP_TD_PO.
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY ZTERM.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING ZTERM.

REFRESH O_TD_DATA.
IF LTD_I_DATA[] IS NOT INITIAL.
**** START UPD 2015/03/11 ISID18 ****
*    SELECT
*      ZTERM       " 支払条件キー
*      TEXT1       " 支払条件の固有テキスト
*      FROM T052U
*      INTO TABLE O_TD_DATA
*       FOR ALL ENTRIES IN LTD_I_DATA
*     WHERE ZTERM = LTD_I_DATA-ZTERM
*       AND SPRAS = CNS_SPRAS_EN.
SELECT
ZTERM            " 支払条件キー
Z_PAYMENT_TEXT   " 支払条件の固有テキスト
AS TEXT1
FROM ZTEGSDM011
INTO TABLE O_TD_DATA
FOR ALL ENTRIES IN LTD_I_DATA
WHERE ZTERM = LTD_I_DATA-ZTERM
AND SPRAS = LW_SPRAS.
**** END UPD 2015/03/11 ISID18 ****
ENDIF.

* ソート
SORT O_TD_DATA BY ZTERM.

ENDFORM.                    " GET_T052U
************************************************************************
*       Form  GET_ZTEGMMM001
************************************************************************
*       実需マスタ情報の取得
************************************************************************
*      <--I_TD_DATA   購買発注データ
*      <--O_TD_DATA1  会社コード
*      <--O_TD_DATA2  実需マスタ情報
************************************************************************
FORM GET_ZTEGMMM001
USING    I_TD_DATA  TYPE TYP_TD_PO
**** START UPD 2015/02/10 ISID18 ****
*  CHANGING O_TD_DATA1 TYPE TYP_TD_T001K
*           O_TD_DATA2 TYPE TYP_TD_ZTEGMMM001.
CHANGING O_TD_DATA2 TYPE TYP_TD_ZTEGMMM001
**** END UPD 2015/02/10 ISID18 ****
**** START ADD 2015/05/25 ISID18 ****
O_TD_LFB1  TYPE TYP_TD_LFB1
O_TH_M999  TYPE TYP_TH_ZTEGZZM999.
**** END ADD 2015/05/25 ISID18 ****

TYPES LTYP_RH_BUKRS TYPE RANGE OF T001K-BUKRS.
**** START ADD 2015/02/10 ISID18 ****
TYPES:
BEGIN OF LTYP_TH_MMM001,
MATNR          TYPE EKPO-MATNR,    " 品目コード
BUKRS          TYPE T001-BUKRS,    " 会社コード
Z_ENDUSER_CD   TYPE ZEENDUSERCD,   " EndUser
Z_PURPOSE_TEXT TYPE ZEPURPOSETEXT, " Purpose
END OF LTYP_TH_MMM001,
LTYP_TD_MMM001   TYPE STANDARD TABLE OF LTYP_TH_MMM001.
TYPES:
BEGIN OF LTYP_TH_KNA1,
KUNNR      TYPE KNA1-KUNNR,
ADRNR      TYPE KNA1-ADRNR,
END OF LTYP_TH_KNA1,
LTYP_TD_KNA1 TYPE STANDARD TABLE OF LTYP_TH_KNA1.
**** START ADD 2015/08/24 ISID21 ****
TYPES:
BEGIN OF LTYP_TH_EUC,
KUNNR TYPE KNA1-KUNNR,
LANDX TYPE T005T-LANDX,
END OF LTYP_TH_EUC,
LTYP_TD_EUC TYPE STANDARD TABLE OF LTYP_TH_EUC.
**** END ADD 2015/08/24 ISID21 ****
DATA:
LTD_MMM001     TYPE LTYP_TD_MMM001,
LTD_MMM001T    TYPE LTYP_TD_MMM001,
LTH_MMM001     TYPE LTYP_TH_MMM001,
LTH_ZTEGMMM001 TYPE TYP_TH_ZTEGMMM001,
LTD_KNA1       TYPE LTYP_TD_KNA1,
LTD_KNA1T      TYPE LTYP_TD_KNA1,
LTH_KNA1       TYPE LTYP_TH_KNA1,
LRD_ADRC       TYPE BUADDRNRRNG,
LRH_ADRC       LIKE LINE OF LRD_ADRC,
LTD_ADRC       TYPE ZTEGZZ002,
LTH_ADRC       TYPE ZSEGZZ0002,
LTD_MATNR      TYPE TYP_TD_PO.
**** END ADD 2015/02/10 ISID18 ****
**** START DEL 2015/02/10 ISID18 ****
*  DATA LTH_T001K      TYPE TYP_TH_T001K.
*  DATA LTD_T001K      TYPE TYP_TD_T001K.
**** END DEL 2015/02/10 ISID18 ****
DATA LTD_I_DATA     TYPE TYP_TD_PO.
**** START ADD 2015/02/10 ISID18 ****
DATA LTH_I_DATA     TYPE TYP_TH_PO.
**** END ADD 2015/02/10 ISID18 ****
DATA LRD_BUKRS      TYPE LTYP_RH_BUKRS.
DATA LRH_BUKRS      LIKE LINE OF LRD_BUKRS.
**** START ADD 2015/08/24 ISID21 ****
DATA:
LW_LANGU         TYPE SY-LANGU,
LTD_EUC          TYPE LTYP_TD_EUC,
LTH_EUC          TYPE LTYP_TH_EUC.

IF P_LANGU IS NOT INITIAL.
LW_LANGU = P_LANGU.
ELSE.
LW_LANGU = SY-LANGU.
ENDIF.
**** END ADD 2015/08/24 ISID21 ****


* 重複キー削除
LTD_I_DATA[] = I_TD_DATA[].
**** START UPD 2015/02/10 ISID18 ****
*  SORT LTD_I_DATA BY WERKS.
*  DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
*    COMPARING WERKS.
*
*  REFRESH O_TD_DATA1.
SORT LTD_I_DATA BY BUKRS.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING BUKRS.

* Range of Material
LTD_MATNR[] = I_TD_DATA[].
SORT LTD_MATNR BY MATNR.
DELETE ADJACENT DUPLICATES FROM LTD_MATNR
COMPARING MATNR.
**** END UPD 2015/02/10 ISID18 ****
REFRESH O_TD_DATA2.

**** START DEL 2015/02/10 ISID18 ****
** 会社コード取得
*  IF LTD_I_DATA[] IS NOT INITIAL.
*    SELECT
*      T001W~WERKS
*      T001K~BUKRS
*      INTO TABLE O_TD_DATA1
*      FROM T001W AS T001W
*     INNER JOIN T001K AS T001K
*        ON T001W~BWKEY = T001K~BWKEY
*       FOR ALL ENTRIES IN LTD_I_DATA
*     WHERE T001W~WERKS = LTD_I_DATA-WERKS.
*  ENDIF.
*
** 重複キー削除
*  LTD_I_DATA[] = I_TD_DATA[].
*  SORT LTD_I_DATA BY MATNR.
*  DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
*    COMPARING MATNR.
*  LTD_T001K[] = O_TD_DATA1[].
*  SORT LTD_T001K BY BUKRS.
*  DELETE ADJACENT DUPLICATES FROM LTD_T001K
*    COMPARING BUKRS.
**** END DEL 2015/02/10 ISID18 ****

* Purpose取得
IF LTD_I_DATA[] IS NOT INITIAL.
**** START UPD 2015/02/10 ISID18 ****
*    LOOP AT LTD_T001K INTO LTH_T001K.
LOOP AT LTD_I_DATA INTO LTH_I_DATA.
**** END UPD 2015/02/10 ISID18 ****
CLEAR LRH_BUKRS.
LRH_BUKRS-SIGN   = 'I'.
LRH_BUKRS-OPTION = 'EQ'.
**** START UPD 2015/02/10 ISID18 ****
*      LRH_BUKRS-LOW    = LTH_T001K-BUKRS.
LRH_BUKRS-LOW    = LTH_I_DATA-BUKRS.
**** END UPD 2015/02/10 ISID18 ****
APPEND LRH_BUKRS TO LRD_BUKRS.
ENDLOOP.
**** BEGIN OF UPD 2015/02/10 ISID18 ****
*    SELECT
*      MATNR
*      BUKRS
*      Z_PURPOSE_TEXT
*      INTO TABLE O_TD_DATA2
*      FROM ZTEGMMM001
*       FOR ALL ENTRIES IN LTD_I_DATA
*     WHERE MATNR  = LTD_I_DATA-MATNR
*       AND BUKRS IN LRD_BUKRS.
ENDIF.
IF LTD_MATNR[] IS NOT INITIAL.
SELECT
MATNR
BUKRS
Z_ENDUSER_CD
Z_PURPOSE_TEXT
INTO TABLE LTD_MMM001
FROM ZTEGMMM001
FOR ALL ENTRIES IN LTD_MATNR
WHERE MATNR  = LTD_MATNR-MATNR
AND BUKRS IN LRD_BUKRS.
ENDIF.

**** START ADD 2015/05/25 ISID18 ****
* EndUser表示の判定
REFRESH O_TD_LFB1.
REFRESH LTD_MATNR.
LTD_MATNR[] = I_TD_DATA[].
SORT LTD_MATNR BY BUKRS LIFNR.
DELETE ADJACENT DUPLICATES FROM LTD_MATNR
COMPARING BUKRS LIFNR.
IF LTD_MATNR[] IS NOT INITIAL.
SELECT LIFNR
BUKRS
FDGRV
FROM LFB1
INTO TABLE O_TD_LFB1
FOR ALL ENTRIES IN LTD_MATNR
WHERE BUKRS = LTD_MATNR-BUKRS
AND LIFNR = LTD_MATNR-LIFNR.
ENDIF.
SORT O_TD_LFB1 BY LIFNR BUKRS.

* EndUser表示可否を取得
CLEAR O_TH_M999.
SELECT LOW
UP TO 1 ROWS
INTO O_TH_M999
FROM ZTEGZZM999
WHERE NAME = CNS_NAME
AND PROGNAME = SY-REPID.
ENDSELECT.
**** END ADD 2015/05/25 ISID18 ****

* Enduserの重複キーレコード削除
LTD_MMM001T[] = LTD_MMM001[].
SORT LTD_MMM001T BY Z_ENDUSER_CD.
DELETE ADJACENT DUPLICATES FROM LTD_MMM001T
COMPARING Z_ENDUSER_CD.

* Enduserのアドレス番号取得
IF LTD_MMM001T[] IS NOT INITIAL.
SELECT KUNNR
ADRNR
INTO TABLE LTD_KNA1
FROM KNA1
FOR ALL ENTRIES IN LTD_MMM001T
WHERE KUNNR = LTD_MMM001T-Z_ENDUSER_CD.
ENDIF.

**** START ADD 2015/08/24 ISID21 ****
* EnduserのCountry name取得
IF LTD_MMM001T[] IS NOT INITIAL.
SELECT KNA1~KUNNR
T005T~LANDX
INTO TABLE LTD_EUC
FROM KNA1
INNER JOIN T005T
ON KNA1~LAND1 = T005T~LAND1
FOR ALL ENTRIES IN LTD_MMM001T
WHERE KNA1~KUNNR = LTD_MMM001T-Z_ENDUSER_CD
AND T005T~SPRAS = LW_LANGU.
SORT LTD_EUC BY KUNNR.
ENDIF.
**** END ADD 2015/08/24 ISID21 ****

* アドレス情報取得
LTD_KNA1T[] = LTD_KNA1[].
SORT LTD_KNA1T BY ADRNR.
DELETE ADJACENT DUPLICATES FROM LTD_KNA1T
COMPARING ADRNR.
IF LTD_KNA1T[] IS NOT INITIAL.
CLEAR LRH_ADRC.
LRH_ADRC-SIGN = 'I'.
LRH_ADRC-OPTION = 'EQ'.
LOOP AT LTD_KNA1T INTO LTH_KNA1.
LRH_ADRC-LOW = LTH_KNA1-ADRNR.
APPEND LRH_ADRC TO LRD_ADRC.
ENDLOOP.
CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
EXPORTING
IMPMULTITFLG     = '2'
IMPRNGADDRNUMBER = LRD_ADRC
IMPORTING
EXPTABADRC       = LTD_ADRC.
ENDIF.
SORT LTD_ADRC BY ADDRNUMBER.

* Enduser名称編集
LOOP AT LTD_MMM001 INTO LTH_MMM001.
MOVE-CORRESPONDING LTH_MMM001 TO LTH_ZTEGMMM001.
CLEAR LTH_KNA1.
READ TABLE LTD_KNA1 INTO LTH_KNA1
WITH KEY KUNNR = LTH_ZTEGMMM001-Z_ENDUSER_CD
BINARY SEARCH.
IF SY-SUBRC = 0.
CLEAR LTH_ADRC.
READ TABLE LTD_ADRC INTO LTH_ADRC
WITH KEY ADDRNUMBER =  LTH_KNA1-ADRNR
BINARY SEARCH.
IF SY-SUBRC = 0.
LTH_ZTEGMMM001-Z_ENDUSER = LTH_ADRC-Z_NAME.
ENDIF.
**** 2016/3/4 ISID18 INS START ****
ELSE.
CLEAR LTH_ZTEGMMM001-Z_ENDUSER.
**** 2016/3/4 ISID18 INS END ****
ENDIF.

**** START ADD 2015/08/24 ISID21 ****
CLEAR LTH_EUC.
READ TABLE LTD_EUC INTO LTH_EUC
WITH KEY KUNNR = LTH_ZTEGMMM001-Z_ENDUSER_CD
BINARY SEARCH.
IF SY-SUBRC = 0.
LTH_ZTEGMMM001-LANDX = LTH_EUC-LANDX.
**** 2016/3/4 ISID18 INS START ****
ELSE.
CLEAR LTH_ZTEGMMM001-LANDX.
**** 2016/3/4 ISID18 INS END ****
ENDIF.
**** END ADD 2015/08/24 ISID21 ****
APPEND LTH_ZTEGMMM001 TO O_TD_DATA2.
ENDLOOP.
**** END OF UPD 2015/02/10 ISID18 ****

* ソート
**** START DEL 2015/02/10 ISID18 ****
*  SORT O_TD_DATA1 BY WERKS.
**** END DEL 2015/02/10 ISID18 ****
SORT O_TD_DATA2 BY MATNR BUKRS.

ENDFORM.                    " GET_ZTEGMMM001
************************************************************************
*       Form  GET_SO_DATA
************************************************************************
*       受注関連情報取得
************************************************************************
*      <--I_TD_DATA   購買発注データ
*      <--O_TD_DATA1  従業員番号
*      <--O_TD_DATA2  従業員名
*      <--O_TD_DATA3  氏名
*      <--O_TD_DATA4  得意先発注番号
*      <--O_TD_DATA5  EndUser
************************************************************************
FORM GET_SO_DATA
USING    I_TD_DATA  TYPE TYP_TD_PO
**** START UPD 2015/02/10 ISID18 ****
*  CHANGING O_TD_DATA1 TYPE TYP_TD_VBPA
*           O_TD_DATA2 TYPE TYP_TD_PA0001
*           O_TD_DATA3 TYPE TYP_TD_USR21_ADRP
*           O_TD_DATA4 TYPE TYP_TD_VBKD
*           O_TD_DATA5 TYPE TYP_TD_VBPA_ADRC.
CHANGING O_TD_DATA1 TYPE TYP_TD_VBPA
O_TD_DATA2 TYPE TYP_TD_PA0001
**** START ADD 2015/02/26 ISID18 ****
O_TD_DATA5 TYPE TYP_TD_USR21_ADRP
**** END ADD 2015/02/26 ISID18 ****
O_TD_DATA3 TYPE TYP_TD_EKPA
O_TD_DATA4 TYPE TYP_TD_VBKD.
**** END UPD 2015/02/10 ISID18 ****

**** START ADD 2014/12/29 ISID11 ****
**** START DEL 2015/02/10 ISID18 ****
*  DATA:
*    LTD_VBELN TYPE TYP_TD_VBELN,
*    LTD_DUPLIVBPA TYPE TYP_TD_VBELN,
*    LST_VBPA TYPE TYP_TH_VBELN,
*    LRD_ADRC  TYPE BUADDRNRRNG,
*    LST_RNG_ADRC  TYPE BUS_ADDRNUMBER_RANGE,
*    LTD_ADRC  TYPE ZTEGZZ002,
*    LST_ADRC  TYPE ZSEGZZ0002,
*    LST_VBPA_ADRC TYPE TYP_TH_VBPA_ADRC.
**** END DEL 2015/02/10 ISID18 ****
**** END ADD 2014/12/29 ISID11 ****

DATA LTD_I_DATA  TYPE TYP_TD_PO.
DATA LW_PARVW    TYPE VBPA-PARVW.
DATA LTD_VBPA    TYPE TYP_TD_VBPA.
**** START ADD 2015/02/10 ISID18 ****
DATA LTD_EKPA    TYPE TYP_TD_EKPA.
**** END ADD 2015/02/10 ISID18 ****
FIELD-SYMBOLS <LFS_PA0001> TYPE TYP_TH_PA0001.

* 重複キー削除
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY ERNAM.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING ERNAM.
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****

REFRESH O_TD_DATA1.
REFRESH O_TD_DATA2.
REFRESH O_TD_DATA3.
REFRESH O_TD_DATA4.
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
REFRESH O_TD_DATA5.
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****

* 氏名 (省略なし)取得
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT
USR21~BNAME
ADRP~NAME_TEXT
INTO TABLE O_TD_DATA5
FROM USR21 AS USR21
INNER JOIN ADRP AS ADRP
ON USR21~PERSNUMBER = ADRP~PERSNUMBER
FOR ALL ENTRIES IN LTD_I_DATA
WHERE USR21~BNAME = LTD_I_DATA-ERNAM.
ENDIF.
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****

* 重複キー削除
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY VBELN.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING VBELN.
**** START DEL 2015/02/26 ISID18 ****
*  IF LTD_I_DATA[] IS INITIAL.
*    RETURN.
*  ENDIF.
**** END DEL 2015/02/26 ISID18 ****

* 取引先機能変換
CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = CNS_PARVW_PE
IMPORTING
OUTPUT = LW_PARVW.

* 営業員を取得
**** START ADD 2015/02/26 ISID18 ****
IF LTD_I_DATA[] IS NOT INITIAL.
**** END ADD 2015/02/26 ISID18 ****
SELECT
VBELN
POSNR
PERNR
FROM VBPA
INTO TABLE O_TD_DATA1
FOR ALL ENTRIES IN LTD_I_DATA
WHERE VBELN = LTD_I_DATA-VBELN
AND PARVW = LW_PARVW.
**** START ADD 2015/02/26 ISID18 ****
*   得意先発注番号取得
SELECT
VBELN
POSNR
BSTKD
INTO TABLE O_TD_DATA4
FROM VBKD
FOR ALL ENTRIES IN LTD_I_DATA
WHERE VBELN = LTD_I_DATA-VBELN.
ENDIF.
**** END ADD 2015/02/26 ISID18 ****

* 営業員名取得
LTD_VBPA[] = O_TD_DATA1[].
SORT LTD_VBPA BY PERNR.
DELETE ADJACENT DUPLICATES FROM LTD_VBPA
COMPARING PERNR.
IF LTD_VBPA[] IS NOT INITIAL.
SELECT
PERNR
BEGDA
**** START UPD 2015/02/25 ISID18 ****
*      SNAME
ENAME
**** END UPD 2015/02/25 ISID18 ****
INTO TABLE O_TD_DATA2
FROM PA0001
FOR ALL ENTRIES IN LTD_VBPA
WHERE PERNR = LTD_VBPA-PERNR.
ENDIF.

**** START ADD 2015/02/10 ISID18 ****
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY EBELN EKORG.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING EBELN EKORG.
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT EBELN
PERNR
INTO TABLE O_TD_DATA3
FROM EKPA
FOR ALL ENTRIES IN LTD_I_DATA
WHERE EBELN = LTD_I_DATA-EBELN
AND EBELP = SPACE
AND EKORG = LTD_I_DATA-EKORG
AND PARVW = LW_PARVW.
ENDIF.
LTD_EKPA[] = O_TD_DATA3[].
SORT LTD_EKPA BY PERNR.
DELETE ADJACENT DUPLICATES FROM LTD_EKPA
COMPARING PERNR.
IF LTD_EKPA[] IS NOT INITIAL.
SELECT PERNR
BEGDA
**** START UPD 2015/02/25 ISID18 ****
*           SNAME
ENAME
**** END UPD 2015/02/25 ISID18 ****
APPENDING TABLE O_TD_DATA2
FROM PA0001
FOR ALL ENTRIES IN LTD_EKPA
WHERE PERNR = LTD_EKPA-PERNR.
ENDIF.
**** END ADD 2015/02/10 ISID18 ****

SORT O_TD_DATA2 BY PERNR ASCENDING
BEGDA DESCENDING.
LOOP AT O_TD_DATA2 ASSIGNING <LFS_PA0001>.
AT NEW PERNR.
DELETE O_TD_DATA2
WHERE PERNR  = <LFS_PA0001>-PERNR
AND BEGDA <> <LFS_PA0001>-BEGDA.
ENDAT.
ENDLOOP.

**** START DEL 2015/02/26 ISID18 ****
** 得意先発注番号取得
*  SELECT
*    VBELN
*    POSNR
*    BSTKD
*    INTO TABLE O_TD_DATA4
*    FROM VBKD
*     FOR ALL ENTRIES IN LTD_I_DATA
*   WHERE VBELN = LTD_I_DATA-VBELN.
**** END DEL 2015/02/26 ISID18 ****

**** START DEL 2015/02/10 ISID18 ****
** 取引先機能変換
*  CLEAR LW_PARVW.
*  CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
*    EXPORTING
*      INPUT  = CNS_PARVW_ZJ
*    IMPORTING
*      OUTPUT = LW_PARVW.
*
** EndUserの取得
***** START UPD 2014/12/29 ISID11 ****
**  SELECT
**    VBPA~VBELN
**    VBPA~POSNR
**    ADRC~NAME1
**    INTO TABLE O_TD_DATA5
**    FROM VBPA AS VBPA
**   INNER JOIN ADRC AS ADRC
**      ON VBPA~ADRNR = ADRC~ADDRNUMBER
**     FOR ALL ENTRIES IN LTD_I_DATA
**   WHERE VBPA~VBELN = LTD_I_DATA-VBELN
**     AND VBPA~PARVW = LW_PARVW.
*
*  SELECT VBELN
*         POSNR
*         ADRNR
*    INTO TABLE LTD_VBELN
*    FROM VBPA
*     FOR ALL ENTRIES IN LTD_I_DATA
*   WHERE VBPA~VBELN = LTD_I_DATA-VBELN
*     AND VBPA~PARVW = LW_PARVW.
*
*  IF SY-SUBRC = 0.
*
*    LTD_DUPLIVBPA = LTD_VBELN.
*    SORT LTD_DUPLIVBPA BY ADRNR ASCENDING.
*    DELETE ADJACENT DUPLICATES FROM LTD_DUPLIVBPA
*                          COMPARING ADRNR.
*
*    LST_RNG_ADRC-SIGN   = 'I'.
*    LST_RNG_ADRC-OPTION = 'EQ'.
*
*    LOOP AT LTD_DUPLIVBPA INTO LST_VBPA.
*
*      LST_RNG_ADRC-LOW = LST_VBPA-ADRNR.
*      APPEND LST_RNG_ADRC TO LRD_ADRC.
*
*    ENDLOOP.
*
**   Get ADRC address and name
*    CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
*      EXPORTING
*        IMPMULTITFLG     = '2'
*        IMPRNGADDRNUMBER = LRD_ADRC
*      IMPORTING
*        EXPTABADRC       = LTD_ADRC.
*
*    SORT LTD_ADRC BY ADDRNUMBER ASCENDING.
*
*    LOOP AT LTD_VBELN INTO LST_VBPA.
*
*      CLEAR:
*        LST_ADRC.
*
*      READ TABLE LTD_ADRC INTO LST_ADRC
*        WITH KEY ADDRNUMBER = LST_VBPA-ADRNR
*        BINARY SEARCH.
*
*      IF SY-SUBRC = 0.
*
*        LST_VBPA_ADRC-VBELN = LST_VBPA-VBELN.
*        LST_VBPA_ADRC-POSNR = LST_VBPA-POSNR.
*        LST_VBPA_ADRC-NAME1 = LST_ADRC-Z_NAME.
*        APPEND LST_VBPA_ADRC TO O_TD_DATA5.
*
*      ENDIF.
*
*    ENDLOOP.
*
*  ENDIF.
**** END DEL 2015/02/10 ISID18 ****
**** END UPD 2014/12/29 ISID11 ****

* ソート
SORT O_TD_DATA1 BY VBELN POSNR.
SORT O_TD_DATA2 BY PERNR.
**** START UPD 2015/02/10 ISID18 ****
*  SORT O_TD_DATA3 BY BNAME.
SORT O_TD_DATA3 BY EBELN.
**** END UPD 2015/02/10 ISID18 ****
SORT O_TD_DATA4 BY VBELN POSNR.
**** START DEL 2015/02/10 ISID18 ****
*  SORT O_TD_DATA5 BY VBELN POSNR.
**** END DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
SORT O_TD_DATA5 BY BNAME.
**** END ADD 2015/02/26 ISID18 ****

ENDFORM.                    " GET_SO_DATA
************************************************************************
*       Form  GET_ZTEGZZM002
************************************************************************
*       通貨コード
************************************************************************
*      <--I_TD_DATA  購買発注データ
*      <--O_TD_DATA  通貨コード
************************************************************************
FORM GET_ZTEGZZM002
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_ZTEGZZM002.

* 重複キー削除
DATA LTD_I_DATA TYPE TYP_TD_PO.
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY WAERS.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING WAERS.

REFRESH O_TD_DATA.
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT
WAERS
Z_WAERS
INTO TABLE O_TD_DATA
FROM ZTEGZZM002
FOR ALL ENTRIES IN LTD_I_DATA
WHERE WAERS = LTD_I_DATA-WAERS.
ENDIF.
SORT O_TD_DATA BY WAERS.

ENDFORM.                    " GET_ZTEGZZM002
************************************************************************
*       Form  GET_LFA1_T005X
************************************************************************
*       小数点書式、日付書式取得
************************************************************************
*      -->I_TD_DATA  購買発注データ
*      <--O_TD_DATA  小数点書式、日付書式
************************************************************************
FORM GET_LFA1_T005X
USING    I_TD_DATA TYPE TYP_TD_PO
CHANGING O_TD_DATA TYPE TYP_TD_LFA1_T005X.

* 仕入先データ
TYPES: BEGIN OF LTYP_TH_LFA1,
LIFNR TYPE LFA1-LIFNR,
LAND1 TYPE LFA1-LAND1,
END OF LTYP_TH_LFA1.
DATA: LTH_LFA1  TYPE LTYP_TH_LFA1,
LTD_LFA1  TYPE STANDARD TABLE OF LTYP_TH_LFA1,
LTD_LFA12 TYPE STANDARD TABLE OF LTYP_TH_LFA1.

* 国コード - 小数点とデータ形式
TYPES: BEGIN OF LTYP_TH_T005X,
LAND  TYPE T005X-LAND,
XDEZP TYPE T005X-XDEZP,
DATFM TYPE T005X-DATFM,
END OF LTYP_TH_T005X.
DATA: LTH_T005X TYPE LTYP_TH_T005X,
LTD_T005X TYPE STANDARD TABLE OF LTYP_TH_T005X.
DATA: LTH_LFA1_T005X TYPE TYP_TH_LFA1_T005X.
DATA: LTD_I_DATA TYPE TYP_TD_PO.

* 重複キー削除
LTD_I_DATA[] = I_TD_DATA[].
SORT LTD_I_DATA BY LIFNR.
DELETE ADJACENT DUPLICATES FROM LTD_I_DATA
COMPARING LIFNR.
REFRESH O_TD_DATA.

* 仕入先コードデータ取得
IF LTD_I_DATA[] IS NOT INITIAL.
SELECT
LIFNR
LAND1
FROM LFA1
INTO TABLE LTD_LFA1
FOR ALL ENTRIES IN LTD_I_DATA
WHERE LIFNR = LTD_I_DATA-LIFNR.
ENDIF.

* 小数点書式、日付書式取得
LTD_LFA12[] = LTD_LFA1[].
SORT LTD_LFA12 BY LAND1.
DELETE ADJACENT DUPLICATES FROM LTD_LFA12
COMPARING LAND1.
IF LTD_LFA12[] IS NOT INITIAL.
SELECT
LAND
XDEZP
DATFM
FROM T005X
INTO TABLE LTD_T005X
FOR ALL ENTRIES IN LTD_LFA12
WHERE LAND = LTD_LFA12-LAND1.
ENDIF.

* ソート
SORT LTD_LFA1  BY LIFNR.
SORT LTD_T005X BY LAND.

LOOP AT LTD_LFA1 INTO LTH_LFA1.
MOVE-CORRESPONDING LTH_LFA1 TO LTH_LFA1_T005X.
CLEAR LTH_T005X.
READ TABLE LTD_T005X INTO LTH_T005X
WITH KEY LAND = LTH_LFA1-LAND1
BINARY SEARCH.
LTH_LFA1_T005X-XDEZP = LTH_T005X-XDEZP.
LTH_LFA1_T005X-DATFM = LTH_T005X-DATFM.
APPEND LTH_LFA1_T005X TO O_TD_DATA.
ENDLOOP.

ENDFORM.                    " GET_LFA1_T005X
************************************************************************
*      Form  GET_SERVER_FILE
************************************************************************
*     帳票用ファイル名取得
************************************************************************
*      -->I_TD_DATA 会社コード
*      <--O_TD_DATA ファイル名
************************************************************************
FORM GET_SERVER_FILE
**** START UPD 2015/02/10 ISID18 ****
*  USING    I_TD_DATA TYPE TYP_TD_T001K
USING    I_TD_DATA TYPE TYP_TD_PO
**** END UPD 2015/02/10 ISID18 ****
CHANGING O_TD_DATA TYPE TYP_TD_FILENAME.

DATA:
**** START UPD 2015/02/10 ISID18 ****
*    LTH_IDATA    TYPE TYP_TH_T001K,
LTH_IDATA    TYPE TYP_TH_PO,
LTD_IDATA    TYPE TYP_TD_PO,
**** END UPD 2015/02/10 ISID18 ****
LTH_ODATA    TYPE TYP_TH_FILENAME,
**** BEGIN OF INS 2015/02/03 ISID18 ****
LW_ENCODING  TYPE ABAP_ENCODING,
LW_RC        TYPE I,
**** END OF INS 2015/02/03 ISID18 ****
LW_OUTPUT_FN TYPE ZEOUTPUTFN,
LW_OUTPUT_CP TYPE ZEOUTPUTCP,
LW_CODEPAGE  TYPE CPCODEPAGE,
LW_FILEPATH  TYPE XUVALUE.

**** START ADD 2015/05/25 ISID18 ****
DATA LW_LANGU   TYPE SY-LANGU.
DATA LW_SUBKEY1 TYPE ZTEGZZM001-Z_CONV_SUBKEY1.
IF P_LANGU IS NOT INITIAL.
LW_LANGU = P_LANGU.
ELSE.
LW_LANGU = SY-LANGU.
ENDIF.
CALL FUNCTION 'CONVERSION_EXIT_ISOLA_OUTPUT'
EXPORTING
INPUT  = LW_LANGU
IMPORTING
OUTPUT = LW_SUBKEY1.
**** END ADD 2015/05/25 ISID18 ****

REFRESH O_TD_DATA.

**** START ADD 2015/02/10 ISID18 ****
LTD_IDATA[] = I_TD_DATA[].
SORT LTD_IDATA BY BUKRS.
DELETE ADJACENT DUPLICATES FROM LTD_IDATA
COMPARING BUKRS.
**** END ADD 2015/02/10 ISID18 ****

* 選択画面「Print」「Reprint」が選択されている場合
CASE 'X'.
WHEN RB_PRINT
OR RB_REPNT.
GET PARAMETER ID 'ZSVF' FIELD LW_FILEPATH.

*     出力ファイル名取得
**** START UPD 2015/02/10 ISID18 ****
*      LOOP AT I_TD_DATA INTO LTH_IDATA.
LOOP AT LTD_IDATA INTO LTH_IDATA.
**** END UPD 2015/02/10 ISID18 ****
CLEAR: LTH_ODATA.
CLEAR: LW_OUTPUT_FN,
LW_OUTPUT_CP.
SELECT Z_OUTPUT_FN
Z_OUTPUT_CP
UP TO 1 ROWS
INTO (LW_OUTPUT_FN,LW_OUTPUT_CP)
FROM ZTEGZZM001
WHERE PROGNAME = SY-REPID
AND BUKRS    = LTH_IDATA-BUKRS
**** START ADD 2015/05/25 ISID18 ****
AND Z_CONV_SUBKEY1 = LW_SUBKEY1.
**** END ADD 2015/05/25 ISID18 ****
ENDSELECT.
*       データが取得できなかった場合
IF SY-SUBRC <> 0.
MESSAGE S051 WITH 'ZTEGZZM001' SY-REPID
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDIF.
CONCATENATE LW_FILEPATH
LW_OUTPUT_FN
SY-REPID
SY-UNAME
SY-UZEIT
CNS_TXT
INTO LTH_ODATA-FILENAME.
LTH_ODATA-BUKRS = LTH_IDATA-BUKRS.
LTH_ODATA-CODEPAGE = LW_OUTPUT_CP.
APPEND LTH_ODATA TO O_TD_DATA.
ENDLOOP.

*   選択画面「Download」が選択されている場合
WHEN RB_DOWNL.
CLEAR LTH_ODATA.
*     GUIコードページ取得
**** BEGIN OF UPD 2015/02/03 ISID18 ****
*      CALL FUNCTION 'NLS_GET_FRONTEND_CP'
*        EXPORTING
*          LANGU                 = SY-LANGU
*        IMPORTING
*          FRONTEND_CODEPAGE     = LW_CODEPAGE
*        EXCEPTIONS
*          ILLEGAL_SYST_CODEPAGE = 1
*          NO_FRONTEND_CP_FOUND  = 2
*          INTERNAL_OR_DB_ERROR  = 3
*          OTHERS                = 4.
*      IF SY-SUBRC = 0
CALL METHOD CL_GUI_FRONTEND_SERVICES=>GET_SAPLOGON_ENCODING
CHANGING
FILE_ENCODING                 = LW_ENCODING
RC                            = LW_RC
EXCEPTIONS
CNTL_ERROR                    = 1
ERROR_NO_GUI                  = 2
NOT_SUPPORTED_BY_GUI          = 3
CANNOT_INITIALIZE_GLOBALSTATE = 4
OTHERS                        = 5.
IF SY-SUBRC = 0.
LW_CODEPAGE = LW_ENCODING.
**** END OF UPD 2015/02/03 ISID18 ****
*       GUIコードページ名取得
CALL FUNCTION 'SCP_CODEPAGE_INFO'
EXPORTING
CODEPAGE  = LW_CODEPAGE
IMPORTING
HTTP_NAME = LTH_ODATA-CODEPAGE.
ENDIF.
LTH_ODATA-FILENAME = P_FILE.
APPEND LTH_ODATA TO O_TD_DATA.
WHEN OTHERS.
ENDCASE.
SORT O_TD_DATA BY BUKRS.

ENDFORM.                    " GET_SERVER_FILE
************************************************************************
*      Form  EDIT_DATA
************************************************************************
*      出力データ編集
************************************************************************
*      -->I_TD_DATA             購買発注伝票データ
*      -->I_TD_ZTEGMMT011       Output Management
*      -->I_TD_LFA1_ADRC        仕入先情報
*      -->I_TD_TWLAD_ADRC       保管場所住所情報
*      -->I_TD_ADRC             納入先住所情報
*      -->I_TD_EINA_T069T       証明書カテゴリテキスト
*      -->I_TD_T024             購買グループテキスト
*      -->I_TD_T052U            支払条件テキスト
*      -->I_TD_T001K            会社コード
*      -->I_TD_ZTEGMMM001       Purpose
*      -->I_TD_VBPA             従業員番号
*      -->I_TD_PA0001           従業員名
*      -->I_TD_USR21_ADRP       氏名
*      -->I_TD_VBKD             CustomerPONo
*      -->I_TD_VBPA_ADRC        EndUser
*      -->I_TD_ZTEGZZM002       通貨コード
*      -->I_TD_LFA1_T005X       小数点書式、日付書式
*      -->I_TD_FILENAME         ファイル名
*      <--O_TD_SFILE            出力ファイルデータ
*      <--O_TD_FILE             出力ファイルデータ(会社コード付け)
*      <--O_TD_MSG              メッセージ
*      <--O_RECORD_TOT         処理件数
*      <--O_RECORD_ERR         エラー件数
*      <--O_RECORD_OK          成功件数
************************************************************************
FORM EDIT_DATA
USING   I_TD_PO         TYPE TYP_TD_PO
I_TD_ZTEGMMT011 TYPE TYP_TD_ZTEGMMT011
I_TD_LFA1_ADRC  TYPE TYP_TD_LFA1_ADRC
**** START DEL 2015/02/10 ISID18 ****
*           I_TD_TWLAD_ADRC TYPE TYP_TD_TWLAD_ADRC
*           I_TD_ADRC       TYPE TYP_TD_ADRC
**** END DEL 2015/02/10 ISID18 ****
I_TD_EINA_T069T TYPE TYP_TD_EINA_T069T
**** START ADD 2015/02/10 ISID18 ****
I_TD_TVKO       TYPE TYP_TD_TVKO
**** END ADD 2015/02/10 ISID18 ****
I_TD_T024       TYPE TYP_TD_T024
I_TD_T052U      TYPE TYP_TD_T052U
**** START DEL 2015/02/10 ISID18 ****
*           I_TD_T001K      TYPE TYP_TD_T001K
**** END DEL 2015/02/10 ISID18 ****
I_TD_ZTEGMMM001 TYPE TYP_TD_ZTEGMMM001
**** START ADD 2015/05/25 ISID18 ****
I_TD_LFB1       TYPE TYP_TD_LFB1
I_TH_ZTEGZZM999 TYPE TYP_TH_ZTEGZZM999
**** END ADD 2015/05/25 ISID18 ****
**** START ADD 2015/02/10 ISID18 ****
I_TD_VBAK_KNA1  TYPE TYP_TD_VBAK_KNA1
I_TD_EKPA       TYPE TYP_TD_EKPA
**** END ADD 2015/02/10 ISID18 ****
I_TD_VBPA       TYPE TYP_TD_VBPA
I_TD_PA0001     TYPE TYP_TD_PA0001
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
I_TD_USR21_ADRP TYPE TYP_TD_USR21_ADRP
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****
I_TD_VBKD       TYPE TYP_TD_VBKD
**** START ADD 2015/02/10 ISID18 ****
I_TD_VBPA_T005T TYPE TYP_TD_VBPA_T005T
**** END ADD 2015/02/10 ISID18 ****
**** START DEL 2015/02/10 ISID18 ****
*           I_TD_VBPA_ADRC  TYPE TYP_TD_VBPA_ADRC
**** END DEL 2015/02/10 ISID18 ****
I_TD_ZTEGZZM002 TYPE TYP_TD_ZTEGZZM002
I_TD_LFA1_T005X TYPE TYP_TD_LFA1_T005X
I_TD_FILENAME   TYPE TYP_TD_FILENAME
CHANGING O_TD_SFILE      TYPE TYP_TD_ZSEGMM0001
O_TD_FILE_BUKRS TYPE TYP_TD_FILE
O_TD_MSG        TYPE TYP_TD_MSG
O_RECORD_TOT    TYPE I
O_RECORD_ERR    TYPE I
O_RECORD_OK     TYPE I.

DATA:
LTH_PO         TYPE TYP_TH_PO,
**** START DEL 2015/02/10 ISID18 ****
**** START ADD 2015/02/26 ISID18 ****
LTH_USR21_ADRP TYPE TYP_TH_USR21_ADRP,
**** END ADD 2015/02/26 ISID18 ****
**** END DEL 2015/02/10 ISID18 ****
LTH_ZTEGZZM002 TYPE TYP_TH_ZTEGZZM002,
LTH_LFA1_ADRC  TYPE TYP_TH_LFA1_ADRC,
**** START DEL 2015/02/10 ISID18 ****
*    LTH_TWLAD_ADRC TYPE TYP_TH_TWLAD_ADRC,
*    LTH_ADRC       TYPE TYP_TH_ADRC,
**** END DEL 2015/02/10 ISID18 ****
LTH_T024       TYPE TYP_TH_T024,
LTH_T052U      TYPE TYP_TH_T052U,
**** START DEL 2015/02/10 ISID18 ****
*    LTH_T001K      TYPE TYP_TH_T001K,
**** END DEL 2015/02/10 ISID18 ****
LTH_ZTEGMMM001 TYPE TYP_TH_ZTEGMMM001,
**** START ADD 2015/05/25 ISID18 ****
LTH_LFB1       TYPE TYP_TH_LFB1,
**** END ADD 2015/05/25 ISID18 ****
LTH_VBPA       TYPE TYP_TH_VBPA,
LTH_PA0001     TYPE TYP_TH_PA0001,
**** START DEL 2015/02/10 ISID18 ****
*    LTH_VBPA_ADRC  TYPE TYP_TH_VBPA_ADRC,
**** END DEL 2015/02/10 ISID18 ****
LTH_EINA_T069T TYPE TYP_TH_EINA_T069T,
**** START ADD 2015/02/10 ISID18 ****
LTH_TVKO       TYPE TYP_TH_TVKO,
LTH_VBAK_KNA1  TYPE TYP_TH_VBAK_KNA1,
LTH_EKPA       TYPE TYP_TH_EKPA,
LTD_PO         TYPE TYP_TD_PO,
LTH_VBPA_T005T TYPE TYP_TH_VBPA_T005T,
**** END ADD 2015/02/10 ISID18 ****
LTH_LFA1_T005X TYPE TYP_TH_LFA1_T005X,
LTH_VBKD       TYPE TYP_TH_VBKD,
LTH_SFILE      TYPE ZSEGMM0001,
LTH_FILE_BUKRS TYPE TYP_TH_FILE,
LTH_MSG        TYPE TYP_TH_MSG,
LTH_ZTEGMMT012 TYPE ZTEGMMT012,
LTD_ZTEGMMT012 TYPE STANDARD TABLE OF ZTEGMMT012,
LTD_SFILE      TYPE STANDARD TABLE OF ZSEGMM0001,
LW_DATUM       TYPE SY-DATUM,
LW_UZEIT       TYPE SY-UZEIT,
LW_WERKS       TYPE T001W-WERKS,
LW_END_FLG(1)  TYPE C,
LW_NETPR(16)   TYPE P DECIMALS 6,
LW_AMT_C       TYPE STRING,
LW_AMT         TYPE ZEZAMOUNT,
LW_REFNO       TYPE NUMC15,
LW_OUTPUT_MD   TYPE CHAR01,           " Output mode
LW_LOGNO       TYPE ZEOUTPUTLOGNO,    " Output logno
LW_ERRFLG(1)   TYPE C.                " エラーフラグ
FIELD-SYMBOLS:
**** START ADD 2015/07/07 ISID18 ****
<LFS_SFILE_BUKRS> TYPE TYP_TH_FILE,
**** END ADD 2015/07/07 ISID18 ****
<LFS_SFILE>    TYPE ZSEGMM0001.

REFRESH O_TD_SFILE.
REFRESH O_TD_FILE_BUKRS.
REFRESH O_TD_MSG.

**** START ADD 2015/02/10 ISID18 ****
LTD_PO[] = I_TD_PO[].
SORT LTD_PO BY WERKS.
DELETE ADJACENT DUPLICATES FROM LTD_PO
COMPARING WERKS.
**** END ADD 2015/02/10 ISID18 ****

* Output Mode編集
CASE 'X'.
WHEN RB_PRINT
OR RB_REPNT.
LW_OUTPUT_MD = CNS_MODE_P.  " 「Print」「Reprint」の場合
WHEN RB_DOWNL.
LW_OUTPUT_MD = CNS_MODE_D.  " 「Download」の場合
WHEN OTHERS.
ENDCASE.
LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_PO INTO LTH_PO.
CLEAR LTH_ZTEGMMT012.

*   購買発注データ
LTH_ZTEGMMT012-Z_OUTPUT_MODE   = LW_OUTPUT_MD. " 出力モード
LTH_ZTEGMMT012-EBELN           = LTH_PO-EBELN. " PurchaseOrder
LTH_ZTEGMMT012-AEDAT           = LTH_PO-AEDAT. " CreatedOn
LTH_ZTEGMMT012-EBELP           = LTH_PO-EBELP. " PurchaseOrderItem
LTH_ZTEGMMT012-LNAME           = P_TRAY.       " Printer/Tray
LTH_ZTEGMMT012-Z_COMP_NAME     = P_CNAME.      " CopmanyName
LTH_ZTEGMMT012-Z_COMP_ADDRESS1 = P_CADD1.      " CopmanyAddress1
LTH_ZTEGMMT012-Z_COMP_ADDRESS2 = P_CADD2.      " CopmanyAddress2
LTH_ZTEGMMT012-Z_COMP_TEL      = P_CTEL.       " CopmanyTel
LTH_ZTEGMMT012-Z_COMP_FAX      = P_CFAX.       " CopmanyFax
***** 2015/10/19 ISID18 DEL START *****
*    LTH_ZTEGMMT012-Z_PO_DATE       = SY-DATLO.     " PODate
***** 2015/10/19 ISID18 DEL END *****
***** 2015/10/19 ISID18 INS START *****
LTH_ZTEGMMT012-Z_PO_DATE       = LTH_PO-BEDAT.     " PODate
***** 2015/10/19 ISID18 INS END *****

**** START ADD 2014/12/26 ISID11 ****
LTH_ZTEGMMT012-Z_REPORT_LANG   = P_LANGU.       "Report Language
LTH_ZTEGMMT012-Z_REPORT_TITLE  = P_TITLE.       "Report Title
**** END ADD 2014/12/26 ISID11 ****

*   SalesDivision
CLEAR LTH_T024.
READ TABLE I_TD_T024 INTO LTH_T024
WITH KEY EKGRP = LTH_PO-EKGRP
BINARY SEARCH.
LTH_ZTEGMMT012-Z_SALES_DIV = LTH_T024-EKNAM.

*   Sales Coordinatorの取得
IF LTH_PO-VBELN IS NOT INITIAL.
CLEAR LTH_VBPA.
READ TABLE I_TD_VBPA INTO LTH_VBPA
WITH KEY VBELN = LTH_PO-VBELN
POSNR = LTH_PO-VBELP
BINARY SEARCH.
IF SY-SUBRC <> 0.
CLEAR LTH_VBPA.
READ TABLE I_TD_VBPA INTO LTH_VBPA
WITH KEY VBELN = LTH_PO-VBELN
BINARY SEARCH.
ENDIF.
CLEAR LTH_PA0001.
READ TABLE I_TD_PA0001 INTO LTH_PA0001
WITH KEY PERNR = LTH_VBPA-PERNR
BINARY SEARCH.
**** START UPD 2015/02/25 ISID18 ****
*      LTH_ZTEGMMT012-Z_SALES_CRDNTR = LTH_PA0001-SNAME.
LTH_ZTEGMMT012-Z_SALES_CRDNTR = LTH_PA0001-ENAME.
**** END UPD 2015/02/25 ISID18 ****
ELSE.
**** START UPD 2015/02/10 ISID18 ****
*      CLEAR LTH_USR21_ADRP.
*      READ TABLE I_TD_USR21_ADRP INTO LTH_USR21_ADRP
*        WITH KEY BNAME = LTH_PO-ERNAM
*        BINARY SEARCH.
*      LTH_ZTEGMMT012-Z_SALES_CRDNTR = LTH_USR21_ADRP-NAME_TEXT.
CLEAR LTH_EKPA.
READ TABLE I_TD_EKPA INTO LTH_EKPA
WITH KEY EBELN = LTH_PO-EBELN
BINARY SEARCH.
CLEAR LTH_PA0001.
READ TABLE I_TD_PA0001 INTO LTH_PA0001
WITH KEY PERNR = LTH_EKPA-PERNR
BINARY SEARCH.
**** START UPD 2015/02/25 ISID18 ****
*      LTH_ZTEGMMT012-Z_SALES_CRDNTR = LTH_PA0001-SNAME.
LTH_ZTEGMMT012-Z_SALES_CRDNTR = LTH_PA0001-ENAME.
**** END UPD 2015/02/25 ISID18 ****
**** END UPD 2015/02/10 ISID18 ****
ENDIF.

*   Vendor Name,Address
LTH_ZTEGMMT012-Z_VEND_OT      = LTH_PO-LIFNR. " VendCodeTo
CLEAR LTH_LFA1_ADRC.
READ TABLE I_TD_LFA1_ADRC INTO LTH_LFA1_ADRC
WITH KEY LIFNR = LTH_PO-LIFNR
BINARY SEARCH.
LTH_ZTEGMMT012-Z_VEND_NAME_OT = LTH_LFA1_ADRC-NAME1.
LTH_ZTEGMMT012-Z_ADDRESS1_OT  = LTH_LFA1_ADRC-STREET.
LTH_ZTEGMMT012-Z_ADDRESS2_OT  = LTH_LFA1_ADRC-CITY1.
**** START ADD 2014/12/26 ISID11 ****
LTH_ZTEGMMT012-Z_ADDRESS3_OT  = LTH_LFA1_ADRC-STR_SUPPL1.
LTH_ZTEGMMT012-Z_ADDRESS4_OT  = LTH_LFA1_ADRC-STR_SUPPL2.
**** END ADD 2014/12/26 ISID11 ****
LTH_ZTEGMMT012-Z_TEL_OT       = LTH_LFA1_ADRC-TEL_NUMBER.
LTH_ZTEGMMT012-Z_FAX_OT       = LTH_LFA1_ADRC-FAX_NUMBER.
**** START ADD 2015/02/10 ISID18 ****
LTH_ZTEGMMT012-Z_ATTN_OT      = LTH_PO-VERKF.
**** END ADD 2015/02/10 ISID18 ****

*   VendCodeDeliverTo
**** START UPD 2015/02/10 ISID18 ****
*    IF LTH_PO-LGORT IS NOT INITIAL.
*      CLEAR LTH_TWLAD_ADRC.
*      READ TABLE I_TD_TWLAD_ADRC INTO LTH_TWLAD_ADRC
*        WITH KEY WERKS = LTH_PO-WERKS
*                 LGORT = LTH_PO-LGORT
*        BINARY SEARCH.
*      LTH_ZTEGMMT012-Z_VEND_DT      = LTH_TWLAD_ADRC-ADRNR.
*      LTH_ZTEGMMT012-Z_VEND_NAME_DT = LTH_TWLAD_ADRC-NAME1.
*      LTH_ZTEGMMT012-Z_ADDRESS1_DT  = LTH_TWLAD_ADRC-STREET.
*      LTH_ZTEGMMT012-Z_ADDRESS2_DT  = LTH_TWLAD_ADRC-CITY1.
***** START ADD 2014/12/26 ISID11 ****
*      LTH_ZTEGMMT012-Z_ADDRESS3_DT  = LTH_TWLAD_ADRC-STR_SUPPL1.
*      LTH_ZTEGMMT012-Z_ADDRESS4_DT  = LTH_TWLAD_ADRC-STR_SUPPL2.
***** END ADD 2014/12/26 ISID11 ****
*      LTH_ZTEGMMT012-Z_TEL_DT       = LTH_TWLAD_ADRC-TEL_NUMBER.
*      LTH_ZTEGMMT012-Z_FAX_DT       = LTH_TWLAD_ADRC-FAX_NUMBER.
*    ELSE.
*      CLEAR LTH_ADRC.
*      READ TABLE I_TD_ADRC INTO LTH_ADRC
*        WITH KEY ADDRNUMBER = LTH_PO-ADRN2
*        BINARY SEARCH.
*      LTH_ZTEGMMT012-Z_VEND_DT      = LTH_ADRC-ADDRNUMBER.
*      LTH_ZTEGMMT012-Z_VEND_NAME_DT = LTH_ADRC-NAME1.
*      LTH_ZTEGMMT012-Z_ADDRESS1_DT  = LTH_ADRC-STREET.
*      LTH_ZTEGMMT012-Z_ADDRESS2_DT  = LTH_ADRC-CITY1.
***** START ADD 2014/12/26 ISID11 ****
*      LTH_ZTEGMMT012-Z_ADDRESS3_DT  = LTH_ADRC-STR_SUPPL1.
*      LTH_ZTEGMMT012-Z_ADDRESS4_DT  = LTH_ADRC-STR_SUPPL2.
***** END ADD 2014/12/26 ISID11 ****
*      LTH_ZTEGMMT012-Z_TEL_DT       = LTH_ADRC-TEL_NUMBER.
*      LTH_ZTEGMMT012-Z_FAX_DT       = LTH_ADRC-FAX_NUMBER.
*    ENDIF.
PERFORM FRM_VEND_DT_GET
USING    LTH_PO-EBELN          " 購買伝票
LTH_PO-EBELP          " 購買伝票明細
CHANGING LTH_ZTEGMMT012.
**** END UPD 2015/02/10 ISID18 ****
**** START UPD 2015/07/30 ISID18 ****
*    LTH_ZTEGMMT012-Z_SHIP_TERMS     = LTH_PO-INCO1. " ShippingTerms
IF LTH_PO-INCO1 IS INITIAL AND
LTH_PO-INCO2_ITEM IS NOT INITIAL.
LTH_ZTEGMMT012-Z_SHIP_TERMS = LTH_PO-INCO2_ITEM. " ShippingTerms
ELSEIF LTH_PO-INCO1 IS NOT INITIAL AND
LTH_PO-INCO2_ITEM IS INITIAL.
LTH_ZTEGMMT012-Z_SHIP_TERMS = LTH_PO-INCO1.      " ShippingTerms
ELSEIF LTH_PO-INCO1 IS NOT INITIAL AND
LTH_PO-INCO2_ITEM IS NOT INITIAL.
CONCATENATE LTH_PO-INCO1
LTH_PO-INCO2_ITEM
INTO LTH_ZTEGMMT012-Z_SHIP_TERMS
SEPARATED BY SPACE.
ENDIF.
**** END UPD 2015/07/30 ISID18 ****

**** START ADD BY ISID17 2015/04/29 ****
CLEAR LTH_ZTEGMMT012-Z_PAYMENT_TERMS.
* 伝票タイプが「NB」「ZB」の場合
CASE LTH_PO-BSART.
WHEN CNS_BSART_NB    "購買依頼、購買発注
OR CNS_BSART_ZB.   "返品発注
**** END ADD BY ISID17 2015/04/29 ****
*     PaymentTerms
CLEAR LTH_T052U.
READ TABLE I_TD_T052U INTO LTH_T052U
WITH KEY ZTERM = LTH_PO-ZTERM
BINARY SEARCH.
LTH_ZTEGMMT012-Z_PAYMENT_TERMS = LTH_T052U-TEXT1.
**** START ADD BY ISID17 2015/04/29 ****
WHEN OTHERS.
ENDCASE.
**** END ADD BY ISID17 2015/04/29 ****

**** START UPD 2015/02/10 ISID18 ****
*    LTH_ZTEGMMT012-MATNR           = LTH_PO-MATNR. " ItemCode
*    LTH_ZTEGMMT012-MAKTX           = LTH_PO-TXZ01. " ItemText
*   ItemCode編集
**** START ADD 2015/09/07 ISID17 ****
*    LTH_ZTEGMMT012-Z_MATNR_PO = LTH_PO-IDNLF.
*    IF LTH_ZTEGMMT012-Z_MATNR_PO IS INITIAL.
*      LTH_ZTEGMMT012-Z_MATNR_PO = LTH_PO-MATNR.
***** START ADD 2015/07/06 ISID18 ****
*    ENDIF.
***** END ADD 2015/07/06 ISID18 ****
LTH_ZTEGMMT012-Z_MATNR_PO = LTH_PO-MATNR.
**** END   ADD 2015/09/07 ISID17 ****

*   ItemText編集
CLEAR LTH_TVKO.
READ TABLE I_TD_TVKO INTO LTH_TVKO
WITH KEY BUKRS = LTH_PO-BUKRS
BINARY SEARCH.
PERFORM FRM_MAKTX_GET
USING    LTH_TVKO
CHANGING LTH_ZTEGMMT012.
**** START DEL 2015/07/06 ISID18 ****
*    ENDIF.
**** END DEL 2015/07/06 ISID18 ****
IF LTH_ZTEGMMT012-MAKTX IS INITIAL.
LTH_ZTEGMMT012-MAKTX = LTH_PO-TXZ01.
ENDIF.
**** END UPD 2015/02/10 ISID18 ****

*   Purpose
**** START DEL 2015/02/10 ISID18 ****
*    CLEAR LTH_T001K.
*    READ TABLE I_TD_T001K INTO LTH_T001K
*      WITH KEY WERKS = LTH_PO-WERKS
*      BINARY SEARCH.
**** END DEL 2015/02/10 ISID18 ****
CLEAR LTH_ZTEGMMM001.
READ TABLE I_TD_ZTEGMMM001 INTO LTH_ZTEGMMM001
WITH KEY MATNR = LTH_PO-MATNR
**** START UPD 2015/02/10 ISID18 ****
*               BUKRS = LTH_T001K-BUKRS
BUKRS = LTH_PO-BUKRS
**** END UPD 2015/02/10 ISID18 ****
BINARY SEARCH.
LTH_ZTEGMMT012-Z_PURPOSE = LTH_ZTEGMMM001-Z_PURPOSE_TEXT.

*   EndUser
**** START UPD 2015/02/10 ISID18 ****
*    CLEAR LTH_VBPA_ADRC.
*    READ TABLE I_TD_VBPA_ADRC INTO LTH_VBPA_ADRC
*      WITH KEY VBELN = LTH_PO-VBELN
*               POSNR = LTH_PO-VBELP
*      BINARY SEARCH.
*    IF SY-SUBRC <> 0.
*      READ TABLE I_TD_VBPA_ADRC INTO LTH_VBPA_ADRC
*        WITH KEY VBELN = LTH_PO-VBELN
*        BINARY SEARCH.
*    ENDIF.
*    LTH_ZTEGMMT012-Z_ENDUSER = LTH_VBPA_ADRC-NAME1.
**** START ADD 2015/05/25 ISID18 ****
CLEAR LTH_LFB1.
READ TABLE I_TD_LFB1 INTO LTH_LFB1
WITH KEY LIFNR = LTH_PO-LIFNR
BUKRS = LTH_PO-BUKRS
BINARY SEARCH.
**** START UPD 2015/08/24 ISID21 ****
*    IF LTH_LFB1-FDGRV <> I_TH_ZTEGZZM999-LOW.
IF LTH_LFB1-FDGRV = I_TH_ZTEGZZM999-LOW.
LTH_ZTEGMMT012-Z_FINAL_DEST_PO = LTH_ZTEGMMM001-LANDX.

**** END UPD 2015/08/24 ISID21 ****
**** END ADD 2015/05/25 ISID18 ****
LTH_ZTEGMMT012-Z_ENDUSER = LTH_ZTEGMMM001-Z_ENDUSER.
IF LTH_ZTEGMMT012-Z_ENDUSER IS INITIAL.
CLEAR LTH_VBAK_KNA1.
READ TABLE I_TD_VBAK_KNA1 INTO LTH_VBAK_KNA1
WITH KEY VBELN = LTH_PO-VBELN
BINARY SEARCH.
LTH_ZTEGMMT012-Z_ENDUSER = LTH_VBAK_KNA1-NAME1.
ENDIF.
**** END UPD 2015/02/10 ISID18 ****
**** START ADD 2015/05/25 ISID18 ****
ENDIF.
**** END ADD 2015/05/25 ISID18 ****
LTH_ZTEGMMT012-MENGE     = LTH_PO-MENGE.    " Quantity
LTH_ZTEGMMT012-MEINS     = LTH_PO-MEINS.    " Unit
LTH_ZTEGMMT012-EINDT     = LTH_PO-EINDT.    " DeliveryDate

*   Currency
CLEAR LTH_ZTEGZZM002.
READ TABLE I_TD_ZTEGZZM002 INTO LTH_ZTEGZZM002
WITH KEY WAERS = LTH_PO-WAERS
BINARY SEARCH.
IF SY-SUBRC = 0.
LTH_ZTEGMMT012-Z_WAERS_NETPR = LTH_ZTEGZZM002-Z_WAERS.
LTH_ZTEGMMT012-Z_WAERS_NETWR = LTH_ZTEGZZM002-Z_WAERS.
ELSE.
LTH_ZTEGMMT012-Z_WAERS_NETPR = LTH_PO-WAERS.
LTH_ZTEGMMT012-Z_WAERS_NETWR = LTH_PO-WAERS.
ENDIF.

*   Unit price
IF LTH_PO-PEINH IS NOT INITIAL.
LTH_ZTEGMMT012-Z_NETPR = LTH_PO-NETPR / LTH_PO-PEINH.
ELSE.
LTH_ZTEGMMT012-Z_NETPR = LTH_PO-NETPR.
ENDIF.

*   Amount
LTH_ZTEGMMT012-Z_NETWR = LTH_PO-NETWR.

*   CertificateCategory
CLEAR LTH_EINA_T069T.
READ TABLE I_TD_EINA_T069T INTO LTH_EINA_T069T
WITH KEY LIFNR = LTH_PO-LIFNR
MATNR = LTH_PO-MATNR
BINARY SEARCH.
LTH_ZTEGMMT012-URZTX = LTH_EINA_T069T-URZTX.

*   注文書備考(購買発注テキスト)取得
PERFORM CALL_READ_TEXT
USING    LTH_PO-EBELN
LTH_PO-EBELP
**** START ADD 2015/03/11 ISID18 ****
LTH_PO-SPRAS
**** END ADD 2015/03/11 ISID18 ****
CHANGING LTH_ZTEGMMT012-Z_PO_REMARKS.

**** START ADD 2015/02/10 ISID18 ****
*   Final Destination

**** START UPD 2015/08/24 ISID21 ****
IF LTH_LFB1-FDGRV = I_TH_ZTEGZZM999-LOW AND
LTH_ZTEGMMT012-Z_FINAL_DEST_PO IS INITIAL.
CLEAR LTH_VBPA_T005T.
READ TABLE I_TD_VBPA_T005T INTO LTH_VBPA_T005T
WITH KEY VBELN = LTH_PO-VBELN
BINARY SEARCH.
LTH_ZTEGMMT012-Z_FINAL_DEST_PO = LTH_VBPA_T005T-LANDX.
*  *** START ADD 2015/05/25 ISID18 ****
IF LTH_ZTEGMMT012-Z_FINAL_DEST_PO IS INITIAL.
LTH_ZTEGMMT012-Z_FINAL_DEST_PO = LTH_PO-INCO2.
ENDIF.
*  *** END ADD 2015/05/25 ISID18 ****
ENDIF.
**** END UPD 2015/08/24 ISID21 ****

*   TaxRate,TotalAmount取得
PERFORM FRM_TOTAL_AMT_GET
USING    LTH_PO
CHANGING LTH_ZTEGMMT012.
**** END ADD 2015/02/10 ISID18 ****

LTH_ZTEGMMT012-BSART = LTH_PO-BSART.    " OrderType
LTH_ZTEGMMT012-EKORG = LTH_PO-EKORG.    " PurchaseOrg
LTH_ZTEGMMT012-EKGRP = LTH_PO-EKGRP.    " PurchaseGrp
LTH_ZTEGMMT012-BEDAT = LTH_PO-BEDAT.    " OrderDate
LTH_ZTEGMMT012-ERNAM = LTH_PO-ERNAM.    " CreatedBy
LTH_ZTEGMMT012-WERKS = LTH_PO-WERKS.    " Plant
LTH_ZTEGMMT012-LGORT = LTH_PO-LGORT.    " SLoc
LTH_ZTEGMMT012-PSTYP = LTH_PO-PSTYP.    " ItemCategory
LTH_ZTEGMMT012-KNTTP = LTH_PO-KNTTP.    " AcctAssignmentCat
LTH_ZTEGMMT012-IDNLF = LTH_PO-IDNLF.    " VendorItemCode
LTH_ZTEGMMT012-RETPO = LTH_PO-RETPO.    " ReturnsItem
LTH_ZTEGMMT012-XERSY = LTH_PO-XERSY.    " ERS
LTH_ZTEGMMT012-VBELN = LTH_PO-VBELN.    " SalesOrder
LTH_ZTEGMMT012-VBELP = LTH_PO-VBELP.    " SalesOrderItem

*   CustomerPONo
**** START ADD 2015/02/10 ISID18 ****
LTH_ZTEGMMT012-BSTKD = LTH_PO-SUBMI.
IF LTH_ZTEGMMT012-BSTKD IS INITIAL.
**** END ADD 2015/02/10 ISID18 ****
CLEAR LTH_VBKD.
READ TABLE I_TD_VBKD INTO LTH_VBKD
WITH KEY VBELN = LTH_PO-VBELN
POSNR = LTH_PO-VBELP
BINARY SEARCH.
IF SY-SUBRC <> 0.
READ TABLE I_TD_VBKD INTO LTH_VBKD
WITH KEY VBELN = LTH_PO-VBELN
BINARY SEARCH.
ENDIF.
LTH_ZTEGMMT012-BSTKD = LTH_VBKD-BSTKD.
**** START ADD 2015/02/10 ISID18 ****
ENDIF.
LTH_ZTEGMMT012-EVERS = LTH_PO-EVERS.           " ShippingInstruc
**** END ADD 2015/02/10 ISID18 ****
**** START ADD 2014/12/26 ISID11 ****
**** START UPD 2015/02/26 ISID18 ****
*    LTH_ZTEGMMT012-Z_INPUT_USERID = LTH_PO-ERNAM.  "DataInputUser
CLEAR LTH_USR21_ADRP.
READ TABLE I_TD_USR21_ADRP INTO LTH_USR21_ADRP
WITH KEY BNAME = LTH_PO-ERNAM
BINARY SEARCH.
LTH_ZTEGMMT012-Z_INPUT_USERID = LTH_USR21_ADRP-NAME_TEXT.
**** END UPD 2015/02/26 ISID18 ****
**** END ADD 2014/12/26 ISID11 ****
LTH_ZTEGMMT012-Z_OUTPUT_USERID = SY-UNAME.     " User

*   レポートフォーマット設定
CASE LTH_PO-BSART.
WHEN CNS_BSART_NB.
LTH_ZTEGMMT012-Z_REPORT_FORMAT = CNS_REPORT_10.
WHEN CNS_BSART_UB.
LTH_ZTEGMMT012-Z_REPORT_FORMAT = CNS_REPORT_30.
WHEN CNS_BSART_ZB.
LTH_ZTEGMMT012-Z_REPORT_FORMAT = CNS_REPORT_20.
WHEN OTHERS.
ENDCASE.

*   Decimal notation
IF P_XDEZP IS NOT INITIAL.
LTH_ZTEGMMT012-XDEZP = P_XDEZP.
ELSE.
CLEAR LTH_LFA1_T005X.
READ TABLE I_TD_LFA1_T005X INTO LTH_LFA1_T005X
WITH KEY LIFNR = LTH_PO-LIFNR
BINARY SEARCH.
LTH_ZTEGMMT012-XDEZP = LTH_LFA1_T005X-XDEZP.
ENDIF.

**** 2015/12/3 ISID18 INS START ****
*    商品分類のテキストを取得し、LOAに設定する
SELECT
A~BEZEI
UP TO 1 ROWS
INTO LTH_ZTEGMMT012-Z_LOA
FROM TVM3T AS A
INNER JOIN MVKE AS B
ON A~MVGR3 = B~MVGR3
WHERE B~MATNR = LTH_PO-MATNR
AND B~VKORG = LTH_TVKO-VKORG
AND B~VTWEG = '10'
AND A~SPRAS = P_LANGU.
ENDSELECT.

LTH_ZTEGMMT012-Z_SALESID = LTH_PA0001-PERNR.
LTH_ZTEGMMT012-Z_DATAINPUTID = LTH_USR21_ADRP-BNAME.
**** 2015/12/3 ISID18 INS END ****

*   Date format
IF P_DATFM IS INITIAL.
CLEAR LTH_LFA1_T005X.
READ TABLE I_TD_LFA1_T005X INTO LTH_LFA1_T005X
WITH KEY LIFNR = LTH_PO-LIFNR
BINARY SEARCH.
LTH_ZTEGMMT012-DATFM = LTH_LFA1_T005X-DATFM.
ELSE.
LTH_ZTEGMMT012-DATFM = P_DATFM.
ENDIF.
LTH_ZTEGMMT012-Z_CRE_YMD = LW_DATUM.  " 登録年月日
LTH_ZTEGMMT012-Z_CRE_HMS = LW_UZEIT.  " 登録時分秒
APPEND LTH_ZTEGMMT012 TO LTD_ZTEGMMT012.

*   出力ファイル作成
CLEAR LTH_SFILE.
MOVE-CORRESPONDING LTH_ZTEGMMT012 TO LTH_SFILE.
**** 2015/12/3 ISID18 INS END ****
IF LTH_ZTEGMMT012-Z_SALESID IS INITIAL.
CLEAR LTH_SFILE-Z_SALESCOORDINATORID.
ELSE.
LTH_SFILE-Z_SALESCOORDINATORID = LTH_ZTEGMMT012-Z_SALESID.
ENDIF.
LTH_SFILE-Z_DATAINPUTUSERID = LTH_ZTEGMMT012-Z_DATAINPUTID.
**** 2015/12/3 ISID18 INS END ****

**** START ADD 2015/01/21 ISID11 ****
CALL FUNCTION 'CONVERSION_EXIT_ISOLA_OUTPUT'
EXPORTING
INPUT  = P_LANGU
IMPORTING
OUTPUT = LTH_SFILE-Z_REPORT_LANG.
**** END ADD 2015/01/21 ISID11 ****

*   単価小数点6桁処理
PERFORM CONVERT_AMOUNT
USING    LTH_ZTEGMMT012-Z_WAERS_NETPR
LTH_PO-NETPR
CHANGING LW_AMT_C.
IF LTH_PO-PEINH IS NOT INITIAL.
LW_NETPR = LW_AMT_C / LTH_PO-PEINH.
ELSE.
LW_NETPR = LW_AMT_C.
ENDIF.
CLEAR: LW_AMT.
LW_AMT = LW_NETPR.
CALL FUNCTION 'ZEG_ZZ_RIGHTZERO_DETELE'
EXPORTING
IMPORIGINAL  = LW_AMT
IMPORTING
EXPOUTNOZERO = LTH_SFILE-Z_NETPR.
CONDENSE LTH_SFILE-Z_NETPR NO-GAPS.

*   金額変換
PERFORM CONVERT_AMOUNT
USING    LTH_ZTEGMMT012-Z_WAERS_NETWR
LTH_PO-NETWR
CHANGING LTH_SFILE-Z_NETWR.

**** START ADD 2015/02/10 ISID18 ****
*   総金額変換
PERFORM CONVERT_AMOUNT
USING    LTH_ZTEGMMT012-Z_WAERS_NETWR
LTH_ZTEGMMT012-Z_TOTAL_NETWR
CHANGING LTH_SFILE-Z_TOTAL_NETWR.
**** END ADD 2015/02/10 ISID18 ****
APPEND LTH_SFILE TO O_TD_SFILE.
ENDLOOP.

* Refno採番
LTD_SFILE[] = O_TD_SFILE[].
SORT LTD_SFILE
BY BSART
Z_VEND_OT
Z_VEND_DT
Z_SALES_DIV
Z_SALES_CRDNTR
Z_SHIP_TERMS
Z_PAYMENT_TERMS.
CLEAR LTH_SFILE.
LOOP AT LTD_SFILE ASSIGNING <LFS_SFILE>.
IF <LFS_SFILE>-BSART           <> LTH_SFILE-BSART           OR
<LFS_SFILE>-Z_VEND_OT       <> LTH_SFILE-Z_VEND_OT       OR
<LFS_SFILE>-Z_VEND_DT       <> LTH_SFILE-Z_VEND_DT       OR
<LFS_SFILE>-Z_SALES_DIV     <> LTH_SFILE-Z_SALES_DIV     OR
<LFS_SFILE>-Z_SALES_CRDNTR  <> LTH_SFILE-Z_SALES_CRDNTR  OR
<LFS_SFILE>-Z_SHIP_TERMS    <> LTH_SFILE-Z_SHIP_TERMS    OR
<LFS_SFILE>-Z_PAYMENT_TERMS <> LTH_SFILE-Z_PAYMENT_TERMS.
PERFORM GET_LOG_NO
USING    '10'           " 番号範囲
'ZEGMM0001'    " 番号オブジェクト
CHANGING LW_REFNO
LW_ERRFLG
O_TD_MSG.
MOVE-CORRESPONDING <LFS_SFILE> TO LTH_SFILE.
ENDIF.
<LFS_SFILE>-Z_REFNO = LW_REFNO.

*   外部書式変換
PERFORM CONVERT_TO_OUTPUT
CHANGING <LFS_SFILE>.

*   出力ファイルデータ(会社コード)作成
CLEAR LTH_FILE_BUKRS.
MOVE-CORRESPONDING <LFS_SFILE> TO LTH_FILE_BUKRS-INCLUDE.
LW_WERKS = LTH_FILE_BUKRS-INCLUDE-WERKS.
**** START UPD 2015/02/10 ISID18 ****
*    CLEAR LTH_T001K.
*    READ TABLE I_TD_T001K INTO LTH_T001K
*      WITH KEY WERKS = LW_WERKS
*      BINARY SEARCH.
*    LTH_FILE_BUKRS-BUKRS = LTH_T001K-BUKRS.
CLEAR LTH_PO.
READ TABLE LTD_PO INTO LTH_PO
WITH KEY WERKS = LW_WERKS
BINARY SEARCH.
LTH_FILE_BUKRS-BUKRS = LTH_PO-BUKRS.
**** END UPD 2015/02/10 ISID18 ****
APPEND LTH_FILE_BUKRS TO O_TD_FILE_BUKRS.
ENDLOOP.
O_TD_SFILE[] = LTD_SFILE[].

* ソート
SORT O_TD_SFILE
BY BSART
EKORG
WERKS
**** START UPD 2015/03/11 ISID18 ****
*       Z_TEL_OT
Z_VEND_OT
**** END UPD 2015/03/11 ISID18 ****
LGORT
Z_VEND_DT
EBELN
EBELP.
**** START ADD 2015/07/07 ISID18 ****
LOOP AT O_TD_SFILE ASSIGNING <LFS_SFILE>.
PERFORM CONVERT_EBELP
CHANGING <LFS_SFILE>-EBELP.
ENDLOOP.
**** END ADD 2015/07/07 ISID18 ****
SORT O_TD_FILE_BUKRS
BY BUKRS
INCLUDE-BSART
INCLUDE-EKORG
INCLUDE-WERKS
**** START UPD 2015/03/11 ISID18 ****
*       INCLUDE-Z_TEL_OT
INCLUDE-Z_VEND_OT
**** END UPD 2015/03/11 ISID18 ****
INCLUDE-LGORT
INCLUDE-Z_VEND_DT
INCLUDE-EBELN
INCLUDE-EBELP.
**** START ADD 2015/07/07 ISID18 ****
LOOP AT O_TD_FILE_BUKRS ASSIGNING <LFS_SFILE_BUKRS>.
PERFORM CONVERT_EBELP
CHANGING <LFS_SFILE_BUKRS>-INCLUDE-EBELP.
ENDLOOP.
**** END ADD 2015/07/07 ISID18 ****
SORT LTD_ZTEGMMT012
BY Z_OUTPUT_MODE
EBELN
AEDAT
EBELP.

* テーブル更新
LOOP AT LTD_ZTEGMMT012 INTO LTH_ZTEGMMT012.
CLEAR LW_ERRFLG.

*   レコード登録日が変更前
AT END OF AEDAT.
LW_END_FLG = 'X'.
O_RECORD_TOT = O_RECORD_TOT + 1.
ENDAT.

CASE LW_END_FLG.
WHEN 'X'.
*       Outputlog no取得
PERFORM GET_LOG_NO
USING    '01'            " 番号範囲
'ZEGZZ0001'     " 番号オブジェクト
CHANGING LW_LOGNO
LW_ERRFLG
O_TD_MSG.
IF LW_ERRFLG IS NOT INITIAL.
CLEAR LW_END_FLG.
O_RECORD_ERR = O_RECORD_ERR + 1.
CONTINUE.
ENDIF.

*       テーブルにロックをかける
PERFORM LOCK_TABLE
USING    LW_LOGNO
LTH_ZTEGMMT012
CHANGING LW_ERRFLG
O_TD_MSG.
IF LW_ERRFLG IS NOT INITIAL.
CLEAR LW_END_FLG.
O_RECORD_ERR = O_RECORD_ERR + 1.
CONTINUE.
ENDIF.

*       Update Output Log
PERFORM UPDATE_ZTEGZZT001
USING    LW_LOGNO
LTH_ZTEGMMT012
I_TD_FILENAME
**** START UPD 2015/02/10 ISID18 ****
*                   I_TD_T001K
I_TD_PO
**** END UPD 2015/02/10 ISID18 ****
CHANGING LW_ERRFLG
O_TD_MSG.
IF LW_ERRFLG IS NOT INITIAL.
CLEAR LW_END_FLG.
O_RECORD_ERR = O_RECORD_ERR + 1.
*         テーブルロックをリリース
PERFORM RELEASE_TABLE
USING LW_LOGNO
LTH_ZTEGMMT012.
CONTINUE.
ENDIF.

*       Update OutputManagement(PurchaseOrder)(ZTEGMMT011)
PERFORM UPDATE_ZTEGMMT011
USING    LTH_ZTEGMMT012
I_TD_ZTEGMMT011
CHANGING LW_ERRFLG
O_TD_MSG.
IF LW_ERRFLG IS NOT INITIAL.
CLEAR LW_END_FLG.
O_RECORD_ERR = O_RECORD_ERR + 1.
*         テーブルロックをリリース
PERFORM RELEASE_TABLE
USING LW_LOGNO
LTH_ZTEGMMT012.
CONTINUE.
ENDIF.

*       Update OutputWork(PurchaseOrder)(ZTEGMMT012)
PERFORM UPDATE_ZTEGMMT012
USING    LTH_ZTEGMMT012
LTD_ZTEGMMT012
CHANGING LW_ERRFLG
O_TD_MSG.
CLEAR LW_END_FLG.
IF LW_ERRFLG IS NOT INITIAL.
O_RECORD_ERR = O_RECORD_ERR + 1.
ELSE.
O_RECORD_OK = O_RECORD_OK + 1.
COMMIT WORK AND WAIT.

*         メッセージ出力
CLEAR LTH_MSG.
**** START UPD 2015/02/25 ISID18 ****
*          MESSAGE S077 WITH LTH_ZTEGMMT012-EBELN
MESSAGE S081 WITH TEXT-007 LTH_ZTEGMMT012-EBELN
**** END UPD 2015/02/25 ISID18 ****
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-030.
APPEND LTH_MSG TO O_TD_MSG.
ENDIF.
*       テーブルロックをリリース
PERFORM RELEASE_TABLE
USING LW_LOGNO
LTH_ZTEGMMT012.
WHEN OTHERS.
ENDCASE.
ENDLOOP.
**** START DEL 2015/02/25 ISID18 ****
*  IF LW_ERRFLG IS INITIAL.
*    CLEAR LTH_MSG.
*    MESSAGE S013 INTO LTH_MSG-TEXT.
*    LTH_MSG-TYPE = TEXT-030.
*    APPEND LTH_MSG TO O_TD_MSG.
*  ENDIF.
**** END DEL 2015/02/25 ISID18 ****

ENDFORM.                    " EDIT_DATA
************************************************************************
*　      Form  CALL_READ_TEXT
************************************************************************
*       注文書備考(購買発注テキスト)取得
************************************************************************
*      -->I_EBELN  購買伝票
*      -->I_EBELP  購買明細
*      <--O_TEXT   取得テキスト
************************************************************************
FORM CALL_READ_TEXT
USING    I_EBELN TYPE EKPO-EBELN
I_EBELP TYPE EKPO-EBELP
**** START ADD 2015/03/11 ISID18 ****
I_LANGU TYPE EKKO-SPRAS
**** END ADD 2015/03/11 ISID18 ****
CHANGING O_TEXT  TYPE ANY.

DATA: LW_NAME     TYPE THEAD-TDNAME,
LW_MSG(128) TYPE C,
LTH_LINES   TYPE TLINE,
LTD_LINES   TYPE STANDARD TABLE OF TLINE.

CONCATENATE I_EBELN I_EBELP INTO LW_NAME.
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = 'F02'
**** START UPD 2015/03/11 ISID18 ****
*      LANGUAGE                = SY-LANGU
LANGUAGE                = I_LANGU
**** END UPD 2015/03/11 ISID18 ****
NAME                    = LW_NAME
OBJECT                  = 'EKPO'
TABLES
LINES                   = LTD_LINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.
CASE SY-SUBRC.
WHEN 0.
LOOP AT LTD_LINES INTO LTH_LINES.
CONCATENATE O_TEXT LTH_LINES-TDLINE
INTO O_TEXT.
ENDLOOP.
WHEN 4.
WHEN OTHERS.
MESSAGE ID SY-MSGID
TYPE SY-MSGTY
NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO LW_MSG.
*     汎用モジュールにて想定外のエラーが発生しました。
MESSAGE S032
WITH 'READ_TEXT' LW_MSG
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDCASE.

ENDFORM.                    " CALL_READ_TEXT
************************************************************************
*      Form  CONVERT_TO_OUTPUT
************************************************************************
*      外部書式変換
*----------------------------------------------------------------------*
*      <--O_TH_SFILE  ファイルデータ
************************************************************************
FORM CONVERT_TO_OUTPUT
CHANGING O_TH_SFILE TYPE ZSEGMM0001.

DATA LW_CHAR(20) TYPE C.

* PurchaseOrder
LW_CHAR = O_TH_SFILE-EBELN.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-EBELN = LW_CHAR.

* PurchaseOrderItem
**** START DEL 2015/07/07 ISID18 ****
*  LW_CHAR = O_TH_SFILE-EBELP.
*  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*    EXPORTING
*      INPUT  = LW_CHAR
*    IMPORTING
*      OUTPUT = LW_CHAR.
*  O_TH_SFILE-EBELP = LW_CHAR.
**** END DEL 2015/07/07 ISID18 ****

* VendCodeTo
LW_CHAR = O_TH_SFILE-Z_VEND_OT.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-Z_VEND_OT = LW_CHAR.

* VendCodeDeliverTo
LW_CHAR = O_TH_SFILE-Z_VEND_DT.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-Z_VEND_DT = LW_CHAR.

* RefNo
LW_CHAR = O_TH_SFILE-Z_REFNO.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-Z_REFNO = LW_CHAR.

* ItemCode
**** START DEL 2015/02/10 ISID18 ****
*  LW_CHAR = O_TH_SFILE-MATNR.
**** START ADD 2015/05/25 ISID18 ****
LW_CHAR = O_TH_SFILE-Z_MATNR_PO.
CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-Z_MATNR_PO = LW_CHAR.
**** END ADD 2015/05/25 ISID18 ****
*  O_TH_SFILE-MATNR = LW_CHAR.
**** END DEL 2015/02/10 ISID18 ****

* Quantity
LW_CHAR = O_TH_SFILE-MENGE.
WRITE LW_CHAR TO LW_CHAR UNIT O_TH_SFILE-MEINS.
O_TH_SFILE-MENGE = LW_CHAR.

* Unit
LW_CHAR = O_TH_SFILE-MEINS.
CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
EXPORTING
INPUT          = LW_CHAR
LANGUAGE       = SY-LANGU
IMPORTING
OUTPUT         = LW_CHAR
EXCEPTIONS
UNIT_NOT_FOUND = 1
OTHERS         = 2.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE 'S' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ELSE.
O_TH_SFILE-MEINS = LW_CHAR.
ENDIF.

* SalesOrder
LW_CHAR = O_TH_SFILE-VBELN.
CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-VBELN = LW_CHAR.

* SalesOrderItem
LW_CHAR = O_TH_SFILE-VBELP.
CALL FUNCTION 'CONVERSION_EXIT_MATN1_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_TH_SFILE-VBELP = LW_CHAR.

ENDFORM.                    " CONVERT_TO_OUTPUT
************************************************************************
*      Form  LOCK_TABLE
************************************************************************
*      テーブルにロックをかける
************************************************************************
*      -->I_LOGNO             出力ログ
*      -->I_TH_SFILE          購買発注伝票データ
*      <--O_ERRFLG            エラーフラグ
*      <--O_TD_MSG            メッセージ
************************************************************************
FORM LOCK_TABLE
USING    I_LOGNO    TYPE ZEOUTPUTLOGNO
I_TH_SFILE TYPE ZTEGMMT012
CHANGING O_ERRFLG   TYPE CHAR01
O_TD_MSG   TYPE TYP_TD_MSG.

DATA LTH_MSG  TYPE TYP_TH_MSG.

* ZTEGZZT001テーブルをロック
CALL FUNCTION 'ENQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = I_LOGNO
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.
CLEAR LTH_MSG.
**** START UPD 2015/02/10 ISID18 ****
*    MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
*   対象の伝票は、別のユーザが編集中です。（USER = &1）&2 &3
MESSAGE E082 WITH SY-MSGV1 TEXT-007 I_TH_SFILE-EBELN
**** END UPD 2015/02/10 ISID18 ****
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.
RETURN.
ENDIF.

* ZTEGMMT011テーブルをロック
CALL FUNCTION 'ENQUEUE_EZZTEGMMT011'
EXPORTING
MODE_ZTEGMMT011 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = I_TH_SFILE-Z_OUTPUT_MODE
EBELN           = I_TH_SFILE-EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.
CLEAR LTH_MSG.
**** START UPD 2015/02/10 ISID18 ****
*    MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
*   対象の伝票は、別のユーザが編集中です。（USER = &1）&2 &3
MESSAGE E082 WITH SY-MSGV1 TEXT-007 I_TH_SFILE-EBELN
**** END UPD 2015/02/10 ISID18 ****
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.

*   テーブルZTEGZZT001をリリース
CALL FUNCTION 'DEQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = I_LOGNO.
RETURN.
ENDIF.

* ZTEGMMT012テーブルをロック
CALL FUNCTION 'ENQUEUE_EZZTEGMMT012'
EXPORTING
MODE_ZTEGMMT012 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = I_TH_SFILE-Z_OUTPUT_MODE
EBELN           = I_TH_SFILE-EBELN
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.
IF SY-SUBRC <> 0.
CLEAR LTH_MSG.
**** START UPD 2015/02/10 ISID18 ****
*    MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
*       WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
*   対象の伝票は、別のユーザが編集中です。（USER = &1）&2 &3
MESSAGE E082 WITH SY-MSGV1 TEXT-007 I_TH_SFILE-EBELN
**** END UPD 2015/02/10 ISID18 ****
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.

*   テーブルZTEGZZT001をリリース
CALL FUNCTION 'DEQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = I_LOGNO.

*   テーブルZTEGMMT011をリリース
CALL FUNCTION 'DEQUEUE_EZZTEGMMT011'
EXPORTING
MODE_ZTEGMMT011 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = I_TH_SFILE-Z_OUTPUT_MODE
EBELN           = I_TH_SFILE-EBELN.
ENDIF.

ENDFORM.                    " LOCK_TABLE
************************************************************************
*      Form  RELEASE_TABLE
************************************************************************
*      テーブルロックをリリース
************************************************************************
*      -->I_LOGNO             出力ログ
*      -->I_TH_SFILE          購買発注伝票データ
************************************************************************
FORM RELEASE_TABLE
USING I_LOGNO    TYPE ZEOUTPUTLOGNO
I_TH_SFILE TYPE ZTEGMMT012.

* ZTEGZZT001をリリース
CALL FUNCTION 'DEQUEUE_EZZTEGZZT001'
EXPORTING
MODE_ZTEGZZT001 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_LOG_NO = I_LOGNO.

* ZTEGMMT011をリリース
CALL FUNCTION 'DEQUEUE_EZZTEGMMT011'
EXPORTING
MODE_ZTEGMMT011 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = I_TH_SFILE-Z_OUTPUT_MODE
EBELN           = I_TH_SFILE-EBELN.

* ZTEGMMT012をリリース
CALL FUNCTION 'DEQUEUE_EZZTEGMMT012'
EXPORTING
MODE_ZTEGMMT012 = CNS_LOCK_MODE
MANDT           = SY-MANDT
Z_OUTPUT_MODE   = I_TH_SFILE-Z_OUTPUT_MODE
EBELN           = I_TH_SFILE-EBELN.

ENDFORM.                    " RELEASE_TABLE
************************************************************************
*      Form  UPDATE_ZTEGZZT001
************************************************************************
*       Update Output Log
************************************************************************
*      -->I_LOGNO             出力ログ
*      -->I_TH_SFILE          購買発注伝票データ
*      -->I_TD_FILENAME       ファイル名
*      -->I_TD_FILE_BUKRS     出力データ(会社コード付け)
*      <--O_ERRFLG            エラーフラグ
*      <--O_TD_MSG            メッセージ
************************************************************************
FORM UPDATE_ZTEGZZT001
USING    I_LOGNO       TYPE ZEOUTPUTLOGNO
I_TH_SFILE    TYPE ZTEGMMT012
I_TD_FILENAME TYPE TYP_TD_FILENAME
**** START UPD 2015/02/10 ISID18 ****
*           I_TD_T001K    TYPE TYP_TD_T001K
I_TD_PO       TYPE TYP_TD_PO
**** END UPD 2015/02/10 ISID18 ****
CHANGING O_ERRFLG      TYPE CHAR01
O_TD_MSG      TYPE TYP_TD_MSG.

DATA: LTH_INSERT TYPE ZTEGZZT001,
LTH_MSG    TYPE TYP_TH_MSG,
**** START UPD 2015/02/10 ISID18 ****
*        LTH_T001K  TYPE TYP_TH_T001K,
LTH_T001K  TYPE TYP_TH_PO,
LTD_PO     TYPE TYP_TD_PO,
**** END UPD 2015/02/10 ISID18 ****
LTH_FILE   TYPE TYP_TH_FILENAME.

**** START ADD 2015/02/10 ISID18 ****
LTD_PO[] = I_TD_PO[].
SORT LTD_PO BY WERKS BUKRS.
**** END ADD 2015/02/10 ISID18 ****

LTH_INSERT-MANDT = SY-MANDT.                  " Client
LTH_INSERT-Z_OUTPUT_LOG_NO = I_LOGNO.         " 出力ログID
LTH_INSERT-PROGNAME = SY-REPID.               " ABAP プログラム名
LTH_INSERT-Z_REPORT_NAME = TEXT-007.          " 帳票名
LTH_INSERT-Z_OUTPUT_MODE
= I_TH_SFILE-Z_OUTPUT_MODE." 出力モード
LTH_INSERT-LNAME = P_TRAY.                    " スプール: デバイス名
CASE 'X'.
*   選択画面「Print」「Reprint」が選択されている場合
WHEN RB_PRINT
OR RB_REPNT.
CLEAR LTH_T001K.
**** START UPD 2015/02/10 ISID18 ****
*      READ TABLE I_TD_T001K INTO LTH_T001K
*        WITH KEY WERKS = I_TH_SFILE-WERKS
*        BINARY SEARCH.
READ TABLE LTD_PO INTO LTH_T001K
WITH KEY WERKS = I_TH_SFILE-WERKS
BINARY SEARCH.
**** END UPD 2015/02/10 ISID18 ****
CLEAR LTH_FILE.
READ TABLE I_TD_FILENAME INTO LTH_FILE
WITH KEY BUKRS = LTH_T001K-BUKRS
BINARY SEARCH.
LTH_INSERT-Z_OUTPUT_PATH = LTH_FILE-FILENAME. " 出力ファイルパス
LTH_INSERT-Z_OUTPUT_CP = LTH_FILE-CODEPAGE.   " コードページ
*   選択画面「Download」が選択されている場合
WHEN RB_DOWNL.
CLEAR LTH_FILE.
READ TABLE I_TD_FILENAME INTO LTH_FILE INDEX 1.
LTH_INSERT-Z_OUTPUT_PATH = LTH_FILE-FILENAME. " 出力ファイルパス
LTH_INSERT-Z_OUTPUT_CP = LTH_FILE-CODEPAGE.   " コードページ
WHEN OTHERS.
ENDCASE.
LTH_INSERT-Z_KEY1_TYPE = 'EKORG'.
LTH_INSERT-Z_KEY1_VALUE = I_TH_SFILE-EKORG.     " PurchaseOrg
LTH_INSERT-Z_KEY2_TYPE = 'EKGRP'.
LTH_INSERT-Z_KEY2_VALUE = I_TH_SFILE-EKGRP.     " PurchaseGrp
LTH_INSERT-Z_KEY3_TYPE = 'LIFNR'.
* VendCodeTo
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = I_TH_SFILE-Z_VEND_OT
IMPORTING
OUTPUT = LTH_INSERT-Z_KEY3_VALUE.
LTH_INSERT-Z_KEY4_TYPE = 'EBELN'.
* PurchaseOrder
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = I_TH_SFILE-EBELN
IMPORTING
OUTPUT = LTH_INSERT-Z_KEY4_VALUE.
LTH_INSERT-Z_CRE_YMD = I_TH_SFILE-Z_CRE_YMD.    " Created date
LTH_INSERT-Z_CRE_HMS = I_TH_SFILE-Z_CRE_HMS.    " Created time
LTH_INSERT-Z_CRE_USERID = SY-UNAME.             " User

* 登録
INSERT INTO ZTEGZZT001 VALUES LTH_INSERT.
IF SY-SUBRC <> 0.
CLEAR LTH_MSG.
MESSAGE E012 WITH 'ZTEGZZT001'
I_TH_SFILE-EBELN
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.
ROLLBACK WORK.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGZZT001
************************************************************************
*      Form  UPDATE_ZTEGMMT011
************************************************************************
*      OutputManagement(PurchaseOrder)(ZTEGMMT011)
************************************************************************
*      -->I_TH_SFILE           購買発注伝票データ
*      -->I_TD_ZTEGMMT011      OutputManagement
*      <--O_ERRFLG            エラーフラグ
*      <--O_TD_MSG            メッセージ
************************************************************************
FORM UPDATE_ZTEGMMT011
USING    I_TH_SFILE      TYPE ZTEGMMT012
I_TD_ZTEGMMT011 TYPE TYP_TD_ZTEGMMT011
CHANGING O_ERRFLG        TYPE CHAR01
O_TD_MSG        TYPE TYP_TD_MSG.

DATA:
LTH_INSERT TYPE ZTEGMMT011,
LTH_MSG  TYPE TYP_TH_MSG.

LTH_INSERT-MANDT = SY-MANDT.                      " Client
LTH_INSERT-Z_OUTPUT_MODE
= I_TH_SFILE-Z_OUTPUT_MODE.      " 出力モード
LTH_INSERT-EBELN = I_TH_SFILE-EBELN.              " 購買伝票番号
LTH_INSERT-AEDAT = I_TH_SFILE-AEDAT.              " レコード登録日
LTH_INSERT-Z_CRE_YMD = I_TH_SFILE-Z_CRE_YMD.      " Created date
LTH_INSERT-Z_CRE_HMS = I_TH_SFILE-Z_CRE_HMS.      " Created time
LTH_INSERT-Z_CRE_USERID = SY-UNAME.               " User

* 登録
READ TABLE I_TD_ZTEGMMT011 TRANSPORTING NO FIELDS
WITH KEY Z_OUTPUT_MODE = I_TH_SFILE-Z_OUTPUT_MODE
EBELN         = I_TH_SFILE-EBELN
BINARY SEARCH.
IF SY-SUBRC <> 0.
INSERT INTO ZTEGMMT011 VALUES LTH_INSERT.
IF SY-SUBRC <> 0.
MESSAGE E012 WITH 'ZTEGMMT011'
LTH_INSERT-EBELN
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.
ROLLBACK WORK.
ENDIF.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGMMT011
************************************************************************
*     Form  UPDATE_ZTEGMMT012
************************************************************************
*     OutputWork(PurchaseOrder)(ZTEGMMT0102)
************************************************************************
*      -->I_TH_SFILE           購買発注伝票データ
*      -->I_TD_SFILE           出力データ
*      <--O_ERRFLG            エラーフラグ
*      <--O_TD_MSG            メッセージ
************************************************************************
FORM UPDATE_ZTEGMMT012
USING    I_TH_SFILE TYPE ZTEGMMT012
I_TD_SFILE TYPE TYP_TD_ZTEGMMT012
CHANGING O_ERRFLG   TYPE CHAR01
O_TD_MSG   TYPE TYP_TD_MSG.

DATA:
LTH_INSERT   TYPE ZTEGMMT012,
LTD_INSERT   TYPE TYP_TD_ZTEGMMT012,
LTH_MSG      TYPE TYP_TH_MSG.

* Delete data
DELETE FROM ZTEGMMT012
WHERE Z_OUTPUT_MODE  = I_TH_SFILE-Z_OUTPUT_MODE
AND EBELN          = I_TH_SFILE-EBELN.
IF SY-SUBRC <> 0 AND
SY-SUBRC <> 4.
CLEAR LTH_MSG.
MESSAGE E033 WITH 'ZTEGMMT012'
I_TH_SFILE-EBELN
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.
ROLLBACK WORK.
RETURN.
ENDIF.

LOOP AT I_TD_SFILE INTO LTH_INSERT
WHERE Z_OUTPUT_MODE = I_TH_SFILE-Z_OUTPUT_MODE
AND EBELN = I_TH_SFILE-EBELN.
LTH_INSERT-MANDT = SY-MANDT.                   " Client
LTH_INSERT-Z_CRE_USERID = SY-UNAME.            " User
APPEND LTH_INSERT TO LTD_INSERT.
ENDLOOP.

* insert
INSERT ZTEGMMT012 FROM TABLE LTD_INSERT
ACCEPTING DUPLICATE KEYS.
IF SY-SUBRC <> 0.
CLEAR LTH_MSG.
MESSAGE E012 WITH 'ZTEGMMT012'
I_TH_SFILE-EBELN
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.
ROLLBACK WORK.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGMMT012
************************************************************************
*      Form  OUTPUT_DATA
************************************************************************
*      ファイル出力
************************************************************************
*      -->I_TD_FILE_BUKRS       出力ファイルデータ(会社コード付け)
*      -->I_TD_FILENAME         ファイル名
*      <--O_TD_SFILE            出力ファイル
*      <--O_TD_MSG              メッセージ
************************************************************************
FORM OUTPUT_DATA
USING    I_TD_FILE_BUKRS TYPE TYP_TD_FILE
I_TD_FILENAME   TYPE TYP_TD_FILENAME
CHANGING O_TD_SFILE      TYPE TYP_TD_ZSEGMM0001
O_TD_MSG        TYPE TYP_TD_MSG.

DATA:
LW_ERRFLG(1)   TYPE C,
LW_SFILE       TYPE STRING,
LW_OUTPUT_CP   TYPE STRING,
LW_CODEPAGE    TYPE ABAP_ENCODING,
LW_CDUTF8      TYPE ABAP_ENCODING,
LW_SEPARATOR   TYPE CHAR01,
LTH_FILENAME   TYPE TYP_TH_FILENAME,
LTH_MSG        TYPE TYP_TH_MSG,
LTH_SFILE      TYPE ZSEGMM0001,
LTH_FILE_BUKRS TYPE TYP_TH_FILE.

CASE 'X'.
*   選択画面「Print」「Reprint」が選択されている場合
WHEN RB_PRINT
OR RB_REPNT.
LW_CDUTF8 = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( 'UTF-8' ).
LOOP AT I_TD_FILENAME INTO LTH_FILENAME.
*       ファイル名、コードページ取得
CLEAR LW_OUTPUT_CP.
LW_OUTPUT_CP = LTH_FILENAME-CODEPAGE.
LW_CODEPAGE  = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( LW_OUTPUT_CP ).
IF LW_CODEPAGE = LW_CDUTF8.
OPEN DATASET LTH_FILENAME-FILENAME FOR OUTPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ELSE.
TRY.
OPEN DATASET LTH_FILENAME-FILENAME FOR OUTPUT
IN LEGACY TEXT MODE
CODE PAGE LW_CODEPAGE
IGNORING CONVERSION ERRORS.
CATCH CX_SY_CODEPAGE_CONVERTER_INIT.
LW_ERRFLG = 'X'.
ENDTRY.
ENDIF.
*       ファイルオープンエラー
**** START UPD 2015/02/25 ISID18 ****
*        IF SY-SUBRC <> 0.
*          CLEAR LTH_MSG.
*          MESSAGE E035 WITH LTH_FILENAME-FILENAME
*             INTO LTH_MSG-TEXT.
*          LTH_MSG-TYPE = TEXT-011.
*          APPEND LTH_MSG TO O_TD_MSG.
*          LW_ERRFLG = 'X'.
IF SY-SUBRC <> 0 OR
LW_ERRFLG IS NOT INITIAL.
IF LW_ERRFLG IS NOT INITIAL.
MESSAGE S078 DISPLAY LIKE 'E'.
ELSE.
MESSAGE S035 WITH LTH_FILENAME-FILENAME
DISPLAY LIKE 'E'.
ENDIF.
**** END UPD 2015/02/25 ISID18 ****
ELSE.
LOOP AT I_TD_FILE_BUKRS INTO LTH_FILE_BUKRS
WHERE BUKRS = LTH_FILENAME-BUKRS.
CLEAR LTH_SFILE.
MOVE-CORRESPONDING LTH_FILE_BUKRS-INCLUDE TO LTH_SFILE.
CONCATENATE LTH_SFILE-LNAME            " Printer/tray
LTH_SFILE-Z_COMP_NAME      " CompanyName
LTH_SFILE-Z_COMP_ADDRESS1  " CompanyAddress1
LTH_SFILE-Z_COMP_ADDRESS2  " CompanyAddress2
LTH_SFILE-Z_COMP_TEL       " CompanyTel
LTH_SFILE-Z_COMP_FAX       " CompanyAFax
LTH_SFILE-Z_PO_DATE        " PODate
LTH_SFILE-Z_SALES_DIV      " SalesDivision
LTH_SFILE-Z_SALES_CRDNTR   " SalesCoordinator
LTH_SFILE-Z_VEND_OT        " VendCodeTo
LTH_SFILE-Z_VEND_NAME_OT   " VendNameTo
LTH_SFILE-Z_ADDRESS1_OT    " VendAddress1To
LTH_SFILE-Z_ADDRESS2_OT    " VendAddress2To
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ADDRESS3_OT    " VendAddress3To
LTH_SFILE-Z_ADDRESS4_OT    " VendAddress4To
**** END ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ATTN_OT        " VendAttnTo
LTH_SFILE-Z_TEL_OT         " VendTelTo
LTH_SFILE-Z_FAX_OT         " VendFaxTo
LTH_SFILE-Z_VEND_DT        " VendCodeDeliverTo
LTH_SFILE-Z_VEND_NAME_DT   " VendNameDeliverTo
LTH_SFILE-Z_ADDRESS1_DT    " VendAddress1D
LTH_SFILE-Z_ADDRESS2_DT    " VendAddress2D
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ADDRESS3_DT    " VendAddress3D
LTH_SFILE-Z_ADDRESS4_DT    " VendAddress4D
**** END ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ATTN_DT        " VendAttnDeliverTo
LTH_SFILE-Z_TEL_DT         " VendTelDeliverTo
LTH_SFILE-Z_FAX_DT         " VendFaxDeliverTo
LTH_SFILE-Z_SHIP_TERMS     " ShippingTerms
LTH_SFILE-Z_PAYMENT_TERMS  " PaymentTerms
LTH_SFILE-Z_REFNO          " RefNo
**** START UPD 2015/02/10 ISID18 ****
*                        LTH_SFILE-MATNR            " ItemCode
LTH_SFILE-Z_MATNR_PO       " ItemCode
**** END UPD 2015/02/10 ISID18 ****
LTH_SFILE-EBELN            " PurchaseOrder
LTH_SFILE-EBELP            " PurchaseOrderItem
LTH_SFILE-MAKTX            " ItemText
LTH_SFILE-Z_PURPOSE        " Purpose
LTH_SFILE-Z_ENDUSER        " EndUser
LTH_SFILE-MENGE            " Quantity
LTH_SFILE-MEINS            " Unit
LTH_SFILE-EINDT            " DeliveryDate
LTH_SFILE-Z_NETPR          " UnitPrice
LTH_SFILE-Z_WAERS_NETPR    " CurrencyUnitPrice
LTH_SFILE-Z_NETWR          " Amount
LTH_SFILE-Z_WAERS_NETWR    " CurrencyAmount
LTH_SFILE-URZTX            " CertificateCategory
LTH_SFILE-Z_PO_REMARKS     " Remarks
**** START ADD 2015/02/10 ISID18 ****
LTH_SFILE-Z_FINAL_DEST_PO  " FinalDestination
LTH_SFILE-Z_TAX_RATE       " TaxRate
LTH_SFILE-Z_TOTAL_NETWR    " TotalAmount
**** END ADD 2015/02/10 ISID18 ****
LTH_SFILE-BSART            " OrderType
LTH_SFILE-EKORG            " PurchaseOrg
LTH_SFILE-EKGRP            " PurchaseGrp
LTH_SFILE-BEDAT            " OrderDate
LTH_SFILE-AEDAT            " CreatedOn
LTH_SFILE-ERNAM            " CreatedBy
LTH_SFILE-WERKS            " Plant
LTH_SFILE-LGORT            " SLoc
LTH_SFILE-PSTYP            " ItemCategory
LTH_SFILE-KNTTP            " AcctAssignmentCat
LTH_SFILE-IDNLF            " VendorItemCode
LTH_SFILE-RETPO            " ReturnsItem
LTH_SFILE-XERSY            " ERS
LTH_SFILE-VBELN            " SalesOrder
LTH_SFILE-VBELP            " SalesOrderItem
LTH_SFILE-BSTKD            " CustomerPONo
**** START ADD 2015/02/10 ISID18 ****
LTH_SFILE-EVERS            " ShippingInstruct
**** END ADD 2015/02/10 ISID18 ****
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_INPUT_USERID   "DataInputUser
**** END ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_OUTPUT_USERID  " User
LTH_SFILE-XDEZP            " Decimal notation
LTH_SFILE-DATFM            " Date format
LTH_SFILE-Z_REPORT_FORMAT  " Report format
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_REPORT_LANG    " 帳票言語
LTH_SFILE-Z_REPORT_TITLE   " 帳票タイトル
**** END ADD 2014/12/26 ISID11 ****
**** 2015/12/3 ISID18 INS START ****
LTH_SFILE-Z_LOA                              "LOA
LTH_SFILE-Z_SALESCOORDINATORID "SalesCoordinatorID
LTH_SFILE-Z_DATAINPUTUSERID        "DataInputUserID
**** 2015/12/3 ISID18 INS END ****
INTO LW_SFILE
SEPARATED BY
CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
TRANSFER LW_SFILE TO LTH_FILENAME-FILENAME.
ENDLOOP.
CLOSE DATASET LTH_FILENAME-FILENAME.
ENDIF.
ENDLOOP.
*     ダウンロードが成功した場合
IF LW_ERRFLG IS INITIAL.
**** START UPD 2015/02/25 ISID18 ****
*        CLEAR LTH_MSG.
*        MESSAGE S037 INTO LTH_MSG-TEXT.
*        LTH_MSG-TYPE = TEXT-030.
*        APPEND LTH_MSG TO O_TD_MSG.
MESSAGE S037.
**** END UPD 2015/02/25 ISID18 ****
ENDIF.

*   選択画面「Download」が選択されている場合
WHEN RB_DOWNL.
*     ヘッダテキスト行セット
PERFORM SET_HEADER_LINE CHANGING O_TD_SFILE.
*     ファイル名、コードページ取得
CLEAR LTH_FILENAME.
READ TABLE I_TD_FILENAME INTO LTH_FILENAME INDEX 1.
LW_OUTPUT_CP = LTH_FILENAME-CODEPAGE.
LW_CODEPAGE  = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( LW_OUTPUT_CP ).
LW_SEPARATOR = CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
*     ダウンロード
CALL FUNCTION 'GUI_DOWNLOAD'
EXPORTING
FILENAME                = LTH_FILENAME-FILENAME
FILETYPE                = 'ASC'
WRITE_FIELD_SEPARATOR   = LW_SEPARATOR
CODEPAGE                = LW_CODEPAGE
TABLES
DATA_TAB                = O_TD_SFILE
EXCEPTIONS
FILE_WRITE_ERROR        = 1
NO_BATCH                = 2
GUI_REFUSE_FILETRANSFER = 3
INVALID_TYPE            = 4
NO_AUTHORITY            = 5
UNKNOWN_ERROR           = 6
HEADER_NOT_ALLOWED      = 7
SEPARATOR_NOT_ALLOWED   = 8
FILESIZE_NOT_ALLOWED    = 9
HEADER_TOO_LONG         = 10
DP_ERROR_CREATE         = 11
DP_ERROR_SEND           = 12
DP_ERROR_WRITE          = 13
UNKNOWN_DP_ERROR        = 14
ACCESS_DENIED           = 15
DP_OUT_OF_MEMORY        = 16
DISK_FULL               = 17
DP_TIMEOUT              = 18
FILE_NOT_FOUND          = 19
DATAPROVIDER_EXCEPTION  = 20
CONTROL_FLUSH_ERROR     = 21
OTHERS                  = 22.
*     ダウンロードが失敗した場合
IF SY-SUBRC <> 0.
**** START UPD 2015/02/25 ISID18 ****
*        CLEAR LTH_MSG.
*        MESSAGE E036 INTO LTH_MSG-TEXT.
*        LTH_MSG-TYPE = TEXT-011.
*        APPEND LTH_MSG TO O_TD_MSG.
MESSAGE S036 DISPLAY LIKE 'E'.
**** END UPD 2015/02/25 ISID18 ****

*     ダウンロードが成功した場合
ELSE.
**** START UPD 2015/02/25 ISID18 ****
*        CLEAR LTH_MSG.
*        MESSAGE S037 INTO LTH_MSG-TEXT.
*        LTH_MSG-TYPE = TEXT-030.
*        APPEND LTH_MSG TO O_TD_MSG.
MESSAGE S037.
**** END UPD 2015/02/25 ISID18 ****
ENDIF.
WHEN OTHERS.
ENDCASE.

ENDFORM.                    " OUTPUT_DATA
************************************************************************
*      Form  GET_LOG_NO
************************************************************************
*      出力ログ番号取得
************************************************************************
*      -->I_NR      番号範囲
*      -->I_OBJECT  番号オブジェクト
*      <--O_LOGNO   ログ番号
*      <--O_ERRFLG  エラーフラグ
*      <--O_TD_MSG    メッセージ
************************************************************************
FORM GET_LOG_NO
USING    I_NR     TYPE INRI-NRRANGENR
I_OBJECT TYPE INRI-OBJECT
CHANGING O_LOGNO  TYPE ZEOUTPUTLOGNO
O_ERRFLG TYPE CHAR01
O_TD_MSG   TYPE TYP_TD_MSG.

DATA LTH_MSG TYPE TYP_TH_MSG.

CLEAR: O_LOGNO,
O_ERRFLG.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = I_NR
OBJECT                  = I_OBJECT
QUANTITY                = '1'
SUBOBJECT               = SPACE
TOYEAR                  = '0000'
IGNORE_BUFFER           = SPACE
IMPORTING
NUMBER                  = O_LOGNO
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 4
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
BUFFER_OVERFLOW         = 7
OTHERS                  = 8.
IF SY-SUBRC <> 0.
CLEAR LTH_MSG.
MESSAGE ID SY-MSGID TYPE 'E' NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO LTH_MSG-TEXT.
LTH_MSG-TYPE = TEXT-011.
APPEND LTH_MSG TO O_TD_MSG.
O_ERRFLG = 'X'.
ENDIF.

ENDFORM.                    " GET_LOG_NO
************************************************************************
*      Form  SET_HEADER_LINE
************************************************************************
*      ヘッダテキスト行セット
************************************************************************
*      <--O_TD_SFILE   出力ファイル
************************************************************************
FORM SET_HEADER_LINE
CHANGING O_TD_SFILE TYPE TYP_TD_ZSEGMM0001.

DATA: LW_STR TYPE STRING,
LTH_SFILE TYPE ZSEGMM0001.

* 構造項目内容説明取得
CALL FUNCTION 'ZEG_ZZ_DD04T_GET'
EXPORTING
IMPTSNAME    = 'ZSEGMM0001'
IMPLANGU     = SY-LANGU
IMPORTING
EXPSCRTEXT_L = LW_STR.

CLEAR LTH_SFILE.
SPLIT LW_STR AT CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB
INTO LTH_SFILE-LNAME            " Printer/tray
LTH_SFILE-Z_COMP_NAME      " CompanyName
LTH_SFILE-Z_COMP_ADDRESS1  " CompanyAddress1
LTH_SFILE-Z_COMP_ADDRESS2  " CompanyAddress2
LTH_SFILE-Z_COMP_TEL       " CompanyTel
LTH_SFILE-Z_COMP_FAX       " CompanyAFax
LTH_SFILE-Z_PO_DATE        " PODate
LTH_SFILE-Z_SALES_DIV      " SalesDivision
LTH_SFILE-Z_SALES_CRDNTR   " SalesCoordinator
LTH_SFILE-Z_VEND_OT        " VendCodeTo
LTH_SFILE-Z_VEND_NAME_OT   " VendNameTo
LTH_SFILE-Z_ADDRESS1_OT    " VendAddress1To
LTH_SFILE-Z_ADDRESS2_OT    " VendAddress2To
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ADDRESS3_OT    " VendAddress3To
LTH_SFILE-Z_ADDRESS4_OT    " VendAddress4To
**** END ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ATTN_OT        " VendAttnTo
LTH_SFILE-Z_TEL_OT         " VendTelTo
LTH_SFILE-Z_FAX_OT         " VendFaxTo
LTH_SFILE-Z_VEND_DT        " VendCodeDeliverTo
LTH_SFILE-Z_VEND_NAME_DT   " VendNameDeliverTo
LTH_SFILE-Z_ADDRESS1_DT    " VendAddress1DeliverTo
LTH_SFILE-Z_ADDRESS2_DT    " VendAddress2DeliverTo
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ADDRESS3_DT    " VendAddress3DeliverTo
LTH_SFILE-Z_ADDRESS4_DT    " VendAddress4DeliverTo
**** END ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_ATTN_DT        " VendAttnDeliverTo
LTH_SFILE-Z_TEL_DT         " VendTelDeliverTo
LTH_SFILE-Z_FAX_DT         " VendFaxDeliverTo
LTH_SFILE-Z_SHIP_TERMS     " ShippingTerms
LTH_SFILE-Z_PAYMENT_TERMS  " PaymentTerms
LTH_SFILE-Z_REFNO          " RefNo
**** START UPD 2015/02/10 ISID18 ****
*         LTH_SFILE-MATNR            " ItemCode
LTH_SFILE-Z_MATNR_PO       " ItemCode
**** END UPD 2015/02/10 ISID18 ****
LTH_SFILE-EBELN            " PurchaseOrder
LTH_SFILE-EBELP            " PurchaseOrderItem
LTH_SFILE-MAKTX            " ItemText
LTH_SFILE-Z_PURPOSE        " Purpose
LTH_SFILE-Z_ENDUSER        " EndUser
LTH_SFILE-MENGE            " Quantity
LTH_SFILE-MEINS            " Unit
LTH_SFILE-EINDT            " DeliveryDate
LTH_SFILE-Z_NETPR          " UnitPrice
LTH_SFILE-Z_WAERS_NETPR    " CurrencyUnitPrice
LTH_SFILE-Z_NETWR          " Amount
LTH_SFILE-Z_WAERS_NETWR    " CurrencyAmount
LTH_SFILE-URZTX            " CertificateCategory
LTH_SFILE-Z_PO_REMARKS     " Remarks
**** START ADD 2015/02/10 ISID18 ****
LTH_SFILE-Z_FINAL_DEST_PO  " FinalDestination
LTH_SFILE-Z_TAX_RATE       " TaxRate
LTH_SFILE-Z_TOTAL_NETWR    " TotalAmount
**** END ADD 2015/02/10 ISID18 ****
LTH_SFILE-BSART            " OrderType
LTH_SFILE-EKORG            " PurchaseOrg
LTH_SFILE-EKGRP            " PurchaseGrp
LTH_SFILE-BEDAT            " OrderDate
LTH_SFILE-AEDAT            " CreatedOn
LTH_SFILE-ERNAM            " CreatedBy
LTH_SFILE-WERKS            " Plant
LTH_SFILE-LGORT            " SLoc
LTH_SFILE-PSTYP            " ItemCategory
LTH_SFILE-KNTTP            " AcctAssignmentCat
LTH_SFILE-IDNLF            " VendorItemCode
LTH_SFILE-RETPO            " ReturnsItem
LTH_SFILE-XERSY            " ERS
LTH_SFILE-VBELN            " SalesOrder
LTH_SFILE-VBELP            " SalesOrderItem
LTH_SFILE-BSTKD            " CustomerPONo
**** START ADD 2015/02/10 ISID18 ****
LTH_SFILE-EVERS            " ShippingInstruction
**** END ADD 2015/02/10 ISID18 ****
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_INPUT_USERID   "DataInputUser
**** END ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_OUTPUT_USERID  " User
LTH_SFILE-XDEZP            " Decimal notation
LTH_SFILE-DATFM            " Date format
LTH_SFILE-Z_REPORT_FORMAT  " Report format
**** START ADD 2014/12/26 ISID11 ****
LTH_SFILE-Z_REPORT_LANG    " 帳票言語
LTH_SFILE-Z_REPORT_TITLE  " 帳票タイトル
**** END ADD 2014/12/26 ISID11 ****
**** 2015/12/3 ISID18 INS START ****
LTH_SFILE-Z_LOA                              "LOA
LTH_SFILE-Z_SALESCOORDINATORID "SalesCoordinatorID
LTH_SFILE-Z_DATAINPUTUSERID.        "DataInputUserID
**** 2015/12/3 ISID18 INS END ****
INSERT LTH_SFILE INTO O_TD_SFILE INDEX 1.

ENDFORM.                    " SET_HEADER_LINE
************************************************************************
*      Form  CONVERT_AMOUNT
************************************************************************
*      Covert amount to display
************************************************************************
*      -->I_WAERS     Currency
*      -->I_IN_AMT   Internal amount
*      <--O_OUT_AMT  External amount
************************************************************************
FORM CONVERT_AMOUNT
USING    I_WAERS   TYPE WAERS
I_IN_AMT  TYPE ANY
CHANGING O_OUT_AMT TYPE STRING.

DATA:
LW_AMOUNT(20) TYPE C.

* convert the format of amount
CLEAR LW_AMOUNT.
LW_AMOUNT = I_IN_AMT.
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = I_WAERS
SAP_AMOUNT  = LW_AMOUNT
IMPORTING
IDOC_AMOUNT = LW_AMOUNT.
O_OUT_AMT = LW_AMOUNT.

ENDFORM.                    " CONVERT_AMOUNT
************************************************************************
*      Form  WRITE_OUT
************************************************************************
*       Write result screen
************************************************************************
*      -->I_TD_FILENAME         ファイル名
*      -->I_TD_MSG              メッセージ
*      -->I_RECORD_TOT        処理件数
*      -->I_RECORD_ERR        エラー件数
*      -->I_RECORD_OK         成功件数
************************************************************************
FORM WRITE_OUT
USING I_TD_FILENAME TYPE TYP_TD_FILENAME
I_RECORD_TOT  TYPE I
I_RECORD_ERR  TYPE I
I_RECORD_OK   TYPE I
I_TD_MSG      TYPE TYP_TD_MSG.
DATA:
LW_MODE(10)  TYPE C,
LRH_WERKS    LIKE LINE OF S_WERKS,
LRH_EKORG    LIKE LINE OF S_EKORG,
LW_WERKS     TYPE STRING,
LW_EKORG     TYPE STRING,
LTH_FILENAME TYPE TYP_TH_FILENAME,
LTH_MSG      TYPE TYP_TH_MSG,
LW_SIGN      TYPE STRING,
LW_OPTION    TYPE STRING,
LW_LOW       TYPE STRING,
LW_HIGH      TYPE STRING,
LW_NO        TYPE I.

* Mode
CASE 'X'.
WHEN RB_PRINT.
LW_MODE = TEXT-002.
WHEN RB_REPNT.
LW_MODE = TEXT-003.
WHEN RB_DOWNL.
LW_MODE = TEXT-004.
WHEN OTHERS.
ENDCASE.

* Plant: SI:X OP:XX LO:XX HI:XX
LOOP AT S_WERKS INTO LRH_WERKS.
CLEAR: LW_SIGN,
LW_OPTION,
LW_LOW,
LW_HIGH.
LW_NO = LW_NO + 1.
CONCATENATE 'SI:'
LRH_WERKS-SIGN
INTO LW_SIGN.
CONCATENATE 'OP:'
LRH_WERKS-OPTION
INTO LW_OPTION.
CONCATENATE 'LO:'
LRH_WERKS-LOW
INTO LW_LOW.
CONCATENATE 'HI:'
LRH_WERKS-HIGH
INTO LW_HIGH.
IF LW_NO = 1.
CONCATENATE LW_SIGN
LW_OPTION
LW_LOW
LW_HIGH
INTO LW_WERKS
SEPARATED BY SPACE.
ELSEIF LW_NO > 1
AND LW_NO <= 5.
CONCATENATE LW_WERKS
'/'
LW_SIGN
LW_OPTION
LW_LOW
LW_HIGH
INTO LW_WERKS
SEPARATED BY SPACE.
ELSE.
CONCATENATE LW_WERKS
'/...'
INTO LW_WERKS
SEPARATED BY SPACE.
ENDIF.
ENDLOOP.

* Purch. Org.: SI:X OP:XX LO:XX HI:XX
CLEAR LW_NO.
LOOP AT S_EKORG INTO LRH_EKORG.
CLEAR: LW_SIGN,
LW_OPTION,
LW_LOW,
LW_HIGH.
LW_NO = LW_NO + 1.
CONCATENATE 'SI:'
LRH_EKORG-SIGN
INTO LW_SIGN.
CONCATENATE 'OP:'
LRH_EKORG-OPTION
INTO LW_OPTION.
CONCATENATE 'LO:'
LRH_EKORG-LOW
INTO LW_LOW.
CONCATENATE 'HI:'
LRH_EKORG-HIGH
INTO LW_HIGH.
IF LW_NO = 1.
CONCATENATE LW_SIGN
LW_OPTION
LW_LOW
LW_HIGH
INTO LW_EKORG
SEPARATED BY SPACE.
ELSEIF LW_NO > 1
AND LW_NO <= 5.
CONCATENATE LW_EKORG
'/'
LW_SIGN
LW_OPTION
LW_LOW
LW_HIGH
INTO LW_EKORG
SEPARATED BY SPACE.
ELSE.
CONCATENATE LW_EKORG
'/...'
INTO LW_EKORG
SEPARATED BY SPACE.
ENDIF.
ENDLOOP.

SKIP 2.
WRITE: /1 TEXT-018,         " Parameters
/3 TEXT-019,         " Mode
28 ':',
32 LW_MODE,
/3 TEXT-020,         " Report type
28 ':',
32 TEXT-007,
/3 TEXT-021,         " Plant
28 ':',
32 LW_WERKS,
/3 TEXT-022,         " Purchase Org.
28 ':',
32 LW_EKORG,
/3 TEXT-024,         " File Name
28 ':'.
* FileName
LOOP AT I_TD_FILENAME INTO LTH_FILENAME.
IF SY-TABIX = 1.
WRITE  32 LTH_FILENAME-FILENAME.
ELSE.
WRITE /32 LTH_FILENAME-FILENAME.
ENDIF.
ENDLOOP.

SKIP 2.
WRITE: /1 TEXT-025,         " Result
/3 TEXT-026,         " Number of Transactions
28 ':',
32 I_RECORD_TOT,
/3 TEXT-027,         " Number of Normal
28 ':',
32 I_RECORD_OK,
/3 TEXT-028,         " Number of Errors
28 ':',
32 I_RECORD_ERR.

SKIP 2.
WRITE: /1 TEXT-029.
LOOP AT I_TD_MSG INTO LTH_MSG.
WRITE: /4  TEXT-031,       " Report type
25 LTH_MSG-TYPE,   " Message type
46 LTH_MSG-TEXT.   " Message text
ENDLOOP.

ENDFORM.                    " WRITE_OUT
************************************************************************
*      Form  HEADER_OUT
************************************************************************
*     ヘッダ部出力
************************************************************************
FORM HEADER_OUT .

* タイトル表題設定
SET TITLEBAR 'GUI_TITLE_2000'.

WRITE:  1 TEXT-012,         " Client
10 ':',
13 SY-MANDT,
130 TEXT-013,         " Date
136 ':',
139 SY-DATLO.
WRITE: /1 TEXT-014,         " Program
10 ':',
13 SY-REPID,
130 TEXT-015,         " Time
136 ':',
139 SY-TIMLO.
WRITE: /1 TEXT-016,         " User
10 ':',
13 SY-UNAME,
60 TEXT-017.

ENDFORM.                    " HEADER_OUT
**** START ADD 2015/02/10 ISID18 ****
************************************************************************
*      Form  FRM_VEND_DT_GET
************************************************************************
*      納入先住所情報取得
************************************************************************
*      -->I_EBELN          購買伝票
*      -->I_EBELP          購買伝票明細
*      <--O_TH_ZTEGMMT012  テーブルデータ
************************************************************************
FORM FRM_VEND_DT_GET
USING    I_EBELN         TYPE EKPO-EBELN
I_EBELP         TYPE EKPO-EBELP
CHANGING O_TH_ZTEGMMT012 TYPE ZTEGMMT012.

DATA:
LTH_ADRC TYPE ZSEGZZ0002,
LW_SUBRC TYPE SY-SUBRC.

CLEAR:
O_TH_ZTEGMMT012-Z_VEND_DT,
O_TH_ZTEGMMT012-Z_VEND_NAME_DT,
O_TH_ZTEGMMT012-Z_ADDRESS1_DT,
O_TH_ZTEGMMT012-Z_ADDRESS2_DT,
O_TH_ZTEGMMT012-Z_ADDRESS3_DT,
O_TH_ZTEGMMT012-Z_ADDRESS4_DT,
O_TH_ZTEGMMT012-Z_TEL_DT,
O_TH_ZTEGMMT012-Z_FAX_DT.

CALL FUNCTION 'ZEG_ZZ_ADRC_GET_FROM_PO'
EXPORTING
IMPEBELN = I_EBELN
IMPEBELP = I_EBELP
IMPORTING
EXPADRC  = LTH_ADRC
EXPSUBRC = LW_SUBRC.

IF LW_SUBRC = 0.
O_TH_ZTEGMMT012-Z_VEND_DT      = LTH_ADRC-ADDRNUMBER.
O_TH_ZTEGMMT012-Z_VEND_NAME_DT = LTH_ADRC-Z_NAME.
O_TH_ZTEGMMT012-Z_ADDRESS1_DT  = LTH_ADRC-Z_ADDRESS1.
O_TH_ZTEGMMT012-Z_ADDRESS2_DT  = LTH_ADRC-Z_ADDRESS2.
O_TH_ZTEGMMT012-Z_ADDRESS3_DT  = LTH_ADRC-Z_ADDRESS3.
O_TH_ZTEGMMT012-Z_ADDRESS4_DT  = LTH_ADRC-Z_ADDRESS4.
O_TH_ZTEGMMT012-Z_TEL_DT       = LTH_ADRC-TEL_NUMBER.
O_TH_ZTEGMMT012-Z_FAX_DT       = LTH_ADRC-FAX_NUMBER.
ENDIF.

ENDFORM.                    " FRM_VEND_DT_GET
************************************************************************
*&      Form  FRM_MAKTX_GET
************************************************************************
*       品目テキスト取得
************************************************************************
*      -->I_TH_TVKO        販売組織
*      <--O_TH_ZTEGMMT012  テーブルデータ
************************************************************************
FORM FRM_MAKTX_GET
USING    I_TH_TVKO       TYPE TYP_TH_TVKO
CHANGING O_TH_ZTEGMMT012 TYPE ZTEGMMT012.

DATA:
LW_LANGU    TYPE SY-LANGU,
LW_NAME     TYPE THEAD-TDNAME,
LW_MSG(128) TYPE C,
LTH_LINES   TYPE TLINE,
LTD_LINES   TYPE STANDARD TABLE OF TLINE.

IF P_LANGU IS NOT INITIAL.
LW_LANGU = P_LANGU.
ELSE.
LW_LANGU = SY-LANGU.
ENDIF.
CLEAR O_TH_ZTEGMMT012-MAKTX.
**** START UPD 2015/07/06 ISID18 ****
*  LW_NAME+0(18) = O_TH_ZTEGMMT012-Z_MATNR_PO+0(18).
CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
EXPORTING
INPUT        = O_TH_ZTEGMMT012-Z_MATNR_PO
IMPORTING
OUTPUT       = LW_NAME+0(18)
EXCEPTIONS
LENGTH_ERROR = 1
OTHERS       = 2.
**** END UPD 2015/07/06 ISID18 ****
LW_NAME+18(4) = I_TH_TVKO-VKORG.
LW_NAME+22(2) = I_TH_TVKO-VTWEG.
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = '0001'
LANGUAGE                = LW_LANGU
NAME                    = LW_NAME
OBJECT                  = 'MVKE'
TABLES
LINES                   = LTD_LINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.
CASE SY-SUBRC.
WHEN 0.
LOOP AT LTD_LINES INTO LTH_LINES.
CONCATENATE O_TH_ZTEGMMT012-MAKTX
LTH_LINES-TDLINE
INTO O_TH_ZTEGMMT012-MAKTX.
ENDLOOP.
WHEN 4.
WHEN OTHERS.
MESSAGE ID SY-MSGID
TYPE SY-MSGTY
NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO LW_MSG.
*     汎用モジュールにて想定外のエラーが発生しました。
MESSAGE S032
WITH 'READ_TEXT' LW_MSG
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDCASE.

ENDFORM.                    " FRM_MAKTX_GET
************************************************************************
*&      Form  FRM_TOTAL_AMT_GET
************************************************************************
*       総金額取得
************************************************************************
*      -->I_TH_PO          購買発注データ
*      <--O_TH_ZTEGMMT012  テーブルデータ
************************************************************************
FORM FRM_TOTAL_AMT_GET
USING    I_TH_PO         TYPE TYP_TH_PO
CHANGING O_TH_ZTEGMMT012 TYPE ZTEGMMT012.

DATA:
LW_MSG(128) TYPE C,
LTH_MWDAT   TYPE RTAX1U15,
LTD_MWDAT   TYPE STANDARD TABLE OF RTAX1U15.

* 初期化
CLEAR: O_TH_ZTEGMMT012-Z_TAX_RATE,
O_TH_ZTEGMMT012-Z_TOTAL_NETWR.

**** START ADD BY ISID17 2015/04/29 ****
* 伝票タイプが「NB」「ZB」の場合
CASE I_TH_PO-BSART.
WHEN CNS_BSART_NB    "購買依頼、購買発注
OR CNS_BSART_ZB.   "返品発注
**** END ADD BY ISID17 2015/04/29 ****
* 汎用モジュール起動
CALL FUNCTION 'CALCULATE_TAX_FROM_NET_AMOUNT'
EXPORTING
I_BUKRS           = I_TH_PO-BUKRS
I_MWSKZ           = I_TH_PO-MWSKZ
I_WAERS           = I_TH_PO-WAERS
I_WRBTR           = I_TH_PO-NETWR
TABLES
T_MWDAT           = LTD_MWDAT
EXCEPTIONS
BUKRS_NOT_FOUND   = 1
COUNTRY_NOT_FOUND = 2
MWSKZ_NOT_DEFINED = 3
MWSKZ_NOT_VALID   = 4
KTOSL_NOT_FOUND   = 5
KALSM_NOT_FOUND   = 6
PARAMETER_ERROR   = 7
KNUMH_NOT_FOUND   = 8
KSCHL_NOT_FOUND   = 9
UNKNOWN_ERROR     = 10
ACCOUNT_NOT_FOUND = 11
TXJCD_NOT_VALID   = 12
OTHERS            = 13.

CASE SY-SUBRC.
WHEN 0.
CLEAR LTH_MWDAT.
READ TABLE LTD_MWDAT INTO LTH_MWDAT INDEX 1.
**** START DEL BY ISID17 2015/04/29 ****
*          O_TH_ZTEGMMT012-Z_TOTAL_NETWR = I_TH_PO-NETWR +
*                                          LTH_MWDAT-WMWST.
**** END DEL BY ISID17 2015/04/29 ****
O_TH_ZTEGMMT012-Z_TAX_RATE = LTH_MWDAT-MSATZ.
WHEN OTHERS.
MESSAGE ID SY-MSGID
TYPE SY-MSGTY
NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO LW_MSG.
*     汎用モジュールにて想定外のエラーが発生しました。
MESSAGE S032
WITH 'CALCULATE_TAX_FROM_NET_AMOUNT' LW_MSG
DISPLAY LIKE 'E'.
LEAVE LIST-PROCESSING.
ENDCASE.
**** START ADD BY ISID17 2015/04/29 ****
WHEN OTHERS.
ENDCASE.

O_TH_ZTEGMMT012-Z_TOTAL_NETWR = I_TH_PO-NETWR
+ LTH_MWDAT-WMWST.
**** END ADD BY ISID17 2015/04/29 ****

ENDFORM.                    " FRM_TOTAL_AMT_GET
************************************************************************
*&      Form  GET_VBAK_KNA1
************************************************************************
*       販売伝票より住所取得
************************************************************************
*      -->I_TD_PO         購買発注データ
*      <--O_TD_VBAK_KNA1  住所
************************************************************************
FORM GET_VBAK_KNA1
USING    I_TD_PO        TYPE TYP_TD_PO
CHANGING O_TD_VBAK_KNA1 TYPE TYP_TD_VBAK_KNA1.

TYPES:
BEGIN OF LTYP_TH_VBAK,
VBELN TYPE VBAK-VBELN,
ADRNR TYPE KNA1-ADRNR,
END OF LTYP_TH_VBAK,
LTYP_TD_VBAK TYPE STANDARD TABLE OF LTYP_TH_VBAK.
DATA:
LTD_PO         TYPE TYP_TD_PO,
LTD_VBAK       TYPE LTYP_TD_VBAK,
LTD_VBAK2      TYPE LTYP_TD_VBAK,
LTH_VBAK       TYPE LTYP_TH_VBAK,
LTH_VBAK_KNA1  TYPE TYP_TH_VBAK_KNA1,
LRD_ADRC       TYPE BUADDRNRRNG,
LRH_ADRC       LIKE LINE OF LRD_ADRC,
LTD_ADRC       TYPE ZTEGZZ002,
LTH_ADRC       TYPE ZSEGZZ0002.

REFRESH O_TD_VBAK_KNA1.
LTD_PO[] = I_TD_PO[].
SORT LTD_PO BY VBELN.
DELETE ADJACENT DUPLICATES FROM LTD_PO
COMPARING VBELN.

* 販売伝票対しての受注先のアドレス番号取得
IF LTD_PO[] IS NOT INITIAL.
SELECT
VBAK~VBELN
KNA1~ADRNR
INTO TABLE LTD_VBAK
FROM VBAK AS VBAK
INNER JOIN KNA1 AS KNA1
ON VBAK~KUNNR = KNA1~KUNNR
FOR ALL ENTRIES IN LTD_PO
WHERE VBELN = LTD_PO-VBELN.
ENDIF.

LTD_VBAK2[] = LTD_VBAK[].
SORT LTD_VBAK2 BY ADRNR.
DELETE ADJACENT DUPLICATES FROM LTD_VBAK2
COMPARING ADRNR.
IF LTD_VBAK2[] IS NOT INITIAL.
CLEAR LRH_ADRC.
LRH_ADRC-SIGN = 'I'.
LRH_ADRC-OPTION = 'EQ'.
LOOP AT LTD_VBAK2 INTO LTH_VBAK.
LRH_ADRC-LOW = LTH_VBAK-ADRNR.
APPEND LRH_ADRC TO LRD_ADRC.
ENDLOOP.
ENDIF.

* Get ADRC address and name
CALL FUNCTION 'ZEG_ZZ_ADRC_GET'
EXPORTING
IMPMULTITFLG     = '2'
IMPRNGADDRNUMBER = LRD_ADRC
IMPORTING
EXPTABADRC       = LTD_ADRC.
SORT LTD_ADRC BY ADDRNUMBER.

* 取得した名称を内部ＴＢＬに編集
LOOP AT LTD_VBAK INTO LTH_VBAK.
CLEAR LTH_VBAK_KNA1.
LTH_VBAK_KNA1-VBELN = LTH_VBAK-VBELN.
CLEAR LTH_ADRC.
READ TABLE LTD_ADRC INTO LTH_ADRC
WITH KEY ADDRNUMBER = LTH_VBAK-ADRNR
BINARY SEARCH.
LTH_VBAK_KNA1-NAME1 = LTH_ADRC-Z_NAME.
APPEND LTH_VBAK_KNA1 TO O_TD_VBAK_KNA1.
ENDLOOP.
SORT O_TD_VBAK_KNA1 BY VBELN.

ENDFORM.                    " GET_VBAK_KNA1
************************************************************************
*&      Form  GET_VBPA_T005T
************************************************************************
*       出荷先の国名取得
************************************************************************
*      -->I_TD_PO         購買発注データ
*      <--O_TD_VBAK_KNA1  出荷先の国名
************************************************************************
FORM GET_VBPA_T005T
USING    I_TD_PO         TYPE TYP_TD_PO
CHANGING O_TD_VBPA_T005T TYPE TYP_TD_VBPA_T005T.

DATA LTD_PO   TYPE TYP_TD_PO.
DATA LW_PARVW TYPE VBPA-PARVW.
DATA LW_LANGU TYPE SY-LANGU.

REFRESH O_TD_VBPA_T005T.

LTD_PO[] = I_TD_PO[].
SORT LTD_PO BY VBELN.
DELETE ADJACENT DUPLICATES FROM LTD_PO
COMPARING VBELN.

* 取引先機能変換
CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = 'SH'
IMPORTING
OUTPUT = LW_PARVW.

CLEAR LW_LANGU.
IF P_LANGU IS NOT INITIAL.
LW_LANGU = P_LANGU.
ELSE.
LW_LANGU = SY-LANGU.
ENDIF.

* 国名取得
IF LTD_PO[] IS NOT INITIAL.
SELECT VBPA~VBELN
T005T~LANDX
INTO TABLE O_TD_VBPA_T005T
FROM VBPA AS VBPA
INNER JOIN KNA1 AS KNA1
ON VBPA~KUNNR = KNA1~KUNNR
INNER JOIN T005T AS T005T
ON KNA1~LAND1 = T005T~LAND1
FOR ALL ENTRIES IN LTD_PO
WHERE VBPA~VBELN = LTD_PO-VBELN
AND VBPA~POSNR = SPACE
AND VBPA~PARVW = LW_PARVW
**** START UPD 2015/03/11 ISID18 ****
*       AND T005T~SPRAS = P_LANGU.
AND T005T~SPRAS = LW_LANGU.
**** END UPD 2015/03/11 ISID18 ****
ENDIF.

SORT O_TD_VBPA_T005T BY VBELN.

ENDFORM.                    " GET_VBPA_T005T
************************************************************************
*&      Form  GET_DEFAULT_PRINTER
************************************************************************
*       出力デバイス取得
************************************************************************
FORM GET_DEFAULT_PRINTER .

DATA LST_USER_DEFAULTS  TYPE USDEFAULTS.

CALL FUNCTION 'SUSR_USER_READ'
EXPORTING
USER_NAME            = SY-UNAME
IMPORTING
USER_DEFAULTS        = LST_USER_DEFAULTS
EXCEPTIONS
USER_NAME_NOT_EXISTS = 1
INTERNAL_ERROR       = 2
OTHERS               = 3.

IF SY-SUBRC = 0.
CALL FUNCTION 'CONVERSION_EXIT_SPDEV_OUTPUT'
EXPORTING
INPUT  = LST_USER_DEFAULTS-SPLD
IMPORTING
OUTPUT = P_TRAY.
ENDIF.

ENDFORM.                    " GET_DEFAULT_PRINTER
************************************************************************
*&      Form  GET_PRINT_DATA
************************************************************************
*       Printデータ限定
************************************************************************
*      -->I_TD_ZTEGMMT011  履歴データ
*      <--O_TD_PO  　　　　購買発注データ
************************************************************************
FORM GET_PRINT_DATA
USING    I_TD_ZTEGMMT011 TYPE TYP_TD_ZTEGMMT011
CHANGING O_TD_PO         TYPE TYP_TD_PO.

DATA LTH_ZTEGMMT011 TYPE TYP_TH_ZTEGMMT011.

* PRINTの場合下記処理を行う
IF RB_PRINT IS INITIAL.
RETURN.
ENDIF.

* 既に印刷したデータを削除
LOOP AT I_TD_ZTEGMMT011 INTO LTH_ZTEGMMT011.
DELETE O_TD_PO
WHERE EBELN = LTH_ZTEGMMT011-EBELN.
ENDLOOP.
IF O_TD_PO[] IS INITIAL.
MESSAGE S006 WITH 'EKKO&EKPO'.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    " GET_PRINT_DATA
**** END ADD 2015/02/10 ISID18 ****
**** START ADD 2015/07/07 ISID18 ****
*&---------------------------------------------------------------------*
*&      Form  CONVERT_EBELP
*&---------------------------------------------------------------------*
*       購買明細番号外部書式転換
*----------------------------------------------------------------------*
*      <--O_EBELP  購買明細番号
*----------------------------------------------------------------------*
FORM CONVERT_EBELP
CHANGING O_EBELP TYPE STRING.

DATA LW_CHAR(20) TYPE C.
LW_CHAR = O_EBELP.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
EXPORTING
INPUT  = LW_CHAR
IMPORTING
OUTPUT = LW_CHAR.
O_EBELP = LW_CHAR.

ENDFORM.                    " CONVERT_EBELP
**** END ADD 2015/07/07 ISID18 ****
*Text symbol text・
*001:Mode
*002:Print
*003:Reprint
*004:Download
*005:Print Option
*006:Download Option
*007:Purchase Order
*008:Report Parameter
*009:Printer/Tray
*010:File Path
*011:[Error]
*012:CLIENT
*013:Date
*014:PROGRAM
*015:Time
*016:USER
*017:<<<Purchase Order Report Output>>>
*018:<Parameters>
*019:Mode
*020:Report Type
*021:Plant
*022:Purch. Org.
*024:File Name
*025:<Result>
*026:Number of Transcations
*027:Number of Normal
*028:Number of Errors
*029:<Message>
*030:[Information]
*031:(Purchase Order)
*Selection text・
*P_CADD1:        Company Address1
*P_CADD2:        Company Address2
*P_CFAX:        Company Fax
*P_CNAME:        Company Name
*P_CTEL:        Company Tel
*P_DATFM:        Date format
*P_FILE:        File Path
*P_LANGU:        Report Language
*P_TITLE:        Report Title
*P_TRAY:        Printer/Tray
*P_XDEZP:        Dec.pt.format
*RB_DOWNL:        Download
*RB_PRINT:        Print
*RB_REPNT:        Reprint
*S_AEDAT:        Created on
*S_BEDAT:        Doc. date
*S_BSART:        Order Type
*S_EBELN:        Purchase Order
*S_EINDT:        Delivery Date
*S_EKGRP:        Purch. Group
*S_EKORG:        Purch. Org.
*S_ERNAM:        Created by
*S_KNTTP:        Acct Assgt Cat.
*S_LIFNR:        Vendor
*S_MATNR:        Material
*S_PSTYP:        Item Category
*S_SPRAS:        Vendor Language
*S_WERKS:        Plant
