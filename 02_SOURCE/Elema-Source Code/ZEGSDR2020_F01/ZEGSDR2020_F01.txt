*----------------------------------------------------------------------*
***INCLUDE ZEGSDR2020_F01.
*----------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       A-1-1．入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT.
* A-1-1-1．販売組織(Sales Organization)存在チェック
PERFORM CHECK_VKORG.

* A-1-1-2．流通チャネル(Distribution Channel)存在チェック
PERFORM CHECK_VTWEG.

* A-1-1-3． 販売部門(Division)存在チェック
PERFORM CHECK_SPART.

* A-1-1-4．営業所(Sales Office)存在チェック
PERFORM CHECK_VKBUR.

* A-1-1-5．営業グループ(Sales Group)存在チェック
PERFORM CHECK_VKGRP.

ENDFORM.                    " CHECK_INPUT
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKORG
*&---------------------------------------------------------------------*
*       A-1-1-1．販売組織(Sales Organization)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKORG.
SELECT SINGLE VKORG
FROM TVKO
INTO P_VKORG
WHERE VKORG = P_VKORG.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_VKORG'.
MESSAGE E039(ZMEGSD01) WITH P_VKORG.
*   #售##( &1 )不存在
ENDIF.

ENDFORM.                    " CHECK_VKORG
*&---------------------------------------------------------------------*
*&      Form  CHECK_VTWEG
*&---------------------------------------------------------------------*
*       A-1-1-2．流通チャネル(Distribution Channel)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VTWEG.
TYPES: BEGIN OF LTYP_VTWEG,
VTWEG TYPE TVTW-VTWEG,
END OF LTYP_VTWEG.
DATA:
LTD_VTWEG   TYPE STANDARD TABLE OF LTYP_VTWEG,
LST_VTWEG   TYPE LTYP_VTWEG,
LST_VTWEG_R LIKE LINE OF RD_VTWEG.

SELECT VTWEG
INTO TABLE LTD_VTWEG
FROM TVTW
WHERE VTWEG IN S_VTWEG.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VTWEG-LOW'.
MESSAGE E040(ZMEGSD01) WITH SPACE.
*   流通チャネル&1は存在しません
ENDIF.

REFRESH RD_VTWEG.

LST_VTWEG_R-SIGN = 'I'.
LST_VTWEG_R-OPTION = 'EQ'.
LOOP AT LTD_VTWEG INTO LST_VTWEG.
LST_VTWEG_R-LOW = LST_VTWEG-VTWEG.
APPEND LST_VTWEG_R TO RD_VTWEG.
ENDLOOP.

ENDFORM.                    " CHECK_VTWEG
*&---------------------------------------------------------------------*
*&      Form  CHECK_SPART
*&---------------------------------------------------------------------*
*       A-1-1-3． 販売部門(Division)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_SPART.
TYPES:
BEGIN OF LTYP_SPART,
SPART TYPE TSPA-SPART,
END OF LTYP_SPART.

DATA:
LTD_SPART   TYPE STANDARD TABLE OF LTYP_SPART,
LST_SPART   TYPE LTYP_SPART,
LST_SPART_R LIKE LINE OF RD_SPART.

SELECT SPART
INTO TABLE LTD_SPART
FROM TSPA
WHERE SPART IN S_SPART.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_SPART-LOW'.
MESSAGE E041(ZMEGSD01) WITH SPACE.
*   製品部門&1は存在しません
ENDIF.

REFRESH RD_SPART.
LST_SPART_R-SIGN = 'I'.
LST_SPART_R-OPTION = 'EQ'.
LOOP AT LTD_SPART INTO LST_SPART.
LST_SPART_R-LOW = LST_SPART-SPART.
APPEND LST_SPART_R TO RD_SPART.
ENDLOOP.

ENDFORM.                    " CHECK_SPART
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKBUR
*&---------------------------------------------------------------------*
*       A-1-1-4．営業所(Sales Office)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKBUR.
TYPES:
BEGIN OF LTYP_VKBUR,
VKBUR TYPE TVBUR-VKBUR,
END OF LTYP_VKBUR.

DATA:
LTD_VKBUR   TYPE STANDARD TABLE OF LTYP_VKBUR,
LST_VKBUR   TYPE LTYP_VKBUR,
LST_VKBUR_R LIKE LINE OF RD_VKBUR.

SELECT VKBUR
INTO TABLE LTD_VKBUR
FROM TVBUR
WHERE VKBUR IN S_VKBUR.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKBUR-LOW'.
MESSAGE E042(ZMEGSD01) WITH SPACE.
*   営業所&1は存在しません
ENDIF.

REFRESH RD_VKBUR.
LST_VKBUR_R-SIGN = 'I'.
LST_VKBUR_R-OPTION = 'EQ'.
LOOP AT LTD_VKBUR INTO LST_VKBUR.
LST_VKBUR_R-LOW = LST_VKBUR-VKBUR.
APPEND LST_VKBUR_R TO RD_VKBUR.
ENDLOOP.

ENDFORM.                    " CHECK_VKBUR
*&---------------------------------------------------------------------*
*&      Form  CHECK_VKGRP
*&---------------------------------------------------------------------*
*       A-1-1-5．営業グループ(Sales Group)存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VKGRP.
TYPES:
BEGIN OF LTYP_VKGRP,
VKGRP TYPE TVKGR-VKGRP,
END OF LTYP_VKGRP.

DATA:
LTD_VKGRP   TYPE STANDARD TABLE OF LTYP_VKGRP,
LST_VKGRP   TYPE LTYP_VKGRP,
LST_VKGRP_R LIKE LINE OF RD_VKGRP.

SELECT VKGRP
INTO TABLE LTD_VKGRP
FROM TVKGR
WHERE VKGRP IN S_VKGRP.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_VKGRP-LOW'.
MESSAGE E043(ZMEGSD01) WITH SPACE.
*   営業グループ&1は存在しません
ENDIF.

REFRESH RD_VKGRP.
LST_VKGRP_R-SIGN = 'I'.
LST_VKGRP_R-OPTION = 'EQ'.
LOOP AT LTD_VKGRP INTO LST_VKGRP.
LST_VKGRP_R-LOW = LST_VKGRP-VKGRP.
APPEND LST_VKGRP_R TO RD_VKGRP.
ENDLOOP.

ENDFORM.                    " CHECK_VKGRP
*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA
*&---------------------------------------------------------------------*
*       A-1-2-1．販売エリアの整合性チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.
SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
INTO TABLE O_TD_TVTA
FROM TVTA
WHERE VKORG =  P_VKORG                     " 販売組織
AND VTWEG IN S_VTWEG                     " 流通チャネル
AND SPART IN S_SPART.                    " 製品部門

IF SY-SUBRC <> 0.
MESSAGE E044(ZMEGSD01).
*   指定された販売エリアの整合性がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA
*&---------------------------------------------------------------------*
*&      Form  CHECK_TVTA_AUTH
*&---------------------------------------------------------------------*
*       A-1-3．権限チェック
*----------------------------------------------------------------------*
*      <--O_TD_TVTA          ITAB:販売エリア
*----------------------------------------------------------------------*
FORM CHECK_TVTA_AUTH CHANGING O_TD_TVTA TYPE TYP_TD_TVTA.
DATA:
LST_TVTA  TYPE TYP_TVTA,
LW_TABIX  TYPE SY-TABIX.

LOOP AT O_TD_TVTA INTO LST_TVTA.
LW_TABIX = SY-TABIX.
AUTHORITY-CHECK OBJECT 'V_VBAK_VKO'
ID 'VKORG' FIELD LST_TVTA-VKORG
ID 'VTWEG' FIELD LST_TVTA-VTWEG
ID 'SPART' FIELD LST_TVTA-SPART
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.
DELETE O_TD_TVTA INDEX LW_TABIX.
ENDIF.
ENDLOOP.

IF O_TD_TVTA IS INITIAL.
MESSAGE E038(ZMEGSD01).
*   販売エリアに対する実行権限がありません
ENDIF.

ENDFORM.                    " CHECK_TVTA_AUTH
*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
FORM MAIN_PROCESS.
DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203,
LW_ERRFLG      TYPE CHAR1.

REFRESH:
TD_ZSEGSD0009,
TD_ITEM_ALV_TEM.

**** START ADD 2015/03/03 iSiD19 ****
*     本社及び明細分割情報を取得する
SELECT SINGLE A~ZFLGHEADOFFICE  "本社フラグ
A~ZFLGSOSINGLE    "販売伝票単一明細フラグ
INTO (W_FLGHEADOF,
W_FLGSOSGL )
FROM ZTEGSDT204 AS A
INNER JOIN TVKO  AS B
ON A~BUKRS = B~BUKRS
WHERE B~VKORG   = P_VKORG.

*     存在しない場合、フラグに初期値を設定する
IF SY-SUBRC <> 0.
W_FLGHEADOF = SPACE. "本社フラグ
W_FLGSOSGL  = SPACE. "販売伝票単一明細フラグ
ENDIF.
**** END ADD 2015/03/03 iSiD19     ****

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
*     A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL.
LEAVE LIST-PROCESSING.
ENDIF.

*     A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.

*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
*     A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL.
LEAVE LIST-PROCESSING.
ENDIF.

*     A-2-2-2-1．販売伝票タイプの検索
*     A-2-2-2-2．販売伝票タイプの設定処理
PERFORM GET_DATA_205 CHANGING LTD_ZTEGSDT203.

*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.
*     A-2-3-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN1 USING TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.
IF LW_ERRFLG IS NOT INITIAL.
LEAVE LIST-PROCESSING.
ENDIF.
WHEN OTHERS.
*     処理なし
ENDCASE.

* 従業員データ取得
PERFORM GET_ZTERM_DATA.

* A-3．画面出力
PERFORM ALV_OUTPUT USING LTD_ZTEGSDT203.

ENDFORM.                    " MAIN_PROCESS
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN
*&---------------------------------------------------------------------*
*       以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_KBUNCC_F       処理区分1
*      -->I_STATUS_F       ステータス1
*      -->I_KBUNCC_S       処理区分2
*      -->I_STATUS_S       ステータス2
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN  USING I_KBUNCC_F     TYPE C
I_STATUS_F     TYPE C
I_KBUNCC_S     TYPE C
I_STATUS_S     TYPE C
I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203
O_W_ERRFLG     TYPE C.
DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
**** START ADD BY ISID REN 2015/07/15 ****
ZTEGSDT203~AUART                     "販売伝票タイプ
ZTEGSDT203~PSTYV                     "明細カテゴリ
**** END ADD BY ISID REN 2015/07/15 ****
**** START UPD BY ISID REN 2015/08/13 ****
*         ZTEGSDT203~MATNR                     " 品目コード
ZTEGSDT203~MATNR_SO AS MATNR          "品目コード(SO)
**** END UPD BY ISID REN 2015/08/13 ****
**** START UPD BY ISID REN 2015/08/28 ****
ZTEGSDT203~KDMAT                      "得意先品目
**** END UPD BY ISID REN 2015/08/28 ****
**** START DEL 2015/03/03 iSiD19 ****
*         ZTEGSDT203~TXZ01                     " テキスト (短)
**** END DEL 2015/03/03 iSiD19 ****
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
**** START ADD 2015/03/03 iSiD19 ****
ZTEGSDT203~LGORT_SO AS LGORT         "保管場所
**** END ADD 2015/03/03 iSiD19 ****
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
**** START ADD BY ISID REN 2015/07/15 ****
ZTEGSDT203~EVERS                     "出荷指示
ZTEGSDT203~NETPR_EU                  "正味価格EU
ZTEGSDT203~WAERK_EU                  "通貨EU
ZTEGSDT203~KPEIN_EU                  "価格条件単位EU
ZTEGSDT203~KMEIN_EU                  "条件単位EU
ZTEGSDT203~Z_SHP_REMARK1             "出荷指示備考(1)
ZTEGSDT203~Z_SHP_REMARK2             "出荷指示備考(2)
**** END ADD BY ISID REN 2015/07/15 ****
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1 AS ZNAME1               " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~PERNR                     " 営業員
**** START UPD 2015/03/03 iSiD19 ****
*         ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
*         ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~Z_VEND_NAME_DT             "出荷先名（PO）
ZTEGSDT203~Z_ADDRESS1_DT              "出荷先住所1
ZTEGSDT203~Z_ADDRESS2_DT              "出荷先住所2
ZTEGSDT203~Z_ADDRESS3_DT              "出荷先住所3
ZTEGSDT203~Z_ADDRESS4_DT              "出荷先住所4
ZTEGSDT203~Z_TEL_DT                   "出荷先電話番号
ZTEGSDT203~Z_FAX_DT                   "出荷先FAX番号（PO）
ZTEGSDT203~INCO1    	                 "インコタームズ
ZTEGSDT203~INCO2                      "取引条件
**** START ADD BY ISID REN 2015/08/06 ****
ZTEGSDT203~Z_LASTDEST                 "最終仕向地
**** END ADD BY ISID REN 2015/08/06 ****
ZTEGSDT203~Z_PURPOSE_TEXT             "用途（PO）
ZTEGSDT203~ZKUNNR_ZJ                  "最終需要者
**** START UPD BY ISID REN 2015/08/06 ****
*         KNA1_J~NAME1 AS ZNAME_ZJ                "名称1
KNA1_J~NAME2 AS ZNAME_ZJ_2              "名称2
KNA1_J~NAME3 AS ZNAME_ZJ_3              "名称3
**** END UPD BY ISID REN 2015/08/06 ****
ZTEGSDT203~ZKUNNR_ZE AS ZKUNNR_DS     "エンドユーザ（価格）
**** START UPD BY ISID REN 2015/08/06 ****
*         KNA1_E~NAME1 AS ZNAME_DS                "名称1
KNA1_E~NAME2 AS ZNAME_DS_2              "名称2
KNA1_E~NAME3 AS ZNAME_DS_3              "名称3
**** END UPD BY ISID REN 2015/08/06 ****
ZTEGSDT203~EINDT                      "明細納入期日
ZTEGSDT203~Z_PO_ITEM_TXT              "購買発注明細テキスト
ZTEGSDT203~SUBMI                      "一括番号
**** END UPD 2015/03/03 iSiD19 ****
ZTEGSDT203~AUGRU                     " 受注理由 (取引理由)
ZTEGSDT203~ZKBUNCC                   " 処理区分
ZTEGSDT203~STATUS                    " ステータス
**** START ADD 2015/04/24 ISID11 ****
ZTEGSDT203~MSGID                    "メッセージ ID
ZTEGSDT203~MSGNO                    "システムメッセージ番号
ZTEGSDT203~MSGV1                    "メッセージ変数
ZTEGSDT203~MSGV2                    "メッセージ変数
ZTEGSDT203~MSGV3                    "メッセージ変数
ZTEGSDT203~MSGV4                    "メッセージ変数
**** END ADD 2015/04/24 ISID11 ****
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
**** START ADD BY ISID REN 2015/08/06 ****
ZTEGSDT203~ERNAM                     "オブジェクト登録者名
**** END ADD BY ISID REN 2015/08/06 ****
**** START ADD BY ISID REN 2015/07/15 ****
KNA1~SPRAS                           "言語キー
**** END ADD BY ISID REN 2015/07/15 ****
**** START ADD BY ISID21 2015/09/22 ****
ZTEGSDT203~Z_ITEM_BSTKD             " 得意先発注番号
**** END ADD BY ISID21 2015/09/22 ****
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
**** START ADD 2015/03/03 iSiD19 ****
LEFT JOIN KNA1 AS KNA1_E
ON ZTEGSDT203~ZKUNNR_ZE  =  KNA1_E~KUNNR " 出荷先
LEFT JOIN KNA1 AS KNA1_J
ON ZTEGSDT203~ZKUNNR_ZJ  =  KNA1_J~KUNNR " 出荷先
**** END ADD 2015/03/03 iSiD19     ****
INTO CORRESPONDING FIELDS OF TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG  " 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART  " 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ( ( ZTEGSDT203~ZKBUNCC    = I_KBUNCC_F   " 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_F ) " ステータス
OR ( ZTEGSDT203~ZKBUNCC  = I_KBUNCC_S   " 処理区分
AND ZTEGSDT203~STATUS = I_STATUS_S ) ). " ステータス

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
*   対象データが存在しません。(TBL = &1)
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM.
ELSE.
LTD_SDT203[] = O_TD_SDT203[].
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= SY-DATUM                  " 開始日付
AND ENDDA >= SY-DATUM.                 " 終了日付

IF SY-SUBRC = 0.
SORT LTD_PA0001 BY PERNR ASCENDING.     " 営業員
ENDIF.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.
<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME.  " 応募者氏名

**** START ADD BY ISID REN 2015/08/21 ****
CONCATENATE <LFS_ST_SDT203>-ZNAME_ZJ_2  "名称2
<LFS_ST_SDT203>-ZNAME_ZJ_3  "名称3
INTO <LFS_ST_SDT203>-ZNAME_ZJ.   "最終需要者名称
CONCATENATE <LFS_ST_SDT203>-ZNAME_DS_2  "名称2
<LFS_ST_SDT203>-ZNAME_DS_3  "名称3
INTO <LFS_ST_SDT203>-ZNAME_DS.   "エンドユーザ（価格）名称
**** END ADD BY ISID REN 2015/08/21 ****
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN
*&---------------------------------------------------------------------*
*&      Form  EDIT_DATA_MAIN
*&---------------------------------------------------------------------*
*       A-2-1-2．承認一覧の関連情報を取得
*----------------------------------------------------------------------*
*      <--O_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM EDIT_DATA_MAIN CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_SDT203   TYPE TYP_TD_ZTEGSDT203,
LTD_PROCESS  TYPE TYP_TD_ZTEGSDT203,
LTD_203      TYPE TYP_TD_ZTEGSDT203,
LTD_KNVP     TYPE STANDARD TABLE OF TYP_KNVP,
LST_KNVP     TYPE TYP_KNVP,
**** START DEL 2015/03/03 iSiD19 ****
*    LTD_SDT204   TYPE STANDARD TABLE OF TYP_ZTEGSDT204,
*    LST_SDT204   TYPE TYP_ZTEGSDT204,
**** END DEL 2015/03/03 iSiD19 ****
LTD_DATA_205_TEM TYPE TYP_TD_205,
LTD_DATA_205 TYPE TYP_TD_205,
**** START ADD BY ISID REN 2015/07/15 ****
LTD_ZTEGSDT205 TYPE TYP_TD_205,       "Sales Type Determinant
LTD_MVKE_T184  TYPE TYP_TD_MVKE_T184, "販売伝票の明細カテゴリ
LST_ZTEGSDT205 TYPE TYP_DATA_205,     "Sales Type Determinant
LST_MVKE_T184  TYPE TYP_MVKE_T184,    "販売伝票の明細カテゴリ
**** END ADD BY ISID REN 2015/07/15 ****
LST_DATA_205 TYPE TYP_DATA_205,
LTD_KALVG    TYPE TYP_TD_KALVG,
LST_KALVG    TYPE TYP_KALVG,
LTD_KALKS    TYPE TYP_TD_KALKS,
LST_KALKS    TYPE TYP_KALKS,
LTD_COND_TYPE TYPE TYP_TD_COND_TYPE,
LST_COND_TYPE TYPE TYP_COND_TYPE,
LTD_ENAME    TYPE STANDARD TABLE OF TYP_ENAME,
LST_ENAME    TYPE TYP_ENAME,
LTD_KNVV     TYPE STANDARD TABLE OF TYP_KNVV,
LST_KNVV     TYPE TYP_KNVV,
LW_PARVW     TYPE KNVP-PARVW.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
*   A-2-1-2-1．出荷先の情報の検索
AT FIRST.
**** START ADD 2015/03/03 iSiD19 ****
IF W_FLGHEADOF IS NOT INITIAL. "本社フラグ
**** END ADD 2015/03/03 iSiD19   ****

LTD_SDT203[] = O_TD_SDT203[].

DELETE LTD_SDT203
WHERE ZKUNNR_S IS NOT INITIAL.         " Ship-to

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門

IF LTD_SDT203 IS NOT INITIAL.
CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = CNS_PAR_SH
IMPORTING
OUTPUT = LW_PARVW.

SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~KUNN2                     " 取引先の得意先コード
KNA1~NAME1                     " 名称1
FROM KNVP
INNER JOIN KNA1
ON KNVP~KUNN2 = KNA1~KUNNR        " 取引先の得意先コード
INTO TABLE LTD_KNVP                 " ITAB:得意先マスタ
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = LW_PARVW.         " 取引先機能

IF SY-SUBRC = 0.
SORT LTD_KNVP BY KUNNR ASCENDING  " 得意先コード
VKORG ASCENDING  " 販売組織
VTWEG ASCENDING  " 流通チャネル
SPART ASCENDING. " 製品部門
ENDIF.
ENDIF.
**** START ADD 2015/03/03 iSiD19 ****
ENDIF. "本社フラグ
**** END ADD 2015/03/03 iSiD19   ****

**** START DEL 2015/03/03 iSiD19 ****
**   A-2-1-2-2．最終需要者の情報を検索
*      LTD_SDT203[] = O_TD_SDT203[].
*
*      DELETE LTD_SDT203
*       WHERE ZKUNNR_ZJ IS NOT INITIAL.        " 最終需要者
*
*      SORT LTD_SDT203 BY MATNR ASCENDING      " 品目コード
*                         VKORG ASCENDING.     " 販売組織
*
*      DELETE ADJACENT DUPLICATES FROM LTD_SDT203
*                            COMPARING MATNR   " 品目コード
*                                      VKORG.  " 販売組織
*
*      IF LTD_SDT203 IS NOT INITIAL.
*        SELECT ZTEGSDT204~MATNR               " 品目コード
*               TVKO~VKORG                     " 販売組織
*               ZTEGSDT204~ZKUNNR_ZJ           " 最終需要者
*               ZTEGSDT204~ZKUNNR_DS           " 最終需要者(商流)
*          FROM ZTEGSDT204
*         INNER JOIN TVKO
*            ON ZTEGSDT204~BUKRS = TVKO~BUKRS
*          INTO TABLE LTD_SDT204
*           FOR ALL ENTRIES IN LTD_SDT203
*         WHERE ZTEGSDT204~MATNR = LTD_SDT203-MATNR
*                                              " 品目コード
*           AND TVKO~VKORG       = LTD_SDT203-VKORG.
*        " 販売組織
*
*        IF SY-SUBRC = 0.
*          SORT LTD_SDT204 BY MATNR ASCENDING  " 品目コード
*                             VKORG ASCENDING. " 販売組織
*        ENDIF.
*
*      ENDIF.
**** END DEL 2015/03/03 iSiD19 ****

*   A-2-1-2-3．営業員情報の検索
LTD_SDT203[] = O_TD_SDT203[].

DELETE LTD_SDT203
WHERE ENAME IS NOT INITIAL.            " 応募者氏名

SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING.     " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING KUNNR   " 得意先コード
VKORG   " 販売組織
VTWEG   " 流通チャネル
SPART.  " 製品部門

IF LTD_SDT203 IS NOT INITIAL.
CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = CNS_PAR_PE
IMPORTING
OUTPUT = LW_PARVW.

SELECT KNVP~KUNNR                     " 得意先コード
KNVP~VKORG                     " 販売組織
KNVP~VTWEG                     " 流通チャネル
KNVP~SPART                     " 製品部門
KNVP~PERNR                     " 従業員番号
PA0001~ENAME                   " 従業員氏名
FROM KNVP
INNER JOIN PA0001
ON KNVP~PERNR = PA0001~PERNR      " 従業員番号
INTO TABLE LTD_ENAME
FOR ALL ENTRIES IN LTD_SDT203
WHERE KNVP~KUNNR = LTD_SDT203-KUNNR  " 得意先コード
AND KNVP~VKORG = LTD_SDT203-VKORG  " 販売組織
AND KNVP~VTWEG = LTD_SDT203-VTWEG  " 流通チャネル
AND KNVP~SPART = LTD_SDT203-SPART  " 製品部門
AND KNVP~PARVW = LW_PARVW.         " 取引先機能

IF SY-SUBRC = 0.
SORT LTD_ENAME BY KUNNR ASCENDING   " 得意先コード
VKORG ASCENDING   " 販売組織
VTWEG ASCENDING   " 流通チャネル
SPART ASCENDING.  " 製品部門
ENDIF.
ENDIF.

**** START ADD BY ISID REN 2015/07/15 ****
*     販売伝票タイプの取得処理
PERFORM SEL_ZTEGSDT205
USING O_TD_SDT203     "承認対象データ
CHANGING LTD_ZTEGSDT205. "Sales Type Determinant

*     販売伝票の明細カテゴリの取得処理
PERFORM SEL_MVKE_T184
USING O_TD_SDT203     "承認対象データ
LTD_ZTEGSDT205  "Sales Type Determinant
CHANGING LTD_MVKE_T184.  "販売伝票の明細カテゴリ
**** END ADD BY ISID REN 2015/07/15 ****

**** START DEL 2015/03/03 iSiD19 ****
**   A-2-1-2-4．出荷プラントの情報を検索
*      LTD_SDT203[] = O_TD_SDT203[].
*
*      DELETE LTD_SDT203
*       WHERE DWERK IS NOT INITIAL.            " 出荷プラント
*
*      SORT LTD_SDT203 BY KUNNR ASCENDING      " 得意先コード
*                         VKORG ASCENDING      " 販売組織
*                         VTWEG ASCENDING      " 流通チャネル
*                         SPART ASCENDING.     " 製品部門
*
*      DELETE ADJACENT DUPLICATES FROM LTD_SDT203
*                            COMPARING KUNNR   " 得意先コード
*                                      VKORG   " 販売組織
*                                      VTWEG   " 流通チャネル
*                                      SPART.  " 製品部門
*
*      IF LTD_SDT203 IS NOT INITIAL.
*        SELECT KUNNR                          " 得意先コード
*               VKORG                          " 販売組織
*               VTWEG                          " 流通チャネル
*               SPART                          " 製品部門
*               VWERK                          " 出荷プラント
*          FROM KNVV
*          INTO TABLE LTD_KNVV
*           FOR ALL ENTRIES IN LTD_SDT203
*         WHERE KUNNR = LTD_SDT203-KUNNR       " 得意先コード
*           AND VKORG = LTD_SDT203-VKORG       " 販売組織
*           AND VTWEG = LTD_SDT203-VTWEG       " 流通チャネル
*           AND SPART = LTD_SDT203-SPART.      " 製品部門
*
*        IF SY-SUBRC = 0.
*          SORT LTD_KNVV BY KUNNR ASCENDING    " 得意先コード
*                           VKORG ASCENDING    " 販売組織
*                           VTWEG ASCENDING    " 流通チャネル
*                           SPART ASCENDING.   " 製品部門
*        ENDIF.
*      ENDIF.
**** END DEL 2015/03/03 iSiD19 ****

*     A-2-1-2-5．販売伝票タイプの検索
PERFORM GET_DATA_205_A USING O_TD_SDT203
CHANGING LTD_DATA_205.

IF LTD_DATA_205 IS NOT INITIAL.
LTD_DATA_205_TEM[] = LTD_DATA_205[].
SORT LTD_DATA_205_TEM BY AUART ASCENDING.
" 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205_TEM
COMPARING AUART." 販売伝票タイプ

SELECT AUART                          " 販売伝票タイプ
KALVG                          " 伝票決定区分
FROM TVAK
INTO TABLE LTD_KALVG
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART." 販売伝票タイプ

IF SY-SUBRC = 0.
SORT LTD_KALVG BY AUART ASCENDING.  " 販売伝票タイプ
ENDIF.
ENDIF.

LTD_203[] = O_TD_SDT203[].
SORT LTD_203 BY     KUNNR ASCENDING     " 得意先コード
VKORG ASCENDING     " 販売組織
VTWEG ASCENDING     " 流通チャネル
SPART ASCENDING.    " 製品部門

SELECT KUNNR                                " 得意先コード
VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALKS                                " 価格決定区分割当
FROM KNVV
INTO TABLE LTD_KALKS
FOR ALL ENTRIES IN LTD_203
WHERE KUNNR = LTD_203-KUNNR                " 得意先コード
AND VKORG = LTD_203-VKORG                " 販売伝票タイプ
AND VTWEG = LTD_203-VTWEG                " 販売組織
AND SPART = LTD_203-SPART.               " 製品部門

IF SY-SUBRC = 0.
SORT LTD_KALKS BY  KUNNR ASCENDING        " 得意先コード
VKORG ASCENDING        " 販売伝票タイプ
VTWEG ASCENDING        " 販売組織
SPART ASCENDING.       " 製品部門
ENDIF.

LTD_PROCESS[] = O_TD_SDT203[].
SORT LTD_PROCESS BY VKORG ASCENDING         " 販売組織
VTWEG ASCENDING         " 流通チャネル
SPART ASCENDING.        " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING VKORG       " 販売組織
VTWEG       " 流通チャネル
SPART.      " 製品部門

SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALVG                                " 伝票決定区分
KALKS                                " 価格決定区分割当
KARTV                                " 条件タイプ
FROM T683V
INTO TABLE LTD_COND_TYPE
FOR ALL ENTRIES IN LTD_PROCESS
WHERE VKORG = LTD_PROCESS-VKORG            " 販売伝票タイプ
AND VTWEG = LTD_PROCESS-VTWEG            " 販売組織
AND SPART = LTD_PROCESS-SPART.           " 製品部門

SORT LTD_COND_TYPE  BY VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING      " 製品部門
KALVG ASCENDING      " 伝票決定区分
KALKS ASCENDING.     " 価格決定区分割当
ENDAT.

**** START ADD BY ISID REN 2015/07/16 ****
*   初回承認の場合のみ　処理区分=固定値"1"
IF <LFS_ST_SDT203>-ZKBUNCC = CNS_KBUNCC_1.
*     出荷指示備考の情報を取得する
PERFORM READ_TEXT_OD_REMARK
USING <LFS_ST_SDT203>-SPRAS  "言語キー
<LFS_ST_SDT203>-VKORG  "販売組織
<LFS_ST_SDT203>-VTWEG  "流通チャネル
<LFS_ST_SDT203>-KUNNR  "得意先
<LFS_ST_SDT203>-MATNR  "品目
CHANGING
<LFS_ST_SDT203>-Z_SHP_REMARK1  "Outbound Delivery Remark(1)
<LFS_ST_SDT203>-Z_SHP_REMARK2. "Outbound Delivery Remark(2)

*     伝票タイプと明細カテゴリの初期提案の情報を取得する
*     販売伝票タイプの取得処理
CLEAR <LFS_ST_SDT203>-AUART.
READ TABLE LTD_ZTEGSDT205 TRANSPORTING AUART
INTO LST_ZTEGSDT205
WITH KEY BSART = <LFS_ST_SDT203>-BSART     "購買伝票タイプ
KNTTP = <LFS_ST_SDT203>-KNTTP     "勘定設定カテゴリ
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-AUART = LST_ZTEGSDT205-AUART.
ENDIF.

*     販売伝票の明細カテゴリの取得処理
CLEAR <LFS_ST_SDT203>-PSTYV.
READ TABLE LTD_MVKE_T184 TRANSPORTING PSTYV
INTO LST_MVKE_T184
WITH KEY AUART = <LFS_ST_SDT203>-AUART     "販売伝票タイプ
MATNR = <LFS_ST_SDT203>-MATNR     "品目コード
VKORG = <LFS_ST_SDT203>-VKORG     "販売組織
VTWEG = <LFS_ST_SDT203>-VTWEG     "流通チャネル
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-PSTYV = LST_MVKE_T184-PSTYV.
ENDIF.
ENDIF.
**** END ADD BY ISID REN 2015/07/16 ****

*   A-2-1-2-6．出荷先の情報を取得する。
IF <LFS_ST_SDT203>-ZKUNNR_S IS INITIAL.
**** START ADD 2015/03/03 iSiD19 ****
IF W_FLGHEADOF IS NOT INITIAL. "本社フラグ
**** END ADD 2015/03/03 iSiD19   ****
CLEAR LST_KNVP.
READ TABLE LTD_KNVP INTO LST_KNVP
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.

**** START ADD 2015/03/03 iSiD19 ****
IF SY-SUBRC = 0. "本社フラグ
**** END ADD 2015/03/03 iSiD19   ****
<LFS_ST_SDT203>-ZKUNNR_S = LST_KNVP-KUNN2.
" 出荷先

<LFS_ST_SDT203>-ZNAME1   = LST_KNVP-NAME1.
" 出荷先名称
**** START ADD 2015/03/03 iSiD19 ****
ELSE.
<LFS_ST_SDT203>-ZKUNNR_S = <LFS_ST_SDT203>-KUNNR."出荷先
<LFS_ST_SDT203>-ZNAME1   = <LFS_ST_SDT203>-NAME1."出荷先名称
ENDIF.

ELSE.
<LFS_ST_SDT203>-ZKUNNR_S = <LFS_ST_SDT203>-KUNNR."出荷先
<LFS_ST_SDT203>-ZNAME1   = <LFS_ST_SDT203>-NAME1."出荷先名称
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****
ENDIF.

**** START DEL 2015/03/03 iSiD19 ****
**   A-2-1-2‐7．最終需要者の情報を取得する。
*    IF <LFS_ST_SDT203>-ZKUNNR_ZJ IS INITIAL.
*      CLEAR LST_SDT204.
*      READ TABLE LTD_SDT204 INTO LST_SDT204
*                        WITH KEY MATNR = <LFS_ST_SDT203>-MATNR
*                                 VKORG = <LFS_ST_SDT203>-VKORG
*                        BINARY SEARCH.
*
*      <LFS_ST_SDT203>-ZKUNNR_ZJ = LST_SDT204-ZKUNNR_ZJ.
*      " 最終需要者
*
*      <LFS_ST_SDT203>-ZKUNNR_DS = LST_SDT204-ZKUNNR_DS.
*      " 最終需要者(商流)
*    ENDIF.
**** END DEL 2015/03/03 iSiD19 ****

*   A-2-1-2-8．営業員の情報を取得する。
IF <LFS_ST_SDT203>-ENAME IS INITIAL.
CLEAR LST_ENAME.
READ TABLE LTD_ENAME INTO LST_ENAME
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
BINARY SEARCH.

<LFS_ST_SDT203>-PERNR = LST_ENAME-PERNR. " 取引先の得意先コード

<LFS_ST_SDT203>-ENAME = LST_ENAME-ENAME. " 従業員氏名
ENDIF.

**** START DEL 2015/03/03 iSiD19 ****
**   A-2-1-2-9．出荷プラントの情報を検索
*    IF <LFS_ST_SDT203>-DWERK IS INITIAL.
*      CLEAR LST_KNVV.
*      READ TABLE LTD_KNVV INTO LST_KNVV
*                      WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
*                               VKORG = <LFS_ST_SDT203>-VKORG
*                               VTWEG = <LFS_ST_SDT203>-VTWEG
*                               SPART = <LFS_ST_SDT203>-SPART
*                      BINARY SEARCH.
*
*      <LFS_ST_SDT203>-DWERK = LST_KNVV-VWERK.
*    ENDIF.
**** END DEL 2015/03/03 iSiD19 ****

*   A-2-1-2-10．販売伝票タイプの設定処理
CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = <LFS_ST_SDT203>-BSART
KNTTP = <LFS_ST_SDT203>-KNTTP
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-AUART   = LST_DATA_205-AUART. " 販売伝票タイプ
<LFS_ST_SDT203>-ZABEZEI = LST_DATA_205-BEZEI.
" 販売伝票タイプテキスト
<LFS_ST_SDT203>-VBTYP   = LST_DATA_205-VBTYP.
" 販売管理伝票カテゴリ

*     伝票決定区分の取得処理
CLEAR LST_KALVG.
READ TABLE LTD_KALVG INTO LST_KALVG BINARY SEARCH
WITH KEY AUART = LST_DATA_205-AUART.

IF <LFS_ST_SDT203>-ZKBUNCC = CNS_KBUNCC_1     " 処理区分
AND <LFS_ST_SDT203>-STATUS = CNS_STATUS_C.  " ステータス
<LFS_ST_SDT203>-AUGRU = LST_DATA_205-AUGRU. " 受注理由
ENDIF.
ENDIF.

*   価格決定区分割当の取得処理
CLEAR LST_KALKS.
READ TABLE LTD_KALKS INTO LST_KALKS BINARY SEARCH
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART.

*   条件タイプの取得処理
CLEAR LST_COND_TYPE.
READ TABLE LTD_COND_TYPE INTO LST_COND_TYPE BINARY SEARCH
WITH KEY VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
KALVG = LST_KALVG-KALVG
KALKS = LST_KALKS-KALKS.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-KARTV = LST_COND_TYPE-KARTV.
ENDIF.

ENDLOOP.

ENDFORM.                    " EDIT_DATA_MAIN
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_MAIN1
*&---------------------------------------------------------------------*
*       A-2-3-1．以下の通り、承認対象データを取得する。
*----------------------------------------------------------------------*
*      -->I_TD_TVTA        ITAB:販売エリア
*      <--O_TD_SDT203      ITAB:承認対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM GET_DATA_MAIN1  USING I_TD_TVTA      TYPE TYP_TD_TVTA
CHANGING O_TD_SDT203    TYPE TYP_TD_ZTEGSDT203
O_W_ERRFLG     TYPE C.
DATA:
LTD_PA0001 TYPE STANDARD TABLE OF TYP_PA0001,
LTD_SDT203 TYPE TYP_TD_ZTEGSDT203,
LST_PA0001 TYPE TYP_PA0001.

FIELD-SYMBOLS:
<LFS_ST_SDT203> TYPE TYP_ZTEGSDT203.

SELECT ZTEGSDT203~VKORG                     " 販売組織
ZTEGSDT203~VTWEG                     " 流通チャネル
ZTEGSDT203~SPART                     " 製品部門
ZTEGSDT203~VKBUR                     " 営業所
ZTEGSDT203~VKGRP                     " 営業グループ
ZTEGSDT203~KUNNR                     " 受注先
KNA1~NAME1                           " 名称1
**** START ADD BY ISID REN 2015/07/15 ****
ZTEGSDT203~AUART                     "販売伝票タイプ
ZTEGSDT203~PSTYV                     "明細カテゴリ
**** END ADD BY ISID REN 2015/07/15 ****
**** START UPD BY ISID REN 2015/07/15 ****
*         ZTEGSDT203~MATNR                     " 品目コード
ZTEGSDT203~MATNR_SO AS MATNR         "品目コード(SO)
**** END UPD BY ISID REN 2015/07/15 ****
**** START UPD BY ISID REN 2015/08/28 ****
ZTEGSDT203~KDMAT                     "得意先品目
**** END UPD BY ISID REN 2015/08/28 ****
**** START DEL 2015/03/03 iSiD19 ****
*         ZTEGSDT203~TXZ01                     " テキスト (短)
**** END DEL 2015/03/03 iSiD19 ****
ZTEGSDT203~MENGE                     " 購買発注量
ZTEGSDT203~MEINS                     " 発注単位
ZTEGSDT203~NETPR                     " 正味価格
ZTEGSDT203~WAERS                     " 通貨コード
**** START ADD 2015/03/03 iSiD19 ****
ZTEGSDT203~LGORT_SO AS LGORT         "保管場所
**** END ADD 2015/03/03 iSiD19 ****
ZTEGSDT203~PEINH                     " 価格単位
ZTEGSDT203~BPRME                     " 購買発注価格単位
ZTEGSDT203~NETWR                     " 正味発注額
**** START ADD BY ISID REN 2015/07/15 ****
ZTEGSDT203~EVERS                     "出荷指示
ZTEGSDT203~NETPR_EU                  "正味価格EU
ZTEGSDT203~WAERK_EU                  "通貨EU
ZTEGSDT203~KPEIN_EU                  "価格条件単位EU
ZTEGSDT203~KMEIN_EU                  "条件単位EU
ZTEGSDT203~Z_SHP_REMARK1             "出荷指示備考(1)
ZTEGSDT203~Z_SHP_REMARK2             "出荷指示備考(2)
**** END ADD BY ISID REN 2015/07/15 ****
ZTEGSDT203~DWERK                     " 出荷プラント
ZTEGSDT203~ZKUNNR_S                  " 出荷先
KNA1_S~NAME1 AS ZNAME1               " 名称1
ZTEGSDT203~EINDT                     " 明細納入期日
ZTEGSDT203~ZTERM                     " 支払条件キー
ZTEGSDT203~EBELN                     " 購買伝票番号
ZTEGSDT203~AEDAT                     " レコード登録日
ZTEGSDT203~PERNR                     " 営業員
**** START UPD 2015/03/03 iSiD19 ****
*         ZTEGSDT203~ZKUNNR_ZJ                 " 最終需要者
*         ZTEGSDT203~ZKUNNR_DS                 " 最終需要者(商流)
ZTEGSDT203~Z_VEND_NAME_DT             "出荷先名（PO）
ZTEGSDT203~Z_ADDRESS1_DT              "出荷先住所1
ZTEGSDT203~Z_ADDRESS2_DT              "出荷先住所2
ZTEGSDT203~Z_ADDRESS3_DT              "出荷先住所3
ZTEGSDT203~Z_ADDRESS4_DT              "出荷先住所4
ZTEGSDT203~Z_TEL_DT                   "出荷先電話番号
ZTEGSDT203~Z_FAX_DT                   "出荷先FAX番号（PO）
ZTEGSDT203~INCO1    	                 "インコタームズ
ZTEGSDT203~INCO2                      "貿易条件
**** START ADD BY ISID REN 2015/08/06 ****
ZTEGSDT203~Z_LASTDEST                 "最終仕向地
**** END ADD BY ISID REN 2015/08/06 ****
ZTEGSDT203~Z_PURPOSE_TEXT             "用途（PO）
ZTEGSDT203~ZKUNNR_ZJ                  "最終需要者
**** START UPD BY ISID REN 2015/07/20 ****
*         KNA1~NAME1 AS ZNAME_ZJ                 "名称1
**** START UPD BY ISID REN 2015/08/21 ****
*         KNA1_J~NAME1 AS ZNAME_ZJ                 "名称1
KNA1_J~NAME2 AS ZNAME_ZJ_2                "名称2
KNA1_J~NAME3 AS ZNAME_ZJ_3                "名称3
**** END UPD BY ISID REN 2015/08/21 ****
**** END UPD BY ISID REN 2015/07/20 ****
ZTEGSDT203~ZKUNNR_ZE AS ZKUNNR_DS     "エンドユーザ（価格）
**** START UPD BY ISID REN 2015/07/20 ****
*         KNA1~NAME1 AS ZNAME_DS                 "名称1
**** START UPD BY ISID REN 2015/08/21 ****
*         KNA1_E~NAME1 AS ZNAME_DS                 "名称1
KNA1_E~NAME2 AS ZNAME_DS_2                "名称2
KNA1_E~NAME3 AS ZNAME_DS_3                "名称3
**** END UPD BY ISID REN 2015/08/21 ****
**** END UPD BY ISID REN 2015/07/20 ****
ZTEGSDT203~Z_PO_ITEM_TXT              "購買発注明細テキスト
ZTEGSDT203~SUBMI                      "一括番号
**** END UPD 2015/03/03 iSiD19 ****
ZTEGSDT203~AUGRU                     " 受注理由 (取引理由)
ZTEGSDT203~ZKBUNCC                   " 処理区分
ZTEGSDT203~STATUS                    " ステータス
ZTEGSDT203~EBELP                     " 購買伝票の明細番号
ZTEGSDT203~MSGTX                     " メッセージテキスト
ZTEGSDT203~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT203~BSART                     " 購買伝票タイプ
**** START ADD BY ISID REN 2015/08/06 ****
ZTEGSDT203~ERNAM                     "オブジェクト登録者名
**** END ADD BY ISID REN 2015/08/06 ****
**** START ADD BY ISID REN 2015/07/15 ****
KNA1~SPRAS                           "言語キー
**** END ADD BY ISID REN 2015/07/15 ****
**** START ADD BY ISID21 2015/09/22 ****
ZTEGSDT203~Z_ITEM_BSTKD             " 得意先発注番号
**** END ADD BY ISID21 2015/09/22 ****
FROM ZTEGSDT203
LEFT JOIN KNA1
ON ZTEGSDT203~KUNNR     =  KNA1~KUNNR   " 受注先
LEFT JOIN KNA1 AS KNA1_S
ON ZTEGSDT203~ZKUNNR_S  =  KNA1_S~KUNNR " 出荷先
**** START ADD 2015/03/03 iSiD19 ****
LEFT JOIN KNA1 AS KNA1_E
ON ZTEGSDT203~ZKUNNR_ZE  =  KNA1_E~KUNNR " 出荷先
LEFT JOIN KNA1 AS KNA1_J
ON ZTEGSDT203~ZKUNNR_ZJ  =  KNA1_J~KUNNR " 出荷先
**** END ADD 2015/03/03 iSiD19     ****
INTO CORRESPONDING FIELDS OF TABLE O_TD_SDT203
FOR ALL ENTRIES IN I_TD_TVTA
WHERE ZTEGSDT203~VKORG     =  P_VKORG      " 販売組織
AND ZTEGSDT203~VTWEG     =  I_TD_TVTA-VTWEG " 流通チャネル
AND ZTEGSDT203~SPART     =  I_TD_TVTA-SPART " 製品部門
AND ZTEGSDT203~VKBUR     IN S_VKBUR      " 営業所
AND ZTEGSDT203~VKGRP     IN S_VKGRP      " 営業グループ
AND ZTEGSDT203~Z_CRE_YMD IN S_DATE       " 登録年月日
AND ZTEGSDT203~ZKBUNCC   = CNS_KBUNCC_2  " 処理区分
AND ZTEGSDT203~STATUS    = CNS_STATUS_C. " ステータス

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
*   対象データが存在しません。(TBL = &1)
MESSAGE S006(ZMEGSD01) WITH CNS_TABLENM.
ELSE.
LTD_SDT203[] = O_TD_SDT203[].
SORT LTD_SDT203 BY PERNR ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING PERNR.    " 営業員

SELECT PERNR                              " 営業員
ENAME                              " 応募者氏名
FROM PA0001
INTO TABLE LTD_PA0001
FOR ALL ENTRIES IN LTD_SDT203
WHERE PERNR = LTD_SDT203-PERNR           " 営業員
AND BEGDA <= SY-DATUM                  " 開始日付
AND ENDDA >= SY-DATUM.                 " 終了日付

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
CLEAR LST_PA0001.
READ TABLE LTD_PA0001 INTO LST_PA0001
WITH KEY PERNR = <LFS_ST_SDT203>-PERNR
BINARY SEARCH.

<LFS_ST_SDT203>-ENAME = LST_PA0001-ENAME. " 応募者氏名

**** START ADD BY ISID REN 2015/08/21 ****
CONCATENATE <LFS_ST_SDT203>-ZNAME_ZJ_2  "名称2
<LFS_ST_SDT203>-ZNAME_ZJ_3  "名称3
INTO <LFS_ST_SDT203>-ZNAME_ZJ.   "最終需要者名称
CONCATENATE <LFS_ST_SDT203>-ZNAME_DS_2  "名称2
<LFS_ST_SDT203>-ZNAME_DS_3  "名称3
INTO <LFS_ST_SDT203>-ZNAME_DS.   "エンドユーザ（価格）名称
**** END ADD BY ISID REN 2015/08/21 ****
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_DATA_MAIN
*&---------------------------------------------------------------------*
*&      Form  ALV_OUTPUT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_TD_SDT203    ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM ALV_OUTPUT  USING I_TD_SDT203      TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_FIELDCAT   TYPE LVC_T_FCAT,
LST_LAYOUT     TYPE LVC_S_LAYO,
**** START ADD 2015/03/03 iSiD19 ****
LST_VARIANT_E TYPE DISVARIANT.       "Variant
**** END ADD 2015/03/03 iSiD19 ****

* 項目カタログの編集
PERFORM EDIT_FIELDCAT USING CNS_STNM008
CNS_STNM011
CHANGING LTD_FIELDCAT.

* レイアウト構造の編集
PERFORM EDIT_LAYOUT CHANGING LST_LAYOUT.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING I_TD_SDT203.

* ALV一覧形式で出力する
IF RB_ERR IS INITIAL.

**** START ADD 2015/03/03 iSiD19 ****
*   バリアントの管理を分けられそうです
LST_VARIANT_E-REPORT = SY-REPID.
IF RB_APP IS NOT INITIAL.
LST_VARIANT_E-HANDLE = '2001'.
ELSE.
LST_VARIANT_E-HANDLE = '2002'.
ENDIF.
**** END ADD 2015/03/03 iSiD19 ****

CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
**** START ADD 2015/03/03 iSiD19 ****
IS_VARIANT               = LST_VARIANT_E
**** END ADD 2015/03/03 iSiD19 ****
TABLES
T_OUTTAB                 = TD_APP_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ELSE.
**** START ADD 2015/03/03 iSiD19 ****
*   バリアントの管理を分けられそうです
LST_VARIANT_E-REPORT = SY-REPID.
LST_VARIANT_E-HANDLE = '2003'.
**** END ADD 2015/03/03 iSiD19 ****

CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY_LVC'
EXPORTING
I_CALLBACK_PROGRAM       = SY-REPID
I_CALLBACK_PF_STATUS_SET = CNS_PF_STATUS
I_CALLBACK_USER_COMMAND  = CNS_USER_CMD
IS_LAYOUT_LVC            = LST_LAYOUT
IT_FIELDCAT_LVC          = LTD_FIELDCAT
**** START ADD 2015/03/03 iSiD19 ****
IS_VARIANT               = LST_VARIANT_E
**** END ADD 2015/03/03 iSiD19 ****
TABLES
T_OUTTAB                 = TD_ERR_ALV
EXCEPTIONS
PROGRAM_ERROR            = 1
OTHERS                   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
ENDIF.

ENDFORM.                    " ALV_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*       A-3．画面出力
*----------------------------------------------------------------------*
*      -->I_W_STRNM08    構造名
*      -->I_W_STRNM11    構造名
*      <--O_TD_SDT203    ITAB:項目カタログ
*----------------------------------------------------------------------*
FORM EDIT_FIELDCAT USING I_W_STRNM08     TYPE TABNAME
I_W_STRNM11     TYPE TABNAME
CHANGING O_TD_FIELDCAT   TYPE LVC_T_FCAT.
* A-3-1．データのALV一覧出力
DATA:
LST_FIELDCAT TYPE LVC_S_FCAT.

CLEAR O_TD_FIELDCAT.

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = I_W_STRNM08
CHANGING
CT_FIELDCAT            = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

LEAVE LIST-PROCESSING.
ENDIF.

LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.

*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = I_W_STRNM11
CHANGING
CT_FIELDCAT            = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

LEAVE LIST-PROCESSING.
ENDIF.

LST_FIELDCAT-FIELDNAME = 'CHK'.
LST_FIELDCAT-CHECKBOX  = ABAP_ON.
LST_FIELDCAT-NO_OUT    = ABAP_ON.
LST_FIELDCAT-TECH      = ABAP_ON.
APPEND LST_FIELDCAT TO  O_TD_FIELDCAT.
CLEAR LST_FIELDCAT.

*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = I_W_STRNM08
CHANGING
CT_FIELDCAT            = O_TD_FIELDCAT
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.

LEAVE LIST-PROCESSING.
ENDIF.

WHEN OTHERS.
*     処理なし
ENDCASE.

**** START ADD BY ISID REN 2015/07/29 ****
LST_FIELDCAT-NO_ZERO = ABAP_TRUE.
MODIFY O_TD_FIELDCAT
FROM LST_FIELDCAT
TRANSPORTING NO_ZERO "ALV コントロール: 出力のゼロを非表示
WHERE FIELDNAME = 'KPEIN'          "価格条件単位
OR FIELDNAME ='ZMKPEIN'          "マスタ価格条件単位
OR FIELDNAME = 'Z_KPEIN_VBAP'.  "リストビューア・/
**** END ADD BY ISID REN 2015/07/29 ****

ENDFORM.                    " EDIT_FIELDCAT
*&---------------------------------------------------------------------*
*&      Form  EDIT_LAYOUT
*&---------------------------------------------------------------------*
*       レイアウト構造の編集
*----------------------------------------------------------------------*
*      <--O_W_LAYOUT     レイアウト
*----------------------------------------------------------------------*
FORM EDIT_LAYOUT CHANGING O_ST_LAYOUT   TYPE LVC_S_LAYO.
O_ST_LAYOUT-CWIDTH_OPT = ABAP_ON.
O_ST_LAYOUT-ZEBRA      = ABAP_ON.
**** START ADD BY ISID REN 2015/07/29 ****
O_ST_LAYOUT-CWIDTH_OPT = ABAP_TRUE.
**** END ADD BY ISID REN 2015/07/29 ****

CASE ABAP_ON.
*   A-3-1-1．ラジオボタン「承認一覧(Approve)」を指定した場合。
WHEN RB_APP.
O_ST_LAYOUT-BOX_FNAME = 'CHK'.

*   A-3-1-2．ラジオボタン「エラーリカバリ(Error recovery)」を指定した
*   場合。
WHEN RB_ERR.
O_ST_LAYOUT-BOX_FNAME = 'CHK'.

*   A-3-1-3．ラジオボタン「承認済受注未登録一覧(Approved List)」を指定
*   した場合。
WHEN RB_LIST.
*     処理なし
WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " EDIT_LAYOUT
*&---------------------------------------------------------------------*
*&      Form  EDIT_ALVDATA
*&---------------------------------------------------------------------*
*       ALV出力データの編集
*----------------------------------------------------------------------*
*      -->I_TD_SDT203      構造名
*      <--O_TD_APP_ALV    ITAB:承認済受注未登録一覧
*      <--O_TD_ERR_ALV    ITAB:エラー一覧
*----------------------------------------------------------------------*
FORM EDIT_ALVDATA USING I_TD_SDT203  TYPE TYP_TD_ZTEGSDT203.
DATA:
LST_SDT203      TYPE TYP_ZTEGSDT203,
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

**** START ADD 2015/03/03 iSiD19 ****
DATA:
LTD_MATERDES   TYPE TYP_TD_MATERDES,
LTD_PLANTINFO  TYPE TYP_TD_PLANTINFO,
LTD_INCOTERM   TYPE TYP_TD_INCOTERM,
LTD_PAYTERMS   TYPE TYP_TD_PAYTERMS,
LTD_ODREASON   TYPE TYP_TD_ODREASON,
LTD_STORELOC   TYPE TYP_TD_STORELOC,
LTD_TVAUT      TYPE TYP_TD_TVAUT,
LTD_T001L      TYPE TYP_TD_T001L.
**** END ADD 2015/03/03 iSiD19   ****

REFRESH:
TD_APP_ALV,
TD_ERR_ALV.

**** START ADD 2015/03/03 iSiD19 ****
*  ALV表示用項目を取得する
PERFORM GET_ALV_REFDATA USING    I_TD_SDT203
CHANGING LTD_MATERDES
LTD_PLANTINFO
LTD_INCOTERM
LTD_PAYTERMS
LTD_ODREASON
LTD_STORELOC
LTD_TVAUT
LTD_T001L.
**** END ADD 2015/03/03 iSiD19   ****

LOOP AT I_TD_SDT203 INTO LST_SDT203.
LST_APP_ALVDATA-VKORG   = LST_SDT203-VKORG." 販売組織
LST_APP_ALVDATA-VTWEG   = LST_SDT203-VTWEG." 流通チャネル
LST_APP_ALVDATA-SPART   = LST_SDT203-SPART." 製品部門
LST_APP_ALVDATA-VKBUR   = LST_SDT203-VKBUR." 営業所
LST_APP_ALVDATA-VKGRP   = LST_SDT203-VKGRP." 営業グループ
LST_APP_ALVDATA-KUNNR   = LST_SDT203-KUNNR." 受注先
LST_APP_ALVDATA-NAME1   = LST_SDT203-NAME1." 名称 1
LST_APP_ALVDATA-MATNR   = LST_SDT203-MATNR." 品目コード
**** START DEL BY ISID REN 2015/07/16 ****
LST_APP_ALVDATA-KDMAT   = LST_SDT203-KDMAT. "得意先品目
**** END DEL BY ISID REN 2015/07/16 ****
**** START DEL 2015/03/03 iSiD19 ****
*   LST_APP_ALVDATA-ARKTX   = LST_SDT203-TXZ01." 受注明細のテキスト (短)
**** END DEL 2015/03/03 iSiD19 ****
LST_APP_ALVDATA-KWMENG  = LST_SDT203-MENGE." 累積受注数量 (販売単位)
LST_APP_ALVDATA-VRKME   = LST_SDT203-MEINS." 販売単位
LST_APP_ALVDATA-NETPR   = LST_SDT203-NETPR." 正味価格
LST_APP_ALVDATA-WAERK   = LST_SDT203-WAERS." 販売伝票通貨
LST_APP_ALVDATA-KPEIN   = LST_SDT203-PEINH." 価格条件単位
LST_APP_ALVDATA-ZVRKME  = LST_SDT203-BPRME." 販売単位
LST_APP_ALVDATA-NETWR   = LST_SDT203-NETWR." 正味価格
LST_APP_ALVDATA-WERKS   = LST_SDT203-DWERK.
" プラント (自社または外部)
LST_APP_ALVDATA-ZEKUNNR = LST_SDT203-ZKUNNR_S. " 出荷先
LST_APP_ALVDATA-ZEKNAME = LST_SDT203-ZNAME1.   " 出荷先名称
LST_APP_ALVDATA-EDATU   = LST_SDT203-EINDT.    " 納入日程日付
LST_APP_ALVDATA-ZEEMNAM = LST_SDT203-ENAME.    " 従業員名称
LST_APP_ALVDATA-DZTERM  = LST_SDT203-ZTERM.    " 支払条件キー
LST_APP_ALVDATA-BSTKD   = LST_SDT203-EBELN.    " 得意先発注番号
LST_APP_ALVDATA-BSTDK   = LST_SDT203-AEDAT.    " 得意先発注日付
LST_APP_ALVDATA-EBELP   = LST_SDT203-EBELP.    " 購買伝票の明細番号
LST_APP_ALVDATA-ZABEZEI = LST_SDT203-ZABEZEI.  " 内容説明
LST_APP_ALVDATA-AUGRU   = LST_SDT203-AUGRU.    " 受注理由 (取引理由)
LST_APP_ALVDATA-PERNR   = LST_SDT203-PERNR.    " 営業員
**** START DEL 2015/03/03 iSiD19 ****
*    LST_APP_ALVDATA-ZKUNNR_ZJ = LST_SDT203-ZKUNNR_ZJ. "最終需要者
*    LST_APP_ALVDATA-ZKUNNR_DS = LST_SDT203-ZKUNNR_DS. "最終需要者(商流)
**** END DEL 2015/03/03 iSiD19 ****
LST_APP_ALVDATA-VBTYP   = LST_SDT203-VBTYP. "販売管理伝票カテゴリ
LST_APP_ALVDATA-KARTV   = LST_SDT203-KARTV. " 条件タイプ

**** START ADD 2015/03/03 iSiD19 ****
LST_APP_ALVDATA-LGORT          = LST_SDT203-LGORT.
LST_APP_ALVDATA-Z_VEND_NAME_DT = LST_SDT203-Z_VEND_NAME_DT.
"名称 （Master）
LST_APP_ALVDATA-Z_ADDRESS1_DT = LST_SDT203-Z_ADDRESS1_DT.
"出荷先住所1
LST_APP_ALVDATA-Z_ADDRESS2_DT = LST_SDT203-Z_ADDRESS2_DT.
"出荷先住所2
LST_APP_ALVDATA-Z_ADDRESS3_DT = LST_SDT203-Z_ADDRESS3_DT.
"出荷先住所3
LST_APP_ALVDATA-Z_ADDRESS4_DT = LST_SDT203-Z_ADDRESS4_DT.
"出荷先住所4
CONCATENATE LST_SDT203-Z_ADDRESS1_DT
LST_SDT203-Z_ADDRESS2_DT
LST_SDT203-Z_ADDRESS3_DT
LST_SDT203-Z_ADDRESS4_DT
INTO LST_APP_ALVDATA-Z_ADDRESS_DT.
"出荷先住所1~4（PO）
LST_APP_ALVDATA-Z_TEL_DT = LST_SDT203-Z_TEL_DT.
"出荷先電話番号（PO）
LST_APP_ALVDATA-Z_FAX_DT = LST_SDT203-Z_FAX_DT.
"出荷先FAX番号（PO）
LST_APP_ALVDATA-INCO1 = LST_SDT203-INCO1.
"インコタームズ (1)
LST_APP_ALVDATA-INCO2 = LST_SDT203-INCO2.
"インコタームズ (2)
LST_APP_ALVDATA-Z_PURPOSE_TEXT = LST_SDT203-Z_PURPOSE_TEXT.
"用途（PO）
LST_APP_ALVDATA-ZKUNNR_ZJ = LST_SDT203-ZKUNNR_ZJ.
"最終需要者
LST_APP_ALVDATA-ZNAME_ZJ = LST_SDT203-ZNAME_ZJ.
"名称1
**** START DEL BY ISID REN 2015/07/16 ****
*    LST_APP_ALVDATA-ZKUNNR_DS = LST_SDT203-ZKUNNR_DS.  "最終需要者
*    LST_APP_ALVDATA-ZNAME_DS = LST_SDT203-ZNAME_DS.    "名称1
**** END DEL BY ISID REN 2015/07/16 ****
LST_APP_ALVDATA-Z_PO_ITEM_TXT = LST_SDT203-Z_PO_ITEM_TXT.
"購買発注明細テキスト
LST_APP_ALVDATA-SUBMI = LST_SDT203-SUBMI.
"一括番号 (見積依頼/見積書)

LST_APP_ALVDATA-AUART   = LST_SDT203-AUART.    " 販売伝票タイプ

**** START ADD BY ISID REN 2015/07/16 ****
LST_APP_ALVDATA-EVERS	= LST_SDT203-EVERS. "出荷指示
LST_APP_ALVDATA-Z_ENDUSER_CD
= LST_SDT203-ZKUNNR_DS. "エンドユーザ(価格)
LST_APP_ALVDATA-Z_NAME1_KNA1 = LST_SDT203-ZNAME_DS. "名称
LST_APP_ALVDATA-Z_NETPR_VBAP = LST_SDT203-NETPR_EU. "正味価格(EU)
LST_APP_ALVDATA-Z_WAERK_VBAP = LST_SDT203-WAERK_EU. "販売伝票通貨
LST_APP_ALVDATA-Z_KPEIN_VBAP
= LST_SDT203-KPEIN_EU.      "リストビューア・/
LST_APP_ALVDATA-Z_VRKME_VBAP = LST_SDT203-KMEIN_EU. "販売単位
LST_APP_ALVDATA-Z_TDLINE_1
= LST_SDT203-Z_SHP_REMARK1. "テキスト行(1)
LST_APP_ALVDATA-Z_TDLINE_2
= LST_SDT203-Z_SHP_REMARK2. "テキスト行(2)
LST_APP_ALVDATA-PSTYV = LST_SDT203-PSTYV. "明細カテゴリ (販売伝票)
LST_APP_ALVDATA-SPRAS = LST_SDT203-SPRAS. "言語キー
**** END ADD BY ISID REN 2015/07/16 ****

**** START ADD BY ISID REN 2015/08/06 ****
LST_APP_ALVDATA-ERNAM
= LST_SDT203-ERNAM.    "オブジェクト登録者名
LST_APP_ALVDATA-INCO2      = LST_SDT203-INCO2.      "取引条件
LST_APP_ALVDATA-Z_LASTDEST = LST_SDT203-Z_LASTDEST. "最終仕向地
**** END ADD BY ISID REN 2015/08/06 ****

*    ALV表示用項目の読み込み
PERFORM READ_ALV_REFDATA USING     LST_SDT203
LTD_MATERDES
LTD_PLANTINFO
LTD_INCOTERM
LTD_PAYTERMS
LTD_ODREASON
LTD_STORELOC
LTD_TVAUT
LTD_T001L
CHANGING LST_APP_ALVDATA.
**** END UPD 2015/03/03 iSiD19   ****

**** START ADD 2015/09/22 iSiD21 ****
* 販売価格マスタの販売情報を追加設定する。
IF LST_SDT203-MATNR IS NOT INITIAL.
PERFORM GET_MASTER_PRICE
USING LST_SDT203-VKORG
LST_SDT203-VTWEG
LST_SDT203-SPART
LST_SDT203-KUNNR
LST_SDT203-KDMAT
LST_SDT203-MATNR
LST_SDT203-MENGE
LST_SDT203-MEINS
CHANGING
LST_APP_ALVDATA-ZMNETPR
LST_APP_ALVDATA-ZMWAERK
LST_APP_ALVDATA-ZMKPEIN
LST_APP_ALVDATA-ZMZVRKME.
ENDIF.

LST_APP_ALVDATA-Z_ITEM_BSTKD = LST_SDT203-Z_ITEM_BSTKD.  "得意先発注番号
**** END ADD 2015/09/22 iSiD21     ****

IF RB_ERR IS INITIAL.
APPEND LST_APP_ALVDATA TO TD_APP_ALV.
ELSE.
**** START UPD BY ISID REN 2015/07/14 ****
*      LST_ERR_ALVDATA = LST_APP_ALVDATA.
MOVE-CORRESPONDING LST_APP_ALVDATA TO LST_ERR_ALVDATA.
**** END UPD BY ISID REN 2015/07/14 ****

**** START UPD 2015/04/24 ISID11 ****
*      LST_ERR_ALVDATA-MSGTX   = LST_SDT203-MSGTX.
IF LST_SDT203-MSGNO IS NOT INITIAL.
MESSAGE ID          LST_SDT203-MSGID
TYPE     CNS_MSG_S
NUMBER LST_SDT203-MSGNO
WITH       LST_SDT203-MSGV1
LST_SDT203-MSGV2
LST_SDT203-MSGV3
LST_SDT203-MSGV4
INTO        LST_ERR_ALVDATA-MSGTX.
ENDIF.
**** END UPD 2015/04/24 ISID11 ****
" メッセージテキスト
APPEND LST_ERR_ALVDATA TO TD_ERR_ALV.
ENDIF.

CLEAR:
LST_APP_ALVDATA,
LST_ERR_ALVDATA.

ENDLOOP.

SORT TD_APP_ALV BY VKORG ASCENDING          " 販売組織
VTWEG ASCENDING          " 流通チャネル
SPART ASCENDING          " 製品部門
BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

SORT TD_ERR_ALV BY VKORG ASCENDING          " 販売組織
VTWEG ASCENDING          " 流通チャネル
SPART ASCENDING          " 製品部門
BSTKD ASCENDING          " 発注番号
EBELP ASCENDING.         " 購買伝票の明細番号

ENDFORM.                    " EDIT_ALVDATA
*&---------------------------------------------------------------------*
*&      Form  SET_STATUS
*&---------------------------------------------------------------------*
*       ALV画面のステータスの設定
*----------------------------------------------------------------------*
*      -->I_TD_EXTAB       ITAB:ユーザ例外
*----------------------------------------------------------------------*
FORM SET_STATUS USING I_TD_EXTAB TYPE SLIS_T_EXTAB.
DATA:
LST_EXTAB TYPE SLIS_EXTAB.

REFRESH:
I_TD_EXTAB.

CASE ABAP_ON.
*  ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
SET TITLEBAR 'TITLE_APP'.
SET PF-STATUS 'STATUS_APP'.

*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_ERR'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB.

*   ラジオボタン「承認済受注未登録一覧(Approved List)」を指定した場合
WHEN RB_LIST.
LST_EXTAB-FCODE = '&ALL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = '&SAL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'APP'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'MODI'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
LST_EXTAB-FCODE = 'DEL'.
APPEND LST_EXTAB TO I_TD_EXTAB.
CLEAR LST_EXTAB.
SET TITLEBAR 'TITLE_LIST'.
SET PF-STATUS 'STATUS_APP' EXCLUDING I_TD_EXTAB.

WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " SET_STATUS
*&---------------------------------------------------------------------*
*&      Form  SELECT_DATA
*&---------------------------------------------------------------------*
*       対象データを選択
*----------------------------------------------------------------------*
*      <--O_TD_SELFIELD     ITAB:選択対象データ
*----------------------------------------------------------------------*
FORM SELECT_DATA CHANGING O_TD_SELFIELD TYPE TYP_TD_ERRALVDATA.
DATA:
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

CASE ABAP_ON.
*   ラジオボタン「承認一覧(Approve)」を指定した場合
WHEN RB_APP.
LOOP AT TD_APP_ALV INTO LST_APP_ALVDATA
WHERE CHK IS NOT INITIAL.
MOVE-CORRESPONDING LST_APP_ALVDATA TO LST_ERR_ALVDATA.
APPEND LST_ERR_ALVDATA TO O_TD_SELFIELD.
CLEAR LST_ERR_ALVDATA.
ENDLOOP.

*   ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
WHEN RB_ERR.
O_TD_SELFIELD = TD_ERR_ALV.
DELETE O_TD_SELFIELD WHERE CHK IS INITIAL.

WHEN OTHERS.
*   処理なし
ENDCASE.

ENDFORM.                    " SELECT_DAT
*&---------------------------------------------------------------------*
*&      Form  POP_CONFIRM
*&---------------------------------------------------------------------*
*       POP確認
*----------------------------------------------------------------------*
*      -->I_W_TITLEBAR     TITLEBAR
*      -->I_W_QUESTION     TEXT_QUESTION
*      -->I_W_BUTTON1      TEXT_BUTTON_1
*      -->I_W_BUTTON2      TEXT_BUTTON_2
*      <--O_W_ANSWER       ANSWER
*----------------------------------------------------------------------*
FORM POP_CONFIRM USING I_W_TITLEBAR TYPE ANY
I_W_QUESTION TYPE ANY
I_W_BUTTON1  TYPE ANY
I_W_BUTTON2  TYPE ANY
CHANGING O_W_ANSWER   TYPE C.

CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TITLEBAR              = I_W_TITLEBAR
TEXT_QUESTION         = I_W_QUESTION
TEXT_BUTTON_1         = I_W_BUTTON1
TEXT_BUTTON_2         = I_W_BUTTON2
DISPLAY_CANCEL_BUTTON = SPACE
IMPORTING
ANSWER                = O_W_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND        = 1
OTHERS                = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " POP_CONFIRM
*&---------------------------------------------------------------------*
*&      Form  LOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロック処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:ロック処理の対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM LOCK_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_W_ERRFLG   TYPE C.
DATA:
LW_EBELN        TYPE EBELN,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LTD_PROCESS_TEM TYPE TYP_TD_ERRALVDATA.

LTD_PROCESS[] = I_TD_PROCESS[].

SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.

LOOP AT LTD_PROCESS INTO LST_PROCESS.
LW_EBELN = LST_PROCESS-BSTKD.

CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
EXPORTING
MODE_ZTEGSDT203 = 'E'
EBELN           = LW_EBELN
**** START ADD BY ISID REN 2015/08/21 ****
EBELP           = LST_PROCESS-EBELP
**** END ADD BY ISID REN 2015/08/21 ****
EXCEPTIONS
FOREIGN_LOCK    = 1
SYSTEM_FAILURE  = 2
OTHERS          = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID
**** START UPD BY ISID REN 2015/08/21 ****
*        TYPE   CNS_MSG_E
TYPE   CNS_MSG_S
**** END UPD BY ISID REN 2015/08/21 ****
NUMBER SY-MSGNO
WITH   SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
**** START ADD BY ISID REN 2015/08/21 ****
DISPLAY LIKE CNS_MSG_E.
**** END ADD BY ISID REN 2015/08/21 ****

*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS_TEM.
O_W_ERRFLG = ABAP_ON.

RETURN.
ELSE.
APPEND LST_PROCESS TO LTD_PROCESS_TEM.
ENDIF.
ENDLOOP.

ENDFORM.                    " LOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_TD_ALVDATA     ITAB:ロックの解除の対象データ
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203 USING I_TD_ALVDATA TYPE TYP_TD_ERRALVDATA.
DATA:
LST_ALVDATA   TYPE TYP_ERR_ALVDATA,
LW_EBELN      TYPE EBELN.

**** START UPD BY ISID REN 2015/08/21 ****
*  LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
*    LW_EBELN = LST_ALVDATA-BSTKD.
*    CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
*      EXPORTING
*        MODE_ZTEGSDT203 = 'E'
*        EBELN           = LW_EBELN.
*  ENDLOOP.
CALL FUNCTION 'DEQUEUE_ALL'.
**** END UPD BY ISID REN 2015/08/21 ****

ENDFORM.                    " UNLOCK_ZTEGSDT203
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203
*&---------------------------------------------------------------------*
*       B-2-2．受発注連携データのステータス更新処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:更新処理の対象データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203 USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_W_ERRFLG   TYPE C.
DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LW_DATE       TYPE SY-DATUM,
LW_TIME       TYPE SY-UZEIT.

LW_DATE = SY-DATUM.
LW_TIME = SY-UZEIT.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2    " 処理区分
STATUS       = CNS_STATUS_D    " ステータス
Z_MOD_YMD    = LW_DATE         " 更新年月日
Z_MOD_HMS    = LW_TIME         " 更新時分秒
Z_MOD_USERID = SY-UNAME        " 更新ユーザ
**** START ADD 2015/03/03 iSiD19 ****
DWERK        = LST_PROCESS-WERKS      "出荷プラント
ZTERM        = LST_PROCESS-DZTERM     "支払条件
LGORT_SO     = LST_PROCESS-LGORT      "保管場所
**** END ADD 2015/03/03 iSiD19 ****
WHERE EBELN        = LST_PROCESS-BSTKD      "購買伝票番号
AND EBELP        = LST_PROCESS-EBELP.     "購買伝票の明細番号

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
ROLLBACK WORK.
*     データ更新に失敗しました(TBL = &1)
MESSAGE S024(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.

*     ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_PROCESS.
ENDIF.
ENDLOOP.

ENDFORM.                    " UPDATE_ZTEGSDT203

*&---------------------------------------------------------------------*
*&      Form  DISPLAY_ALV_AGAIN
*&---------------------------------------------------------------------*
*       B-3．ALV画面を再表示処理
*----------------------------------------------------------------------*
FORM DISPLAY_ALV_AGAIN.
DATA:
LTD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203,
LW_ERRFLG      TYPE C.

*  ラジオボタン「承認一覧(Approve)」を指定した場合
IF RB_APP IS NOT INITIAL.
*   A-2-1-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_1
CNS_STATUS_C
CNS_KBUNCC_2
CNS_STATUS_A
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL .
CLEAR TD_APP_ALV.
RETURN.
ENDIF.

*   A-2-1-2．承認一覧の関連情報を取得
PERFORM EDIT_DATA_MAIN CHANGING LTD_ZTEGSDT203.
ENDIF.

* ラジオボタン「エラーリカバリ(Error recovery)」を指定した場合
IF RB_ERR IS NOT INITIAL.
*   A-2-2-1．以下の通り、承認対象データを取得する。
PERFORM GET_DATA_MAIN USING CNS_KBUNCC_2
CNS_STATUS_E
CNS_KBUNCC_3
CNS_STATUS_E
TD_TVTA
CHANGING LTD_ZTEGSDT203
LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL .
CLEAR TD_ERR_ALV.
RETURN.
ENDIF.

*   販売伝票タイプを取得
PERFORM GET_DATA_205 CHANGING LTD_ZTEGSDT203.
ENDIF.

* ALV出力データの編集
PERFORM EDIT_ALVDATA USING LTD_ZTEGSDT203.

ENDFORM.                    " DISPLAY_ALV_AGAIN
*&---------------------------------------------------------------------*
*&      Form  EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*       C-2-1．シミュレーション対象データの補足処理。
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM EDIT_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA.

**** START ADD 2015/03/03 iSiD19 ****
IF W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ;ON
RETURN.
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****

LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

REFRESH O_TD_PROCESS.

LOOP AT I_TD_APP_ALV INTO LST_APP_ALV.
READ TABLE LTD_PROCESS TRANSPORTING NO FIELDS
WITH KEY BSTKD = LST_APP_ALV-BSTKD
BINARY SEARCH.

IF SY-SUBRC = 0.
MOVE-CORRESPONDING LST_APP_ALV TO LST_PROCESS_TEM.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDIF.
ENDLOOP.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*&      Form  BAPI_SALESORDER_CREAT
*&---------------------------------------------------------------------*
*       C-2-2．受注シミュレーション処理を行う。
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS     ITAB:処理の対象データ
*      <--O_TD_UPDATE      ITAB;更新対象データ
*      <--O_W_ERRFLG       BAPIエラーフラッグ
*      <--O_TD_MESSAGE     ITAB:BAPIエラーメッセージ
*----------------------------------------------------------------------*
FORM BAPI_SALESORDER_CREAT USING I_TD_PROCESS TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_UPDATE  TYPE TYP_TD_ALVDATA
O_W_ERRFLG   TYPE C
O_TD_MESSAGE TYPE TYP_TD_BAPIMSG.
DATA:
LST_PROCESS       TYPE TYP_ERR_ALVDATA,
LST_TEM_PROCESS   TYPE TYP_TEM_ALVDATA,
LST_TEM_PROCESS1  TYPE TYP_TEM_ALVDATA,
LTD_TEM_PROCESS   TYPE TYP_TD_ALVDATA,
LST_HEADER_IN     TYPE BAPISDHD1,
LST_ORDER_PARTNER TYPE BAPIPARNR,
LTD_ORDER_PARTNER TYPE STANDARD TABLE OF BAPIPARNR,
LST_ITEMS_IN      TYPE BAPISDITM,
LTD_ITEMS_IN      TYPE STANDARD TABLE OF BAPISDITM,
LST_SCHEDULES     TYPE BAPISCHDL,
LTD_SCHEDULES     TYPE STANDARD TABLE OF BAPISCHDL,
LST_CONDITIONS    TYPE BAPICOND,
LTD_CONDITIONS    TYPE STANDARD TABLE OF BAPICOND,
**** START ADD 2015/03/03 iSiD19 ****
LTD_ORDER_TEXT    TYPE STANDARD TABLE OF BAPISDTEXT,
LST_ORDER_TEXT    TYPE BAPISDTEXT,
LTD_PARTNERADD    TYPE STANDARD TABLE OF BAPIADDR1,
LST_PARTNERADD    TYPE BAPIADDR1,
LW_ADRNR          TYPE KNA1-ADRNR,
LST_ADRC          TYPE ADRC,
LTD_ADRC          TYPE TYP_TD_ADRC,
LST_ADRC_E        TYPE ADRC,
**** END ADD 2015/03/03 iSiD19   ****
**** START ADD BY ISID REN 2015/08/11 ****
LW_TABIX          TYPE I,
LW_NEW_FLG        TYPE FLAG,
LW_END_FLG        TYPE FLAG,
LW_SIMERR_FLG   TYPE FLAG,
**** END ADD BY ISID REN 2015/08/11 ****
LW_NUMBER         TYPE POSNR_VA,
LW_COND_VALUE     TYPE BAPICURR-BAPICURR,
LTD_RETURN        TYPE STANDARD TABLE OF BAPIRET2,
LST_RETURN        TYPE BAPIRET2,
LST_MESSAGE       TYPE TYP_BAPIMSG,
LTD_MESSAGE       TYPE STANDARD TABLE OF TYP_BAPIMSG,
LST_SWITCH        TYPE BAPISDLS.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
MOVE-CORRESPONDING LST_PROCESS TO LST_TEM_PROCESS.

**** START ADD 2015/03/03 iSiD19 ****
LST_TEM_PROCESS-LGPRO = LST_PROCESS-LGORT."保管場所
**** END ADD 2015/03/03 iSiD19 ****

APPEND LST_TEM_PROCESS TO LTD_TEM_PROCESS.
CLEAR LST_TEM_PROCESS.
ENDLOOP.

**** START ADD 2015/03/03 iSiD19 ****
* マニュアル SD 伝票アドレスの抽出
PERFORM F_GET_ADRC CHANGING LTD_ADRC.
**** END ADD 2015/03/03 iSiD19 ****

LOOP AT LTD_TEM_PROCESS INTO LST_TEM_PROCESS1.
LST_TEM_PROCESS = LST_TEM_PROCESS1.

**** START UPD BY ISID REN 2015/08/11 ****
*    AT NEW BSTKD.
LW_TABIX = SY-TABIX.

CLEAR: LW_NEW_FLG,
LW_END_FLG.

AT NEW BSTKD.
LW_NEW_FLG = ABAP_TRUE.
ENDAT.

*   販売伝票単一明細の場合、且つ販売伝票複数明細の一件目の場合
IF   W_FLGSOSGL IS NOT INITIAL "販売伝票単一明細フラグ
OR LW_NEW_FLG = ABAP_TRUE.

*     クリア
CLEAR: LW_NUMBER,
LST_HEADER_IN,
LTD_CONDITIONS,
LTD_ITEMS_IN,
LTD_SCHEDULES,
LTD_PARTNERADD,
LTD_ORDER_TEXT,
LTD_ORDER_PARTNER.
**** END UPD BY ISID REN 2015/08/11 ****

*     @受注伝票ヘッダ
LST_HEADER_IN-DOC_TYPE   = LST_TEM_PROCESS-AUART. "販売伝票タイプ
LST_HEADER_IN-SALES_ORG  = LST_TEM_PROCESS-VKORG. "販売組織
LST_HEADER_IN-DISTR_CHAN = LST_TEM_PROCESS-VTWEG. "流通チャネル
LST_HEADER_IN-DIVISION   = LST_TEM_PROCESS-SPART. "製品部門
LST_HEADER_IN-SALES_GRP  = LST_TEM_PROCESS-VKGRP. "営業グループ
LST_HEADER_IN-SALES_OFF  = LST_TEM_PROCESS-VKBUR. "営業所
LST_HEADER_IN-PURCH_NO_C = LST_TEM_PROCESS-BSTKD. "得意先発注番号
LST_HEADER_IN-PURCH_DATE = LST_TEM_PROCESS-BSTDK. "得意先発注日付
LST_HEADER_IN-ORD_REASON
= LST_TEM_PROCESS-AUGRU. "受注理由 (取引理由)
LST_HEADER_IN-CURRENCY   = LST_TEM_PROCESS-WAERK. "販売伝票通貨
LST_HEADER_IN-REQ_DATE_H = LST_TEM_PROCESS-EDATU. "指定納入期日

**** START ADD 2015/03/03 iSiD19 ****
LST_HEADER_IN-COLLECT_NO = LST_TEM_PROCESS-SUBMI. "一括番号

**** START UPD BY ISID REN 2015/08/06 ****
*      LST_HEADER_IN-INCOTERMS1 = LST_TEM_PROCESS-INCO1. "インコタームズ
*      LST_HEADER_IN-INCOTERMS2 = LST_TEM_PROCESS-INCO2. "インコタームズ
*      LST_HEADER_IN-NAME       = LST_TEM_PROCESS-INCO2. "発注者名称
LST_HEADER_IN-INCOTERMS1 = LST_TEM_PROCESS-INCO1. "インコタームズ
LST_HEADER_IN-INCOTERMS2 = LST_TEM_PROCESS-INCO2. "貿易条件
LST_HEADER_IN-NAME       = LST_TEM_PROCESS-Z_LASTDEST. "発注者名称
**** END UPD BY ISID REN 2015/08/06 ****
**** END ADD 2015/03/03 iSiD19   ****

**** START UPD BY ISID REN 2015/07/17 ****
*     明細の1件目の用途を設定する
*     用途
CLEAR LST_ORDER_TEXT.
LST_ORDER_TEXT-ITM_NUMBER = '000000'.
LST_ORDER_TEXT-TEXT_ID = 'Z024'.      "テキスト ID
LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語

LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_PURPOSE_TEXT. "用途（PO）

APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
**** END UPD BY ISID REN 2015/07/17 ****

**** START UPD BY ISID REN 2015/08/11 ****
*    ENDAT.
*     C伝票取引先
CLEAR LST_ORDER_PARTNER.
IF LST_TEM_PROCESS-KUNNR IS NOT INITIAL.          "受注先
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SP.     "受注先「SP」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-KUNNR.   "受注先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
ENDIF.

CLEAR LST_ORDER_PARTNER.
IF LST_TEM_PROCESS-ZEKUNNR IS NOT INITIAL. "出荷先
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SH.     "出荷先「SH」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZEKUNNR. "出荷先
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
ENDIF.

CLEAR LST_ORDER_PARTNER.
IF LST_TEM_PROCESS-PERNR IS NOT INITIAL. "営業員
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_PE.        "営業員「PE」
LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-PERNR. " 営業員
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
ENDIF.

CLEAR LST_ORDER_PARTNER.

IF LST_TEM_PROCESS-ZKUNNR_ZJ IS NOT INITIAL. "最終需要者
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZJ. "最終需要者「ZJ」
LST_ORDER_PARTNER-PARTN_NUMB
= LST_TEM_PROCESS-ZKUNNR_ZJ. "最終需要者
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
ENDIF.

CLEAR LST_ORDER_PARTNER.
*     エンドユーザ（価格)
IF LST_TEM_PROCESS-Z_ENDUSER_CD IS NOT INITIAL.
LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZE.
LST_ORDER_PARTNER-PARTN_NUMB
= LST_TEM_PROCESS-Z_ENDUSER_CD. "エンドユーザ（価格)
APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
ENDIF.

*     本社の場合、ヘッダテキストの設定
IF W_FLGHEADOF IS NOT INITIAL.
LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
LST_ORDER_TEXT-ITM_NUMBER = '000000'. "販売伝票明細

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '01'.     "1行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_VEND_NAME_DT.   "出荷先名（PO）
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '02'.     "1行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_ADDRESS1_DT.    "出荷先住所1
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '03'.     "2行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_ADDRESS2_DT.    "出荷先住所2
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '04'.     "3行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_ADDRESS3_DT.    "出荷先住所3
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '05'.     "4行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_ADDRESS4_DT.    "出荷先住所4
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '06'.     "5行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_TEL_DT.         "出荷先電話
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*       テキスト
LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
LST_ORDER_TEXT-FORMAT_COL = '07'.     "6行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_FAX_DT.         "出荷先FAX
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
ELSE.
*      海外の場合、出荷先の情報を上書き
*      マニュアル SD 伝票アドレスのは既に存在しているか？
CLEAR LST_ADRC_E.
READ TABLE LTD_ADRC
INTO LST_ADRC_E
WITH TABLE KEY
NAME1      = LST_TEM_PROCESS-Z_VEND_NAME_DT "名称 1
STREET     = LST_TEM_PROCESS-Z_ADDRESS1_DT  "地名
CITY1      = LST_TEM_PROCESS-Z_ADDRESS2_DT  "市区町村
STR_SUPPL1 = LST_TEM_PROCESS-Z_ADDRESS3_DT  "地名 2
STR_SUPPL2 = LST_TEM_PROCESS-Z_ADDRESS4_DT  "地名 3
TEL_NUMBER = LST_TEM_PROCESS-Z_TEL_DT       "電話番号
FAX_NUMBER = LST_TEM_PROCESS-Z_FAX_DT.      "FAX 番号

IF SY-SUBRC = 0.
LST_ORDER_PARTNER-COUNTRY  = LST_ADRC_E-COUNTRY.    "国コード
LST_ORDER_PARTNER-ADDRESS  = LST_ADRC_E-ADDRNUMBER. "アドレス
LST_ORDER_PARTNER-ADDR_ORIG  = 'E'.              "コピー元住所
MODIFY LTD_ORDER_PARTNER FROM LST_ORDER_PARTNER
TRANSPORTING COUNTRY
ADDRESS
ADDR_ORIG
WHERE PARTN_ROLE = CNS_ROLE_SH.
ELSE.
LST_ORDER_PARTNER-ADDR_LINK = '1'.      "住所コードへのリンク
MODIFY LTD_ORDER_PARTNER FROM LST_ORDER_PARTNER
TRANSPORTING ADDR_LINK
WHERE PARTN_ROLE = CNS_ROLE_SH.

SELECT SINGLE ADRNR
INTO LW_ADRNR
FROM KNA1
WHERE KUNNR = LST_TEM_PROCESS-ZEKUNNR.

SELECT *
INTO LST_ADRC
FROM ADRC UP TO 1 ROWS
WHERE ADDRNUMBER = LW_ADRNR.
ENDSELECT.

LST_PARTNERADD-ADDR_NO    = '1'.
LST_PARTNERADD-NAME = LST_TEM_PROCESS-Z_VEND_NAME_DT.  "名称 1
LST_PARTNERADD-NAME_2
= LST_TEM_PROCESS-Z_VEND_NAME_DT.   "名称 2
LST_PARTNERADD-STREET = LST_TEM_PROCESS-Z_ADDRESS1_DT. "地名
LST_PARTNERADD-CITY
= LST_TEM_PROCESS-Z_ADDRESS2_DT. "市区町村
LST_PARTNERADD-STR_SUPPL1
= LST_TEM_PROCESS-Z_ADDRESS3_DT. "地名 2
LST_PARTNERADD-POSTL_COD1
= LST_ADRC-POST_CODE1.  "市区町村の郵便番号
LST_PARTNERADD-HOUSE_NO   = LST_ADRC-HOUSE_NUM1. "番地-号
LST_PARTNERADD-COUNTRY    = LST_ADRC-COUNTRY.    "国コード
LST_PARTNERADD-LANGU      = LST_ADRC-LANGU.      "言語キー
LST_PARTNERADD-REGION     = LST_ADRC-REGION. "地域 (都道府県)
LST_PARTNERADD-TIME_ZONE
= LST_ADRC-TIME_ZONE.   "アドレスタイムゾーン
LST_PARTNERADD-STR_SUPPL2
= LST_TEM_PROCESS-Z_ADDRESS4_DT.           "地名 3
LST_PARTNERADD-TEL1_NUMBR
= LST_TEM_PROCESS-Z_TEL_DT.                "電話番号 1
LST_PARTNERADD-FAX_NUMBER
= LST_TEM_PROCESS-Z_FAX_DT.                "FAX 番号
APPEND LST_PARTNERADD TO LTD_PARTNERADD.
ENDIF.
ENDIF.
ENDIF.
**** END UPD BY ISID REN 2015/08/11 ****

LW_NUMBER = LW_NUMBER + 10.

*   B明細データ
LST_ITEMS_IN-ITM_NUMBER = LW_NUMBER.             "販売伝票明細
LST_ITEMS_IN-MATERIAL   = LST_TEM_PROCESS-MATNR. "品目コード

**** START ADD BY ISID REN 2015/07/17 ****
LST_ITEMS_IN-ITEM_CATEG = LST_TEM_PROCESS-PSTYV.
**** END ADD BY ISID REN 2015/07/17 ****

LST_ITEMS_IN-SHORT_TEXT
= LST_TEM_PROCESS-ARKTX. "受注明細のテキスト (短)
LST_ITEMS_IN-PLANT = LST_TEM_PROCESS-WERKS. "プラント

**** START ADD 2015/03/03 iSiD19 ****
LST_ITEMS_IN-STORE_LOC = LST_TEM_PROCESS-LGPRO. "保管場所
**** END ADD 2015/03/03 iSiD19 ****

LST_ITEMS_IN-SALES_UNIT = LST_TEM_PROCESS-VRKME. "販売単位

*   販売単位による受注数量
IF LST_TEM_PROCESS-KWMENG > CNS_MENG_MAX.
LST_ITEMS_IN-TARGET_QTY = CNS_MENG_MAX.
ELSE.
LST_ITEMS_IN-TARGET_QTY = LST_TEM_PROCESS-KWMENG.
ENDIF.

LST_ITEMS_IN-TARGET_QU
= LST_TEM_PROCESS-VRKME. "目標数量 (数量単位)
LST_ITEMS_IN-REF_DOC    = LST_TEM_PROCESS-BSTKD. "参照伝票番号
LST_ITEMS_IN-REF_DOC_IT = LST_TEM_PROCESS-EBELP. "参照明細番号
APPEND LST_ITEMS_IN TO LTD_ITEMS_IN.
CLEAR LST_ITEMS_IN.

*   D納入日程行データ
LST_SCHEDULES-ITM_NUMBER = LW_NUMBER.     "販売伝票明細
LST_SCHEDULES-SCHED_LINE = CNS_LINE_01.   "納入日程行
LST_SCHEDULES-REQ_DATE   = LST_TEM_PROCESS-EDATU. "納入日程日付

*   販売単位による受注数量
IF LST_TEM_PROCESS-KWMENG > CNS_MENG_MAX.
LST_SCHEDULES-REQ_QTY  = CNS_MENG_MAX.
ELSE.
LST_SCHEDULES-REQ_QTY  = LST_TEM_PROCESS-KWMENG.
ENDIF.

APPEND LST_SCHEDULES TO LTD_SCHEDULES.
CLEAR LST_SCHEDULES.

LST_CONDITIONS-ITM_NUMBER = LW_NUMBER.    "販売伝票明細

*   条件タイプ
IF LST_TEM_PROCESS-KARTV IS INITIAL.
LST_CONDITIONS-COND_TYPE  = CNS_COND_ZPR0.
ELSE.
LST_CONDITIONS-COND_TYPE = LST_TEM_PROCESS-KARTV.
ENDIF.

**** START ADD BY ISID REN 2015/08/11 ****
IF LST_TEM_PROCESS-NETPR <> 0.
**** END ADD BY ISID REN 2015/08/11 ****
CLEAR LW_COND_VALUE.
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = LST_TEM_PROCESS-WAERK
AMOUNT_INTERNAL = LST_TEM_PROCESS-NETPR
IMPORTING
AMOUNT_EXTERNAL = LW_COND_VALUE.       "条件レート

LST_CONDITIONS-COND_VALUE = LW_COND_VALUE. "条件レート
LST_CONDITIONS-CURRENCY   = LST_TEM_PROCESS-WAERK.  " 通貨コード
LST_CONDITIONS-COND_UNIT  = LST_TEM_PROCESS-ZVRKME. " 条件単位
LST_CONDITIONS-COND_P_UNT = LST_TEM_PROCESS-KPEIN.  " 販売単位

APPEND LST_CONDITIONS TO LTD_CONDITIONS.

**** START ADD BY ISID REN 2015/08/11 ****
ENDIF.
**** END ADD BY ISID REN 2015/08/11 ****

CLEAR LST_CONDITIONS.

**** START ADD BY ISID REN 2015/07/17 ****
*   エンドユーザ価格が設定された場合のみ設定処理を行う
IF LST_TEM_PROCESS-Z_ENDUSER_CD IS NOT INITIAL.
LST_CONDITIONS-ITM_NUMBER = LW_NUMBER.    "販売伝票明細
LST_CONDITIONS-COND_TYPE  = CNS_COND_ZPZE.

CLEAR LW_COND_VALUE.
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = LST_TEM_PROCESS-Z_WAERK_VBAP
AMOUNT_INTERNAL = LST_TEM_PROCESS-Z_NETPR_VBAP
IMPORTING
AMOUNT_EXTERNAL = LW_COND_VALUE.       "条件レート

LST_CONDITIONS-COND_VALUE = LW_COND_VALUE. "条件レート
LST_CONDITIONS-CURRENCY
= LST_TEM_PROCESS-Z_WAERK_VBAP.  "通貨コード
LST_CONDITIONS-COND_UNIT
= LST_TEM_PROCESS-Z_VRKME_VBAP.  "販売単位
LST_CONDITIONS-COND_P_UNT
= LST_TEM_PROCESS-Z_KPEIN_VBAP.  "条件単位

APPEND LST_CONDITIONS TO LTD_CONDITIONS.
ENDIF.
**** END ADD BY ISID REN 2015/07/17 ****

APPEND LST_TEM_PROCESS TO O_TD_UPDATE.

**** START ADD 2015/03/03 iSiD19 ****
*   テキスト
**** START UPD BY ISID REN 2015/07/17 ****
*    LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
**** END UPD BY ISID REN 2015/07/17 ****
LST_ORDER_TEXT-ITM_NUMBER = LW_NUMBER."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = '0001'.      "テキスト ID
LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-ARKTX."テキスト行
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
CLEAR LST_ORDER_TEXT.
**** END ADD 2015/03/03 iSiD19   ****

**** START UPD BY ISID REN 2015/07/17 ****
*   出荷指示備考
CLEAR LST_ORDER_TEXT.
LST_ORDER_TEXT-ITM_NUMBER = LW_NUMBER."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = '9001'.      "テキスト ID
LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語

LST_ORDER_TEXT-FORMAT_COL = '01'.     "1行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_TDLINE_1. "出荷指示備考(1)
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

LST_ORDER_TEXT-FORMAT_COL = '02'.     "2行目
LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_TDLINE_2. "出荷指示備考(2)
APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.

*   購買発注テキスト
CLEAR LST_ORDER_TEXT.
LST_ORDER_TEXT-ITM_NUMBER = LW_NUMBER."販売伝票明細
LST_ORDER_TEXT-TEXT_ID = '0005'.      "テキスト ID
LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語

LST_ORDER_TEXT-TEXT_LINE
= LST_TEM_PROCESS-Z_PO_ITEM_TXT. "購買発注明細テキスト

APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
**** END UPD BY ISID REN 2015/07/17 ****

AT END OF BSTKD.
**** START UPD BY ISID REN 2015/08/11 ****
**     C伝票取引先
***** START ADD BY ISID REN 2015/08/10 ****
*      CLEAR LST_ORDER_PARTNER.
*      IF LST_TEM_PROCESS-KUNNR IS NOT INITIAL. "受注先
***** END ADD BY ISID REN 2015/08/10 ****
*        LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SP.     "受注先「SP」
*        LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-KUNNR.  "受注先
*        APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
***** START ADD BY ISID REN 2015/08/10 ****
*      ENDIF.
***** END ADD BY ISID REN 2015/08/10 ****
*
*      CLEAR LST_ORDER_PARTNER.
*
***** START ADD BY ISID REN 2015/08/10 ****
*      IF LST_TEM_PROCESS-ZEKUNNR IS NOT INITIAL. "出荷先
***** END ADD BY ISID REN 2015/08/10 ****
*        LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_SH.     "出荷先「SH」
*        LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZEKUNNR. "出荷先
*        APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
***** START ADD BY ISID REN 2015/08/10 ****
*      ENDIF.
***** END ADD BY ISID REN 2015/08/10 ****
*
*      CLEAR LST_ORDER_PARTNER.
*
***** START ADD BY ISID REN 2015/08/10 ****
*      IF LST_TEM_PROCESS-PERNR IS NOT INITIAL. "営業員
***** END ADD BY ISID REN 2015/08/10 ****
*        LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_PE.        "営業員「PE」
*        LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-PERNR. " 営業員
*        APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
***** START ADD BY ISID REN 2015/08/10 ****
*      ENDIF.
***** END ADD BY ISID REN 2015/08/10 ****
*
*      CLEAR LST_ORDER_PARTNER.
*
***** START ADD BY ISID REN 2015/08/10 ****
*      IF LST_TEM_PROCESS-ZKUNNR_ZJ IS NOT INITIAL. "最終需要者
***** END ADD BY ISID REN 2015/08/10 ****
*        LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZJ. "最終需要者「ZJ」
*        LST_ORDER_PARTNER-PARTN_NUMB
*          = LST_TEM_PROCESS-ZKUNNR_ZJ. "最終需要者
*        APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
***** START ADD BY ISID REN 2015/08/10 ****
*      ENDIF.
***** END ADD BY ISID REN 2015/08/10 ****
*
*      CLEAR LST_ORDER_PARTNER.
*
***** START UPD 2015/03/03 iSiD19 ****
**      LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZC.
**        " 最終需要者(商流)「ZC」
**      LST_ORDER_PARTNER-PARTN_NUMB = LST_TEM_PROCESS-ZKUNNR_DS.
**      " 最終需要者(商流)
**      APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
**      CLEAR LST_ORDER_PARTNER.
*
***** START UPD BY ISID REN 2015/07/17 ****
**      IF LST_TEM_PROCESS-ZKUNNR_DS IS NOT INITIAL.
**        LST_ORDER_PARTNER-PARTN_ROLE
**          = CNS_ROLE_ZC. " 最終需要者(商流)「ZC」
**        LST_ORDER_PARTNER-PARTN_NUMB
**          = LST_TEM_PROCESS-ZKUNNR_DS. " 最終需要者(商流)
**        APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
**        CLEAR LST_ORDER_PARTNER.
**      ENDIF.
**     エンドユーザ（価格)
*      IF LST_TEM_PROCESS-Z_ENDUSER_CD IS NOT INITIAL.
*        LST_ORDER_PARTNER-PARTN_ROLE = CNS_ROLE_ZE.
*        LST_ORDER_PARTNER-PARTN_NUMB
*          = LST_TEM_PROCESS-Z_ENDUSER_CD. "エンドユーザ（価格)
*        APPEND LST_ORDER_PARTNER TO LTD_ORDER_PARTNER.
*      ENDIF.
***** END UPD BY ISID REN 2015/07/17 ****
*
**     本社の場合、ヘッダテキストの設定
*      IF W_FLGHEADOF IS NOT INITIAL.
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '01'.     "1行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_VEND_NAME_DT.
*        "出荷先名（PO）
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '02'.     "1行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS1_DT.
*        "出荷先住所1
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '03'.     "2行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS2_DT.
*        "出荷先住所2
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '04'.     "3行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS3_DT.
*        "出荷先住所3
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '05'.     "4行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_ADDRESS4_DT.
*        "出荷先住所4
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '06'.     "5行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_TEL_DT.
*        "出荷先電話
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
**       テキスト
***** START UPD BY ISID REN 2015/07/17 ****
**        LST_ORDER_TEXT-LANGU = SY-LANGU.      "言語キー
*        LST_ORDER_TEXT-LANGU = LST_TEM_PROCESS-SPRAS. "得意先の通信言語
***** END UPD BY ISID REN 2015/07/17 ****
*        LST_ORDER_TEXT-ITM_NUMBER = '000000'."販売伝票明細
*        LST_ORDER_TEXT-TEXT_ID = 'Z012'.      "テキスト ID
*        LST_ORDER_TEXT-FORMAT_COL = '07'.     "6行目
*        LST_ORDER_TEXT-TEXT_LINE = LST_TEM_PROCESS-Z_FAX_DT.
*        "出荷先FAX
*        APPEND LST_ORDER_TEXT TO LTD_ORDER_TEXT.
*        CLEAR LST_ORDER_TEXT.
*
*      ELSE.
**      海外の場合、出荷先の情報を上書き
**      マニュアル SD 伝票アドレスのは既に存在しているか？
*        CLEAR LST_ADRC_E.
*        READ TABLE LTD_ADRC
*          INTO LST_ADRC_E
*          WITH TABLE KEY
*            NAME1      = LST_TEM_PROCESS-Z_VEND_NAME_DT "名称 1
*            STREET     = LST_TEM_PROCESS-Z_ADDRESS1_DT  "地名
*            CITY1      = LST_TEM_PROCESS-Z_ADDRESS2_DT  "市区町村
*            STR_SUPPL1 = LST_TEM_PROCESS-Z_ADDRESS3_DT  "地名 2
*            STR_SUPPL2 = LST_TEM_PROCESS-Z_ADDRESS4_DT  "地名 3
*            TEL_NUMBER = LST_TEM_PROCESS-Z_TEL_DT       "電話番号
*            FAX_NUMBER = LST_TEM_PROCESS-Z_FAX_DT.      "FAX 番号
*
*        IF SY-SUBRC = 0.
*          CLEAR LST_ORDER_PARTNER.
*          LST_ORDER_PARTNER-COUNTRY  = LST_ADRC_E-COUNTRY.    "国コード
*          LST_ORDER_PARTNER-ADDRESS  = LST_ADRC_E-ADDRNUMBER. "アドレス
*          LST_ORDER_PARTNER-ADDR_ORIG  = 'E'.           "コピー元住所
*          MODIFY LTD_ORDER_PARTNER FROM LST_ORDER_PARTNER
*                           TRANSPORTING COUNTRY
*                                        ADDRESS
*                                        ADDR_ORIG
*                                  WHERE PARTN_ROLE = CNS_ROLE_SH.
*        ELSE.
*          CLEAR LST_ORDER_PARTNER.
*          LST_ORDER_PARTNER-ADDR_LINK = '1'.      "住所コードへのリンク
*          MODIFY LTD_ORDER_PARTNER FROM LST_ORDER_PARTNER
*                           TRANSPORTING ADDR_LINK
*                                  WHERE PARTN_ROLE = CNS_ROLE_SH.
*
*          SELECT SINGLE ADRNR
*            INTO LW_ADRNR
*            FROM KNA1
*           WHERE KUNNR = LST_TEM_PROCESS-ZEKUNNR.
*
*          SELECT *
*            INTO LST_ADRC
*            FROM ADRC UP TO 1 ROWS
*           WHERE ADDRNUMBER = LW_ADRNR.
*          ENDSELECT.
*
*          LST_PARTNERADD-ADDR_NO    = '1'.
*          LST_PARTNERADD-NAME       = LST_TEM_PROCESS-Z_VEND_NAME_DT.
*          "名称 1
*          LST_PARTNERADD-NAME_2     = LST_TEM_PROCESS-Z_VEND_NAME_DT.
*          "名称 2
*          LST_PARTNERADD-STREET     = LST_TEM_PROCESS-Z_ADDRESS1_DT.
*          "地名
*          LST_PARTNERADD-CITY       = LST_TEM_PROCESS-Z_ADDRESS2_DT.
*          "市区町村
*          LST_PARTNERADD-STR_SUPPL1 = LST_TEM_PROCESS-Z_ADDRESS3_DT.
*          "地名 2
*          LST_PARTNERADD-POSTL_COD1 = LST_ADRC-POST_CODE1.
*          "市区町村の郵便番号
*          LST_PARTNERADD-HOUSE_NO   = LST_ADRC-HOUSE_NUM1.
*          "番地-号
*          LST_PARTNERADD-COUNTRY    = LST_ADRC-COUNTRY.
*          "国コード
*          LST_PARTNERADD-LANGU      = LST_ADRC-LANGU.
*          "言語キー
*          LST_PARTNERADD-REGION     = LST_ADRC-REGION.
*          "地域 (都道府県)
*          LST_PARTNERADD-TIME_ZONE  = LST_ADRC-TIME_ZONE.
*          "アドレスタイムゾーン
*          LST_PARTNERADD-STR_SUPPL2 = LST_TEM_PROCESS-Z_ADDRESS4_DT.
*          "地名 3
*          LST_PARTNERADD-TEL1_NUMBR = LST_TEM_PROCESS-Z_TEL_DT.
*          "電話番号 1
*          LST_PARTNERADD-FAX_NUMBER = LST_TEM_PROCESS-Z_FAX_DT.
*          "FAX 番号
*          APPEND LST_PARTNERADD TO LTD_PARTNERADD.
*          CLEAR LST_PARTNERADD.
*        ENDIF.
*      ENDIF.
**** END UPD 2015/03/03 iSiD19   ****
LW_END_FLG = ABAP_TRUE.
ENDAT.

IF   LW_END_FLG = ABAP_TRUE
OR W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ
**** END UPD BY ISID REN 2015/08/11 ****

LST_SWITCH-PRICING = CNS_PRICING_G.
" 価格要素のコピー (変更なし)/税の再決定

**** START UPD 2015/09/22 iSiD21   ****
*   BAPi シミュレーションチェックできないものを追加チェックする
CLEAR  LW_SIMERR_FLG .
LOOP AT LTD_ITEMS_IN INTO LST_ITEMS_IN.
*       品目存在チェック
IF LST_ITEMS_IN-MATERIAL IS INITIAL.
LST_MESSAGE-BSTKD   = LST_ITEMS_IN-REF_DOC.
LST_MESSAGE-EBELP   = LST_ITEMS_IN-REF_DOC_IT.

LST_MESSAGE-MSGID = 'V1'.
LST_MESSAGE-MSGNO = '018'.
MESSAGE ID LST_MESSAGE-MSGID TYPE 'E'
NUMBER LST_MESSAGE-MSGNO
INTO  LST_MESSAGE-MESSAGE.
APPEND LST_MESSAGE TO LTD_MESSAGE.
CLEAR LST_MESSAGE.

O_W_ERRFLG = ABAP_ON.
LW_SIMERR_FLG = ABAP_ON.
ELSE.
LST_MESSAGE-BSTKD   = LST_ITEMS_IN-REF_DOC.
LST_MESSAGE-EBELP   = LST_ITEMS_IN-REF_DOC_IT.
LST_MESSAGE-MSGID = 'V1'.
LST_MESSAGE-MSGNO = '899'.
APPEND LST_MESSAGE TO LTD_MESSAGE.
CLEAR LST_MESSAGE.
ENDIF.
ENDLOOP.

*  エラーチェック
IF LW_SIMERR_FLG = ABAP_ON.
APPEND LINES OF LTD_MESSAGE TO O_TD_MESSAGE.
CLEAR LTD_MESSAGE[].
CONTINUE.
ENDIF.

**** END UPD 2015/09/22 iSiD21   ****

IF LST_TEM_PROCESS-VBTYP = CNS_VBTYP_C.
CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
EXPORTING
ORDER_HEADER_IN     = LST_HEADER_IN
LOGIC_SWITCH        = LST_SWITCH
TESTRUN             = ABAP_ON
TABLES
RETURN              = LTD_RETURN
ORDER_ITEMS_IN      = LTD_ITEMS_IN
ORDER_PARTNERS      = LTD_ORDER_PARTNER
ORDER_SCHEDULES_IN  = LTD_SCHEDULES
ORDER_CONDITIONS_IN = LTD_CONDITIONS
**** START ADD 2015/03/03 iSiD19 ****
ORDER_TEXT          = LTD_ORDER_TEXT
PARTNERADDRESSES    = LTD_PARTNERADD.
**** END ADD 2015/03/03 iSiD19   ****
ELSE.

CALL FUNCTION 'SD_SALESDOCUMENT_CREATE'
EXPORTING
SALES_HEADER_IN     = LST_HEADER_IN
LOGIC_SWITCH        = LST_SWITCH
TESTRUN             = ABAP_ON
TABLES
RETURN              = LTD_RETURN
SALES_ITEMS_IN      = LTD_ITEMS_IN
SALES_PARTNERS      = LTD_ORDER_PARTNER
SALES_SCHEDULES_IN  = LTD_SCHEDULES
SALES_CONDITIONS_IN = LTD_CONDITIONS
**** START ADD 2015/03/03 iSiD19 ****
SALES_TEXT          = LTD_ORDER_TEXT
PARTNERADDRESSES    = LTD_PARTNERADD.
**** END ADD 2015/03/03 iSiD19   ****
ENDIF.

LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E
OR TYPE = CNS_MSG_A.
LOOP AT LTD_ITEMS_IN INTO LST_ITEMS_IN.
LST_MESSAGE-BSTKD   = LST_ITEMS_IN-REF_DOC.
LST_MESSAGE-EBELP   = LST_ITEMS_IN-REF_DOC_IT.
LST_MESSAGE-MESSAGE = LST_RETURN-MESSAGE.
**** START ADD 2015/04/24 ISID11 ****
LST_MESSAGE-MSGID = LST_RETURN-ID.
LST_MESSAGE-MSGNO = LST_RETURN-NUMBER.
LST_MESSAGE-MSGV1 = LST_RETURN-MESSAGE_V1.
LST_MESSAGE-MSGV2 = LST_RETURN-MESSAGE_V2.
LST_MESSAGE-MSGV3 = LST_RETURN-MESSAGE_V3.
LST_MESSAGE-MSGV4 = LST_RETURN-MESSAGE_V4.
**** END ADD 2015/04/24 ISID11 ****
APPEND LST_MESSAGE TO O_TD_MESSAGE.
CLEAR LST_MESSAGE.
ENDLOOP.

O_W_ERRFLG = ABAP_ON.

EXIT.
ENDLOOP.

**** START UPD BY ISID REN 2015/08/11 ****
*      CLEAR:
*        LST_HEADER_IN,
*        LW_NUMBER.
*
*      REFRESH:
*        LTD_ITEMS_IN,
*        LTD_ORDER_PARTNER,
*        LTD_SCHEDULES,
*        LTD_CONDITIONS.
*    ENDAT.
ENDIF.
**** END UPD BY ISID REN 2015/08/11 ****
ENDLOOP.

IF O_TD_MESSAGE IS NOT INITIAL.
SORT O_TD_MESSAGE BY BSTKD ASCENDING
EBELP ASCENDING.
ENDIF.

ENDFORM.                    " BAPI_SALESORDER_CREAT
*&---------------------------------------------------------------------*
*&      Form  CHECK_TD_PROCESS
*&---------------------------------------------------------------------*
*       購買発注番号混在チェック
*----------------------------------------------------------------------*
*      -->I_TD_APP_ALV     ITAB:ALV対象データ
*      -->I_TD_ERR_ALV     ITAB:ALV対象データ
*      <--O_TD_PROCESS     ITAB:処理の対象データ
*----------------------------------------------------------------------*
FORM CHECK_TD_PROCESS USING I_TD_APP_ALV TYPE TYP_TD_APPALVDATA
I_TD_ERR_ALV TYPE TYP_TD_ERRALVDATA
CHANGING O_TD_PROCESS TYPE TYP_TD_ERRALVDATA.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LST_PROCESS     TYPE TYP_ERR_ALVDATA,
LST_PROCESS_TEM TYPE TYP_ERR_ALVDATA,
LST_APP_ALV     TYPE TYP_APP_ALVDATA,
LTD_APP_ALV     TYPE TYP_TD_APPALVDATA,
LW_CUNT         TYPE I.

LTD_PROCESS = O_TD_PROCESS.
SORT LTD_PROCESS BY BSTKD ASCENDING.
DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING BSTKD.      " 発注番号

DESCRIBE TABLE LTD_PROCESS LINES LW_CUNT.
IF LW_CUNT > 1.
*   変更の場合、同一購買発注のみ指定できます
MESSAGE E047(ZMEGSD01).
ENDIF.

**** START ADD 2015/03/03 iSiD19 ****
IF W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ;ON
RETURN.
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****

REFRESH O_TD_PROCESS.
READ TABLE LTD_PROCESS INTO LST_PROCESS INDEX 1.

IF RB_APP IS NOT INITIAL.
LTD_APP_ALV[] = I_TD_APP_ALV[].
DELETE LTD_APP_ALV WHERE BSTKD <> LST_PROCESS-BSTKD.

LOOP AT LTD_APP_ALV INTO LST_APP_ALV.
MOVE-CORRESPONDING LST_APP_ALV TO LST_PROCESS_TEM.
APPEND LST_PROCESS_TEM TO O_TD_PROCESS.
CLEAR LST_PROCESS_TEM.
ENDLOOP.
ENDIF.

IF RB_ERR IS NOT INITIAL.
O_TD_PROCESS = I_TD_ERR_ALV.
DELETE O_TD_PROCESS WHERE BSTKD <> LST_PROCESS-BSTKD.
ENDIF.

SORT O_TD_PROCESS BY BSTKD ASCENDING        " 発注番号
EBELP ASCENDING.       " 購買伝票の明細番号

ENDFORM.                    " EDIT_TD_PROCESS
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_205
*&---------------------------------------------------------------------*
*       販売伝票タイプの検索
*----------------------------------------------------------------------*
*      <--O_TD_SDT203      ITAB:承認対象データ
*----------------------------------------------------------------------*
FORM GET_DATA_205 CHANGING O_TD_SDT203 TYPE TYP_TD_ZTEGSDT203.
DATA:
LTD_DATA_205     TYPE TYP_TD_205,
LTD_DATA_205_TEM TYPE TYP_TD_205,
LST_DATA_205     TYPE TYP_DATA_205,
LTD_PROCESS      TYPE TYP_TD_ZTEGSDT203,
LTD_203          TYPE TYP_TD_ZTEGSDT203,
LTD_SDT203       TYPE TYP_TD_ZTEGSDT203,
LTD_KALVG        TYPE TYP_TD_KALVG,
LST_KALVG        TYPE TYP_KALVG,
LTD_KALKS        TYPE TYP_TD_KALKS,
LST_KALKS        TYPE TYP_KALKS,
LTD_COND_TYPE    TYPE TYP_TD_COND_TYPE,
LST_COND_TYPE    TYPE TYP_COND_TYPE,
LST_TVAKT        TYPE TYP_TVAKT,
LTD_TVAKT        TYPE STANDARD TABLE OF TYP_TVAKT.

FIELD-SYMBOLS:
<LFS_ST_DATA_205> TYPE TYP_DATA_205,
<LFS_ST_SDT203>   TYPE TYP_ZTEGSDT203.

LOOP AT O_TD_SDT203 ASSIGNING <LFS_ST_SDT203>.
AT FIRST.
LTD_SDT203[] = O_TD_SDT203[].
SORT LTD_SDT203 BY BSART ASCENDING      " 購買伝票タイプ
KNTTP ASCENDING.     " 勘定設定カテゴリ
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING BSART   " 購買伝票タイプ
KNTTP.  " 勘定設定カテゴリ

SELECT ZTEGSDT205~BSART                 " 購買伝票タイプ
ZTEGSDT205~KNTTP                 " 勘定設定カテゴリ
ZTEGSDT205~AUART                 " 販売伝票タイプ
TVAK~VBTYP                       " 販売管理伝票カテゴリ
FROM ZTEGSDT205
INNER JOIN TVAK
ON ZTEGSDT205~AUART = TVAK~AUART
INTO CORRESPONDING FIELDS OF TABLE LTD_DATA_205
FOR ALL ENTRIES IN LTD_SDT203
WHERE ZTEGSDT205~BSART = LTD_SDT203-BSART   " 購買伝票タイプ
AND ZTEGSDT205~KNTTP = LTD_SDT203-KNTTP.  " 勘定設定カテゴリ

IF SY-SUBRC = 0.
LTD_DATA_205_TEM = LTD_DATA_205.
SORT LTD_DATA_205_TEM BY AUART ASCENDING.
" 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205_TEM
COMPARING AUART." 販売伝票タイプ

SELECT AUART                          " 販売伝票タイプ
BEZEI                          " 販売伝票タイプテキスト
FROM TVAKT
INTO TABLE LTD_TVAKT
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART " 販売伝票タイプ
AND SPRAS = SY-LANGU.              " システム言語

IF SY-SUBRC = 0.
SORT LTD_TVAKT BY AUART ASCENDING.
ENDIF.

LOOP AT LTD_DATA_205 ASSIGNING <LFS_ST_DATA_205>.
CLEAR LST_TVAKT.
READ TABLE LTD_TVAKT INTO LST_TVAKT
WITH KEY AUART = <LFS_ST_DATA_205>-AUART
BINARY SEARCH.
<LFS_ST_DATA_205>-BEZEI = LST_TVAKT-BEZEI.
" 販売伝票タイプテキスト
ENDLOOP.
SORT LTD_DATA_205  BY BSART ASCENDING " 購買伝票タイプ
KNTTP ASCENDING." 勘定設定カテゴリ

SELECT AUART                          " 販売伝票タイプ
KALVG                          " 伝票決定区分
FROM TVAK
INTO TABLE LTD_KALVG
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART. " 販売伝票タイプ

IF SY-SUBRC = 0.

SORT LTD_KALVG BY AUART ASCENDING.   " 販売伝票タイプ

ENDIF.

ENDIF.

LTD_203[] = O_TD_SDT203[].
SORT LTD_203 BY     KUNNR ASCENDING     " 得意先コード
VKORG ASCENDING     " 販売組織
VTWEG ASCENDING     " 流通チャネル
SPART ASCENDING.    " 製品部門

SELECT KUNNR                                " 得意先コード
VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALKS                                " 価格決定区分割当
FROM KNVV
INTO TABLE LTD_KALKS
FOR ALL ENTRIES IN LTD_203
WHERE KUNNR = LTD_203-KUNNR                " 得意先コード
AND VKORG = LTD_203-VKORG                " 販売伝票タイプ
AND VTWEG = LTD_203-VTWEG                " 販売組織
AND SPART = LTD_203-SPART.               " 製品部門

IF SY-SUBRC = 0.
SORT LTD_KALKS BY  KUNNR ASCENDING        " 得意先コード
VKORG ASCENDING        " 販売伝票タイプ
VTWEG ASCENDING        " 販売組織
SPART ASCENDING.       " 製品部門
ENDIF.

LTD_PROCESS[] = O_TD_SDT203[].
SORT LTD_PROCESS BY VKORG ASCENDING         " 販売組織
VTWEG ASCENDING         " 流通チャネル
SPART ASCENDING.        " 製品部門

DELETE ADJACENT DUPLICATES FROM LTD_PROCESS
COMPARING VKORG       " 販売組織
VTWEG       " 流通チャネル
SPART.      " 製品部門

SELECT VKORG                                " 販売組織
VTWEG                                " 流通チャネル
SPART                                " 製品部門
KALVG                                " 伝票決定区分
KALKS                                " 価格決定区分割当
KARTV                                " 条件タイプ
FROM T683V
INTO TABLE LTD_COND_TYPE
FOR ALL ENTRIES IN LTD_PROCESS
WHERE VKORG = LTD_PROCESS-VKORG            " 販売伝票タイプ
AND VTWEG = LTD_PROCESS-VTWEG            " 販売組織
AND SPART = LTD_PROCESS-SPART.           " 製品部門

SORT LTD_COND_TYPE  BY VKORG ASCENDING      " 販売組織
VTWEG ASCENDING      " 流通チャネル
SPART ASCENDING      " 製品部門
KALVG ASCENDING      " 伝票決定区分
KALKS ASCENDING.     " 価格決定区分割当
ENDAT.

CLEAR LST_DATA_205.
READ TABLE LTD_DATA_205 INTO LST_DATA_205
WITH KEY BSART = <LFS_ST_SDT203>-BSART
KNTTP = <LFS_ST_SDT203>-KNTTP
BINARY SEARCH.
IF SY-SUBRC = 0.
<LFS_ST_SDT203>-AUART   = LST_DATA_205-AUART. " 販売伝票タイプ
<LFS_ST_SDT203>-ZABEZEI = LST_DATA_205-BEZEI.
" 販売伝票タイプテキスト
<LFS_ST_SDT203>-VBTYP   = LST_DATA_205-VBTYP.
" 販売管理伝票カテゴリ

*     伝票決定区分の取得処理
CLEAR LST_KALVG.
READ TABLE LTD_KALVG INTO LST_KALVG BINARY SEARCH
WITH KEY AUART = LST_DATA_205-AUART.
ENDIF.

*   価格決定区分割当の取得処理
CLEAR LST_KALKS.
READ TABLE LTD_KALKS INTO LST_KALKS BINARY SEARCH
WITH KEY KUNNR = <LFS_ST_SDT203>-KUNNR
VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART.

*   条件タイプの取得処理
CLEAR LST_COND_TYPE.
READ TABLE LTD_COND_TYPE INTO LST_COND_TYPE BINARY SEARCH
WITH KEY VKORG = <LFS_ST_SDT203>-VKORG
VTWEG = <LFS_ST_SDT203>-VTWEG
SPART = <LFS_ST_SDT203>-SPART
KALVG = LST_KALVG-KALVG
KALKS = LST_KALKS-KALKS.

IF SY-SUBRC = 0.
<LFS_ST_SDT203>-KARTV = LST_COND_TYPE-KARTV.
ENDIF.
ENDLOOP.

ENDFORM.                    " GET_DATA_205
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_BAPI
*&---------------------------------------------------------------------*
*       C-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_W_MESSAGE      メッセージ
*      -->I_ST_ALVDATA     BAPI処理対象
*      -->I_W_DATUM        更新年月日
*      -->I_W_UZEIT        更新時分秒
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_BAPI USING I_KBUNCC      TYPE C
I_STATUS      TYPE C
I_W_MESSAGE   TYPE TYP_BAPIMSG
I_ST_ALVDATA  TYPE TYP_TEM_ALVDATA
I_W_DATUM     TYPE SY-DATUM
I_W_UZEIT     TYPE SY-UZEIT
CHANGING O_W_ERRFLG   TYPE C.
UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC              " 処理区分
STATUS       = I_STATUS              " ステータス
ZKUNNR_S     = I_ST_ALVDATA-ZEKUNNR  " 出荷先
**** START DEL 2015/03/03 iSiD19 ****
*         ZKUNNR_ZJ    = I_ST_ALVDATA-ZKUNNR_ZJ " 最終需要者
*         ZKUNNR_DS    = I_ST_ALVDATA-ZKUNNR_DS " 最終需要者（商流）
**** END DEL 2015/03/03 iSiD19 ****
PERNR        = I_ST_ALVDATA-PERNR    " 営業員
AUGRU        = I_ST_ALVDATA-AUGRU    " 受注理由
**** START ADD BY ISID REN 2015/07/16 ****
AUART         = I_ST_ALVDATA-AUART    "販売伝票タイプ
PSTYV         = I_ST_ALVDATA-PSTYV    "明細カテゴリ
Z_SHP_REMARK1 = I_ST_ALVDATA-Z_TDLINE_1 "出荷指示備考(1)
Z_SHP_REMARK2 = I_ST_ALVDATA-Z_TDLINE_2 "出荷指示備考(2)
**** END ADD BY ISID REN 2015/07/16 ****
DWERK        = I_ST_ALVDATA-WERKS    " 出荷プラント
ZTERM        = I_ST_ALVDATA-DZTERM    "支払条件
**** START ADD 2015/03/03 iSiD19 ****
LGORT_SO     = I_ST_ALVDATA-LGPRO    "保管場所
**** END ADD 2015/03/03 iSiD19 ****
**** START ADD BY ISID21 2015/09/22 ****
Z_PURPOSE_TEXT = I_ST_ALVDATA-Z_PURPOSE_TEXT "用途
**** END ADD BY ISID21 2015/09/22 ****
**** START UPD 2015/04/24 ISID11 ****
*         MSGTX        = I_W_MESSAGE          " メッセージ
MSGTX        = I_W_MESSAGE-MESSAGE   " メッセージ
MSGID         = I_W_MESSAGE-MSGID    " メッセージ ID
MSGNO        = I_W_MESSAGE-MSGNO     " システムメッセージ番号
MSGV1        = I_W_MESSAGE-MSGV1     " メッセージ変数
MSGV2        = I_W_MESSAGE-MSGV2     " メッセージ変数
MSGV3        = I_W_MESSAGE-MSGV3     " メッセージ変数
MSGV4        = I_W_MESSAGE-MSGV4     " メッセージ変数
**** END UPD 2015/04/24 ISID11 ****
**** END ADD 2015/04/24 ISID11 ****
Z_MOD_YMD    = I_W_DATUM             " 更新年月日
Z_MOD_HMS    = I_W_UZEIT             " 更新時分秒
Z_MOD_USERID = SY-UNAME              " 更新ユーザ
WHERE EBELN        = I_ST_ALVDATA-BSTKD    " 購買伝票番号
AND EBELP        = I_ST_ALVDATA-EBELP.   " 購買伝票の明細番号

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_BAPI
*&---------------------------------------------------------------------*
*&      Form  SET_SCREEN_9000
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_PROCESS      ITAB:ALV処理対象データ
*      <--O_ZSEGSD0009      SCREEN9000ヘッダデータ
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*      <--O_TD_ITEM_ALV_INI SCREEN9000明細データ初期値
*----------------------------------------------------------------------*
FORM SET_SCREEN_9000 USING I_TD_PROCESS      TYPE TYP_TD_ERRALVDATA
CHANGING O_ZSEGSD0009      TYPE ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM
O_TD_ITEM_ALV_INI TYPE TYP_TD_ITEM.
DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LST_ZTERM     TYPE TYP_ZTERM,
LW_NETWR      TYPE NETWR,
**** START ADD 2015/03/03 iSiD19 ****
LW_EBELP      TYPE EBELP,
**** END ADD 2015/03/03 iSiD19   ****
**** START ADD BY ISID REN 2015/08/21 ****
LW_NAME2      TYPE KNA1-NAME2,
LW_NAME3      TYPE KNA1-NAME3,
**** END ADD BY ISID REN 2015/08/21 ****
LW_VKORGTEXT  TYPE VTXTK,
LW_VTWEGTEXT  TYPE VTXTK,
LW_SPARTTEXT  TYPE VTXTK,
LW_ZESALESTXT TYPE ZESALESTXT,
LST_ITEM_ALV  TYPE TYP_ALV_ITEM,
LST_ALV_ITEM  TYPE TYP_ALV_ITEM,
LW_POSNR      TYPE POSNR_VA.

CLEAR:
LW_NETWR,
O_ZSEGSD0009.

REFRESH:
O_TD_ITEM_ALV,
O_TD_ITEM_ALV_INI.

LOOP AT I_TD_PROCESS INTO LST_PROCESS.
**** START UPD 2015/03/03 iSiD19 ****
*    IF SY-TABIX = 1.
**** START UPD BY ISID REN 2015/08/11 ****
*    IF SY-TABIX = LINES( I_TD_PROCESS ).
IF SY-TABIX = 1.
**** END UPD BY ISID REN 2015/08/11 ****
**** END UPD 2015/03/03 iSiD19 ****

O_ZSEGSD0009-VKORG    = LST_PROCESS-VKORG.    " 販売組織
O_ZSEGSD0009-VTWEG    = LST_PROCESS-VTWEG.    " 流通チャネル
O_ZSEGSD0009-SPART    = LST_PROCESS-SPART.    " 製品部門
O_ZSEGSD0009-VKBUR    = LST_PROCESS-VKBUR.    " 営業所
O_ZSEGSD0009-VKGRP    = LST_PROCESS-VKGRP.    " 営業グループ
O_ZSEGSD0009-ZEKUNNR1 = LST_PROCESS-KUNNR.    " 受注先
O_ZSEGSD0009-ZEKNAME1 = LST_PROCESS-NAME1.    " 受注先名称
O_ZSEGSD0009-ZEKUNNR  = LST_PROCESS-ZEKUNNR.  " 出荷先
O_ZSEGSD0009-ZEKNAME  = LST_PROCESS-ZEKNAME.  " 出荷先名称
**** START UPD 2015/03/03 iSiD19 ****
*      O_ZSEGSD0009-ZEKUNNR2 = LST_PROCESS-ZKUNNR_ZJ. " 最終需要者
*      O_ZSEGSD0009-ZEKUNNR3 = LST_PROCESS-ZKUNNR_DS. " 最終需要者(商流)
O_ZSEGSD0009-Z_ADDRESS1_DT = LST_PROCESS-Z_ADDRESS1_DT.
" 出荷先住所1
O_ZSEGSD0009-Z_ADDRESS2_DT = LST_PROCESS-Z_ADDRESS2_DT.
" 出荷先住所2
O_ZSEGSD0009-Z_ADDRESS3_DT = LST_PROCESS-Z_ADDRESS3_DT.
" 出荷先住所3
O_ZSEGSD0009-Z_ADDRESS4_DT = LST_PROCESS-Z_ADDRESS4_DT.
" 出荷先住所4
O_ZSEGSD0009-Z_VEND_NAME_DT = LST_PROCESS-Z_VEND_NAME_DT.
" 出荷先名（PO）
O_ZSEGSD0009-Z_ADDRESS_DT   = LST_PROCESS-Z_ADDRESS_DT.
" 出荷先住所（PO）
O_ZSEGSD0009-Z_TEL_DT  = LST_PROCESS-Z_TEL_DT.
" 出荷先電話番号（PO）
O_ZSEGSD0009-Z_FAX_DT  = LST_PROCESS-Z_FAX_DT.
" 出荷先FAX番号（PO）

**** START UPD BY ISID REN 2015/08/06 ****
*      O_ZSEGSD0009-INCO1     = LST_PROCESS-INCO1.  " インコタームズ (1)
*      O_ZSEGSD0009-INCO2     = LST_PROCESS-INCO2.  " インコタームズ (2)
*      O_ZSEGSD0009-ZBEZEI_IC = LST_PROCESS-ZBEZEI_IC. " テキスト
O_ZSEGSD0009-Z_LASTDEST
= LST_PROCESS-Z_LASTDEST.  "Final Destination
**** END UPD BY ISID REN 2015/08/06 ****

O_ZSEGSD0009-SUBMI     = LST_PROCESS-SUBMI.     " 一括番号
O_ZSEGSD0009-ZKUNNR_ZJ = LST_PROCESS-ZKUNNR_ZJ. " 最終需要者
O_ZSEGSD0009-ZNAME_ZJ  = LST_PROCESS-ZNAME_ZJ.  " 名称
**** START UPD BY ISID REN 2015/07/16 ****
*      O_ZSEGSD0009-ZKUNNR_DS = LST_PROCESS-ZKUNNR_DS. "最終需要者(価格)
*      O_ZSEGSD0009-ZNAME_DS = LST_PROCESS-ZNAME_DS.   "名称 1
O_ZSEGSD0009-ZKUNNR_DS
= LST_PROCESS-Z_ENDUSER_CD. "最終需要者(価格)
O_ZSEGSD0009-ZNAME_DS = LST_PROCESS-Z_NAME1_KNA1.  "名称
**** END UPD BY ISID REN 2015/07/16 ****
**** END UPD 2015/03/03 iSiD19 ****
O_ZSEGSD0009-PERNR    = LST_PROCESS-PERNR.      " 営業員
O_ZSEGSD0009-ENAME    = LST_PROCESS-ZEEMNAM.    " 営業員氏名
O_ZSEGSD0009-BSTKD    = LST_PROCESS-Z_ITEM_BSTKD.   " 購買発注番号

**** START UPD 2015/09/22 iSiD22 ****
O_ZSEGSD0009-EBELN = LST_PROCESS-BSTKD.
***** START ADD 2015/03/03 iSiD19 ****
*      IF W_FLGSOSGL IS NOT INITIAL. "販売伝票単一明細フラグ;ON
*        CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
*          EXPORTING
*            INPUT  = LST_PROCESS-EBELP
*          IMPORTING
*            OUTPUT = LW_EBELP.
*        " 購買発注番号
*        CONCATENATE LST_PROCESS-BSTKD
*                    '/'
*                    LW_EBELP
*                    INTO O_ZSEGSD0009-BSTKD.
*      ENDIF.
***** END ADD 2015/03/03 iSiD19   ****
**** END UPD 2015/09/22 iSiD22 ****

O_ZSEGSD0009-BSTDK    = LST_PROCESS-BSTDK.   " 購買発注伝票日付
O_ZSEGSD0009-AUART    = LST_PROCESS-AUART.   " 販売伝票タイプ
O_ZSEGSD0009-ZABEZEI  = LST_PROCESS-ZABEZEI.
" 販売伝票タイプテキスト
O_ZSEGSD0009-AUGRU    = LST_PROCESS-AUGRU.   " 受注理由 (取引理由)

*     D-2-1-3．販売エリアのテキストの設定処理。
SELECT SINGLE VTEXT
INTO LW_VKORGTEXT
FROM TVKOT
WHERE SPRAS = SY-LANGU
AND VKORG = LST_PROCESS-VKORG.

IF SY-SUBRC = 0
AND LW_VKORGTEXT IS NOT INITIAL.
LW_ZESALESTXT = LW_VKORGTEXT.
ENDIF.

*     D-2-1-3-2．流通チャネルの名称の取得処理
SELECT SINGLE VTEXT
INTO LW_VTWEGTEXT
FROM TVTWT
WHERE SPRAS = SY-LANGU
AND VTWEG = LST_PROCESS-VTWEG.

IF SY-SUBRC = 0
AND LW_VTWEGTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_VTWEGTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_VTWEGTEXT.
ENDIF.
ENDIF.

*     D-2-1-3-3．製品部門の名称の取得処理
SELECT SINGLE VTEXT
INTO LW_SPARTTEXT
FROM TSPAT
WHERE SPRAS = SY-LANGU
AND SPART = LST_PROCESS-SPART.

IF SY-SUBRC = 0
AND LW_SPARTTEXT IS NOT INITIAL.
IF LW_ZESALESTXT IS NOT INITIAL.
CONCATENATE LW_ZESALESTXT
LW_SPARTTEXT
INTO LW_ZESALESTXT
SEPARATED BY ','.
ELSE.
LW_ZESALESTXT = LW_SPARTTEXT.
ENDIF.
ENDIF.

O_ZSEGSD0009-ZESALESTXT = LW_ZESALESTXT." 販売エリアテキスト

*     D-2-1-4．営業所のテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = LST_PROCESS-VKBUR.

*     D-2-1-5．営業グループのテキストの設定処理。
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = LST_PROCESS-VKGRP.

*     D-2-1-5．最終需要者の名称の設定処理。
**** START UPD BY ISID REN 2015/08/21 ****
*      SELECT SINGLE NAME1
***** START UPD 2015/03/03 iSiD19 ****
**               INTO O_ZSEGSD0009-ZEKNAME2
*               INTO O_ZSEGSD0009-ZNAME_ZJ
***** END UPD 2015/03/03 iSiD19 ****
SELECT SINGLE NAME2
NAME3
INTO (LW_NAME2,
LW_NAME3)
**** END UPD BY ISID REN 2015/08/21 ****
FROM KNA1
WHERE KUNNR = LST_PROCESS-ZKUNNR_ZJ.

**** START ADD BY ISID REN 2015/08/21 ****
IF SY-SUBRC = 0.
CONCATENATE LW_NAME2
LW_NAME3
INTO O_ZSEGSD0009-ZNAME_ZJ.
ELSE.
CLEAR O_ZSEGSD0009-ZNAME_ZJ.
ENDIF.
**** END ADD BY ISID REN 2015/08/21 ****

*     D-2-1-6．最終需要者(商流)の名称の設定処理
**** START UPD BY ISID REN 2015/08/21 ****
*      SELECT SINGLE NAME1
***** START UPD 2015/03/03 iSiD19 ****
**               INTO O_ZSEGSD0009-ZEKNAME3
*               INTO O_ZSEGSD0009-ZNAME_DS
***** END UPD 2015/03/03 iSiD19 ****
SELECT SINGLE NAME2
NAME3
INTO (LW_NAME2,
LW_NAME3)
**** END UPD BY ISID REN 2015/08/21 ****
FROM KNA1
**** START UPD BY ISID REN 2015/07/16 ****
*              WHERE KUNNR = LST_PROCESS-ZKUNNR_DS.
WHERE KUNNR = LST_PROCESS-Z_ENDUSER_CD.
**** END UPD BY ISID REN 2015/07/16 ****

**** START ADD BY ISID REN 2015/08/21 ****
IF SY-SUBRC = 0.
CONCATENATE LW_NAME2
LW_NAME3
INTO O_ZSEGSD0009-ZNAME_DS.
ELSE.
CLEAR O_ZSEGSD0009-ZNAME_DS.
ENDIF.
**** END ADD BY ISID REN 2015/08/21 ****

*     D-2-1-7．受注総額の設定処理。
*     通貨単位を設定
O_ZSEGSD0009-WAERK = LST_PROCESS-WAERK.
ENDIF.

*   各明細の受注額(Net Value)を合計
CATCH SYSTEM-EXCEPTIONS ARITHMETIC_ERRORS = 4.
LW_NETWR = LW_NETWR + LST_PROCESS-NETWR.
ENDCATCH.

IF SY-SUBRC <> 0.
LW_NETWR        = CNS_NETWR_MAX.
ENDIF.

**** START ADD BY ISID REN 2015/08/28 ****
LST_ITEM_ALV-KDMAT  = LST_PROCESS-KDMAT.  "得意先品目
**** END ADD BY ISID REN 2015/08/28 ****

LST_ITEM_ALV-MATNR  = LST_PROCESS-MATNR.  " 品目コード
LST_ITEM_ALV-ARKTX  = LST_PROCESS-ARKTX.  " 品目テキスト
LST_ITEM_ALV-KWMENG = LST_PROCESS-KWMENG. " 数量
LST_ITEM_ALV-VRKME  = LST_PROCESS-VRKME.  " 単位
LST_ITEM_ALV-NETPR  = LST_PROCESS-NETPR.  " 単価
LST_ITEM_ALV-WAERK  = LST_PROCESS-WAERK.  " 通貨
LST_ITEM_ALV-KPEIN  = LST_PROCESS-KPEIN.  " /
LST_ITEM_ALV-ZVRKME = LST_PROCESS-ZVRKME. " UoM
LST_ITEM_ALV-NETWR  = LST_PROCESS-NETWR.  " 受注額
LST_ITEM_ALV-WERKS  = LST_PROCESS-WERKS.  " 出荷プラント
LST_ITEM_ALV-EDATU  = LST_PROCESS-EDATU.  " 納入期日
LST_ITEM_ALV-ZTERM  = LST_PROCESS-DZTERM. " 支払条件
**** START ADD 2015/03/03 iSiD19 ****
LST_ITEM_ALV-BSTKD  = LST_PROCESS-BSTKD.   " 購買伝票番号
LST_ITEM_ALV-EBELP  = LST_PROCESS-EBELP.   " 購買伝票の明細番号
LST_ITEM_ALV-Z_PO_ITEM_TXT = LST_PROCESS-Z_PO_ITEM_TXT." テキスト行
LST_ITEM_ALV-LGORT  = LST_PROCESS-LGORT.   " 保管場所
LST_ITEM_ALV-LGOBE  = LST_PROCESS-LGOBE.   " 保管場所テキスト
**** END ADD 2015/03/03 iSiD19   ****

**** START ADD BY ISID REN 2015/07/16 ****
LST_ITEM_ALV-PSTYV = LST_PROCESS-PSTYV. "明細カテゴリ (販売伝票)
LST_ITEM_ALV-EVERS = LST_PROCESS-EVERS. "出荷指示
LST_ITEM_ALV-Z_NETPR_VBAP
= LST_PROCESS-Z_NETPR_VBAP. "正味価格(EU)
LST_ITEM_ALV-Z_WAERK_VBAP
= LST_PROCESS-Z_WAERK_VBAP. "販売伝票通貨
LST_ITEM_ALV-Z_KPEIN_VBAP = LST_PROCESS-Z_KPEIN_VBAP. "/
LST_ITEM_ALV-Z_VRKME_VBAP = LST_PROCESS-Z_VRKME_VBAP. "販売単位
LST_ITEM_ALV-Z_TDLINE_1 = LST_PROCESS-Z_TDLINE_1. "テキスト行(1)
LST_ITEM_ALV-Z_TDLINE_2 = LST_PROCESS-Z_TDLINE_2. "テキスト行(2)
LST_ITEM_ALV-SPRAS      = LST_PROCESS-SPRAS.      "言語キー
LST_ITEM_ALV-Z_PURPOSE_TEXT = LST_PROCESS-Z_PURPOSE_TEXT.
**** END ADD BY ISID REN 2015/07/16 ****

**** START ADD BY ISID21 2015/09/22 ****
* TODO
LST_ITEM_ALV-ZMNETPR = LST_PROCESS-ZMNETPR.     "マスタ販売価格
LST_ITEM_ALV-ZMWAERK = LST_PROCESS-ZMWAERK.     "マスタ販売伝票通貨
LST_ITEM_ALV-ZMKPEIN = LST_PROCESS-ZMKPEIN.         "マスタ価格条件単位
LST_ITEM_ALV-ZMZVRKME = LST_PROCESS-ZMZVRKME.  "マスタ販売単位
LST_ITEM_ALV-Z_ITEM_BSTKD = LST_PROCESS-Z_ITEM_BSTKD.  "得意先発注番号
**** END ADD BY ISID21 2015/09/22 ****

**** START ADD BY ISID REN 2015/08/06 ****
LST_ITEM_ALV-INCO1      = LST_PROCESS-INCO1.      "Incoterms
LST_ITEM_ALV-INCO2      = LST_PROCESS-INCO2.      "Ship Terms.
**** END ADD BY ISID REN 2015/08/06 ****

*   D-2-2-2．明細番号(Item)の設定処理。
CLEAR LST_ALV_ITEM.
READ TABLE TD_ITEM_ALV_TEM INTO LST_ALV_ITEM
WITH KEY BSTKD = LST_PROCESS-BSTKD
EBELP = LST_PROCESS-EBELP
BINARY SEARCH.
IF SY-SUBRC <> 0.
LW_POSNR            = LW_POSNR + 10.
LST_ITEM_ALV-POSNR  = LW_POSNR.         " 明細番号
ELSE.
LST_ITEM_ALV-POSNR = LST_ALV_ITEM-POSNR." 明細番号
ENDIF.

LST_ITEM_ALV-BSTKD  = LST_PROCESS-BSTKD.  " 購買発注番号
LST_ITEM_ALV-EBELP  = LST_PROCESS-EBELP.  " 購買伝票の明細番号


*   D-2-2-3-2．支払条件テキストの設定処理。
**** START UPD 2015/03/03 iSiD19 ****
*    READ TABLE TD_ZTERM INTO LST_ZTERM
*                        WITH KEY ZTERM = LST_PROCESS-DZTERM
*                        BINARY SEARCH.
*
*    IF SY-SUBRC = 0.
*      LST_ITEM_ALV-TEXT1 = LST_ZTERM-TEXT1.
*    ENDIF.
LST_ITEM_ALV-TEXT1 = LST_PROCESS-TEXT1.
**** END UPD 2015/03/03 iSiD19 ****

LST_ITEM_ALV-VBTYP = LST_PROCESS-VBTYP. " 販売管理伝票カテゴリ
LST_ITEM_ALV-KARTV = LST_PROCESS-KARTV. " 条件タイプ
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV.
APPEND LST_ITEM_ALV TO O_TD_ITEM_ALV_INI.
CLEAR LST_ITEM_ALV.
ENDLOOP.

O_ZSEGSD0009-NETWR = LW_NETWR.

ENDFORM.                    " SET_SCREEN_9000
*&---------------------------------------------------------------------*
*&      Form  ALV_9000_OUPUT
*&---------------------------------------------------------------------*
*       D-2．データ設定処理
*----------------------------------------------------------------------*
*      -->I_TD_ITEM_ALV     ITAB:SCREEN9000ALV処理対象データ
*----------------------------------------------------------------------*
FORM ALV_9000_OUPUT.
DATA:
LTD_EXCLUDE        TYPE UI_FUNCTIONS,
LST_VARIANT        TYPE DISVARIANT,
LST_LAYOUT         TYPE LVC_S_LAYO,
LTD_FIELDCAT       TYPE LVC_T_FCAT,
LST_FIELDCAT       TYPE LVC_S_FCAT,
LTD_F4             TYPE LVC_T_F4,
LST_F4             TYPE LVC_S_F4,
LCL_EVENT_RECEIVER TYPE REF TO CL_EVENT_RECEIVER,
LW_VALID           TYPE C,
LW_COL             TYPE LVC_S_COL,
LW_ROW             TYPE LVC_S_ROW.

IF W_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

IF CI_ALV IS NOT INITIAL.
CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.
IF LW_VALID IS INITIAL.
RETURN.
ENDIF.
ENDIF.

IF CI_ALV IS INITIAL.
*   容器の作成
CREATE OBJECT: CI_CCONTAINER
EXPORTING
CONTAINER_NAME = CNS_CONTA.

CREATE OBJECT CI_ALV
EXPORTING
I_PARENT = CI_CCONTAINER.

*   ALVレイアウトの設定
**** START DEL BY ISID REN 2015/07/29 ****
*    LST_LAYOUT-CWIDTH_OPT = ABAP_ON.
**** END DEL BY ISID REN 2015/07/29 ****

*   ALV項目定義
CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
EXPORTING
I_STRUCTURE_NAME       = CNS_STNM010
CHANGING
CT_FIELDCAT            = LTD_FIELDCAT[]
EXCEPTIONS
INCONSISTENT_INTERFACE = 1
PROGRAM_ERROR          = 2
OTHERS                 = 3.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_E NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

LOOP AT LTD_FIELDCAT INTO LST_FIELDCAT.
**** START UPD BY ISID REN 2015/07/14 ****
*      IF LST_FIELDCAT-FIELDNAME = CNS_FNM_WAERK   " 通貨
*        OR LST_FIELDCAT-FIELDNAME = CNS_FNM_NETWR " 受注額
***** START ADD 2015/03/03 iSiD19 ****
*        OR LST_FIELDCAT-FIELDNAME = CSN_POSNR     "販売伝票明細
*        OR LST_FIELDCAT-FIELDNAME = CSN_MATNR     "品目コード
*        OR LST_FIELDCAT-FIELDNAME = CSN_ZTDLINE_M "テキスト行
*        OR LST_FIELDCAT-FIELDNAME = CSN_WERKS     "プラント
*        OR LST_FIELDCAT-FIELDNAME = CSN_EBELN     "購買伝票番号
*        OR LST_FIELDCAT-FIELDNAME = CSN_EBELP     "購買伝票の明細番号
*        OR LST_FIELDCAT-FIELDNAME = CSN_TDLINE    "テキスト行
*        OR LST_FIELDCAT-FIELDNAME = CSN_LGOBE     "保管場所テキスト
***** END ADD 2015/03/03 iSiD19   ****
*        OR LST_FIELDCAT-FIELDNAME = CNS_FNM_TEXT1.
*        " 支払条件テキスト
*        CONTINUE.
*      ENDIF.
*
*      IF LST_FIELDCAT-FIELDNAME = CNS_FNM_ZTERM.
*        LST_FIELDCAT-F4AVAILABL = ABAP_ON.
*      ENDIF.
*
***** START ADD 2015/03/03 iSiD19 ****
*      IF LST_FIELDCAT-FIELDNAME = CSN_VRKME
*      OR LST_FIELDCAT-FIELDNAME = CSN_ZVRKME.
*        LST_FIELDCAT-F4AVAILABL = ABAP_ON.
*      ENDIF.
***** END ADD 2015/03/03 iSiD19   ****
*
*      LST_FIELDCAT-EDIT = ABAP_ON.
*
***** START ADD 2015/03/03 iSiD19 ****
*      IF LST_FIELDCAT-FIELDNAME = CNS_FNM_ZTERM.
*        LST_FIELDCAT-EDIT = SPACE.
*      ENDIF.
***** END ADD 2015/03/03 iSiD19   ****
CASE LST_FIELDCAT-FIELDNAME.
WHEN CNS_FNM_WAERK  "通貨
OR CNS_FNM_NETWR  "受注額
OR CSN_POSNR      "販売伝票明細
**** START ADD BY ISID REN 2015/08/28 ****
*          OR CSN_MATNR      "品目コード
**** END ADD BY ISID REN 2015/08/28 ****
OR CSN_ZTDLINE_M  "テキスト行
OR CSN_WERKS      "プラント
OR CSN_EBELN      "購買伝票番号
OR CSN_EBELP      "購買伝票の明細番号
OR CSN_TDLINE     "テキスト行
OR CSN_LGOBE      "保管場所テキスト
OR CNS_FNM_TEXT1  "支払条件テキスト
**** START ADD BY ISID REN 2015/08/06 ****
OR CSN_INCO1      "Incoterms
OR CSN_INCO2      "Ship Terms
**** END ADD BY ISID REN 2015/08/06 ****
**** START ADD BY ISID REN 2015/08/10 ****
OR CNS_FNM_ZTERM
**** END ADD BY ISID REN 2015/08/10 ****
**** START ADD BY ISID REN 2015/08/13 ****
OR CSN_VRKME          "販売単位
OR CSN_ZVRKME         "販売単位
**** START ADD BY ISID21 2015/09/22 ****
OR CNS_ZMNETPR      "マスタ販売価格
OR CNS_ZMWAERK      "マスタ販売伝票通貨
OR CNS_ZMKPEIN        "マスタ価格条件単位
OR CNS_ZMZVRKME     "マスタ販売単位
**** END ADD BY ISID21 2015/09/22 ****
**** END ADD BY ISID REN 2015/08/13 ****
OR CNS_EVERS.     "Ship Instr.
**** START UPD BY ISID REN 2015/07/29 ****
*          CONTINUE.
LST_FIELDCAT-COL_OPT = ABAP_TRUE.
**** END UPD BY ISID REN 2015/07/29 ****

**** START ADD BY ISID REN 2015/08/28 ****
WHEN CSN_MATNR.      "品目コード
LST_FIELDCAT-OUTPUTLEN
= LST_FIELDCAT-DD_OUTLEN
+ 1. "ALV コントロール: 文字の出力長
**** END ADD BY ISID REN 2015/08/28 ****

**** START DEL BY ISID REN 2015/08/10 ****
*        WHEN CNS_FNM_ZTERM.
*          LST_FIELDCAT-F4AVAILABL = ABAP_ON.
**** END DEL BY ISID REN 2015/08/10 ****

WHEN CNS_PSTYV          "Item Cat.
**** START DEL BY ISID REN 2015/08/13 ****
*          OR CSN_VRKME          "販売単位
*          OR CSN_ZVRKME         "販売単位
**** END DEL BY ISID REN 2015/08/13 ****
**** START ADD BY ISID REN 2015/08/28 ****
OR CNS_KDMAT           "得意先が使用する品目コード
**** END ADD BY ISID REN 2015/08/28 ****
OR CNS_Z_VRKME_VBAP   "販売単位
OR CNS_Z_WAERK_VBAP.  "Net Price(EU)
**** START ADD BY ISID REN 2015/07/29 ****
LST_FIELDCAT-OUTPUTLEN
= LST_FIELDCAT-DD_OUTLEN
+ 1. "ALV コントロール: 文字の出力長
**** END ADD BY ISID REN 2015/07/29 ****
LST_FIELDCAT-F4AVAILABL = ABAP_ON.
LST_FIELDCAT-EDIT       = ABAP_ON.

**** START ADD BY ISID REN 2015/07/29 ****
WHEN 'KPEIN'         "価格条件単位
OR 'Z_KPEIN_VBAP'. "リストビューア・/
LST_FIELDCAT-OUTPUTLEN
= LST_FIELDCAT-DD_OUTLEN
+ 1. "ALV コントロール: 文字の出力長
LST_FIELDCAT-NO_ZERO = ABAP_TRUE.
LST_FIELDCAT-EDIT    = ABAP_ON.

WHEN 'Z_TDLINE_1'
OR 'Z_TDLINE_2'.
LST_FIELDCAT-OUTPUTLEN = 40.
LST_FIELDCAT-EDIT = ABAP_ON.
**** END ADD BY ISID REN 2015/07/29 ****
**** START ADD BY ISID21 2015/09/22 ****
WHEN 'Z_PURPOSE_TEXT'.
LST_FIELDCAT-OUTPUTLEN = 35.
LST_FIELDCAT-EDIT = ABAP_ON.
**** END ADD BY ISID21 2015/09/22 ****
WHEN OTHERS.
**** START ADD BY ISID REN 2015/07/29 ****
LST_FIELDCAT-OUTPUTLEN
= LST_FIELDCAT-DD_OUTLEN
+ 1. "ALV コントロール: 文字の出力長
**** END ADD BY ISID REN 2015/07/29 ****
LST_FIELDCAT-EDIT = ABAP_ON.
ENDCASE.
**** END UPD BY ISID REN 2015/07/14 ****

MODIFY LTD_FIELDCAT FROM LST_FIELDCAT.
ENDLOOP.

PERFORM EXCLUDE_TB_FUNCTIONS CHANGING LTD_EXCLUDE.

LST_VARIANT-REPORT  = SY-REPID.

**** START ADD 2015/03/03 iSiD19 ****
IF RB_ERR IS INITIAL.
LST_VARIANT-HANDLE = '2004'.
ELSE.
LST_VARIANT-HANDLE = '2005'.
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****

CALL METHOD CI_ALV->SET_TABLE_FOR_FIRST_DISPLAY
EXPORTING
IS_VARIANT                    = LST_VARIANT
IS_LAYOUT                     = LST_LAYOUT
IT_TOOLBAR_EXCLUDING          = LTD_EXCLUDE
CHANGING
IT_OUTTAB                     = TD_ITEM_ALV
IT_FIELDCATALOG               = LTD_FIELDCAT
EXCEPTIONS
INVALID_PARAMETER_COMBINATION = 1
PROGRAM_ERROR                 = 2
TOO_MANY_LINES                = 3
OTHERS                        = 4.
ELSE.

CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
ES_ROW_ID = LW_ROW
ES_COL_ID = LW_COL.

CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.

CALL METHOD CI_ALV->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LW_ROW
IS_COLUMN_ID = LW_COL.

ENDIF.

CREATE OBJECT LCL_EVENT_RECEIVER.

* 画面値が変更される時事件
SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED
FOR ALL INSTANCES.
* 画面値が変更された後事件
SET HANDLER LCL_EVENT_RECEIVER->HANDLE_DATA_CHANGED_FINISHED
FOR ALL INSTANCES.

CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_MODIFIED.

CALL METHOD CI_ALV->REGISTER_EDIT_EVENT
EXPORTING
I_EVENT_ID = CL_GUI_ALV_GRID=>MC_EVT_ENTER.

* 検索F4
REFRESH LTD_F4.
CLEAR LST_F4.
LST_F4-FIELDNAME  = CNS_FNM_ZTERM.
LST_F4-REGISTER   = ABAP_ON.
LST_F4-GETBEFORE  = ABAP_ON.
LST_F4-CHNGEAFTER = ABAP_ON.
LST_F4-INTERNAL   = SPACE.
APPEND LST_F4 TO LTD_F4.

**** START ADD BY ISID REN 2015/07/14 ****
LST_F4-FIELDNAME  = CNS_PSTYV. "Item Cat.
INSERT LST_F4 INTO TABLE LTD_F4.
**** END ADD BY ISID REN 2015/07/14 ****

CALL METHOD CI_ALV->REGISTER_F4_FOR_FIELDS
EXPORTING
IT_F4 = LTD_F4.

SET HANDLER LCL_EVENT_RECEIVER->HANDLE_F4 FOR CI_ALV.

ENDFORM.                    " ALV_9000_OUPUT
*&---------------------------------------------------------------------*
*&      Form  EXCLUDE_TB_FUNCTIONS
*&---------------------------------------------------------------------*
*       ユーザ事件を除く
*----------------------------------------------------------------------*
*      <--O_TD_EXCLUDE     ITAB:SCREEN9000ALVユーザ事件
*----------------------------------------------------------------------*
FORM EXCLUDE_TB_FUNCTIONS CHANGING O_TD_EXCLUDE TYPE UI_FUNCTIONS.
DATA:
LST_EXCLUDE TYPE UI_FUNC.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_DELETE_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_INSERT_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_APPEND_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY_ROW.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_UNDO.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_REFRESH.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_CHECK.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_CUT.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

LST_EXCLUDE = CL_GUI_ALV_GRID=>MC_MB_PASTE.
APPEND LST_EXCLUDE TO O_TD_EXCLUDE.
CLEAR LST_EXCLUDE.

ENDFORM.                    " EXCLUDE_TB_FUNCTIONS
*&---------------------------------------------------------------------*
*&      Form  CHECK_9000_ALV
*&---------------------------------------------------------------------*
*       ALV画面項目チェック
*----------------------------------------------------------------------*
**** START ADD BY ISID REN 2015/08/28 ****
*      -->I_W_SAVE_OK       OK CODE
**** END ADD BY ISID REN 2015/08/28 ****
*----------------------------------------------------------------------*
FORM CHECK_9000_ALV
**** START ADD BY ISID REN 2015/08/28 ****
USING    I_W_SAVE_OK       TYPE SY-UCOMM
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING O_TD_MODI TYPE LVC_T_CELL.

DATA:
LST_MODI       TYPE LVC_S_CELL,
LST_ALV        TYPE TYP_ALV_ITEM,
**** START ADD BY ISID REN 2015/08/29 ****
L_TD_ITEM_ALV  TYPE TYP_TD_ITEM,
LTD_KNMT   TYPE TYP_TD_KNMT, "得意先/品目情報レコードデータテーブル
LTD_KNMT_T     TYPE TYP_TD_KNMT,
LTD_MARM       TYPE TYP_TD_MARM, "品目数量単位
LST_KNMT       TYPE TYP_KNMT,
LTD_MVKE_T184  TYPE TYP_TD_MVKE_T184, "販売伝票の明細カテゴリ
LST_MVKE_T184  TYPE TYP_MVKE_T184,    "販売伝票の明細カテゴリ
LW_MSGTX       TYPE SY-MSGV1,
**** END ADD BY ISID REN 2015/08/29 ****
LW_INDEX       TYPE SY-INDEX.

CLEAR W_ERRFLG.

**** START ADD BY ISID REN 2015/08/28 ****
CASE I_W_SAVE_OK.
WHEN CNS_USER_SHOD
OR CNS_USER_SAVE.
WHEN OTHERS.
*     得意先/品目情報レコードデータテーブルの検索
L_TD_ITEM_ALV = TD_ITEM_ALV.
SORT L_TD_ITEM_ALV
BY KDMAT ASCENDING. "得意先品目
DELETE ADJACENT DUPLICATES
FROM L_TD_ITEM_ALV
COMPARING KDMAT. "得意先品目

IF L_TD_ITEM_ALV IS NOT INITIAL.
SELECT KDMAT    "得意先品目
MATNR    "品目コード
FROM KNMT     "得意先/品目情報レコードデータテーブル
INTO CORRESPONDING FIELDS OF TABLE LTD_KNMT
FOR ALL ENTRIES IN L_TD_ITEM_ALV
WHERE VKORG = ST_ZSEGSD0009-VKORG     "販売組織
AND VTWEG = ST_ZSEGSD0009-VTWEG     "流通チャネル
AND KUNNR = ST_ZSEGSD0009-ZEKUNNR1  "受注先
AND KDMAT = L_TD_ITEM_ALV-KDMAT.    "得意先品目

IF SY-SUBRC = 0.
SORT LTD_KNMT
BY KDMAT ASCENDING. "得意先品目

APPEND LINES OF LTD_KNMT TO LTD_KNMT_T.
SORT LTD_KNMT_T
BY MATNR ASCENDING.    "品目コード
DELETE ADJACENT DUPLICATES
FROM LTD_KNMT_T
COMPARING MATNR. "品目コード

*         品目単位の整合性をチェックする
SELECT MATNR "品目コード
MEINH "発注単位
FROM MARM  "品目数量単位
INTO CORRESPONDING FIELDS OF TABLE LTD_MARM
FOR ALL ENTRIES IN LTD_KNMT_T
WHERE MATNR = LTD_KNMT_T-MATNR.     "品目コード

IF SY-SUBRC = 0.
SORT LTD_MARM
BY MATNR ASCENDING  "品目コード
MEINH ASCENDING. "発注単位
ENDIF.
ENDIF.
ENDIF.

*     販売伝票の明細カテゴリの取得処理
PERFORM SEL_MVKE_T184_9000
USING ST_ZSEGSD0009-AUART "販売伝票タイプ
ST_ZSEGSD0009-VKORG "販売組織
ST_ZSEGSD0009-VTWEG "流通チャネル
LTD_KNMT_T          "得意先/品目情報レコードデータテーブル
CHANGING LTD_MVKE_T184.   "販売伝票の明細カテゴリ
ENDCASE.
**** END ADD BY ISID REN 2015/08/28 ****

LOOP AT TD_ITEM_ALV
INTO LST_ALV.

LW_INDEX = SY-TABIX.

**** START ADD BY ISID REN 2015/08/28 ****
*   得意先品目の入力必須チェック
IF LST_ALV-KDMAT IS INITIAL.
CLEAR LST_MODI.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_KDMAT.
APPEND LST_MODI TO O_TD_MODI.
W_ERRFLG = ABAP_ON.
EXIT.
ENDIF.
**** END ADD BY ISID REN 2015/08/28 ****

**** START ADD BY ISID REN 2015/08/29 ****
CASE I_W_SAVE_OK.
WHEN CNS_USER_SHOD
OR CNS_USER_SAVE.
WHEN OTHERS.
*       得意先品目マスタの存在チェック
READ TABLE LTD_KNMT INTO LST_KNMT
WITH KEY LST_ALV-KDMAT
BINARY SEARCH.

IF SY-SUBRC <> 0.
CLEAR: LST_MODI,
O_TD_MODI.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_KDMAT.
APPEND LST_MODI TO O_TD_MODI.
W_ERRFLG = ABAP_ON.
*         得意先品目 &1 は存在しません
MESSAGE S126(ZMEGSD01)
WITH LST_ALV-KDMAT
DISPLAY LIKE CNS_MSG_E.

RETURN.
ENDIF.

*       品目単位の整合性をチェックする
READ TABLE LTD_MARM TRANSPORTING NO FIELDS
WITH KEY MATNR = LST_KNMT-MATNR   "品目コード
MEINH = LST_ALV-VRKME    "代替数量単位
BINARY SEARCH.

IF SY-SUBRC <> 0.
CLEAR: LST_MODI,
O_TD_MODI.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_KDMAT.
APPEND LST_MODI TO O_TD_MODI.
W_ERRFLG = ABAP_ON.

*         数量単位: 変換
CALL FUNCTION 'CONVERSION_EXIT_CUNIT_OUTPUT'
EXPORTING
INPUT                = LST_ALV-VRKME
LANGUAGE             = SY-LANGU
IMPORTING
OUTPUT               = LW_MSGTX
EXCEPTIONS
UNIT_NOT_FOUND       = 1
OTHERS               = 2.

IF SY-SUBRC <> 0.
CLEAR LW_MSGTX.
ENDIF.

*         発注単位 &1 は品目マスタに存在しません
MESSAGE S127(ZMEGSD01)
WITH LW_MSGTX    "代替数量単位
DISPLAY LIKE CNS_MSG_E.
RETURN.
ENDIF.

*       販売伝票の明細カテゴリの取得処理
READ TABLE LTD_MVKE_T184       "販売伝票の明細カテゴリ
TRANSPORTING NO FIELDS
WITH KEY MATNR = LST_KNMT-MATNR.    "品目コード

IF SY-SUBRC <> 0.
CLEAR: LST_MODI,
O_TD_MODI.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_KDMAT.
APPEND LST_MODI TO O_TD_MODI.
W_ERRFLG = ABAP_ON.
*         明細カテゴリを決定できません
MESSAGE S129(ZMEGSD01) DISPLAY LIKE CNS_MSG_E.
RETURN.
ENDIF.
ENDCASE.
**** END ADD BY ISID REN 2015/08/29 ****

**** START DEL 2015/03/03 iSiD19 ****
*    IF LST_ALV-POSNR IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_POSNR.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
*
*    IF LST_ALV-MATNR IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_MATNR.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
*
*    IF LST_ALV-ARKTX IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_ARKTX.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
**** END DEL 2015/03/03 iSiD19 ****

IF LST_ALV-KWMENG IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_KWMENG.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

IF LST_ALV-VRKME IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_VRKME.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

*   無償の場合、正味価格がゼロ
*    IF LST_ALV-NETPR IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_NETPR.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.

IF LST_ALV-KPEIN IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_KPEIN.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

IF LST_ALV-ZVRKME IS INITIAL.
LST_MODI-ROW_ID-INDEX = LW_INDEX.
LST_MODI-COL_ID-FIELDNAME = CNS_FNM_ZVRKME.
APPEND LST_MODI TO O_TD_MODI.
CLEAR LST_MODI.
W_ERRFLG = ABAP_ON.
ENDIF.

**** START DEL 2015/03/03 iSiD19 ****
*    IF LST_ALV-WERKS IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_WERKS.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
*
*    IF LST_ALV-EDATU IS INITIAL.
*      LST_MODI-ROW_ID-INDEX = LW_INDEX.
*      LST_MODI-COL_ID-FIELDNAME = CNS_FNM_EDATU.
*      APPEND LST_MODI TO O_TD_MODI.
*      CLEAR LST_MODI.
*      W_ERRFLG = ABAP_ON.
*    ENDIF.
**** END DEL 2015/03/03 iSiD19 ****
ENDLOOP.

**** START ADD BY ISID REN 2015/08/29 ****
IF W_ERRFLG = ABAP_ON.
*   必要な入力項目すべてに入力してください
MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
ENDIF.
**** END ADD BY ISID REN 2015/08/29 ****

ENDFORM.                    " CHECK_9000_ALV
*&---------------------------------------------------------------------*
*&      Form  GET_9000_AGAIN
*&---------------------------------------------------------------------*
*       E-2．データ設定処理
*----------------------------------------------------------------------*
**** START ADD BY ISID REN 2015/08/28 ****
*      -->I_W_SAVE_OK       OK CODE
**** END ADD BY ISID REN 2015/08/28 ****
*      <--O_ZSEGSD0009      SCREEN9000ALVヘッダデータ変更値_TEM
*      <--O_TD_ITEM_ALV     SCREEN9000明細データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM GET_9000_AGAIN
**** START ADD BY ISID REN 2015/08/28 ****
USING    I_W_SAVE_OK       TYPE SY-UCOMM
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING O_ZSEGSD0009      TYPE ZSEGSD0009
O_TD_ITEM_ALV     TYPE TYP_TD_ITEM
O_W_ERRFLG        TYPE C.
DATA:
LW_KWMENG    TYPE EKPO-MENGE,
LW_MENG_ALV  TYPE EKPO-MENGE,
**** START ADD BY ISID REN 2015/08/21 ****
LW_PARVW     TYPE KNVP-PARVW,
LW_NAME2     TYPE KNA1-NAME2,
LW_NAME3     TYPE KNA1-NAME3,
**** END ADD BY ISID REN 2015/08/21 ****
**** START ADD BY ISID REN 2015/08/28 ****
LTD_KNMT     TYPE TYP_TD_KNMT,
LTD_KNMT_T   TYPE TYP_TD_KNMT,
LTD_MAKT     TYPE TYP_TD_MAKT,
LST_KNMT     TYPE TYP_KNMT,
LST_MAKT     TYPE TYP_MAKT,
LW_NAME      TYPE THEAD-TDNAME,
LTD_LINES    TYPE TABLE OF TLINE,
LST_LINES    TYPE TLINE,
LTD_MVKE_T184 TYPE TYP_TD_MVKE_T184, "販売伝票の明細カテゴリ
LST_MVKE_T184 TYPE TYP_MVKE_T184,    "販売伝票の明細カテゴリ
**** END ADD BY ISID REN 2015/08/28 ****
LW_NETWR      TYPE NETWR.

**** START ADD 2015/03/03 iSiD19 ****
DATA:
L_TD_ITEM_ALV TYPE TYP_TD_ITEM,
LTD_STORELOC TYPE HASHED TABLE OF TYP_STORELOC
WITH UNIQUE KEY WERKS LGPRO, "保管場所
LST_STORELOC TYPE TYP_STORELOC.
**** END ADD 2015/03/03 iSiD19   ****

**** START ADD 2015/10/14 iSiD21 ****
DATA:
LW_VWERK TYPE KNVV-VWERK,
LW_ZTERM  TYPE KNVV-ZTERM.
CLEAR:
LW_VWERK,
LW_ZTERM.
**** END ADD 2015/10/14 iSiD21   ****

FIELD-SYMBOLS:
<LFS_ALV>    TYPE TYP_ALV_ITEM,
<LFS_ALV1>   TYPE TYP_ALV_ITEM.

IF SY-DATAR = ABAP_ON.
W_CHANGED_9000 = ABAP_ON.
ENDIF.

**** START DEL 2015/03/03 iSiD19 ****
** E-2-1-1．営業所のテキストの再設定処理。
*  SELECT SINGLE BEZEI
*           INTO O_ZSEGSD0009-ZVBEZEI
*           FROM TVKBT
*          WHERE SPRAS = SY-LANGU
*            AND VKBUR = O_ZSEGSD0009-VKBUR.
*
*  IF SY-SUBRC <> 0.
*    CLEAR:
*      O_ZSEGSD0009-ZVBEZEI.
*  ENDIF.
**** END DEL 2015/03/03 iSiD19 ****

**** START DEL BY ISID REN 2015/08/21 ****
** E-2-1-2．営業グループのテキストの再設定処理。
*  SELECT SINGLE BEZEI
*           INTO O_ZSEGSD0009-ZTBEZEI
*           FROM TVGRT
*          WHERE SPRAS = SY-LANGU
*            AND VKGRP = O_ZSEGSD0009-VKGRP.
*
*  IF SY-SUBRC <> 0.
*    CLEAR:
*      O_ZSEGSD0009-ZTBEZEI.
*  ENDIF.
**** END DEL BY ISID REN 2015/08/21 ****

* E-2-1-3．受注先の名称の再設定処理。
SELECT NAME1 UP TO 1 ROWS                   " 受注先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME1
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR1.       " 受注先
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZEKNAME1.
ENDIF.

* E-2-1-4．出荷先の名称の再設定処理。
SELECT NAME1 UP TO 1 ROWS                   " 出荷先名称
FROM KNA1
INTO O_ZSEGSD0009-ZEKNAME
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR.       " 出荷先
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR O_ZSEGSD0009-ZEKNAME.
ENDIF.

**** START ADD BY ISID REN 2015/08/21 ****
* 受注先と販売組織の変更チェック
IF   O_ZSEGSD0009-ZEKUNNR1 <> ST_LAST_ZSEGSD0009-ZEKUNNR1 "受注先
OR O_ZSEGSD0009-VKORG    <> ST_LAST_ZSEGSD0009-VKORG.   "販売組織
*   営業所、営業グループを再取得処理
SELECT VKGRP      "営業グループ
VKBUR      "営業所
VWERK      "出荷プラント
ZTERM      "支払条件
UP TO 1 ROWS
FROM KNVV  "得意先マスタ: 販売データ
INTO (O_ZSEGSD0009-VKGRP,              "営業グループ
O_ZSEGSD0009-VKBUR,                  "営業所
LW_VWERK,                                    "出荷プラント
LW_ZTERM )                                   "支払条件
WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR1    "受注先
AND VKORG = O_ZSEGSD0009-VKORG.      "販売組織
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR: O_ZSEGSD0009-VKGRP,              "営業グループ
O_ZSEGSD0009-VKBUR.              "営業所
ENDIF.

CLEAR LW_PARVW.
CALL FUNCTION 'CONVERSION_EXIT_PARVW_INPUT'
EXPORTING
INPUT  = CNS_PAR_PE
IMPORTING
OUTPUT = LW_PARVW.

*   営業員の再設定処理
SELECT KNVP~PERNR   "営業員
PA0001~ENAME "営業員名称
UP TO 1 ROWS
FROM KNVP         "得意先マスタ　取引先機能
INNER JOIN
PA0001       "HR マスタレコード
ON KNVP~PERNR = PA0001~PERNR      " 従業員番号
INTO (O_ZSEGSD0009-PERNR,    "営業員
O_ZSEGSD0009-ENAME)    "営業員名称
WHERE KNVP~KUNNR = O_ZSEGSD0009-ZEKUNNR1     "受注先
AND KNVP~VKORG = O_ZSEGSD0009-VKORG        "販売組織
AND KNVP~VTWEG = O_ZSEGSD0009-VTWEG        "流通チャネル
AND KNVP~SPART = O_ZSEGSD0009-SPART        "製品部門
AND KNVP~PARVW = LW_PARVW                  "取引先機能
AND PA0001~BEGDA <= SY-DATUM               "開始日付
AND PA0001~ENDDA >= SY-DATUM.              "終了日付
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR: O_ZSEGSD0009-PERNR,    "営業員
O_ZSEGSD0009-ENAME.    "営業員名称
ENDIF.
ENDIF.

* 営業所のテキストの再設定処理
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZVBEZEI
FROM TVKBT
WHERE SPRAS = SY-LANGU
AND VKBUR = O_ZSEGSD0009-VKBUR.

IF SY-SUBRC <> 0.
CLEAR O_ZSEGSD0009-ZVBEZEI.
ENDIF.

* 営業グループのテキストの再設定処理
SELECT SINGLE BEZEI
INTO O_ZSEGSD0009-ZTBEZEI
FROM TVGRT
WHERE SPRAS = SY-LANGU
AND VKGRP = O_ZSEGSD0009-VKGRP.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ZTBEZEI.
ENDIF.
**** END ADD BY ISID REN 2015/08/21 ****

* E-2-1-5．最終需要者の名称の再設定処理
**** START UPD BY ISID REN 2015/08/21 ****
*  SELECT SINGLE NAME1
***** START UPD 2015/03/03 iSiD19 ****
**           INTO O_ZSEGSD0009-ZEKNAME2          " 最終需要者名称
**           FROM KNA1
**          WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR2.
*           INTO O_ZSEGSD0009-ZNAME_ZJ           " 最終需要者名称
SELECT SINGLE NAME2
NAME3
INTO (LW_NAME2,
LW_NAME3)
**** END UPD BY ISID REN 2015/08/21 ****
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZKUNNR_ZJ. " 最終需要者
**** END UPD 2015/03/03 iSiD19 ****

IF SY-SUBRC <> 0.
CLEAR:
**** START UPD 2015/03/03 iSiD19 ****
*      O_ZSEGSD0009-ZEKNAME2.
O_ZSEGSD0009-ZNAME_ZJ.
**** END UPD 2015/03/03 iSiD19 ****

**** START ADD BY ISID REN 2015/08/21 ****
ELSE.
CONCATENATE LW_NAME2
LW_NAME3
INTO O_ZSEGSD0009-ZNAME_ZJ.
**** END ADD BY ISID REN 2015/08/21 ****
ENDIF.

* E-2-1-6．最終需要者(商流)の名称の再設定処理
**** START UPD BY ISID REN 2015/08/21 ****
*  SELECT SINGLE NAME1
***** START UPD 2015/03/03 iSiD19 ****
**           INTO O_ZSEGSD0009-ZEKNAME3         " 最終需要者(商流)名称
**           FROM KNA1
**          WHERE KUNNR = O_ZSEGSD0009-ZEKUNNR3.
*           INTO O_ZSEGSD0009-ZNAME_DS         " 最終需要者(商流)名称
SELECT SINGLE NAME2
NAME3
INTO (LW_NAME2,
LW_NAME3)
**** END UPD BY ISID REN 2015/08/21 ****
FROM KNA1
WHERE KUNNR = O_ZSEGSD0009-ZKUNNR_DS. " 最終需要者(商流)
**** END UPD 2015/03/03 iSiD19 ****

IF SY-SUBRC <> 0.
CLEAR:
**** START UPD 2015/03/03 iSiD19 ****
*      O_ZSEGSD0009-ZEKNAME3.
O_ZSEGSD0009-ZNAME_DS.
**** END UPD 2015/03/03 iSiD19 ****

**** START ADD BY ISID REN 2015/08/21 ****
ELSE.
CONCATENATE LW_NAME2
LW_NAME3
INTO O_ZSEGSD0009-ZNAME_DS.
**** END ADD BY ISID REN 2015/08/21 ****
ENDIF.

* E-2-1-7．営業員の氏名の再設定処理
SELECT ENAME UP TO 1 ROWS
INTO O_ZSEGSD0009-ENAME            " 営業員の氏名
FROM PA0001
WHERE PERNR =  O_ZSEGSD0009-PERNR   " 営業員
AND BEGDA <= SY-DATUM             " 開始日付
AND ENDDA >= SY-DATUM.            " 終了日付
ENDSELECT.

IF SY-SUBRC <> 0.
CLEAR:
O_ZSEGSD0009-ENAME.
ENDIF.

* 通貨チェック
PERFORM CHK_WAERK CHANGING O_W_ERRFLG.

**** START ADD 2015/03/03 iSiD19 ****
* 保管場所のテキストの設定処理
L_TD_ITEM_ALV = O_TD_ITEM_ALV.
SORT L_TD_ITEM_ALV BY WERKS LGORT.
DELETE ADJACENT DUPLICATES FROM L_TD_ITEM_ALV
COMPARING WERKS LGORT.

IF L_TD_ITEM_ALV IS NOT INITIAL.
SELECT WERKS
LGORT AS LGPRO
LGOBE
INTO CORRESPONDING FIELDS OF TABLE LTD_STORELOC
FROM T001L
FOR ALL ENTRIES IN L_TD_ITEM_ALV
WHERE WERKS = L_TD_ITEM_ALV-WERKS
AND LGORT = L_TD_ITEM_ALV-LGORT.
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****

**** START ADD BY ISID REN 2015/08/28 ****
* 得意先/品目情報レコードデータテーブルの検索
L_TD_ITEM_ALV = O_TD_ITEM_ALV.
SORT L_TD_ITEM_ALV
BY KDMAT ASCENDING. "得意先品目
DELETE ADJACENT DUPLICATES
FROM L_TD_ITEM_ALV
COMPARING KDMAT. "得意先品目

IF L_TD_ITEM_ALV IS NOT INITIAL.
SELECT KDMAT    "得意先品目
MATNR    "品目コード
FROM KNMT     "得意先/品目情報レコードデータテーブル
INTO CORRESPONDING FIELDS OF TABLE LTD_KNMT
FOR ALL ENTRIES IN L_TD_ITEM_ALV
WHERE VKORG = O_ZSEGSD0009-VKORG     "販売組織
AND VTWEG = O_ZSEGSD0009-VTWEG     "流通チャネル
AND KUNNR = O_ZSEGSD0009-ZEKUNNR1  "受注先
AND KDMAT =  L_TD_ITEM_ALV-KDMAT.  "得意先品目

IF SY-SUBRC = 0.
SORT LTD_KNMT
BY KDMAT ASCENDING. "得意先品目

APPEND LINES OF LTD_KNMT TO LTD_KNMT_T.
SORT LTD_KNMT_T
BY MATNR ASCENDING.    "品目コード
DELETE ADJACENT DUPLICATES
FROM LTD_KNMT_T
COMPARING MATNR. "品目コード

*     得意先マスタ: 販売データの検索
SELECT MATNR                  "品目コード
MAKTX                  "品目テキスト
FROM MAKT                   "得意先マスタ: 販売データ
INTO CORRESPONDING FIELDS OF TABLE LTD_MAKT
FOR ALL ENTRIES IN LTD_KNMT_T
WHERE MATNR = LTD_KNMT_T-MATNR     "品目コード
AND SPRAS = SY-LANGU.            "言語キー

IF SY-SUBRC = 0.
SORT LTD_MAKT
BY MATNR ASCENDING. "品目コード
ENDIF.
ENDIF.
ENDIF.

* 販売伝票の明細カテゴリの取得処理
PERFORM SEL_MVKE_T184_9000
USING O_ZSEGSD0009-AUART     "販売伝票タイプ
O_ZSEGSD0009-VKORG     "販売組織
O_ZSEGSD0009-VTWEG     "流通チャネル
LTD_KNMT_T             "得意先/品目情報レコードデータテーブル
CHANGING LTD_MVKE_T184.      "販売伝票の明細カテゴリ
**** END ADD BY ISID REN 2015/08/28 ****

*  E-2-2-2．明細の数量と金額項目が変更された場合、
*  受注額の再計算処理を行う。
CLEAR LW_NETWR.
LOOP AT O_TD_ITEM_ALV ASSIGNING <LFS_ALV>.
CLEAR:
LW_KWMENG,
LW_MENG_ALV.

**** START ADD BY ISID21 2015/10/14 ****
* 受注先と販売組織の変更チェック
IF   O_ZSEGSD0009-ZEKUNNR1 <> ST_LAST_ZSEGSD0009-ZEKUNNR1 "受注先
OR O_ZSEGSD0009-VKORG    <> ST_LAST_ZSEGSD0009-VKORG.   "販売組織
*    出荷プラントと支払条件を明細に設定する。
<LFS_ALV>-WERKS = LW_VWERK.
<LFS_ALV>-ZTERM = LW_ZTERM.
ENDIF.
**** END ADD BY ISID21 2015/10/14 ****

**** START ADD BY ISID21 2015/09/22 ****
*  購買発注番号の再設定
IF SY-TABIX = 1.
O_ZSEGSD0009-BSTKD = <LFS_ALV>-Z_ITEM_BSTKD.
ENDIF.
**** END ADD BY ISID21 2015/09/22 ****

**** START ADD BY ISID REN 2015/08/28 ****
*   品目コードの再取得
READ TABLE LTD_KNMT INTO LST_KNMT
WITH KEY KDMAT = <LFS_ALV>-KDMAT "得意先品目
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_ALV>-MATNR = LST_KNMT-MATNR.  "品目コード

*     品目テキストを取得する
CLEAR LW_NAME.
LW_NAME+0(18) = <LFS_ALV>-MATNR.     "品目コード
LW_NAME+18(4) = O_ZSEGSD0009-VKORG.  "販売組織
LW_NAME+22(2) = O_ZSEGSD0009-VTWEG.  "流通チャネル
CLEAR LTD_LINES.

IF W_FLGHEADOF = ABAP_ON.
READ TABLE LTD_MAKT
INTO LST_MAKT
WITH KEY MATNR = <LFS_ALV>-MATNR.  "品目コード

IF SY-SUBRC = 0.
<LFS_ALV>-ARKTX = LST_MAKT-MAKTX. "品目テキスト
ELSE.
CLEAR <LFS_ALV>-ARKTX. "品目テキスト
ENDIF.
ELSE.
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = '0001'
LANGUAGE                = SY-LANGU
NAME                    = LW_NAME
OBJECT                  = 'MVKE'
TABLES
LINES                   = LTD_LINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

IF SY-SUBRC = 0
AND LINES( LTD_LINES ) > 0.
CLEAR LST_LINES.
READ TABLE LTD_LINES
INTO LST_LINES INDEX 1.

<LFS_ALV>-ARKTX = LST_LINES-TDLINE. "品目テキスト
ELSE.
READ TABLE LTD_MAKT
INTO LST_MAKT
WITH KEY MATNR = <LFS_ALV>-MATNR.  "品目コード

IF SY-SUBRC = 0.
<LFS_ALV>-ARKTX = LST_MAKT-MAKTX. "品目テキスト
ELSE.
CLEAR <LFS_ALV>-ARKTX. "品目テキスト
ENDIF.
ENDIF.
ENDIF.
ELSE.
CLEAR: <LFS_ALV>-MATNR, "品目コード
<LFS_ALV>-ARKTX. "品目テキスト
ENDIF.
**** END ADD BY ISID REN 2015/08/28 ****

IF <LFS_ALV>-KWMENG > CNS_MENG_MAX.
LW_MENG_ALV = CNS_MENG_MAX.
ELSE.
LW_MENG_ALV = <LFS_ALV>-KWMENG.
ENDIF.

CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR              = <LFS_ALV>-MATNR
I_IN_ME              = <LFS_ALV>-VRKME
I_OUT_ME             = <LFS_ALV>-ZVRKME
I_MENGE              = LW_MENG_ALV
IMPORTING
E_MENGE              = LW_KWMENG
EXCEPTIONS
ERROR_IN_APPLICATION = 1
ERROR                = 2
OTHERS               = 3.

IF SY-SUBRC <> 0.
**** START ADD BY ISID REN 2015/08/28 ****
IF    I_W_SAVE_OK = CNS_USER_SAPP
AND <LFS_ALV>-MATNR <> SPACE.
**** END ADD BY ISID REN 2015/08/28 ****
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
EXIT.
**** START ADD BY ISID REN 2015/08/28 ****
ELSE.
<LFS_ALV>-NETWR = 0.
ENDIF.
**** END ADD BY ISID REN 2015/08/28 ****
ELSE.
IF <LFS_ALV>-KPEIN = 0.
<LFS_ALV>-NETWR = 0.
ELSE.
CATCH SYSTEM-EXCEPTIONS ARITHMETIC_ERRORS = 4.
<LFS_ALV>-NETWR = LW_KWMENG
* <LFS_ALV>-NETPR
/ <LFS_ALV>-KPEIN.
LW_NETWR = <LFS_ALV>-NETWR + LW_NETWR.
ENDCATCH.

IF SY-SUBRC <> 0.
<LFS_ALV>-NETWR = CNS_NETWR_MAX.
LW_NETWR        = CNS_NETWR_MAX.
ENDIF.
ENDIF.
ENDIF.

**** START ADD 2015/03/03 iSiD19 ****
*   保管場所のテキストの設定処理
READ TABLE LTD_STORELOC INTO LST_STORELOC
WITH TABLE KEY WERKS = <LFS_ALV>-WERKS
LGPRO = <LFS_ALV>-LGORT.
IF SY-SUBRC = 0.
<LFS_ALV>-LGOBE = LST_STORELOC-LGOBE.
ELSE.
<LFS_ALV>-LGOBE = SPACE.
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****

**** START ADD BY ISID REN 2015/08/28 ****
*   受注明細の明細カテゴリを再決定する
IF    <LFS_ALV>-MATNR IS NOT INITIAL
AND <LFS_ALV>-PSTYV IS INITIAL.        "明細カテゴリ
READ TABLE LTD_MVKE_T184 TRANSPORTING PSTYV
INTO LST_MVKE_T184
WITH KEY MATNR = <LFS_ALV>-MATNR     "品目コード
BINARY SEARCH.

IF SY-SUBRC = 0.
<LFS_ALV>-PSTYV = LST_MVKE_T184-PSTYV.
ENDIF.
ENDIF.
**** END ADD BY ISID REN 2015/08/28 ****

**** START ADD 2015/09/22 iSiD21 ****
* 販売価格マスタの販売情報を追加設定する。
IF <LFS_ALV>-MATNR IS NOT INITIAL.
LW_KWMENG = <LFS_ALV>-KWMENG.

PERFORM GET_MASTER_PRICE
USING O_ZSEGSD0009-VKORG
O_ZSEGSD0009-VTWEG
O_ZSEGSD0009-SPART
O_ZSEGSD0009-ZEKUNNR1
<LFS_ALV>-KDMAT
<LFS_ALV>-MATNR
LW_KWMENG
<LFS_ALV>-VRKME
CHANGING
<LFS_ALV>-ZMNETPR
<LFS_ALV>-ZMWAERK
<LFS_ALV>-ZMKPEIN
<LFS_ALV>-ZMZVRKME.
ENDIF.
**** END ADD 2015/09/22 iSiD21     ****
ENDLOOP.

O_ZSEGSD0009-NETWR = LW_NETWR.

*  E-2-2-3．ヘッダの通貨項目が変更された場合、
* 「FS:明細」-通貨は同様に設定
IF O_W_ERRFLG IS INITIAL.
LOOP AT O_TD_ITEM_ALV ASSIGNING <LFS_ALV1>.
<LFS_ALV1>-WAERK = O_ZSEGSD0009-WAERK.
ENDLOOP.
ENDIF.

ENDFORM.                    " GET_9000_AGAIN
**** START DEL BY ISID REN 2015/08/21 ****
**&--------------------------------------------------------------------*
**&      Form  LOCK_ZTEGSDT203_H
**&--------------------------------------------------------------------*
**       ロック処理
**---------------------------------------------------------------------*
**      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
**      <--O_W_ERRFLG       エラーフラッグ
**---------------------------------------------------------------------*
*FORM LOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE ZSEGSD0009
*                     CHANGING O_W_ERRFLG   TYPE C.
*  DATA LW_EBELN TYPE ZTEGSDT203-EBELN.
*
*  LW_EBELN = I_ST_ZSEGSD0009-BSTKD.
*
*  CALL FUNCTION 'ENQUEUE_EZZTEGSDT203'
*    EXPORTING
*      MODE_ZTEGSDT203 = 'E'
*      EBELN           = LW_EBELN
*    EXCEPTIONS
*      FOREIGN_LOCK    = 1
*      SYSTEM_FAILURE  = 2
*      OTHERS          = 3.
*
*  IF SY-SUBRC <> 0.
*    MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
*               WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
*               DISPLAY LIKE CNS_MSG_E.
*
*    O_W_ERRFLG = ABAP_ON.
*  ENDIF.
*
*ENDFORM.                    " LOCK_ZTEGSDT203_H
**** END DEL BY ISID REN 2015/08/21 ****
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       ロックの解除
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009   SCREEN9000ALVヘッダデータ変更値
*----------------------------------------------------------------------*
FORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009  TYPE ZSEGSD0009.
**** START UPD BY ISID REN 2015/08/21 ****
*  DATA LW_EBELN TYPE ZTEGSDT203-EBELN.
*
*  LW_EBELN = I_ST_ZSEGSD0009-BSTKD.
*
*  CALL FUNCTION 'DEQUEUE_EZZTEGSDT203'
*    EXPORTING
*      MODE_ZTEGSDT203 = 'E'
*      EBELN           = LW_EBELN.
CALL FUNCTION 'DEQUEUE_ALL'.
**** END UPD BY ISID REN 2015/08/21 ****
ENDFORM.                    " LOCK_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*       F-2．データ更新処理
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_H USING I_ST_ZSEGSD0009 TYPE ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
CHANGING O_W_ERRFLG      TYPE C.
DATA:
LST_ALV  TYPE TYP_ALV_ITEM,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_DATUM TYPE SY-DATUM,
LW_UZEIT TYPE SY-UZEIT,
LW_MENG  TYPE BSTMG.

LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.
LW_EBELN = I_ST_ZSEGSD0009-EBELN.

CLEAR LW_MENG.
IF LST_ALV-KWMENG > CNS_MENG_MAX.
LW_MENG = CNS_MENG_MAX.
ELSE.
LW_MENG = LST_ALV-KWMENG.
ENDIF.

UPDATE ZTEGSDT203
SET ZKBUNCC      = CNS_KBUNCC_2          " 処理区分
STATUS       = CNS_STATUS_A          " ステータス
VKBUR        = I_ST_ZSEGSD0009-VKBUR " 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP " 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1 " 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR  " 出荷先
**** START UPD 2015/03/03 iSiD19 ****
*           ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2 " 最終需要者
*           ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3 " 最終需要者(商流)
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZKUNNR_ZJ " 最終需要者
ZKUNNR_ZE    = I_ST_ZSEGSD0009-ZKUNNR_DS " 最終需要者(商流)
**** END UPD 2015/03/03 iSiD19 ****
PERNR        = I_ST_ZSEGSD0009-PERNR     " 営業員
AUGRU        = I_ST_ZSEGSD0009-AUGRU " 受注理由 (取引理由)
**** START ADD BY ISID REN 2015/08/28 ****
KDMAT         = LST_ALV-KDMAT        "得意先品目
MATNR_SO      = LST_ALV-MATNR        "品目コード
**** END ADD BY ISID REN 2015/08/28 ****
**** START DEL 2015/03/03 iSiD19 ****
*           MATNR        = LST_ALV-MATNR      " 品目コード
*           TXZ01        = LST_ALV-ARKTX      " テキスト (短)
**** END DEL 2015/03/03 iSiD19 ****
**** START ADD BY ISID REN 2015/07/16 ****
AUART         = I_ST_ZSEGSD0009-AUART "販売伝票タイプ
PSTYV         = LST_ALV-PSTYV      "明細カテゴリ
NETPR_EU      = LST_ALV-Z_NETPR_VBAP  "正味価格EU
WAERK_EU      = LST_ALV-Z_WAERK_VBAP  "通貨EU
KPEIN_EU      = LST_ALV-Z_KPEIN_VBAP  "価格条件単位EU
KMEIN_EU      = LST_ALV-Z_VRKME_VBAP  "条件単位EU
Z_SHP_REMARK1 = LST_ALV-Z_TDLINE_1 "出荷指示備考(1)
Z_SHP_REMARK2 = LST_ALV-Z_TDLINE_2 "出荷指示備考(2)
**** END ADD BY ISID REN 2015/07/16 ****
MENGE        = LW_MENG            " 購買発注量
**** START DEL BY ISID REN 2015/08/13 ****
*           MEINS        = LST_ALV-VRKME      "発注単位
**** END DEL BY ISID REN 2015/08/13 ****
NETPR        = LST_ALV-NETPR      " 正味価格
**** START DEL 2015/03/03 iSiD19 ****
*           WAERS        = LST_ALV-WAERK      " 通貨コード
**** END DEL 2015/03/03 iSiD19 ****
**** START DEL BY ISID REN 2015/08/13 ****
*           PEINH        = LST_ALV-KPEIN      " 価格単位
**** END DEL BY ISID REN 2015/08/13 ****
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
**** START UPD 2015/03/03 iSiD19 ****
ZTERM        = LST_ALV-ZTERM      " 支払条件キー
LGORT_SO     = LST_ALV-LGORT       "保管場所
**** END UPD 2015/03/03 iSiD19 ****
**** START ADD BY ISID21 2015/09/22 ****
Z_PURPOSE_TEXT = LST_ALV-Z_PURPOSE_TEXT "用途
Z_ITEM_BSTKD = LST_ALV-Z_ITEM_BSTKD  "得意先発注番号
**** END ADD BY ISID21 2015/09/22 ****
Z_MOD_YMD    = LW_DATUM           " 更新年月日
Z_MOD_HMS    = LW_UZEIT           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新者
WHERE EBELN = LW_EBELN
AND EBELP = LST_ALV-EBELP.

IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
O_W_ERRFLG = ABAP_ON.
ROLLBACK WORK.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.

*   データ更新に失敗しました(TBL = &1)
MESSAGE S024(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  APP_9000_DATA
*&---------------------------------------------------------------------*
*       G.Approve
*----------------------------------------------------------------------*
*      -->I_ST_ZSEGSD0009    SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV      SCREEN9000明細データ
*      <--O_TD_PROCESS       ITAB:ALV処理対象データ
*----------------------------------------------------------------------*
FORM APP_9000_DATA USING I_ST_ZSEGSD0009   TYPE ZSEGSD0009
I_TD_ITEM_ALV     TYPE TYP_TD_ITEM
CHANGING O_TD_PROCESS      TYPE TYP_TD_ERRALVDATA.
DATA:
LST_PROCESS   TYPE TYP_ERR_ALVDATA,
LST_ITEM_ALV  TYPE TYP_ALV_ITEM.

LOOP AT I_TD_ITEM_ALV INTO LST_ITEM_ALV.
LST_PROCESS-VKORG     = I_ST_ZSEGSD0009-VKORG.  " 販売組織
LST_PROCESS-VTWEG     = I_ST_ZSEGSD0009-VTWEG.  " 流通チャネル
LST_PROCESS-SPART     = I_ST_ZSEGSD0009-SPART.  " 製品部門
LST_PROCESS-VKBUR     = I_ST_ZSEGSD0009-VKBUR.  " 営業所
LST_PROCESS-VKGRP     = I_ST_ZSEGSD0009-VKGRP.  " 営業グループ
LST_PROCESS-KUNNR     = I_ST_ZSEGSD0009-ZEKUNNR1. " 受注先
LST_PROCESS-NAME1     = I_ST_ZSEGSD0009-ZEKNAME1. " 受注先名称
LST_PROCESS-ZEKUNNR   = I_ST_ZSEGSD0009-ZEKUNNR.  " 出荷先
LST_PROCESS-ZEKNAME   = I_ST_ZSEGSD0009-ZEKNAME.  " 出荷先名称
**** START UPD 2015/03/03 iSiD19 ****
*    LST_PROCESS-ZKUNNR_ZJ = I_ST_ZSEGSD0009-ZEKUNNR2. "最終需要者
*    LST_PROCESS-ZKUNNR_DS = I_ST_ZSEGSD0009-ZEKUNNR3. "最終需要者(商流)
LST_PROCESS-ZKUNNR_ZJ = I_ST_ZSEGSD0009-ZKUNNR_ZJ. " 最終需要者

**** START UPD BY ISID REN 2015/07/16 ****
*    LST_PROCESS-ZKUNNR_DS
*      = I_ST_ZSEGSD0009-ZKUNNR_DS. " 最終需要者(商流)
LST_PROCESS-Z_ENDUSER_CD
= I_ST_ZSEGSD0009-ZKUNNR_DS. "エンドユーザ（価格)
**** END UPD BY ISID REN 2015/07/16 ****

LST_PROCESS-Z_VEND_NAME_DT = I_ST_ZSEGSD0009-Z_VEND_NAME_DT.
" 出荷先名称
LST_PROCESS-Z_ADDRESS1_DT = I_ST_ZSEGSD0009-Z_ADDRESS1_DT.
" 出荷先住所1
LST_PROCESS-Z_ADDRESS2_DT = I_ST_ZSEGSD0009-Z_ADDRESS2_DT.
" 出荷先住所2
LST_PROCESS-Z_ADDRESS3_DT = I_ST_ZSEGSD0009-Z_ADDRESS3_DT.
" 出荷先住所3
LST_PROCESS-Z_ADDRESS4_DT = I_ST_ZSEGSD0009-Z_ADDRESS4_DT.
" 出荷先住所4
LST_PROCESS-Z_TEL_DT = I_ST_ZSEGSD0009-Z_TEL_DT.
" 出荷先電話番号（PO）
LST_PROCESS-Z_FAX_DT = I_ST_ZSEGSD0009-Z_FAX_DT.
" 出荷先FAX番号（PO）
**** START DEL BY ISID REN 2015/08/06 ****
*    LST_PROCESS-INCO1 = I_ST_ZSEGSD0009-INCO1. " インコタームズ (1)
*    LST_PROCESS-INCO2 = I_ST_ZSEGSD0009-INCO2. " インコタームズ (2)
**** START DEL BY ISID REN 2015/08/06 ****
LST_PROCESS-SUBMI = I_ST_ZSEGSD0009-SUBMI. " 一括番号
**** END UPD 2015/03/03 iSiD19 ****
LST_PROCESS-PERNR     = I_ST_ZSEGSD0009-PERNR. " 営業員
LST_PROCESS-ZEEMNAM   = I_ST_ZSEGSD0009-ENAME. " 営業員氏名
LST_PROCESS-BSTKD     = I_ST_ZSEGSD0009-EBELN. " 購買発注番号
LST_PROCESS-BSTDK     = I_ST_ZSEGSD0009-BSTDK. " 購買発注伝票日付
LST_PROCESS-AUART     = I_ST_ZSEGSD0009-AUART. " 販売伝票タイプ
LST_PROCESS-ZABEZEI   = I_ST_ZSEGSD0009-ZABEZEI. " 内容説明
LST_PROCESS-AUGRU     = I_ST_ZSEGSD0009-AUGRU. " 受注理由 (取引理由)
**** START ADD BY ISID REN 2015/08/06 ****
LST_PROCESS-Z_LASTDEST = I_ST_ZSEGSD0009-Z_LASTDEST. "最終仕向地
LST_PROCESS-INCO1     = LST_ITEM_ALV-INCO1.    "インコタームズ
LST_PROCESS-INCO2     = LST_ITEM_ALV-INCO2.    "取引条件
**** END ADD BY ISID REN 2015/08/06 ****
LST_PROCESS-MATNR     = LST_ITEM_ALV-MATNR.    " 品目コード
LST_PROCESS-ARKTX     = LST_ITEM_ALV-ARKTX.    " 品目テキスト
LST_PROCESS-KWMENG    = LST_ITEM_ALV-KWMENG.   " 数量
LST_PROCESS-VRKME     = LST_ITEM_ALV-VRKME.    " 単位
LST_PROCESS-NETPR     = LST_ITEM_ALV-NETPR.    " 単価
LST_PROCESS-WAERK     = LST_ITEM_ALV-WAERK.    " 通貨
LST_PROCESS-KPEIN     = LST_ITEM_ALV-KPEIN.    " /
LST_PROCESS-ZVRKME    = LST_ITEM_ALV-ZVRKME.   " UoM
LST_PROCESS-NETWR     = LST_ITEM_ALV-NETWR.    " 受注額
LST_PROCESS-WERKS     = LST_ITEM_ALV-WERKS.    " 出荷プラント
LST_PROCESS-EDATU     = LST_ITEM_ALV-EDATU.    " 納入期日
LST_PROCESS-DZTERM    = LST_ITEM_ALV-ZTERM.    " 支払条件
**** START UPD 2015/03/03 iSiD19 ****
LST_PROCESS-LGORT    = LST_ITEM_ALV-LGORT.     " 保管場所
**** END UPD 2015/03/03 iSiD19 ****
**** START ADD BY ISID REN 2015/07/16 ****
LST_PROCESS-PSTYV = LST_ITEM_ALV-PSTYV. "明細カテゴリ (販売伝票)
LST_PROCESS-Z_NETPR_VBAP
= LST_ITEM_ALV-Z_NETPR_VBAP. "正味価格(EU)
LST_PROCESS-Z_WAERK_VBAP
= LST_ITEM_ALV-Z_WAERK_VBAP. "販売伝票通貨
LST_PROCESS-Z_KPEIN_VBAP = LST_ITEM_ALV-Z_KPEIN_VBAP. "/
LST_PROCESS-Z_VRKME_VBAP = LST_ITEM_ALV-Z_VRKME_VBAP. "販売単位
LST_PROCESS-Z_TDLINE_1 = LST_ITEM_ALV-Z_TDLINE_1. "テキスト行(1)
LST_PROCESS-Z_TDLINE_2 = LST_ITEM_ALV-Z_TDLINE_2. "テキスト行(2)
LST_PROCESS-SPRAS      = LST_ITEM_ALV-SPRAS.      "言語キー
LST_PROCESS-Z_PO_ITEM_TXT
= LST_ITEM_ALV-Z_PO_ITEM_TXT. "購買発注明細テキスト
LST_PROCESS-Z_PURPOSE_TEXT
= LST_ITEM_ALV-Z_PURPOSE_TEXT. "用途（PO）
**** END ADD BY ISID REN 2015/07/16 ****
LST_PROCESS-EBELP     = LST_ITEM_ALV-EBELP.    "購買伝票の明細番号
LST_PROCESS-VBTYP     = LST_ITEM_ALV-VBTYP.   "販売管理伝票カテゴリ
LST_PROCESS-KARTV     = LST_ITEM_ALV-KARTV.    "条件タイプ
**** START ADD BY ISID21 2015/09/22 ****
LST_PROCESS-Z_ITEM_BSTKD = LST_ITEM_ALV-Z_ITEM_BSTKD.  "得意先発注番号
**** END ADD BY ISID21 2015/09/22 ****
APPEND LST_PROCESS TO O_TD_PROCESS.
CLEAR LST_PROCESS.
ENDLOOP.

ENDFORM.                    " APP_9000_DATA
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_9000
*&---------------------------------------------------------------------*
*       G-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_KBUNCC         処理区分
*      -->I_STATUS         ステータス
*      -->I_ST_ZSEGSD0009  SCREEN9000ALVヘッダデータ変更値
*      -->I_TD_ITEM_ALV    SCREEN9000明細データ
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_9000 USING I_KBUNCC        TYPE C
I_STATUS        TYPE C
I_ST_ZSEGSD0009 TYPE ZSEGSD0009
I_TD_ITEM_ALV   TYPE TYP_TD_ITEM
CHANGING O_W_ERRFLG   TYPE C.
DATA:
LST_ALV  TYPE TYP_ALV_ITEM,
LFG_ERR  TYPE C,
LW_EBELN TYPE EBELN,
LW_DATUM TYPE SY-DATUM,
LW_UZEIT TYPE SY-UZEIT,
LW_MENG  TYPE BSTMG.

LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_ITEM_ALV INTO LST_ALV.
LW_EBELN = I_ST_ZSEGSD0009-EBELN.

CLEAR LW_MENG.
IF LST_ALV-KWMENG > CNS_MENG_MAX.
LW_MENG = CNS_MENG_MAX.
ELSE.
LW_MENG = LST_ALV-KWMENG.
ENDIF.

UPDATE ZTEGSDT203
SET ZKBUNCC      = I_KBUNCC            " 処理区分
STATUS       = I_STATUS            " ステータス
MSGTX        = SPACE               " メッセージ
VKBUR        = I_ST_ZSEGSD0009-VKBUR  " 営業所
VKGRP        = I_ST_ZSEGSD0009-VKGRP  " 営業グループ
KUNNR        = I_ST_ZSEGSD0009-ZEKUNNR1 " 受注先
ZKUNNR_S     = I_ST_ZSEGSD0009-ZEKUNNR  " 出荷先
**** START UPD 2015/03/03 iSiD19 ****
*           ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZEKUNNR2 " 最終需要者
*           ZKUNNR_DS    = I_ST_ZSEGSD0009-ZEKUNNR3 " 最終需要者(商流)
ZKUNNR_ZJ    = I_ST_ZSEGSD0009-ZKUNNR_ZJ " 最終需要者
ZKUNNR_ZE    = I_ST_ZSEGSD0009-ZKUNNR_DS " 最終需要者(商流)
**** END UPD 2015/03/03 iSiD19 ****
PERNR        = I_ST_ZSEGSD0009-PERNR     " 営業員
AUGRU        = I_ST_ZSEGSD0009-AUGRU     "受注理由 (取引理由)
**** START ADD BY ISID REN 2015/08/28 ****
KDMAT        = LST_ALV-KDMAT             "得意先品目
MATNR_SO     = LST_ALV-MATNR             "品目コード
**** END ADD BY ISID REN 2015/08/28 ****
**** START ADD BY ISID REN 2015/07/16 ****
AUART         = I_ST_ZSEGSD0009-AUART "販売伝票タイプ
PSTYV         = LST_ALV-PSTYV         "明細カテゴリ
NETPR_EU      = LST_ALV-Z_NETPR_VBAP  "正味価格EU
WAERK_EU      = LST_ALV-Z_WAERK_VBAP  "通貨EU
KPEIN_EU      = LST_ALV-Z_KPEIN_VBAP  "価格条件単位EU
KMEIN_EU      = LST_ALV-Z_VRKME_VBAP  "条件単位EU
Z_SHP_REMARK1 = LST_ALV-Z_TDLINE_1 "出荷指示備考(1)
Z_SHP_REMARK2 = LST_ALV-Z_TDLINE_2 "出荷指示備考(2)
**** END ADD BY ISID REN 2015/07/16 ****
**** START DEL 2015/03/03 iSiD19 ****
*           MATNR        = LST_ALV-MATNR      " 品目コード
*           TXZ01        = LST_ALV-ARKTX      " テキスト (短)
**** END DEL 2015/03/03 iSiD19 ****
MENGE        = LW_MENG            " 購買発注量
**** START DEL BY ISID REN 2015/08/13 ****
*           MEINS        = LST_ALV-VRKME      " 発注単位
**** END DEL BY ISID REN 2015/08/13 ****
NETPR        = LST_ALV-NETPR      " 正味価格
**** START DEL 2015/03/03 iSiD19 ****
*           WAERS        = LST_ALV-WAERK      " 通貨コード
**** END DEL 2015/03/03 iSiD19 ****
**** START DEL BY ISID REN 2015/08/13 ****
*           PEINH        = LST_ALV-KPEIN      " 価格単位
**** END DEL BY ISID REN 2015/08/13 ****
BPRME        = LST_ALV-ZVRKME     " 購買発注価格単位
NETWR        = LST_ALV-NETWR      " 正味発注額
DWERK        = LST_ALV-WERKS      " 出荷プラント
EINDT        = LST_ALV-EDATU      " 明細納入期日
**** START UPD 2015/03/03 iSiD19 ****
ZTERM        = LST_ALV-ZTERM      " 支払条件キー
LGORT_SO     = LST_ALV-LGORT      " 保管場所
**** END UPD 2015/03/22 iSiD19 ****
**** START ADD BY ISID21 2015/09/22 ****
Z_PURPOSE_TEXT = LST_ALV-Z_PURPOSE_TEXT "用途
Z_ITEM_BSTKD = LST_ALV-Z_ITEM_BSTKD  "得意先発注番号
**** END ADD BY ISID21 2015/09/22 ****
Z_MOD_YMD    = LW_DATUM           " 更新年月日
Z_MOD_HMS    = LW_UZEIT           " 更新時分秒
Z_MOD_USERID = SY-UNAME           " 更新者
WHERE EBELN = LW_EBELN
AND EBELP = LST_ALV-EBELP.

IF SY-SUBRC <> 0.
LFG_ERR = ABAP_ON.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
COMMIT WORK.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.
ELSE.
O_W_ERRFLG = ABAP_ON.
ROLLBACK WORK.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203_H USING I_ST_ZSEGSD0009.

*   データ更新に失敗しました(TBL = &1)
MESSAGE S024(ZMEGSD01) WITH CNS_TABLENM
DISPLAY LIKE CNS_MSG_E.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_H
*&---------------------------------------------------------------------*
*&      Form  FRM_F4_SHOW
*&---------------------------------------------------------------------*
*       検索F4
*----------------------------------------------------------------------*
FORM FRM_F4_SHOW.
DATA:
LTD_RETURN TYPE STANDARD TABLE OF DDSHRETVAL,
LST_RETURN TYPE DDSHRETVAL,
L_ROW      TYPE I,
LST_STAB   TYPE LVC_S_STBL,
LST_ZTERM  TYPE TYP_ZTERM,
LST_ITEM   TYPE TYP_ALV_ITEM,
**** START ADD BY ISID REN 2015/07/14 ****
LST_COL    TYPE LVC_S_COL,
LW_MTPOS   TYPE MVKE-MTPOS, "品目マスタの明細カテゴリグループ
LW_PSTYV   TYPE PSTYV,      "Item Cat
**** END ADD BY ISID REN 2015/07/14 ****
LW_ZTERM   TYPE DZTERM.

**** START ADD BY ISID REN 2015/07/14 ****
* ALV コントロール: 列 ID
CALL METHOD CI_ALV->GET_CURRENT_CELL
IMPORTING
E_ROW     = L_ROW
ES_COL_ID = LST_COL.

IF L_ROW = 0.
RETURN.
ENDIF.

READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX L_ROW.

IF SY-SUBRC <> 0.
RETURN.
ENDIF.

CASE LST_COL-FIELDNAME.
WHEN CNS_PSTYV.      "Item Cat.
*     品目マスタの明細カテゴリグループの抽出
SELECT SINGLE MTPOS "品目マスタの明細カテゴリグループ
FROM MVKE         "品目の販売データ
INTO LW_MTPOS     "品目マスタの明細カテゴリグループ
WHERE MATNR = LST_ITEM-MATNR       "品目コード
AND VKORG = ST_ZSEGSD0009-VKORG  "販売組織
AND VTWEG = ST_ZSEGSD0009-VTWEG. "流通チャネル

IF SY-SUBRC = 0.
LW_PSTYV = LST_ITEM-PSTYV.
*       Item Cat Help
CALL FUNCTION 'RV_HELP'
EXPORTING
KEY    = ST_ZSEGSD0009-AUART "販売伝票タイプ
KEY2   = LW_MTPOS        "品目マスタの明細カテゴリグループ
NUMBER = '006'           "Item Cat Help
IMPORTING
FIELD  = LW_PSTYV.       "Item Cat

IF LW_PSTYV <> SPACE.
LST_ITEM-PSTYV = LW_PSTYV. "Item Cat
ENDIF.
ENDIF.

WHEN CNS_FNM_ZTERM.
**** END ADD BY ISID REN 2015/07/14 ****
*     F4 help also returning the value to be displayed in internal table
CALL FUNCTION 'F4IF_INT_TABLE_VALUE_REQUEST'
EXPORTING
RETFIELD        = CNS_FNM_ZTERM
VALUE_ORG       = CNS_ORG_S
TABLES
VALUE_TAB       = TD_ZTERM
RETURN_TAB      = LTD_RETURN
EXCEPTIONS
PARAMETER_ERROR = 1
NO_VALUES_FOUND = 2
OTHERS          = 3.

*     エラー
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
RETURN.
ELSE.
READ TABLE LTD_RETURN INTO LST_RETURN INDEX 1.

IF SY-SUBRC = 0.
**** START DEL BY ISID REN 2015/07/14 ****
*      CALL METHOD CI_ALV->GET_CURRENT_CELL
*        IMPORTING
*          E_ROW = L_ROW.
*
*      READ TABLE TD_ITEM_ALV INTO LST_ITEM INDEX L_ROW.
*      IF SY-SUBRC = 0.
**** END DEL BY ISID REN 2015/07/14 ****
CLEAR LST_ZTERM.
LW_ZTERM = LST_RETURN-FIELDVAL.

READ TABLE TD_ZTERM INTO LST_ZTERM
WITH KEY ZTERM = LW_ZTERM
BINARY SEARCH.

LST_ITEM-ZTERM = LW_ZTERM.
LST_ITEM-TEXT1 = LST_ZTERM-TEXT1.

**** START ADD BY ISID REN 2015/07/14 ****
ENDIF.
ENDIF.
**** END ADD BY ISID REN 2015/07/14 ****

WHEN OTHERS.
RETURN.
ENDCASE.

MODIFY TD_ITEM_ALV FROM LST_ITEM INDEX L_ROW.

**** START DEL BY ISID REN 2015/07/14 ****
*      ENDIF.
**** END DEL BY ISID REN 2015/07/14 ****

LST_STAB-ROW = ABAP_ON.
LST_STAB-COL = ABAP_ON.

**** START DEL BY ISID REN 2015/08/29 ****
*  CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY
*    EXPORTING
*      IS_STABLE = LST_STAB.
**** END DEL BY ISID REN 2015/08/29 ****

**** START DEL BY ISID REN 2015/07/14 ****
*    ENDIF.
*  ENDIF.
**** END DEL BY ISID REN 2015/07/14 ****

ENDFORM.                    " FRM_F4_SHOW
*&---------------------------------------------------------------------*
*&      Form  CHK_WAERK
*&---------------------------------------------------------------------*
*       通貨チェック
*----------------------------------------------------------------------*
*      <--O_W_ERRFLG       エラーフラッグ
*----------------------------------------------------------------------*
FORM CHK_WAERK CHANGING O_W_ERRFLG   TYPE C.

SELECT SINGLE WAERS
FROM TCURC
INTO ST_ZSEGSD0009-WAERK
WHERE WAERS = ST_ZSEGSD0009-WAERK.

IF SY-SUBRC <> 0.
O_W_ERRFLG = ABAP_ON.
*    通貨コード & は存在しません
MESSAGE S641(Z1) WITH ST_ZSEGSD0009-WAERK
DISPLAY LIKE CNS_MSG_E.
SET CURSOR FIELD 'ST_ZSEGSD0009-WAERK'.
ENDIF.

ENDFORM.                    " CHK_WAERK
*&---------------------------------------------------------------------*
*&      Form  GET_DATA_205_A
*&---------------------------------------------------------------------*
*       A-2-1-2-5．販売伝票タイプの検索
*----------------------------------------------------------------------*
*      -->I_TD_SDT203      ITAB:承認対象データ
*      <--O_TD_DATA_205    ITAB:販売伝票タイプ
*----------------------------------------------------------------------*
FORM GET_DATA_205_A USING I_TD_SDT203   TYPE TYP_TD_ZTEGSDT203
CHANGING O_TD_DATA_205 TYPE TYP_TD_205.
DATA:
LTD_SDT203       TYPE TYP_TD_ZTEGSDT203,
LTD_DATA_205_TEM TYPE TYP_TD_205,
LST_TVAKT        TYPE TYP_TVAKT,
LTD_TVAKT        TYPE STANDARD TABLE OF TYP_TVAKT.

FIELD-SYMBOLS:
<LFS_ST_DATA_205> TYPE TYP_DATA_205.

LTD_SDT203 = I_TD_SDT203.
SORT LTD_SDT203 BY BSART ASCENDING          " 購買伝票タイプ
KNTTP ASCENDING.         " 勘定設定カテゴリ

DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING BSART       " 購買伝票タイプ
KNTTP.      " 勘定設定カテゴリ

SELECT ZTEGSDT205~BSART                     " 購買伝票タイプ
ZTEGSDT205~KNTTP                     " 勘定設定カテゴリ
ZTEGSDT205~AUART                     " 販売伝票タイプ
ZTEGSDT205~AUGRU                     " 受注理由
TVAK~VBTYP                           " 販売管理伝票カテゴリ
FROM ZTEGSDT205
INNER JOIN TVAK
ON ZTEGSDT205~AUART = TVAK~AUART
INTO TABLE O_TD_DATA_205
FOR ALL ENTRIES IN LTD_SDT203
WHERE ZTEGSDT205~BSART = LTD_SDT203-BSART  " 購買伝票タイプ
AND ZTEGSDT205~KNTTP = LTD_SDT203-KNTTP. " 勘定設定カテゴリ

IF SY-SUBRC = 0.
LTD_DATA_205_TEM = O_TD_DATA_205.
SORT LTD_DATA_205_TEM BY AUART ASCENDING.
" 販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_DATA_205_TEM
COMPARING AUART.    " 販売伝票タイプ

SELECT AUART                              " 販売伝票タイプ
BEZEI                              " 販売伝票タイプテキスト
FROM TVAKT
INTO TABLE LTD_TVAKT
FOR ALL ENTRIES IN LTD_DATA_205_TEM
WHERE AUART = LTD_DATA_205_TEM-AUART     " 販売伝票タイプ
AND SPRAS = SY-LANGU.                  " システム言語

IF SY-SUBRC = 0.
SORT LTD_TVAKT BY AUART ASCENDING.
ENDIF.

LOOP AT O_TD_DATA_205 ASSIGNING <LFS_ST_DATA_205>.
CLEAR LST_TVAKT.
READ TABLE LTD_TVAKT INTO LST_TVAKT
WITH KEY AUART = <LFS_ST_DATA_205>-AUART
BINARY SEARCH.
<LFS_ST_DATA_205>-BEZEI = LST_TVAKT-BEZEI.
" 販売伝票タイプテキスト
ENDLOOP.

SORT O_TD_DATA_205  BY BSART ASCENDING    " 購買伝票タイプ
KNTTP ASCENDING.   " 勘定設定カテゴリ
ENDIF.

ENDFORM.                    " GET_DATA_205_A
*&---------------------------------------------------------------------*
*&      Form  GET_ZTERM_DATA
*&---------------------------------------------------------------------*
*       従業員データ取得
*----------------------------------------------------------------------*
FORM GET_ZTERM_DATA.

SELECT ZTERM
TEXT1
FROM T052U
INTO TABLE TD_ZTERM
WHERE SPRAS = SY-LANGU.

IF SY-SUBRC = 0.
SORT TD_ZTERM BY ZTERM ASCENDING.
ENDIF.

ENDFORM.                    " GET_ZTERM_DATA
*&---------------------------------------------------------------------*
*&      Form  UPDATE_ZTEGSDT203_ITEM
*&---------------------------------------------------------------------*
*       C-3．データ更新処理
*----------------------------------------------------------------------*
*      -->I_TD_MESSAGE     ITAB:BAPIメッセージ
*      -->I_TD_ALVDATA     ITAB:BAPI処理対象
*      -->I_TD_UNLOCK      ITAB:UNLOCK処理対象データ
*----------------------------------------------------------------------*
FORM UPDATE_ZTEGSDT203_ITEM USING I_TD_MESSAGE  TYPE TYP_TD_BAPIMSG
I_TD_ALVDATA  TYPE TYP_TD_ALVDATA
I_TD_UNLOCK   TYPE TYP_TD_ERRALVDATA.
DATA:
LST_ALVDATA TYPE TYP_TEM_ALVDATA,
LST_MESSAGE TYPE TYP_BAPIMSG,
LW_DATUM    TYPE SY-DATUM,
LW_UZEIT    TYPE SY-UZEIT,
LFG_ERR     TYPE C.

LW_DATUM = SY-DATUM.
LW_UZEIT = SY-UZEIT.

LOOP AT I_TD_ALVDATA INTO LST_ALVDATA.
CLEAR LST_MESSAGE.
READ TABLE I_TD_MESSAGE INTO LST_MESSAGE
WITH KEY BSTKD = LST_ALVDATA-BSTKD
EBELP = LST_ALVDATA-EBELP
BINARY SEARCH.

IF SY-SUBRC <> 0.
*  C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_C
**** START UPD 2015/04/24 ISID11 ****
*                                           LST_MESSAGE-MESSAGE
LST_MESSAGE
**** END UPD 2015/04/24 ISID11 ****
LST_ALVDATA
LW_DATUM
LW_UZEIT
CHANGING LFG_ERR.
ELSE.
*  C-3-1．承認エラーの場合、受発注連携データのステータス更新処理を行う。
PERFORM UPDATE_ZTEGSDT203_BAPI USING CNS_KBUNCC_2
CNS_STATUS_E
**** START UPD 2015/04/24 ISID11 ****
*                                           LST_MESSAGE-MESSAGE
LST_MESSAGE
**** END UPD 2015/04/24 ISID11 ****
LST_ALVDATA
LW_DATUM
LW_UZEIT
CHANGING LFG_ERR.
ENDIF.

IF LFG_ERR IS NOT INITIAL.
EXIT.
ENDIF.
ENDLOOP.

IF LFG_ERR IS INITIAL.
* C-3-3．データ更新に全件成功した場合、コミットし、ロックを解除
COMMIT WORK.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.
ELSE.
ROLLBACK WORK.

*   ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING I_TD_UNLOCK.

*   データ更新に失敗しました(TBL = &1)
MESSAGE E024(ZMEGSD01) WITH CNS_TABLENM.
ENDIF.

ENDFORM.                    " UPDATE_ZTEGSDT203_ITEM
*&---------------------------------------------------------------------*
*&      Form  MODIFY_9000
*&---------------------------------------------------------------------*
*       SCREEN 9000再表示処理
*----------------------------------------------------------------------*
FORM MODIFY_9000.
DATA:
LST_ZSEGSD0009  TYPE ZSEGSD0009,
LST_APP_ALVDATA TYPE TYP_APP_ALVDATA,
LST_ERR_ALVDATA TYPE TYP_ERR_ALVDATA.

DELETE TD_ZSEGSD0009 WHERE BSTKD = ST_ZSEGSD0009-BSTKD.
APPEND ST_ZSEGSD0009 TO TD_ZSEGSD0009.

DELETE TD_ITEM_ALV_TEM WHERE BSTKD = ST_ZSEGSD0009-EBELN.
APPEND LINES OF TD_ITEM_ALV TO TD_ITEM_ALV_TEM.

SORT TD_ITEM_ALV_TEM BY BSTKD ASCENDING
EBELP ASCENDING.

LOOP AT TD_ZSEGSD0009 INTO LST_ZSEGSD0009.
IF RB_ERR IS INITIAL.
READ TABLE TD_APP_ALV TRANSPORTING NO FIELDS
WITH KEY VKORG = LST_ZSEGSD0009-VKORG
VTWEG = LST_ZSEGSD0009-VTWEG
SPART = LST_ZSEGSD0009-SPART
BSTKD = LST_ZSEGSD0009-EBELN
BINARY SEARCH.

IF SY-SUBRC = 0.
LST_APP_ALVDATA-VKBUR     = LST_ZSEGSD0009-VKBUR.
LST_APP_ALVDATA-VKGRP     = LST_ZSEGSD0009-VKGRP.
LST_APP_ALVDATA-KUNNR     = LST_ZSEGSD0009-ZEKUNNR1.
LST_APP_ALVDATA-NAME1     = LST_ZSEGSD0009-ZEKNAME1.
LST_APP_ALVDATA-ZEKUNNR   = LST_ZSEGSD0009-ZEKUNNR.
LST_APP_ALVDATA-ZEKNAME   = LST_ZSEGSD0009-ZEKNAME.
**** START UPD 2015/03/03 iSiD19 ****
*        LST_APP_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZEKUNNR2.
*        LST_APP_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZEKUNNR3.
LST_APP_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZKUNNR_ZJ.
**** START UPD BY ISID REN 2015/07/16 ****
*        LST_APP_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZKUNNR_DS.
LST_APP_ALVDATA-Z_ENDUSER_CD = LST_ZSEGSD0009-ZKUNNR_DS.
**** END UPD BY ISID REN 2015/07/16 ****
**** END UPD 2015/03/03 iSiD19 ****
LST_APP_ALVDATA-PERNR     = LST_ZSEGSD0009-PERNR.
LST_APP_ALVDATA-ZEEMNAM   = LST_ZSEGSD0009-ENAME.
LST_APP_ALVDATA-AUGRU     = LST_ZSEGSD0009-AUGRU.

MODIFY TD_APP_ALV FROM LST_APP_ALVDATA
TRANSPORTING VKBUR
VKGRP
KUNNR
NAME1
ZEKUNNR
ZEKNAME
ZKUNNR_ZJ
**** START UPD BY ISID REN 2015/07/16 ****
*                                       ZKUNNR_DS
Z_ENDUSER_CD
**** END UPD BY ISID REN 2015/07/16 ****

PERNR
ZEEMNAM
AUGRU
WHERE BSTKD = LST_ZSEGSD0009-EBELN.
ENDIF.
ELSE.
READ TABLE TD_ERR_ALV TRANSPORTING NO FIELDS
WITH KEY VKORG = LST_ZSEGSD0009-VKORG
VTWEG = LST_ZSEGSD0009-VTWEG
SPART = LST_ZSEGSD0009-SPART
BSTKD = LST_ZSEGSD0009-EBELN
BINARY SEARCH.

IF SY-SUBRC = 0.
LST_ERR_ALVDATA-VKBUR     = LST_ZSEGSD0009-VKBUR.
LST_ERR_ALVDATA-VKGRP     = LST_ZSEGSD0009-VKGRP.
LST_ERR_ALVDATA-KUNNR     = LST_ZSEGSD0009-ZEKUNNR1.
LST_ERR_ALVDATA-NAME1     = LST_ZSEGSD0009-ZEKNAME1.
LST_ERR_ALVDATA-ZEKUNNR   = LST_ZSEGSD0009-ZEKUNNR.
LST_ERR_ALVDATA-ZEKNAME   = LST_ZSEGSD0009-ZEKNAME.
**** START UPD 2015/03/03 iSiD19 ****
*        LST_ERR_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZEKUNNR2.
*        LST_ERR_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZEKUNNR3.
LST_ERR_ALVDATA-ZKUNNR_ZJ = LST_ZSEGSD0009-ZKUNNR_ZJ.
**** START UPD BY ISID REN 2015/07/16 ****
*        LST_ERR_ALVDATA-ZKUNNR_DS = LST_ZSEGSD0009-ZKUNNR_DS.
LST_ERR_ALVDATA-Z_ENDUSER_CD = LST_ZSEGSD0009-ZKUNNR_DS.
**** END UPD BY ISID REN 2015/07/16 ****
**** END UPD 2015/03/03 iSiD19 ****
LST_ERR_ALVDATA-PERNR     = LST_ZSEGSD0009-PERNR.
LST_ERR_ALVDATA-ZEEMNAM   = LST_ZSEGSD0009-ENAME.
LST_ERR_ALVDATA-AUGRU     = LST_ZSEGSD0009-AUGRU.

MODIFY TD_ERR_ALV FROM LST_ERR_ALVDATA
TRANSPORTING VKBUR
VKGRP
KUNNR
NAME1
ZEKUNNR
ZEKNAME
ZKUNNR_ZJ
**** START UPD BY ISID REN 2015/07/16 ****
*                                       ZKUNNR_DS
Z_ENDUSER_CD
**** END UPD BY ISID REN 2015/07/16 ****
PERNR
ZEEMNAM
AUGRU
WHERE BSTKD = LST_ZSEGSD0009-EBELN.
ENDIF.
ENDIF.
ENDLOOP.

ENDFORM.                    " MODIFY_9000
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND
*&---------------------------------------------------------------------*
*       ALV画面の事件
*----------------------------------------------------------------------*
*      -->I_W_UCOMM       　ユーザ事件
*      -->I_ST_SELFIELD     information cursor position ALV
*----------------------------------------------------------------------*
FORM USER_COMMAND USING I_W_UCOMM     TYPE SY-UCOMM
I_ST_SELFIELD TYPE SLIS_SELFIELD.
DATA:
LTD_PROCESS     TYPE TYP_TD_ERRALVDATA,
LTD_UPDATE      TYPE TYP_TD_ALVDATA,
LW_QUESTION     TYPE CHAR72,
LW_ANSWER       TYPE CHAR1,
LW_ERRFLG       TYPE CHAR1,
*    LW_DATA_ERRFLG  TYPE CHAR1,
LTD_MESSAGE     TYPE TYP_TD_BAPIMSG.

I_ST_SELFIELD-REFRESH = ABAP_ON.

CLEAR LTD_PROCESS.

* A-4．ボタンイベント処理
CASE I_W_UCOMM.
*   A-4-1-1．　「Delete」ボタン押下時の処理
*   A-4-2-1．「Delete」ボタン押下時の処理
WHEN CNS_USER_DEL.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.

IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ELSE.
*       削除しますか？
MESSAGE S034(ZMEGSD01) INTO LW_QUESTION.

*       POP確認
PERFORM POP_CONFIRM USING TEXT-B01
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.

IF LW_ANSWER <> 1.
RETURN.
ENDIF.
ENDIF.

*     B-2-1．ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     B-2-2．受発注連携データのステータス更新処理を行う。
CLEAR LW_ERRFLG.
PERFORM UPDATE_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS INITIAL.
COMMIT WORK AND WAIT.
*       B-2-3．ロックの解除
PERFORM UNLOCK_ZTEGSDT203 USING LTD_PROCESS.
ENDIF.

*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*   A-4-1-2．　「Approve」ボタン押下時の処理
WHEN CNS_USER_APP.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.

*     C-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.

*     C-1-3．ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     C-2．受注シミュレーション処理
*     C-2-1．シミュレーション対象データの補足処理。
PERFORM EDIT_TD_PROCESS USING TD_APP_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG.
*     受注シミュレーション処理を行う
PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LTD_MESSAGE.

*     C-3．データ更新処理
PERFORM UPDATE_ZTEGSDT203_ITEM USING LTD_MESSAGE
LTD_UPDATE
LTD_PROCESS.

*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*     C-4-2．メッセージを表示する。
IF LW_ERRFLG IS INITIAL.
*       指定された対象が全て承認されました
MESSAGE S045(ZMEGSD01).
ELSE.
*       承認失敗のデータが存在します。エラーリカバリ一覧をご確認ください
MESSAGE S046(ZMEGSD01).
ENDIF.

*   A-4-1-3．　「Change」ボタン押下時の処理
*   A-4-2-2．　「Change」ボタン押下時の処理
WHEN CNS_USER_MOD.
*     対象データを選択
PERFORM SELECT_DATA CHANGING LTD_PROCESS.

*     D-1-1．入力チェック
IF LTD_PROCESS IS INITIAL.
*       明細を指定ください
MESSAGE E028(ZMEGSD01).
ENDIF.

**** START ADD 2015/03/03 iSiD19 ****
*     販売伝票単一明細フラグ立っている場合、
*     一明細しか選択できないようにする
IF W_FLGSOSGL IS NOT INITIAL
AND LINES( LTD_PROCESS ) > 1.
*       一つの明細のみが指定できます。
MESSAGE E102(ZMEGSD01).
ENDIF.
**** END ADD 2015/03/03 iSiD19   ****

*     購買発注番号混在チェック
PERFORM CHECK_TD_PROCESS USING TD_APP_ALV
TD_ERR_ALV
CHANGING LTD_PROCESS.

**** START ADD BY ISID REN 2015/08/21 ****
*     ロック処理
CLEAR LW_ERRFLG.
PERFORM LOCK_ZTEGSDT203 USING LTD_PROCESS
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.
**** END ADD BY ISID REN 2015/08/21 ****

*     D-2．データ設定処理
CLEAR:
TD_ITEM_ALV,
TD_ITEM_ALV_INI,
ST_ZSEGSD0009,
W_ERRFLG.

PERFORM SET_SCREEN_9000 USING LTD_PROCESS
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
TD_ITEM_ALV_INI.

CLEAR W_CHANGED_9000.

CALL SCREEN 9000.

WHEN CNS_USER_BACK
OR CNS_USER_EXIT.
LEAVE TO SCREEN 0.

WHEN OTHERS.
*     処理なし

ENDCASE.

ENDFORM.                    " USER_COMMAND
*&---------------------------------------------------------------------*
*&      Form  COMMAND_EXIT
*&---------------------------------------------------------------------*
*       EXIT 事件
*----------------------------------------------------------------------*
FORM COMMAND_EXIT.
DATA:
LW_VALID    TYPE C,
LW_QUESTION TYPE CHAR72,
**** START ADD BY ISID REN 2015/08/21 ****
LW_EBELN    TYPE EBELN,
**** END ADD BY ISID REN 2015/08/21 ****
LW_ANSWER   TYPE C.

CASE OK_CODE.
WHEN CNS_USER_BACK
OR CNS_USER_EXIT.
CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.

IF SY-DATAR = ABAP_ON.
W_CHANGED_9000 = ABAP_ON.
ENDIF.

IF LW_VALID IS INITIAL
OR W_CHANGED_9000 IS NOT INITIAL
OR TD_ITEM_ALV <> TD_ITEM_ALV_INI.
*       終了しますか？
MESSAGE S050(ZMEGSD01) INTO LW_QUESTION.

*       POP確認
PERFORM POP_CONFIRM USING TEXT-B04
LW_QUESTION
TEXT-B02
TEXT-B03
CHANGING LW_ANSWER.

IF LW_ANSWER <> 1.
RETURN.
ELSE.
CLEAR:
W_CHANGED_9000.

CLEAR TD_ITEM_ALV.

CALL METHOD CI_ALV->REFRESH_TABLE_DISPLAY.

**** START ADD BY ISID REN 2015/08/21 ****
CALL FUNCTION 'DEQUEUE_ALL'.
**** END ADD BY ISID REN 2015/08/21 ****

LEAVE TO SCREEN 0.
ENDIF.
ELSE.
**** START ADD BY ISID REN 2015/08/21 ****
CALL FUNCTION 'DEQUEUE_ALL'.
**** END ADD BY ISID REN 2015/08/21 ****

LEAVE TO SCREEN 0.
ENDIF.
WHEN OTHERS.

ENDCASE.

ENDFORM.                    " COMMAND_EXIT
*&---------------------------------------------------------------------*
*&      Form  USER_COMMAND_9000
*&---------------------------------------------------------------------*
*       画面9000のボタンイベント処理
*----------------------------------------------------------------------*
FORM USER_COMMAND_9000.
DATA:
LW_VALID       TYPE C,
LW_SAVE_OK     TYPE SY-UCOMM,
LW_ERRFLG      TYPE C,
LST_MESSAGE    TYPE TYP_BAPIMSG,
LTD_MESSAGE    TYPE TYP_TD_BAPIMSG,
LTD_UPDATE     TYPE TYP_TD_ALVDATA,
LTD_PROCESS    TYPE TYP_TD_ERRALVDATA,
LTD_MODI       TYPE LVC_T_CELL.

CALL METHOD CI_ALV->CHECK_CHANGED_DATA
IMPORTING
E_VALID = LW_VALID.

IF LW_VALID IS INITIAL.
RETURN.
ENDIF.

LW_SAVE_OK = OK_CODE.

CASE LW_SAVE_OK.
WHEN CNS_USER_ENTR.
*     E-2．データ設定処理
PERFORM GET_9000_AGAIN
**** START ADD BY ISID REN 2015/08/28 ****
USING    LW_SAVE_OK
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
LW_ERRFLG.

*     ALV画面項目チェック
PERFORM CHECK_9000_ALV
**** START ADD BY ISID REN 2015/08/28 ****
USING    LW_SAVE_OK
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING LTD_MODI.

IF W_ERRFLG = ABAP_ON.
CALL METHOD CI_ALV->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

**** START DEL BY ISID REN 2015/08/29 ****
**       必要な入力項目すべてに入力してください
*        MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
**** END DEL BY ISID REN 2015/08/29 ****

RETURN.
ENDIF.

WHEN CNS_USER_SAPP.
*     ALV画面項目チェック
PERFORM CHECK_9000_ALV
**** START ADD BY ISID REN 2015/08/28 ****
USING    LW_SAVE_OK
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING LTD_MODI.

IF W_ERRFLG = ABAP_ON.
CALL METHOD CI_ALV->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

**** START DEL BY ISID REN 2015/08/29 ****
**       必要な入力項目すべてに入力してください
*        MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
**** END DEL BY ISID REN 2015/08/29 ****

RETURN.
ENDIF.

CLEAR LW_ERRFLG.
PERFORM GET_9000_AGAIN
**** START ADD BY ISID REN 2015/08/28 ****
USING    LW_SAVE_OK
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     G.Approve
PERFORM APP_9000_DATA USING ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LTD_PROCESS.

*     C-2-2．受注シミュレーション処理を行う。
CLEAR:
LW_ERRFLG.

PERFORM BAPI_SALESORDER_CREAT USING LTD_PROCESS
CHANGING LTD_UPDATE
LW_ERRFLG
LTD_MESSAGE.

IF LW_ERRFLG IS NOT INITIAL.
READ TABLE LTD_MESSAGE INTO LST_MESSAGE INDEX 1.
MESSAGE LST_MESSAGE-MESSAGE TYPE CNS_MSG_S
DISPLAY LIKE CNS_MSG_E.
RETURN.
ENDIF.

**** START DEL BY ISID REN 2015/08/21 ****
**     G-3-1．ロック処理
*      CLEAR LW_ERRFLG.
*      PERFORM LOCK_ZTEGSDT203_H USING ST_ZSEGSD0009
*                             CHANGING LW_ERRFLG.
*
*      IF LW_ERRFLG IS NOT INITIAL.
*        RETURN.
*      ENDIF.
**** END DEL BY ISID REN 2015/08/21 ****

*    C-3-2．承認成功の場合、受発注連携データのステータス更新処理を行う。
CLEAR LW_ERRFLG.
PERFORM UPDATE_ZTEGSDT203_9000 USING CNS_KBUNCC_2
CNS_STATUS_C
ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     C-４．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*     C-4-2．メッセージを表示する。
*      データ承認しました。(購買発注 = &1)
MESSAGE S049(ZMEGSD01) WITH ST_ZSEGSD0009-EBELN.
LEAVE TO SCREEN 0.

WHEN CNS_USER_SHOD
OR CNS_USER_SAVE.
*     ALV画面項目チェック
PERFORM CHECK_9000_ALV
**** START ADD BY ISID REN 2015/08/28 ****
USING    LW_SAVE_OK
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING LTD_MODI.

IF W_ERRFLG = ABAP_ON.
CALL METHOD CI_ALV->SET_SELECTED_CELLS
EXPORTING
IT_CELLS = LTD_MODI.

**** START DEL BY ISID REN 2015/08/29 ****
**       必要な入力項目すべてに入力してください
*        MESSAGE S055(00) DISPLAY LIKE CNS_MSG_E.
**** END DEL BY ISID REN 2015/08/29 ****

RETURN.
ENDIF.

*     E-2．データ設定処理
PERFORM GET_9000_AGAIN
**** START ADD BY ISID REN 2015/08/28 ****
USING    LW_SAVE_OK
**** END ADD BY ISID REN 2015/08/28 ****
CHANGING ST_ZSEGSD0009
TD_ITEM_ALV
LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

**** START DEL BY ISID REN 2015/08/21 ****
**     F-1-3．ロック処理
*      CLEAR LW_ERRFLG.
*      PERFORM LOCK_ZTEGSDT203_H USING ST_ZSEGSD0009
*                             CHANGING LW_ERRFLG.
*
*      IF LW_ERRFLG IS NOT INITIAL.
*        RETURN.
*      ENDIF.
**** END DEL BY ISID REN 2015/08/21 ****

*     F-2．データ更新処理
PERFORM UPDATE_ZTEGSDT203_H USING ST_ZSEGSD0009
TD_ITEM_ALV
CHANGING LW_ERRFLG.

IF LW_ERRFLG IS NOT INITIAL.
RETURN.
ENDIF.

*     B-3．ALV画面を再表示処理
PERFORM DISPLAY_ALV_AGAIN.

*     SCREEN 9000再表示処理
PERFORM MODIFY_9000.

*     更新成功のメッセージを表示する
*     データ更新しました。(購買発注 = &1)
MESSAGE S048(ZMEGSD01) WITH ST_ZSEGSD0009-EBELN.
LEAVE TO SCREEN 0.

WHEN OTHERS.
*     処理なし
ENDCASE.

ENDFORM.                    " USER_COMMAND_9000
**** START ADD 2015/03/03 iSiD19 ****
*&---------------------------------------------------------------------*
*&      Form  GET_ALV_REFDATA
*&---------------------------------------------------------------------*
*       ALV表示用項目を取得する
*----------------------------------------------------------------------*
*      -->I_TD_ZTEGSDT203  対象データテーブル
*      <--O_LTD_MATERDES   品目テキストテーブル
*      <--O_LTD_PLANTINFO  出荷プラントテーブル
*      <--O_LTD_INCOTERM  インコタームズテーブル
*      <--O_LTD_PAYTERMS  支払条件テーブル
*      <--O_LTD_ODREASON  受注理由テーブル
*      <--O_LTD_STORELOC  保管場所テーブル
*      <--O_TD_TVAUT     受注理由マスタ
*      <--O_TD_T001L     保管場所マスタ
*----------------------------------------------------------------------*
FORM GET_ALV_REFDATA USING    I_TD_ZTEGSDT203 TYPE TYP_TD_ZTEGSDT203
CHANGING O_TD_MATERDES  TYPE TYP_TD_MATERDES
O_TD_PLANTINFO TYPE TYP_TD_PLANTINFO
O_TD_INCOTERM  TYPE TYP_TD_INCOTERM
O_TD_PAYTERMS  TYPE TYP_TD_PAYTERMS
O_TD_ODREASON  TYPE TYP_TD_ODREASON
O_TD_STORELOC  TYPE TYP_TD_STORELOC
O_TD_TVAUT     TYPE TYP_TD_TVAUT
O_TD_T001L     TYPE TYP_TD_T001L.
DATA:
LTD_ZTEGSDT203      TYPE TYP_TD_ZTEGSDT203,
LST_ZTEGSDT203      TYPE TYP_ZTEGSDT203,
LST_PLANTINFO_SB    TYPE TYP_PLANTINFO,
LST_PLANTINFO       TYPE TYP_PLANTINFO,
LTD_PLANTINFO       TYPE STANDARD TABLE OF TYP_PLANTINFO.

CLEAR:
O_TD_MATERDES,
O_TD_PLANTINFO,
O_TD_INCOTERM,
O_TD_PAYTERMS,
O_TD_ODREASON,
O_TD_STORELOC,
O_TD_TVAUT,
O_TD_T001L.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY MATNR.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING MATNR.

* 品目テキストを取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT MATNR
MAKTX
INTO TABLE O_TD_MATERDES
FROM MAKT
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE MATNR = LTD_ZTEGSDT203-MATNR
AND SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY KUNNR
VKORG
VTWEG
SPART.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING KUNNR
VKORG
VTWEG
SPART.

* 出荷プラントの情報を取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT KUNNR
VKORG
VTWEG
SPART
VWERK
**** START UPD BY ISID REN 2015/08/06 ****
*     INTO TABLE O_TD_PLANTINFO
ZTERM  "支払条件キー
INTO CORRESPONDING FIELDS OF TABLE O_TD_PLANTINFO
**** END UPD BY ISID REN 2015/08/06 ****
FROM KNVV
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE KUNNR = LTD_ZTEGSDT203-KUNNR
AND VKORG = LTD_ZTEGSDT203-VKORG
AND VTWEG = LTD_ZTEGSDT203-VTWEG
AND SPART = LTD_ZTEGSDT203-SPART.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY INCO1.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING INCO1.

* インコタームズのテキストを取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT INCO1
BEZEI
INTO TABLE O_TD_INCOTERM
FROM TINCT
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE INCO1 = LTD_ZTEGSDT203-INCO1
AND SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
**** START UPD BY ISID REN 2015/08/06 ****
*  LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
*  SORT LTD_ZTEGSDT203 BY ZTERM.
*  DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
*                             COMPARING ZTERM.
LTD_PLANTINFO = O_TD_PLANTINFO.
SORT LTD_PLANTINFO BY ZTERM.
DELETE ADJACENT DUPLICATES FROM LTD_PLANTINFO
COMPARING ZTERM.
**** END UPD BY ISID REN 2015/08/06 ****

* 支払条件のテキストを取得する
**** START UPD BY ISID REN 2015/08/06 ****
*  IF LTD_ZTEGSDT203 IS NOT INITIAL.
IF LTD_PLANTINFO IS NOT INITIAL.
**** END UPD BY ISID REN 2015/08/06 ****
SELECT ZTERM
TEXT1
INTO TABLE O_TD_PAYTERMS
FROM T052U
**** START UPD BY ISID REN 2015/08/06 ****
*       FOR ALL ENTRIES IN LTD_ZTEGSDT203
*     WHERE ZTERM = LTD_ZTEGSDT203-ZTERM
FOR ALL ENTRIES IN LTD_PLANTINFO
WHERE ZTERM = LTD_PLANTINFO-ZTERM
**** START UPD BY ISID REN 2015/08/06 ****
AND SPRAS = SY-LANGU.
ENDIF.

* 検索条件の作成
LTD_ZTEGSDT203 = I_TD_ZTEGSDT203.
SORT LTD_ZTEGSDT203 BY BSART
KNTTP.

DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT203
COMPARING BSART
KNTTP.

* 受注理由を取得する
IF LTD_ZTEGSDT203 IS NOT INITIAL.
SELECT A~BSART
A~KNTTP
A~AUART
B~AUGRU
B~BEZEI
INTO TABLE O_TD_ODREASON
FROM ZTEGSDT205 AS A
INNER JOIN TVAUT AS B
ON A~AUGRU = B~AUGRU
FOR ALL ENTRIES IN LTD_ZTEGSDT203
WHERE A~BSART = LTD_ZTEGSDT203-BSART
AND A~KNTTP = LTD_ZTEGSDT203-KNTTP
AND B~SPRAS = SY-LANGU.
ENDIF.

**** START ADD BY ISID REN 2015/08/06 ****
CLEAR LTD_PLANTINFO.
**** END ADD BY ISID REN 2015/08/06 ****

* 検索条件の作成
LOOP AT I_TD_ZTEGSDT203 INTO LST_ZTEGSDT203.
IF LST_ZTEGSDT203-DWERK IS NOT INITIAL.
LST_PLANTINFO-VWERK =  LST_ZTEGSDT203-DWERK.
ELSE.
CLEAR LST_PLANTINFO_SB.
READ TABLE O_TD_PLANTINFO INTO LST_PLANTINFO_SB
WITH TABLE KEY KUNNR = LST_ZTEGSDT203-KUNNR
VKORG = LST_ZTEGSDT203-VKORG
VTWEG = LST_ZTEGSDT203-VTWEG
SPART = LST_ZTEGSDT203-SPART.
LST_PLANTINFO-VWERK =  LST_PLANTINFO_SB-VWERK.
ENDIF.

COLLECT LST_PLANTINFO INTO LTD_PLANTINFO.
CLEAR LST_PLANTINFO.
ENDLOOP.

* 保管場所を取得する
IF LTD_PLANTINFO IS NOT INITIAL.
SELECT A~MATNR
A~WERKS
A~LGPRO
B~LGOBE
INTO TABLE O_TD_STORELOC
FROM MARC AS A
INNER JOIN T001L AS B
ON A~WERKS = B~WERKS
AND A~LGPRO = B~LGORT
FOR ALL ENTRIES IN LTD_PLANTINFO
WHERE A~WERKS = LTD_PLANTINFO-VWERK.
ENDIF.

* 受注理由マスタ
SELECT AUGRU
BEZEI
INTO TABLE O_TD_TVAUT
FROM TVAUT
WHERE SPRAS = SY-LANGU.

* 保管場所マスタ
SELECT WERKS
LGORT
LGOBE
INTO TABLE O_TD_T001L
FROM T001L.

ENDFORM.                    " GET_ALV_REFDATA
*&---------------------------------------------------------------------*
*&      Form  READ_ALV_REFDATA
*&---------------------------------------------------------------------*
*       ALV表示用項目の読み込み
*----------------------------------------------------------------------*
*      -->I_ST_SDT203   対象データ
*      -->I_TD_MATERDES   品目テキストテーブル
*      -->I_TD_PLANTINFO  出荷プラントテーブル
*      -->I_TD_INCOTERM  インコタームズテーブル
*      -->I_LTD_PAYTERMS  支払条件テーブル
*      -->I_TD_PAYTERMS  受注理由テーブル
*      -->I_TD_STORELOC  保管場所テーブル
*      -->I_TD_TVAUT     受注理由マスタ
*      -->I_TD_T001L     保管場所マスタ
*      <--O_ST_APP_ALVDATA  ALV表示用データ
*----------------------------------------------------------------------*
FORM READ_ALV_REFDATA  USING    I_ST_SDT203    TYPE TYP_ZTEGSDT203
I_TD_MATERDES  TYPE TYP_TD_MATERDES
I_TD_PLANTINFO TYPE TYP_TD_PLANTINFO
I_TD_INCOTERM  TYPE TYP_TD_INCOTERM
I_TD_PAYTERMS  TYPE TYP_TD_PAYTERMS
I_TD_ODREASON  TYPE TYP_TD_ODREASON
I_TD_STORELOC  TYPE TYP_TD_STORELOC
I_TD_TVAUT     TYPE TYP_TD_TVAUT
I_TD_T001L     TYPE TYP_TD_T001L
CHANGING O_ST_APP_ALVDATA TYPE TYP_APP_ALVDATA.
DATA:
LST_MATERDES  TYPE TYP_MATERDES,
LST_PLANTINFO TYPE TYP_PLANTINFO,
LST_INCOTERM  TYPE TYP_INCOTERM,
LST_PAYTERMS  TYPE TYP_PAYTERMS,
LST_ODREASON  TYPE TYP_ODREASON,
LST_STORELOC  TYPE TYP_STORELOC,
LW_NAME       TYPE THEAD-TDNAME,
LTD_LINES     TYPE TABLE OF TLINE,
LST_LINES     TYPE TLINE,
LST_TVAUT     TYPE TYP_TVAUT,
LST_T001L     TYPE TYP_T001L.

* 品目テキストを取得する
CONCATENATE I_ST_SDT203-MATNR
I_ST_SDT203-VKORG
I_ST_SDT203-VTWEG INTO LW_NAME RESPECTING BLANKS.

IF W_FLGHEADOF = ABAP_ON.
READ TABLE I_TD_MATERDES INTO LST_MATERDES
WITH TABLE KEY MATNR = I_ST_SDT203-MATNR.
IF SY-SUBRC = 0.
O_ST_APP_ALVDATA-ARKTX = LST_MATERDES-MAKTX."品目テキスト
ELSE.
CLEAR O_ST_APP_ALVDATA-ARKTX.
ENDIF.
ELSE.
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = '0001'
LANGUAGE                = SY-LANGU
NAME                    = LW_NAME
OBJECT                  = 'MVKE'
TABLES
LINES                   = LTD_LINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

IF SY-SUBRC = 0.
READ TABLE LTD_LINES INTO LST_LINES INDEX 1.
O_ST_APP_ALVDATA-ARKTX = LST_LINES-TDLINE. "品目テキスト
ELSE.
READ TABLE I_TD_MATERDES INTO LST_MATERDES
WITH TABLE KEY MATNR = I_ST_SDT203-MATNR.
IF SY-SUBRC = 0.
O_ST_APP_ALVDATA-ARKTX = LST_MATERDES-MAKTX."品目テキスト
ELSE.
CLEAR O_ST_APP_ALVDATA-ARKTX.
ENDIF.
ENDIF.
ENDIF.

**** START UPD BY ISID REN 2015/08/06 ****
*  IF I_ST_SDT203-DWERK IS INITIAL.
CLEAR: O_ST_APP_ALVDATA-WERKS,
O_ST_APP_ALVDATA-DZTERM.
**** END UPD BY ISID REN 2015/08/06 ****

* 出荷プラントの情報を取得する
READ TABLE I_TD_PLANTINFO INTO LST_PLANTINFO
WITH TABLE KEY KUNNR = I_ST_SDT203-KUNNR
VKORG = I_ST_SDT203-VKORG
VTWEG = I_ST_SDT203-VTWEG
SPART = I_ST_SDT203-SPART.

**** START ADD BY ISID REN 2015/08/06 ****
IF SY-SUBRC = 0.
**** END ADD BY ISID REN 2015/08/06 ****

O_ST_APP_ALVDATA-WERKS  = LST_PLANTINFO-VWERK.  "出荷プラント

**** START ADD BY ISID REN 2015/08/06 ****
O_ST_APP_ALVDATA-DZTERM = LST_PLANTINFO-ZTERM.  "支払条件キー
ENDIF.
**** END ADD BY ISID REN 2015/08/06 ****

**** START DEL BY ISID REN 2015/08/06 ****
*  ENDIF.
**** END DEL BY ISID REN 2015/08/06 ****

**** START DEL BY ISID REN 2015/08/06 ****
** インコタームズのテキストを取得する
*  READ TABLE I_TD_INCOTERM INTO LST_INCOTERM
*                           WITH TABLE KEY INCO1 = I_ST_SDT203-INCO1.
*  O_ST_APP_ALVDATA-ZBEZEI_IC = LST_INCOTERM-BEZEI.
*  "インコタームズのテキスト
**** END DEL BY ISID REN 2015/08/06 ****

**** START ADD BY ISID REN 2015/08/06 ****
CLEAR O_ST_APP_ALVDATA-TEXT1. "支払条件のテキスト

IF O_ST_APP_ALVDATA-DZTERM IS NOT INITIAL.
**** END ADD BY ISID REN 2015/08/06 ****

*   支払条件のテキストを取得する
READ TABLE I_TD_PAYTERMS INTO LST_PAYTERMS
**** START UPD BY ISID REN 2015/08/06 ****
*    WITH TABLE KEY ZTERM = I_ST_SDT203-ZTERM.
WITH KEY ZTERM = O_ST_APP_ALVDATA-DZTERM.

IF SY-SUBRC = 0.
**** END UPD BY ISID REN 2015/08/06 ****

O_ST_APP_ALVDATA-TEXT1 = LST_PAYTERMS-TEXT1. "支払条件のテキスト

**** START ADD BY ISID REN 2015/08/06 ****
ENDIF.
ENDIF.
**** END ADD BY ISID REN 2015/08/06 ****

* 受注理由を取得する
IF I_ST_SDT203-ZKBUNCC = '1'
AND I_ST_SDT203-STATUS  = 'C'.
READ TABLE I_TD_ODREASON INTO LST_ODREASON
WITH TABLE KEY BSART = I_ST_SDT203-BSART
KNTTP = I_ST_SDT203-KNTTP.
O_ST_APP_ALVDATA-AUGRU = LST_ODREASON-AUGRU. "受注理由
O_ST_APP_ALVDATA-ZBEZEI_OR = LST_ODREASON-BEZEI."テキスト
ELSE.
*   受注理由テキスト
READ TABLE I_TD_TVAUT INTO LST_TVAUT
WITH TABLE KEY AUGRU = I_ST_SDT203-AUGRU.
O_ST_APP_ALVDATA-ZBEZEI_OR = LST_TVAUT-BEZEI."テキスト
ENDIF.

* 保管場所を取得する
IF    I_ST_SDT203-ZKBUNCC = '1'
AND I_ST_SDT203-STATUS  = 'C'.
READ TABLE I_TD_STORELOC INTO LST_STORELOC
WITH TABLE KEY MATNR = O_ST_APP_ALVDATA-MATNR
WERKS = O_ST_APP_ALVDATA-WERKS.
O_ST_APP_ALVDATA-LGORT = LST_STORELOC-LGPRO."出庫保管場所
O_ST_APP_ALVDATA-LGOBE = LST_STORELOC-LGOBE."保管場所テキスト
ELSE.
READ TABLE I_TD_T001L INTO LST_T001L
WITH TABLE KEY WERKS = O_ST_APP_ALVDATA-WERKS
LGORT = O_ST_APP_ALVDATA-LGORT.
O_ST_APP_ALVDATA-LGOBE = LST_T001L-LGOBE."保管場所テキスト
ENDIF.

ENDFORM.                    " READ_ALV_REFDATA
*&---------------------------------------------------------------------*
*&      Form  F_GET_ADRC
*&---------------------------------------------------------------------*
*       マニュアル SD 伝票アドレスの抽出
*----------------------------------------------------------------------*
*      <--O_TD_ADRC  伝票アドレス
*----------------------------------------------------------------------*
FORM F_GET_ADRC  CHANGING O_TD_ADRC TYPE TYP_TD_ADRC.
CLEAR O_TD_ADRC.

SELECT *
INTO TABLE O_TD_ADRC
FROM ADRC
WHERE ADDR_GROUP = 'SD01'.

ENDFORM.                    " F_GET_ADRC
**** END ADD 2015/03/03 iSiD19   ****
**** START ADD BY ISID REN 2015/07/15 ****
*&---------------------------------------------------------------------*
*&      Form  SEL_ZTEGSDT205
*&---------------------------------------------------------------------*
*       販売伝票タイプの取得処理
*----------------------------------------------------------------------*
*      -->I_TD_SDT203        承認対象データ
*      <--O_TD_ZTEGSDT205    Sales Type Determinant
*----------------------------------------------------------------------*
FORM SEL_ZTEGSDT205
USING    I_TD_SDT203     TYPE TYP_TD_ZTEGSDT203
CHANGING O_TD_ZTEGSDT205 TYPE TYP_TD_205.
* ローカル変数定義
DATA LTD_SDT203       TYPE TYP_TD_ZTEGSDT203.

CLEAR O_TD_ZTEGSDT205.

APPEND LINES OF I_TD_SDT203 TO LTD_SDT203.
SORT LTD_SDT203 BY BSART ASCENDING          "購買伝票タイプ
KNTTP ASCENDING.         "勘定設定カテゴリ
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING BSART       "購買伝票タイプ
KNTTP.      "勘定設定カテゴリ

SELECT BSART                     "購買伝票タイプ
KNTTP                     "勘定設定カテゴリ
AUART                     "販売伝票タイプ
FROM ZTEGSDT205
INTO CORRESPONDING FIELDS OF TABLE O_TD_ZTEGSDT205
FOR ALL ENTRIES IN LTD_SDT203
WHERE BSART = LTD_SDT203-BSART  "購買伝票タイプ
AND KNTTP = LTD_SDT203-KNTTP. "勘定設定カテゴリ

IF SY-SUBRC = 0.
SORT O_TD_ZTEGSDT205
BY BSART ASCENDING    "購買伝票タイプ
KNTTP ASCENDING.   "勘定設定カテゴリ
ENDIF.

ENDFORM.                    " SEL_ZTEGSDT205
*&---------------------------------------------------------------------*
*&      Form  SEL_MVKE_T184
*&---------------------------------------------------------------------*
*       販売伝票の明細カテゴリの取得処理
*----------------------------------------------------------------------*
*      -->I_TD_SDT203        承認対象データ
*      -->I_TD_ZTEGSDT205    Sales Type Determinant
*      <--O_TD_MVKE_T184     販売伝票の明細カテゴリ
*----------------------------------------------------------------------*
FORM SEL_MVKE_T184
USING    I_TD_SDT203     TYPE TYP_TD_ZTEGSDT203
I_TD_ZTEGSDT205 TYPE TYP_TD_205
CHANGING O_TD_MVKE_T184  TYPE TYP_TD_MVKE_T184.
* ローカル変数定義
DATA: LTD_AUART_RANGE  TYPE FIP_T_AUART_RANGE,
LST_AUART_RANGE  TYPE FIP_S_AUART_RANGE,
LTD_ZTEGSDT205   TYPE TYP_TD_205,
LST_ZTEGSDT205   TYPE TYP_DATA_205,
LTD_MVKE         TYPE TYP_TD_MVKE_T184,
LTD_T184         TYPE TYP_TD_MVKE_T184,
LTD_MVKE_T184    TYPE TYP_TD_MVKE_T184,
LST_MVKE_T184    TYPE TYP_MVKE_T184,
**** START ADD BY ISID REN 25/08/31 ****
LST_MVKE_T184_T  TYPE TYP_MVKE_T184,
**** END ADD BY ISID REN 25/08/31 ****
LTD_SDT203       TYPE TYP_TD_ZTEGSDT203.

CLEAR O_TD_MVKE_T184.

APPEND LINES OF I_TD_SDT203 TO LTD_SDT203.
SORT LTD_SDT203 BY MATNR ASCENDING          "品目コード
VKORG ASCENDING          "販売組織
VTWEG ASCENDING.         "流通チャネル
DELETE ADJACENT DUPLICATES FROM LTD_SDT203
COMPARING MATNR          "品目コード
VKORG          "販売組織
VTWEG.         "流通チャネル

APPEND LINES OF I_TD_ZTEGSDT205 TO LTD_ZTEGSDT205.
SORT LTD_ZTEGSDT205 BY AUART ASCENDING.         "販売伝票タイプ
DELETE ADJACENT DUPLICATES FROM LTD_ZTEGSDT205
COMPARING AUART.          "販売伝票タイプ

LST_AUART_RANGE-SIGN   = 'I'.
LST_AUART_RANGE-OPTION = 'EQ'.
LOOP AT LTD_ZTEGSDT205 INTO LST_ZTEGSDT205.
LST_AUART_RANGE-LOW = LST_ZTEGSDT205-AUART.
APPEND LST_AUART_RANGE TO LTD_AUART_RANGE.
ENDLOOP.

SELECT MATNR                     "品目コード
VKORG                     "販売組織
VTWEG                     "流通チャネル
MTPOS                     "品目マスタの明細カテゴリグループ
FROM MVKE
INTO CORRESPONDING FIELDS OF TABLE LTD_MVKE_T184
FOR ALL ENTRIES IN LTD_SDT203
WHERE MATNR = LTD_SDT203-MATNR  "品目コード
AND VKORG = LTD_SDT203-VKORG  "販売組織
AND VTWEG = LTD_SDT203-VTWEG. "流通チャネル

IF SY-SUBRC <> 0.
RETURN.
ENDIF.

APPEND LINES OF LTD_MVKE_T184 TO LTD_MVKE.
SORT LTD_MVKE
BY MTPOS ASCENDING. "品目マスタの明細カテゴリグループ
DELETE ADJACENT DUPLICATES FROM LTD_MVKE
COMPARING MTPOS. "品目マスタの明細カテゴリグループ

SELECT AUART                     "販売伝票タイプ
PSTYV                     "明細カテゴリ初期値
MTPOS                     "品目マスタの明細カテゴリグループ
FROM T184
INTO CORRESPONDING FIELDS OF TABLE LTD_T184
FOR ALL ENTRIES IN LTD_MVKE
WHERE T184~VWPOS = SPACE             "明細用途
AND T184~UEPST = SPACE             "上位レベル明細の明細カテゴリ
AND T184~AUART IN LTD_AUART_RANGE  "販売伝票タイプ
AND T184~MTPOS
= LTD_MVKE-MTPOS.   "品目マスタの明細カテゴリグループ

IF SY-SUBRC = 0.
**** START UPD BY ISID REN 2015/08/21 ****
*    SORT LTD_T184 BY MTPOS ASCENDING. "品目マスタの明細カテゴリグループ

*    LOOP AT LTD_MVKE_T184 INTO LST_MVKE_T184.
*      READ TABLE LTD_T184 INTO LST_MVKE_T184
*        TRANSPORTING AUART                "販売伝票タイプ
*                     PSTYV                "明細カテゴリ初期値
*        WITH KEY MTPOS = LST_MVKE_T184-MTPOS
*        BINARY SEARCH.
**** START UPD BY ISID REN 2015/08/31 ****
*    SORT LTD_MVKE_T184
*      BY MTPOS ASCENDING.   "品目マスタの明細カテゴリグループ
*
*    LOOP AT LTD_T184 INTO LST_MVKE_T184.
*      READ TABLE LTD_MVKE_T184 INTO LST_MVKE_T184
*        TRANSPORTING MATNR  "品目コード
*                     VKORG "販売組織
*                     VTWEG "流通チャネル
*        WITH KEY MTPOS = LST_MVKE_T184-MTPOS
*        BINARY SEARCH.
*
*      IF SY-SUBRC = 0.
*        APPEND LST_MVKE_T184 TO O_TD_MVKE_T184.
*      ENDIF.
LOOP AT LTD_MVKE_T184 INTO LST_MVKE_T184.
LOOP AT LTD_T184
INTO LST_MVKE_T184_T
WHERE MTPOS = LST_MVKE_T184-MTPOS.
LST_MVKE_T184-PSTYV = LST_MVKE_T184_T-PSTYV. "明細カテゴリ初期値
LST_MVKE_T184-AUART = LST_MVKE_T184_T-AUART. "販売伝票タイプ
APPEND LST_MVKE_T184 TO O_TD_MVKE_T184.
ENDLOOP.
**** END UPD BY ISID REN 2015/08/31 ****
**** END UPD BY ISID REN 2015/08/21 ****
ENDLOOP.

SORT O_TD_MVKE_T184
BY AUART ASCENDING                     "販売伝票タイプ
MATNR ASCENDING                     "品目コード
VKORG ASCENDING                     "販売組織
VTWEG ASCENDING.                    "流通チャネル
ENDIF.

ENDFORM.                    " SEL_MVKE_T184
**** START ADD BY ISID REN 2015/08/28 ****
*&---------------------------------------------------------------------*
*&      Form  SEL_MVKE_T184_9000
*&---------------------------------------------------------------------*
*       販売伝票の明細カテゴリの取得処理
*----------------------------------------------------------------------*
*      -->IW_AUART           販売伝票タイプ
*      -->IW_VKORG           販売組織
*      -->IW_VTWEG           流通チャネル
*      -->I_TD_KNMT          得意先/品目情報レコードデータテーブル
*      <--O_TD_MVKE_T184     販売伝票の明細カテゴリ
*----------------------------------------------------------------------*
FORM SEL_MVKE_T184_9000
USING    IW_AUART        TYPE ZSEGSD0009-AUART
IW_VKORG        TYPE ZSEGSD0009-VKORG
IW_VTWEG        TYPE ZSEGSD0009-VTWEG
I_TD_KNMT       TYPE TYP_TD_KNMT
CHANGING O_TD_MVKE_T184  TYPE TYP_TD_MVKE_T184.
* ローカル変数定義
DATA: LTD_MVKE         TYPE TYP_TD_MVKE_T184,
LTD_T184         TYPE TYP_TD_MVKE_T184,
LTD_MVKE_T184    TYPE TYP_TD_MVKE_T184,
LST_MVKE_T184    TYPE TYP_MVKE_T184,
LST_MVKE_T184_T  TYPE TYP_MVKE_T184.

CLEAR O_TD_MVKE_T184.

IF LINES( I_TD_KNMT ) = 0.
RETURN.
ENDIF.

SELECT MATNR                     "品目コード
MTPOS                     "品目マスタの明細カテゴリグループ
FROM MVKE
INTO CORRESPONDING FIELDS OF TABLE LTD_MVKE_T184
FOR ALL ENTRIES IN I_TD_KNMT
WHERE MATNR = I_TD_KNMT-MATNR  "品目コード
AND VKORG = IW_VKORG  "販売組織
AND VTWEG = IW_VTWEG. "流通チャネル

IF SY-SUBRC <> 0.
RETURN.
ENDIF.

APPEND LINES OF LTD_MVKE_T184 TO LTD_MVKE.
SORT LTD_MVKE
BY MTPOS ASCENDING. "品目マスタの明細カテゴリグループ
DELETE ADJACENT DUPLICATES FROM LTD_MVKE
COMPARING MTPOS. "品目マスタの明細カテゴリグループ

SELECT PSTYV                     "明細カテゴリ初期値
MTPOS                     "品目マスタの明細カテゴリグループ
FROM T184
INTO CORRESPONDING FIELDS OF TABLE LTD_T184
FOR ALL ENTRIES IN LTD_MVKE
WHERE VWPOS = SPACE             "明細用途
AND UEPST = SPACE             "上位レベル明細の明細カテゴリ
AND AUART = IW_AUART          "販売伝票タイプ
AND MTPOS = LTD_MVKE-MTPOS.   "品目マスタの明細カテゴリグループ

IF SY-SUBRC = 0.
LOOP AT LTD_MVKE_T184 INTO LST_MVKE_T184.
LOOP AT LTD_T184
INTO LST_MVKE_T184_T
WHERE MTPOS = LST_MVKE_T184-MTPOS.
LST_MVKE_T184-PSTYV = LST_MVKE_T184_T-PSTYV. "明細カテゴリ初期値
APPEND LST_MVKE_T184 TO O_TD_MVKE_T184.
ENDLOOP.
ENDLOOP.

SORT O_TD_MVKE_T184
BY MATNR ASCENDING                      "品目コード
PSTYV ASCENDING.                     "明細カテゴリ初期値
ENDIF.

ENDFORM.                    " SEL_MVKE_T184_9000
**** END ADD BY ISID REN 2015/08/28 ****
*&---------------------------------------------------------------------*
*&      FORM  READ_TEXT_OD_REMARK
*&---------------------------------------------------------------------*
*       出荷指示備考の情報を取得する
*----------------------------------------------------------------------*
*      -->I_W_SPRAS         言語キー
*      -->I_W_VKORG         販売組織
*      -->I_W_VTWEG         流通チャネル
*      -->I_W_KUNNR         得意先
*      -->I_W_MATNR         品目
*      <--O_W_Z_SHP_REMARK1 Outbound Delivery Remark(1)
*      <--O_W_Z_SHP_REMARK2 Outbound Delivery Remark(2)
*----------------------------------------------------------------------*
FORM READ_TEXT_OD_REMARK
USING    I_W_SPRAS         TYPE TYP_ZTEGSDT203-SPRAS
I_W_VKORG         TYPE TYP_ZTEGSDT203-VKORG
I_W_VTWEG         TYPE TYP_ZTEGSDT203-VTWEG
I_W_KUNNR         TYPE TYP_ZTEGSDT203-KUNNR
I_W_MATNR         TYPE TYP_ZTEGSDT203-MATNR
CHANGING O_W_Z_SHP_REMARK1 TYPE TYP_ZTEGSDT203-Z_SHP_REMARK1
O_W_Z_SHP_REMARK2 TYPE TYP_ZTEGSDT203-Z_SHP_REMARK2.
* ローカル変数定義
DATA: LW_TDNAME  TYPE THEAD-TDNAME,   "読込テキスト名
LTD_TLINE  TYPE TLINE_TAB,      "返り値のテキスト
LST_TLINE  TYPE TLINE.          "テキスト行

CLEAR: O_W_Z_SHP_REMARK1,
O_W_Z_SHP_REMARK2.

* 読込テキスト名の作成
**** START UPD BY ISID REN 2015/08/04 ****
*  CONCATENATE I_W_VKORG         "販売組織
*              I_W_VTWEG         "流通チャネル
*              I_W_KUNNR         "得意先
*              I_W_MATNR         "品目
*         INTO LW_TDNAME.        "読込テキスト名
LW_TDNAME+0(4)   = I_W_VKORG.  "販売組織
LW_TDNAME+4(2)   = I_W_VTWEG.  "流通チャネル
LW_TDNAME+6(10)  = I_W_KUNNR.  "得意先
LW_TDNAME+16(18) = I_W_MATNR.  "品目
**** END UPD BY ISID REN 2015/08/04 ****

* SAPscript: テキスト読込
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = CNS_TDID_0001
LANGUAGE                = I_W_SPRAS
NAME                    = LW_TDNAME
OBJECT                  = CNS_TDOBJECT_KNMT
TABLES
LINES                   = LTD_TLINE
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

IF SY-SUBRC = 0.
IF LINES( LTD_TLINE ) >= 1.
READ TABLE LTD_TLINE INDEX 1 INTO LST_TLINE.

MOVE LST_TLINE-TDLINE TO O_W_Z_SHP_REMARK1.
ENDIF.

IF LINES( LTD_TLINE ) >= 2.
READ TABLE LTD_TLINE INDEX 2 INTO LST_TLINE.

MOVE LST_TLINE-TDLINE TO O_W_Z_SHP_REMARK2.
ENDIF.
ENDIF.

ENDFORM.                    " READ_TEXT_OD_REMARK
**** END ADD BY ISID REN 2015/07/15 ****
**** START ADD BY ISID REN 2015/08/07 ****
*&---------------------------------------------------------------------*
*&      FORM  CHK_PSTYV
*&---------------------------------------------------------------------*
*       チェック明細カテゴリ
*----------------------------------------------------------------------*
*      -->I_TD_ITEM_ALV         ALV DATA
*      -->I_W_ROW_ID            ROW ID
*      -->I_W_VALUE             明細カテゴリ
*      -->I_W_VKORG             販売組織
*      -->I_W_VTWEG             流通チャネル
*      -->I_W_AUART             販売伝票タイプ
*      <--O_W_ERR_FLG           エラーフラグ
*----------------------------------------------------------------------*
FORM CHK_PSTYV
USING    I_TD_ITEM_ALV     TYPE TYP_TD_ITEM
I_W_ROW_ID        TYPE LVC_S_MODI-ROW_ID
I_W_VALUE         TYPE LVC_S_MODI-VALUE
I_W_VKORG         TYPE ZSEGSD0009-VKORG
I_W_VTWEG         TYPE ZSEGSD0009-VTWEG
I_W_AUART         TYPE ZSEGSD0009-AUART
CHANGING O_W_ERR_FLG       TYPE FLAG.
* ローカル変数の定義
DATA: LW_PSTYV     TYPE TVAP-PSTYV,
LW_PSTYV_T   TYPE TVAP-PSTYV,
LTD_T184     TYPE TYP_TD_T184,
LST_T184     TYPE TYP_T184,
LST_ITEM     TYPE TYP_ALV_ITEM,
LW_MTPOS     TYPE MVKE-MTPOS.

* クリア
CLEAR O_W_ERR_FLG. "エラーフラグ

LW_PSTYV_T = I_W_VALUE. "明細カテゴリ

* 品目コードの取得
READ TABLE I_TD_ITEM_ALV
INTO     LST_ITEM
INDEX    I_W_ROW_ID
TRANSPORTING MATNR   "品目コード
PSTYV.  "Item Cat

IF LST_ITEM-PSTYV IS INITIAL.
RETURN.
ENDIF.

* 品目マスタの明細カテゴリグループの抽出
SELECT SINGLE MTPOS        "品目マスタの明細カテゴリグループ
FROM        MVKE         "品目の販売データ
INTO        LW_MTPOS     "品目マスタの明細カテゴリグループ
WHERE MATNR = LST_ITEM-MATNR       "品目コード
AND VKORG = I_W_VKORG            "販売組織
AND VTWEG = I_W_VTWEG.           "流通チャネル

IF SY-SUBRC = 0.
*   販売伝票: 明細カテゴリ決定の検索
SELECT AUART       "販売伝票タイプ
MTPOS       "品目マスタの明細カテゴリグループ
PSTYV       "伝票の明細カテゴリ初期値
PSTY1       "マニュアル登録可能な伝票明細カテゴリ
PSTY2       "マニュアル登録可能な伝票明細カテゴリ
PSTY3       "マニュアル登録可能な伝票明細カテゴリ
PSTY4       "マニュアル登録可能な伝票明細カテゴリ
PSTY5       "マニュアル登録可能な伝票明細カテゴリ
PSTY6       "マニュアル登録可能な伝票明細カテゴリ
PSTY7       "マニュアル登録可能な伝票明細カテゴリ
PSTY8       "マニュアル登録可能な伝票明細カテゴリ
PSTY9       "マニュアル登録可能な伝票明細カテゴリ
PSTY10      "マニュアル登録可能な伝票明細カテゴリ
PSTY11      "マニュアル登録可能な伝票明細カテゴリ
FROM  T184
INTO CORRESPONDING FIELDS OF TABLE LTD_T184
WHERE AUART = I_W_AUART "販売伝票タイプ
AND MTPOS = LW_MTPOS  "品目マスタの明細カテゴリグループ
AND VWPOS = SPACE     "明細用途
AND UEPST = SPACE.    "上位レベル明細の明細カテゴリ

IF SY-SUBRC = 0.
LOOP AT LTD_T184 INTO LST_T184.
DO 12 TIMES VARYING LW_PSTYV
FROM LST_T184-PSTYV
NEXT LST_T184-PSTY1.
IF LW_PSTYV = LW_PSTYV_T.
RETURN.
ENDIF.
ENDDO.
ENDLOOP.
ENDIF.
ENDIF.

O_W_ERR_FLG = ABAP_TRUE.

ENDFORM.                    " CHK_PSTYV
**** END ADD BY ISID REN 2015/08/07 ****
**** START ADD BY ISID REN 2015/08/28 ****
*&---------------------------------------------------------------------*
*&      FORM  CHK_MARM
*&---------------------------------------------------------------------*
*       品目単位の整合性をチェックする
*----------------------------------------------------------------------*
*      -->I_TD_ITEM_ALV         ALV DATA
*      -->I_W_ROW_ID            ROW ID
*      -->I_W_MATNR             品目コード
*      <--O_W_ERR_FLG           エラーフラグ
*      <--O_W_PSTYV             明細カテゴリ (販売伝票)
*      <--O_W_MEINH             発注単位
*----------------------------------------------------------------------*
FORM CHK_MARM
USING    I_TD_ITEM_ALV     TYPE TYP_TD_ITEM
I_W_ROW_ID        TYPE LVC_S_MODI-ROW_ID
I_W_MATNR         TYPE KNMT-MATNR
CHANGING O_W_ERR_FLG       TYPE FLAG
O_W_PSTYV         TYPE ZSEGSD0010-PSTYV
O_W_MEINH         TYPE MARM-MEINH.
* ローカル変数の定義
DATA: LW_PSTYV     TYPE TVAP-PSTYV,
LW_PSTYV_T   TYPE TVAP-PSTYV,
LTD_T184     TYPE TYP_TD_T184,
LST_T184     TYPE TYP_T184,
LST_ITEM     TYPE TYP_ALV_ITEM,
LW_MTPOS     TYPE MVKE-MTPOS.

* クリア
CLEAR: O_W_ERR_FLG, "エラーフラグ
O_W_PSTYV,   "明細カテゴリ (販売伝票)
O_W_MEINH.   "発注単位

* 品目コードの取得
READ TABLE I_TD_ITEM_ALV
INTO     LST_ITEM
INDEX    I_W_ROW_ID.

O_W_PSTYV = LST_ITEM-PSTYV.     "明細カテゴリ (販売伝票)
O_W_MEINH = LST_ITEM-VRKME.     "発注単位

* 品目単位の整合性をチェックする
SELECT SINGLE MEINH    "代替数量単位
FROM        MARM     "品目数量単位
INTO        LST_ITEM-VRKME     "発注単位
WHERE MATNR = I_W_MATNR        "品目コード
AND MEINH = LST_ITEM-VRKME.  "発注単位

IF SY-SUBRC <> 0.
O_W_ERR_FLG = ABAP_TRUE.
ENDIF.

ENDFORM.                    " CHK_MARM
**** END ADD BY ISID REN 2015/08/28 ****

**** START ADD BY ISID21 2015/09/22 ****
*&---------------------------------------------------------------------*
*&      GET_MASTER_PRICE.
*&---------------------------------------------------------------------*
*       販売価格マスタの価格情報を取得する
*----------------------------------------------------------------------*
*      -->I_W_VKORG         販売組織
*      -->I_W_VTWEG         流通チャネル
*      -->I_W_SPART         製品部門
*      -->I_W_KUNNR         得意先コード
*      -->I_W_ZZZKDMAT   得意先品目コード
*      -->I_W_MATNR        品目コード
*      -->I_W_KWMENG    　販売累積数量
*      -->I_W_VRKME　    　販売単位
*      <--O_W_ZMNETPR        マスタ販売価格
*      <--O_ZMWAERK           マスタ販売伝票通貨
*      <--O_ZMKPEIN             マスタ価格条件単位
*      <--O_ZMZVRKME          マスタ販売単位
*----------------------------------------------------------------------*
FORM GET_MASTER_PRICE
USING
I_W_VKORG TYPE A901-VKORGAU
I_W_VTWEG TYPE A901-VTWEG
I_W_SPART TYPE A901-SPART
I_W_KUNNR TYPE A901-KUNNR
I_W_ZZZKDMAT  TYPE A901-ZZZKDMAT
I_W_MATNR  TYPE MARA-MATNR
I_W_KWMENG TYPE EKPO-MENGE
I_W_VRKME TYPE ZSEGSD0008-VRKME
CHANGING
O_W_ZMNETPR   TYPE ZSEGSD0008-ZMNETPR
O_W_ZMWAERK   TYPE ZSEGSD0008-ZMWAERK
O_W_ZMKPEIN     TYPE ZSEGSD0008-ZMKPEIN
O_W_ZMZVRKME  TYPE ZSEGSD0008-ZMZVRKME.

* ローカルデータ宣言
DATA:
LST_A901 TYPE TYP_A901,
LST_KONP TYPE TYP_KONP,
LTD_KONM TYPE TABLE OF TYP_KONM,
LST_KONM TYPE TYP_KONM,
LW_MENGE TYPE EKPO-MENGE,
LW_SUBRC TYPE SY-SUBRC,
LW_WAERS    TYPE WAERS,
LW_BAPICURR LIKE  BAPICURR-BAPICURR.

* 初期クリア
CLEAR:
O_W_ZMNETPR,
O_W_ZMWAERK,
O_W_ZMKPEIN,
O_W_ZMZVRKME.

*  条件れコート番号
SELECT DATBI                                  "条件マスタ有効終了日
DATAB                                  "条件マスタ有効開始日
KNUMH                                  "条件レコード番号
INTO LST_A901
FROM A901
WHERE KAPPL    = CNS_V                   "アプリケーション
AND VKORGAU = I_W_VKORG            "受注伝票の販売組織
AND VTWEG    = I_W_VTWEG            "流通チャネル
AND SPART    = I_W_SPART            "製品部門
AND KUNNR    = I_W_KUNNR            "得意先コード
AND ZZZKDMAT = I_W_ZZZKDMAT   "客先型番
AND DATBI    >= SY-DATUM
AND DATAB  <= SY-DATUM.
ENDSELECT.

IF SY-SUBRC <> 0.
RETURN.
ENDIF.

* 条件情報取得
PERFORM GET_KONP_KONM TABLES   LTD_KONM
USING    LST_A901-KNUMH
'S'
CHANGING LST_KONP
LW_SUBRC.

* 販売価格マスタの販売価格を設定する。
IF LW_SUBRC = 0.
O_W_ZMNETPR = LST_KONP-KBETR.
O_W_ZMWAERK = LST_KONP-KONWA.
O_W_ZMKPEIN = LST_KONP-KPEIN.
O_W_ZMZVRKME = LST_KONP-KMEIN.
ELSE.
RETURN.
ENDIF.

*  数量変更
CALL FUNCTION 'MD_CONVERT_MATERIAL_UNIT'
EXPORTING
I_MATNR              = I_W_MATNR
I_IN_ME              = I_W_VRKME
I_OUT_ME             = LST_KONP-KMEIN
I_MENGE              = I_W_KWMENG
IMPORTING
E_MENGE              = LW_MENGE
EXCEPTIONS
ERROR_IN_APPLICATION = 1
ERROR                = 2
OTHERS               = 3.

IF SY-SUBRC <> 0.
RETURN.
ENDIF.

* スケールの販売価格を適用する。
SORT LTD_KONM BY KSTBM ASCENDING.
LOOP AT LTD_KONM INTO LST_KONM.
IF I_W_KWMENG >= LST_KONM-KSTBM.
O_W_ZMNETPR = LST_KONM-KBETR.
ELSE.
EXIT.
ENDIF.
ENDLOOP.
ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  GET_KONP_KONM
*&---------------------------------------------------------------------*
*       条件情報取得
*----------------------------------------------------------------------*
*      -->I_KONM    条件 (一次元の数量スケール)情報
*      -->I_KNUMH   条件レコード番号
*      <--O_KONP    条件 (明細)情報
*      <--O_SUBRC   処理結果
*----------------------------------------------------------------------*
FORM GET_KONP_KONM TABLES   I_KONM STRUCTURE ST_KONM
USING    I_KNUMH TYPE A017-KNUMH
I_FLG   TYPE C
CHANGING O_KONP  TYPE TYP_KONP
O_SUBRC TYPE SY-SUBRC.

* 条件 (明細)情報取得
SELECT KONMS                   "条件スケール単位
KPEIN                   "価格条件単位
KMEIN                   "条件単位
KBETR
KONWA
INTO O_KONP
FROM KONP
WHERE KNUMH = I_KNUMH.
ENDSELECT.
O_SUBRC = SY-SUBRC.
IF O_SUBRC <> 0.
RETURN.
ENDIF.

* 条件 (一次元の数量スケール)情報取得
SELECT KSTBM                   "条件スケール数量
KBETR                   "条件レート (条件金額/パーセント)
INTO TABLE I_KONM
FROM KONM
WHERE KNUMH = I_KNUMH.

ENDFORM.                    " GET_KONP_KONM
**** END ADD BY ISID21 2015/09/22 ****
