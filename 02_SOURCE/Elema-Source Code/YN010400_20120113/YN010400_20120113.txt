*&---------------------------------------------------------------------*
*& Report  YN010400
*&
*&---------------------------------------------------------------------*
*&  機能     ： マニュアル照合
*&  作成日   ： 2006/06/12
*&  作成者   ： NDSC
*&  変更履歴 ： 2007/02/28 Version2
*&  変更内容 ： Version2 (2007/02/28 R.Tomoeda)
*&           ：  ・支払基準日更新のデフォルトチェックをはずす
*&           ：  ・照合番号/照合日/照合ユーザ追加
*&           ：  ・外部データ入力の明細コピーボタンの追加
*&           ：  ・外部データ入力のデフォルトレイアウト表示
*&  変更履歴 ： 2007/11/27 バグ修正
*&  変更内容 ： バグ修正(2007/11/27 R.Tomoeda)
*&           ：  ・ローカルファイル出力時のヘッダとレコード行のずれを修#
*&  変更内容 ： テンプレート改善ＰＪ (2009/01/13 OODUCHI)
*&           ：・パフォーマンス改善
*&
*&  変更履歴 ： テンプレート改善ＰＪ (2009/01/21 Y.WAN)
*&  変更内容 ： ・ALV画面に照合取消機能を追加
*&  変更履歴 ： conversion様 対応
*&  変更内容 ： ECC6.0→4.6C (2010/12/13 K.Onoda)
*&           ： ・コンバージョン作業
*&  変更内容 ： elematec様用仕様変更 (2011/12/07 S.Takikawa)
*&              部分照合機能追加(2011/12/22 S.Takikawa)
*&---------------------------------------------------------------------*
REPORT  YN010400 MESSAGE-ID YN01
NO STANDARD PAGE HEADING
.

TABLES: YN110,
YN120,
YN210,
YN220.

INCLUDE <ICON>.

*&---------------------------------------------------------------------*
*&   定数定義　
*&---------------------------------------------------------------------*
CONSTANTS: C_ON  TYPE C VALUE 'X',
C_OFF TYPE C VALUE ' '.

CONSTANTS: C_RC_CODE_ERROR         LIKE SY-SUBRC VALUE '9',
C_RC_CODE_DB_ERROR      LIKE SY-SUBRC VALUE '8',
C_RC_CODE_NOT_EXIST     LIKE SY-SUBRC VALUE '4',
C_RC_CODE_NO_AUTHORITY  LIKE SY-SUBRC VALUE '5'.

* 外部／自社区分
CONSTANTS: C_KUBUN_EXTERNAL(2) TYPE C VALUE '10',         " 外部
C_KUBUN_INTERNAL(2) TYPE C VALUE '20'.         " 自社

CONSTANTS: C_USER_COMMAND_SELECT_ALL(20)   TYPE C VALUE '&SELECT_ALL',
C_USER_COMMAND_DESELECT_ALL(20) TYPE C VALUE '&DESELECT_ALL',
C_USER_COMMAND_COMPARE(20)         TYPE C VALUE 'COMP',
C_USER_COMMAND_SELECT_TARGET(20)   TYPE C VALUE 'SLTG',
C_USER_COMMAND_DESELECT_TARGET(20) TYPE C VALUE 'DSTG',
C_USER_COMMAND_INPUT_DATA(20)      TYPE C VALUE 'INPD',
C_USER_COMMAND_EDIT_DATA(20)       TYPE C VALUE 'EDID',
C_USER_COMMAND_DELETE_DATA(20)     TYPE C VALUE 'DELD',
C_USER_COMMAND_UPDATE_COMMENT(20)  TYPE C VALUE 'UPCM',
C_USER_COMMAND_CANCEL_DATA(20)     TYPE C VALUE 'CNLD',
*&Ver2 対応 2007/02/28 >>> 外部データ入力の明細コピーボタンの追加
C_USER_COMMAND_COPY_ROW(20)        TYPE C VALUE '&COPY_ROW',
*&Ver2 対応 2007/02/28 <<<
C_USER_COMMAND_SAVE(20)            TYPE C VALUE 'SAVE'.


CONSTANTS: C_STATUS_OK                    TYPE X VALUE '00',
C_STATUS_EXTERNAL_DATA         TYPE X VALUE '01',
C_STATUS_INTERNAL_DATA         TYPE X VALUE '02',
C_STATUS_DELETED_DATA          TYPE X VALUE '04',
C_STATUS_AUTO_COMPARED_DATA    TYPE X VALUE '40',
C_STATUS_MANUAL_COMPARED_DATA  TYPE X VALUE '80',
C_STATUS_NO_DATA               TYPE X VALUE 'FF',
*照合取消 2009/01/21 ADD-S
C_STATUS_NO_CANCEL_DATA        TYPE X VALUE '08',"00001000
C_STATUS_NOTONE_SYOUGOU        TYPE X VALUE '10'."00010000
*照合取消 2009/01/21 ADD-E
* 照合ステータス
CONSTANTS: C_CSTS_INIT                  TYPE C VALUE '1',
C_CSTS_NO_EXTERNAL           TYPE C VALUE '6',
C_CSTS_NO_INTERNAL           TYPE C VALUE '6',
C_CSTS_DIFFERENT_QUANTITY    TYPE C VALUE '6',
C_CSTS_DIFFERENT_PRICE       TYPE C VALUE '6',
C_CSTS_OK                    TYPE C VALUE '8'.

* 売上／仕入区分
CONSTANTS: C_MODE_SALES                 TYPE C VALUE '1',
C_MODE_PURCHASE              TYPE C VALUE '2'.

* 外部データ入力モード
CONSTANTS: C_INPUT_MODE_NEW             TYPE C VALUE 'N',   " 登録
C_INPUT_MODE_EDIT            TYPE C VALUE 'E'.   " 更新

* リターンモード
CONSTANTS: C_RETURN_MODE_EXIT           TYPE C VALUE 'E',   " EXIT
C_RETURN_MODE_SAVE           TYPE C VALUE 'S',   " SAVE
C_RETURN_MODE_COMPARE        TYPE C VALUE 'C'.   " 照合押下

CONSTANTS: C_DOMAIN_NAME_KUBUN(10)      TYPE C VALUE 'YNCHAR2',
C_DOMAIN_NAME_CSTS(10)       TYPE C VALUE 'YNCHAR1'.

* elematec 対応 2011/12/07 ADD >>>
*CONSTANTS: C_MSGNO_CONFIRM_COMPARE      LIKE SY-MSGNO VALUE '790',
CONSTANTS: C_MSGNO_CONFIRM_COMPARE      LIKE SY-MSGNO VALUE '905',
* elematec 対応 2011/12/07 ADD <<<
C_MSGNO_CONFIRM_MODIFY       LIKE SY-MSGNO VALUE '792',
C_MSGNO_CONFIRM_DELETE       LIKE SY-MSGNO VALUE '791',
C_MSGNO_CONFIRM_EXIT         LIKE SY-MSGNO VALUE '794',
*-- 20090113 INS STA
C_MSGNO_CONFIRM_CONTINUE     LIKE SY-MSGNO VALUE '704',
*-- 20090113 INS END
C_MSGNO_INFORM_MODIFY        LIKE SY-MSGNO VALUE '795',
C_MSGNO_INFORM_RELEASE       LIKE SY-MSGNO VALUE '796',
C_MSGNO_INFORM_DELETE        LIKE SY-MSGNO VALUE '797',
*照合取消 2009/01/21 ADD-S
C_MSGNO_INFORM_CANCEL        LIKE SY-MSGNO VALUE '708'. "照合
*照合取消 2009/01/21 ADD-E

*-- 20090113 INS STA
CONSTANTS: C_DEFAULT_ONE TYPE C VALUE '1',    " はい
C_DEFAULT_TWO TYPE C VALUE '2',    " いいえ
C_CONTINUE_COUNT LIKE SY-DBCNT VALUE '5000',
C_SCOPE_THREE TYPE C VALUE '3',    " ロックパラメータ
*-- 20090113 INS END

*照合取消 2009/01/21 ADD-S
* conversion 対応 2010/12/13 UPD >>>
*           C_CANCEL_NUMBER_TEXT TYPE STRING VALUE '件、',
C_CANCEL_NUMBER_TEXT(4) TYPE C VALUE '件、',
* conversion 対応 2010/12/13 UPD <<<
"ポップアップ画面表示用
* conversion 対応 2010/12/13 UPD >>>
*           C_PROGRAM_NAME       TYPE STRING VALUE 'YN010400',
C_PROGRAM_NAME(8)       TYPE C VALUE 'YN010400',
* conversion 対応 2010/12/13 UPD <<<
"照合取消のテーブル更新用
C_CHECK_KOUMOKU(5)   TYPE C VALUE 'BUKRS',
"チェックする権限項目
* conversion 対応 2010/12/13 UPD >>>
*           C_CHECK_KOUMOKU_TEXT_JP TYPE STRING VALUE '会社コード',
C_CHECK_KOUMOKU_TEXT_JP(10) TYPE C VALUE '会社コード',
* conversion 対応 2010/12/13 UPD <<<
"チェックする権限項目日本語テキスト
* conversion 対応 2010/12/13 UPD >>>
*           C_CHECK_KOUMOKU_TEXT_EN TYPE STRING VALUE 'Company Code',
C_CHECK_KOUMOKU_TEXT_EN(12) TYPE C VALUE 'Company Code',
* conversion 対応 2010/12/13 UPD <<<
"チェックする権限項目英語テキスト
C_DUMMY              LIKE TACT-ACTVT VALUE '00',
"DUMMY(権限チェック用)
C_ACTVT              LIKE TACT-ACTVT VALUE '00'.
"チェックする権限
*照合取消 2009/01/21 ADD-E

DATA: C_TAB TYPE C.

* conversion 対応 2010/12/13 ADD >>>
* テーブルID
CONSTANTS: C_TABLE_ID_GA_URI(5) TYPE C VALUE 'YN110',  "外部データ(売上)
C_TABLE_ID_GA_SHI(5) TYPE C VALUE 'YN210',  "外部データ(仕入)
C_TABLE_ID_ZI_URI(5) TYPE C VALUE 'YN120',  "自社データ(売上)
C_TABLE_ID_ZI_SHI(5) TYPE C VALUE 'YN220'.  "自社データ(仕入)
* conversion 対応 2010/12/13 ADD <<<

* elematec 対応 2011/12/07 ADD >>>
CONSTANTS: C_PARVW_SEIKYU     TYPE PARVW VALUE 'RS'.  "請求先
* elematec 対応 2011/12/07 ADD <<<

*&---------------------------------------------------------------------*
*&   内部テーブル定義　
*&---------------------------------------------------------------------*
TYPES: BEGIN OF TYP_ALV_CUSTOMIZER,
*&バグ対応 2007/05/22 >>> 大文字/小文字を区別
*         NAME(8)   TYPE C,
NAME(10)   TYPE C,
*&バグ対応 2007/05/22 <<< 大文字/小文字を区別
PROPS(80) TYPE C,
END OF TYP_ALV_CUSTOMIZER.

TYPES: TYP_T_ALV_CUSTOMIZER TYPE STANDARD TABLE OF TYP_ALV_CUSTOMIZER.

* ALV属性定義（照合画面）
DATA: T_ALV_CUSTOMIZER_0100 TYPE TYP_T_ALV_CUSTOMIZER.
* ALV属性定義（入力画面）
DATA: T_ALV_CUSTOMIZER_0200 TYPE TYP_T_ALV_CUSTOMIZER.

TYPES: BEGIN OF TYP_YN_10_DATA,
YNTGTFLG          LIKE YN110-TGTFLG,   " 照合対象フラグ
YNGJAHR           LIKE YN110-GJAHR,    " 会計年度
YNSLPDOC          LIKE YN110-SLPDOC,   " 外部番号
YNDTLDOC          LIKE YN110-DTLDOC,   " 外部明細番号
YNVRFCTON         LIKE YN110-VRFCTON,  " 取引先コード
YNBUKRS           LIKE YN110-BUKRS,    " 会社コード
YNZFBDT           LIKE YN110-ZFBDT,    " 日付
YNPRCTR           LIKE YN110-PRCTR,    " 利益センタ
YNPERNR           LIKE YN110-PERNR,    " 担当者
YNDVSON           LIKE YN110-DVSON,    " 部門
YNCSTS            LIKE YN110-CSTS,     " 照合ステータス
YNSGTXT           LIKE YN110-COMMT,    " コメント
YNKNQUAN          LIKE YN110-KNQUAN,   " 数量
YNKNUNIT          LIKE YN110-KNUNIT,   " 単位
YNKNUNTPRC        LIKE YN110-KNUNTPRC, " 単価
YNKNTAXAMT        LIKE YN110-KNTAXAMT, " 消費税額
YNKNITXAMT        LIKE YN110-KNITXAMT, " 税抜金額
YNKNETXAMT        LIKE YN110-KNETXAMT, " 税込金額
YNWAERS           LIKE YN110-WAERS,    " 通貨コード
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
YNCHKDOC          LIKE YN110-CHKDOC,   " 照合番号
YNCHKDAT          LIKE YN110-CHKDAT,   " 照合日
YNCHKUSR          LIKE YN110-CHKUSR,   " 照合ユーザ
*&Ver2 対応 2007/02/28 <<<
YNUPDDAT          LIKE YN110-UPDDAT,   " 更新日
YNUPDTIM          LIKE YN110-UPDTIM,   " 更新時刻
YNUPDUSR          LIKE YN110-UPDUSR,   " 更新ユーザ
YNUPDPRG          LIKE YN110-UPDPRG,   " 更新プログラム
YNDELFLG          LIKE YN110-DELFLG,   " 削除フラグ
YNOLDGJAHR        LIKE YN110-OLDGJAHR,    " 元会計年度
YNOLDSLPDOC       LIKE YN110-OLDSLPDOC,   " 元外部番号
YNOLDDTLDOC       LIKE YN110-OLDDTLDOC,   " 元外部明細番号
YNCKEY1           LIKE YN110-CKEY1,    " 得意先発注番号
YNCKEY2           LIKE YN110-CKEY2,    " 取引先品目コード
YNCKEY3           LIKE YN110-CKEY3,                " 照合キー3
YNCKEY4           LIKE YN110-CKEY4,                " 照合キー4
YNCKEY5           LIKE YN110-CKEY5,                " 照合キー5
YNCKEY6           LIKE YN110-CKEY6,                " 照合キー6
YNCKEY7           LIKE YN110-CKEY7,                " 照合キー7
YNCKEY8           LIKE YN110-CKEY8,                " 照合キー8
YNLIST1           LIKE YN110-LIST1,    " 自社品目コード
YNLIST2           LIKE YN110-LIST2,    " 品名
YNLIST3           LIKE YN110-LIST3,    " 受注先コード
YNLIST4           LIKE YN110-LIST4,    " 得意発注明細番号
YNLIST5           LIKE YN110-LIST5,    " 一覧表示項目5
YNLIST6           LIKE YN110-LIST6,    " 一覧表示項目6
YNLIST7           LIKE YN110-LIST7,    " 一覧表示項目7
YNLIST8           LIKE YN110-LIST8,    " 一覧表示項目8
YNLIST9           LIKE YN110-LIST9,    " 一覧表示項目9
YNLIST10          LIKE YN110-LIST10,   " 一覧表示項目10
* elematec 対応 2011/12/07 ADD >>>
YNINSDT           LIKE YN110-INSDT,    " 登録日
YNLDATE1          LIKE YN110-LDATE1,   " 請求日
YNCZFBDT          LIKE YN110-CZFBDT,   " 照合締日
*         YNAUTOFLG_P       LIKE YN110-AUTOFLG_P, "自動生成明細
* elematec 対応 2011/12/07 ADD <<<
END OF TYP_YN_10_DATA.

* 検索用外部データ内部テーブル
DATA: T_YN_10_DATA TYPE STANDARD TABLE OF TYP_YN_10_DATA.

TYPES: BEGIN OF TYP_YN_20_DATA,
YNTGTFLG          LIKE YN120-TGTFLG,   " 照合対象フラグ
YNGJAHR           LIKE YN120-GJAHR,    " 会計年度
YNSLPDOC          LIKE YN120-SLPDOC,   " 外部番号
YNDTLDOC          LIKE YN120-DTLDOC,   " 外部明細番号
YNVRFCTON         LIKE YN120-VRFCTON,  " 取引先コード
YNBUKRS           LIKE YN120-BUKRS,    " 会社コード
YNZFBDT           LIKE YN120-ZFBDT,    " 日付
YNPRCTR           LIKE YN120-PRCTR,    " 利益センタ
YNPERNR           LIKE YN120-PERNR,    " 担当者
YNDVSON           LIKE YN120-DVSON,    " 部門
YNCSTS            LIKE YN120-CSTS,     " 照合ステータス
YNSGTXT           LIKE YN120-COMMT,    " コメント
YNGJAHR_B         LIKE YN120-YNGJAHR,  " 会計伝票会計年度
YNBELNR           LIKE YN120-BELNR,    " 会計伝票番号
YNBUZEI           LIKE YN120-BUZEI,    " 会計伝票明細番号
YNKNQUAN          LIKE YN120-KNQUAN,   " 数量
YNKNUNIT          LIKE YN120-KNUNIT,   " 単位
YNKNUNTPRC        LIKE YN120-KNUNTPRC, " 単価
YNKNTAXAMT        LIKE YN120-KNTAXAMT, " 消費税額
YNKNITXAMT        LIKE YN120-KNITXAMT, " 税抜金額
YNKNETXAMT        LIKE YN120-KNETXAMT, " 税込金額
YNWAERS           LIKE YN120-WAERS,    " 通貨コード
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
YNCHKDOC          LIKE YN120-CHKDOC,   " 照合番号
YNCHKDAT          LIKE YN120-CHKDAT,   " 照合日
YNCHKUSR          LIKE YN120-CHKUSR,   " 照合ユーザ
*&Ver2 対応 2007/02/28 <<<
YNUPDDAT          LIKE YN120-UPDDAT,   " 更新日
YNUPDTIM          LIKE YN120-UPDTIM,   " 更新時刻
YNUPDUSR          LIKE YN120-UPDUSR,   " 更新ユーザ
YNUPDPRG          LIKE YN120-UPDPRG,   " 更新プログラム
YNCKEY1           LIKE YN120-CKEY1,    " 得意先発注番号
YNCKEY2           LIKE YN120-CKEY2,    " 取引先品目コード
YNCKEY3           LIKE YN120-CKEY3,                " 照合キー3
YNCKEY4           LIKE YN120-CKEY4,                " 照合キー4
YNCKEY5           LIKE YN120-CKEY5,                " 照合キー5
YNCKEY6           LIKE YN120-CKEY6,                " 照合キー6
YNCKEY7           LIKE YN120-CKEY7,                " 照合キー7
YNCKEY8           LIKE YN120-CKEY8,                " 照合キー8
YNLIST1           LIKE YN120-LIST1,    " 自社品目コード
YNLIST2           LIKE YN120-LIST2,    " 品名
YNLIST3           LIKE YN120-LIST3,    " 受注先コード
YNLIST4           LIKE YN120-LIST4,    " 得意発注明細番号
YNLIST5           LIKE YN120-LIST5,    " 一覧表示項目5
YNLIST6           LIKE YN120-LIST6,    " 一覧表示項目6
YNLIST7           LIKE YN120-LIST7,    " 一覧表示項目7
YNLIST8           LIKE YN120-LIST8,    " 一覧表示項目8
YNLIST9           LIKE YN120-LIST9,    " 一覧表示項目9
YNLIST10          LIKE YN120-LIST10,   " 一覧表示項目10
* elematec 対応 2011/12/07 ADD >>>
YNINSDT           LIKE YN120-INSDT,    " 登録日
YNLDATE1          LIKE YN120-LDATE1,   " 請求日
YNCZFBDT          LIKE YN120-CZFBDT,   " 照合締日
* elematec 対応 2011/12/07 ADD <<<
END OF TYP_YN_20_DATA.

* 検索用自社データ内部テーブル
DATA: T_YN_20_DATA TYPE STANDARD TABLE OF TYP_YN_20_DATA.

* ロック/アンロック用内部テーブル定義
TYPES:BEGIN OF TYP_T_ENQ_KEY,
BUKRS   LIKE YN110-BUKRS,
VRFCTON LIKE YN110-VRFCTON,
END OF TYP_T_ENQ_KEY.

DATA: G_WA_ENQ_KEY     TYPE TYP_T_ENQ_KEY,
G_TBL_ENQ_KEY_J  TYPE SORTED TABLE OF TYP_T_ENQ_KEY
WITH NON-UNIQUE KEY BUKRS VRFCTON,    "自社用
G_TBL_ENQ_KEY_G  TYPE SORTED TABLE OF TYP_T_ENQ_KEY
WITH NON-UNIQUE KEY BUKRS VRFCTON,    "外部用
G_TBL_ENQ_KEY_J_OK  TYPE SORTED TABLE OF TYP_T_ENQ_KEY
WITH NON-UNIQUE KEY BUKRS VRFCTON,
"自社ロ・
G_TBL_ENQ_KEY_G_OK  TYPE SORTED TABLE OF TYP_T_ENQ_KEY
WITH NON-UNIQUE KEY BUKRS VRFCTON.
"外部ロ・


*照合取消データ取得用テーブル 外部
TYPES:BEGIN OF TYP_YN10,
GJAHR   LIKE YN110-GJAHR,   "外部会計年度
SLPDOC  LIKE YN110-SLPDOC,  "外部番号
DTLDOC  LIKE YN110-DTLDOC,  "外部明細番号
VRFCTON LIKE YN110-VRFCTON, "得意先コード
BUKRS   LIKE YN110-BUKRS,   "会社コード
END OF TYP_YN10.

*照合取消データ取得用内部テーブル 外部
DATA: T_CANCEL_10 TYPE STANDARD TABLE OF TYP_YN10 WITH HEADER LINE.

*照合取消データ取得用テーブル YN210 YN220
TYPES:BEGIN OF TYP_YN20,
GJAHR   LIKE YN120-GJAHR,   "伝票会計年度
SLPDOC  LIKE YN120-SLPDOC,  "伝票番号
DTLDOC  LIKE YN120-DTLDOC,  "伝票明細番号
VRFCTON LIKE YN120-VRFCTON, "仕入先コード
BUKRS   LIKE YN120-BUKRS,   "会社コード
END OF TYP_YN20.

*照合取消データ取得用テーブル YN210 YN220
DATA: T_CANCEL_20 TYPE STANDARD TABLE OF TYP_YN20 WITH HEADER LINE.

*-- 20090113 INS STA
TYPES : BEGIN OF TYP_XXA1,
VRFCTON LIKE YN110-VRFCTON,
NAME1   LIKE KNA1-NAME1,
END OF TYP_XXA1.
*-- 取引先マスタ名称一括取得用内部テーブル
DATA : T_VRFCTON TYPE SORTED TABLE OF TYP_XXA1 WITH NON-UNIQUE KEY
VRFCTON.
DATA : T_XXA1 TYPE HASHED TABLE OF TYP_XXA1 WITH UNIQUE KEY VRFCTON.
DATA : W_XXA1 TYPE TYP_XXA1.

TYPES : BEGIN OF TYP_CEPCT,
PRCTR LIKE CEPCT-PRCTR,
KTEXT LIKE CEPCT-KTEXT,
END OF TYP_CEPCT.
*-- 利益センタマスタ名称一括取得用内部テーブル
DATA : T_PRCTR TYPE SORTED TABLE OF TYP_CEPCT WITH NON-UNIQUE KEY PRCTR.
DATA : T_CEPCT TYPE STANDARD TABLE OF TYP_CEPCT WITH NON-UNIQUE KEY
PRCTR.
DATA : W_CEPCT TYPE TYP_CEPCT.
*-- 20090113 INS END

TYPES: TYP_T_DD03P TYPE STANDARD TABLE OF DD03P.

* エレメント内部テーブル
DATA: T_DD03P_YN110 TYPE TYP_T_DD03P,
T_DD03P_YN120 TYPE TYP_T_DD03P,
T_DD03P_YN210 TYPE TYP_T_DD03P,
T_DD03P_YN220 TYPE TYP_T_DD03P.

DATA: OK_CODE LIKE SY-UCOMM,
RC_CODE LIKE SY-SUBRC,
COUNTER LIKE SY-DBCNT,
*-- 20090113 INS STA ポップアップ表示用
COUNTER_10 LIKE SY-DBCNT,
COUNTER_20 LIKE SY-DBCNT,
*-- 20090113 INS END
YNTEXT LIKE SY-TITLE.

DATA: REFRESH_FLAG TYPE C,
OUTPUT_FLAG TYPE C,
INPUT_MODE TYPE C,
RETURN_MODE TYPE C.

DATA: P_MODE TYPE C.

*&照合取消 2009/01/21 ADD-S 　
DATA: G_BUKRS  TYPE YN110-BUKRS,
G_CHKDOC TYPE YN110-CHKDOC,
G_VRFCTON TYPE YN110-VRFCTON,
G_CHKDAT TYPE YN110-CHKDAT,
G_CANCEL_NUMBER_10 LIKE SY-DBCNT VALUE 0,
G_CANCEL_NUMBER_20 LIKE SY-DBCNT VALUE 0.
*&照合取消 2009/01/21 ADD-E

* elematec 対応 2011/12/07 ADD >>>
*----- 名称取得用
TYPES: BEGIN OF TYP_WERKS_NAME,
WERKS     TYPE WERKS_D,        "プラント
NAME1     TYPE NAME1,          "プラント名
END   OF TYP_WERKS_NAME.
TYPES: BEGIN OF TYP_PERNR_NAME,
PERNR     TYPE CHAR12,         "担当者
NAME_TEXT TYPE AD_NAMTEXT,     "完全な個人名
END   OF TYP_PERNR_NAME.

DATA: W_WERKS_NAME   TYPE TYP_WERKS_NAME,
T_WERKS_NAME   TYPE SORTED TABLE OF TYP_WERKS_NAME
WITH NON-UNIQUE KEY WERKS,
W_PERNR_NAME   TYPE TYP_PERNR_NAME,
T_PERNR_NAME   TYPE SORTED TABLE OF TYP_PERNR_NAME
WITH NON-UNIQUE KEY PERNR.
*----- 外部データ追加用の会社コード
DATA: G_BUKRS_INPUT  TYPE BUKRS.
*----- LFM1取得用
TYPES: BEGIN OF TYP_LFM1,
LIFNR   TYPE LIFNR,            "仕入先
EKORG   TYPE EKORG,            "購買組織
ZTERM   TYPE DZTERM,           "支払条件
WAERS   TYPE WAERS,            "通貨コード
END   OF TYP_LFM1.
DATA:  T_LFM1         TYPE SORTED TABLE OF TYP_LFM1
WITH NON-UNIQUE KEY LIFNR EKORG.
*----- LFM1取得用
TYPES: BEGIN OF TYP_WYT3,
LIFNR   TYPE LIFNR,            "仕入先
EKORG   TYPE EKORG,            "購買組織
LIFN2   TYPE LIFN2,            "取引先機能
END   OF TYP_WYT3.
DATA:  T_WYT3         TYPE SORTED TABLE OF TYP_WYT3
WITH NON-UNIQUE KEY LIFNR EKORG.

*----- A044(税コード)取得用
TYPES: BEGIN OF TYP_MWSKZ,
LIFNR   TYPE LIFNR,            "仕入先
MWSKZ   TYPE MWSKZ,            "税コード
END   OF TYP_MWSKZ.
DATA:  T_MWSKZ        TYPE SORTED TABLE OF TYP_MWSKZ
WITH NON-UNIQUE KEY LIFNR.
*----- 外部データの金額内部換算処理用
TYPES:BEGIN OF TYP_CHANGE_CURRENT,
ROW_ID    TYPE I,              "行番号
FIELD     TYPE CHAR50,         "項目名
AMOUNT(8) TYPE P DECIMALS 2,   "内部換算値
END   OF TYP_CHANGE_CURRENT.
*DATA: T_CHANGE_CURRENT TYPE STANDARD TABLE OF TYP_CHANGE_CURRENT.
*----- 照合件数カウント
DATA: G_COUNT_10 LIKE SY-DBCNT,   "外部件数
G_COUNT_20 LIKE SY-DBCNT.   "自社件数
*----- 外部データ登録時の必須チェック用
TYPES:BEGIN OF TYP_YN230,
LIFNR      TYPE LIFNR,      "受注先
VRFCTON    TYPE YNLIFNR,    "請求先
BUKRS      TYPE BUKRS,      "会社コード
WAERS      TYPE WAERS,      "通貨コード
OUTEXITDOC TYPE YNOUTEXITDOC, "外部データEXIT番号
END   OF TYP_YN230.
DATA: T_YN230  TYPE STANDARD TABLE OF TYP_YN230.
*----- 受注先選択画面入力値前ゼロ埋めデータRANGEテーブル
DATA:GR_LIFNR   TYPE RANGE OF YNLIST21.
* elematec 対応 2011/12/07 ADD <<<

* elematec 対応 2011/12/22 ADD >>>
* 部分照合用
DATA:G_POINT_CHECK_NOTINPUT  TYPE CHAR01.     "部分照合差額入力不可
* BDC用
TYPES:TYP_BDCDATA TYPE STANDARD TABLE OF BDCDATA.
* 処理結果画面用
TYPES:BEGIN OF TYP_POINT_COMPARE,
BUKRS       TYPE BUKRS,
VRFCTON     TYPE YNLIFNR,
BELNR       TYPE YNBELNR,
END   OF TYP_POINT_COMPARE.
DATA: GT_POINT_COMPARE    TYPE STANDARD TABLE OF TYP_POINT_COMPARE.
DATA: GT_CHANGE_CELL TYPE STANDARD TABLE OF LVC_S_MODI.
* elematec 対応 2011/12/22 ADD <<<

*&---------------------------------------------------------------------*
*&   画面項目定義
*&---------------------------------------------------------------------*
SELECTION-SCREEN BEGIN OF BLOCK BK1 WITH FRAME TITLE TEXT-001.
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS: P_SALES TYPE C RADIOBUTTON GROUP KBN
DEFAULT 'X'  USER-COMMAND CHMOD.
SELECTION-SCREEN COMMENT 4(18) TEXT-002.                " 売上照合
PARAMETERS: P_PRCHS TYPE C RADIOBUTTON GROUP KBN.
SELECTION-SCREEN COMMENT 26(18) TEXT-003.               " 仕入照合
*照会のみのチェックボックスを追加
*
SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK BK1.

* elematec 対応 2011/12/07 ADD >>>
SELECTION-SCREEN BEGIN OF BLOCK BK6 WITH FRAME TITLE TEXT-014.
PARAMETERS P_CZFBDT TYPE YN210-CZFBDT OBLIGATORY.
SELECTION-SCREEN END OF BLOCK BK6.
* elematec 対応 2011/12/07 ADD <<<

*INCLUDE YN01_YN010400_0000.
INCLUDE YN01_YN010400_0000_20120113.

* 処理オプション
SELECTION-SCREEN BEGIN OF BLOCK BK4 WITH FRAME TITLE TEXT-006.
PARAMETERS P_PG TYPE C AS CHECKBOX.
SELECTION-SCREEN BEGIN OF BLOCK BK5 WITH FRAME TITLE TEXT-007.
* elematec 対応 2011/12/07 ADD >>>
*SELECT-OPTIONS P_CPUDT FOR YN110-UPDDAT
SELECT-OPTIONS P_CPUDT FOR YN110-UPDDAT
NO-EXTENSION
NO INTERVALS.
SELECT-OPTIONS P_DVSON3 FOR YN210-DVSON
NO INTERVALS
MODIF ID 020.
SELECT-OPTIONS P_LIST23 FOR YN210-LIST2 MODIF ID 020.
SELECT-OPTIONS P_LIST33 FOR YN120-LIST3 MODIF ID 020.
* elematec 対応 2011/12/07 ADD <<<
*&Ver2 対応 2007/02/28 >>> 支払基準日更新のデフォルトチェックをはずす
PARAMETERS P_OVWRT TYPE C AS CHECKBOX. "DEFAULT 'X'.
*&Ver2 対応 2007/02/28 <<<
SELECTION-SCREEN END OF BLOCK BK5.
SELECTION-SCREEN END OF BLOCK BK4.

* elematec 対応 2011/12/07 ADD >>>
*仕入照合システム項目
SELECTION-SCREEN BEGIN OF BLOCK BK7 WITH FRAME TITLE TEXT-009.
PARAMETERS P_EKORG TYPE LFM1-EKORG OBLIGATORY.     "購買組織
PARAMETERS P_PARVW TYPE TPAR-PARVW OBLIGATORY.     "取引先機能
PARAMETERS P_KAPPL TYPE A044-KAPPL OBLIGATORY.     "アプリケーション
PARAMETERS P_KSCHL TYPE A044-KSCHL OBLIGATORY.     "条件
SELECTION-SCREEN END OF BLOCK BK7.

*売上照合システム項目
SELECTION-SCREEN BEGIN OF BLOCK BK8 WITH FRAME TITLE TEXT-010.
PARAMETERS P_VKORG TYPE KNVV-VKORG OBLIGATORY.     "販売組織
PARAMETERS P_VTWEG TYPE KNVV-VTWEG OBLIGATORY.     "流通チャネル
PARAMETERS P_SPART TYPE KNVV-SPART OBLIGATORY.     "製品部門
SELECTION-SCREEN END OF BLOCK BK8.
* elematec 対応 2011/12/07 ADD <<<

* elematec 対応 2011/12/22 ADD >>>
* 部分照合用項目
SELECTION-SCREEN BEGIN OF BLOCK BK9 WITH FRAME TITLE TEXT-015.
PARAMETERS P_NOTP TYPE C AS CHECKBOX.    "自社データなし部分照合不可
PARAMETERS P_BLART  TYPE BKPF-BLART OBLIGATORY.     "伝票タイプ
PARAMETERS P_BSCHLS TYPE TBSL-BSCHL OBLIGATORY.     "転記キー(借方)
PARAMETERS P_BSCHLH TYPE TBSL-BSCHL OBLIGATORY.     "転記キー(貸方)
SELECTION-SCREEN END OF BLOCK BK9.

* elematec 対応 2011/12/22 ADD <<<

*INCLUDE YN01_YN010200.

*INCLUDE YN01_YN010400_0001.
INCLUDE YN01_YN010400_0001_20120113.
*INCLUDE YN01_YN010400_0100.
INCLUDE YN01_YN010400_0100_20120113.
*INCLUDE YN01_YN010400_0200.
INCLUDE YN01_YN010400_0200_20120113.
INCLUDE ZN090100.
* elematec 対応 2011/12/07 ADD >>>
*INCLUDE ZN090100.
TYPE-POOLS:SSCR.
* elematec 対応 2011/12/07 ADD <<<

*&---------------------------------------------------------------------*
*&   Event LOAD-Of-PROGRAM
*&---------------------------------------------------------------------*
LOAD-Of-PROGRAM.

*  PERFORM SET_SPECIAL_CHAR USING    9
*                           CHANGING C_TAB.
* 出力項目定義取得
PERFORM GET_TABLE_FIELDS.

*&---------------------------------------------------------------------*
*&   Event INITIALIZATION
*&---------------------------------------------------------------------*
INITIALIZATION.

* ロック解除
* elematec 対応 2011/12/07 ADD >>>
*  PERFORM UNLOCK_YN110.
*  PERFORM UNLOCK_YN210.
*  PERFORM UNLOCK_YN120.
*  PERFORM UNLOCK_YN220.
PERFORM TABLE_UNLOCK_901.
* elematec 対応 2011/12/07 ADD <<<

* elematec 対応 2011/12/07 ADD >>>
*---選択画面の複数入力ボタン制御
PERFORM BUTTON_CONTROL.
*---デフォルト値設定
PERFORM INIT_OUT.
* elematec 対応 2011/12/07 ADD <<<

*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN OUTPUT
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN OUTPUT.

IF P_SALES = 'X'.
P_MODE = C_MODE_SALES.
ELSEIF P_PRCHS = 'X'.
P_MODE = C_MODE_PURCHASE.
ENDIF.
PERFORM SET_DYNPRO_TEXT.

*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN.

OK_CODE = SY-UCOMM.
CASE OK_CODE.
WHEN 'CHMOD'.
WHEN OTHERS.
PERFORM CHECK_INPUT_DATA.
ENDCASE.

*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN ON VALUE-REQUEST
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_VRFCT1-LOW.
PERFORM F4_INPUT USING 'P_VRFCT1-LOW'.

*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN ON VALUE-REQUEST
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_VRFCT1-HIGH.
PERFORM F4_INPUT USING 'P_VRFCT1-HIGH'.

*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN ON VALUE-REQUEST
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_VRFCT2-LOW.
PERFORM F4_INPUT USING 'P_VRFCT2-LOW'.

*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN ON VALUE-REQUEST
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_VRFCT2-HIGH.
PERFORM F4_INPUT USING 'P_VRFCT2-HIGH'.

* elematec 対応 2011/12/07 ADD >>>
*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN ON VALUE-REQUEST
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_DVSON1-LOW.
PERFORM F4_INPUT USING 'P_DVSON1-LOW'.
*&---------------------------------------------------------------------*
*&   Event AT SELECTION-SCREEN ON VALUE-REQUEST
*&---------------------------------------------------------------------*
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_DVSON2-LOW.
PERFORM F4_INPUT USING 'P_DVSON2-LOW'.
* elematec 対応 2011/12/07 ADD <<<

*&---------------------------------------------------------------------*
*&   Event START-OF-SELECTION
*&---------------------------------------------------------------------*
START-OF-SELECTION.

** 自社データ取込
*  IF P_PG = C_ON.
*    PERFORM YN010200_MAIN.
*    IF G_ERR_FLG = 'X'.
*      EXIT.
*    ENDIF.
*  ENDIF.
* 照合データ検索
PERFORM GET_COMPARISON_DATA.
IF RC_CODE <> 0.
EXIT.
ENDIF.
*-- 20090113 MOV STA 対象データのみロック対象とするように変更
* ロック処理とマスタ名称取得処理
PERFORM LOCK_TABLES.
IF RC_CODE <> 0.
EXIT.
ENDIF.
*-- 20090113 MOV END
* ALV一覧設定
PERFORM SET_T_GRID_DATA_0100.
IF RC_CODE <> 0.
EXIT.
ENDIF.

*&---------------------------------------------------------------------*
*&   Event END-OF-SELECTION
*&---------------------------------------------------------------------*
END-OF-SELECTION.

*  IF P_PG = C_ON AND G_ERR_FLG = 'X'.
*    EXIT.
*  ENDIF.
DESCRIBE TABLE T_GRID_DATA_0100 LINES COUNTER.
IF COUNTER = 0.
*   対象データなし
MESSAGE I762.
ELSE.
*   ALV一覧表示
REFRESH_FLAG = C_ON.
CALL SCREEN 100.
IF RETURN_MODE = C_RETURN_MODE_COMPARE.
OUTPUT_FLAG = '2'.
PERFORM OUTPUT_LOG.
ENDIF.
ENDIF.

*&---------------------------------------------------------------------*
*&      Form  GET_COMPARISON_DATA
*&---------------------------------------------------------------------*
*       照合データ検索
*----------------------------------------------------------------------*
FORM GET_COMPARISON_DATA .

* elematec 対応 2011/12/07 ADD >>>
* 入力の受注先に前ゼロを埋める
PERFORM CHANGE_ZYUTYU.
* elematec 対応 2011/12/07 ADD <<<

PERFORM GET_YN_10_DATA.
CHECK RC_CODE = 0.
PERFORM GET_YN_20_DATA.
*-- 20090113 INS STA 件数により処理を続行するかのポップアップを表示
CHECK RC_CODE = 0.
IF COUNTER > C_CONTINUE_COUNT.
PERFORM POPUP_TO_CONFIRM USING C_MSGNO_CONFIRM_CONTINUE
C_DEFAULT_TWO.
ENDIF.
CHECK RC_CODE = 0.
*-- 20090113 INS END

* elematec 対応 2011/12/07 ADD >>>
* 照合マスタを取得
PERFORM GET_YN230.
* elematec 対応 2011/12/07 ADD <<<

ENDFORM.                    " GET_COMPARISON_DATA
*&---------------------------------------------------------------------*
*&      Form  SET_T_GRID_DATA_0100
*&---------------------------------------------------------------------*
*       ALV一覧設定
*----------------------------------------------------------------------*
FORM SET_T_GRID_DATA_0100 .

DATA: L_H_GRID_DATA LIKE LINE OF T_GRID_DATA_0100.
DATA: L_H_YN_10_DATA LIKE LINE OF T_YN_10_DATA,
L_H_YN_20_DATA LIKE LINE OF T_YN_20_DATA.

REFRESH T_GRID_DATA_0100.
LOOP AT T_YN_10_DATA INTO L_H_YN_10_DATA.

CLEAR L_H_GRID_DATA.

MOVE-CORRESPONDING L_H_YN_10_DATA TO L_H_GRID_DATA.
L_H_GRID_DATA-YNGJAHR1 = L_H_YN_10_DATA-YNGJAHR.
L_H_GRID_DATA-YNSLPDOC1 = L_H_YN_10_DATA-YNSLPDOC.
L_H_GRID_DATA-YNDTLDOC1 = L_H_YN_10_DATA-YNDTLDOC.
L_H_GRID_DATA-YNGJAHR = ' '.

PERFORM GET_VRFCTON_NAME USING    L_H_GRID_DATA-YNVRFCTON
CHANGING L_H_GRID_DATA-YNVRFCTONNAME.
* elematec 対応 2011/12/07 DEL >>>
*    IF RC_CODE <> 0.
*      CASE P_MODE.
*        WHEN C_MODE_SALES.
*          MESSAGE I752 WITH L_H_GRID_DATA-YNVRFCTON.
*        WHEN C_MODE_PURCHASE.
*          MESSAGE I753 WITH L_H_GRID_DATA-YNVRFCTON.
*      ENDCASE.
*      EXIT.
*    ENDIF.
* elematec 対応 2011/12/07 DEL >>>

L_H_GRID_DATA-YNKUBUN = C_KUBUN_EXTERNAL.
PERFORM GET_DOMAIN_VALUE USING    L_H_GRID_DATA-YNKUBUN
C_DOMAIN_NAME_KUBUN
CHANGING L_H_GRID_DATA-YNKUBUNTXT.
IF RC_CODE <> 0.
MESSAGE I754 WITH TEXT-111.
EXIT.
ENDIF.

IF NOT L_H_GRID_DATA-YNPRCTR IS INITIAL.
PERFORM GET_PRCTR_NAME USING    L_H_GRID_DATA-YNPRCTR
CHANGING L_H_GRID_DATA-YNPRCTRNAME.
* elematec 対応 2011/12/07 DEL >>>
*      IF RC_CODE <> 0.
*        MESSAGE I761 WITH L_H_GRID_DATA-YNPRCTR.
*        EXIT.
*      ENDIF.
* elematec 対応 2011/12/07 DEL >>>
ENDIF.

PERFORM GET_DOMAIN_VALUE USING    L_H_GRID_DATA-YNCSTS
C_DOMAIN_NAME_CSTS
CHANGING L_H_GRID_DATA-YNCSTSTXT.
IF RC_CODE <> 0.
MESSAGE I754 WITH TEXT-112.
EXIT.
ENDIF.

L_H_GRID_DATA-YNKNTAXAMT1 = 0.
L_H_GRID_DATA-YNKNTAXAMT2 = L_H_GRID_DATA-YNKNTAXAMT * ( -1 ).
L_H_GRID_DATA-YNKNTAXAMT3 =
L_H_GRID_DATA-YNKNTAXAMT1 + L_H_GRID_DATA-YNKNTAXAMT2.

L_H_GRID_DATA-YNKNITXAMT1 = 0.
L_H_GRID_DATA-YNKNITXAMT2 = L_H_GRID_DATA-YNKNITXAMT * ( -1 ).
L_H_GRID_DATA-YNKNITXAMT3 =
L_H_GRID_DATA-YNKNITXAMT1 + L_H_GRID_DATA-YNKNITXAMT2.

L_H_GRID_DATA-YNKNETXAMT1 = 0.
L_H_GRID_DATA-YNKNETXAMT2 = L_H_GRID_DATA-YNKNETXAMT * ( -1 ).
L_H_GRID_DATA-YNKNETXAMT3 =
L_H_GRID_DATA-YNKNETXAMT1 + L_H_GRID_DATA-YNKNETXAMT2.

* elematec 対応 2011/12/22 ADD >>>
L_H_GRID_DATA-YNKNETXAMT5 = L_H_GRID_DATA-YNKNETXAMT3.
* elematec 対応 2011/12/22 ADD <<<

* elematec 対応 2011/12/07 ADD >>>
*   プラント名称取得
IF NOT L_H_GRID_DATA-YNDVSON IS INITIAL.
PERFORM GET_WERKS_NAME    USING L_H_GRID_DATA-YNDVSON
CHANGING L_H_GRID_DATA-YNDVSONNAME.
ENDIF.
*   担当者名称取得
IF NOT L_H_GRID_DATA-YNPERNR IS INITIAL.
PERFORM GET_YNPERNR_NAME    USING L_H_GRID_DATA-YNPERNR
CHANGING L_H_GRID_DATA-YNPERNRNAME.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

APPEND L_H_GRID_DATA TO T_GRID_DATA_0100.

ENDLOOP.

CHECK RC_CODE = 0.

LOOP AT T_YN_20_DATA INTO L_H_YN_20_DATA.

CLEAR L_H_GRID_DATA.

MOVE-CORRESPONDING L_H_YN_20_DATA TO L_H_GRID_DATA.
L_H_GRID_DATA-YNGJAHR2 = L_H_YN_20_DATA-YNGJAHR.
L_H_GRID_DATA-YNSLPDOC2 = L_H_YN_20_DATA-YNSLPDOC.
L_H_GRID_DATA-YNDTLDOC2 = L_H_YN_20_DATA-YNDTLDOC.
L_H_GRID_DATA-YNGJAHR = L_H_YN_20_DATA-YNGJAHR_B.

PERFORM GET_VRFCTON_NAME USING    L_H_GRID_DATA-YNVRFCTON
CHANGING L_H_GRID_DATA-YNVRFCTONNAME.
* elematec 対応 2011/12/07 DEL >>>
*    IF RC_CODE <> 0.
*      CASE P_MODE.
*        WHEN C_MODE_SALES.
*          MESSAGE I752 WITH L_H_GRID_DATA-YNVRFCTON.
*        WHEN C_MODE_PURCHASE.
*          MESSAGE I753 WITH L_H_GRID_DATA-YNVRFCTON.
*      ENDCASE.
*      EXIT.
*    ENDIF.
* elematec 対応 2011/12/07 DEL <<<

L_H_GRID_DATA-YNKUBUN = C_KUBUN_INTERNAL.
PERFORM GET_DOMAIN_VALUE USING    L_H_GRID_DATA-YNKUBUN
'YNCHAR2'
CHANGING L_H_GRID_DATA-YNKUBUNTXT.
IF RC_CODE <> 0.
MESSAGE I754 WITH TEXT-111.
EXIT.
ENDIF.

IF NOT L_H_GRID_DATA-YNPRCTR IS INITIAL.
PERFORM GET_PRCTR_NAME USING    L_H_GRID_DATA-YNPRCTR
CHANGING L_H_GRID_DATA-YNPRCTRNAME.
* elematec 対応 2011/12/07 DEL >>>
*      IF RC_CODE <> 0.
*        MESSAGE I761 WITH L_H_GRID_DATA-YNPRCTR.
*        EXIT.
*      ENDIF.
* elematec 対応 2011/12/07 DEL <<<
ENDIF.

PERFORM GET_DOMAIN_VALUE USING    L_H_GRID_DATA-YNCSTS
'YNCHAR1'
CHANGING L_H_GRID_DATA-YNCSTSTXT.
IF RC_CODE <> 0.
MESSAGE I754 WITH TEXT-112.
EXIT.
ENDIF.

L_H_GRID_DATA-YNKNTAXAMT1 = L_H_GRID_DATA-YNKNTAXAMT.
L_H_GRID_DATA-YNKNTAXAMT2 = 0.
L_H_GRID_DATA-YNKNTAXAMT3 =
L_H_GRID_DATA-YNKNTAXAMT1 + L_H_GRID_DATA-YNKNTAXAMT2.

L_H_GRID_DATA-YNKNITXAMT1 = L_H_GRID_DATA-YNKNITXAMT.
L_H_GRID_DATA-YNKNITXAMT2 = 0.
L_H_GRID_DATA-YNKNITXAMT3 =
L_H_GRID_DATA-YNKNITXAMT1 + L_H_GRID_DATA-YNKNITXAMT2.

L_H_GRID_DATA-YNKNETXAMT1 = L_H_GRID_DATA-YNKNETXAMT.
L_H_GRID_DATA-YNKNETXAMT2 = 0.
L_H_GRID_DATA-YNKNETXAMT3 =
L_H_GRID_DATA-YNKNETXAMT1 + L_H_GRID_DATA-YNKNETXAMT2.

* elematec 対応 2011/12/22 ADD >>>
L_H_GRID_DATA-YNKNETXAMT5 = L_H_GRID_DATA-YNKNETXAMT3.
* elematec 対応 2011/12/22 ADD <<<


* elematec 対応 2011/12/07 ADD >>>
*   プラント名称取得
IF NOT L_H_GRID_DATA-YNDVSON IS INITIAL.
PERFORM GET_WERKS_NAME    USING L_H_GRID_DATA-YNDVSON
CHANGING L_H_GRID_DATA-YNDVSONNAME.
ENDIF.
*   担当者名称取得
IF NOT L_H_GRID_DATA-YNPERNR IS INITIAL.
PERFORM GET_YNPERNR_NAME    USING L_H_GRID_DATA-YNPERNR
CHANGING L_H_GRID_DATA-YNPERNRNAME.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

APPEND L_H_GRID_DATA TO T_GRID_DATA_0100.

ENDLOOP.

SORT T_GRID_DATA_0100 BY YNBUKRS   YNVRFCTON YNKUBUN DESCENDING
YNSLPDOC1 YNDTLDOC1 YNSLPDOC2 YNDTLDOC2.

ENDFORM.                    " SET_T_GRID_DATA_0100
*&---------------------------------------------------------------------*
*&      Form  GET_TABLE_FIELDS
*&---------------------------------------------------------------------*
*       項目テキスト取得
*----------------------------------------------------------------------*
FORM GET_TABLE_FIELDS .

PERFORM GET_DDIF_TABL TABLES T_DD03P_YN110
USING  'YN110'.
PERFORM GET_DDIF_TABL TABLES T_DD03P_YN120
USING  'YN120'.
PERFORM GET_DDIF_TABL TABLES T_DD03P_YN210
USING  'YN210'.
PERFORM GET_DDIF_TABL TABLES T_DD03P_YN220
USING  'YN220'.

ENDFORM.                    " GET_TABLE_FIELDS
*&---------------------------------------------------------------------*
*&      Form  GET_DDIF_TBL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_DD03P  text
*      -->P_TABNAME   text
*----------------------------------------------------------------------*
FORM GET_DDIF_TABL  TABLES   P_T_DD03P STRUCTURE DD03P
USING    P_TABNAME.

DATA: L_NAME TYPE DDOBJNAME.

REFRESH P_T_DD03P.
L_NAME = P_TABNAME.
CALL FUNCTION 'DDIF_TABL_GET'
EXPORTING
NAME          = L_NAME
LANGU         = SY-LANGU
TABLES
DD03P_TAB     = P_T_DD03P
EXCEPTIONS
ILLEGAL_INPUT = 1
OTHERS        = 2.

IF SY-SUBRC <> 0.
MESSAGE E754 WITH P_TABNAME.
ENDIF.

ENDFORM.                    " GET_DDIF_TBL
*&---------------------------------------------------------------------*
*&      Form  SET_FIELD_NAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_FCAT_0100  text
*----------------------------------------------------------------------*
FORM SET_FIELD_NAME  TABLES   P_T_FCAT TYPE LVC_T_FCAT.

DATA: BEGIN OF L_LINE,
TEXT(80),
END OF L_LINE.
DATA: L_T_SRC LIKE STANDARD TABLE OF L_LINE.
DATA: L_SNAME TYPE STRING,
L_FNAME TYPE STRING.
DATA: L_REPID LIKE SY-REPID,
L_KEY_BEGIN TYPE STRING,
L_KEY_END TYPE STRING.
DATA: L_INDEX_BEGIN LIKE SY-TABIX,
L_INDEX_END LIKE SY-TABIX.

FIELD-SYMBOLS: <FS_COL_ID> TYPE I.

L_SNAME = 'TYP_GRID_DATA'.
CONCATENATE 'BEGIN OF TYP_GRID_DATA_' SY-DYNNR INTO L_KEY_BEGIN.
CONCATENATE 'END OF TYP_GRID_DATA_' SY-DYNNR INTO L_KEY_END.

REFRESH P_T_FCAT.
CONCATENATE 'YN01' SY-REPID SY-DYNNR INTO L_REPID SEPARATED BY '_'.
READ REPORT L_REPID INTO L_T_SRC.
LOOP AT L_T_SRC INTO L_LINE.
IF L_LINE CS L_KEY_BEGIN.
L_INDEX_BEGIN = SY-TABIX.
CONTINUE.
ENDIF.
CLEAR P_T_FCAT.
IF L_INDEX_BEGIN > 0.
CONDENSE L_LINE.
IF L_LINE CS 'TYPE' OR L_LINE CS 'LIKE'.
P_T_FCAT-FIELDNAME = L_LINE(SY-FDPOS).
CONDENSE P_T_FCAT-FIELDNAME.
IF P_T_FCAT-FIELDNAME CS '('.
P_T_FCAT-FIELDNAME = P_T_FCAT-FIELDNAME(SY-FDPOS).
ENDIF.
L_FNAME = P_T_FCAT-FIELDNAME+2.
CONCATENATE 'C_ALV_COL' SY-DYNNR+1(1) '_' L_FNAME
INTO L_FNAME.
ASSIGN (L_FNAME) TO <FS_COL_ID>.
IF <FS_COL_ID> <> 9999.
P_T_FCAT-COL_ID = <FS_COL_ID>.
APPEND P_T_FCAT.
ENDIF.
ENDIF.
ENDIF.
IF L_LINE CS L_KEY_END.
SORT P_T_FCAT BY COL_ID.
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    " SET_FIELD_NAME
*&---------------------------------------------------------------------*
*&      Form  SET_FIELD_PROPS_1
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_FCAT_0100  text
*----------------------------------------------------------------------*
FORM SET_FIELD_PROPS_1 TABLES P_T_FCAT  TYPE LVC_T_FCAT
P_T_GRID_DATA
P_T_ALV_CUSTOMIZER TYPE TYP_T_ALV_CUSTOMIZER
.

DATA: L_HELP_ID(20) TYPE C,
L_TNAME TYPE DFIES-TABNAME,
L_FNAME TYPE DFIES-FIELDNAME.
DATA: L_H_DD03P TYPE DD03P,
L_S_DD04V TYPE DD04V.
DATA: L_LEN TYPE I,
L_TYP TYPE C.

FIELD-SYMBOLS: <FS>.
FIELD-SYMBOLS: <FS_FCAT> LIKE LINE OF P_T_FCAT.
FIELD-SYMBOLS: <FS_T_DD03P> TYPE TYP_T_DD03P.

LOOP AT P_T_FCAT ASSIGNING <FS_FCAT>.
L_FNAME = <FS_FCAT>-FIELDNAME.
IF <FS_FCAT>-FIELDNAME CS '_C'.
L_FNAME = <FS_FCAT>-FIELDNAME(SY-FDPOS).
ENDIF.
ASSIGN COMPONENT L_FNAME OF STRUCTURE P_T_GRID_DATA TO <FS>.
DESCRIBE FIELD <FS> HELP-ID L_HELP_ID.
IF NOT L_HELP_ID IS INITIAL.
IF L_HELP_ID CS '-'.
*     表示テキスト設定(テーブル定義から)
SPLIT L_HELP_ID AT '-' INTO L_TNAME L_FNAME.
CONCATENATE 'T_DD03P_YN' P_MODE L_TNAME+3 INTO L_TNAME.
ASSIGN (L_TNAME) TO <FS_T_DD03P>.
READ TABLE <FS_T_DD03P> INTO L_H_DD03P
WITH KEY FIELDNAME = L_FNAME.
IF SY-SUBRC = 0.
<FS_FCAT>-DATATYPE   = L_H_DD03P-DATATYPE.
<FS_FCAT>-INTTYPE    = L_H_DD03P-INTTYPE.
<FS_FCAT>-IFIELDNAME = L_H_DD03P-FIELDNAME.
<FS_FCAT>-ROLLNAME   = L_H_DD03P-ROLLNAME.
<FS_FCAT>-OUTPUTLEN  = L_H_DD03P-OUTPUTLEN.
<FS_FCAT>-DD_OUTLEN  = L_H_DD03P-LENG.
<FS_FCAT>-DECIMALS   = L_H_DD03P-DECIMALS.
<FS_FCAT>-DOMNAME    = L_H_DD03P-DOMNAME.
<FS_FCAT>-CONVEXIT   = L_H_DD03P-CONVEXIT.
<FS_FCAT>-COLTEXT    = L_H_DD03P-DDTEXT.
<FS_FCAT>-SCRTEXT_S  = L_H_DD03P-SCRTEXT_S.
<FS_FCAT>-SCRTEXT_M  = L_H_DD03P-SCRTEXT_M.
<FS_FCAT>-SCRTEXT_L  = L_H_DD03P-SCRTEXT_L.
* elematec 対応 2011/12/07 ADD >>>
IF <FS_FCAT>-FIELDNAME = 'YNLDATE1'.
<FS_FCAT>-COLTEXT   = TEXT-T01.
<FS_FCAT>-SCRTEXT_S = TEXT-T01.
<FS_FCAT>-SCRTEXT_M = TEXT-T01.
<FS_FCAT>-SCRTEXT_L = TEXT-T01.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<
ENDIF.
ELSE.
*     表示テキスト設定(データエレメントから)
PERFORM GET_DDIF_DTEL USING    L_HELP_ID
CHANGING L_S_DD04V.
<FS_FCAT>-DATATYPE  = L_S_DD04V-DATATYPE.
<FS_FCAT>-COLTEXT   = L_S_DD04V-DDTEXT.
<FS_FCAT>-SCRTEXT_S = L_S_DD04V-SCRTEXT_S.
<FS_FCAT>-SCRTEXT_M = L_S_DD04V-SCRTEXT_M.
<FS_FCAT>-SCRTEXT_L = L_S_DD04V-SCRTEXT_L.
ENDIF.
ELSE.
*     表示テキスト設定(特殊処理：取引先名称)
IF <FS_FCAT>-FIELDNAME CS 'NAME'.
L_FNAME = <FS_FCAT>-FIELDNAME(SY-FDPOS).
READ TABLE P_T_FCAT WITH KEY FIELDNAME = L_FNAME.
IF SY-SUBRC = 0.
CONCATENATE P_T_FCAT-ROLLNAME 'NAME' INTO L_FNAME.
PERFORM GET_DDIF_DTEL USING    L_FNAME
CHANGING L_S_DD04V.
<FS_FCAT>-COLTEXT   = L_S_DD04V-DDTEXT.
<FS_FCAT>-SCRTEXT_S = L_S_DD04V-SCRTEXT_S.
<FS_FCAT>-SCRTEXT_M = L_S_DD04V-SCRTEXT_M.
<FS_FCAT>-SCRTEXT_L = L_S_DD04V-SCRTEXT_L.
ENDIF.
ELSEIF <FS_FCAT>-FIELDNAME = 'YNCHKBOX'.
<FS_FCAT>-COLTEXT   = C_TAB.
<FS_FCAT>-SCRTEXT_S = C_TAB.
<FS_FCAT>-SCRTEXT_M = C_TAB.
<FS_FCAT>-SCRTEXT_L = C_TAB.
ENDIF.
ENDIF.
*   長さ設定
DESCRIBE FIELD <FS> TYPE L_TYP.
*&Ver2 対応 2007/02/28 >>> 外部データ入力の明細コピーボタンの追加
IF L_TYP CO 'CN' .
*   IF L_TYP CO 'CNP' .
*&Ver2 対応 2007/02/28 <<<
IF <FS> CP '* #'.
ENDIF.
<FS_FCAT>-INTLEN = SY-FDPOS.
ENDIF.
ENDLOOP.

ENDFORM.                    " SET_FIELD_PROPS_1
*&---------------------------------------------------------------------*
*&      Form  SET_FIELD_PROPS_3
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_FCAT  text
*----------------------------------------------------------------------*
FORM SET_FIELD_PROPS_3 TABLES P_T_FCAT  TYPE LVC_T_FCAT
P_T_GRID_DATA
P_T_ALV_CUSTOMIZER TYPE TYP_T_ALV_CUSTOMIZER
P_T_F4 STRUCTURE LVC_S_F4
.

DATA: L_HELP_ID(20) TYPE C,
L_TNAME TYPE DFIES-TABNAME,
L_FNAME TYPE DFIES-FIELDNAME,
L_INDEX LIKE SY-INDEX.
DATA: L_H_DD03P TYPE DD03P,
L_H_F4 TYPE LVC_S_F4,
L_S_DD04V TYPE DD04V.

FIELD-SYMBOLS: <FS>.
FIELD-SYMBOLS: <FS_FCAT> LIKE LINE OF P_T_FCAT.
FIELD-SYMBOLS: <FS_T_DD03P> TYPE TYP_T_DD03P.

REFRESH P_T_F4.
LOOP AT P_T_FCAT ASSIGNING <FS_FCAT>.
L_INDEX = SY-TABIX - 1.
L_FNAME = <FS_FCAT>-FIELDNAME.
IF <FS_FCAT>-FIELDNAME CS '_C'.
L_FNAME = <FS_FCAT>-FIELDNAME(SY-FDPOS).
ENDIF.
ASSIGN COMPONENT L_FNAME OF STRUCTURE P_T_GRID_DATA TO <FS>.
DESCRIBE FIELD <FS> HELP-ID L_HELP_ID.
IF NOT L_HELP_ID IS INITIAL.
SPLIT L_HELP_ID AT '-' INTO L_TNAME L_FNAME.
*     検索ヘルプ設定
READ TABLE P_T_ALV_CUSTOMIZER WITH KEY NAME = 'F4_REF'.
IF SY-SUBRC = 0.
CASE P_T_ALV_CUSTOMIZER-PROPS+L_INDEX(1).
WHEN 'X'.
CONCATENATE 'YN' P_MODE L_TNAME+3 INTO L_TNAME.
<FS_FCAT>-REF_TABLE = L_TNAME.
<FS_FCAT>-REF_FIELD = L_FNAME.
WHEN 'A'.
<FS_FCAT>-F4AVAILABL = 'X'.
CLEAR L_H_F4.
L_H_F4-FIELDNAME = <FS_FCAT>-FIELDNAME.
L_H_F4-REGISTER = 'X'.
L_H_F4-CHNGEAFTER = 'X'.
APPEND L_H_F4 TO P_T_F4.
ENDCASE.
ENDIF.
ENDIF.
ENDLOOP.

ENDFORM.                    " SET_FIELD_PROPS_3
*&---------------------------------------------------------------------*
*&      Form  SET_T_GRID_DATA_0200
*&---------------------------------------------------------------------*
*       照合ALV一覧から入力画面にコピーする
*----------------------------------------------------------------------*
FORM SET_T_GRID_DATA_0200 .

DATA: L_H_GRID_DATA_0100 LIKE LINE OF T_GRID_DATA_0100,
L_H_GRID_DATA_0200 LIKE LINE OF T_GRID_DATA_0200.

REFRESH T_GRID_DATA_0200.
LOOP AT T_GRID_DATA_0100 INTO L_H_GRID_DATA_0100
WHERE YNCHKBOX = 'X'.

CLEAR L_H_GRID_DATA_0200.
MOVE-CORRESPONDING L_H_GRID_DATA_0100 TO L_H_GRID_DATA_0200.

*   会計年度設定
CLEAR L_H_GRID_DATA_0200-YNGJAHR.
CASE L_H_GRID_DATA_0100-YNKUBUN.
WHEN C_KUBUN_EXTERNAL.
L_H_GRID_DATA_0200-YNGJAHR = L_H_GRID_DATA_0100-YNGJAHR1.
WHEN C_KUBUN_INTERNAL.
L_H_GRID_DATA_0200-YNGJAHR = L_H_GRID_DATA_0100-YNGJAHR2.
ENDCASE.

*   表示用項目設定
IF NOT L_H_GRID_DATA_0200-YNGJAHR IS INITIAL.
L_H_GRID_DATA_0200-YNGJAHR = L_H_GRID_DATA_0200-YNGJAHR.
ENDIF.
IF NOT L_H_GRID_DATA_0200-YNZFBDT IS INITIAL.
L_H_GRID_DATA_0200-YNZFBDT = L_H_GRID_DATA_0200-YNZFBDT.
ENDIF.

*   元伝票番号設定
IF INPUT_MODE = C_INPUT_MODE_EDIT.
L_H_GRID_DATA_0200-YNOLDGJAHR = L_H_GRID_DATA_0100-YNGJAHR1.
L_H_GRID_DATA_0200-YNOLDSLPDOC = L_H_GRID_DATA_0100-YNSLPDOC1.
L_H_GRID_DATA_0200-YNOLDDTLDOC = L_H_GRID_DATA_0100-YNDTLDOC1.
ELSE.
CLEAR: L_H_GRID_DATA_0200-YNOLDGJAHR,
L_H_GRID_DATA_0200-YNOLDSLPDOC,
L_H_GRID_DATA_0200-YNOLDDTLDOC.
ENDIF.

L_H_GRID_DATA_0200-YNCOLORS[] = T_COLOR_0200[].
APPEND L_H_GRID_DATA_0200 TO T_GRID_DATA_0200.

ENDLOOP.

* 空白行追加
IF L_H_GRID_DATA_0100 IS INITIAL.
CLEAR L_H_GRID_DATA_0200.
L_H_GRID_DATA_0200-YNCOLORS[] = T_COLOR_0200[].
* elematec 対応 2011/12/07 ADD >>>
PERFORM INSERT_DATA_INIT_LINE CHANGING L_H_GRID_DATA_0200.
* elematec 対応 2011/12/07 ADD <<<
APPEND L_H_GRID_DATA_0200 TO T_GRID_DATA_0200.
ENDIF.

ENDFORM.                    " SET_T_GRID_DATA_0200
*&---------------------------------------------------------------------*
*&      Form  CHANGE_T_GRID_DATA
*&---------------------------------------------------------------------*
*       照合ALV一覧データ追加
*----------------------------------------------------------------------*
FORM CHANGE_T_GRID_DATA .

DATA: L_H_GRID_DATA_0100 LIKE LINE OF T_GRID_DATA_0100,
L_H_GRID_DATA_0200 LIKE LINE OF T_GRID_DATA_0200.
DATA: L_SLPDOC LIKE L_H_GRID_DATA_0100-YNSLPDOC1,
L_DTLDOC LIKE L_H_GRID_DATA_0100-YNDTLDOC1.
DATA: L_DATE(10) TYPE C,
L_NUMBER(21) TYPE C,
L_DECIMAL TYPE I.

CLEAR RC_CODE.
LOOP AT T_GRID_DATA_0200 INTO L_H_GRID_DATA_0200.

CHECK NOT L_H_GRID_DATA_0200 IS INITIAL.

CLEAR L_H_GRID_DATA_0100.

*   外部番号採番
AT NEW YNGJAHR.
CLEAR COUNTER.
PERFORM GET_NEXT_SLPDOC USING    L_H_GRID_DATA_0200-YNBUKRS
L_H_GRID_DATA_0200-YNGJAHR
CHANGING L_SLPDOC.
IF L_SLPDOC IS INITIAL.
RC_CODE = C_RC_CODE_DB_ERROR.
ROLLBACK WORK.
MESSAGE I782.
EXIT.
ENDIF.
ENDAT.
COUNTER = COUNTER + 1.
L_DTLDOC = COUNTER.

PERFORM INSERT_YN_10 USING L_H_GRID_DATA_0200
L_SLPDOC
L_DTLDOC.
IF RC_CODE <> 0.
EXIT.
ENDIF.

MOVE-CORRESPONDING L_H_GRID_DATA_0200 TO L_H_GRID_DATA_0100.
L_H_GRID_DATA_0100-YNGJAHR1 = L_H_GRID_DATA_0200-YNGJAHR.
L_H_GRID_DATA_0100-YNGJAHR = ' '.
L_H_GRID_DATA_0100-YNSLPDOC1 = L_SLPDOC.
L_H_GRID_DATA_0100-YNDTLDOC1 = L_DTLDOC.

L_H_GRID_DATA_0100-YNKUBUN = C_KUBUN_EXTERNAL.
PERFORM GET_DOMAIN_VALUE USING    L_H_GRID_DATA_0100-YNKUBUN
C_DOMAIN_NAME_KUBUN
CHANGING L_H_GRID_DATA_0100-YNKUBUNTXT.

L_H_GRID_DATA_0100-YNCSTS = C_CSTS_INIT.
PERFORM GET_DOMAIN_VALUE USING    L_H_GRID_DATA_0100-YNCSTS
C_DOMAIN_NAME_CSTS
CHANGING L_H_GRID_DATA_0100-YNCSTSTXT.

L_H_GRID_DATA_0100-YNKNTAXAMT1 = 0.
L_H_GRID_DATA_0100-YNKNTAXAMT2 =
L_H_GRID_DATA_0100-YNKNTAXAMT * ( -1 ).
L_H_GRID_DATA_0100-YNKNTAXAMT3 =
L_H_GRID_DATA_0100-YNKNTAXAMT1 + L_H_GRID_DATA_0100-YNKNTAXAMT2.

L_H_GRID_DATA_0100-YNKNITXAMT1 = 0.
L_H_GRID_DATA_0100-YNKNITXAMT2 =
L_H_GRID_DATA_0100-YNKNITXAMT * ( -1 ).
L_H_GRID_DATA_0100-YNKNITXAMT3 =
L_H_GRID_DATA_0100-YNKNITXAMT1 + L_H_GRID_DATA_0100-YNKNITXAMT2.

L_H_GRID_DATA_0100-YNKNETXAMT1 = 0.
L_H_GRID_DATA_0100-YNKNETXAMT2 =
L_H_GRID_DATA_0100-YNKNETXAMT * ( -1 ).
L_H_GRID_DATA_0100-YNKNETXAMT3 =
L_H_GRID_DATA_0100-YNKNETXAMT1 + L_H_GRID_DATA_0100-YNKNETXAMT2.

L_H_GRID_DATA_0100-YNUPDDAT = YN110-UPDDAT.
L_H_GRID_DATA_0100-YNUPDTIM = YN110-UPDTIM.
L_H_GRID_DATA_0100-YNUPDUSR = YN110-UPDUSR.
L_H_GRID_DATA_0100-YNUPDPRG = YN110-UPDPRG.

L_H_GRID_DATA_0100-YNCOLORS[] = T_COLOR_0100[].
* elematec 対応 2011/12/07 ADD >>>
L_H_GRID_DATA_0100-YNINSDT  = YN110-INSDT.
L_H_GRID_DATA_0100-YNLDATE1 = YN110-LDATE1.
L_H_GRID_DATA_0100-YNCZFBDT = YN110-CZFBDT.
* elematec 対応 2011/12/07 ADD <<<
* elematec 対応 2011/12/22 ADD >>>
L_H_GRID_DATA_0100-YNKNETXAMT5 = L_H_GRID_DATA_0100-YNKNETXAMT3.
* elematec 対応 2011/12/22 ADD <<<
APPEND L_H_GRID_DATA_0100 TO T_GRID_DATA_0100.

ENDLOOP.

CHECK  RC_CODE = 0.
COMMIT WORK AND WAIT.
SORT T_GRID_DATA_0100 BY YNBUKRS   YNVRFCTON YNKUBUN DESCENDING
YNSLPDOC1 YNDTLDOC1 YNSLPDOC2 YNDTLDOC2.

ENDFORM.                    " CHANGE_T_GRID_DATA
*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT_DATA_0200
*&---------------------------------------------------------------------*
*       外部データ入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT_DATA_0200.

DATA: LH_GRID_DATA LIKE LINE OF T_ALV_CHECKER_0200.
DATA: L_ROW_ID TYPE I.
DATA: L_TNAME TYPE STRING,
L_FUNC_NAME(30) TYPE C.
DATA: L_DATE(10) TYPE C.

* elematec 対応 2011/12/07 ADD >>>
DATA:L_EXIT_TYPE TYPE YNOUTEXITDOC,  " EXIT番号
L_ERR_FLG   TYPE XFELD,         "エラーフラグ('X'->エラー)
L_ENQ_KEY   TYPE TYP_LOCK,      "ロック用
L_LIFNR     TYPE CHAR10.        " 受注先前ゼロ埋め用
* elematec 対応 2011/12/07 ADD <<<

CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
CONCATENATE 'LOCK_' L_TNAME INTO L_FUNC_NAME.

CLEAR: RC_CODE, L_ROW_ID.
DATA: LS_LOG_DATA LIKE LINE OF T_LOG_DATA.

REFRESH T_LOG_DATA.
LOOP AT T_ALV_CHECKER_0200 INTO LH_GRID_DATA.

* elematec 対応 2011/12/07 ADD >>>
* 行追加ボタン＋エラー時の行指定修正
L_ROW_ID = LH_GRID_DATA-ROW_ID.
*    L_ROW_ID = LH_GRID_DATA-LINNO.
* elematec 対応 2011/12/07 ADD <<<

*   空白ラインチェック
CHECK NOT LH_GRID_DATA IS INITIAL.

* elematec 対応 2011/12/07 ADD >>>
CLEAR:L_ERR_FLG.
*---①受注先が必須
IF LH_GRID_DATA-YNLIST1 = SPACE.
PERFORM SET_T_LOG_DATA USING 'YNLIST1'
L_ROW_ID
'785'
'TEXT'
SPACE.
CONTINUE.      "以降のチェックはなし
ELSE.
*     受注先のEXIT番号をYN230より取得
PERFORM LIST1_CHECK_TYPE USING LH_GRID_DATA-YNLIST1
CHANGING L_EXIT_TYPE.
ENDIF.

*---②受注伝票/ｲﾝﾎﾞｲｽNO/受注伝票+ｲﾝﾎﾞｲｽNO必須入力チェック
CASE L_EXIT_TYPE.
*     受注伝票必須
WHEN '2001'.
IF LH_GRID_DATA-YNLIST2 = SPACE.
PERFORM SET_T_LOG_DATA USING 'YNLIST2'
L_ROW_ID
'785'
'TEXT'
SPACE.
CONTINUE.      "以降のチェックはなし
ENDIF.
*     ｲﾝﾎﾞｲｽNO必須
WHEN '2002'.
IF LH_GRID_DATA-YNLIST8 = SPACE.
PERFORM SET_T_LOG_DATA USING 'YNLIST8'
L_ROW_ID
'785'
'TEXT'
SPACE.
CONTINUE.      "以降のチェックはなし
ENDIF.
*     受注伝票＋ｲﾝﾎﾞｲｽNO必須
WHEN '2003'.
IF LH_GRID_DATA-YNLIST2 = SPACE.
PERFORM SET_T_LOG_DATA USING 'YNLIST2'
L_ROW_ID
'785'
'TEXT'
SPACE.
L_ERR_FLG = C_ON.
ENDIF.
IF LH_GRID_DATA-YNLIST8 = SPACE.
PERFORM SET_T_LOG_DATA USING 'YNLIST8'
L_ROW_ID
'785'
'TEXT'
SPACE.
L_ERR_FLG = C_ON.
ENDIF.
IF L_ERR_FLG = C_ON.
CONTINUE.      "以降のチェックはなし
ENDIF.
WHEN OTHERS.
ENDCASE.
*    ELSE.

*--- ③発注番号/ｲﾝﾎﾞｲｽNOなどの必須項目が入力されている場合
*   受注伝票番号の存在チェック
IF  LH_GRID_DATA-YNLIST2 <> SPACE.
PERFORM CHECK_EBELN     USING LH_GRID_DATA-YNLIST2
CHANGING L_ERR_FLG.
IF L_ERR_FLG = C_ON.
PERFORM SET_T_LOG_DATA USING 'YNLIST2'
L_ROW_ID
'907'
'VALUE'
SPACE.
ENDIF.
ENDIF.
*   請求日の必須チェック
IF LH_GRID_DATA-YNLDATE1 IS INITIAL
OR LH_GRID_DATA-YNLDATE1 = SPACE.
PERFORM SET_T_LOG_DATA USING 'YNLDATE1'
L_ROW_ID
'785'
'TEXT'
SPACE.
ENDIF.
*   プラントの必須チェック
IF LH_GRID_DATA-YNDVSON IS INITIAL.
PERFORM SET_T_LOG_DATA USING 'YNDVSON'
L_ROW_ID
'785'
'TEXT'
SPACE.
ENDIF.
***   年度必須チェック
**    IF LH_GRID_DATA-YNGJAHR IS INITIAL.
***     IF P_MODE = C_MODE_PURCHASE. "20061031 HATTORI DEL
**      PERFORM SET_T_LOG_DATA USING 'YNGJAHR'
**                                   L_ROW_ID
**                                   '785'
**                                   'TEXT'
**                                   SPACE.
***     ENDIF.  "20061031 HATTORI DEL
***   年度妥当性チェック
**    ELSE.
**      CONCATENATE LH_GRID_DATA-YNGJAHR '0101' INTO L_DATE.
**      PERFORM CHECK_DATE USING L_DATE.
**      IF RC_CODE <> 0.
**        PERFORM SET_T_LOG_DATA USING 'YNGJAHR'
**                                     L_ROW_ID
**                                     '788'
**                                     SPACE
**                                     SPACE.
**      ENDIF.
**    ENDIF.
***   取引先コード必須チェック
**    IF LH_GRID_DATA-YNVRFCTON IS INITIAL.
**      PERFORM SET_T_LOG_DATA USING 'YNVRFCTON'
**                                   L_ROW_ID
**                                   '785'
**                                   'TEXT'
**                                   SPACE.
**    ENDIF.
***   会社コード必須チェック
**    IF LH_GRID_DATA-YNBUKRS IS INITIAL.
**      PERFORM SET_T_LOG_DATA USING 'YNBUKRS'
**                                   L_ROW_ID
**                                   '785'
**                                   'TEXT'
**                                   SPACE.
**    ENDIF.
**
***   通貨コード必須チェック
**    IF LH_GRID_DATA-YNWAERS IS INITIAL.
**      PERFORM SET_T_LOG_DATA USING 'YNWAERS'
**                                   L_ROW_ID
**                                   '785'
**                                   'TEXT'
**                                   SPACE.
**    ENDIF.
* elematec 対応 2011/12/07 DEL <<<

*   日付妥当性チェック
IF NOT LH_GRID_DATA-YNZFBDT IS INITIAL.
PERFORM CHECK_DATE USING    LH_GRID_DATA-YNZFBDT.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNZFBDT'
L_ROW_ID
'786'
SPACE
SPACE.
ENDIF.
ENDIF.

*   数量妥当性チェック
IF NOT LH_GRID_DATA-YNKNQUAN IS INITIAL.
PERFORM CHECK_NUMBER USING    LH_GRID_DATA-YNKNQUAN.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNQUAN'
L_ROW_ID
'787'
SPACE
SPACE.
ELSE.
PERFORM CHECK_OVERFLOW USING  'YNKNQUAN'
LH_GRID_DATA-YNKNQUAN.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNQUAN'
L_ROW_ID
'799'
SPACE
SPACE.
ENDIF.
ENDIF.
ENDIF.

*   単価妥当性チェック
IF NOT LH_GRID_DATA-YNKNUNTPRC IS INITIAL.
PERFORM CHECK_NUMBER USING    LH_GRID_DATA-YNKNUNTPRC.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNUNTPRC'
L_ROW_ID
'787'
SPACE
SPACE.
ELSE.
PERFORM CHECK_OVERFLOW USING  'YNKNUNTPRC'
LH_GRID_DATA-YNKNUNTPRC.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNUNTPRC'
L_ROW_ID
'799'
SPACE
SPACE.
ENDIF.
ENDIF.
ENDIF.

*   消費税額妥当性チェック
IF NOT LH_GRID_DATA-YNKNTAXAMT IS INITIAL.
PERFORM CHECK_NUMBER USING    LH_GRID_DATA-YNKNTAXAMT.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNTAXAMT'
L_ROW_ID
'787'
SPACE
SPACE.
ELSE.
PERFORM CHECK_OVERFLOW USING  'YNKNTAXAMT'
LH_GRID_DATA-YNKNTAXAMT.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNTAXAMT'
L_ROW_ID
'799'
SPACE
SPACE.
ENDIF.
ENDIF.
ENDIF.

*   税抜金額妥当性チェック
IF NOT LH_GRID_DATA-YNKNITXAMT IS INITIAL.
PERFORM CHECK_NUMBER USING    LH_GRID_DATA-YNKNITXAMT.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNITXAMT'
L_ROW_ID
'787'
SPACE
SPACE.
ELSE.
PERFORM CHECK_OVERFLOW USING  'YNKNITXAMT'
LH_GRID_DATA-YNKNITXAMT.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNKNITXAMT'
L_ROW_ID
'799'
SPACE
SPACE.
ENDIF.
ENDIF.
ENDIF.

* elematec 対応 2011/12/07 DEL >>>
***   税込金額妥当性チェック
**    IF NOT LH_GRID_DATA-YNKNETXAMT IS INITIAL.
**      PERFORM CHECK_NUMBER USING    LH_GRID_DATA-YNKNETXAMT.
**      IF RC_CODE <> 0.
**        PERFORM SET_T_LOG_DATA USING 'YNKNETXAMT'
**                                     L_ROW_ID
**                                     '787'
**                                     SPACE
**                                     SPACE.
**      ELSE.
**        PERFORM CHECK_OVERFLOW USING  'YNKNETXAMT'
**                                      LH_GRID_DATA-YNKNETXAMT.
**        IF RC_CODE <> 0.
**          PERFORM SET_T_LOG_DATA USING 'YNKNETXAMT'
**                                       L_ROW_ID
**                                       '799'
**                                       SPACE
**                                       SPACE.
**        ENDIF.
**      ENDIF.
**    ENDIF.
**
***   会社コード存在チェック
**    IF NOT LH_GRID_DATA-YNBUKRS IS INITIAL.
**      PERFORM CHECK_BUKRS USING LH_GRID_DATA-YNBUKRS.
**      IF RC_CODE <> 0.
**        PERFORM SET_T_LOG_DATA USING 'YNBUKRS'
**                                     L_ROW_ID
**                                     '750'
**                                     'VALUE'
**                                     SPACE.
**      ELSE.
***       権限チェック
**        PERFORM CHECK_AUTHORITY USING   LH_GRID_DATA-YNBUKRS.
**        IF RC_CODE <> 0.
**          PERFORM SET_T_LOG_DATA USING 'YNBUKRS'
**                                       L_ROW_ID
**                                       '751'
**                                       'VALUE'
**                                       SPACE.
**        ENDIF.
**      ENDIF.
**    ENDIF.
**
* elematec 対応 2011/12/07 DEL <<<

*   取引先コード存在チェック
IF NOT LH_GRID_DATA-YNVRFCTON IS INITIAL.
PERFORM CHECK_VRFCTON USING    LH_GRID_DATA-YNVRFCTON.
IF RC_CODE <> 0.
IF P_MODE = C_MODE_SALES.
PERFORM SET_T_LOG_DATA USING 'YNVRFCTON'
L_ROW_ID
'752'
'VALUE'
SPACE.
ELSE.
PERFORM SET_T_LOG_DATA USING 'YNVRFCTON'
L_ROW_ID
'753'
'VALUE'
SPACE.
ENDIF.
ELSE.
*       取引先コードと会社コード関連チェック
IF NOT LH_GRID_DATA-YNBUKRS IS INITIAL.
PERFORM CHECK_VRFCTON_BY_BUKRS USING LH_GRID_DATA-YNVRFCTON
LH_GRID_DATA-YNBUKRS.
IF RC_CODE <> 0.
IF P_MODE = C_MODE_SALES.
PERFORM SET_T_LOG_DATA USING 'YNVRFCTON'
L_ROW_ID
'752'
'VALUE'
SPACE.
ELSE.
PERFORM SET_T_LOG_DATA USING 'YNVRFCTON'
L_ROW_ID
'753'
'VALUE'
SPACE.
ENDIF.
*         ロック
ELSE.
* elematec 対応 2011/12/07 DEL >>>
*            PERFORM (L_FUNC_NAME) IN PROGRAM YN010400
*              USING LH_GRID_DATA-YNBUKRS
*                    LH_GRID_DATA-YNVRFCTON.
*            IF RC_CODE <> 0.
*              PERFORM SET_T_LOG_DATA USING 'YNVRFCTON'
*                                           L_ROW_ID
*                                           '756'
*                                           L_TNAME
*                                           YNTEXT.
*            ENDIF.
* elematec 対応 2011/12/07 DEL <<<
ENDIF.
ENDIF.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
ENDIF.

*   [仕入照合]受注先のチェック
IF P_MODE = C_MODE_PURCHASE
AND LH_GRID_DATA-YNLIST1 <> SPACE.
*     入力された受注先の前ゼロを埋める
CLEAR:L_LIFNR.
L_LIFNR = LH_GRID_DATA-YNLIST1+0(10).
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = L_LIFNR
IMPORTING
OUTPUT = L_LIFNR.
*     選択画面入力の仕入先かどうかチェック
PERFORM CHECK_VRFCTON_IN USING L_LIFNR.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNLIST1'
L_ROW_ID
'908'
'VALUE'
SPACE.
ELSE.
*       正常の場合はロック
IF LH_GRID_DATA-YNBUKRS   IS INITIAL  "会社コード
OR L_LIFNR                IS INITIAL  "受注先
OR LH_GRID_DATA-YNDVSON   IS INITIAL. "プラント
ELSE.
CLEAR:TAB_LOCK, L_ENQ_KEY.
L_ENQ_KEY-BUKRS = LH_GRID_DATA-YNBUKRS.
L_ENQ_KEY-LIFNR = L_LIFNR.
L_ENQ_KEY-WERKS = LH_GRID_DATA-YNDVSON.
APPEND L_ENQ_KEY TO TAB_LOCK.
*         レコードロック
PERFORM TABLE_LOCK_901.
IF  RC_CODE_LOCK <> 0.
YNTEXT = SY-MSGV1.
PERFORM SET_T_LOG_DATA USING 'YNLIST1'
L_ROW_ID
'756'
L_TNAME
YNTEXT.
ENDIF.
ENDIF.
ENDIF.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

*   利益センター存在チェック
IF NOT LH_GRID_DATA-YNPRCTR IS INITIAL.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = LH_GRID_DATA-YNPRCTR
IMPORTING
OUTPUT = LH_GRID_DATA-YNPRCTR.
PERFORM CHECK_PRCTR USING    LH_GRID_DATA-YNPRCTR.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNPRCTR'
L_ROW_ID
'761'
'VALUE'
SPACE.
ELSE.
*       利益センターと会社コード関連チェック
IF NOT LH_GRID_DATA-YNBUKRS IS INITIAL.
PERFORM CHECK_PRCTR_BY_BUKRS USING    LH_GRID_DATA-YNPRCTR
LH_GRID_DATA-YNBUKRS.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNPRCTR'
L_ROW_ID
'761'
'VALUE'
SPACE.
ENDIF.
ENDIF.
ENDIF.
ENDIF.

*   通貨コード存在チェック
IF NOT LH_GRID_DATA-YNWAERS IS INITIAL.
PERFORM CHECK_WAERS USING LH_GRID_DATA-YNWAERS.
IF RC_CODE <> 0.
PERFORM SET_T_LOG_DATA USING 'YNWAERS'
L_ROW_ID
'776'
'VALUE'
SPACE.
ENDIF.
ENDIF.
ENDLOOP.


* elematec 対応 2011/12/07 DEL >>>
* 行追加ボタン＋エラー時の行指定修正
*  SORT T_LOG_DATA BY ROW_ID COL_ID.
* elematec 対応 2011/12/07 DEL <<<
PERFORM SET_SELECTED_CELL_0200  USING    1.
PERFORM REFRESH_ALV_GRID_LOG.

ENDFORM.                    " CHECK_INPUT_DATA_0200
*&---------------------------------------------------------------------*
*&      Form  CHECK_BUKRS
*&---------------------------------------------------------------------*
*       会社コード存在チェック
*----------------------------------------------------------------------*
*      -->P_BUKRS  会社コード
*----------------------------------------------------------------------*
FORM CHECK_BUKRS  USING    P_BUKRS.

CLEAR RC_CODE.
SELECT COUNT(*) INTO COUNTER FROM T001 WHERE BUKRS = P_BUKRS.
IF COUNTER = 0.
RC_CODE = C_RC_CODE_NOT_EXIST.
ENDIF.

ENDFORM.                    " CHECK_BUKRS
*&---------------------------------------------------------------------*
*&      Form  CHECK_PRCTR
*&---------------------------------------------------------------------*
*       利益センタ存在チェック
*----------------------------------------------------------------------*
*      -->P_PRCTR  利益センタ
*----------------------------------------------------------------------*
FORM CHECK_PRCTR  USING    P_PRCTR.

CLEAR RC_CODE.
SELECT COUNT(*) INTO COUNTER FROM CEPC WHERE PRCTR = P_PRCTR.
IF COUNTER = 0.
RC_CODE = C_RC_CODE_NOT_EXIST.
ENDIF.

ENDFORM.                    " CHECK_PRCTR
*&---------------------------------------------------------------------*
*&      Form  SET_DYNPRO_TEXT
*&---------------------------------------------------------------------*
*       選択画面テキスト動的に設定
*----------------------------------------------------------------------*
FORM SET_DYNPRO_TEXT .

DATA: L_HELP_ID(20) TYPE C,
L_SNAME TYPE STRING,
L_FNAME TYPE STRING,
L_SCR_NAME TYPE STRING,
L_TEXT TYPE STRING.

FIELD-SYMBOLS: <FS> TYPE ANY.

FIELD-SYMBOLS: <FS_T_DD03P> TYPE TYP_T_DD03P.
DATA: L_H_DD03P LIKE LINE OF <FS_T_DD03P>.

CHECK SY-DYNNR = '1000'.
LOOP AT SCREEN.
IF SCREEN-GROUP1 = '020' OR SCREEN-GROUP1 = '010'.
CASE SCREEN-GROUP3.
WHEN 'TXT'.
L_SCR_NAME = SCREEN-NAME.
WHEN 'LOW'.
ASSIGN (SCREEN-NAME) TO <FS>.
DESCRIBE FIELD <FS> HELP-ID L_HELP_ID.
SPLIT L_HELP_ID AT '-' INTO L_SNAME L_FNAME.
CONCATENATE 'T_DD03P_YN' P_MODE SCREEN-GROUP1+1(2)
INTO L_SNAME.
ASSIGN (L_SNAME) TO <FS_T_DD03P>.
READ TABLE <FS_T_DD03P> INTO L_H_DD03P
WITH KEY FIELDNAME = L_FNAME.
IF SY-SUBRC = 0.
ASSIGN (L_SCR_NAME) TO <FS>.
<FS> = L_H_DD03P-DDTEXT.
ELSE.
MESSAGE E764.
ENDIF.
ENDCASE.
ENDIF.
ENDLOOP.

ENDFORM.                    " SET_DYNPRO_TEXT
*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT_DATA_0100
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_INPUT_DATA_0100 .

CLEAR RC_CODE.
CASE OK_CODE.
WHEN C_USER_COMMAND_COMPARE.
PERFORM CHECK_COMPARE.
WHEN C_USER_COMMAND_SELECT_TARGET.
PERFORM CHECK_SELECT_TARGET.
WHEN C_USER_COMMAND_DESELECT_TARGET.
PERFORM CHECK_DESELECT_TARGET.
WHEN C_USER_COMMAND_INPUT_DATA.
WHEN C_USER_COMMAND_EDIT_DATA.
PERFORM CHECK_EDIT_DATA.
WHEN C_USER_COMMAND_DELETE_DATA.
PERFORM CHECK_DELETE_DATA.
WHEN C_USER_COMMAND_UPDATE_COMMENT.
*照合取消　2009/01/21 ADD-S
WHEN C_USER_COMMAND_CANCEL_DATA.
PERFORM CHECK_CANCEL_DATA.
*照合取消　2009/01/21 ADD-E
ENDCASE.

ENDFORM.                    " CHECK_INPUT_DATA_0100
*&---------------------------------------------------------------------*
*&      Form  SET_T_COMPARE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM SET_T_COMPARE .

DATA: L_H_GRID_DATA LIKE LINE OF T_GRID_DATA_0100.
DATA: LS_CHECKER LIKE LINE OF T_COMPARE_CHECKER.
DATA: LS_COMPARE TYPE TYP_COMPARE.
*-- 20090113 INS STA
DATA: LS_COMPARE_1 TYPE TYP_COMPARE.
DATA: LS_COMPARE_2 TYPE TYP_COMPARE.
*-- 20090113 INS END

CLEAR COUNTER.
* elematec 対応 2011/12/07 ADD >>>
CLEAR:G_COUNT_10, G_COUNT_20.
* elematec 対応 2011/12/07 ADD <<<
LOOP AT T_GRID_DATA_0100 INTO L_H_GRID_DATA
WHERE YNTGTFLG = 'X'
AND YNDELFLG = ' '
AND YNCSTS <> C_CSTS_OK_MANUAL
AND YNCSTS <> C_CSTS_OK_AUTO.
CLEAR: LS_COMPARE, LS_CHECKER,
LS_COMPARE_1, LS_COMPARE_2.
LS_COMPARE-YNBUKRS = L_H_GRID_DATA-YNBUKRS.
LS_COMPARE-YNVRFCTON = L_H_GRID_DATA-YNVRFCTON.
LS_COMPARE-YNWAERS = L_H_GRID_DATA-YNWAERS.
LS_COMPARE-YNKNITXAMT = L_H_GRID_DATA-YNKNITXAMT.
* elematec 対応 2011/12/22 ADD >>>
*    LS_COMPARE-YNKNETXAMT = L_H_GRID_DATA-YNKNETXAMT.
*   部分照合差額をプラスの値にして設定
IF L_H_GRID_DATA-YNKUBUN = C_KUBUN_INTERNAL.
LS_COMPARE-YNKNETXAMT = L_H_GRID_DATA-YNKNETXAMT5.
ELSE.
LS_COMPARE-YNKNETXAMT = L_H_GRID_DATA-YNKNETXAMT5 * -1.
ENDIF.
IF L_H_GRID_DATA-YNKNETXAMT4 <> 0.
LS_COMPARE-POINT_COMPARE = C_ON.
ENDIF.
* elematec 対応 2011/12/22 ADD <<<
LS_COMPARE-YNKNQUAN = L_H_GRID_DATA-YNKNQUAN.
IF L_H_GRID_DATA-YNKUBUN = C_KUBUN_EXTERNAL.
*-- 20090113 UPD STA
*      COLLECT LS_COMPARE INTO T_COMPARE_1.
READ TABLE T_COMPARE_1 INTO LS_COMPARE_1
WITH TABLE KEY
YNBUKRS   = LS_COMPARE-YNBUKRS
YNVRFCTON = LS_COMPARE-YNVRFCTON
YNCKEY1   = LS_COMPARE-YNCKEY1
YNCKEY2   = LS_COMPARE-YNCKEY2
YNCKEY3   = LS_COMPARE-YNCKEY3
YNCKEY4   = LS_COMPARE-YNCKEY4
YNCKEY5   = LS_COMPARE-YNCKEY5
YNCKEY6   = LS_COMPARE-YNCKEY6
YNCKEY7   = LS_COMPARE-YNCKEY7
YNCKEY8   = LS_COMPARE-YNCKEY8
YNWAERS   = LS_COMPARE-YNWAERS.
IF SY-SUBRC = 0.
DELETE TABLE T_COMPARE_1 FROM LS_COMPARE_1.
LS_COMPARE-YNKNITXAMT = LS_COMPARE-YNKNITXAMT
+ LS_COMPARE_1-YNKNITXAMT.
LS_COMPARE-YNKNETXAMT = LS_COMPARE-YNKNETXAMT
+ LS_COMPARE_1-YNKNETXAMT.
LS_COMPARE-YNKNQUAN = LS_COMPARE-YNKNQUAN
+ LS_COMPARE_1-YNKNQUAN.
* elematec 対応 2011/12/22 ADD >>>
LS_COMPARE-POINT_COMPARE = LS_COMPARE_1-POINT_COMPARE.
* elematec 対応 2011/12/22 ADD <<<
INSERT LS_COMPARE INTO TABLE T_COMPARE_1.
ELSE.
INSERT LS_COMPARE INTO TABLE T_COMPARE_1.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
*     メッセージ用件数
G_COUNT_10 = G_COUNT_10 + 1.
* elematec 対応 2011/12/07 ADD <<<


ELSEIF L_H_GRID_DATA-YNKUBUN = C_KUBUN_INTERNAL.
*      COLLECT LS_COMPARE INTO T_COMPARE_2.
READ TABLE T_COMPARE_2 INTO LS_COMPARE_2
WITH TABLE KEY
YNBUKRS   = LS_COMPARE-YNBUKRS
YNVRFCTON = LS_COMPARE-YNVRFCTON
YNCKEY1   = LS_COMPARE-YNCKEY1
YNCKEY2   = LS_COMPARE-YNCKEY2
YNCKEY3   = LS_COMPARE-YNCKEY3
YNCKEY4   = LS_COMPARE-YNCKEY4
YNCKEY5   = LS_COMPARE-YNCKEY5
YNCKEY6   = LS_COMPARE-YNCKEY6
YNCKEY7   = LS_COMPARE-YNCKEY7
YNCKEY8   = LS_COMPARE-YNCKEY8
YNWAERS   = LS_COMPARE-YNWAERS.
IF SY-SUBRC = 0.
DELETE TABLE T_COMPARE_2 FROM LS_COMPARE_2.
LS_COMPARE-YNKNITXAMT = LS_COMPARE-YNKNITXAMT
+ LS_COMPARE_2-YNKNITXAMT.
LS_COMPARE-YNKNETXAMT = LS_COMPARE-YNKNETXAMT
+ LS_COMPARE_2-YNKNETXAMT.
LS_COMPARE-YNKNQUAN = LS_COMPARE-YNKNQUAN
+ LS_COMPARE_2-YNKNQUAN.
* elematec 対応 2011/12/22 ADD >>>
LS_COMPARE-POINT_COMPARE = LS_COMPARE_2-POINT_COMPARE.
* elematec 対応 2011/12/22 ADD <<<
INSERT LS_COMPARE INTO TABLE T_COMPARE_2.
ELSE.
INSERT LS_COMPARE INTO TABLE T_COMPARE_2.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
*     メッセージ用件数
G_COUNT_20 = G_COUNT_20 + 1.
* elematec 対応 2011/12/07 ADD <<<
*-- 20090113 UPD END
ENDIF.
LS_CHECKER-BUKRS = L_H_GRID_DATA-YNBUKRS.
LS_CHECKER-VRFCTON = L_H_GRID_DATA-YNVRFCTON.
LS_CHECKER-WAERS = L_H_GRID_DATA-YNWAERS.
COLLECT LS_CHECKER INTO T_COMPARE_CHECKER.
LS_CHECKER-COUNT = 1.
MODIFY TABLE T_COMPARE_CHECKER FROM LS_CHECKER
TRANSPORTING COUNT.
ADD 1 TO COUNTER.
ENDLOOP.

ENDFORM.                    " SET_T_COMPARE
*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT_DATA
*&---------------------------------------------------------------------*
*       選択画面の入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT_DATA .

DATA: L_EVAL TYPE STRING.

* elematec 対応 2011/12/22 ADD >>>
DATA: LW_LINES   TYPE I.       "件数取得要
* elematec 対応 2011/12/22 ADD <<<

*-----自社データ

* 会社コード存在チェック
PERFORM CHECK_BUKRS_RANGE TABLES   P_BUKRS1
CHANGING L_EVAL.
IF RC_CODE <> 0.
MESSAGE E750 WITH L_EVAL.
ENDIF.
* 権限チェック
PERFORM CHECK_AUTHORITY_RANGE TABLES   P_BUKRS1
CHANGING L_EVAL.
IF RC_CODE = C_RC_CODE_NOT_EXIST.
MESSAGE E762.
ELSEIF RC_CODE = C_RC_CODE_NO_AUTHORITY.
MESSAGE E751 WITH L_EVAL.
ENDIF.
* 取引先コード存在チェック
* elematec 対応 2011/12/07 ADD >>>
PERFORM CHECK_VRFCTON_RANGE TABLES   P_LIST11     "受注先
CHANGING L_EVAL.
*  PERFORM CHECK_VRFCTON_RANGE TABLES   P_VRFCT1
*                              CHANGING L_EVAL.
* elematec 対応 2011/12/07 ADD <<<
IF RC_CODE <> 0.
IF P_MODE = C_MODE_SALES.
MESSAGE E752 WITH L_EVAL.
ELSE.
MESSAGE E753 WITH L_EVAL.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
ELSE.
*   自社データの受注先を外部データ受注先へコピー
P_LIST12[] = P_LIST11[].
* elematec 対応 2011/12/07 ADD <<<
ENDIF.
* 利益センタ存在チェック
PERFORM CHECK_PRCTR_RANGE TABLES   P_PRCTR1
CHANGING L_EVAL.
IF RC_CODE <> 0.
MESSAGE E761 WITH L_EVAL.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
* プラントの入力チェック
IF  P_DVSON1[] IS INITIAL.     "未入力の場合
IF SY-UCOMM+0(1) <> '%'.    "複数入力ボタン押下以外
IF P_MODE = C_MODE_SALES.  "[売上照合]
*        MESSAGE E901 WITH L_EVAL.
ELSE.                      "[仕入照合]
MESSAGE E901 WITH TEXT-051.
ENDIF.
ENDIF.
ELSE.
*   自社データのプラントを外部データのプラントへコピー
P_DVSON2[] = P_DVSON1[].
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

*-----外部データ

* 会社コード存在チェック
PERFORM CHECK_BUKRS_RANGE TABLES   P_BUKRS2
CHANGING L_EVAL.
IF RC_CODE <> 0.
MESSAGE E750 WITH L_EVAL.
ENDIF.
* 権限チェック
PERFORM CHECK_AUTHORITY_RANGE TABLES   P_BUKRS2
CHANGING L_EVAL.
IF RC_CODE = C_RC_CODE_NOT_EXIST.
MESSAGE E762.
ELSEIF RC_CODE = C_RC_CODE_NO_AUTHORITY.
MESSAGE E751 WITH L_EVAL.
ENDIF.
* 取引先コード存在チェック
* elematec 対応 2011/12/07 ADD >>>
PERFORM CHECK_VRFCTON_RANGE TABLES   P_LIST12    "受注先
CHANGING L_EVAL.
*  PERFORM CHECK_VRFCTON_RANGE TABLES   P_VRFCT2
*                              CHANGING L_EVAL.
* elematec 対応 2011/12/07 ADD <<<
IF RC_CODE <> 0.
IF P_MODE = C_MODE_SALES.
MESSAGE E752 WITH L_EVAL.
ELSE.
MESSAGE E753 WITH L_EVAL.
ENDIF.
ENDIF.
* 利益センタ存在チェック
PERFORM CHECK_PRCTR_RANGE TABLES   P_PRCTR2
CHANGING L_EVAL.
IF RC_CODE <> 0.
MESSAGE E761 WITH L_EVAL.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
* プラントの入力チェック
IF  P_DVSON1[] IS INITIAL     "未入力の場合
AND SY-UCOMM+0(1) <> '%'.    "複数入力ボタン押下以外
IF P_MODE = C_MODE_SALES.  "[売上照合]
*      MESSAGE E901 WITH L_EVAL.
ELSE.                      "[仕入照合]
MESSAGE E901 WITH TEXT-051.
ENDIF.
ENDIF.


*----自社データ取り込みのチェック
IF P_PG = C_ON.
PERFORM CHECK_P_PG  TABLES P_DVSON3
P_LIST23.
ENDIF.
*-----照合締日の入力値チェック
IF P_CZFBDT IS INITIAL
OR P_LIST11[] IS INITIAL.
ELSE.
PERFORM CHECK_CZFBDT TABLES P_LIST11
USING  P_CZFBDT.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<


* elematec 対応 2011/12/22 ADD >>>
* 受注先の件数チェック（複数の場合、フラグをON)
DESCRIBE TABLE P_LIST11 LINES LW_LINES.
IF LW_LINES > 1.
G_POINT_CHECK_NOTINPUT = C_ON.
ELSE.
G_POINT_CHECK_NOTINPUT = SPACE.
ENDIF.
* elematec 対応 2011/12/22 ADD <<<

ENDFORM.                    " CHECK_INPUT_DATA
*&---------------------------------------------------------------------*
*&      Form  CHECK_BUKRS_RANGE
*&---------------------------------------------------------------------*
*       会社コード存在チェック
*----------------------------------------------------------------------*
*      -->P_T_BUKRS  会社コード範囲
*----------------------------------------------------------------------*
FORM CHECK_BUKRS_RANGE  TABLES   P_T_BUKRS
CHANGING L_EVAL.

FIELD-SYMBOLS: <FS1>, <FS2>, <FS3>.

CLEAR: RC_CODE, L_EVAL.
LOOP AT P_T_BUKRS.
ASSIGN COMPONENT 1 OF STRUCTURE P_T_BUKRS TO <FS1>.
ASSIGN COMPONENT 2 OF STRUCTURE P_T_BUKRS TO <FS2>.
CHECK <FS1> = 'I' AND <FS2> = 'EQ'.
ASSIGN COMPONENT 3 OF STRUCTURE P_T_BUKRS TO <FS3>.
PERFORM CHECK_BUKRS  USING <FS3>.
IF RC_CODE <> 0.
L_EVAL = <FS3>.
EXIT.
ENDIF.
ENDLOOP.
* elematec 対応 2011/12/07 ADD >>>
*--- 外部データ追加時に使用する会社コードを退避
G_BUKRS_INPUT = <FS3>.
* elematec 対応 2011/12/07 ADD <<<

ENDFORM.                    " CHECK_BUKRS_RANGE
*&---------------------------------------------------------------------*
*&      Form  CHECK_PRCTR_RANGE
*&---------------------------------------------------------------------*
*       利益センタ存在チェック
*----------------------------------------------------------------------*
*      -->PT_PRCTR  利益センタ
*----------------------------------------------------------------------*
FORM CHECK_PRCTR_RANGE  TABLES   PT_PRCTR
CHANGING L_EVAL.

FIELD-SYMBOLS: <FS1>, <FS2>, <FS3>.

CLEAR: RC_CODE, L_EVAL.
LOOP AT PT_PRCTR.
ASSIGN COMPONENT 1 OF STRUCTURE PT_PRCTR TO <FS1>.
ASSIGN COMPONENT 2 OF STRUCTURE PT_PRCTR TO <FS2>.
CHECK <FS1> = 'I' AND <FS2> = 'EQ'.
ASSIGN COMPONENT 3 OF STRUCTURE PT_PRCTR TO <FS3>.
PERFORM CHECK_PRCTR  USING <FS3>.
IF RC_CODE <> 0.
L_EVAL = <FS3>.
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    " CHECK_PRCTR_RANGE
*&---------------------------------------------------------------------*
*&      Form  CHECK_WAERS
*&---------------------------------------------------------------------*
*       通貨コード存在チェック
*----------------------------------------------------------------------*
*      -->P_WAERS  通貨コード
*----------------------------------------------------------------------*
FORM CHECK_WAERS  USING   P_WAERS.

CLEAR RC_CODE.
SELECT COUNT(*) INTO COUNTER FROM TCURC WHERE WAERS = P_WAERS.
IF COUNTER = 0.
RC_CODE = C_RC_CODE_NOT_EXIST.
ENDIF.

ENDFORM.                    " CHECK_BUKRS_RANGE
*&---------------------------------------------------------------------*
*&      Form  GET_YN_10_DATA
*&---------------------------------------------------------------------*
*       外部データ検索
*----------------------------------------------------------------------*
FORM GET_YN_10_DATA .

DATA: L_TNAME(10) TYPE C.

CLEAR RC_CODE.
REFRESH T_YN_10_DATA.
CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
SELECT TGTFLG     " 照合対象フラグ
GJAHR      " 会計年度
SLPDOC     " 外部番号
DTLDOC     " 外部明細番号
VRFCTON    " 取引先コード
BUKRS      " 会社コード
ZFBDT      " 日付
PRCTR      " 利益センタ
PERNR      " 担当者
DVSON      " 部門
CSTS       " 照合ステータス
COMMT      " コメント
KNQUAN     " 数量
KNUNIT     " 単位
KNUNTPRC   " 単価
KNTAXAMT   " 消費税額
KNITXAMT   " 税抜金額
KNETXAMT   " 税込金額
WAERS      " 通貨コード
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
CHKDOC     " 照合番号
CHKDAT     " 照合日
CHKUSR     " 照合ユーザ
*&Ver2 対応 2007/02/28 <<<
UPDDAT     " 更新日
UPDTIM     " 更新時刻
UPDUSR     " 更新ユーザ
UPDPRG     " 更新プログラム
DELFLG     " 削除フラグ
OLDGJAHR   " 元会計年度
OLDSLPDOC  " 元外部番号
OLDDTLDOC  " 元外部明細番号
CKEY1      " 得意先発注番号
CKEY2      " 取引先品目コード
CKEY3                                              " 照合キー3
CKEY4                                              " 照合キー4
CKEY5                                              " 照合キー5
CKEY6                                              " 照合キー6
CKEY7                                              " 照合キー7
CKEY8                                              " 照合キー8
LIST1      " 自社品目コード
LIST2      " 品名
LIST3      " 受注先コード
LIST4      " 得意発注明細番号
LIST5      " 一覧表示項目5
LIST6      " 一覧表示項目6
LIST7      " 一覧表示項目7
LIST8      " 一覧表示項目8
LIST9      " 一覧表示項目9
LIST10     " 一覧表示項目10
* elematec 対応 2011/12/07 ADD >>>
INSDT      " 登録日
LDATE1     " 請求日/入庫日
CZFBDT     " 照合締日
* elematec 対応 2011/12/07 ADD <<<
INTO TABLE T_YN_10_DATA
FROM (L_TNAME)
WHERE GJAHR   IN P_GJAHR2
AND SLPDOC  IN P_SLPDO2
AND DTLDOC  IN P_DTLDO2
AND VRFCTON IN P_VRFCT2
AND BUKRS   IN P_BUKRS2
AND ZFBDT   IN P_ZFBDT2
AND PRCTR   IN P_PRCTR2
AND PERNR   IN P_PERNR2
AND DVSON   IN P_DVSON2
AND CSTS    IN P_CSTS2
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
*    AND UPDDAT  IN P_UPDAT2
*    AND UPDUSR  IN P_UPUSR2
AND COMMT   IN P_COMMT2
AND CHKDOC  IN P_CHDOC2
AND CHKDAT  IN P_CHDAT2
AND CHKUSR  IN P_CHUSR2
*&Ver2 対応 2007/02/28 <<<
AND DELFLG  IN P_DELFL2
* elematec 対応 2011/12/07 ADD >>>
AND LIST1   IN GR_LIFNR
AND LIST2   IN P_LIST22
AND LIST8   IN P_LIST82
AND LDATE1  IN P_LDAT12
* elematec 対応 2011/12/07 ADD <<<
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I754 WITH L_TNAME.
ENDCASE.

*-- 20090113 INS STA
CLEAR: COUNTER_10.
DESCRIBE TABLE T_YN_10_DATA LINES COUNTER_10.
*-- 20090113 INS END

ENDFORM.                    " GET_YN_10_DATA
*&---------------------------------------------------------------------*
*&      Form  GET_YN_20_DATA
*&---------------------------------------------------------------------*
*       自社データ検索
*----------------------------------------------------------------------*
FORM GET_YN_20_DATA .

DATA: L_TNAME(10) TYPE C.

CLEAR RC_CODE.
REFRESH T_YN_20_DATA.
CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.
SELECT TGTFLG     " 照合対象フラグ
GJAHR      " 会計年度
SLPDOC     " 外部番号
DTLDOC     " 外部明細番号
VRFCTON    " 取引先コード
BUKRS      " 会社コード
ZFBDT      " 日付
PRCTR      " 利益センタ
PERNR      " 担当者
DVSON      " 部門
CSTS       " 照合ステータス
COMMT      " コメント
YNGJAHR    " 会計伝票会計年度
BELNR      " 会計伝票番号
BUZEI      " 会計伝票明細番号
KNQUAN     " 数量
KNUNIT     " 単位
KNUNTPRC   " 単価
KNTAXAMT   " 消費税額
KNITXAMT   " 税抜金額
KNETXAMT   " 税込金額
WAERS      " 通貨コード
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
CHKDOC     " 照合番号
CHKDAT     " 照合日
CHKUSR     " 照合ユーザ
*&Ver2 対応 2007/02/28 <<<
UPDDAT     " 更新日
UPDTIM     " 更新時刻
UPDUSR     " 更新ユーザ
UPDPRG     " 更新プログラム
CKEY1      " 得意先発注番号
CKEY2      " 取引先品目コード
CKEY3                                              " 照合キー3
CKEY4                                              " 照合キー4
CKEY5                                              " 照合キー5
CKEY6                                              " 照合キー6
CKEY7                                              " 照合キー7
CKEY8                                              " 照合キー8
LIST1      " 自社品目コード
LIST2      " 品名
LIST3      " 受注先コード
LIST4      " 得意発注明細番号
LIST5      " 一覧表示項目5
LIST6      " 一覧表示項目6
LIST7      " 一覧表示項目7
LIST8      " 一覧表示項目8
LIST9      " 一覧表示項目9
LIST10     " 一覧表示項目10
* elematec 対応 2011/12/07 ADD >>>
INSDT      " 登録日
LDATE1     " 請求日/入庫日
CZFBDT     " 照合締日
* elematec 対応 2011/12/07 ADD <<<
INTO TABLE T_YN_20_DATA
FROM (L_TNAME)
WHERE GJAHR   IN P_GJAHR1
AND SLPDOC  IN P_SLPDO1
AND DTLDOC  IN P_DTLDO1
AND VRFCTON IN P_VRFCT1
AND BUKRS   IN P_BUKRS1
AND ZFBDT   IN P_ZFBDT1
AND PRCTR   IN P_PRCTR1
AND PERNR   IN P_PERNR1
AND DVSON   IN P_DVSON1
AND CSTS    IN P_CSTS1
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
*    AND UPDDAT  IN P_UPDAT1
*    AND UPDUSR  IN P_UPUSR1
AND COMMT   IN P_COMMT1
AND CHKDOC  IN P_CHDOC1
AND CHKDAT  IN P_CHDAT1
AND CHKUSR  IN P_CHUSR1
*&Ver2 対応 2007/02/28 <<<
* elematec 対応 2011/12/07 ADD >>>
AND LIST1   IN GR_LIFNR
AND LIST2   IN P_LIST21
AND LIST8   IN P_LIST81
AND LDATE1  IN P_LDAT11
* elematec 対応 2011/12/07 ADD <<<
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I754 WITH L_TNAME.
ENDCASE.

*-- 20090113 INS STA
CLEAR: COUNTER_20, COUNTER.
DESCRIBE TABLE T_YN_20_DATA LINES COUNTER_20.
COUNTER = COUNTER_10 + COUNTER_20.
*-- 20090113 INS END

ENDFORM.                    " GET_YN_20_DATA
*&---------------------------------------------------------------------*
*&      Form  SET_FIELD_PROPS_2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_FCAT  text
*      -->P_T_ALV_CUSTOMIZER  text
*----------------------------------------------------------------------*
FORM SET_FIELD_PROPS_2 TABLES P_T_FCAT           TYPE LVC_T_FCAT
P_T_ALV_CUSTOMIZER TYPE TYP_T_ALV_CUSTOMIZER
.

DATA: L_INDEX LIKE SY-TABIX.

FIELD-SYMBOLS: <FS> TYPE ANY.

LOOP AT P_T_FCAT.
L_INDEX = SY-TABIX - 1.
LOOP AT P_T_ALV_CUSTOMIZER FROM 2.
ASSIGN COMPONENT P_T_ALV_CUSTOMIZER-NAME OF STRUCTURE P_T_FCAT
TO <FS>.
IF SY-SUBRC = 0.
<FS> =  P_T_ALV_CUSTOMIZER-PROPS+L_INDEX(1).
ENDIF.
ENDLOOP.
MODIFY P_T_FCAT.
ENDLOOP.

READ TABLE P_T_FCAT WITH KEY DATATYPE = 'CUKY'.
IF SY-SUBRC = 0.
P_T_FCAT-CFIELDNAME = P_T_FCAT-FIELDNAME.
MODIFY P_T_FCAT TRANSPORTING CFIELDNAME
WHERE DATATYPE = 'CURR'.
ENDIF.

ENDFORM.                    " SET_FIELD_PROPS_2
*&---------------------------------------------------------------------*
*&      Form  SET_T_COLORS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_T_FCAT  text
*      -->P_T_ALV_CUSTOMIZER  text
*----------------------------------------------------------------------*
FORM SET_T_COLORS TABLES P_T_FCAT           TYPE LVC_T_FCAT
P_T_COLOR          TYPE LVC_T_SCOL
P_T_ALV_CUSTOMIZER TYPE TYP_T_ALV_CUSTOMIZER
.

DATA: L_INDEX LIKE SY-TABIX.
DATA: LS_COLOR TYPE LVC_S_SCOL.

READ TABLE P_T_ALV_CUSTOMIZER WITH KEY NAME = 'EDIT'.
REFRESH P_T_COLOR.
LOOP AT P_T_FCAT.
L_INDEX = SY-TABIX - 1.
IF SY-SUBRC = 0.
IF P_T_ALV_CUSTOMIZER-PROPS+L_INDEX(1) = C_OFF.
LS_COLOR-FNAME = P_T_FCAT-FIELDNAME.
LS_COLOR-COLOR-COL = 0.
LS_COLOR-COLOR-INT = 0.
LS_COLOR-COLOR-INV = 0.
APPEND LS_COLOR TO P_T_COLOR.
ENDIF.
ENDIF.
ENDLOOP.

ENDFORM.                    " SET_T_COLORS
*&---------------------------------------------------------------------*
*&      Form  GET_DDIF_DTEL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_DENAME  text
*      <--P_S_DD04V  text
*----------------------------------------------------------------------*
FORM GET_DDIF_DTEL  USING    P_DENAME
CHANGING P_S_DD04V TYPE DD04V.

DATA: L_NAME TYPE DDOBJNAME.

CLEAR P_S_DD04V.
L_NAME = P_DENAME.
CALL FUNCTION 'DDIF_DTEL_GET'
EXPORTING
NAME     = L_NAME
LANGU    = SY-LANGU
IMPORTING
DD04V_WA = P_S_DD04V
EXCEPTIONS
OTHERS   = 0.

ENDFORM.                    " GET_DDIF_DTEL
*&---------------------------------------------------------------------*
*&      Form  F4_INPUT_0200
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_FIELDNAME  text
*      -->P_S_ROW_NO  text
*      -->P_R_EVENT_DATA  text
*----------------------------------------------------------------------*
FORM F4_INPUT_0200 USING P_FIELDNAME
P_S_ROW_NO TYPE LVC_S_ROID
P_R_EVENT_DATA TYPE REF TO CL_ALV_EVENT_DATA.

DATA: L_S_FCAT TYPE LVC_S_FCAT,
L_S_F4 TYPE LVC_S_MODI.

FIELD-SYMBOLS: <FS_T_F4> TYPE LVC_T_MODI.

DATA: L_TNAME TYPE STRING,
L_VALUE TYPE STRING.

CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
READ TABLE T_FCAT_0200 INTO L_S_FCAT
WITH KEY FIELDNAME = P_FIELDNAME.
* 項目値取得
PERFORM F4IF_FIELD_VALUE_REQUEST USING    L_TNAME
L_S_FCAT-IFIELDNAME
SPACE
CHANGING L_VALUE.
IF NOT L_VALUE IS INITIAL.
ASSIGN P_R_EVENT_DATA->M_DATA->* TO <FS_T_F4>.
L_S_F4-FIELDNAME = P_FIELDNAME.
L_S_F4-ROW_ID = P_S_ROW_NO-ROW_ID.
L_S_F4-VALUE = L_VALUE.
APPEND L_S_F4 TO <FS_T_F4>.
P_R_EVENT_DATA->M_EVENT_HANDLED = 'X'.
ENDIF.

ENDFORM.                    " F4_INPUT_0200
*&---------------------------------------------------------------------*
*&      Form  GET_VRFCTON_NAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_VRFCTON  text
*      <--P_VRFCTONNAME  text
*----------------------------------------------------------------------*
FORM GET_VRFCTON_NAME  USING    P_VRFCTON
CHANGING P_VRFCTONNAME.

CLEAR: RC_CODE, P_VRFCTONNAME, W_XXA1.
*-- 20090113 UPD STA 取引先名称の取得をREADに変更
READ TABLE T_XXA1 INTO W_XXA1 WITH TABLE KEY
VRFCTON = P_VRFCTON.
RC_CODE = SY-SUBRC.
* elematec 対応 2011/12/07 ADD >>>
* 取得できない場合はＤＢより再取得
IF RC_CODE <> 0.
SELECT SINGLE
LIFNR
NAME1
INTO W_XXA1
FROM LFA1
WHERE LIFNR = P_VRFCTON.
INSERT W_XXA1 INTO TABLE T_XXA1.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<
P_VRFCTONNAME = W_XXA1-NAME1.
*-- 20090113 UPD END
ENDFORM.                    " GET_VRFCTON_NAME
*&---------------------------------------------------------------------*
*&      Form  CHECK_VRFCTON_BY_BUKRS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_VRFCTON  text
*      -->P_BUKRS  text
*      <--P_VRFCTONNAME  text
*----------------------------------------------------------------------*
FORM CHECK_VRFCTON_BY_BUKRS  USING    P_VRFCTON
P_BUKRS.

DATA: L_VRFCTONNAME(30) TYPE C.

CLEAR RC_CODE.
CASE P_MODE.
WHEN C_MODE_SALES.
SELECT SINGLE KNA1~NAME1 INTO L_VRFCTONNAME
FROM KNB1 INNER JOIN KNA1 ON KNB1~KUNNR = KNA1~KUNNR
WHERE KNB1~BUKRS = P_BUKRS
AND KNB1~KUNNR = P_VRFCTON.
WHEN C_MODE_PURCHASE.
SELECT SINGLE LFA1~NAME1 INTO L_VRFCTONNAME
FROM LFB1 INNER JOIN LFA1 ON LFB1~LIFNR = LFA1~LIFNR
WHERE LFB1~BUKRS = P_BUKRS
AND LFB1~LIFNR = P_VRFCTON.
ENDCASE.
RC_CODE = SY-SUBRC.

ENDFORM.                    " CHECK_VRFCTON_BY_BUKRS
*&---------------------------------------------------------------------*
*&      Form  GET_DOMAIN_VALUE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_CODE  text
*      <--P_VALUE  text
*----------------------------------------------------------------------*
FORM GET_DOMAIN_VALUE  USING    P_CODE
P_DNAME
CHANGING P_VALUE.

DATA: L_DOMNAME LIKE DD07V-DOMNAME,
L_DOMVALUE LIKE DD07V-DOMVALUE_L,
L_DDTEXT LIKE DD07V-DDTEXT.

CLEAR RC_CODE.
L_DOMNAME = P_DNAME.
L_DOMVALUE = P_CODE.
CALL FUNCTION 'DOMAIN_VALUE_GET'
EXPORTING
I_DOMNAME  = L_DOMNAME
I_DOMVALUE = L_DOMVALUE
IMPORTING
E_DDTEXT   = L_DDTEXT
EXCEPTIONS
NOT_EXIST  = 1
OTHERS     = 2.
IF SY-SUBRC = 0.
P_VALUE = L_DDTEXT.
ELSE.
RC_CODE = C_RC_CODE_DB_ERROR.
ENDIF.

ENDFORM.                    " GET_DOMAIN_VALUE
*&---------------------------------------------------------------------*
*&      Form  GET_PRCTR_NAME
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PRCTR  text
*      <--P_PRCTRNAME  text
*----------------------------------------------------------------------*
FORM GET_PRCTR_NAME  USING    P_PRCTR
CHANGING P_PRCTRNAME.

CLEAR: RC_CODE, P_PRCTRNAME, W_CEPCT.
*-- 20090113 UPD STA 利益センタ名称の取得をREADに変更
READ TABLE T_CEPCT INTO W_CEPCT WITH TABLE KEY
PRCTR = P_PRCTR.
RC_CODE = SY-SUBRC.
* elematec 対応 2011/12/07 ADD >>>
* 取得できない場合はＤＢより再取得
IF RC_CODE <> 0.
SELECT PRCTR
KTEXT
INTO W_CEPCT
FROM CEPCT
UP TO 1 ROWS
WHERE SPRAS =  SY-LANGU
AND PRCTR =  P_PRCTR
AND DATBI >= SY-DATUM.
ENDSELECT.
INSERT W_CEPCT INTO TABLE T_CEPCT.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<
P_PRCTRNAME = W_CEPCT-KTEXT.
*-- 20090113 UPD END

ENDFORM.                    " GET_PRCTR_NAME
*&---------------------------------------------------------------------*
*&      Form  CHECK_PRCTR_BY_BUKRS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_PRCTR  text
*      -->P_BUKRS  text
*----------------------------------------------------------------------*
FORM CHECK_PRCTR_BY_BUKRS  USING    P_PRCTR
P_BUKRS.

DATA: L_PRCTRNAME(30) TYPE C.

CLEAR RC_CODE.
SELECT SINGLE CEPCT~KTEXT INTO L_PRCTRNAME
FROM CEPCT INNER JOIN TKA02 ON CEPCT~KOKRS = TKA02~KOKRS
WHERE TKA02~BUKRS = P_BUKRS
AND CEPCT~PRCTR = P_PRCTR.
RC_CODE = SY-SUBRC.

ENDFORM.                    " CHECK_PRCTR_BY_BUKRS
*&---------------------------------------------------------------------*
*&      Form  REFRESH_GRID_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_OBJ_GRID  text
*----------------------------------------------------------------------*
FORM REFRESH_GRID_DATA  USING P_OBJ_GRID TYPE REF TO CL_GUI_ALV_GRID.

DATA: L_VALID TYPE C.

CLEAR RC_CODE.
CALL METHOD P_OBJ_GRID->CHECK_CHANGED_DATA
IMPORTING
E_VALID = L_VALID.
IF L_VALID <> 'X'.
RC_CODE = C_RC_CODE_ERROR.
ENDIF.

ENDFORM.                    " REFRESH_GRID_DATA
*&---------------------------------------------------------------------*
*&      Form  F4IF_FIELD_VALUE_REQUEST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_TABNAME   text
*      -->P_FIELDNAME   text
*----------------------------------------------------------------------*
FORM F4IF_FIELD_VALUE_REQUEST  USING    P_TNAME
P_FNAME
P_DFNAME
CHANGING P_VALUE.

DATA: L_TNAME TYPE DFIES-TABNAME,
L_FNAME TYPE DFIES-FIELDNAME,
L_DFNAME TYPE HELP_INFO-DYNPROFLD,
L_REPID LIKE SY-REPID,
L_DYNNR LIKE SY-DYNNR.
DATA: L_T_RET TYPE STANDARD TABLE OF DDSHRETVAL,
L_H_RET LIKE LINE OF L_T_RET.

L_TNAME = P_TNAME.
L_FNAME = P_FNAME.
L_REPID = SY-REPID.
L_DYNNR = SY-DYNNR.
L_DFNAME = P_DFNAME.
CLEAR P_VALUE.
CALL FUNCTION 'F4IF_FIELD_VALUE_REQUEST'
EXPORTING
TABNAME           = L_TNAME
FIELDNAME         = L_FNAME
DYNPPROG          = L_REPID
DYNPNR            = L_DYNNR
DYNPROFIELD       = L_DFNAME
TABLES
RETURN_TAB        = L_T_RET
EXCEPTIONS
FIELD_NOT_FOUND   = 1
NO_HELP_FOR_FIELD = 2
INCONSISTENT_HELP = 3
NO_VALUES_FOUND   = 4
OTHERS            = 5.
IF SY-SUBRC = 0.
READ TABLE L_T_RET INTO L_H_RET INDEX 1.
P_VALUE = L_H_RET-FIELDVAL.
ENDIF.

ENDFORM.                    " F4IF_FIELD_VALUE_REQUEST
*&---------------------------------------------------------------------*
*&      Form  F4_INPUT
*&---------------------------------------------------------------------*
*       F4インプット
*----------------------------------------------------------------------*
*      -->P_DYN_FNAME   項目名
*----------------------------------------------------------------------*
FORM F4_INPUT  USING    P_DYN_FNAME.

DATA: L_HELP_ID(20) TYPE C,
L_SNAME TYPE STRING,
L_FNAME TYPE STRING,
L_VALUE TYPE STRING.

FIELD-SYMBOLS: <FS> TYPE ANY.

ASSIGN (P_DYN_FNAME) TO <FS>.
DESCRIBE FIELD <FS> HELP-ID L_HELP_ID.
SPLIT L_HELP_ID AT '-' INTO L_SNAME L_FNAME.
IF NOT L_FNAME IS INITIAL.
CONCATENATE 'YN' P_MODE L_SNAME+3(2) INTO L_SNAME.
*   項目値取得
PERFORM F4IF_FIELD_VALUE_REQUEST USING    L_SNAME
L_FNAME
P_DYN_FNAME
CHANGING L_VALUE.
ENDIF.

ENDFORM.                                                    " F4_INPUT
*&---------------------------------------------------------------------*
*&      Form  DYNP_VALUES_UPDATE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_DYN_FNAME  text
*      -->P_VALUE  text
*----------------------------------------------------------------------*
FORM DYNP_VALUES_UPDATE  USING    P_DYN_FNAME
P_VALUE.

DATA: L_T_DYFIELDS TYPE STANDARD TABLE OF DYNPREAD,
L_H_DYFIELDS TYPE DYNPREAD,
L_REPID LIKE SY-REPID.

L_H_DYFIELDS-FIELDNAME = P_DYN_FNAME.
L_H_DYFIELDS-FIELDVALUE = P_VALUE.
APPEND L_H_DYFIELDS TO L_T_DYFIELDS.

L_REPID = SY-REPID.
CALL FUNCTION 'DYNP_VALUES_UPDATE'
EXPORTING
DYNAME     = L_REPID
DYNUMB     = SY-DYNNR
TABLES
DYNPFIELDS = L_T_DYFIELDS
EXCEPTIONS
OTHERS     = 0.
ENDFORM.                    " DYNP_VALUES_UPDATE
*&---------------------------------------------------------------------*
*&      Form  EXECUTE_USER_COMMAND_0100
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM  text
*----------------------------------------------------------------------*
FORM EXECUTE_USER_COMMAND_0100  USING    P_UCOMM.

DATA: LS_GRID_DATA LIKE LINE OF T_GRID_DATA_0100.

LOOP AT T_GRID_DATA_0100 INTO LS_GRID_DATA.
CASE P_UCOMM.
WHEN C_USER_COMMAND_SELECT_ALL.
LS_GRID_DATA-YNCHKBOX = C_ON.
WHEN C_USER_COMMAND_DESELECT_ALL.
LS_GRID_DATA-YNCHKBOX = C_OFF.
ENDCASE.
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA.
ENDLOOP.
PERFORM REFRESH_ALV_GRID_0100.

ENDFORM.                    " EXECUTE_USER_COMMAND_0100
*&---------------------------------------------------------------------*
*&      Form  CHECK_SELECT_TARGET
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_SELECT_TARGET .

DATA: L_STATUS TYPE X,
L_X TYPE X.

CLEAR RC_CODE.
PERFORM GET_STATUS CHANGING L_STATUS.
IF L_STATUS = C_STATUS_NO_DATA.
RC_CODE = C_STATUS_NO_DATA.
MESSAGE I762.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_DELETED_DATA.
IF L_X = C_STATUS_DELETED_DATA.
RC_CODE = C_STATUS_DELETED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_AUTO_COMPARED_DATA.
IF L_X = C_STATUS_AUTO_COMPARED_DATA.
RC_CODE = C_STATUS_AUTO_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_MANUAL_COMPARED_DATA.
IF L_X = C_STATUS_MANUAL_COMPARED_DATA.
RC_CODE = C_STATUS_MANUAL_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_SELECT_TARGET
*&---------------------------------------------------------------------*
*&      Form  TOGGLE_TARGET_FLAG
*&---------------------------------------------------------------------*
*       照合対象フラグ更新
*----------------------------------------------------------------------*
*      -->P_FLAG  照合対象フラグ
*----------------------------------------------------------------------*
FORM TOGGLE_TARGET_FLAG  USING    P_FLAG.

DATA: LS_GRID_DATA LIKE LINE OF T_GRID_DATA_0100.
DATA: L_UPDDAT LIKE SY-DATUM,
L_UPDTIM LIKE SY-UZEIT,
L_UPDUSR LIKE SY-UNAME,
L_UPDPRG LIKE SY-REPID.

CLEAR COUNTER.
LOOP AT T_GRID_DATA_0100 INTO LS_GRID_DATA WHERE YNCHKBOX = C_ON.
IF LS_GRID_DATA-YNTGTFLG <> P_FLAG.
L_UPDDAT = SY-DATUM.
L_UPDTIM = SY-UZEIT.
L_UPDUSR = SY-UNAME.
L_UPDPRG = SY-REPID.
CASE P_MODE.
WHEN C_MODE_SALES.
CASE LS_GRID_DATA-YNKUBUN.
WHEN C_KUBUN_EXTERNAL.
UPDATE YN110
SET TGTFLG = P_FLAG
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
WHEN C_KUBUN_INTERNAL.
UPDATE YN120
SET TGTFLG = P_FLAG
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR2
AND SLPDOC = LS_GRID_DATA-YNSLPDOC2
AND DTLDOC = LS_GRID_DATA-YNDTLDOC2
.
ENDCASE.
WHEN C_MODE_PURCHASE.
CASE LS_GRID_DATA-YNKUBUN.
WHEN C_KUBUN_EXTERNAL.
UPDATE YN210
SET TGTFLG = P_FLAG
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
WHEN C_KUBUN_INTERNAL.
UPDATE YN220
SET TGTFLG = P_FLAG
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR2
AND SLPDOC = LS_GRID_DATA-YNSLPDOC2
AND DTLDOC = LS_GRID_DATA-YNDTLDOC2
.
ENDCASE.
ENDCASE.
IF SY-SUBRC = 0.
COMMIT WORK AND WAIT.
COUNTER = COUNTER + 1.
LS_GRID_DATA-YNTGTFLG = P_FLAG.
LS_GRID_DATA-YNCHKBOX = C_OFF.
LS_GRID_DATA-YNUPDDAT = L_UPDDAT.
LS_GRID_DATA-YNUPDTIM = L_UPDTIM.
LS_GRID_DATA-YNUPDUSR = L_UPDUSR.
LS_GRID_DATA-YNUPDPRG = L_UPDPRG.
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA.
ENDIF.
ELSE.
LS_GRID_DATA-YNCHKBOX = C_OFF.
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA.
ENDIF.
ENDLOOP.
PERFORM REFRESH_ALV_GRID_0100.

ENDFORM.                    " TOGGLE_TARGET_FLAG
*&---------------------------------------------------------------------*
*&      Form  GET_STATUS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_L_STATUS  text
*----------------------------------------------------------------------*
FORM GET_STATUS  CHANGING P_STATUS TYPE X.

DATA: L_H_GRID_DATA_0100 LIKE LINE OF T_GRID_DATA_0100.

CLEAR: P_STATUS, COUNTER.
*&照合取消 2009/01/21 ADD-S
CLEAR: G_BUKRS,G_CHKDOC,G_VRFCTON.
*&照合取消 2009/01/21 ADD-E 　
LOOP AT T_GRID_DATA_0100 INTO L_H_GRID_DATA_0100
WHERE YNCHKBOX = C_ON.
COUNTER = COUNTER + 1.
IF L_H_GRID_DATA_0100-YNKUBUN = C_KUBUN_EXTERNAL.
P_STATUS = P_STATUS BIT-OR C_STATUS_EXTERNAL_DATA.
ELSEIF L_H_GRID_DATA_0100-YNKUBUN = C_KUBUN_INTERNAL.
P_STATUS = P_STATUS BIT-OR C_STATUS_INTERNAL_DATA.
ENDIF.
IF L_H_GRID_DATA_0100-YNDELFLG = C_ON.
P_STATUS = P_STATUS BIT-OR C_STATUS_DELETED_DATA.
ENDIF.
IF L_H_GRID_DATA_0100-YNCSTS = C_CSTS_OK_AUTO.
P_STATUS = P_STATUS BIT-OR C_STATUS_AUTO_COMPARED_DATA.
ELSEIF L_H_GRID_DATA_0100-YNCSTS = C_CSTS_OK.
P_STATUS = P_STATUS BIT-OR C_STATUS_MANUAL_COMPARED_DATA.
ENDIF.
*&照合取消 2009/01/21 ADD-S 　
*　 照合日がないデータを選択したかどうか
IF L_H_GRID_DATA_0100-YNCHKDOC IS INITIAL.
P_STATUS = P_STATUS BIT-OR C_STATUS_NO_CANCEL_DATA.
ENDIF.
*　 照合番号が混在しているかどうか
IF COUNTER > 1 AND G_CHKDOC <> L_H_GRID_DATA_0100-YNCHKDOC.
P_STATUS = P_STATUS BIT-OR C_STATUS_NOTONE_SYOUGOU.
ENDIF.
G_CHKDOC   = L_H_GRID_DATA_0100-YNCHKDOC. "今の照合番号を格納する#
G_BUKRS    = L_H_GRID_DATA_0100-YNBUKRS.  "会社コードを取得（結果#
G_VRFCTON  = L_H_GRID_DATA_0100-YNVRFCTON."取引先コードを取得（結#
G_CHKDAT   = L_H_GRID_DATA_0100-YNCHKDAT. "ポップアップ画面用
*&照合取消 2009/01/21 ADD-E 　
ENDLOOP.
IF L_H_GRID_DATA_0100 IS INITIAL.
P_STATUS = P_STATUS BIT-OR C_STATUS_NO_DATA.
ENDIF.

ENDFORM.                    " GET_STATUS

*&照合取消 2009/01/21 ADD-S 　
*&---------------------------------------------------------------------*
*&      Form  CHECK_CANCEL_DATA
*&---------------------------------------------------------------------*
*       照合取消の選択データのチェック
*----------------------------------------------------------------------*
FORM CHECK_CANCEL_DATA.

DATA: L_STATUS TYPE X,
L_X TYPE X.

CLEAR RC_CODE.
PERFORM GET_STATUS CHANGING L_STATUS.
*選択しなくて、照合取消ボタンを押下の場合
*[対象データがありません]を出力
IF L_STATUS = C_STATUS_NO_DATA.
RC_CODE = C_STATUS_NO_DATA.
MESSAGE I762.
EXIT.
ENDIF.
*選択されたデータの中で照合番号が混在して、照合取消ボタンを押下の場合
*[照合取消時は照合番号を一つだけ選んでください]を出力
L_X = L_STATUS BIT-AND C_STATUS_NOTONE_SYOUGOU.
IF L_X = C_STATUS_NOTONE_SYOUGOU.
RC_CODE = C_STATUS_NOTONE_SYOUGOU.
MESSAGE I705.
EXIT.
ENDIF.
*照合番号が入ってないデータを選択されて、照合取消ボタンを押下の場合
*[照合済データを選択して出力してください]を出力
L_X = L_STATUS BIT-AND C_STATUS_NO_CANCEL_DATA.
IF L_X = C_STATUS_NO_CANCEL_DATA.
RC_CODE = C_STATUS_NO_CANCEL_DATA.
MESSAGE I706.
EXIT.
ENDIF.

ENDFORM.     "CHECK_CANCEL_DATA
*照合取消 2009/01/21 ADD-E

*&---------------------------------------------------------------------*
*&      Form  CHECK_AUTHORITY_NEW
*&---------------------------------------------------------------------*
*       権限チェック
*----------------------------------------------------------------------*
*      -->P_OBJECT               権限オブジェクト
*         P_CHECK_KOUMOKU_NAME   チェック項目
*         P_CHECK_TARGET　　　　 チェック目標
*         P_ACTVT.　　　　　　　 チェック権限
*----------------------------------------------------------------------*
FORM CHECK_AUTHORITY_NEW USING P_OBJECT
P_CHECK_KOUMOKU_NAME
P_CHECK_TARGET
P_ACTVT.
DATA L_L TYPE STRING.
CLEAR: RC_CODE.
IF SY-LANGU = 'J'.
L_L = C_CHECK_KOUMOKU_TEXT_JP.
ELSE.
L_L = C_CHECK_KOUMOKU_TEXT_EN.
ENDIF.

IF P_ACTVT = C_DUMMY.
AUTHORITY-CHECK OBJECT P_OBJECT
ID P_CHECK_KOUMOKU_NAME FIELD P_CHECK_TARGET
ID 'ACTVT' DUMMY.
ELSE.
AUTHORITY-CHECK OBJECT P_OBJECT
ID P_CHECK_KOUMOKU_NAME FIELD P_CHECK_TARGET
ID 'ACTVT' FIELD P_ACTVT.
ENDIF.

IF SY-SUBRC <> 0.
RC_CODE = C_RC_CODE_NO_AUTHORITY.
MESSAGE I707 WITH L_L P_CHECK_TARGET.
ENDIF.

ENDFORM.
*照合取消 2009/01/21 ADD-S
*&---------------------------------------------------------------------*
*&      Form  GET_CANCEL_DATA
*&---------------------------------------------------------------------*
*       照合取消データの取得及び対象件数の取得
*----------------------------------------------------------------------*

FORM GET_CANCEL_DATA.

DATA L_TNAME TYPE STRING.

CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.

REFRESH: T_CANCEL_10,
T_CANCEL_20.

* conversion 対応 2010/12/13 UPD >>>
*    SELECT GJAHR       "外部会計年度
*           SLPDOC      "外部番号
*           DTLDOC      "外部明細番号
*           VRFCTON     "取引先コード
*           BUKRS       "会社コード
*    INTO   CORRESPONDING FIELDS OF TABLE T_CANCEL_10
*    FROM   (L_TNAME)
*    WHERE  CHKDOC = G_CHKDOC
*      AND  BUKRS  = G_BUKRS
*           .
*   CASE SY-SUBRC.
*     WHEN 0 OR 4.
*     WHEN OTHERS.
*       RC_CODE = C_RC_CODE_DB_ERROR.
*       MESSAGE I754 WITH L_TNAME.
*   ENDCASE.

* 外部データ(売上)の取得
IF L_TNAME     = C_TABLE_ID_GA_URI.
SELECT GJAHR       "外部会計年度
SLPDOC      "外部番号
DTLDOC      "外部明細番号
VRFCTON     "取引先コード
BUKRS       "会社コード
INTO   CORRESPONDING FIELDS OF TABLE T_CANCEL_10
FROM   YN110
WHERE  CHKDOC = G_CHKDOC
AND  BUKRS  = G_BUKRS
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I754 WITH L_TNAME.
ENDCASE.
* 外部データ(仕入)の取得
ELSEIF L_TNAME = C_TABLE_ID_GA_SHI.
SELECT GJAHR       "外部会計年度
SLPDOC      "外部番号
DTLDOC      "外部明細番号
VRFCTON     "取引先コード
BUKRS       "会社コード
INTO   CORRESPONDING FIELDS OF TABLE T_CANCEL_10
FROM   YN210
WHERE  CHKDOC = G_CHKDOC
AND  BUKRS  = G_BUKRS
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I754 WITH L_TNAME.
ENDCASE.
ENDIF.
* conversion 対応 2010/12/13 UPD <<<

CHECK RC_CODE = 0.

CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.

* conversion 対応 2010/12/13 UPD >>>
*    SELECT GJAHR       "伝票会計年度
*           SLPDOC      "伝票番号
*           DTLDOC      "伝票明細番号
*           VRFCTON     "取引先コード
*           BUKRS       "会社コード
*    INTO   CORRESPONDING FIELDS OF TABLE T_CANCEL_20
*    FROM   (L_TNAME)
*    WHERE  CHKDOC = G_CHKDOC
*      AND  BUKRS  = G_BUKRS
*           .
*   CASE SY-SUBRC.
*     WHEN 0 OR 4.
*     WHEN OTHERS.
*       RC_CODE = C_RC_CODE_DB_ERROR.
*       MESSAGE I754 WITH L_TNAME.
*   ENDCASE.

* 自社データ(売上)の取得
IF L_TNAME     = C_TABLE_ID_ZI_URI.
SELECT GJAHR       "伝票会計年度
SLPDOC      "伝票番号
DTLDOC      "伝票明細番号
VRFCTON     "取引先コード
BUKRS       "会社コード
INTO   CORRESPONDING FIELDS OF TABLE T_CANCEL_20
FROM   YN120
WHERE  CHKDOC = G_CHKDOC
AND  BUKRS  = G_BUKRS
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I754 WITH L_TNAME.
ENDCASE.
* 自社データ(仕入)の取得
ELSEIF L_TNAME = C_TABLE_ID_ZI_SHI.
SELECT GJAHR       "伝票会計年度
SLPDOC      "伝票番号
DTLDOC      "伝票明細番号
VRFCTON     "取引先コード
BUKRS       "会社コード
INTO   CORRESPONDING FIELDS OF TABLE T_CANCEL_20
FROM   YN220
WHERE  CHKDOC = G_CHKDOC
AND  BUKRS  = G_BUKRS
.
CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I754 WITH L_TNAME.
ENDCASE.
ENDIF.
* conversion 対応 2010/12/13 UPD <<<

DESCRIBE TABLE T_CANCEL_10 LINES G_CANCEL_NUMBER_10.
DESCRIBE TABLE T_CANCEL_20 LINES G_CANCEL_NUMBER_20.

ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  CANCEL_TABLE_LOCK
*&---------------------------------------------------------------------*
*       照合取消：テーブルエントリロック
*----------------------------------------------------------------------*
FORM CANCEL_TABLE_LOCK.


DATA: L_H_CANCEL_10 LIKE LINE OF T_CANCEL_10, "自社用
L_H_CANCEL_20 LIKE LINE OF T_CANCEL_20. "外部用

DATA: L_FUNC_NAME(30) TYPE C,
L_TNAME TYPE STRING.

* 取得データからロック対象のキーテーブル作成
*-- 外部データ
LOOP AT T_CANCEL_10 INTO L_H_CANCEL_10.
G_WA_ENQ_KEY-BUKRS   = L_H_CANCEL_10-BUKRS.
G_WA_ENQ_KEY-VRFCTON = L_H_CANCEL_10-VRFCTON.
INSERT G_WA_ENQ_KEY INTO TABLE G_TBL_ENQ_KEY_G.
ENDLOOP.

DELETE ADJACENT DUPLICATES FROM G_TBL_ENQ_KEY_G.

*-- 自社データ
LOOP AT T_CANCEL_20 INTO L_H_CANCEL_20.
G_WA_ENQ_KEY-BUKRS = L_H_CANCEL_20-BUKRS.
G_WA_ENQ_KEY-VRFCTON =  L_H_CANCEL_20-VRFCTON.
INSERT G_WA_ENQ_KEY INTO TABLE G_TBL_ENQ_KEY_J.
ENDLOOP.

DELETE ADJACENT DUPLICATES FROM G_TBL_ENQ_KEY_J.

*-- 外部データロック
CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
CONCATENATE 'LOCK_' L_TNAME INTO L_FUNC_NAME.

LOOP AT G_TBL_ENQ_KEY_G INTO G_WA_ENQ_KEY.
PERFORM (L_FUNC_NAME) IN PROGRAM YN010400
USING G_WA_ENQ_KEY-BUKRS G_WA_ENQ_KEY-VRFCTON.
IF RC_CODE <> 0.
MESSAGE I756 WITH L_TNAME YNTEXT.
EXIT.
ELSE.
INSERT G_WA_ENQ_KEY INTO TABLE G_TBL_ENQ_KEY_G_OK.
ENDIF.
ENDLOOP.
IF RC_CODE <> 0.
EXIT.
ENDIF.

*--自社データロック
CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.
CONCATENATE 'LOCK_' L_TNAME INTO L_FUNC_NAME.
CLEAR RC_CODE.

LOOP AT G_TBL_ENQ_KEY_J INTO G_WA_ENQ_KEY.
PERFORM (L_FUNC_NAME) IN PROGRAM YN010400
USING G_WA_ENQ_KEY-BUKRS G_WA_ENQ_KEY-VRFCTON.
IF RC_CODE <> 0.
MESSAGE I756 WITH L_TNAME YNTEXT.
EXIT.
ELSE.
INSERT G_WA_ENQ_KEY INTO TABLE G_TBL_ENQ_KEY_J_OK.
ENDIF.
ENDLOOP.
IF RC_CODE <> 0.
EXIT.
ENDIF.
DELETE ADJACENT DUPLICATES FROM G_TBL_ENQ_KEY_J_OK.
DELETE ADJACENT DUPLICATES FROM G_TBL_ENQ_KEY_G_OK.
ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  CANCEL_TABLE_UNLOCK
*&---------------------------------------------------------------------*
*       照合取消：テーブルエントアンロック
*----------------------------------------------------------------------*
FORM CANCEL_TABLE_UNLOCK.

DATA: L_FUNC_NAME(30) TYPE C,
L_TNAME TYPE STRING.

* 外部データアンロック
CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
CONCATENATE 'DEQUEUE_EY_' L_TNAME INTO L_FUNC_NAME.

LOOP AT G_TBL_ENQ_KEY_G_OK INTO G_WA_ENQ_KEY.
CALL FUNCTION L_FUNC_NAME
EXPORTING
VRFCTON        = G_WA_ENQ_KEY-VRFCTON
BUKRS          = G_WA_ENQ_KEY-BUKRS
EXCEPTIONS
SYSTEM_FAILURE = 2
OTHERS         = 3.
IF SY-SUBRC <> 0.
ENDIF.
ENDLOOP.

* 自社データアンロック
CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.
CONCATENATE 'DEQUEUE_EY_' L_TNAME INTO L_FUNC_NAME.

LOOP AT G_TBL_ENQ_KEY_J_OK INTO G_WA_ENQ_KEY.
CALL FUNCTION L_FUNC_NAME
EXPORTING
VRFCTON        = G_WA_ENQ_KEY-VRFCTON
BUKRS          = G_WA_ENQ_KEY-BUKRS
EXCEPTIONS
SYSTEM_FAILURE = 2
OTHERS         = 3.
IF SY-SUBRC <> 0.
ENDIF.
ENDLOOP.

ENDFORM.   "CANCEL_TABLE_UNLOCK

*&---------------------------------------------------------------------*
*&      Form  CANCEL_MESSAGE
*&---------------------------------------------------------------------*
*       ポップアップ画面のメッセージを生成する
*----------------------------------------------------------------------*
*     -->
*     <-- P_MSGNO 　　表示用メッセージ番号
*         P_QUESTION  ポップアップ画面表示する内容
*----------------------------------------------------------------------*
FORM CANCEL_MESSAGE CHANGING P_MSGNO P_QUESTION.

DATA: L_CANCEL_10 TYPE STRING,
L_CANCEL_20 TYPE STRING,
L_CANCEL_NUMBER_TEXT TYPE STRING, "　'件、'
L_CANCEL_NUMBER_10 TYPE STRING,   "外部　取消件数
L_CANCEL_NUMBER_20 TYPE STRING.   "自社　取消件数

IF SY-LANGU = 'J'.
L_CANCEL_NUMBER_TEXT = C_CANCEL_NUMBER_TEXT.
ENDIF.

L_CANCEL_NUMBER_10 = G_CANCEL_NUMBER_10.
L_CANCEL_NUMBER_20 = G_CANCEL_NUMBER_20.
CONCATENATE L_CANCEL_NUMBER_10 L_CANCEL_NUMBER_TEXT INTO L_CANCEL_10.
CONCATENATE L_CANCEL_NUMBER_20 L_CANCEL_NUMBER_TEXT INTO L_CANCEL_20.
MESSAGE ID 'YN01' TYPE 'S' NUMBER P_MSGNO
INTO P_QUESTION WITH L_CANCEL_10 L_CANCEL_20 G_CHKDAT.

ENDFORM.

*&---------------------------------------------------------------------*
*&      Form  CANCEL_DATA
*&---------------------------------------------------------------------*
*       照合取消を行う
*  取得したデータの外部（内部）データをループしながら処理する。
*　　(1)照合ステータスを'1'(未照合)とする。			
*　　(2)照合番号、照合日、照合ユーザーに初期値を設定する。		
	
*　　(3)更新日:         システム日付
*　　　 更新時刻:       システム時刻
*    　 更新ユーザ:  　 今のユーザ
*       更新プログラム:	固定値 YN010400		
*　　(4)編集したデータを｢外部データ｣に更新する。　
*　　　　※更新テーブルは選択画面の売上/仕入区分により判断する。	
	
	
*　　　更新に失敗した場合は、‘[テーブルID]更新エラー’を出力後、
*　　　ロールバックし、第2画面へ戻る。			
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM CANCEL_DATA .

DATA: L_TNAME(10) TYPE C.

CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
*外部データの照合取消を行う
LOOP AT T_CANCEL_10.
* conversion 対応 2010/12/13 UPD >>>
*    UPDATE (L_TNAME)
*       SET CSTS    = C_CSTS_INIT
*           CHKDOC  = ''
*           CHKDAT  = '00000000'
*           CHKUSR  = ''
*           UPDDAT  = SY-DATUM
*           UPDTIM  = SY-UZEIT
*           UPDUSR  = SY-UNAME
*           UPDPRG  = C_PROGRAM_NAME
*     WHERE GJAHR   = T_CANCEL_10-GJAHR
*       AND SLPDOC  = T_CANCEL_10-SLPDOC
*       AND DTLDOC  = T_CANCEL_10-DTLDOC
*       AND VRFCTON = T_CANCEL_10-VRFCTON
*       AND BUKRS   = T_CANCEL_10-BUKRS
*           .

*   外部データ(売上)の取得
IF L_TNAME     = C_TABLE_ID_GA_URI.
UPDATE YN110
SET CSTS    = C_CSTS_INIT
CHKDOC  = ''
CHKDAT  = '00000000'
CHKUSR  = ''
UPDDAT  = SY-DATUM
UPDTIM  = SY-UZEIT
UPDUSR  = SY-UNAME
UPDPRG  = C_PROGRAM_NAME
* elematec 対応 2011/12/07 ADD >>>
CZFBDT  = '00000000'
* elematec 対応 2011/12/07 ADD <<<
WHERE GJAHR   = T_CANCEL_10-GJAHR
AND SLPDOC  = T_CANCEL_10-SLPDOC
AND DTLDOC  = T_CANCEL_10-DTLDOC
AND VRFCTON = T_CANCEL_10-VRFCTON
AND BUKRS   = T_CANCEL_10-BUKRS
.
*   外部データ(仕入)の取得
ELSEIF L_TNAME = C_TABLE_ID_GA_SHI.
UPDATE YN210
SET CSTS    = C_CSTS_INIT
CHKDOC  = ''
CHKDAT  = '00000000'
CHKUSR  = ''
UPDDAT  = SY-DATUM
UPDTIM  = SY-UZEIT
UPDUSR  = SY-UNAME
UPDPRG  = C_PROGRAM_NAME
* elematec 対応 2011/12/07 ADD >>>
CZFBDT  = '00000000'
* elematec 対応 2011/12/07 ADD <<<
WHERE GJAHR   = T_CANCEL_10-GJAHR
AND SLPDOC  = T_CANCEL_10-SLPDOC
AND DTLDOC  = T_CANCEL_10-DTLDOC
AND VRFCTON = T_CANCEL_10-VRFCTON
AND BUKRS   = T_CANCEL_10-BUKRS
.
ENDIF.
* conversion 対応 2010/12/13 UPD <<<
IF SY-SUBRC <> 0 .
ROLLBACK WORK.
MESSAGE I758 WITH L_TNAME.
RC_CODE = C_RC_CODE_DB_ERROR .
EXIT.
ENDIF.

ENDLOOP.

CHECK RC_CODE = 0.
*自社データの照合取消を行う
CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.

LOOP AT T_CANCEL_20.
* conversion 対応 2010/12/13 UPD >>>
*    UPDATE (L_TNAME)
*       SET CSTS    = C_CSTS_INIT
*           CHKDOC  = ''
*           CHKDAT  = '00000000'
*           CHKUSR  = ''
*           UPDDAT  = SY-DATUM
*           UPDTIM  = SY-UZEIT
*           UPDUSR  = SY-UNAME
*           UPDPRG  = C_PROGRAM_NAME
*     WHERE GJAHR   = T_CANCEL_20-GJAHR
*       AND SLPDOC  = T_CANCEL_20-SLPDOC
*       AND DTLDOC  = T_CANCEL_20-DTLDOC
*       AND VRFCTON = T_CANCEL_20-VRFCTON
*       AND BUKRS   = T_CANCEL_20-BUKRS
*           .

*   自社データ(売上)の取得
IF L_TNAME     = C_TABLE_ID_ZI_URI.
UPDATE YN120
SET CSTS    = C_CSTS_INIT
CHKDOC  = ''
CHKDAT  = '00000000'
CHKUSR  = ''
UPDDAT  = SY-DATUM
UPDTIM  = SY-UZEIT
UPDUSR  = SY-UNAME
UPDPRG  = C_PROGRAM_NAME
* elematec 対応 2011/12/07 ADD >>>
CZFBDT  = '00000000'
* elematec 対応 2011/12/07 ADD <<<
WHERE GJAHR   = T_CANCEL_20-GJAHR
AND SLPDOC  = T_CANCEL_20-SLPDOC
AND DTLDOC  = T_CANCEL_20-DTLDOC
AND VRFCTON = T_CANCEL_20-VRFCTON
AND BUKRS   = T_CANCEL_20-BUKRS
.
*   自社データ(仕入)の取得
ELSEIF L_TNAME = C_TABLE_ID_ZI_SHI.
UPDATE YN220
SET CSTS    = C_CSTS_INIT
CHKDOC  = ''
CHKDAT  = '00000000'
CHKUSR  = ''
UPDDAT  = SY-DATUM
UPDTIM  = SY-UZEIT
UPDUSR  = SY-UNAME
UPDPRG  = C_PROGRAM_NAME
* elematec 対応 2011/12/07 ADD >>>
CZFBDT  = '00000000'
* elematec 対応 2011/12/07 ADD <<<
WHERE GJAHR   = T_CANCEL_20-GJAHR
AND SLPDOC  = T_CANCEL_20-SLPDOC
AND DTLDOC  = T_CANCEL_20-DTLDOC
AND VRFCTON = T_CANCEL_20-VRFCTON
AND BUKRS   = T_CANCEL_20-BUKRS
.
ENDIF.
* conversion 対応 2010/12/13 UPD <<<
IF SY-SUBRC <> 0 .
ROLLBACK WORK.
MESSAGE I758 WITH L_TNAME.
RC_CODE = C_RC_CODE_DB_ERROR .
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    " CANCEL_DATA
*照合取消 2009/01/21 ADD-E

*&---------------------------------------------------------------------*
*&      Form  CHECK_DELETE_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_DELETE_DATA .

DATA: L_STATUS TYPE X,
L_X TYPE X.

CLEAR RC_CODE.
PERFORM GET_STATUS CHANGING L_STATUS.
IF L_STATUS = C_STATUS_NO_DATA.
RC_CODE = C_STATUS_NO_DATA.
MESSAGE I762.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_INTERNAL_DATA.
IF L_X = C_STATUS_INTERNAL_DATA.
RC_CODE = C_STATUS_INTERNAL_DATA.
MESSAGE I784.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_DELETED_DATA.
IF L_X = C_STATUS_DELETED_DATA.
RC_CODE = C_STATUS_DELETED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_AUTO_COMPARED_DATA.
IF L_X = C_STATUS_AUTO_COMPARED_DATA.
RC_CODE = C_STATUS_AUTO_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_MANUAL_COMPARED_DATA.
IF L_X = C_STATUS_MANUAL_COMPARED_DATA.
RC_CODE = C_STATUS_MANUAL_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_DELETE_DATA
*&---------------------------------------------------------------------*
*&      Form  CHECK_EDIT_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_EDIT_DATA .

DATA: L_STATUS TYPE X,
L_X TYPE X.

CLEAR RC_CODE.
PERFORM GET_STATUS CHANGING L_STATUS.
IF L_STATUS = C_STATUS_NO_DATA.
RC_CODE = C_STATUS_NO_DATA.
MESSAGE I762.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_INTERNAL_DATA.
IF L_X = C_STATUS_INTERNAL_DATA.
RC_CODE = C_STATUS_INTERNAL_DATA.
MESSAGE I798.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_DELETED_DATA.
IF L_X = C_STATUS_DELETED_DATA.
RC_CODE = C_STATUS_DELETED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_AUTO_COMPARED_DATA.
IF L_X = C_STATUS_AUTO_COMPARED_DATA.
RC_CODE = C_STATUS_AUTO_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_MANUAL_COMPARED_DATA.
IF L_X = C_STATUS_MANUAL_COMPARED_DATA.
RC_CODE = C_STATUS_MANUAL_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_EDIT_DATA
*&---------------------------------------------------------------------*
*&      Form  TOGGLE_DELETE_FLAG
*&---------------------------------------------------------------------*
*       削除フラグ更新
*----------------------------------------------------------------------*
*      -->P_FLAG  削除フラグ
*----------------------------------------------------------------------*
FORM TOGGLE_DELETE_FLAG  USING    P_FLAG.

DATA: LS_GRID_DATA LIKE LINE OF T_GRID_DATA_0100.
DATA: L_TNAME TYPE STRING.
DATA: L_UPDDAT LIKE SY-DATUM,
L_UPDTIM LIKE SY-UZEIT,
L_UPDUSR LIKE SY-UNAME,
L_UPDPRG LIKE SY-REPID.

CLEAR: COUNTER, RC_CODE.
CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
LOOP AT T_GRID_DATA_0100 INTO LS_GRID_DATA WHERE YNCHKBOX = C_ON.
IF LS_GRID_DATA-YNDELFLG <> P_FLAG.
L_UPDDAT = SY-DATUM.
L_UPDTIM = SY-UZEIT.
L_UPDUSR = SY-UNAME.
L_UPDPRG = SY-REPID.
CASE P_MODE.
WHEN C_MODE_SALES.
UPDATE YN110
SET DELFLG = P_FLAG
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
WHEN C_MODE_PURCHASE.
UPDATE YN210
SET DELFLG = P_FLAG
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
ENDCASE.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I758 WITH L_TNAME.
EXIT.
ELSE.
COUNTER = COUNTER + 1.
LS_GRID_DATA-YNDELFLG = P_FLAG.
LS_GRID_DATA-YNUPDDAT = L_UPDDAT.
LS_GRID_DATA-YNUPDTIM = L_UPDTIM.
LS_GRID_DATA-YNUPDUSR = L_UPDUSR.
LS_GRID_DATA-YNUPDPRG = L_UPDPRG.
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA.
ENDIF.
ENDIF.
ENDLOOP.

CHECK RC_CODE = 0.

COMMIT WORK AND WAIT.
DELETE T_GRID_DATA_0100
WHERE YNKUBUN = C_KUBUN_EXTERNAL
AND NOT ( YNDELFLG IN P_DELFL2 ).

PERFORM REFRESH_ALV_GRID_0100.

ENDFORM.                    " TOGGLE_DELETE_FLAG
*&---------------------------------------------------------------------*
*&      Form  POPUP_TO_CONFIRM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_2195   text
*----------------------------------------------------------------------*
FORM POPUP_TO_CONFIRM  USING    P_MSGNO
*-- 20090113 INS STA
P_DEFAULT.
*-- 20090113 INS END

DATA: L_QUESTION TYPE STRING,
L_ANSWER TYPE C.

CLEAR RC_CODE.

*照合取消　2009/01/21 MOD-S
* MESSAGE ID 'YN01' TYPE 'S' NUMBER P_MSGNO "DEL 2009/02/17
* INTO L_QUESTION WITH COUNTER.             "DEL 2009/02/17
*  ポップアップ画面のメッセージを生成する
IF OK_CODE = C_USER_COMMAND_CANCEL_DATA.
PERFORM CANCEL_MESSAGE CHANGING P_MSGNO L_QUESTION.
ELSE.

* elematec 対応 2011/12/07 ADD >>>
IF OK_CODE = C_USER_COMMAND_COMPARE.
MESSAGE ID 'YN01' TYPE 'S' NUMBER P_MSGNO
INTO L_QUESTION  WITH G_COUNT_10 G_COUNT_20 .
ELSE.
* elematec 対応 2011/12/07 ADD <<<

MESSAGE ID 'YN01' TYPE 'S' NUMBER P_MSGNO
INTO L_QUESTION WITH COUNTER.
* elematec 対応 2011/12/07 ADD >>>
ENDIF.
* elematec 対応 2011/12/07 ADD <<<
ENDIF.
*照合取消　2009/01/21 MOD-E

CALL FUNCTION 'POPUP_TO_CONFIRM'
EXPORTING
TEXT_QUESTION  = L_QUESTION
*-- 20090113 INS STA
DEFAULT_BUTTON = P_DEFAULT
*-- 20090113 INS END
IMPORTING
ANSWER         = L_ANSWER
EXCEPTIONS
TEXT_NOT_FOUND = 1
OTHERS         = 2.
IF SY-SUBRC = 0.
CASE L_ANSWER.
WHEN '1'.
RC_CODE = 0.
WHEN '2'.
RC_CODE = 2.
WHEN 'A'.
RC_CODE = 9.
ENDCASE.
ELSE.
RC_CODE = C_RC_CODE_ERROR.
ENDIF.

ENDFORM.                    " POPUP_TO_CONFIRM
*&---------------------------------------------------------------------*
*&      Form  CHECK_COMPARE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_COMPARE .

DATA: L_STATUS TYPE X,
L_X TYPE X.

CLEAR RC_CODE.
PERFORM GET_STATUS CHANGING L_STATUS.
IF L_STATUS <> C_STATUS_NO_DATA.
RC_CODE = C_STATUS_NO_DATA.
MESSAGE I781.
ENDIF.

ENDFORM.                    " CHECK_COMPARE
*&---------------------------------------------------------------------*
*&      Form  CHECK_TARGET_IS_EXIST
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_TARGET_IS_EXIST .

CLEAR RC_CODE.
IF COUNTER = 0.
RC_CODE = C_RC_CODE_ERROR.
MESSAGE I762.
ENDIF.

* elematec 対応 2011/12/22 ADD >>>
DATA:LT_COMPARE_1   TYPE STANDARD TABLE OF TYP_COMPARE,
LW_COMPARE_1   LIKE LINE OF LT_COMPARE_1.

* 自社データなし部分照合不可ﾁｪｯｸがONの状態
IF P_NOTP = C_ON.
LT_COMPARE_1[] = T_COMPARE_1[].
*   部分照合データで部分照合差分結果（差額）が0の場合はエラー
READ TABLE LT_COMPARE_1 TRANSPORTING NO FIELDS
WITH KEY  YNKNETXAMT = 0
POINT_COMPARE = C_ON.
IF SY-SUBRC = 0.
RC_CODE = C_RC_CODE_ERROR.
MESSAGE I911.
ENDIF.
ENDIF.
* elematec 対応 2011/12/22 ADD <<<

ENDFORM.                    " CHECK_TARGET_IS_EXIST
*&---------------------------------------------------------------------*
*&      Form  CHECK_DESELECT_TARGET
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM CHECK_DESELECT_TARGET .

DATA: L_STATUS TYPE X,
L_X TYPE X.

CLEAR RC_CODE.
PERFORM GET_STATUS CHANGING L_STATUS.
IF L_STATUS = C_STATUS_NO_DATA.
RC_CODE = C_STATUS_NO_DATA.
MESSAGE I762.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_DELETED_DATA.
IF L_X = C_STATUS_DELETED_DATA.
RC_CODE = C_STATUS_DELETED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_AUTO_COMPARED_DATA.
IF L_X = C_STATUS_AUTO_COMPARED_DATA.
RC_CODE = C_STATUS_AUTO_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.
L_X = L_STATUS BIT-AND C_STATUS_MANUAL_COMPARED_DATA.
IF L_X = C_STATUS_MANUAL_COMPARED_DATA.
RC_CODE = C_STATUS_MANUAL_COMPARED_DATA.
MESSAGE I783.
EXIT.
ENDIF.

ENDFORM.                    " CHECK_DESELECT_TARGET
*&---------------------------------------------------------------------*
*&      Form  POPUP_TO_INFORM
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_MSGNO  text
*----------------------------------------------------------------------*
FORM POPUP_TO_INFORM  USING    P_MSGNO.

DATA: L_TEXT TYPE STRING.

CLEAR RC_CODE.
MESSAGE ID 'YN01' TYPE 'S' NUMBER P_MSGNO
INTO L_TEXT WITH COUNTER.
CALL FUNCTION 'POPUP_TO_DISPLAY_TEXT'
EXPORTING
TEXTLINE1 = L_TEXT.
RC_CODE = SY-SUBRC.

ENDFORM.                    " POPUP_TO_INFORM
*&---------------------------------------------------------------------*
*&      Form  GET_NEXT_SLPDOC
*&---------------------------------------------------------------------*
*       外部番号採番
*----------------------------------------------------------------------*
*      -->P_BUKRS   会社コード
*      -->P_GJAHR   会計年度
*      <--P_SLPDOC  外部番号
*----------------------------------------------------------------------*
FORM GET_NEXT_SLPDOC  USING    P_BUKRS
P_GJAHR
CHANGING P_SLPDOC.

DATA: L_RANGE_NR LIKE INRI-NRRANGENR,
L_OBJECT LIKE INRI-OBJECT.

CLEAR P_SLPDOC.
L_RANGE_NR = C_KUBUN_EXTERNAL.
CONCATENATE 'YNOUTDOC' P_MODE INTO L_OBJECT.
CALL FUNCTION 'NUMBER_GET_NEXT'
EXPORTING
NR_RANGE_NR             = L_RANGE_NR
OBJECT                  = L_OBJECT
QUANTITY                = '1'
SUBOBJECT               = P_BUKRS
TOYEAR                  = P_GJAHR
IMPORTING
NUMBER                  = P_SLPDOC
EXCEPTIONS
INTERVAL_NOT_FOUND      = 1
NUMBER_RANGE_NOT_INTERN = 2
OBJECT_NOT_FOUND        = 3
QUANTITY_IS_0           = 4
QUANTITY_IS_NOT_1       = 5
INTERVAL_OVERFLOW       = 6
BUFFER_OVERFLOW         = 7
OTHERS                  = 8.
IF SY-SUBRC <> 0.
CLEAR P_SLPDOC.
ENDIF.

ENDFORM.                    " GET_NEXT_SLPDOC
*&---------------------------------------------------------------------*
*&      Form  LOCK_YN110
*&---------------------------------------------------------------------*
*       外部データテーブルロック
*----------------------------------------------------------------------*
*  -->  P_BUKRS        会社コード
*  <--  P_VRFCTON      取引先コード
*----------------------------------------------------------------------*
FORM LOCK_YN110 USING    P_BUKRS
P_VRFCTON .

CLEAR RC_CODE.
CALL FUNCTION 'ENQUEUE_EY_YN110'
EXPORTING
VRFCTON        = P_VRFCTON
BUKRS          = P_BUKRS
_SCOPE         = C_SCOPE_THREE
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
YNTEXT = SY-MSGV1.
IF SY-SUBRC <> 0.
RC_CODE = SY-SUBRC.
ENDIF.

ENDFORM.                    " LOCK_YN110
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_YN110
*&---------------------------------------------------------------------*
*       外部データテーブルロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_YN110 .

CALL FUNCTION 'DEQUEUE_EY_YN110'
.

ENDFORM.                    " UNLOCK_YN110
*&---------------------------------------------------------------------*
*&      Form  LOCK_YN210
*&---------------------------------------------------------------------*
*       外部データテーブルロック
*----------------------------------------------------------------------*
*  -->  P_BUKRS        会社コード
*  <--  P_VRFCTON      取引先コード
*----------------------------------------------------------------------*
FORM LOCK_YN210 USING    P_BUKRS
P_VRFCTON .

CLEAR RC_CODE.
CALL FUNCTION 'ENQUEUE_EY_YN210'
EXPORTING
VRFCTON        = P_VRFCTON
BUKRS          = P_BUKRS
_SCOPE         = C_SCOPE_THREE
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
YNTEXT = SY-MSGV1.
IF SY-SUBRC <> 0.
RC_CODE = SY-SUBRC.
ENDIF.

ENDFORM.                    " LOCK_YN210
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_YN210
*&---------------------------------------------------------------------*
*       外部データテーブルロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_YN210 .

CALL FUNCTION 'DEQUEUE_EY_YN210'
.

ENDFORM.                    " UNLOCK_YN210
*&---------------------------------------------------------------------*
*&      Form  LOCK_YN120
*&---------------------------------------------------------------------*
*       外部データテーブルロック
*----------------------------------------------------------------------*
*  -->  P_BUKRS        会社コード
*  <--  P_VRFCTON      取引先コード
*----------------------------------------------------------------------*
FORM LOCK_YN120 USING    P_BUKRS
P_VRFCTON .

CLEAR RC_CODE.
CALL FUNCTION 'ENQUEUE_EY_YN120'
EXPORTING
VRFCTON        = P_VRFCTON
BUKRS          = P_BUKRS
_SCOPE         = C_SCOPE_THREE
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
YNTEXT = SY-MSGV1.
IF SY-SUBRC <> 0.
RC_CODE = SY-SUBRC.
ENDIF.

ENDFORM.                    " LOCK_YN120
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_YN120
*&---------------------------------------------------------------------*
*       外部データテーブルロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_YN120 .

CALL FUNCTION 'DEQUEUE_EY_YN120'
.

ENDFORM.                    " UNLOCK_YN120
*&---------------------------------------------------------------------*
*&      Form  LOCK_YN220
*&---------------------------------------------------------------------*
*       外部データテーブルロック
*----------------------------------------------------------------------*
*  -->  P_BUKRS        会社コード
*  <--  P_VRFCTON      取引先コード
*----------------------------------------------------------------------*
FORM LOCK_YN220 USING    P_BUKRS
P_VRFCTON .

CLEAR RC_CODE.
CALL FUNCTION 'ENQUEUE_EY_YN220'
EXPORTING
VRFCTON        = P_VRFCTON
BUKRS          = P_BUKRS
_SCOPE         = C_SCOPE_THREE
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.
YNTEXT = SY-MSGV1.
IF SY-SUBRC <> 0.
RC_CODE = SY-SUBRC.
ENDIF.

ENDFORM.                    " LOCK_YN220
*&---------------------------------------------------------------------*
*&      Form  UNLOCK_YN220
*&---------------------------------------------------------------------*
*       外部データテーブルロック解除
*----------------------------------------------------------------------*
FORM UNLOCK_YN220 .

CALL FUNCTION 'DEQUEUE_EY_YN220'
.

ENDFORM.                    " UNLOCK_YN220
*&---------------------------------------------------------------------*
*&      Form  UPDATE_COMMENT
*&---------------------------------------------------------------------*
*       コメント更新
*----------------------------------------------------------------------*
FORM UPDATE_COMMENT .

DATA: LS_GRID_DATA LIKE LINE OF T_CHANGED_COMMENT.
DATA: L_TNAME TYPE STRING.
DATA: L_UPDDAT LIKE SY-DATUM,
L_UPDTIM LIKE SY-UZEIT,
L_UPDUSR LIKE SY-UNAME,
L_UPDPRG LIKE SY-REPID.

CLEAR: COUNTER, RC_CODE.
LOOP AT T_CHANGED_COMMENT INTO LS_GRID_DATA.
CONCATENATE 'YN' P_MODE LS_GRID_DATA-YNKUBUN INTO L_TNAME.
L_UPDDAT = SY-DATUM.
L_UPDTIM = SY-UZEIT.
L_UPDUSR = SY-UNAME.
L_UPDPRG = SY-REPID.
CASE P_MODE.
WHEN C_MODE_SALES.
CASE LS_GRID_DATA-YNKUBUN.
WHEN C_KUBUN_EXTERNAL.
UPDATE YN110
SET COMMT = LS_GRID_DATA-YNSGTXT
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
WHEN C_KUBUN_INTERNAL.
UPDATE YN120
SET COMMT = LS_GRID_DATA-YNSGTXT
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR2
AND SLPDOC = LS_GRID_DATA-YNSLPDOC2
AND DTLDOC = LS_GRID_DATA-YNDTLDOC2
.
ENDCASE.
WHEN C_MODE_PURCHASE.
CASE LS_GRID_DATA-YNKUBUN.
WHEN C_KUBUN_EXTERNAL.
UPDATE YN210
SET COMMT = LS_GRID_DATA-YNSGTXT
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
WHEN C_KUBUN_INTERNAL.
UPDATE YN220
SET COMMT = LS_GRID_DATA-YNSGTXT
UPDDAT = L_UPDDAT
UPDTIM = L_UPDTIM
UPDUSR = L_UPDUSR
UPDPRG = L_UPDPRG
WHERE GJAHR = LS_GRID_DATA-YNGJAHR2
AND SLPDOC = LS_GRID_DATA-YNSLPDOC2
AND DTLDOC = LS_GRID_DATA-YNDTLDOC2
.
ENDCASE.
ENDCASE.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I758 WITH L_TNAME.
EXIT.
ELSE.
ADD 1 TO COUNTER.
LS_GRID_DATA-YNUPDDAT = L_UPDDAT.
LS_GRID_DATA-YNUPDTIM = L_UPDTIM.
LS_GRID_DATA-YNUPDUSR = L_UPDUSR.
LS_GRID_DATA-YNUPDPRG = L_UPDPRG.
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA
TRANSPORTING YNUPDDAT YNUPDTIM YNUPDUSR YNUPDPRG
WHERE YNGJAHR1  = LS_GRID_DATA-YNGJAHR1
AND YNSLPDOC1 = LS_GRID_DATA-YNSLPDOC1
AND YNDTLDOC1 = LS_GRID_DATA-YNDTLDOC1
AND YNGJAHR2  = LS_GRID_DATA-YNGJAHR2
AND YNSLPDOC2 = LS_GRID_DATA-YNSLPDOC2
AND YNDTLDOC2 = LS_GRID_DATA-YNDTLDOC2.
ENDIF.
ENDLOOP.

CHECK RC_CODE = 0.
COMMIT WORK AND WAIT.
REFRESH T_CHANGED_COMMENT.
PERFORM REFRESH_ALV_GRID_0100.

ENDFORM.                    " UPDATE_COMMENT
*&---------------------------------------------------------------------*
*&      Form  SET_T_CHANGED_COMMENT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->PT_GOOD_CELLS  text
*----------------------------------------------------------------------*
FORM SET_T_CHANGED_COMMENT
USING P_OBJ_DATA_CHANGED TYPE REF TO CL_ALV_CHANGED_DATA_PROTOCOL.

DATA: LS_GRID_DATA LIKE LINE OF T_CHANGED_COMMENT.
DATA: L_MOD_CELLS TYPE LVC_S_MODI.

* elematec 対応 2011/12/22 ADD >>>
DATA:LW_AMOUNT(8)      TYPE P DECIMALS 2,
LW_AMOUNT_INT(8)  TYPE P DECIMALS 2,
LW_TYPE           TYPE DATATYPE_D,
LW_TABIX          TYPE SY-TABIX,
LW_VALUE_CONDENSE TYPE LVC_VALUE,
LS_CELL2          TYPE LVC_S_MODI.

TYPES:LTYP_GRID_DATA_0100 TYPE STANDARD TABLE OF TYP_GRID_DATA_0100.
FIELD-SYMBOLS:<F_GRID_0100>  TYPE LTYP_GRID_DATA_0100, "内部テーブル
<FL_GRID_0100> TYPE TYP_GRID_DATA_0100.  "構造
CLEAR:GT_CHANGE_CELL.

* 一覧データの読み込み
ASSIGN TABLE FIELD
P_OBJ_DATA_CHANGED->MP_MOD_ROWS->* to <F_GRID_0100>.
* elematec 対応 2011/12/22 ADD <<<

LOOP AT P_OBJ_DATA_CHANGED->MT_MOD_CELLS INTO L_MOD_CELLS.
* elematec 対応 2011/12/22 ADD >>>
AT NEW ROW_ID.
LW_TABIX = LW_TABIX + 1.
ENDAT.

IF L_MOD_CELLS-FIELDNAME = 'YNKNETXAMT4'.

READ TABLE <F_GRID_0100> ASSIGNING <FL_GRID_0100>
INDEX LW_TABIX.


***↓ココカラ↓
* 入力した際に通貨コード"JPY"にもかかわらず、内部テーブルの値が
* 円内部換算されないため
* 金額項目が入力された場合に通貨変数から値を入れなおす
*   力された値が数値かどうかのチェックを行う
LW_VALUE_CONDENSE = L_MOD_CELLS-VALUE.
TRANSLATE LW_VALUE_CONDENSE USING '- '.
*    CONDENSE LW_VALUE_CONDENSE NO-GAPS.
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN = LW_VALUE_CONDENSE
IMPORTING
HTYPE     = LW_TYPE.
IF LW_TYPE = 'NUMC'.
LW_AMOUNT = L_MOD_CELLS-VALUE.
*     通貨内部換算
PERFORM CURRENCY_INTERNAL USING 'JPY'
LW_AMOUNT
CHANGING LW_AMOUNT_INT.
<FL_GRID_0100>-YNKNETXAMT4 = LW_AMOUNT_INT.
ENDIF.
*入力した際に通貨コード"JPY"にもかかわらず、内部テーブルの値が
* 円内部換算されないため
* 金額項目が入力された場合に通貨変数から値を入れなおす
***↑ココマデ↑

*   部分照合差分結果（差額）の計算
<FL_GRID_0100>-YNKNETXAMT5 = <FL_GRID_0100>-YNKNETXAMT3 -
<FL_GRID_0100>-YNKNETXAMT4.
*   更新を有効にするデータを作成
LS_CELL2 = L_MOD_CELLS.
LS_CELL2-FIELDNAME = 'YNKNETXAMT5'.
LS_CELL2-VALUE = <FL_GRID_0100>-YNKNETXAMT5.
CONDENSE LS_CELL2-VALUE NO-GAPS.
APPEND LS_CELL2 TO GT_CHANGE_CELL.
ENDIF.

*    WHERE FIELDNAME = 'YNSGTXT'.
*    CLEAR LS_GRID_DATA.
*    CALL METHOD P_OBJ_DATA_CHANGED->GET_CELL_VALUE
*      EXPORTING
*        I_ROW_ID    = L_MOD_CELLS-ROW_ID
*        I_FIELDNAME = 'YNGJAHR1'
*      IMPORTING
*        E_VALUE     = LS_GRID_DATA-YNGJAHR1.
*    CALL METHOD P_OBJ_DATA_CHANGED->GET_CELL_VALUE
*      EXPORTING
*        I_ROW_ID    = L_MOD_CELLS-ROW_ID
*        I_FIELDNAME = 'YNSLPDOC1'
*      IMPORTING
*        E_VALUE     = LS_GRID_DATA-YNSLPDOC1.
*    CALL METHOD P_OBJ_DATA_CHANGED->GET_CELL_VALUE
*      EXPORTING
*        I_ROW_ID    = L_MOD_CELLS-ROW_ID
*        I_FIELDNAME = 'YNDTLDOC1'
*      IMPORTING
*        E_VALUE     = LS_GRID_DATA-YNDTLDOC1.
*    CALL METHOD P_OBJ_DATA_CHANGED->GET_CELL_VALUE
*      EXPORTING
*        I_ROW_ID    = L_MOD_CELLS-ROW_ID
*        I_FIELDNAME = 'YNGJAHR2'
*      IMPORTING
*        E_VALUE     = LS_GRID_DATA-YNGJAHR2.
*    CALL METHOD P_OBJ_DATA_CHANGED->GET_CELL_VALUE
*      EXPORTING
*        I_ROW_ID    = L_MOD_CELLS-ROW_ID
*        I_FIELDNAME = 'YNSLPDOC2'
*      IMPORTING
*        E_VALUE     = LS_GRID_DATA-YNSLPDOC2.
*    CALL METHOD P_OBJ_DATA_CHANGED->GET_CELL_VALUE
*      EXPORTING
*        I_ROW_ID    = L_MOD_CELLS-ROW_ID
*        I_FIELDNAME = 'YNDTLDOC2'
*      IMPORTING
*        E_VALUE     = LS_GRID_DATA-YNDTLDOC2.
*    DELETE T_CHANGED_COMMENT
*      WHERE YNGJAHR1  = LS_GRID_DATA-YNGJAHR1
*        AND YNSLPDOC1 = LS_GRID_DATA-YNSLPDOC1
*        AND YNDTLDOC1 = LS_GRID_DATA-YNDTLDOC1
*        AND YNGJAHR2  = LS_GRID_DATA-YNGJAHR2
*        AND YNSLPDOC2 = LS_GRID_DATA-YNSLPDOC2
*        AND YNDTLDOC2 = LS_GRID_DATA-YNDTLDOC2.
*    LS_GRID_DATA-YNSGTXT = L_MOD_CELLS-VALUE.
*    IF NOT LS_GRID_DATA-YNSLPDOC1 IS INITIAL.
*      LS_GRID_DATA-YNKUBUN = C_KUBUN_EXTERNAL.
*    ELSE.
*      LS_GRID_DATA-YNKUBUN = C_KUBUN_INTERNAL.
*    ENDIF.
*    APPEND LS_GRID_DATA TO T_CHANGED_COMMENT.
* elematec 対応 2011/12/22 ADD <<<
ENDLOOP.

ENDFORM.                    " SET_T_CHANGED_COMMENT
*&---------------------------------------------------------------------*
*&      Form  INSERT_YN_10
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_GRID_DATA_0200  text
*      -->P_SLPDOC  text
*      -->P_DTLDOC  text
*----------------------------------------------------------------------*
FORM INSERT_YN_10  USING    P_GRID_DATA_0200 TYPE TYP_GRID_DATA_0200
P_SLPDOC
P_DTLDOC.

DATA: L_TNAME(10) TYPE C.
DATA: L_S_YN_10 LIKE YN110.

* elematec 対応 2011/12/07 ADD >>>
* 前ゼロ埋め用
DATA: L_CHAR10    TYPE CHAR10.
* elematec 対応 2011/12/07 ADD <<<

CLEAR RC_CODE.
CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
L_S_YN_10-MANDT = SY-MANDT.
L_S_YN_10-GJAHR = P_GRID_DATA_0200-YNGJAHR.
L_S_YN_10-SLPDOC = P_SLPDOC.
L_S_YN_10-DTLDOC = P_DTLDOC.
L_S_YN_10-BUKRS = P_GRID_DATA_0200-YNBUKRS.
L_S_YN_10-VRFCTON = P_GRID_DATA_0200-YNVRFCTON.
L_S_YN_10-ZFBDT = P_GRID_DATA_0200-YNZFBDT.
L_S_YN_10-PRCTR = P_GRID_DATA_0200-YNPRCTR.
L_S_YN_10-PERNR = P_GRID_DATA_0200-YNPERNR.
L_S_YN_10-DVSON = P_GRID_DATA_0200-YNDVSON.
L_S_YN_10-COMMT = P_GRID_DATA_0200-YNSGTXT.
L_S_YN_10-KNQUAN = P_GRID_DATA_0200-YNKNQUAN.
L_S_YN_10-KNUNIT = P_GRID_DATA_0200-YNKNUNIT.
L_S_YN_10-KNUNTPRC = P_GRID_DATA_0200-YNKNUNTPRC.
L_S_YN_10-KNTAXAMT = P_GRID_DATA_0200-YNKNTAXAMT.
L_S_YN_10-KNITXAMT = P_GRID_DATA_0200-YNKNITXAMT.
L_S_YN_10-KNETXAMT = P_GRID_DATA_0200-YNKNETXAMT.
L_S_YN_10-WAERS = P_GRID_DATA_0200-YNWAERS.
L_S_YN_10-OLDGJAHR = P_GRID_DATA_0200-YNOLDGJAHR.
L_S_YN_10-OLDSLPDOC = P_GRID_DATA_0200-YNOLDSLPDOC.
L_S_YN_10-OLDDTLDOC = P_GRID_DATA_0200-YNOLDDTLDOC.
L_S_YN_10-CKEY1 = P_GRID_DATA_0200-YNCKEY1.
L_S_YN_10-CKEY2 = P_GRID_DATA_0200-YNCKEY2.
L_S_YN_10-CKEY3 = P_GRID_DATA_0200-YNCKEY3.
L_S_YN_10-CKEY4 = P_GRID_DATA_0200-YNCKEY4.
L_S_YN_10-CKEY5 = P_GRID_DATA_0200-YNCKEY5.
L_S_YN_10-CKEY6 = P_GRID_DATA_0200-YNCKEY6.
L_S_YN_10-CKEY7 = P_GRID_DATA_0200-YNCKEY7.
L_S_YN_10-CKEY8 = P_GRID_DATA_0200-YNCKEY8.
* elematec 対応 2011/12/07 ADD >>>
* 受注先に前ゼロを埋める
L_CHAR10 = P_GRID_DATA_0200-YNLIST1+0(10).
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = L_CHAR10
IMPORTING
OUTPUT        = L_CHAR10.

L_S_YN_10-LIST1 = L_CHAR10.
*  L_S_YN_10-LIST1 = P_GRID_DATA_0200-YNLIST1.
* elematec 対応 2011/12/07 ADD <<<
L_S_YN_10-LIST2 = P_GRID_DATA_0200-YNLIST2.
L_S_YN_10-LIST3 = P_GRID_DATA_0200-YNLIST3.
L_S_YN_10-LIST4 = P_GRID_DATA_0200-YNLIST4.
L_S_YN_10-LIST5 = P_GRID_DATA_0200-YNLIST5.
L_S_YN_10-LIST6 = P_GRID_DATA_0200-YNLIST6.
L_S_YN_10-LIST7 = P_GRID_DATA_0200-YNLIST7.
L_S_YN_10-LIST8 = P_GRID_DATA_0200-YNLIST8.
L_S_YN_10-LIST9 = P_GRID_DATA_0200-YNLIST9.
L_S_YN_10-LIST10 = P_GRID_DATA_0200-YNLIST10.
L_S_YN_10-CSTS = C_CSTS_INIT.
L_S_YN_10-UPDDAT = SY-DATUM.
L_S_YN_10-UPDTIM = SY-UZEIT.
L_S_YN_10-UPDUSR = SY-UNAME.
L_S_YN_10-UPDPRG = SY-REPID.
* elematec 対応 2011/12/07 ADD >>>
L_S_YN_10-LDATE1 = P_GRID_DATA_0200-YNLDATE1. "請求日/検収日
L_S_YN_10-INSDT  = SY-DATUM.                  "登録日
* elematec 対応 2011/12/07 ADD <<<
INSERT INTO (L_TNAME) VALUES L_S_YN_10.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_DB_ERROR.
MESSAGE I758 WITH L_TNAME.
ENDIF.
MOVE L_S_YN_10 TO YN110.

ENDFORM.                    " INSERT_YN_10
*&---------------------------------------------------------------------*
*&      Form  SET_T_LOG_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM SET_T_LOG_DATA USING    P_FIELDNAME
P_ROW_ID
P_MSGNO
P_MSGV1
P_MSGV2.

DATA: LS_LOG_DATA LIKE LINE OF T_LOG_DATA,
LS_FCAT LIKE LINE OF T_FCAT_0200,
LS_GRID_DATA LIKE LINE OF T_ALV_CHECKER_0200.
DATA: L_MSGV1 LIKE SY-MSGV1,
L_MSGV2 LIKE SY-MSGV2,
L_TEXT LIKE LS_FCAT-COLTEXT.

FIELD-SYMBOLS: <FS_VALUE>.

LS_LOG_DATA-FIELDNAME = P_FIELDNAME.
LS_LOG_DATA-ROW_ID = P_ROW_ID.
READ TABLE T_FCAT_0200 INTO LS_FCAT
WITH KEY FIELDNAME = P_FIELDNAME.
IF SY-SUBRC = 0.
L_TEXT = LS_FCAT-COLTEXT.
LS_LOG_DATA-COLTEXT = L_TEXT.
LS_LOG_DATA-COL_ID = LS_FCAT-COL_ID.
ENDIF.
* elematec 対応 2011/12/07 ADD >>>
* 行追加ボタン＋エラー時の行指定修正
*  READ TABLE T_ALV_CHECKER_0200 INTO LS_GRID_DATA
*    WITH KEY LINNO = P_ROW_ID.
READ TABLE T_ALV_CHECKER_0200 INTO LS_GRID_DATA
WITH KEY ROW_ID = P_ROW_ID.
* elematec 対応 2011/12/07 ADD <<<
IF SY-SUBRC = 0.
ASSIGN COMPONENT P_FIELDNAME OF STRUCTURE LS_GRID_DATA
TO <FS_VALUE>.
ENDIF.
LS_LOG_DATA-MSGTYP = '1'.
CASE P_MSGV1.
WHEN 'NAME'.
L_MSGV1 = P_FIELDNAME.
WHEN 'TEXT'.
L_MSGV1 = L_TEXT.
WHEN 'VALUE'.
L_MSGV1 = <FS_VALUE>.
WHEN OTHERS.
L_MSGV1 = P_MSGV1.
ENDCASE.
CASE P_MSGV2.
WHEN 'NAME'.
L_MSGV2 = P_FIELDNAME.
WHEN 'TEXT'.
L_MSGV2 = L_TEXT.
WHEN 'VALUE'.
L_MSGV2 = <FS_VALUE>.
WHEN OTHERS.
L_MSGV2 = P_MSGV2.
ENDCASE.
MESSAGE ID 'YN01' TYPE 'E' NUMBER P_MSGNO
INTO LS_LOG_DATA-MESSAGE
WITH L_MSGV1 L_MSGV2.
APPEND LS_LOG_DATA TO T_LOG_DATA.

ENDFORM.                    " SET_T_FCAT_LOG
*&---------------------------------------------------------------------*
*&      Form  SET_SELECTED_CELL_0200
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ROW_ID  text
*----------------------------------------------------------------------*
FORM SET_SELECTED_CELL_0200  USING    P_ROW_ID.

DATA: LS_LOG_DATA LIKE LINE OF T_LOG_DATA.

READ TABLE T_LOG_DATA INTO LS_LOG_DATA INDEX P_ROW_ID.
IF SY-SUBRC = 0.
PERFORM SET_CELL_FOCUS  USING    OBJ_GRID_0200
LS_LOG_DATA-ROW_ID
LS_LOG_DATA-FIELDNAME.
ENDIF.

ENDFORM.                    " SET_SELECTED_CELL_0200
*&---------------------------------------------------------------------*
*&      Form  SET_CELL_FOCUS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_ROW_ID  text
*----------------------------------------------------------------------*
FORM SET_CELL_FOCUS  USING    PO_ALV TYPE REF TO CL_GUI_ALV_GRID
P_ROW_ID
P_FIELDNAME.

DATA: LS_CELL TYPE LVC_S_CELL.

LS_CELL-ROW_ID-INDEX = P_ROW_ID.
LS_CELL-COL_ID-FIELDNAME = P_FIELDNAME.
CALL METHOD PO_ALV->SET_CURRENT_CELL_VIA_ID
EXPORTING
IS_ROW_ID    = LS_CELL-ROW_ID
IS_COLUMN_ID = LS_CELL-COL_ID.
CALL METHOD PO_ALV->SELECT_TEXT_IN_CURR_CELL.
CALL METHOD CL_GUI_CONTROL=>SET_FOCUS
EXPORTING
CONTROL = PO_ALV.
CALL METHOD CL_GUI_CFW=>FLUSH.

ENDFORM.                    " SET_CELL_FOCUS
*&---------------------------------------------------------------------*
*&      Form  UPDATE_COMPARE_STATUS
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM UPDATE_COMPARE_STATUS .

DATA: LS_GRID_DATA LIKE LINE OF T_GRID_DATA_0100.
DATA: LS_COMPARE TYPE TYP_COMPARE,
LS_COUNTER LIKE LINE OF T_COMPARE_COUNTER.
DATA: L_TNAME TYPE STRING,
L_ROW_ID LIKE SY-TABIX.

DATA: LT_CELLS TYPE LVC_T_MODI,
LS_CELLS TYPE LVC_S_MODI.

* elematec 対応 2011/12/07 ADD >>>
DATA:LW_CZFBDT   TYPE ZNECZFBDT.
* elematec 対応 2011/12/07 ADD <<<

CLEAR RC_CODE.
REFRESH T_COMPARE_COUNTER.

CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
LOOP AT T_COMPARE_1 INTO LS_COMPARE.

CLEAR LS_COUNTER.
LS_COUNTER-BUKRS = LS_COMPARE-YNBUKRS.
LS_COUNTER-VRFCTON = LS_COMPARE-YNVRFCTON.

LOOP AT T_GRID_DATA_0100 INTO LS_GRID_DATA
WHERE YNBUKRS   = LS_COMPARE-YNBUKRS
AND YNVRFCTON = LS_COMPARE-YNVRFCTON
AND YNKUBUN = C_KUBUN_EXTERNAL
AND YNTGTFLG = C_ON
AND YNDELFLG = C_OFF
AND YNCSTS <> C_CSTS_OK_MANUAL
AND YNCSTS <> C_CSTS_OK_AUTO.

L_ROW_ID = SY-TABIX.
LS_GRID_DATA-YNCSTS = LS_COMPARE-YNCSTS.
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
LS_GRID_DATA-YNCHKDOC = LS_COMPARE-YNCHKDOC.
LS_GRID_DATA-YNCHKDAT = LS_COMPARE-YNCHKDAT.
LS_GRID_DATA-YNCHKUSR = LS_COMPARE-YNCHKUSR.
*&Ver2 対応 2007/02/28 <<<
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA.
IF LS_GRID_DATA-YNCSTS = C_CSTS_OK.
LS_GRID_DATA-YNTGTFLG = C_OFF.
* elematec 対応 2011/12/07 ADD >>>
LW_CZFBDT = P_CZFBDT.        "照合締日
* elematec 対応 2011/12/07 ADD <<<
ELSE.
LS_GRID_DATA-YNTGTFLG = C_ON.
* elematec 対応 2011/12/07 ADD >>>
CLEAR:LW_CZFBDT.             "照合締日
* elematec 対応 2011/12/07 ADD <<<
ENDIF.

CASE P_MODE.
WHEN C_MODE_SALES.
UPDATE YN110
SET CSTS = LS_GRID_DATA-YNCSTS
TGTFLG = LS_GRID_DATA-YNTGTFLG
UPDDAT = SY-DATUM
UPDTIM = SY-UZEIT
UPDUSR = SY-UNAME
UPDPRG = SY-REPID
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
CHKDOC = LS_GRID_DATA-YNCHKDOC
CHKDAT = LS_GRID_DATA-YNCHKDAT
CHKUSR = LS_GRID_DATA-YNCHKUSR
*&Ver2 対応 2007/02/28 <<<
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
WHEN C_MODE_PURCHASE.
UPDATE YN210
SET CSTS = LS_GRID_DATA-YNCSTS
TGTFLG = LS_GRID_DATA-YNTGTFLG
UPDDAT = SY-DATUM
UPDTIM = SY-UZEIT
UPDUSR = SY-UNAME
UPDPRG = SY-REPID
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
CHKDOC = LS_GRID_DATA-YNCHKDOC
CHKDAT = LS_GRID_DATA-YNCHKDAT
CHKUSR = LS_GRID_DATA-YNCHKUSR
*&Ver2 対応 2007/02/28 <<<
* elematec 対応 2011/12/07 ADD >>>
CZFBDT = LW_CZFBDT          "照合締日
* elematec 対応 2011/12/07 ADD <<<
WHERE GJAHR = LS_GRID_DATA-YNGJAHR1
AND SLPDOC = LS_GRID_DATA-YNSLPDOC1
AND DTLDOC = LS_GRID_DATA-YNDTLDOC1
.
ENDCASE.
IF SY-SUBRC = 0.
LS_CELLS-ROW_ID = L_ROW_ID.
LS_CELLS-FIELDNAME = 'YNCSTSTXT'.
PERFORM GET_DOMAIN_VALUE USING    LS_GRID_DATA-YNCSTS
C_DOMAIN_NAME_CSTS
CHANGING LS_GRID_DATA-YNCSTSTXT.
LS_CELLS-VALUE = LS_GRID_DATA-YNCSTSTXT.
APPEND LS_CELLS TO LT_CELLS.
IF LS_GRID_DATA-YNTGTFLG = C_OFF.
LS_CELLS-ROW_ID = L_ROW_ID.
LS_CELLS-FIELDNAME = 'YNTGTFLG'.
LS_CELLS-VALUE = C_OFF.
APPEND LS_CELLS TO LT_CELLS.
ENDIF.
ELSE.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_ERROR.
MESSAGE I758 WITH L_TNAME.
EXIT.
ENDIF.

ADD 1 TO LS_COUNTER-TOTAL.
CASE LS_GRID_DATA-YNCSTS.
WHEN C_CSTS_OK.
ADD 1 TO LS_COUNTER-OK.
LS_GRID_DATA-YNTGTFLG = C_OFF.
* elematec 対応 2011/12/22 ADD >>>
*         部分照合残額が入力されている場合
IF LS_GRID_DATA-YNKNETXAMT4 <> 0.
ADD 1 TO LS_COUNTER-POINT_COMPARE.      "部分照合件数 +１
ENDIF.
* elematec 対応 2011/12/22 ADD <<<
WHEN C_CSTS_NO_EXTERNAL.
ADD 1 TO LS_COUNTER-NO_EXTERNAL.
WHEN C_CSTS_NO_INTERNAL.
ADD 1 TO LS_COUNTER-NO_INTERNAL.
WHEN C_CSTS_DIFFERENT_QUANTITY.
ADD 1 TO LS_COUNTER-DIFFERENT_QUANTITY.
WHEN C_CSTS_DIFFERENT_PRICE.
ADD 1 TO LS_COUNTER-DIFFERENT_PRICE.
ENDCASE.

ENDLOOP.

COLLECT LS_COUNTER INTO T_COMPARE_COUNTER.

ENDLOOP.

CHECK RC_CODE = 0.

CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.
LOOP AT T_COMPARE_2 INTO LS_COMPARE.

CLEAR LS_COUNTER.
LS_COUNTER-BUKRS = LS_COMPARE-YNBUKRS.
LS_COUNTER-VRFCTON = LS_COMPARE-YNVRFCTON.

LOOP AT T_GRID_DATA_0100 INTO LS_GRID_DATA
WHERE YNBUKRS   = LS_COMPARE-YNBUKRS
AND YNVRFCTON = LS_COMPARE-YNVRFCTON
AND YNKUBUN = C_KUBUN_INTERNAL
AND YNTGTFLG = C_ON
AND YNDELFLG = C_OFF
AND YNCSTS <> C_CSTS_OK_MANUAL
AND YNCSTS <> C_CSTS_OK_AUTO.

L_ROW_ID = SY-TABIX.
LS_GRID_DATA-YNCSTS = LS_COMPARE-YNCSTS.
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
LS_GRID_DATA-YNCHKDOC = LS_COMPARE-YNCHKDOC.
LS_GRID_DATA-YNCHKDAT = LS_COMPARE-YNCHKDAT.
LS_GRID_DATA-YNCHKUSR = LS_COMPARE-YNCHKUSR.
*&Ver2 対応 2007/02/28 <<<
MODIFY T_GRID_DATA_0100 FROM LS_GRID_DATA.
IF LS_GRID_DATA-YNCSTS = C_CSTS_OK.
LS_GRID_DATA-YNTGTFLG = C_OFF.
ELSE.
LS_GRID_DATA-YNTGTFLG = C_ON.
ENDIF.

CASE P_MODE.
WHEN C_MODE_SALES.
UPDATE YN120
SET CSTS = LS_GRID_DATA-YNCSTS
TGTFLG = LS_GRID_DATA-YNTGTFLG
UPDDAT = SY-DATUM
UPDTIM = SY-UZEIT
UPDUSR = SY-UNAME
UPDPRG = SY-REPID
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
CHKDOC = LS_GRID_DATA-YNCHKDOC
CHKDAT = LS_GRID_DATA-YNCHKDAT
CHKUSR = LS_GRID_DATA-YNCHKUSR
*&Ver2 対応 2007/02/28 <<<
WHERE GJAHR = LS_GRID_DATA-YNGJAHR2
AND SLPDOC = LS_GRID_DATA-YNSLPDOC2
AND DTLDOC = LS_GRID_DATA-YNDTLDOC2
.
WHEN C_MODE_PURCHASE.
UPDATE YN220
SET CSTS = LS_GRID_DATA-YNCSTS
TGTFLG = LS_GRID_DATA-YNTGTFLG
UPDDAT = SY-DATUM
UPDTIM = SY-UZEIT
UPDUSR = SY-UNAME
UPDPRG = SY-REPID
*&Ver2 対応 2007/02/28 >>> 照合番号/照合日/照合ユーザ追加
CHKDOC = LS_GRID_DATA-YNCHKDOC
CHKDAT = LS_GRID_DATA-YNCHKDAT
CHKUSR = LS_GRID_DATA-YNCHKUSR
*&Ver2 対応 2007/02/28 <<<
* elematec 対応 2011/12/07 ADD >>>
CZFBDT = LW_CZFBDT         "照合締日
* elematec 対応 2011/12/07 ADD <<<
WHERE GJAHR = LS_GRID_DATA-YNGJAHR2
AND SLPDOC = LS_GRID_DATA-YNSLPDOC2
AND DTLDOC = LS_GRID_DATA-YNDTLDOC2
.
ENDCASE.
IF SY-SUBRC = 0.
LS_CELLS-ROW_ID = L_ROW_ID.
LS_CELLS-FIELDNAME = 'YNCSTSTXT'.
PERFORM GET_DOMAIN_VALUE USING    LS_GRID_DATA-YNCSTS
C_DOMAIN_NAME_CSTS
CHANGING LS_GRID_DATA-YNCSTSTXT.
LS_CELLS-VALUE = LS_GRID_DATA-YNCSTSTXT.
APPEND LS_CELLS TO LT_CELLS.
IF LS_GRID_DATA-YNTGTFLG = C_OFF.
LS_CELLS-ROW_ID = L_ROW_ID.
LS_CELLS-FIELDNAME = 'YNTGTFLG'.
LS_CELLS-VALUE = C_OFF.
APPEND LS_CELLS TO LT_CELLS.
ENDIF.
ELSE.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_ERROR.
MESSAGE I758 WITH L_TNAME.
EXIT.
ENDIF.

ADD 1 TO LS_COUNTER-TOTAL.
CASE LS_GRID_DATA-YNCSTS.
WHEN C_CSTS_OK.
ADD 1 TO LS_COUNTER-OK.
LS_GRID_DATA-YNTGTFLG = C_OFF.
* elematec 対応 2011/12/22 ADD >>>
*         部分照合残額が入力されている場合
IF LS_GRID_DATA-YNKNETXAMT4 <> 0.
ADD 1 TO LS_COUNTER-POINT_COMPARE.      "部分照合件数 +１
ENDIF.
* elematec 対応 2011/12/22 ADD <<<
WHEN C_CSTS_NO_EXTERNAL.
ADD 1 TO LS_COUNTER-NO_EXTERNAL.
WHEN C_CSTS_NO_INTERNAL.
ADD 1 TO LS_COUNTER-NO_INTERNAL.
WHEN C_CSTS_DIFFERENT_QUANTITY.
ADD 1 TO LS_COUNTER-DIFFERENT_QUANTITY.
WHEN C_CSTS_DIFFERENT_PRICE.
ADD 1 TO LS_COUNTER-DIFFERENT_PRICE.
ENDCASE.

ENDLOOP.

COLLECT LS_COUNTER INTO T_COMPARE_COUNTER.

ENDLOOP.

ENDFORM.                    " UPDATE_COMPARE_STATUS
*&---------------------------------------------------------------------*
*&      Form  CUSTOMIZE_TOOLBAR_0200
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_E_OBJECT  text
*----------------------------------------------------------------------*
FORM CUSTOMIZE_TOOLBAR_0200
USING P_OBJ_TOOLBAR_SET TYPE REF TO CL_ALV_EVENT_TOOLBAR_SET.

DATA: LS_BUTTON TYPE STB_BUTTON.
*&Ver2 対応 2007/02/28 >>> 外部データ入力の明細コピーボタンの追加
CLEAR LS_BUTTON.
LS_BUTTON-FUNCTION = C_USER_COMMAND_COPY_ROW.
LS_BUTTON-ICON = ICON_COPY_OBJECT.
LS_BUTTON-BUTN_TYPE = 0.
LS_BUTTON-DISABLED = ' '.
LS_BUTTON-QUICKINFO = TEXT-103.
INSERT LS_BUTTON INTO P_OBJ_TOOLBAR_SET->MT_TOOLBAR INDEX 8.
*&Ver2 対応 2007/02/28 <<<

CASE INPUT_MODE.
WHEN C_INPUT_MODE_NEW.
WHEN C_INPUT_MODE_EDIT.
LS_BUTTON-DISABLED = 'X'.
MODIFY P_OBJ_TOOLBAR_SET->MT_TOOLBAR FROM LS_BUTTON
TRANSPORTING DISABLED
WHERE FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_APPEND_ROW
OR FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_INSERT_ROW
OR FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_DELETE_ROW
*&Ver2 対応 2007/02/28 >>> 外部データ入力の明細コピーボタンの追加
*          OR FUNCTION = CL_GUI_ALV_GRID=>MC_FC_LOC_COPY_ROW.
OR FUNCTION = C_USER_COMMAND_COPY_ROW.
*&Ver2 対応 2007/02/28 <<<
ENDCASE.

ENDFORM.                    " CUSTOMIZE_TOOLBAR_0200
*&---------------------------------------------------------------------*
*&      Form  CHECK_DATE
*&---------------------------------------------------------------------*
*       日付妥当性チェック
*----------------------------------------------------------------------*
*      -->P_DAT  日付
*----------------------------------------------------------------------*
FORM CHECK_DATE  USING    P_DAT.

CLEAR RC_CODE.
CALL FUNCTION 'CONVERT_DATE_TO_INTERNAL'
EXPORTING
DATE_EXTERNAL            = P_DAT
EXCEPTIONS
DATE_EXTERNAL_IS_INVALID = 1
OTHERS                   = 2.
IF SY-SUBRC <> 0.
RC_CODE = SY-SUBRC.
ENDIF.

ENDFORM.                    " CHECK_DATE
*&---------------------------------------------------------------------*
*&      Form  CHECK_NUMBER
*&---------------------------------------------------------------------*
*       数値妥当性チェック
*----------------------------------------------------------------------*
*      -->P_VAL   値
*      <--P_RC    リターンコード
*----------------------------------------------------------------------*
FORM CHECK_NUMBER  USING    P_VAL.

DATA: L_VAL(16) TYPE P DECIMALS 5.

CLEAR RC_CODE.
CATCH SYSTEM-EXCEPTIONS CONVT_NO_NUMBER = 1.
L_VAL = P_VAL.
ENDCATCH.
IF SY-SUBRC <> 0.
RC_CODE = SY-SUBRC.
ENDIF.

ENDFORM.                    " CHECK_NUMBER
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_LOG
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM OUTPUT_LOG .

DATA: LS_LOGGER LIKE LINE OF T_COMPARE_LOGGER,
LS_COUNTER LIKE LINE OF T_COMPARE_COUNTER.
DATA: L_LINES TYPE I,
L_SKIP TYPE I.
* elematec 対応 2011/12/22 ADD >>>
DATA: LW_POINT_COMPARE   TYPE TYP_POINT_COMPARE.
* elematec 対応 2011/12/22 ADD <<<

IF P_PG = C_ON.
SKIP.
SKIP.
ENDIF.

* タイトルの出力
PERFORM OUTPUT_TITLE.

DESCRIBE TABLE T_COMPARE_LOGGER LINES L_LINES.
IF L_LINES > 0.
WRITE: /04 TEXT-011,                             "会社コード
15 TEXT-012,                             "取引先コード
28 TEXT-013.                             "エラー内容
ULINE.
L_SKIP = 3.
ELSE.
L_SKIP = 1.
ENDIF.

SORT T_COMPARE_LOGGER BY BUKRS VRFCTON.
LOOP AT T_COMPARE_LOGGER INTO LS_LOGGER.
WRITE: /04 LS_LOGGER-BUKRS,                 "会社コード
15 LS_LOGGER-VRFCTON,               "取引先コード
28 LS_LOGGER-MESSAGE.               "エラー内容
ENDLOOP.

DO L_SKIP TIMES.
SKIP.
ENDDO.

DESCRIBE TABLE T_COMPARE_COUNTER LINES L_LINES.
IF L_LINES > 0.
WRITE: /04 TEXT-021,                             "会社コード
15 TEXT-022,                             "取引先コード
30 TEXT-023,                             "照合件数
* elematec 対応 2011/12/22 ADD >>>
*            39 TEXT-024.                             "エラー件数
39  TEXT-025,                            "部分照合件数
56  TEXT-024.                            "エラー件数
* elematec 対応 2011/12/22 ADD <<<
ULINE.
ENDIF.

SORT T_COMPARE_COUNTER BY BUKRS VRFCTON.
LOOP AT T_COMPARE_COUNTER INTO LS_COUNTER.
COUNTER = LS_COUNTER-DIFFERENT_QUANTITY +
LS_COUNTER-DIFFERENT_PRICE +
LS_COUNTER-NO_EXTERNAL +
LS_COUNTER-NO_INTERNAL.
WRITE: /04  LS_COUNTER-BUKRS,                 "会社コード
15  LS_COUNTER-VRFCTON,               "取引先コード
28  LS_COUNTER-OK,                    "照合件数
* elematec 対応 2011/12/22 ADD >>>
*            39  COUNTER.                          "エラー件数
39  LS_COUNTER-POINT_COMPARE,         "部分照合件数
56  COUNTER.                          "エラー件数
* elematec 対応 2011/12/22 ADD <<<
ENDLOOP.
*照合取消　2009/01/21 ADD-S
IF G_CANCEL_NUMBER_10 <> 0 OR G_CANCEL_NUMBER_20 <> 0 .
WRITE: /04 TEXT-021,                             "会社コード
15 TEXT-022,                             "取引先コード
30 TEXT-M31,                             "照合取消件数（外部
52 TEXT-M32.                             "照合取消件数（自社
ULINE.
WRITE: /04 G_BUKRS,                             "会社コード
15 G_VRFCTON,                           "取引先コード
32 G_CANCEL_NUMBER_10,                  "照合取消件数（外部#
54 G_CANCEL_NUMBER_20.                  "照合取消件数（自社#
ENDIF.
*照合取消　2009/01/21 ADD-E

* elematec 対応 2011/12/22 ADD >>>
IF GT_POINT_COMPARE[] IS INITIAL.
ELSE.
SKIP 1.
WRITE: /04 TEXT-021,                             "会社コード
15 TEXT-022,                             "取引先コード
30 TEXT-026.                             "会計伝票番号
ULINE.
ENDIF.
* 部分照合データ画面出力
LOOP AT GT_POINT_COMPARE INTO LW_POINT_COMPARE.
WRITE: /04 LW_POINT_COMPARE-BUKRS,              "会社コード
15 LW_POINT_COMPARE-VRFCTON,            "取引先コード
30 LW_POINT_COMPARE-BELNR.              "会計伝票番号
ENDLOOP.
* elematec 対応 2011/12/22 ADD <<<

ENDFORM.                    " OUTPUT_LOG
*&---------------------------------------------------------------------*
*&      Form  CHECK_AUTHORITY
*&---------------------------------------------------------------------*
*       権限チェック
*----------------------------------------------------------------------*
*      -->P_BUKRS  会社コード
*----------------------------------------------------------------------*
FORM CHECK_AUTHORITY  USING   P_BUKRS.

DATA: L_OBJECT(10) TYPE C.

CLEAR: RC_CODE.
CASE P_MODE.
WHEN C_MODE_SALES.
L_OBJECT = 'F_KNA1_BUK'.
WHEN C_MODE_PURCHASE.
L_OBJECT = 'F_LFA1_BUK'.
ENDCASE.
AUTHORITY-CHECK OBJECT L_OBJECT
ID 'BUKRS' FIELD P_BUKRS
ID 'ACTVT' DUMMY.
IF SY-SUBRC <> 0.
RC_CODE = C_RC_CODE_NO_AUTHORITY.
ENDIF.

ENDFORM.                    " CHECK_AUTHORITY
*&---------------------------------------------------------------------*
*&      Form  CHECK_AUTHORITY_RANGE
*&---------------------------------------------------------------------*
*       権限チェック
*----------------------------------------------------------------------*
*      -->PT_BUKRS  会社コード
*      <--P_EVAL  text
*----------------------------------------------------------------------*
FORM CHECK_AUTHORITY_RANGE  TABLES   PT_BUKRS
CHANGING L_EVAL.

DATA: LT_BUKRS LIKE STANDARD TABLE OF T001-BUKRS.
DATA: L_OBJECT(10) TYPE C,
L_BUKRS LIKE T001-BUKRS.

CLEAR: RC_CODE, L_EVAL.
SELECT BUKRS INTO TABLE LT_BUKRS
FROM T001
WHERE BUKRS IN PT_BUKRS.
IF SY-SUBRC <> 0.
* 対象データがありません
RC_CODE = C_RC_CODE_NOT_EXIST.
EXIT.
ENDIF.
CASE P_MODE.
WHEN C_MODE_SALES.
L_OBJECT = 'F_KNA1_BUK'.
WHEN C_MODE_PURCHASE.
L_OBJECT = 'F_LFA1_BUK'.
ENDCASE.
LOOP AT LT_BUKRS INTO L_BUKRS.
AUTHORITY-CHECK OBJECT L_OBJECT
ID 'BUKRS' FIELD L_BUKRS
ID 'ACTVT' DUMMY.
IF SY-SUBRC <> 0.
L_EVAL = L_BUKRS.
RC_CODE = C_RC_CODE_NO_AUTHORITY.
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    " CHECK_AUTHORITY_RANGE
*&---------------------------------------------------------------------*
*&      Form  CHECK_VRFCTON_RANGE
*&---------------------------------------------------------------------*
*       取引先コード存在チェック
*----------------------------------------------------------------------*
*      -->PT_VRFCTON  取引先コード
*      <--P_EVAL  text
*----------------------------------------------------------------------*
FORM CHECK_VRFCTON_RANGE  TABLES   PT_VRFCTON
CHANGING P_EVAL.

FIELD-SYMBOLS: <FS1>, <FS2>, <FS3>.

CLEAR: RC_CODE, P_EVAL.
LOOP AT PT_VRFCTON.
ASSIGN COMPONENT 1 OF STRUCTURE PT_VRFCTON TO <FS1>.
ASSIGN COMPONENT 2 OF STRUCTURE PT_VRFCTON TO <FS2>.
CHECK <FS1> = 'I' AND <FS2> = 'EQ'.
ASSIGN COMPONENT 3 OF STRUCTURE PT_VRFCTON TO <FS3>.
* elematec 対応 2011/12/07 ADD >>>
IF <FS3> CA '*'.              "*が含まれている場合
IF P_MODE = C_MODE_SALES.
ELSE.
MESSAGE E902.
ENDIF.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<
PERFORM CHECK_VRFCTON  USING <FS3>.
IF RC_CODE <> 0.
P_EVAL = <FS3>.
EXIT.
ENDIF.
ENDLOOP.
* elematec 対応 2011/12/07 ADD >>>
IF  SY-SUBRC <> 0            "未入力の場合
AND SY-UCOMM+0(1) <> '%'.    "複数入力ボタン押下以外
IF P_MODE = C_MODE_SALES.  "[売上照合]
*      MESSAGE E901 WITH L_EVAL.
ELSE.                      "[仕入照合]
MESSAGE E901 WITH TEXT-050.
ENDIF.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

ENDFORM.                    " CHECK_VRFCTON_RANGE
*&---------------------------------------------------------------------*
*&      Form  CHECK_VRFCTON
*&---------------------------------------------------------------------*
*       取引先コード存在チェック
*----------------------------------------------------------------------*
*      -->P_VRFCTON  取引先コード存在チェック
*----------------------------------------------------------------------*
FORM CHECK_VRFCTON  USING    P_VRFCTON.
* elematec 対応 2011/12/07 ADD >>>
DATA:L_VRFCTON    TYPE CHAR10.

L_VRFCTON = P_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<

**INSERT 20061031 HATTORI
*  CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
*       EXPORTING
*            INPUT  = P_VRFCTON
*       IMPORTING
*            OUTPUT = P_VRFCTON.
**INSERT END
* elematec 対応 2011/12/07 ADD >>>
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = L_VRFCTON
IMPORTING
OUTPUT = L_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<

CLEAR RC_CODE.
IF P_MODE = C_MODE_SALES.
* elematec 対応 2011/12/07 ADD >>>
*    SELECT COUNT(*) INTO COUNTER FROM KNA1 WHERE KUNNR = P_VRFCTON.
SELECT COUNT(*) INTO COUNTER FROM KNA1 WHERE KUNNR = L_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<

ELSE.
* elematec 対応 2011/12/07 ADD >>>
*    SELECT COUNT(*) INTO COUNTER FROM LFA1 WHERE LIFNR = P_VRFCTON.
SELECT COUNT(*) INTO COUNTER FROM LFA1 WHERE LIFNR = L_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<

ENDIF.
IF COUNTER = 0.
RC_CODE = C_RC_CODE_NOT_EXIST.
* elematec 対応 2011/12/07 ADD >>>
ELSE.
P_VRFCTON = L_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<
ENDIF.

ENDFORM.                    " CHECK_VRFCTON
*&---------------------------------------------------------------------*
*&      Form  LOCK_TABLES
*&---------------------------------------------------------------------*
*       テーブルロック
*----------------------------------------------------------------------*
FORM LOCK_TABLES .

*-- 20090113 UPD STA 対象データの取引先のみロック対象とするように修正
*-- ロック用内部テーブル定義
TYPES:BEGIN OF L_T_ENQ_KEY,
BUKRS   LIKE YN110-BUKRS,
VRFCTON LIKE YN110-VRFCTON,
* elematec 対応 2011/12/07 ADD >>>
DVSON   TYPE CHAR4,           "営業所/プラント
* elematec 対応 2011/12/07 ADD <<<
END OF L_T_ENQ_KEY.
DATA:L_WA_ENQ_KEY     TYPE L_T_ENQ_KEY,
* elematec 対応 2011/12/07 ADD >>>
L_TBL_ENQ_KEY_J  TYPE SORTED TABLE OF L_T_ENQ_KEY
WITH NON-UNIQUE KEY BUKRS VRFCTON DVSON,    "自社用
L_TBL_ENQ_KEY_G  TYPE SORTED TABLE OF L_T_ENQ_KEY
WITH NON-UNIQUE KEY BUKRS VRFCTON DVSON.    "外部用
*       L_TBL_ENQ_KEY_J  TYPE SORTED TABLE OF L_T_ENQ_KEY
*                        WITH NON-UNIQUE KEY BUKRS VRFCTON,    "自社用
*       L_TBL_ENQ_KEY_G  TYPE SORTED TABLE OF L_T_ENQ_KEY
*                        WITH NON-UNIQUE KEY BUKRS VRFCTON.    "外部用
* elematec 対応 2011/12/07 ADD <<<

DATA: L_H_YN_10_DATA LIKE LINE OF T_YN_10_DATA,
L_H_YN_20_DATA LIKE LINE OF T_YN_20_DATA.

DATA: L_FUNC_NAME(30) TYPE C,
L_TNAME TYPE STRING.


* elematec 対応 2011/12/07 ADD >>>
*----- 名称取得用
TYPES: BEGIN OF TYP_WERKS_MOTO,
WERKS     TYPE WERKS_D,        "プラント
END   OF TYP_WERKS_MOTO.
TYPES: BEGIN OF TYP_PERNR_MOTO,
PERNR     TYPE CHAR12,         "担当者
END   OF TYP_PERNR_MOTO.

DATA: LW_WERKS_MOTO   TYPE TYP_WERKS_MOTO,
LT_WERKS_MOTO   TYPE SORTED TABLE OF TYP_WERKS_MOTO
WITH NON-UNIQUE KEY WERKS,
LW_PERNR_MOTO   TYPE TYP_PERNR_MOTO,
LT_PERNR_MOTO   TYPE SORTED TABLE OF TYP_PERNR_MOTO
WITH NON-UNIQUE KEY PERNR.
*----- ロック処理用
DATA: LW_LOCK         TYPE TYP_LOCK. "ｲﾝｸﾙｰﾄﾞZN090100内に定義
* elematec 対応 2011/12/07 ADD <<<

REFRESH: L_TBL_ENQ_KEY_J,
L_TBL_ENQ_KEY_G,
T_VRFCTON,
T_PRCTR,
T_XXA1,
T_CEPCT.

* 取得データからロック対象のキーテーブル作成
*-- 自社データ
LOOP AT T_YN_20_DATA INTO L_H_YN_20_DATA.
L_WA_ENQ_KEY-BUKRS   = L_H_YN_20_DATA-YNBUKRS.
* elematec 対応 2011/12/07 ADD >>>
*    L_WA_ENQ_KEY-VRFCTON = L_H_YN_20_DATA-YNVRFCTON.
L_WA_ENQ_KEY-VRFCTON = L_H_YN_20_DATA-YNLIST1.    "受注先
L_WA_ENQ_KEY-DVSON   = L_H_YN_20_DATA-YNDVSON.    "プラント
* elematec 対応 2011/12/07 ADD <<<
INSERT L_WA_ENQ_KEY INTO TABLE L_TBL_ENQ_KEY_J.
*-- 取引先マスタ一括取得用キーテーブル作成
W_XXA1-VRFCTON = L_H_YN_20_DATA-YNVRFCTON.
INSERT W_XXA1 INTO TABLE T_VRFCTON.
* elematec 対応 2011/12/07 ADD >>>
*   仕入先名称取得用に受注先も追加
W_XXA1-VRFCTON = L_H_YN_20_DATA-YNLIST1.    "受注先
INSERT W_XXA1 INTO TABLE T_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<
*-- 利益センタマスタ一括取得用キーテーブル作成
IF L_H_YN_20_DATA-YNPRCTR <> ''.
W_CEPCT-PRCTR = L_H_YN_20_DATA-YNPRCTR.
INSERT W_CEPCT INTO TABLE T_PRCTR.
ENDIF.

* elematec 対応 2011/12/07 ADD >>>
*-- プラント名称一括取得用キーテーブル作成
IF L_H_YN_10_DATA-YNDVSON <> ''.
LW_WERKS_MOTO-WERKS = L_H_YN_20_DATA-YNDVSON.
INSERT LW_WERKS_MOTO INTO TABLE LT_WERKS_MOTO.
ENDIF.
*-- 担当者名称一括取得用キーテーブル作成
IF L_H_YN_10_DATA-YNPERNR <> ''.
LW_PERNR_MOTO-PERNR = L_H_YN_20_DATA-YNPERNR.
INSERT LW_PERNR_MOTO INTO TABLE LT_PERNR_MOTO.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

ENDLOOP.
DELETE ADJACENT DUPLICATES FROM L_TBL_ENQ_KEY_J.

*-- 外部データ
LOOP AT T_YN_10_DATA INTO L_H_YN_10_DATA.
L_WA_ENQ_KEY-BUKRS = L_H_YN_10_DATA-YNBUKRS.
* elematec 対応 2011/12/07 ADD >>>
*    L_WA_ENQ_KEY-VRFCTON = L_H_YN_10_DATA-YNVRFCTON.
L_WA_ENQ_KEY-VRFCTON = L_H_YN_10_DATA-YNLIST1.    "受注先
L_WA_ENQ_KEY-DVSON   = L_H_YN_10_DATA-YNDVSON.    "プラント
* elematec 対応 2011/12/07 ADD <<<
INSERT L_WA_ENQ_KEY INTO TABLE L_TBL_ENQ_KEY_G.
*-- 取引先マスタ一括取得用キーテーブル作成
W_XXA1-VRFCTON = L_H_YN_10_DATA-YNVRFCTON.
INSERT W_XXA1 INTO TABLE T_VRFCTON.
* elematec 対応 2011/12/07 ADD >>>
*   仕入先名称取得用に受注先も追加
W_XXA1-VRFCTON = L_H_YN_10_DATA-YNLIST1.    "受注先
INSERT W_XXA1 INTO TABLE T_VRFCTON.
* elematec 対応 2011/12/07 ADD <<<
*-- 利益センタマスタ一括取得用キーテーブル作成
IF L_H_YN_10_DATA-YNPRCTR <> ''.
W_CEPCT-PRCTR = L_H_YN_10_DATA-YNPRCTR.
INSERT W_CEPCT INTO TABLE T_PRCTR.
ENDIF.

* elematec 対応 2011/12/07 ADD >>>
*-- プラント名称一括取得用キーテーブル作成
IF L_H_YN_10_DATA-YNDVSON <> ''.
LW_WERKS_MOTO-WERKS = L_H_YN_10_DATA-YNDVSON.
INSERT LW_WERKS_MOTO INTO TABLE LT_WERKS_MOTO.
ENDIF.
*-- 担当者名称一括取得用キーテーブル作成
IF L_H_YN_10_DATA-YNPERNR <> ''.
LW_PERNR_MOTO-PERNR = L_H_YN_10_DATA-YNPERNR.
INSERT LW_PERNR_MOTO INTO TABLE LT_PERNR_MOTO.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

ENDLOOP.
DELETE ADJACENT DUPLICATES FROM L_TBL_ENQ_KEY_G.

DELETE ADJACENT DUPLICATES FROM T_VRFCTON.
DELETE ADJACENT DUPLICATES FROM T_PRCTR.
* elematec 対応 2011/12/07 ADD >>>
DELETE ADJACENT DUPLICATES FROM LT_WERKS_MOTO.
DELETE ADJACENT DUPLICATES FROM LT_PERNR_MOTO.
* elematec 対応 2011/12/07 ADD <<<

*-- 取引先マスタ（名称）の取得
* conversion 対応 2010/12/13 UPD >>>
*  IF T_VRFCTON[] IS NOT INITIAL.
IF NOT T_VRFCTON[] IS INITIAL.
* conversion 対応 2010/12/13 UPD <<<
CASE P_MODE.
WHEN '1'.
SELECT KUNNR NAME1 INTO TABLE T_XXA1
FROM KNA1
FOR ALL ENTRIES IN T_VRFCTON
WHERE KUNNR = T_VRFCTON-VRFCTON.
WHEN '2'.
SELECT LIFNR NAME1 INTO TABLE T_XXA1
FROM LFA1
FOR ALL ENTRIES IN T_VRFCTON
WHERE LIFNR = T_VRFCTON-VRFCTON.
ENDCASE.
ENDIF.
*-- 利益センタマスタ（名称）の取得
* conversion 対応 2010/12/13 UPD >>>
*  IF T_PRCTR[] IS NOT INITIAL.
IF NOT T_PRCTR[] IS INITIAL.
* conversion 対応 2010/12/13 UPD <<<
SELECT PRCTR KTEXT INTO TABLE T_CEPCT
FROM CEPCT
FOR ALL ENTRIES IN T_PRCTR
WHERE PRCTR = T_PRCTR-PRCTR.
ENDIF.

* elematec 対応 2011/12/07 ADD >>>
*-- プラントの名称取得
IF NOT T_WERKS_NAME[] IS INITIAL.
SELECT WERKS NAME1
INTO TABLE T_WERKS_NAME
FROM T001W
FOR ALL ENTRIES IN LT_WERKS_MOTO
WHERE WERKS = LT_WERKS_MOTO-WERKS.
ENDIF.
*-- 担当者の名称取得
IF NOT LT_PERNR_MOTO[] IS INITIAL.
SELECT USR21~BNAME
ADRP~NAME_TEXT
INTO TABLE T_PERNR_NAME
FROM USR21 INNER JOIN ADRP
ON USR21~PERSNUMBER = ADRP~PERSNUMBER
FOR ALL ENTRIES IN LT_PERNR_MOTO
WHERE USR21~BNAME = LT_PERNR_MOTO-PERNR.
ENDIF.
* elematec 対応 2011/12/07 ADD <<<


* elematec 対応 2011/12/07 ADD >>>
*---ロック単位を、別テーブルで一括管理
*---[仕入照合]会社コード、受注先、プラントでロック
CLEAR:TAB_LOCK.
* 会社コードの取得
READ TABLE L_TBL_ENQ_KEY_J INTO L_WA_ENQ_KEY INDEX 1.
G_LOCK_BUKRS = L_WA_ENQ_KEY-BUKRS.
* 仕入先/プラントの内部テーブル作成
APPEND LINES OF L_TBL_ENQ_KEY_J TO TAB_LOCK.
APPEND LINES OF L_TBL_ENQ_KEY_G TO TAB_LOCK.
PERFORM TABLE_LOCK_901.
IF RC_CODE_LOCK <> 0.
YNTEXT = SY-MSGV1.
L_TNAME = 'YN210'.
RC_CODE = RC_CODE_LOCK.
MESSAGE I756 WITH L_TNAME YNTEXT.
EXIT.
ENDIF.
***--自社データロック
**  CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.
**  CONCATENATE 'LOCK_' L_TNAME INTO L_FUNC_NAME.
**  CLEAR RC_CODE.
**
**  LOOP AT L_TBL_ENQ_KEY_J INTO L_WA_ENQ_KEY.
**    PERFORM (L_FUNC_NAME) IN PROGRAM YN010400
**      USING L_WA_ENQ_KEY-BUKRS L_WA_ENQ_KEY-VRFCTON.
**    IF RC_CODE <> 0.
**      MESSAGE I756 WITH L_TNAME YNTEXT.
**      EXIT.
**    ENDIF.
**  ENDLOOP.
**  IF RC_CODE <> 0.
**    EXIT.
**  ENDIF.
**
***-- 外部データロック
**  CONCATENATE 'YN' P_MODE C_KUBUN_EXTERNAL INTO L_TNAME.
**  CONCATENATE 'LOCK_' L_TNAME INTO L_FUNC_NAME.
**
**  LOOP AT L_TBL_ENQ_KEY_G INTO L_WA_ENQ_KEY.
**    PERFORM (L_FUNC_NAME) IN PROGRAM YN010400
**      USING L_WA_ENQ_KEY-BUKRS L_WA_ENQ_KEY-VRFCTON.
**    IF RC_CODE <> 0.
**      MESSAGE I756 WITH L_TNAME YNTEXT.
**      EXIT.
**    ENDIF.
**  ENDLOOP.
**  IF RC_CODE <> 0.
**    EXIT.
**  ENDIF.

* elematec 対応 2011/12/07 ADD <<<

*-- 20090113 UPD END

ENDFORM.                    " LOCK_TABLES
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_CHECKER_0200
*&---------------------------------------------------------------------*
*       チェック項目の内容設定
*----------------------------------------------------------------------*
FORM SET_T_ALV_CHECKER_0200 .

DATA: LS_CHECKER LIKE LINE OF T_ALV_CHECKER_0200,
LH_GRID_DATA LIKE LINE OF T_GRID_DATA_0200.

REFRESH T_ALV_CHECKER_0200.
LOOP AT T_GRID_DATA_0200 INTO LH_GRID_DATA.
CLEAR LS_CHECKER.
LS_CHECKER-ROW_ID = SY-TABIX.
LS_CHECKER-LINNO = SY-TABIX.
LS_CHECKER-YNBUKRS = LH_GRID_DATA-YNBUKRS.           " 会社コード
IF NOT LH_GRID_DATA-YNGJAHR IS INITIAL.
LS_CHECKER-YNGJAHR(4) = LH_GRID_DATA-YNGJAHR.        " 会計年度
ENDIF.
LS_CHECKER-YNVRFCTON = LH_GRID_DATA-YNVRFCTON.       " 取引先コード
IF NOT LH_GRID_DATA-YNZFBDT IS INITIAL.
LS_CHECKER-YNZFBDT(10) = LH_GRID_DATA-YNZFBDT.       " 日付
ENDIF.
LS_CHECKER-YNPRCTR = LH_GRID_DATA-YNPRCTR.           " 利益センタ
IF NOT LH_GRID_DATA-YNKNQUAN IS INITIAL.
LS_CHECKER-YNKNQUAN(15) = LH_GRID_DATA-YNKNQUAN.     " 数量
ENDIF.
IF NOT LH_GRID_DATA-YNKNUNTPRC IS INITIAL.
LS_CHECKER-YNKNUNTPRC(21) = LH_GRID_DATA-YNKNUNTPRC. " 単価
ENDIF.
IF NOT LH_GRID_DATA-YNKNTAXAMT IS INITIAL.
LS_CHECKER-YNKNTAXAMT(21) = LH_GRID_DATA-YNKNTAXAMT. " 消費税額
ENDIF.
IF NOT LH_GRID_DATA-YNKNITXAMT IS INITIAL.
LS_CHECKER-YNKNITXAMT(21) = LH_GRID_DATA-YNKNITXAMT. " 税抜金額
ENDIF.
IF NOT LH_GRID_DATA-YNKNETXAMT IS INITIAL.
LS_CHECKER-YNKNETXAMT(21) = LH_GRID_DATA-YNKNETXAMT. " 税込金額
ENDIF.
LS_CHECKER-YNWAERS = LH_GRID_DATA-YNWAERS.    " 通貨コード
* elematec 対応 2011/12/07 ADD >>>
IF NOT LH_GRID_DATA-YNDVSON IS INITIAL.
LS_CHECKER-YNDVSON = LH_GRID_DATA-YNDVSON.     " プラント
ENDIF.
IF NOT LH_GRID_DATA-YNLIST2 IS INITIAL.
LS_CHECKER-YNLIST2 = LH_GRID_DATA-YNLIST2.     " 発注伝票
ENDIF.
IF NOT LH_GRID_DATA-YNLDATE1 IS INITIAL.
LS_CHECKER-YNLDATE1 = LH_GRID_DATA-YNLDATE1.   " 請求日
ENDIF.
IF NOT LH_GRID_DATA-YNLIST1 IS INITIAL.
LS_CHECKER-YNLIST1 = LH_GRID_DATA-YNLIST1.     " 発注先
ENDIF.
IF NOT LH_GRID_DATA-YNLIST8 IS INITIAL.
LS_CHECKER-YNLIST8 = LH_GRID_DATA-YNLIST8.     " ｲﾝﾎﾞｲｽNO
ENDIF.
* elematec 対応 2011/12/07 ADD <<<

APPEND LS_CHECKER TO T_ALV_CHECKER_0200.
ENDLOOP.

ENDFORM.                    " SET_T_ALV_CHECKER_0200
*&---------------------------------------------------------------------*
*&      Form  CHANGE_T_ALV_CHECKER_0200
*&---------------------------------------------------------------------*
*       チェック項目の内容更新
*----------------------------------------------------------------------*
*      -->P_OBJ_DATA_CHANGED  更新された項目内容
*----------------------------------------------------------------------*
FORM CHANGE_T_ALV_CHECKER_0200
USING P_OBJ_DATA_CHANGED TYPE REF TO CL_ALV_CHANGED_DATA_PROTOCOL.

DATA: LS_CELL TYPE LVC_S_MODI,
LS_ROID TYPE LVC_S_ROID,
LS_LINE TYPE LVC_S_MOCE.
DATA: LS_CHECKER LIKE LINE OF T_ALV_CHECKER_0200,
L_LINNO LIKE SY-TABIX.

FIELD-SYMBOLS: <FS_CHECKER> LIKE LINE OF T_ALV_CHECKER_0200.
FIELD-SYMBOLS: <FS>.

* 行追加
LOOP AT P_OBJ_DATA_CHANGED->MT_INSERTED_ROWS INTO LS_LINE.
CLEAR LS_CHECKER.
LS_CHECKER-ROW_ID = LS_LINE-ROW_ID.
APPEND LS_CHECKER TO T_ALV_CHECKER_0200.
ENDLOOP.

* 行削除
LOOP AT P_OBJ_DATA_CHANGED->MT_DELETED_ROWS INTO LS_LINE.
* elematec 対応 2011/12/07 ADD >>>
* 行削除ボタン時の削除対象レコード修正
*    DELETE T_ALV_CHECKER_0200 INDEX LS_LINE-ROW_ID.
DELETE T_ALV_CHECKER_0200 WHERE ROW_ID =  LS_LINE-ROW_ID.
* elematec 対応 2011/12/07 ADD <<<
ENDLOOP.

* 内容更新
LOOP AT P_OBJ_DATA_CHANGED->MT_MOD_CELLS INTO LS_CELL.
READ TABLE T_ALV_CHECKER_0200 ASSIGNING <FS_CHECKER>
WITH KEY ROW_ID = LS_CELL-ROW_ID.
IF SY-SUBRC = 0.
ASSIGN COMPONENT LS_CELL-FIELDNAME OF STRUCTURE <FS_CHECKER>
TO <FS>.
IF SY-SUBRC = 0.
<FS> = LS_CELL-VALUE.
TRANSLATE <FS> TO UPPER CASE.
ENDIF.
ENDIF.
ENDLOOP.

* 行番更新
LOOP AT P_OBJ_DATA_CHANGED->MT_ROID_FRONT INTO LS_ROID.
L_LINNO = SY-TABIX.
READ TABLE T_ALV_CHECKER_0200 ASSIGNING <FS_CHECKER>
WITH KEY ROW_ID = LS_ROID-ROW_ID.
IF SY-SUBRC = 0.
<FS_CHECKER>-LINNO = L_LINNO.
ENDIF.
ENDLOOP.

* elematec 対応 2011/12/07 ADD >>>
* 行追加ボタン＋エラー時の行指定修正
SORT T_ALV_CHECKER_0200 BY LINNO ROW_ID.
* elematec 対応 2011/12/07 ADD <<<

* elematec 対応 2011/12/07 ADD >>>
* 通貨内部換算
DATA:LW_AMOUNT(8)      TYPE P DECIMALS 2,
LW_AMOUNT_INT(8)  TYPE P DECIMALS 2,
LW_TYPE           TYPE DATATYPE_D,
LW_CHANGE_CURRENT TYPE TYP_CHANGE_CURRENT,
LW_DONE_ROW_ID    TYPE SY-TABIX,
LS_CELL2          TYPE LVC_S_MODI,
LT_CELL2          TYPE STANDARD TABLE OF LVC_S_MODI,
LW_MAKE_CHANGE_DATA TYPE CHAR01.
TYPES:LTYP_GRID_DATA_0200 TYPE STANDARD TABLE OF TYP_GRID_DATA_0200.
FIELD-SYMBOLS:<F_GRID_0200>  TYPE LTYP_GRID_DATA_0200, "内部テーブル
<FL_GRID_0200> TYPE TYP_GRID_DATA_0200.  "構造

*  CLEAR:T_CHANGE_CURRENT.
* 入力した際に通貨コード"JPY"にもかかわらず、内部テーブルの値が
* 円内部換算されないため
* 金額項目が入力された場合に通貨変数から値を入れなおす
ASSIGN TABLE FIELD
P_OBJ_DATA_CHANGED->MP_MOD_ROWS->* to <F_GRID_0200>.

LOOP AT <F_GRID_0200> ASSIGNING <FL_GRID_0200>.
*   変更データのうち、消費税額/税抜金額が処理対象
LOOP AT P_OBJ_DATA_CHANGED->MT_MOD_CELLS INTO LS_CELL.
*     最初の1回目
IF LW_DONE_ROW_ID IS INITIAL.
LW_DONE_ROW_ID = LS_CELL-ROW_ID.
ENDIF.
*     処理済のROW_ID
IF LW_DONE_ROW_ID > LS_CELL-ROW_ID.
CONTINUE.
ENDIF.
*     次のレコードのROW_ID
IF LW_DONE_ROW_ID < LS_CELL-ROW_ID.
LW_DONE_ROW_ID = LS_CELL-ROW_ID.   "ローカル変数にROW_ID退避
EXIT.
ENDIF.
*---  税額と税抜金額が変更された場合
IF LS_CELL-FIELDNAME = 'YNKNTAXAMT'
OR LS_CELL-FIELDNAME = 'YNKNITXAMT'.

*       入力された値が数値かどうかのチェックを行う
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN = LS_CELL-VALUE
IMPORTING
HTYPE     = LW_TYPE.
IF LW_TYPE = 'NUMC'.
*         画面入力の通貨で内部換算する
READ TABLE P_OBJ_DATA_CHANGED->MT_MOD_CELLS
WITH KEY ROW_ID    = LW_DONE_ROW_ID
FIELDNAME = 'YNWAERS'
TRANSPORTING NO FIELDS.
*         通貨コードの変更がある場合はそのまま設定(下記にて処理を行う)
IF SY-SUBRC = 0.
LW_AMOUNT_INT = LS_CELL-VALUE.
*         通貨コードの変更がない場合は内部換算
ELSE.
LW_AMOUNT = LS_CELL-VALUE.
PERFORM CURRENCY_INTERNAL USING <FL_GRID_0200>-YNWAERS
LW_AMOUNT
CHANGING LW_AMOUNT_INT.
ENDIF.
*         ALVデータの最新情報に更新
*         [消費税額]
IF LS_CELL-FIELDNAME = 'YNKNTAXAMT'.
<FL_GRID_0200>-YNKNTAXAMT = LW_AMOUNT_INT.
ENDIF.
*         [税抜金額]
IF LS_CELL-FIELDNAME = 'YNKNITXAMT'.
<FL_GRID_0200>-YNKNITXAMT = LW_AMOUNT_INT.
ENDIF.
ENDIF.
ENDIF.

*---  通貨コードが変更された場合
IF LS_CELL-FIELDNAME = 'YNWAERS'.
CLEAR:LW_MAKE_CHANGE_DATA.
READ TABLE P_OBJ_DATA_CHANGED->MT_MOD_CELLS
WITH KEY ROW_ID    = LW_DONE_ROW_ID
FIELDNAME = 'YNKNTAXAMT'
TRANSPORTING NO FIELDS.
IF SY-SUBRC <> 0.
READ TABLE P_OBJ_DATA_CHANGED->MT_MOD_CELLS
WITH KEY ROW_ID    = LW_DONE_ROW_ID
FIELDNAME = 'YNKNITXAMT'
TRANSPORTING NO FIELDS.
IF SY-SUBRC <> 0.
LW_MAKE_CHANGE_DATA = C_ON.
ENDIF.
ENDIF.

*       [消費税額]
LW_AMOUNT = <FL_GRID_0200>-YNKNTAXAMT.
PERFORM CURRENCY_INTERNAL USING <FL_GRID_0200>-YNWAERS
LW_AMOUNT
CHANGING LW_AMOUNT_INT.
<FL_GRID_0200>-YNKNTAXAMT = LW_AMOUNT_INT.
*        IF LW_MAKE_CHANGE_DATA = C_ON.
*          LS_CELL2 = LS_CELL.
*          LS_CELL2-FIELDNAME = 'YNKNTAXAMT'.
*          LS_CELL2-VALUE = LW_AMOUNT_INT.
*          CONDENSE LS_CELL2-VALUE NO-GAPS.
*          APPEND LS_CELL2 TO LT_CELL2.
*        ENDIF.
*       [税抜金額]
LW_AMOUNT = <FL_GRID_0200>-YNKNITXAMT.
PERFORM CURRENCY_INTERNAL USING <FL_GRID_0200>-YNWAERS
LW_AMOUNT
CHANGING LW_AMOUNT_INT.
<FL_GRID_0200>-YNKNITXAMT = LW_AMOUNT_INT.
ENDIF.
ENDLOOP.
ENDLOOP.
*  APPEND LINES OF LT_CELL2 TO P_OBJ_DATA_CHANGED->MT_MOD_CELLS.
*  APPEND LINES OF LT_CELL2 TO P_OBJ_DATA_CHANGED->MT_GOOD_CELLS.
* elematec 対応 2011/12/07 ADD <<<

ENDFORM.                    " CHANGE_T_ALV_CHECKER_0200
*&---------------------------------------------------------------------*
*&      Form  REFRESH_ALV_GRID_LOG
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM REFRESH_ALV_GRID_LOG .

DATA: L_LINES TYPE I.

DESCRIBE TABLE T_LOG_DATA LINES L_LINES.
IF L_LINES = 0.
CALL METHOD OBJ_SPLITTER_CONTAINER->SET_SASH_POSITION
EXPORTING
SASH_POSITION = 100.
ELSE.
CALL METHOD OBJ_SPLITTER_CONTAINER->SET_SASH_POSITION
EXPORTING
SASH_POSITION = 70.
ENDIF.
CALL METHOD OBJ_GRID_LOG->REFRESH_TABLE_DISPLAY.
CALL METHOD CL_GUI_CFW=>FLUSH.

ENDFORM.                    " REFRESH_ALV_GRID_LOG
*&---------------------------------------------------------------------*
*&      Form  SET_T_GRID_DATA_0200_TEXT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM SET_T_GRID_DATA_0200_TEXT .

DATA: L_LINES TYPE I.

FIELD-SYMBOLS: <FS_GRID_DATA> LIKE LINE OF T_GRID_DATA_0200.

DESCRIBE TABLE T_LOG_DATA LINES L_LINES.
CHECK L_LINES = 0.
LOOP AT T_GRID_DATA_0200 ASSIGNING <FS_GRID_DATA>.
PERFORM GET_VRFCTON_NAME USING    <FS_GRID_DATA>-YNVRFCTON
CHANGING <FS_GRID_DATA>-YNVRFCTONNAME.
PERFORM GET_PRCTR_NAME USING    <FS_GRID_DATA>-YNPRCTR
CHANGING <FS_GRID_DATA>-YNPRCTRNAME.
* elematec 対応 2011/12/07 ADD >>>
PERFORM GET_WERKS_NAME    USING <FS_GRID_DATA>-YNDVSON
CHANGING <FS_GRID_DATA>-YNDVSONNAME.
* elematec 対応 2011/12/07 ADD <<<
ENDLOOP.

ENDFORM.                    " SET_T_GRID_DATA_0200_TEXT
*&---------------------------------------------------------------------*
*&      Form  REFRESH_ALV_GRID_0100
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM REFRESH_ALV_GRID_0100 .

CALL METHOD OBJ_GRID_0100->REFRESH_TABLE_DISPLAY.
CALL METHOD CL_GUI_CFW=>FLUSH.

ENDFORM.                    " REFRESH_ALV_GRID_0100
*&---------------------------------------------------------------------*
*&      Form  REFRESH_ALV_GRID_0200
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM REFRESH_ALV_GRID_0200 .

*&Ver2 対応 2007/02/28 >>> 外部データ入力のデフォルトレイアウト表示
* CALL METHOD OBJ_GRID_0200->SET_FRONTEND_FIELDCATALOG
*   EXPORTING
*     IT_FIELDCATALOG = T_FCAT_0200.
CALL METHOD OBJ_GRID_0200->SET_TABLE_FOR_FIRST_DISPLAY
EXPORTING IS_VARIANT            = S_VARIANT_0200
IS_LAYOUT             = S_LAYOUT_0200
IT_TOOLBAR_EXCLUDING  = T_TOOLBAR_0200
I_SAVE                = 'A'
CHANGING  IT_OUTTAB             = T_GRID_DATA_0200
IT_FIELDCATALOG       = T_FCAT_0200
.
*&Ver2 対応 2007/02/28 <<<

CASE INPUT_MODE.
WHEN C_INPUT_MODE_NEW.
PERFORM SET_CELL_FOCUS  USING    OBJ_GRID_0200
1
'YNGJAHR'.
WHEN C_INPUT_MODE_EDIT.
PERFORM SET_CELL_FOCUS  USING    OBJ_GRID_0200
1
'YNZFBDT'.
ENDCASE.

*&Ver2 対応 2007/02/28 >>> 外部データ入力のデフォルトレイアウト
*  CALL METHOD OBJ_GRID_0200->REFRESH_TABLE_DISPLAY.
*  CALL METHOD CL_GUI_CFW=>FLUSH.
*&Ver2 対応 2007/02/28 <<<

ENDFORM.                    " REFRESH_ALV_GRID_0200
*&---------------------------------------------------------------------*
*&      Form  SET_T_GRID_DATA_0100_COLOR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM SET_T_GRID_DATA_0100_COLOR .

FIELD-SYMBOLS: <FS_GRID_DATA> LIKE LINE OF T_GRID_DATA_0100.

LOOP AT T_GRID_DATA_0100 ASSIGNING <FS_GRID_DATA>.
<FS_GRID_DATA>-YNCOLORS[] = T_COLOR_0100[].
ENDLOOP.

ENDFORM.                    " SET_T_GRID_DATA_0100_COLOR
*&---------------------------------------------------------------------*
*&      Form  SET_T_GRID_DATA_0200_COLOR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM SET_T_GRID_DATA_0200_COLOR .

FIELD-SYMBOLS: <FS_GRID_DATA> LIKE LINE OF T_GRID_DATA_0200.

LOOP AT T_GRID_DATA_0200 ASSIGNING <FS_GRID_DATA>.
<FS_GRID_DATA>-YNCOLORS[] = T_COLOR_0200[].
ENDLOOP.

ENDFORM.                    " SET_T_GRID_DATA_0100_COLOR
*&---------------------------------------------------------------------*
*&      Form  OUTPUT_TITLE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM OUTPUT_TITLE .

IF OUTPUT_FLAG = '1'.
WRITE: / TEXT-007.
ELSE.
WRITE: / TEXT-008.
ENDIF.
ULINE.

ENDFORM.                    " OUTPUT_TITLE
*&---------------------------------------------------------------------*
*&      Form  PROCESS_EVENT_ENTER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM PROCESS_EVENT_ENTER .

DATA: L_EVTID TYPE I.
DATA: L_LINES TYPE I.

IF NOT CL_GUI_ALV_GRID=>CUR_EVENT IS INITIAL.
L_EVTID = CL_GUI_ALV_GRID=>CUR_EVENT->EVENTID.
IF L_EVTID = 19.  " ENTER
DESCRIBE TABLE T_LOG_DATA LINES L_LINES.
IF L_LINES = 0.
CALL METHOD OBJ_GRID_0200->REFRESH_TABLE_DISPLAY.
CALL METHOD CL_GUI_CFW=>FLUSH.
ENDIF.
ENDIF.
ENDIF.

ENDFORM.                    " PROCESS_EVENT_ENTER
*&---------------------------------------------------------------------*
*&      Form  CHECK_OVERFLOW
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_FIELDNAME   text
*      -->P_NUMBER  text
*----------------------------------------------------------------------*
FORM CHECK_OVERFLOW  USING    P_FIELDNAME
P_NUMBER.

DATA: LS_FCAT LIKE LINE OF T_FCAT_0200.
DATA: L_LEN TYPE I,
L_DEC TYPE I,
L_MAX TYPE STRING.
DATA: L_ABS(21) TYPE C.

CLEAR RC_CODE.
READ TABLE T_FCAT_0200 INTO LS_FCAT
WITH KEY FIELDNAME = P_FIELDNAME.
IF SY-SUBRC = 0.
L_DEC = LS_FCAT-DECIMALS.
L_LEN = LS_FCAT-DD_OUTLEN.
DO L_LEN TIMES.
CONCATENATE L_MAX '9' INTO L_MAX.
ENDDO.
IF L_DEC > 0.
CONCATENATE L_MAX '.' INTO L_MAX.
SHIFT L_MAX BY L_DEC PLACES LEFT CIRCULAR.
ENDIF.
L_ABS = ABS( P_NUMBER ).
IF L_ABS > L_MAX.
RC_CODE = C_RC_CODE_ERROR.
ENDIF.
ENDIF.

ENDFORM.                    " CHECK_OVERFLOW
*&---------------------------------------------------------------------*
*&      Form  SET_SPECIAL_CHAR
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM SET_SPECIAL_CHAR USING P_ASCII
CHANGING P_CHAR.

DATA: L_X(4) TYPE X.

FIELD-SYMBOLS: <FS> TYPE C.
L_X = P_ASCII.
ASSIGN L_X TO <FS> CASTING TYPE C.
MOVE <FS>+3(1) TO P_CHAR.

ENDFORM.                    " SET_SPECIAL_CHAR


*&Ver2 対応 2007/02/28 >>> 外部データ入力の明細コピーボタン
*&---------------------------------------------------------------------*
*&      Form  EXECUTE_USER_COMMAND_0200
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_UCOMM  text
*----------------------------------------------------------------------*
FORM EXECUTE_USER_COMMAND_0200 USING    P_UCOMM.

DATA: LS_GRID_DATA LIKE LINE OF T_GRID_DATA_0200.
DATA: LS_ROW TYPE LVC_S_ROW.

CASE P_UCOMM.
WHEN C_USER_COMMAND_COPY_ROW.
CALL METHOD OBJ_GRID_0200->GET_CURRENT_CELL
IMPORTING ES_ROW_ID = LS_ROW.
IF LS_ROW-INDEX > 0.
READ TABLE T_GRID_DATA_0200 INTO LS_GRID_DATA
INDEX LS_ROW-INDEX.
IF SY-SUBRC = 0.
APPEND LS_GRID_DATA TO T_GRID_DATA_0200.
CALL METHOD OBJ_GRID_0200->REFRESH_TABLE_DISPLAY.
CALL METHOD CL_GUI_CFW=>FLUSH.
ENDIF.
ENDIF.
ENDCASE.

ENDFORM.                    " EXECUTE_USER_COMMAND_0200
*&Ver2 対応 2007/02/28 <<<
* elematec 対応 2011/12/07 ADD >>>
*&---------------------------------------------------------------------*
*&      Form  BUTTON_CONTROL
*&---------------------------------------------------------------------*
*       選択画面の複数ボタン制御
*----------------------------------------------------------------------*
FORM BUTTON_CONTROL.
DATA:L_WA_RES        TYPE SSCR_RESTRICT,
L_WA_OPT_LIST   TYPE SSCR_OPT_LIST,
L_WA_ASS        TYPE SSCR_ASS.
DATA:optl TYPE sscr_opt_list.

* 共通設定
L_WA_OPT_LIST-NAME       = 'JUST_EQ'.
L_WA_OPT_LIST-OPTIONS-EQ = 'X'.
APPEND L_WA_OPT_LIST TO L_WA_RES-OPT_LIST_TAB.

*-- 項目別設定
* 単一指定のみの場合
L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_VRFCT1'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_VRFCT2'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_LIST11'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_LIST12'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

* 共通設定
CLEAR:L_WA_OPT_LIST.
L_WA_OPT_LIST-NAME       = 'JUST_EQ2'.
L_WA_OPT_LIST-OPTIONS-EQ = 'X'.
L_WA_OPT_LIST-OPTIONS-CP = 'X'.
APPEND L_WA_OPT_LIST TO L_WA_RES-OPT_LIST_TAB.

L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_DVSON1'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ2'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_DVSON2'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ2'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

L_WA_ASS-KIND    = 'S'.
L_WA_ASS-NAME    = 'P_DVSON3'.
L_WA_ASS-SG_MAIN = 'I'.
L_WA_ASS-OP_MAIN = 'JUST_EQ2'.
APPEND L_WA_ASS TO L_WA_RES-ASS_TAB.

* 実行
CALL FUNCTION 'SELECT_OPTIONS_RESTRICT'
EXPORTING
RESTRICTION = L_WA_RES.


ENDFORM.                    " BUTTON_CONTROL
*&---------------------------------------------------------------------*
*&      Form  INIT_OUT
*&---------------------------------------------------------------------*
*       選択画面のデフォルト値設定
*----------------------------------------------------------------------*
FORM INIT_OUT.
DATA:LW_BUKRS   TYPE BUKRS.

* ユーザパラメータ[会社コード]取得し、選択画面に設定
GET PARAMETER ID 'BUK' FIELD LW_BUKRS.
* 自社
P_BUKRS1-LOW = LW_BUKRS.
P_BUKRS1-SIGN = 'I'.
P_BUKRS1-OPTION = 'EQ'.
APPEND P_BUKRS1.
* 外部
P_BUKRS2-LOW = LW_BUKRS.
P_BUKRS1-SIGN = 'I'.
P_BUKRS1-OPTION = 'EQ'.
APPEND P_BUKRS2.

ENDFORM.                    " INIT_OUT
*&---------------------------------------------------------------------*
*&      Form  CHECK_P_PG
*&---------------------------------------------------------------------*
*       自社データ取込処理項目の入力チェック
*----------------------------------------------------------------------*
*      -->P_P_DVSON1  text
*      -->P_P_LIST23  text
*----------------------------------------------------------------------*
FORM CHECK_P_PG TABLES   P_DVSON3
P_LIST23.
DATA:L_TEXT1   TYPE SYMSGV,
L_TEXT2   TYPE SYMSGV.

IF P_SALES = C_ON.
L_TEXT1 = '営業所'.
L_TEXT2 = '得意先発注番号'.
ELSE.
L_TEXT1 = '処理オプションのプラント'.
L_TEXT2 = '処理オプションの発注番号'.
ENDIF.

* 営業所/プラントが未入力の場合
IF P_DVSON3[] IS INITIAL.
MESSAGE E901 WITH L_TEXT1.
ENDIF.

* 得意先発注番号/発注番号が未入力の場合
IF P_LIST23[] IS INITIAL.
MESSAGE E901 WITH L_TEXT2.
ENDIF.

ENDFORM.                    " CHECK_P_PG
*&---------------------------------------------------------------------*
*&      Form  CHECK_CZFBDT
*&---------------------------------------------------------------------*
*       照合締日の入力値チェック
*----------------------------------------------------------------------*
*      -->P_VRFCT1         得意先/仕入先コード
*      -->P_CZFBDT         照合締日
*----------------------------------------------------------------------*
FORM CHECK_CZFBDT TABLES   P_VRFCT1
USING    P_CZFBDT TYPE ZNECZFBDT.
TYPES:BEGIN OF TYP_ZN001,
LIFNR    TYPE YNLIFNR,
EDATE    TYPE ZNEEDATE,
END   OF TYP_ZN001.
TYPES:BEGIN OF TYP_WYT3,
LIFNR    TYPE LIFNR,
END   OF TYP_WYT3.
DATA: LT_ZN001    TYPE STANDARD TABLE OF TYP_ZN001,
LW_ZN001    TYPE TYP_ZN001,
LT_WYT3     TYPE STANDARD TABLE OF TYP_WYT3,
LW_WYT3     TYPE TYP_WYT3.
FIELD-SYMBOLS:<FS>.

* 仕入照合処理の場合
IF P_PRCHS = C_ON.          "[仕入照合]

*   請求先の取得
SELECT LIFN2
INTO TABLE LT_WYT3
FROM WYT3
WHERE LIFNR IN P_VRFCT1     "画面入力の仕入先
AND EKORG = P_EKORG
AND PARVW = C_PARVW_SEIKYU.    "請求先
LW_WYT3-LIFNR = '+'.
APPEND LW_WYT3 TO LT_WYT3.

*   照合期間（仕入）データ取得
SELECT LIFNR
EDATE
INTO TABLE LT_ZN001
FROM ZN001
FOR ALL ENTRIES IN LT_WYT3
WHERE LIFNR = LT_WYT3-LIFNR.
IF SY-SUBRC = 0.
SORT LT_ZN001.
*     入力された仕入先の照合終了日と照合締日をチェック
LOOP AT P_VRFCT1.
ASSIGN COMPONENT 3 OF STRUCTURE P_VRFCT1 TO <FS>.  "LOW値
READ TABLE LT_ZN001 INTO LW_ZN001
WITH KEY LIFNR = <FS>
BINARY SEARCH.
IF SY-SUBRC <> 0.
READ TABLE LT_ZN001 INTO LW_ZN001
WITH KEY LIFNR = '+'
BINARY SEARCH.
ENDIF.
*       すでに照合が終了(同日も終了とする)している場合エラー
IF P_CZFBDT <= LW_ZN001-EDATE.
MESSAGE E906 WITH LW_ZN001-LIFNR.
ENDIF.
ENDLOOP.
ENDIF.
ENDIF.

ENDFORM.                    " CHECK_CZFBDT
*&---------------------------------------------------------------------*
*&      Form  GET_WERKS_NAME
*&---------------------------------------------------------------------*
*       プラント名取得
*----------------------------------------------------------------------*
*      -->P_YNDVSON         プラント
*      <--P_YNDVSONNAME     プラント名
*----------------------------------------------------------------------*
FORM GET_WERKS_NAME USING    P_DVSON
CHANGING P_DVSONNAME.
DATA:LW_WERKS_NAME   TYPE TYP_WERKS_NAME.

CHECK NOT P_DVSON IS INITIAL.
* 内部テーブルを検索
READ TABLE T_WERKS_NAME INTO LW_WERKS_NAME
WITH TABLE KEY WERKS = P_DVSON.
* すでに取得している場合はこの値を取得
IF SY-SUBRC = 0.
P_DVSONNAME = LW_WERKS_NAME-NAME1.
ELSE.
*   まだ取得していない場合は、 ＤＢより取得
SELECT SINGLE
WERKS
NAME1
INTO LW_WERKS_NAME
FROM T001W
WHERE WERKS = P_DVSON.   "プラント
*   内部テーブルに格納しておく
INSERT LW_WERKS_NAME INTO TABLE T_WERKS_NAME.
P_DVSONNAME = LW_WERKS_NAME-NAME1.
ENDIF.

ENDFORM.                    " GET_WERKS_NAME
*&---------------------------------------------------------------------*
*&      Form  GET_YNPERNR_NAME
*&---------------------------------------------------------------------*
*       担当者名称取得
*----------------------------------------------------------------------*
*      -->P_L_H_GRID_DATA_YNPERNR  text
*      <--P_L_H_GRID_DATA_YNPERNRNAME  text
*----------------------------------------------------------------------*
FORM GET_YNPERNR_NAME USING    P_PERNR
CHANGING P_PERNRNAME.
DATA:LW_PERNR_NAME   TYPE TYP_PERNR_NAME.

CHECK NOT P_PERNR IS INITIAL.
* 内部テーブルを検索
READ TABLE T_PERNR_NAME INTO LW_PERNR_NAME
WITH TABLE KEY PERNR = P_PERNR.
* すでに取得している場合はこの値を取得
IF SY-SUBRC = 0.
P_PERNRNAME = LW_PERNR_NAME-NAME_TEXT.
ELSE.
*   まだ取得していない場合は、 ＤＢより取得
SELECT BNAME
NAME_TEXT
INTO LW_PERNR_NAME
FROM USR21 INNER JOIN ADRP
ON USR21~PERSNUMBER = ADRP~PERSNUMBER
UP TO 1 ROWS
WHERE BNAME = P_PERNR+0(12).
ENDSELECT.
*   内部テーブルに格納しておく
INSERT LW_PERNR_NAME INTO TABLE T_PERNR_NAME.
P_PERNRNAME = LW_PERNR_NAME-NAME_TEXT.
ENDIF.

ENDFORM.                    " GET_YNPERNR_NAME
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_INIT_LINE
*&---------------------------------------------------------------------*
*       外部データ登録時のデフォルト行編集
*----------------------------------------------------------------------*
*      <--P_GRID_DATA_0200   外部データ入力ALV構造
*----------------------------------------------------------------------*
FORM INSERT_DATA_INIT_LINE CHANGING P_GRID_DATA_0200
TYPE TYP_GRID_DATA_0200.

* 会社コード
P_GRID_DATA_0200-YNBUKRS = G_BUKRS_INPUT.
* 担当者
P_GRID_DATA_0200-YNPERNR = SY-UNAME.
* 担当者名称
PERFORM GET_YNPERNR_NAME    USING P_GRID_DATA_0200-YNPERNR
CHANGING P_GRID_DATA_0200-YNPERNRNAME.
* プラント/プラント名
IF P_GRID_DATA_0200-YNDVSON IS INITIAL.
PERFORM INSERT_DATA_INT_WERKS CHANGING P_GRID_DATA_0200-YNDVSON.
IF P_GRID_DATA_0200-YNDVSON <> SPACE.
PERFORM GET_WERKS_NAME    USING P_GRID_DATA_0200-YNDVSON
CHANGING P_GRID_DATA_0200-YNDVSONNAME.
ENDIF.
ENDIF.

ENDFORM.                    " INSERT_DATA_INIT_LINE
*&---------------------------------------------------------------------*
*&      Form  INSERT_DATA_INT_WERKS
*&---------------------------------------------------------------------*
*       外部データ登録時の初期値データ【プラント】
*----------------------------------------------------------------------*
*      <--P_P_GRID_DATA_0200_YNDVSON  text
*----------------------------------------------------------------------*
FORM INSERT_DATA_INT_WERKS CHANGING P_YNDVSON.
FIELD-SYMBOLS: <FS1>, <FS2>, <FS3>.

LOOP AT P_DVSON1.
ASSIGN COMPONENT 1 OF STRUCTURE P_DVSON1 TO <FS1>.
ASSIGN COMPONENT 2 OF STRUCTURE P_DVSON1 TO <FS2>.
IF <FS2> <> 'CP'.
ASSIGN COMPONENT 3 OF STRUCTURE P_DVSON1 TO <FS3>.
P_YNDVSON = <FS3>.
EXIT.
ENDIF.
ENDLOOP.

ENDFORM.                    " INSERT_DATA_INT_WERKS
*&---------------------------------------------------------------------*
*&      Form  SET_T_GRID_DATA_0200_DEFAULT_M
*&---------------------------------------------------------------------*
*       外部データ登録時のデフォルト設定
*----------------------------------------------------------------------*
FORM SET_T_GRID_DATA_0200_DEFAULT_M.

FIELD-SYMBOLS: <FS> TYPE TYP_GRID_DATA_0200.
DATA:LW_TABIX     TYPE SY-TABIX,       " 現在の行番号
LW_SET_WAERS TYPE CHAR01.

LOOP AT T_GRID_DATA_0200 ASSIGNING <FS>.
LW_TABIX = SY-TABIX.
CLEAR:LW_SET_WAERS.
*   受注番号関係なくデフォルト設定
IF <FS>-YNBUKRS IS INITIAL.
PERFORM INSERT_DATA_INIT_LINE CHANGING <FS>.
ENDIF.

*   受注番号以外の入力項目連動のデフォルト設定
PERFORM GET_DATA2_INIT_LINE    USING LW_TABIX
CHANGING <FS>
LW_SET_WAERS.

*   金額計算
PERFORM CALC_DATA_INIT_LINE    USING LW_SET_WAERS
CHANGING <FS>.

ENDLOOP.
*  CLEAR:T_CHANGE_CURRENT.
ENDFORM.                    " SET_T_GRID_DATA_0200_DEFAULT_M
*&---------------------------------------------------------------------*
*&      Form  GET_DATA2_INIT_LINE
*&---------------------------------------------------------------------*
*       外部データ登録時の伝票以外項目とのデフォルト値
*----------------------------------------------------------------------*
*      -->P_TABIX            現在ループ中の行番号
*      <--P_GRID_DATA_0200   外部データ入力ALV構造
*----------------------------------------------------------------------*
FORM GET_DATA2_INIT_LINE    USING P_TABIX   TYPE SY-TABIX
CHANGING P_GRID_DATA_0200
TYPE TYP_GRID_DATA_0200
P_SET_WAERS TYPE CHAR01.
DATA:LW_YEAR      TYPE GJAHR,       " 会計年度算出用
LW_LIFNR     TYPE CHAR10,      " 仕入先(内部)
LW_ZTERM     TYPE DZTERM,      " 支払条件
LW_ZFBDT     TYPE DZFBDT,      " 計上締日
LW_LFM1      TYPE TYP_LFM1,
LW_WYT3      TYPE TYP_WYT3.

DATA:LW_CHANGE_CURRENT  TYPE TYP_CHANGE_CURRENT.
FIELD-SYMBOLS: <FS>.

*-- 照合キー：1 発注伝票番号へコピー
P_GRID_DATA_0200-YNCKEY1 = P_GRID_DATA_0200-YNLIST2+0(10).
*-- 照合キー：2 インボイスNOへコピー
P_GRID_DATA_0200-YNCKEY2 = P_GRID_DATA_0200-YNLIST8.

* 取引先機能データの取得
LW_LIFNR = P_GRID_DATA_0200-YNLIST1+0(10).
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = LW_LIFNR
IMPORTING
OUTPUT        = LW_LIFNR.
CLEAR:LW_WYT3.
* 受注先に紐づく請求先を取得
READ TABLE T_WYT3 INTO LW_WYT3
WITH TABLE KEY LIFNR = LW_LIFNR
EKORG = P_EKORG.
IF SY-SUBRC = 0.
ELSE.
SELECT LIFNR
EKORG
LIFN2
INTO LW_WYT3
FROM WYT3
UP TO 1 ROWS
WHERE LIFNR = LW_LIFNR
AND EKORG = P_EKORG
AND PARVW = C_PARVW_SEIKYU.    "請求先
ENDSELECT.
IF SY-SUBRC = 0.
INSERT LW_WYT3 INTO TABLE T_WYT3.
ENDIF.
ENDIF.

*-- 請求先
P_GRID_DATA_0200-YNVRFCTON = LW_WYT3-LIFN2.

*-- 会計年度(毎回必ず更新)
IF P_GRID_DATA_0200-YNLDATE1 IS INITIAL.
ELSE.
CALL FUNCTION 'BAPI_COMPANYCODE_GET_PERIOD'
EXPORTING
COMPANYCODEID = P_GRID_DATA_0200-YNBUKRS
POSTING_DATE  = P_GRID_DATA_0200-YNLDATE1
IMPORTING
FISCAL_YEAR   = LW_YEAR.
P_GRID_DATA_0200-YNGJAHR = LW_YEAR.
ENDIF.

* 請求先を内部変換(前ゼロ埋め)
LW_LIFNR = P_GRID_DATA_0200-YNVRFCTON+0(10).
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = LW_LIFNR
IMPORTING
OUTPUT = LW_LIFNR.
* 請求先の仕入先マスタを取得
CLEAR:LW_LFM1.
READ TABLE T_LFM1 INTO LW_LFM1
WITH TABLE KEY LIFNR = LW_LIFNR
EKORG = P_EKORG.
IF SY-SUBRC = 0.
LW_ZTERM = LW_LFM1-ZTERM.
ELSE.
SELECT SINGLE LIFNR
EKORG
ZTERM
WAERS
INTO LW_LFM1
FROM LFM1
WHERE LIFNR = LW_LIFNR
AND EKORG = P_EKORG.
LW_ZTERM = LW_LFM1-ZTERM.
INSERT LW_LFM1 INTO TABLE T_LFM1.
ENDIF.

*-- 通貨コード
IF      P_GRID_DATA_0200-YNWAERS IS INITIAL
AND NOT LW_LFM1-WAERS            IS INITIAL.
P_SET_WAERS = C_ON.   "通貨コード設定フラグをON
ENDIF.
P_GRID_DATA_0200-YNWAERS = LW_LFM1-WAERS.

*-- 計上締日(未入力の場合のみ)
IF P_GRID_DATA_0200-YNZFBDT IS INITIAL.
IF P_GRID_DATA_0200-YNLDATE1 IS INITIAL.
ELSE.                    "請求日が入力されている場合のみ
*     支払条件と請求日より、計上締日を算出
CALL FUNCTION 'FI_FIND_PAYMENT_CONDITIONS'
EXPORTING
I_ZTERM            = LW_ZTERM
I_BLDAT            = P_GRID_DATA_0200-YNLDATE1
I_BUDAT            = P_GRID_DATA_0200-YNLDATE1
IMPORTING
E_ZFBDT            = LW_ZFBDT
EXCEPTIONS
TERMS_INCORRECT    = 1
TERMS_NOT_FOUND    = 2
NO_DATE_ENTERED    = 3
NO_DAY_LIMIT_FOUND = 4
OTHERS             = 5.
IF SY-SUBRC = 0.
P_GRID_DATA_0200-YNZFBDT = LW_ZFBDT.
ENDIF.
ENDIF.
ENDIF.

*-- 金額項目
*  LOOP AT T_CHANGE_CURRENT INTO LW_CHANGE_CURRENT
*       WHERE ROW_ID = P_TABIX.
*    ASSIGN COMPONENT LW_CHANGE_CURRENT-FIELD OF
*           STRUCTURE P_GRID_DATA_0200 TO <FS>.
*    <FS> = LW_CHANGE_CURRENT-AMOUNT.
*  ENDLOOP.


ENDFORM.                    " GET_DATA2_INIT_LINE
*&---------------------------------------------------------------------*
*&      Form  CALC_DATA_INIT_LINE
*&---------------------------------------------------------------------*
*       外部データ登録時の金額項目デフォルト値編集
*----------------------------------------------------------------------*
*      -->P_SET_WAERS        税コード取得フラグ
*      <--P_GRID_DATA_0200   外部データ入力ALV構造
*----------------------------------------------------------------------*
FORM CALC_DATA_INIT_LINE    USING P_SET_WAERS TYPE CHAR01
CHANGING P_GRID_DATA_0200
TYPE TYP_GRID_DATA_0200.
DATA:LW_YNKNITXAMT TYPE YNITXAMT,        " 税抜金額(外部表記)
LW_WRBTR    TYPE WRBTR,             " 属性変換用
LT_MWDAT    TYPE TABLE OF RTAX1U15, " 税額
LW_MWDAT    LIKE LINE  OF LT_MWDAT,
LW_KNUMH    TYPE KNUMH,             " 条件レコード番号
LW_MWSKZ    TYPE TYP_MWSKZ,
LW_COUNT    TYPE I.                 " 条件レコード件数

*-- 通貨コードが入力されている場合のみ自動計算
CHECK NOT P_GRID_DATA_0200-YNWAERS IS INITIAL.

*--税抜金額(数量×単価)(未入力の場合に設定)
IF  P_GRID_DATA_0200-YNKNITXAMT = 0.
LW_YNKNITXAMT = P_GRID_DATA_0200-YNKNQUAN *
P_GRID_DATA_0200-YNKNUNTPRC.
*   金額の内部換算
PERFORM CURRENCY_INTERNAL    USING P_GRID_DATA_0200-YNWAERS
LW_YNKNITXAMT
CHANGING P_GRID_DATA_0200-YNKNITXAMT.
ENDIF.

*--消費税額(未入力の場合に設定)
IF  P_GRID_DATA_0200-YNKNTAXAMT = 0
AND P_GRID_DATA_0200-YNKNITXAMT <> 0.

LW_WRBTR = P_GRID_DATA_0200-YNKNITXAMT.     "税抜金額(内部)
*   税コードを取得
READ TABLE T_MWSKZ INTO LW_MWSKZ
WITH TABLE KEY LIFNR = P_GRID_DATA_0200-YNVRFCTON.
IF SY-SUBRC <> 0.
*     請求先をキーに条件マスタを検索
SELECT KNUMH
INTO LW_KNUMH
FROM A044
WHERE KAPPL = P_KAPPL
AND KSCHL = P_KSCHL
AND EKORG = P_EKORG
AND LIFNR = P_GRID_DATA_0200-YNVRFCTON+0(10).
LW_COUNT = LW_COUNT + 1.
ENDSELECT.
IF  SY-SUBRC = 0
AND LW_COUNT = 1.
SELECT KONP~MWSK1
INTO LW_MWSKZ-MWSKZ
FROM KONP
UP TO 1 ROWS
WHERE KNUMH = LW_KNUMH.
ENDSELECT.
IF SY-SUBRC = 0.
LW_MWSKZ-LIFNR = P_GRID_DATA_0200-YNVRFCTON+0(10).
INSERT LW_MWSKZ INTO TABLE T_MWSKZ.
ENDIF.
ENDIF.
ENDIF.
*   税抜金額分の税額を税コードを使用して算出
IF LW_MWSKZ-MWSKZ IS INITIAL.
ELSE.
CALL FUNCTION 'CALCULATE_TAX_FROM_NET_AMOUNT'
EXPORTING
I_BUKRS           = P_GRID_DATA_0200-YNBUKRS
I_MWSKZ           = LW_MWSKZ-MWSKZ
I_WAERS           = P_GRID_DATA_0200-YNWAERS
I_WRBTR           = LW_WRBTR
TABLES
T_MWDAT           = LT_MWDAT
EXCEPTIONS
BUKRS_NOT_FOUND   = 1
COUNTRY_NOT_FOUND = 2
MWSKZ_NOT_DEFINED = 3
MWSKZ_NOT_VALID   = 4
KTOSL_NOT_FOUND   = 5
KALSM_NOT_FOUND   = 6
PARAMETER_ERROR   = 7
KNUMH_NOT_FOUND   = 8
KSCHL_NOT_FOUND   = 9
UNKNOWN_ERROR     = 10
ACCOUNT_NOT_FOUND = 11
TXJCD_NOT_VALID   = 12
OTHERS            = 13.
IF SY-SUBRC <> 0.
P_GRID_DATA_0200-YNKNTAXAMT = 0.
ENDIF.

READ TABLE LT_MWDAT INTO LW_MWDAT INDEX 1.
P_GRID_DATA_0200-YNKNTAXAMT = LW_MWDAT-WMWST.
ENDIF.
* 税額に入力がある場合
ELSE.
IF P_SET_WAERS = C_ON.      "今回通貨コードが設定された場合
LW_MWDAT-WMWST = P_GRID_DATA_0200-YNKNTAXAMT.
PERFORM CURRENCY_INTERNAL    USING P_GRID_DATA_0200-YNWAERS
LW_MWDAT-WMWST
CHANGING P_GRID_DATA_0200-YNKNTAXAMT.
ENDIF.
ENDIF.
* 税抜き金額が入力があり、今回通貨コードが設定された場合
IF  P_GRID_DATA_0200-YNKNITXAMT <> 0
AND P_SET_WAERS = C_ON.
LW_MWDAT-WMWST = P_GRID_DATA_0200-YNKNITXAMT.
PERFORM CURRENCY_INTERNAL    USING P_GRID_DATA_0200-YNWAERS
LW_MWDAT-WMWST
CHANGING P_GRID_DATA_0200-YNKNITXAMT.
ENDIF.

*-- 税込金額(必ず更新する)
P_GRID_DATA_0200-YNKNETXAMT = P_GRID_DATA_0200-YNKNTAXAMT +
P_GRID_DATA_0200-YNKNITXAMT.

ENDFORM.                    " CALC_DATA_INIT_LINE
*&---------------------------------------------------------------------*
*&      Form  CURRENCY_INTERNAL
*&---------------------------------------------------------------------*
*       金額項目の内部換算
*----------------------------------------------------------------------*
*      -->P_YNWAERS         通貨コード
*      -->P_IN              換算元金額
*      <--P_OUT             換算後金額
*----------------------------------------------------------------------*
FORM CURRENCY_INTERNAL USING    P_YNWAERS
P_IN
CHANGING P_OUT.
DATA:LW_BAPICURR TYPE BAPICURR_D,        " 消費税額
LW_CURRENCY TYPE WAERS_CURC,        " 通貨コード
LW_RETURN   TYPE BAPIRETURN.        " リターン

LW_BAPICURR = P_IN.
LW_CURRENCY = P_YNWAERS.      "通貨コード

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_INTERNAL'
EXPORTING
CURRENCY             = LW_CURRENCY
AMOUNT_EXTERNAL      = LW_BAPICURR
MAX_NUMBER_OF_DIGITS = '20'
IMPORTING
AMOUNT_INTERNAL      = P_OUT
RETURN               = LW_RETURN.

ENDFORM.                    " CURRENCY_INTERNAL
*&---------------------------------------------------------------------*
*&      Form  CHECK_EBELN
*&---------------------------------------------------------------------*
*       購買発注伝票の存在チェック(外部データ入力時)
*----------------------------------------------------------------------*
*      -->P_EBELN           伝票番号入力値
*      <--P_ERR_FLG         エラーフラグ
*----------------------------------------------------------------------*
FORM CHECK_EBELN   USING P_EBELN
CHANGING P_ERR_FLG.
DATA:L_EBELN   TYPE EBELN.

CLEAR:P_ERR_FLG.

* 発注伝票が存在するかどうかチェック
SELECT EKPO~EBELN
INTO L_EBELN
FROM EKKO INNER JOIN EKPO
ON EKKO~EBELN = EKPO~EBELN
UP TO 1 ROWS
WHERE EKKO~EBELN = P_EBELN
AND EKPO~LOEKZ = SPACE.
ENDSELECT.
* 存在しない場合エラーフラグをON
IF SY-SUBRC <> 0.
P_ERR_FLG = C_ON.
ENDIF.

ENDFORM.                    " CHECK_EBELN
*&---------------------------------------------------------------------*
*&      Form  CHECK_VRFCTON_IN
*&---------------------------------------------------------------------*
*       外部データ入力[仕入先]選択画面の値かどうかチェック
*----------------------------------------------------------------------*
*      -->P_LH_GRID_DATA_YNVRFCTON  text
*----------------------------------------------------------------------*
FORM CHECK_VRFCTON_IN USING    P_VRFCTON.

CLEAR:RC_CODE.
* 自社データの受注先(外部データの受注先も同じ値)と条件が一致するかどうか
IF P_VRFCTON IN GR_LIFNR.
"正常
ELSE.
RC_CODE = C_RC_CODE_ERROR.
ENDIF.

ENDFORM.                    " CHECK_VRFCTON_IN
*&---------------------------------------------------------------------*
*&      Form  GET_YN230
*&---------------------------------------------------------------------*
*       仕入照合マスタよりデータ取得
*----------------------------------------------------------------------*
FORM GET_YN230.
DATA:L_LIST1       TYPE RANGE OF YNLIST21,
LW_LIST1      LIKE LINE OF L_LIST1,
L_CHAR10      TYPE CHAR10,
LW_LIST12     LIKE LINE OF P_LIST12.

CLEAR:T_YN230.
* 自社データ分
SELECT WYT3~LIFNR
YN230~VRFCTON
YN230~BUKRS
YN230~WAERS
YN230~OUTEXITDOC
INTO TABLE T_YN230
FROM WYT3 INNER JOIN YN230
ON WYT3~LIFN2 = YN230~VRFCTON
WHERE WYT3~LIFNR IN GR_LIFNR         "受注先
AND WYT3~EKORG  = P_EKORG
AND WYT3~PARVW  = C_PARVW_SEIKYU   "請求先
AND YN230~BUKRS = G_BUKRS_INPUT.
IF SY-SUBRC = 0.
SORT T_YN230.
ENDIF.

ENDFORM.                    " GET_YN230
*&---------------------------------------------------------------------*
*&      Form  LIST1_CHECK_TYPE
*&---------------------------------------------------------------------*
*       仕入先の必須項目を決定するEXIT番号取得
*----------------------------------------------------------------------*
*      -->P_YNLIST1          受注先
*      <--P_EXIT_TYPE        EXIT番号
*----------------------------------------------------------------------*
FORM LIST1_CHECK_TYPE USING    P_YNLIST1     TYPE ANY
CHANGING P_EXIT_TYPE   TYPE YNOUTEXITDOC.
DATA:L_LIFNR    TYPE LIFNR,
L_YN230    TYPE TYP_YN230.

CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = P_YNLIST1
IMPORTING
OUTPUT        = L_LIFNR.

* 処理の最初に取得していた仕入照合マスタを読み込む
READ TABLE T_YN230 INTO L_YN230
WITH KEY LIFNR = L_LIFNR        "受注先
BUKRS = G_BUKRS_INPUT
BINARY SEARCH.
P_EXIT_TYPE = L_YN230-OUTEXITDOC.

ENDFORM.                    " LIST1_CHECK_TYPE
*&---------------------------------------------------------------------*
*&      Form  CHANGE_ZYUTYU
*&---------------------------------------------------------------------*
*       選択画面受注先前ゼロ埋め
*----------------------------------------------------------------------*
FORM CHANGE_ZYUTYU.

DATA: L_CHAR10(10) TYPE C,
LW_LIST1  LIKE LINE OF GR_LIFNR,
LW_LIST12 LIKE LINE OF P_LIST12.

* 選択画面に入力された受注先の前ゼロ埋め
CLEAR:GR_LIFNR.
LOOP AT P_LIST12 INTO LW_LIST12.
LW_LIST1 = LW_LIST12.
L_CHAR10 = LW_LIST12-LOW+0(10).
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT         = L_CHAR10
IMPORTING
OUTPUT        = L_CHAR10.
LW_LIST1-LOW = L_CHAR10.
APPEND LW_LIST1 TO GR_LIFNR.
ENDLOOP.

ENDFORM.                    " CHANGE_ZYUTYU
*&---------------------------------------------------------------------*
*&      Form  INSERT_POINT_COMPARA_DATA
*&---------------------------------------------------------------------*
*       部分照合データの作成
*----------------------------------------------------------------------*
FORM INSERT_POINT_COMPARA_DATA.

DATA:LS_COMPARE TYPE TYP_COMPARE2,
LS_GRID_DATA TYPE TYP_GRID_DATA_0100,
LW_KNETXAMT  TYPE YNETXAMT,
LW_MESSAGE   TYPE SYMSGV,
LW_COMP      TYPE TYP_COMPARE,
LT_COMPARE   TYPE STANDARD TABLE OF TYP_COMPARE2.

* 作成した自社データ格納内部テーブル
DATA:LT_GRID_DATA_0100 TYPE STANDARD TABLE OF TYP_GRID_DATA_0100.

CLEAR:RC_CODE, GT_POINT_COMPARE.

* COMPARE外部データに区分を設定し１つの内部テーブルに編集
* 外部データ
LOOP AT T_COMPARE_1 INTO LW_COMP.
IF LW_COMP-POINT_COMPARE <> SPACE.       "部分照合データのみ
MOVE-CORRESPONDING LW_COMP TO LS_COMPARE.
LS_COMPARE-YNKUBUN = C_KUBUN_EXTERNAL. "区分設定
APPEND LS_COMPARE TO LT_COMPARE.
ENDIF.
ENDLOOP.
* 自社データ
LOOP AT T_COMPARE_2 INTO LW_COMP.
IF LW_COMP-POINT_COMPARE <> SPACE.        "部分照合データのみ
MOVE-CORRESPONDING LW_COMP TO LS_COMPARE.
LS_COMPARE-YNKUBUN = C_KUBUN_INTERNAL. "区分設定
APPEND LS_COMPARE TO LT_COMPARE.
ENDIF.
ENDLOOP.

* 部分照合データをループ
LOOP AT LT_COMPARE INTO LS_COMPARE.

*   今回照合したデータのうち、部分照合差額が入力されているものが処理対象
LOOP AT T_GRID_DATA_0100 INTO LS_GRID_DATA
WHERE YNKUBUN     = LS_COMPARE-YNKUBUN
AND YNBUKRS     = LS_COMPARE-YNBUKRS
AND YNVRFCTON   = LS_COMPARE-YNVRFCTON
AND YNTGTFLG    = C_ON
AND YNDELFLG    = C_OFF
AND YNCSTS      <> C_CSTS_OK_MANUAL
AND YNCSTS      <> C_CSTS_OK_AUTO
AND YNKNETXAMT4 <> 0.

*----- 会計伝票作成
PERFORM MAKE_POINT_COMPARA_DOC  CHANGING LS_GRID_DATA
RC_CODE.
IF RC_CODE <> 0.
ROLLBACK WORK.
MESSAGE I909.
EXIT.
ENDIF.

*----- ＤＢデータ作成
LW_KNETXAMT = LS_GRID_DATA-YNKNETXAMT4.
LS_GRID_DATA-YNCHKDOC = LS_COMPARE-YNCHKDOC.
LS_GRID_DATA-YNCHKDAT = LS_COMPARE-YNCHKDAT.
LS_GRID_DATA-YNCHKUSR = LS_COMPARE-YNCHKUSR.

CASE P_MODE.
*       【売上照合】
WHEN C_MODE_SALES.

*       【仕入照合】
WHEN C_MODE_PURCHASE.
IF LS_GRID_DATA-YNKNETXAMT4 < 0.
LW_KNETXAMT = LS_GRID_DATA-YNKNETXAMT4  * -1.
ELSE.
LW_KNETXAMT = LS_GRID_DATA-YNKNETXAMT4.
ENDIF.
*         外部データにプラスの金額を部分照合差額に入力した場合
IF  LS_GRID_DATA-YNKUBUN = C_KUBUN_EXTERNAL
AND LS_GRID_DATA-YNKNETXAMT4 > 0.
PERFORM INSERT_YN_20_POINT_COMPARA USING LS_GRID_DATA
C_CSTS_INIT
C_CSTS_OK
C_KUBUN_EXTERNAL
LW_KNETXAMT
CHANGING LT_GRID_DATA_0100
RC_CODE.
*         外部データにマイナスの金額を部分照合差額に入力した場合
ELSEIF LS_GRID_DATA-YNKUBUN = C_KUBUN_EXTERNAL
AND LS_GRID_DATA-YNKNETXAMT4 < 0.
PERFORM INSERT_YN_20_POINT_COMPARA USING LS_GRID_DATA
C_CSTS_OK
C_CSTS_INIT
C_KUBUN_EXTERNAL
LW_KNETXAMT
CHANGING LT_GRID_DATA_0100
RC_CODE.

*         自社データにプラスの金額を部分照合差額に入力した場合
ELSEIF LS_GRID_DATA-YNKUBUN = C_KUBUN_INTERNAL
AND LS_GRID_DATA-YNKNETXAMT4 > 0.
PERFORM INSERT_YN_20_POINT_COMPARA USING LS_GRID_DATA
C_CSTS_INIT
C_CSTS_OK
C_KUBUN_INTERNAL
LW_KNETXAMT
CHANGING LT_GRID_DATA_0100
RC_CODE.
*         自社データにマイナスの金額を部分照合差額に入力した場合
ELSEIF LS_GRID_DATA-YNKUBUN = C_KUBUN_INTERNAL
AND LS_GRID_DATA-YNKNETXAMT4 < 0.
PERFORM INSERT_YN_20_POINT_COMPARA USING LS_GRID_DATA
C_CSTS_OK
C_CSTS_INIT
C_KUBUN_INTERNAL
LW_KNETXAMT
CHANGING LT_GRID_DATA_0100
RC_CODE.

ENDIF.

WHEN OTHERS.
ENDCASE.
IF RC_CODE <> 0.
ROLLBACK WORK.
MESSAGE I910 WITH 'YN220'.
EXIT.
ENDIF.
ENDLOOP.
ENDLOOP.

ENDFORM.                    " INSERT_POINT_COMPARA_DATA
*&---------------------------------------------------------------------*
*&      Form  MAKE_POINT_COMPARA_DOC
*&---------------------------------------------------------------------*
*       部分照合データ/会計伝票登録
*----------------------------------------------------------------------*
*      <--P_GRID_DATA       部分照合差額が入力されたデータ
*      <--P_RC_CODE         リターンコード(エラーハンドリング用)
*----------------------------------------------------------------------*
FORM MAKE_POINT_COMPARA_DOC CHANGING P_GRID_DATA TYPE TYP_GRID_DATA_0100
P_RC_CODE   TYPE SY-SUBRC.

DATA:LT_BDC      TYPE STANDARD TABLE OF BDCDATA,
LW_FVAL     TYPE BDC_FVAL,
LW_OPT      TYPE CTU_PARAMS,
LT_MESSAGE  TYPE STANDARD TABLE OF BDCMSGCOLL,
LW_MESSAGE  TYPE BDCMSGCOLL.


PERFORM BDC_DYNPRO    USING 'SAPMF05A'
'0100'
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BDC_OKCODE'           "Enter
'/00'
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BKPF-BLDAT'           "伝票日付
P_GRID_DATA-YNLDATE1
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BKPF-BLART'           "伝票タイプ
P_BLART
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BKPF-BUKRS'           "会社コード
P_GRID_DATA-YNBUKRS
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BKPF-BUDAT'           "転記日付
P_GRID_DATA-YNLDATE1
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BKPF-WAERS'           "通貨コード
P_GRID_DATA-YNWAERS
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'RF05A-NEWBS'          "転記キー
P_BSCHLS
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'RF05A-NEWKO'          "勘定コード
P_GRID_DATA-YNVRFCTON  "請求先
CHANGING LT_BDC.
* ２画面目
PERFORM BDC_DYNPRO    USING 'SAPMF05A'
'0302'
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BDC_OKCODE'           "Enter
'/00'
CHANGING LT_BDC.
"金額を外部表記に編集
WRITE P_GRID_DATA-YNKNETXAMT4 TO LW_FVAL
CURRENCY P_GRID_DATA-YNWAERS.
TRANSLATE LW_FVAL USING '- , '.      "符号とカンマをSPACEに変換
CONDENSE LW_FVAL NO-GAPS.             "SPACEを削除
PERFORM BDC_VALUE     USING 'BSEG-WRBTR'           "金額
LW_FVAL
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'RF05A-NEWBS'          "転記キー
P_BSCHLH
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'RF05A-NEWKO'          "勘定コード
P_GRID_DATA-YNVRFCTON  "請求先
CHANGING LT_BDC.

* ３画面目
PERFORM BDC_DYNPRO    USING 'SAPMF05A'
'0302'
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BDC_OKCODE'
'=AB'                  "戻る
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BSEG-WRBTR'           "金額
LW_FVAL
CHANGING LT_BDC.

* ヘッダ画面
PERFORM BDC_DYNPRO    USING 'SAPMF05A'
'0700'
CHANGING LT_BDC.
PERFORM BDC_VALUE     USING 'BDC_OKCODE'           "保存
'=BU'
CHANGING LT_BDC.

LW_OPT-DISMODE = 'N'.
LW_OPT-UPDMODE = 'S'.
* ＢＤＣトランザクション実行
CALL TRANSACTION 'F-42'  USING LT_BDC
OPTIONS FROM LW_OPT
MESSAGES INTO LT_MESSAGE.
* 登録時のメッセージを検索
READ TABLE LT_MESSAGE INTO LW_MESSAGE
WITH KEY MSGTYP = 'S'
MSGID  = 'F5'
MSGNR  = '312'.

* 存在する場合は、会計伝票番号を取得
IF SY-SUBRC = 0.
P_GRID_DATA-YNBELNR = LW_MESSAGE-MSGV1.
ELSE.
P_RC_CODE =  C_RC_CODE_ERROR.
ENDIF.

ENDFORM.                    " MAKE_POINT_COMPARA_DOC
*&---------------------------------------------------------------------*
*&      Form  BDC_DYNPRO
*&---------------------------------------------------------------------*
*       BDCデータ作成
*----------------------------------------------------------------------*
*      -->P_PROGRAM    BDC モジュールプール・プログラム
*      -->P_DYNPRO     BDC Dynpro 番号
*      <--P_T_BDC      BDC内部テーブル
*----------------------------------------------------------------------*
FORM BDC_DYNPRO USING   P_PROGRAM  TYPE ANY
P_DYNPRO   TYPE ANY
CHANGING P_T_BDC    TYPE TYP_BDCDATA.

DATA: LW_BDC TYPE BDCDATA.

LW_BDC-PROGRAM = P_PROGRAM.
LW_BDC-DYNPRO  = P_DYNPRO.
LW_BDC-DYNBEGIN = C_ON.
APPEND LW_BDC TO P_T_BDC.

ENDFORM.                    " BDC_DYNPRO
*&---------------------------------------------------------------------*
*&      Form  BDC_VALUE
*&---------------------------------------------------------------------*
*       BDCデータ作成
*----------------------------------------------------------------------*
*      -->P_FNAME      項目名
*      -->P_FVAL       BDC 項目値
*      <--P_T_BDC      BDC内部テーブル
*----------------------------------------------------------------------*
FORM BDC_VALUE USING    P_FNAM  TYPE ANY
P_FVAL  TYPE ANY
CHANGING P_T_BDC  TYPE TYP_BDCDATA.
DATA: LW_BDC TYPE BDCDATA.

LW_BDC-FNAM = P_FNAM.
LW_BDC-FVAL  = P_FVAL.
APPEND LW_BDC TO P_T_BDC.

ENDFORM.                    " BDC_VALUE
*&---------------------------------------------------------------------*
*&      Form  INSERT_YN_20_POINT_COMPARA
*&---------------------------------------------------------------------*
*       データ登録
*----------------------------------------------------------------------*
*      -->P_GRID_DATA         元データ
*      -->P_CSTS_1            明細１のステータス
*      -->P_CSTS_2            明細２のステータス
*      -->P_KUBUN             処理区分(10:売上照合,20:仕入照合)
*      -->P_KNETXAMT          税込金額(部分照合差額)
*      <--P_T_GRID_DATA_0100  新規登録データ(ALV一覧用)
*      <--P_RC_CODE           リターンコード(エラーハンドリング用)
*----------------------------------------------------------------------*
FORM INSERT_YN_20_POINT_COMPARA USING    P_GRID_DATA
TYPE TYP_GRID_DATA_0100
P_CSTS_1
P_CSTS_2
P_KUBUN
P_KNETXAMT
CHANGING P_T_GRID_DATA_0100
TYPE TTYP_GRID_DATA_0100
P_RC_CODE.
DATA: L_TNAME(10)         TYPE C.
DATA: L_S_YN_20           LIKE YN120,
LW_GRID_DATA_0100   TYPE TYP_GRID_DATA_0100,
LW_KNETXAMT         TYPE YNETXAMT,
LW_YEAR             TYPE GJAHR,             "会計年度算出用
LW_POINT_COMPARE    TYPE TYP_POINT_COMPARE, "画面出力用データ
LW_GJAHR            TYPE YNDOCGJAHR,        "伝票会計年度
LW_SLPDOC           TYPE YNSLPDOC,          "伝票番号
LW_DTLDOC           TYPE YNDTLDOC.          "伝票明細番号
CLEAR RC_CODE.

* 会計年度算出
CALL FUNCTION 'BAPI_COMPANYCODE_GET_PERIOD'
EXPORTING
COMPANYCODEID = P_GRID_DATA-YNBUKRS
POSTING_DATE  = P_GRID_DATA-YNLDATE1   "請求日/入庫日
IMPORTING
FISCAL_YEAR   = LW_YEAR.

* 明細番号存在チェック
IF P_KUBUN = C_KUBUN_EXTERNAL.               "外部データの場合
LW_GJAHR    = P_GRID_DATA-YNGJAHR1.
LW_SLPDOC   = P_GRID_DATA-YNSLPDOC1.
LW_DTLDOC   = P_GRID_DATA-YNDTLDOC1 + 1000.
ELSE.                                        "自社データの場合
LW_GJAHR    = P_GRID_DATA-YNGJAHR2.
LW_SLPDOC   = P_GRID_DATA-YNSLPDOC2.
LW_DTLDOC   = P_GRID_DATA-YNDTLDOC2 + 1000.
ENDIF.
* 部分照合データが存在するかどうかチェック
* 存在する場合は最大値を取得する
SELECT DTLDOC
INTO LW_DTLDOC
FROM YN220
WHERE GJAHR   = LW_GJAHR
AND SLPDOC  = LW_SLPDOC
AND DTLDOC  > 1000
AND VRFCTON = P_GRID_DATA-YNVRFCTON
AND BUKRS   = P_GRID_DATA-YNBUKRS.
ENDSELECT.
* 取得できない場合
IF SY-SUBRC <> 0.
IF P_KUBUN = C_KUBUN_EXTERNAL.
LW_DTLDOC = P_GRID_DATA-YNDTLDOC1 + 1000.
ELSE.
LW_DTLDOC = P_GRID_DATA-YNDTLDOC2 + 1000.
ENDIF.
ELSE.
LW_DTLDOC = LW_DTLDOC + 1000.
ENDIF.

*-----１明細目
CONCATENATE 'YN' P_MODE C_KUBUN_INTERNAL INTO L_TNAME.
* DBデータ作成
L_S_YN_20-MANDT    = SY-MANDT.
L_S_YN_20-GJAHR    = LW_GJAHR.
L_S_YN_20-SLPDOC   = LW_SLPDOC.
L_S_YN_20-DTLDOC   = LW_DTLDOC.
L_S_YN_20-VRFCTON  = P_GRID_DATA-YNVRFCTON.
L_S_YN_20-BUKRS    = P_GRID_DATA-YNBUKRS.
L_S_YN_20-ZFBDT    = P_GRID_DATA-YNZFBDT.
L_S_YN_20-PRCTR    = P_GRID_DATA-YNPRCTR.
L_S_YN_20-PERNR    = SY-UNAME.
L_S_YN_20-DVSON    = P_GRID_DATA-YNDVSON.
L_S_YN_20-TGTFLG   = SPACE.
L_S_YN_20-CSTS     = P_CSTS_1.
L_S_YN_20-COMMT    = P_GRID_DATA-YNSGTXT.
L_S_YN_20-YNGJAHR  = LW_YEAR.
L_S_YN_20-BELNR    = P_GRID_DATA-YNBELNR.
L_S_YN_20-BUZEI    = 1.
L_S_YN_20-KNQUAN   = 1.
L_S_YN_20-KNUNIT   = P_GRID_DATA-YNKNUNIT.
L_S_YN_20-KNUNTPRC = P_GRID_DATA-YNKNUNTPRC.
L_S_YN_20-KNTAXAMT = 0.
L_S_YN_20-KNITXAMT = 0.
L_S_YN_20-KNETXAMT = P_KNETXAMT.
L_S_YN_20-WAERS    = P_GRID_DATA-YNWAERS.
L_S_YN_20-CHKDOC   = P_GRID_DATA-YNCHKDOC.
L_S_YN_20-CHKDAT   = P_GRID_DATA-YNCHKDAT.
L_S_YN_20-CHKUSR   = SY-UNAME.
L_S_YN_20-UPDDAT   = SY-DATUM.
L_S_YN_20-UPDTIM   = SY-UZEIT.
L_S_YN_20-UPDUSR   = SY-UNAME.
L_S_YN_20-UPDPRG   = 'YN010400'.
L_S_YN_20-CKEY1    = P_GRID_DATA-YNCKEY1.
L_S_YN_20-CKEY2    = P_GRID_DATA-YNCKEY2.
L_S_YN_20-LIST1    = P_GRID_DATA-YNLIST1.
L_S_YN_20-LIST2    = P_GRID_DATA-YNLIST2.
L_S_YN_20-LIST3    = P_GRID_DATA-YNLIST3.
L_S_YN_20-LIST4    = P_GRID_DATA-YNLIST4.
L_S_YN_20-LIST5    = P_GRID_DATA-YNLIST5.
L_S_YN_20-LIST6    = P_GRID_DATA-YNLIST6.
L_S_YN_20-LIST7    = P_GRID_DATA-YNLIST7.
L_S_YN_20-LIST8    = P_GRID_DATA-YNLIST8.
L_S_YN_20-INSDT    = SY-DATUM.
L_S_YN_20-LDATE1   = P_GRID_DATA-YNLDATE1.
L_S_YN_20-CZFBDT   = P_CZFBDT.
L_S_YN_20-AUTOFLG  = P_KUBUN+0(1).

INSERT INTO (L_TNAME) VALUES L_S_YN_20.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_DB_ERROR.
EXIT.
ENDIF.

* 画面表示データ作成
LW_GRID_DATA_0100 = P_GRID_DATA.
LW_GRID_DATA_0100-YNPERNR    = SY-UNAME.
LW_GRID_DATA_0100-YNCSTS     = P_CSTS_1.
LW_GRID_DATA_0100-YNBUZEI    = 1.
LW_GRID_DATA_0100-YNKNITXAMT = 0.
LW_GRID_DATA_0100-YNKNETXAMT = P_KNETXAMT.
LW_GRID_DATA_0100-YNCHKUSR   = SY-UNAME.
LW_GRID_DATA_0100-YNUPDDAT   = SY-DATUM.
LW_GRID_DATA_0100-YNUPDTIM   = SY-UZEIT.
LW_GRID_DATA_0100-YNUPDUSR   = SY-UNAME.
LW_GRID_DATA_0100-YNUPDPRG   = SY-REPID.
LW_GRID_DATA_0100-YNINSDT    = SY-DATUM.
APPEND LW_GRID_DATA_0100 TO P_T_GRID_DATA_0100.

*-----２明細目
L_S_YN_20-DTLDOC   = L_S_YN_20-DTLDOC + 1000.
L_S_YN_20-BUZEI    = 2.
L_S_YN_20-CSTS     = P_CSTS_2.
LW_KNETXAMT = P_KNETXAMT * -1.
L_S_YN_20-KNETXAMT = LW_KNETXAMT .

INSERT INTO (L_TNAME) VALUES L_S_YN_20.
IF SY-SUBRC <> 0.
ROLLBACK WORK.
RC_CODE = C_RC_CODE_DB_ERROR.
EXIT.
ENDIF.

* ＤＢデータ
LW_GRID_DATA_0100-YNCSTS     = P_CSTS_1.
LW_GRID_DATA_0100-YNBUZEI    = 2.
LW_GRID_DATA_0100-YNKNETXAMT = LW_KNETXAMT .
APPEND LW_GRID_DATA_0100 TO P_T_GRID_DATA_0100.

*----- 処理結果画面用データ
LW_POINT_COMPARE-BUKRS   = P_GRID_DATA-YNBUKRS.
LW_POINT_COMPARE-VRFCTON = P_GRID_DATA-YNVRFCTON.
LW_POINT_COMPARE-BELNR   = P_GRID_DATA-YNBELNR.
APPEND LW_POINT_COMPARE TO GT_POINT_COMPARE.

ENDFORM.                    " INSERT_YN_20_POINT_COMPARA
*&---------------------------------------------------------------------*
*&      Form  SET_T_ALV_SET_0100
*&---------------------------------------------------------------------*
*       部分照合差分結果(差額)の金額変更
*----------------------------------------------------------------------*
FORM SET_T_ALV_SET_0100.
DATA:LW_CHANGE_CELL  TYPE LVC_S_MODI.
FIELD-SYMBOLS: <FS> TYPE TYP_GRID_DATA_0100.

LOOP AT GT_CHANGE_CELL INTO LW_CHANGE_CELL.
READ TABLE  T_GRID_DATA_0100 ASSIGNING <FS>
INDEX LW_CHANGE_CELL-ROW_ID.
IF SY-SUBRC = 0.
<FS>-YNKNETXAMT5 = LW_CHANGE_CELL-VALUE.
ENDIF.
ENDLOOP.

ENDFORM.                    " SET_T_ALV_SET_0100
*&---------------------------------------------------------------------*
*&      Form  PROCESS_EVENT_ENTER_100
*&---------------------------------------------------------------------*
*       画面情報リフレッシュ判定
*----------------------------------------------------------------------*
FORM PROCESS_EVENT_ENTER_100 .

DATA: L_EVTID TYPE I.
DATA: L_LINES TYPE I.

* Enter押下時に、GT_CHANGE_CELLに値が設定されている場合は
* 画面情報リフレッシュ
IF NOT CL_GUI_ALV_GRID=>CUR_EVENT IS INITIAL.
L_EVTID = CL_GUI_ALV_GRID=>CUR_EVENT->EVENTID.
IF L_EVTID = 19.  " ENTER
DESCRIBE TABLE GT_CHANGE_CELL LINES L_LINES.
IF L_LINES <> 0.
CALL METHOD OBJ_GRID_0100->REFRESH_TABLE_DISPLAY.
CALL METHOD CL_GUI_CFW=>FLUSH.
ENDIF.
ENDIF.
ENDIF.

ENDFORM.                    " PROCESS_EVENT_ENTER_100
