************************************************************************
*  高千穂電気プロジェクト・ＥＤＩ納期回答更新＆モニタリスト作成
************************************************************************
*  [プログラム名]
*  　ZE010200
*  [処理概要]
*　　1.納期回答データの回答納期で購買発注伝票を更新する
*　　2.期回答データをチェックし、エラーのデータは納期回答モニタリスト　
*　　　に表示する。
*　　3.納期回答データから納期回答モニタリストを作成する。　　　　　
*　　　EDIモニタリスト
*　　　対象データ全件を出力する。エラーがあった時も混在出力。
*　　　出力順
*　　　プラント/購買担当/発注先（仕入先）/発注番号
*　　　改ページ
*　　　プラント/購買担当
*　　4.注意・制限事項　
*  　　自動で動かす場合は、納期回答データ全てを対象とし、出力先プラント
*　　　単位。プラントを決定出来無い時選択画面で指定したプラント名。
*    5.チェック条件変更：2002.11.11
************************************************************************
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2002/01/25   PSD M.Anekawa     新規開発
*  2002/02/25   PSD M.Arai        ファイルタイプ変更対応
*  2002/02/26   PSD M.Arai        数量属性変更対応
*  2002/03/20   PSD T.SAITOH      ISOコードからR/3基本数量単位に変換
*  2002/03/22   PSD M.ARAI        テキスト更新内容設定不具合
*  2002/03/28   NDSC R.TOMOEDA    構造体ZE0110変更
*                                 R/3品目コード←→仕入先品目コード
*  2002.03.28  NDSC R.TOMOEDA     GF_REPLY-MATNR → KDMAT
*                                 GF_REPLY-KDMAT → MATNR
*  2002.03.28  NDSC R.TOMOEDA     数量単位変換位置変更
*  2002/03/29  psd m.arai         注文数量設定条件変更
*  2002/03/29  psd m.arai         回答納期設定書式変更
*  2002/06/20  PSD T.SAITOH       再移送
*  2002/07/31  NDSC R.Hata        ファイルクリア追加
*  2002/11/18  NDSC R.TOMOEDA     チェック条件変更
*  2010/03/09  SOLFIS R.Hata      プリンタ決定を標準プリンタのみに変更
*  2011/12/08  SOLFIS C.Maruta    DMW3647
*                                 出力画面の納期回答の属性変更
*& 2012/08/21  ISID               ES-UP
************************************************************************
REPORT  ZE010200  NO STANDARD PAGE HEADING
LINE-SIZE 170
LINE-COUNT 58.
*                                  LINE-COUNT 65.


************************************************************************
*　TYPES
************************************************************************
* ↓ DELETE 2002.02.25 PSD M.Arai ファイルタイプ変更対応
***ファイル
*TYPES: BEGIN   OF   REPLY1_DATA,
*       DATANO(5)      TYPE  C,                             "ﾃﾞｰﾀ処理NO
*       DATACODE(4)    TYPE  C,                           "情報区分ｺｰﾄﾞ
*       DATADAY(6)     TYPE  C,                             "ﾃﾞｰﾀ作成日
*       PARNR(12)      TYPE  C,                             "発注者ｺｰﾄﾞ
*       LIFNR(12)      TYPE  C,                             "受注者ｺｰﾄﾞ
*       WERKS(8)       TYPE  C,                           "発注部門ｺｰﾄﾞ
*       EBELN(23)      TYPE  C,                               "注文番号
*       MFRNR(19)      TYPE  C,                               "製造番号
*       CORRECTION(1)  TYPE  C,                               "訂正ｺｰﾄﾞ
*       KOKU(1)        TYPE  C,                                "ｺｯｸ区分
*       MEINS(3)       TYPE  C,                                   "単位
*       MENGE(12)      TYPE  C,                               "注文数量
*       EKGRP(7)       TYPE  C,                               "購買担当
*       IDNLF(25)      TYPE  C,                       "受注者品目名ｺｰﾄﾞ
*       MATNR(25)      TYPE  C,                         "発注者品目ｺｰﾄﾞ
*       EINDT(6)       TYPE  C,                                   "納期
*       EINNO(8)       TYPE  C,                                 "納期NO
*       ANSWER(6)      TYPE  C,                               "回答納期
*       MENGE1(12)     TYPE  C,                               "回答数量
*       MARK(1)        TYPE  C,                                "確認ﾏｰｸ
*       NOTE1(30)      TYPE  C,                                   "備考
*       MATBU1(20)     TYPE  C,                             "発注部門名
*       EKGRPNM(14)    TYPE  C,                         "購買担当(漢字)
*       NOTE2(60)      TYPE  C,                             "備考(漢字)
*       MATBU2(40)     TYPE  C,                     "発注者部門名(漢字)
*       END   OF   REPLY1_DATA.
*
****ファイル(テーブルの型)
*TYPES: BEGIN   OF   REPLY2_DATA,
*       DATANO(5)      TYPE  C,                             "ﾃﾞｰﾀ処理NO
*       DATACODE(4)    TYPE  C,                           "情報区分ｺｰﾄﾞ
*       DATADAY(6)     TYPE  C,                             "ﾃﾞｰﾀ作成日
*       PARNR(12)      TYPE  C,                             "発注者ｺｰﾄﾞ
*       LIFNR(10)      TYPE  C,                             "受注者ｺｰﾄﾞ
*       WERKS(4)       TYPE  C,                           "発注部門ｺｰﾄﾞ
*       EBELN(23)      TYPE  C,                               "注文番号
*       MFRNR(19)      TYPE  C,                               "製造番号
*       CORRECTION(1)  TYPE  C,                               "訂正ｺｰﾄﾞ
*       KOKU(1)        TYPE  C,                                "ｺｯｸ区分
*       MEINS(3)       TYPE  C,                                   "単位
*       MENGE(12)      TYPE  C,                               "注文数量
*       EKGRP(3)       TYPE  C,                               "購買担当
*       IDNLF(35)      TYPE  C,                       "受注者品目名ｺｰﾄﾞ
*       MATNR(18)      TYPE  C,                         "発注者品目ｺｰﾄﾞ
*       EINDT(6)       TYPE  C,                                   "納期
*       EINNO(8)       TYPE  C,                                 "納期NO
*       ANSWER(6)      TYPE  C,                               "回答納期
*       MENGE1(13)     TYPE  C,                               "回答数量
*       MARK(1)        TYPE  C,                                "確認ﾏｰｸ
*       NOTE1(30)      TYPE  C,                                   "備考
*       MATBU1(20)     TYPE  C,                             "発注部門名
*       EKGRPNM(14)    TYPE  C,                         "購買担当(漢字)
*       NOTE2(60)      TYPE  C,                             "備考(漢字)
*       MATBU2(40)     TYPE  C,                     "発注者部門名(漢字)
*       END   OF   REPLY2_DATA.
* ↑ DELETE 2002.02.25 PSD M.Arai ファイルタイプ変更対応

***DATACHANGE
* ↓ DELETE 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*TYPES: BEGIN OF TYP_CHANGE,
*       CHANGE(512) TYPE C,                            "ﾌｧｲﾙ読込用構造
*       END OF TYP_CHANGE.
* ↑

***リスト
TYPES: BEGIN   OF   LIST_DATA,
WERKS(4)       TYPE  C,                                     "部門
WERKSNM(20)    TYPE  C,                                   "部門名
EKGRP(3)       TYPE  C,                               "購買ｸﾞﾙｰﾌﾟ
EKGRPNM(18)    TYPE  C,                             "購買ｸﾞﾙｰﾌﾟ名
LIFNR(10)      TYPE  C,                                   "手配先
LIFNRNM(34)    TYPE  C,                                 "手配先名
EBELN(23)      TYPE  C,                                 "発注番号
MATNR(18)      TYPE  C,                                 "品目ｺｰﾄﾞ
MATNRNM(30)    TYPE  C,                                     "品名
IDNLF(25)      TYPE  C,                           "仕入先品目ｺｰﾄﾞ
* ↓ modify 2002.02.26 psd m.arai 数量属性変更対応
*       MENGE3(11)     TYPE  C,                               "回答数量
MENGE3         TYPE  P DECIMALS 3,                      "回答数量
* ↑
MEINS(3)       TYPE  C,                                 "単位
*   modify 2011/12/8 C.MARUTA DMW3647{
*       REPLY          TYPE  D,                                "納期期日
REPLY(8)       TYPE  C,                                 "納期期日
* } modify 2011/12/8 C.MARUTA DMW3647
* ↓ modify 2002.02.26 psd m.arai 数量属性変更対応
*       MENGE(11)      TYPE  C,                                "発注数量
MENGE          TYPE  P DECIMALS 3,                      "発注数量
* ↑
EINDT          TYPE  D,                                 "希望納期
EBELNER(18)    TYPE  C,                              "発注番号ｴﾗｰ
MATNRER(18)    TYPE  C,                              "品目ｺｰﾄﾞｴﾗｰ
IDNLFER(25)    TYPE  C,                        "仕入先品目ｺｰﾄﾞｴﾗｰ
MENGEER(15)    TYPE  C,                        "数量ERR
MEINSER(3)     TYPE  C,                                  "単位ｴﾗｰ
END   OF   LIST_DATA.

************************************************************************
*　DATA
************************************************************************

***ファイルより読込時(",")CUT
DATA:
*      GT_CHANGE    TYPE   TABLE OF TYP_CHANGE,                 "内部TBL
*      GF_CHANGE    TYPE   TYP_CHANGE,                             "構造
G_DATA(50)   TYPE   C,                             "("､")をCUT文字
G_FLAG3      TYPE   P,                               "処理行数FLAG
G_LEN        TYPE   P,                                 "文字の長さ
G_FLAG4      TYPE   P,                       "READ DATASETのREAD数
G_FLAG5      TYPE   P.              "READ DATASETが1行も読めない時

***納期回答更新
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*DATA: GT_REPLY     TYPE   TABLE OF REPLY2_DATA.               "内部TBL
*DATA: GF_REPLY     TYPE   REPLY2_DATA.                           "構造
DATA: GF_REPLY     TYPE          ZE0110,
GT_REPLY     LIKE TABLE OF GF_REPLY.
* ↑

***モニタリスト
DATA: GT_LIST     TYPE   TABLE OF LIST_DATA.                    "内部TBL
DATA: GF_LIST     TYPE   LIST_DATA.                                "構造

***注文番号分離時に格納
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*DATA: G_WERKS     LIKE   GF_REPLY-WERKS,                      "ﾌﾟﾗﾝﾄ名
DATA: G_HBMO_CD    LIKE   GF_REPLY-HBMO_CD,                    "ﾌﾟﾗﾝﾄ名
* ↑
G_EBELN     TYPE   EKPO-EBELN,                           "発注番号
G_EBELP     TYPE   EKPO-EBELP.                           "明細番号

***取引先機能ＤＢ仕入先コードチェック
DATA: GF_WYT3     TYPE   WYT3,                             "取引先機能DB
G_NAME2     TYPE   LFA1-NAME2,                 "NAME2でEKGRPをCHEK
G_EKPO      TYPE   EKPO,                             "購買伝票明細
G_FLAG1     TYPE   P,                         "LFA1からNAME2抽出×
G_FLAG2     TYPE   P,                                "WYT3に仕入×
G_FLAG6     TYPE   P,                            "有得無いﾌﾟﾗﾝﾄｴﾗｰ
G_FLAG9     TYPE   P.                           "ﾌﾟﾗﾝﾄｴﾗｰ時別処理

DATA: L_MEINS TYPE EKPO-MEINS.
***汎用モジュール(CREATE_TEXT)
DATA: GT_TLINE    TYPE   TABLE  OF   TLINE WITH HEADER LINE.

***レポート出力
DATA: GF_T001W1             TYPE  T001W,                          "ﾌﾟﾗﾝﾄ
GF_T001W2             TYPE  T001W,                          "ﾌﾟﾗﾝﾄ
G_NAME1               TYPE  LFA1-NAME1,                   "ﾌﾟﾗﾝﾄ名
G_MATKX               TYPE  MAKT-MAKTX,                      "品名
G_EKNAM               TYPE  T024-EKNAM,                "購買担当名
G_PRINT_DEST          TYPE  TSP03-PADEST,              "ﾌﾟﾘﾝﾀｱﾄﾞﾚｽ
G_PARAMS              LIKE  PRI_PARAMS,           "SPOOL印刷ﾊﾟﾗﾒﾀｰ
G_LISTNAME            LIKE  PRI_PARAMS-PLIST,         "SPOOL依頼名
G_LISTTEXT            LIKE  PRI_PARAMS-PRTXT,       "SPOOL依頼ﾃｷｽﾄ
G_VALID               TYPE  C,                        "SPOOL受取側
G_WERKSFLAG           LIKE  GF_LIST-WERKS,      "改ﾍﾟｰｼﾞﾌﾗｸﾞ･ﾌﾟﾗﾝﾄ
G_EKGRPFLAG           LIKE  GF_LIST-EKGRP,   "改ﾍﾟｰｼﾞﾌﾗｸﾞ･購買担当
G_LIFNRFLAG           LIKE  GF_LIST-LIFNR,             "手配先ﾌﾗｸﾞ
G_FLAG7               TYPE  P,                   "出力ﾃﾞﾊﾞｲｽ×の時
G_FLAG8               TYPE  P.                      "SPOOLが○の時
* Add ES-UP 2012/08/21 -->
DATA G_CODEPAGE TYPE ABAP_ENCODING.
* Add ES-UP 2012/08/21 <--
************************************************************************
*  定数宣言
************************************************************************
CONSTANTS: CNS_P360(4)     TYPE  C  VALUE  'P360',      "P_WERKSの初期値
CNS_T001W(5)    TYPE  C  VALUE  'T001W',
CNS_WYT3(4)     TYPE  C  VALUE  'WYT3',
CNS_LFA1(4)     TYPE  C  VALUE  'LFA1',
CNS_EKPO(4)     TYPE  C  VALUE  'EKPO',
CNS_T024(4)     TYPE  C  VALUE  'T024',
CNS_MAKT(4)     TYPE  C  VALUE  'MAKT',
CNS_ADR10(5)    TYPE  C  VALUE  'ADR10',
CNS_F04(3)      TYPE  C  VALUE  'F04',
CNS_J(1)        TYPE  C  VALUE  'J',
CNS_X(1)        TYPE  C  VALUE  'X',
CNS_58(2)       TYPE  C  VALUE  '58',
CNS_170(3)      TYPE  C  VALUE  '170',
CNS_X_PAPER(8)  TYPE  C  VALUE  'X_58_170',
CNS_1(1)        TYPE  C  VALUE  '1',
CNS_1000(4)     TYPE  C  VALUE  '1000',
CNS_Z1(2)       TYPE  C  VALUE  'Z1',
CNS_NULL(1)     TYPE  C  VALUE  ' ',
CNS_HAIFUN(1)   TYPE  C  VALUE  '-',
CNS_SURASH(1)   TYPE  C  VALUE  '/',
CNS_KAKOAKI(1)  TYPE  C  VALUE  '(',
CNS_KAKOTOJI(1) TYPE  C  VALUE  ')',
CNS_P(1)        TYPE  C  VALUE  'P',
CNS_0(1)        TYPE  C  VALUE  '0',
CNS_00(2)       TYPE  C  VALUE  '00',
CNS_CVS(3)      TYPE  C  VALUE  '","',
CNS_DATA2(2)    TYPE  C  VALUE  '40',
CNS_CREATE(11)  TYPE  C  VALUE  'CREATE_TEXT',
CNS_ASTER3(3)   TYPE  C  VALUE  '***',
CNS_ASTER8(8)   TYPE  C  VALUE  '********',
CNS_ASTER9(9)   TYPE  C  VALUE  '*********',
CNS_ASTER18(18) TYPE  C  VALUE  '******************',
CNS_ASTER23(23) TYPE  C  VALUE  '***********************',
CNS_ASTER25(25) TYPE  C  VALUE  '*************************'.
* Add ES-UP 2012/08/21 -->
CONSTANTS CNS_SJIS TYPE STRING VALUE `shift_jis`.
* Add ES-UP 2012/08/21 <--
************************************************************************
*  選択画面
************************************************************************
*SELECTION-SCREEN SKIP 1.                                 "空白行（1行）
*SELECTION-SCREEN SKIP 1.                                 "空白行（1行）
*SELECTION-SCREEN SKIP 1.                                 "空白行（1行）
*SELECTION-SCREEN BEGIN OF LINE.                             "行纏め開始
*SELECTION-SCREEN COMMENT 10(8) TEXT-001 FOR FIELD P_WERKS. "ﾌﾟﾗﾝﾄ名ﾃｷｽﾄ
*SELECTION-SCREEN POSITION 30.                        "P_WERKSを30行目〜
PARAMETERS: P_WERKS TYPE EKPO-WERKS DEFAULT CNS_P360.             "ﾌﾟﾗﾝﾄ
*SELECTION-SCREEN END OF LINE.                               "行纏め終了
*SELECTION-SCREEN SKIP 1.                                 "空白行（1行）
*SELECTION-SCREEN SKIP 1.                                 "空白行（1行）
*SELECTION-SCREEN SKIP 1.                                 "空白行（1行）
*SELECTION-SCREEN BEGIN OF LINE.                             "行纏め開始
*SELECTION-SCREEN COMMENT 10(18) TEXT-002 FOR FIELD P_FILE.  "ﾌｧｲﾙ名ﾃｷｽﾄ
*SELECTION-SCREEN POSITION 30.                         "P_FILEを30行目〜
PARAMETERS: P_FILE(60) TYPE C OBLIGATORY.                    "入力ﾌｧｲﾙ
*SELECTION-SCREEN END OF LINE.                               "行纏め終了

************************************************************************
*  イベント処理　INITIALIZATION
************************************************************************
INITIALIZATION.

************************************************************************
* イベント処理　AT SELECTION-SCREEN　入力チェック
************************************************************************
AT SELECTION-SCREEN.

***入力チェック
DATA: LF_T001W    TYPE   T001W.

****選択画面入力プラントチェック***
SELECT SINGLE *
INTO LF_T001W
FROM T001W
WHERE WERKS = P_WERKS.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE I021(Z1) WITH P_WERKS.
STOP.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_T001W CNS_SURASH SY-SUBRC.
ENDCASE.

************************************************************************
*　イベント処理　START-OF-SELECTION　主処理
************************************************************************
START-OF-SELECTION.
*****入力ファイル読込*ファイルオープン***
* Mod ES-UP 2012/08/21 -->
*  OPEN DATASET P_FILE FOR INPUT IN TEXT MODE.
G_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_SJIS ).
OPEN DATASET P_FILE FOR INPUT
IN LEGACY TEXT MODE CODE PAGE G_CODEPAGE
IGNORING CONVERSION ERRORS.
* Mod ES-UP 2012/08/21 <--
IF SY-SUBRC <> CNS_0.
MESSAGE S306(Z1) WITH TEXT-002 P_FILE.
CLOSE DATASET P_FILE.
EXIT.
ENDIF.

DO.
***ファイルの読込
* ↓ DELETE 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*    READ DATASET P_FILE INTO GF_CHANGE.
READ DATASET P_FILE INTO GF_REPLY.
CASE SY-SUBRC.
WHEN 0.                                                  "READ○
G_FLAG4 = G_FLAG4 + CNS_1.
* ↓ DELETE 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*          PERFORM FRM_DATACHANGE.              "取得項目より（","）CUT
* ↑
PERFORM FRM_DATA_SORT.               "DATA注文番号を昇順にSORT
WHEN OTHERS.                                             "READ×
IF G_FLAG4 = CNS_0.
G_FLAG5 = CNS_1.
CLOSE DATASET P_FILE.
MESSAGE S621(Z1).
EXIT.
ENDIF.
CLOSE DATASET P_FILE.
EXIT.
ENDCASE.
ENDDO.
**
IF G_FLAG5 = CNS_1.                   "READ DATASETが1行も読めない時
EXIT.
CLEAR G_FLAG5.
ENDIF.
PERFORM FRM_CLEAR1.                        "ファイル読込項目クリア
*****更新処理とモニタリスト取得*****
LOOP AT GT_REPLY INTO GF_REPLY.
****取引先機能DB仕入先ｺｰﾄﾞﾁｪｯｸ
PERFORM FRM_WYT3_CHECK.
*    IF G_FLAG1 <> CNS_1.      "LIFN2のDBからNAME2が抽出出来ない時処理×
***プラント抽出処理
IF G_FLAG9 <> CNS_1.
PERFORM FRM_REPORT_T001W_SELECT.
ENDIF.
*    IF G_FLAG6 <> CNS_1.                              "ﾌﾟﾗﾝﾄｴﾗｰ｡ﾌﾟﾗﾝﾄ×
***仕入先抽出処理
*    IF G_FLAG2 <> CNS_1.                "仕入ｺｰﾄﾞがWYT3に×時LFA1抽出×
PERFORM FRM_REPORT_LFA1_SELECT.
*    ENDIF.
***購買グループ抽出処理
PERFORM FRM_REPORT_T024_SELECT.
***品目テキスト抽出処理とその他リスト構造に代入
PERFORM FRM_REPORT_MAKT_SELECT.
APPEND GF_LIST TO GT_LIST.
*    ENDIF.
*    ENDIF.
PERFORM FRM_CLEAR2.                               "ﾓﾆﾀﾘｽﾄ抽出項目ｸﾘｱ
ENDLOOP.
*****ＳＰＯＯＬ*****
***プラントＳＯＲＴ
*  SORT GT_LIST ASCENDING  BY WERKS.
* ソート順不具合対応 2002/03/31 APPEND
SORT GT_LIST ASCENDING  BY WERKS  EKGRP LIFNR EBELN.
LOOP AT GT_LIST INTO GF_LIST.
***プリンタアドレス取得
PERFORM FRM_ADR10.
***プラント毎にＳＰＯＯＬ
IF G_FLAG7 <> CNS_1.
PERFORM FRM_NEW_PAGE_PRINT_ON.
G_FLAG8 = CNS_1.
* 購買担当改ページ不具合 ↓
***購買担当改ページ
IF G_EKGRPFLAG <> GF_LIST-EKGRP.
CLEAR G_LIFNRFLAG.
NEW-PAGE.
ENDIF.
* ↑
***ＷＲＩＴＥ
PERFORM FRM_WEITE_MONITER_LIST.
ENDIF.
G_WERKSFLAG = GF_LIST-WERKS.
G_LIFNRFLAG = GF_LIST-LIFNR.
G_EKGRPFLAG = GF_LIST-EKGRP.
CLEAR G_FLAG7.
ENDLOOP.
***ＳＰＯＯＬ終了
*---APPEND START PSD T.SAITOH 2002/08/08 ---------------------------*
* バックグラウンドでないときのみ画面出力処理を行なう
IF SY-BATCH <> 'X'.
*---APPEND END   PSD T.SAITOH 2002/08/08 ---------------------------*
NEW-PAGE PRINT OFF.
*---APPEND START PSD T.SAITOH 2002/08/08 ---------------------------*
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/08/08 ---------------------------*
IF G_FLAG8 = CNS_1.
MESSAGE S022(Z1).
ENDIF.
PERFORM FRM_CLEAR3.                                "ﾓﾆﾀﾘｽﾄ抽出項目ｸﾘｱ
*---APPEND START PSD T.SAITOH 2002/08/08 ---------------------------*
* バックグラウンドでないときのみ画面出力処理を行なう
IF SY-BATCH <> 'X'.
*---APPEND END   PSD T.SAITOH 2002/08/08 ---------------------------*
*****画面出力*****
***プラント･購買担当･手配先･発注番号ＳＯＲＴ
SORT GT_LIST ASCENDING  BY WERKS  EKGRP LIFNR EBELN.
LOOP AT GT_LIST INTO GF_LIST.
***プラント改ページ
IF G_WERKSFLAG <> GF_LIST-WERKS.
CLEAR G_LIFNRFLAG.
NEW-PAGE.
ENDIF.
***購買担当改ページ
IF G_EKGRPFLAG <> GF_LIST-EKGRP.
CLEAR G_LIFNRFLAG.
NEW-PAGE.
ENDIF.
***ＷＲＩＴＥ
PERFORM FRM_WEITE_MONITER_LIST.
G_WERKSFLAG = GF_LIST-WERKS.
G_EKGRPFLAG = GF_LIST-EKGRP.
G_LIFNRFLAG = GF_LIST-LIFNR.
ENDLOOP.
*---APPEND START PSD T.SAITOH 2002/08/08 ---------------------------*
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/08/08 ---------------------------*
PERFORM FRM_CLEAR3.                                 "ﾓﾆﾀﾘｽﾄ出力項目ｸﾘｱ
*Add 2002.07.31 >>>
DELETE DATASET P_FILE .
*Add 2002.07.31 <<<
************************************************************************
* イベント処理  AT LINE-SELECTION
************************************************************************
AT LINE-SELECTION.

*SCROLL LIST INDEX SY-LSIND TO FIRST PAGE.

************************************************************************
* イベント処理  TOP OF PAGE
************************************************************************
TOP-OF-PAGE.

WRITE:/47 TEXT-004, 98 TEXT-006,
106(8) SY-DATUM+2(6) USING EDIT MASK '__/__/__',
118(5) SY-UZEIT+0(4) USING EDIT MASK '__:__'.
WRITE: /.
WRITE:/80 TEXT-005, 85 GF_LIST-WERKS, 90 GF_LIST-WERKSNM,
111 TEXT-007, 119 GF_LIST-EKGRP, 124 GF_LIST-EKGRPNM.
WRITE: /80(61) SY-ULINE.
WRITE: /.
WRITE:/2 TEXT-008, 27 TEXT-009, 47 TEXT-010, 79 TEXT-011,
104 TEXT-012, 123 TEXT-014, 129 TEXT-015.
WRITE:/104 TEXT-013, 129 TEXT-016.
WRITE:/2(139) SY-ULINE.




************************************************************************
* イベント処理  END-OF-SELECTON.
************************************************************************
END-OF-SELECTION.



************************************************************************
* サブルーチン
************************************************************************
************************************************************************
*      Form  FRM_DATACHANGE
************************************************************************
*      RAED DATASET取得項目より（","）CUTをする処理。
************************************************************************
FORM FRM_DATACHANGE.
*  APPEND GF_CHANGE TO GT_CHANGE.
*  LOOP AT GT_CHANGE INTO GF_CHANGE.
*    SPLIT GF_CHANGE+1 AT CNS_CVS
*      INTO  GF_REPLY-DATANO     "ﾃﾞｰﾀ処理NO
*            GF_REPLY-DATACODE   "情報区分ｺｰﾄﾞ
*            GF_REPLY-DATADAY      "ﾃﾞｰﾀ作成日
*            GF_REPLY-PARNR        "発注者ｺｰﾄﾞ
*            GF_REPLY-LIFNR        "受注者ｺｰﾄﾞ
*            GF_REPLY-WERKS      "発注部門ｺｰﾄﾞ
*            GF_REPLY-EBELN          "注文番号
*            GF_REPLY-MFRNR          "製造番号
*            GF_REPLY-CORRECTION     "訂正ｺｰﾄﾞ
*            GF_REPLY-KOKU            "ｺｯｸ区分
*            GF_REPLY-MEINS              "単位
*            GF_REPLY-MENGE          "注文数量
*            GF_REPLY-EKGRP          "購買担当
*            GF_REPLY-IDNLF  "受注者品目名ｺｰﾄﾞ
*            GF_REPLY-MATNR    "発注者品目ｺｰﾄﾞ
*            GF_REPLY-EINDT              "納期
*            GF_REPLY-EINNO            "納期NO
*            GF_REPLY-ANSWER         "回答納期
*            GF_REPLY-MENGE1         "回答数量
*            GF_REPLY-MARK            "確認ﾏｰｸ
*            GF_REPLY-NOTE1              "備考
*            GF_REPLY-MATBU1       "発注部門名
*            GF_REPLY-EKGRPNM  "購買担当(漢字)
*            GF_REPLY-NOTE2        "備考(漢字)
*            GF_REPLY-MATBU2."発注者部門名(漢字)
*ENDLOOP.

ENDFORM.                    " FRM_DATACHANGE

************************************************************************
*      Form  FRM_GET_PRINT_PARAMETERS
************************************************************************
*      DATA注文番号を昇順にSORT
************************************************************************
FORM FRM_DATA_SORT.

***DATA注文番号を昇順にSORT
APPEND  GF_REPLY TO GT_REPLY.
* ↓ 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  SORT GT_REPLY ASCENDING  BY EBELN+4(10) EBELN+16(3) EBELN+1(2).
SORT GT_REPLY ASCENDING BY BSTNK+0(2)
BSTNK+3(10)
BSTNK+14(1).
* ↑
ENDFORM.                    " FRM_DATA_SORT

************************************************************************
*      Form  FRM_WYT3_CHECK
************************************************************************
*      取引先機能ＤＢ仕入先コードチェック (抽出1件以上次処理)
************************************************************************
FORM FRM_WYT3_CHECK.

***入力ファイル注文番号をプラント名・発注番号・明細番号に分離
* ↓ MODIFY 2002.02.25 ファイルタイプ変更対応
*  G_WERKS+0(1) = CNS_P.
*  G_WERKS+3(1) = CNS_0.
*  G_WERKS+1(2) = GF_REPLY-EBELN+0(2).                           "ﾌﾟﾗﾝﾄ
CONCATENATE CNS_P
GF_REPLY-BSTNK+0(2)
CNS_0
INTO G_HBMO_CD.
*  G_EBELN = GF_REPLY-EBELN+3(10).                             "発注番号
G_EBELN = GF_REPLY-BSTNK+3(10).
*  G_EBELP+0(1) = CNS_0.
*  G_EBELP+4(1) = CNS_0.
*  G_EBELP+1(3) = GF_REPLY-EBELN+15(3).                        "明細番号
CONCATENATE CNS_0 CNS_0 CNS_0
GF_REPLY-BSTNK+14(1)
CNS_0
INTO G_EBELP.
* ↑

***データチェック
***取引先機能ＤＢ仕入先コードチェック
SELECT SINGLE *  FROM  WYT3
* ↓ MODIFY 2002.02.25 ファイルタイプ変更対応
*             INTO  GF_WYT3
*             WHERE LIFNR = GF_REPLY-LIFNR
INTO CORRESPONDING FIELDS OF GF_WYT3
WHERE LIFNR = GF_REPLY-UM_CD
AND   EKORG = CNS_1000
AND   PARVW = CNS_Z1.
*↑

***SY-SUBRCが〜なら
CASE SY-SUBRC.
WHEN 0.                                                    "抽出○
PERFORM FRM_LIFNR_CHECK.
WHEN 4.                                                    "抽出×
*        GF_LIST-LIFNR = CNS_ASTER8.                      "手配先エラー
G_FLAG2 = CNS_1.
WHEN OTHERS.                                              "ｼｽﾃﾑｴﾗｰ
MESSAGE A603(Z1) WITH CNS_WYT3 CNS_SURASH SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_WYT3_CHECK

************************************************************************
*      Form  FRM_LIFNR_CHECK
************************************************************************
*      仕入先マスタチェック ( NAME2の値抽出分岐 )
************************************************************************
FORM FRM_LIFNR_CHECK.

***一件以上の時仕入先ファイルチェック
SELECT SINGLE NAME2 FROM LFA1
INTO  G_NAME2
WHERE LIFNR = GF_WYT3-LIFN2.

***仕入先ファイルチェックエラーの時
CASE SY-SUBRC.
WHEN 0.
PERFORM FRM_NAME2_CHECK.
WHEN 4.
*        GF_LIST-LIFNR = CNS_ASTER8.
*        PERFORM FRM_EKPO_SY_SUBRC_4.
G_FLAG1 = CNS_1.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_LFA1 CNS_SURASH SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_LIFNR_CHECK

************************************************************************
*      Form  FRM_NAME2_CHECK
************************************************************************
*      購買伝票：明細データチェック
************************************************************************
FORM FRM_NAME2_CHECK.
DATA:W_ERR TYPE C.
CLEAR:W_ERR.
***購買伝票:明細データチェック
SELECT SINGLE *
FROM  EKPO
INTO G_EKPO
WHERE EBELN = G_EBELN
AND   EBELP = G_EBELP.

CASE SY-SUBRC.
WHEN 0.
***2002.11.18 ADD >>>
**プラントチェック
CASE G_NAME2+0(1).
WHEN 0.
WHEN 1.
IF G_EKPO-WERKS <> G_HBMO_CD.
PERFORM FRM_WERKERROR.        "ﾌﾟﾗﾝﾄｴﾗｰのP_WERKSの抽出
GF_LIST-EBELNER = CNS_ASTER23.
W_ERR = 'X'.
ENDIF.
WHEN 2.
G_HBMO_CD = G_EKPO-WERKS.
ENDCASE.
**品目コードチェック
CASE G_NAME2+1(1).
WHEN 0.
WHEN 1.
IF G_EKPO-MATNR <> GF_REPLY-MATNR.
GF_LIST-MATNRER = CNS_ASTER18.        "品目ｺｰﾄﾞｴﾗｰ
W_ERR = 'X'.
ENDIF.
WHEN 2.
GF_REPLY-MATNR = G_EKPO-MATNR.
ENDCASE.
**仕入先品目チェック
CASE G_NAME2+2(1).
WHEN 0.
WHEN 1.
IF G_EKPO-IDNLF <> GF_REPLY-KDMAT.
GF_LIST-IDNLFER = CNS_ASTER25.        "仕入先品目ｺｰﾄﾞｴﾗｰ
W_ERR = 'X'.
ENDIF.
WHEN 2.
GF_REPLY-KDMAT = G_EKPO-IDNLF.
ENDCASE.
**数量チェック
CASE G_NAME2+3(1).
WHEN 0.
WHEN 1.
IF G_EKPO-MENGE <> GF_REPLY-KWMENG.
GF_LIST-MENGEER = '***************'.
W_ERR = 'X'.
ENDIF.
WHEN 2.
ENDCASE.
**単位チェック
CASE G_NAME2+4(1).
WHEN 0.
WHEN 1.
PERFORM FRM_MEINS_EXCHANGE USING   GF_REPLY-VRKME
CHANGING L_MEINS.
IF G_EKPO-MEINS <> L_MEINS.
GF_LIST-MEINSER = CNS_ASTER3.           "単位ｴﾗ-
W_ERR = 'X'.
ENDIF.
WHEN 2.
GF_REPLY-VRKME = G_EKPO-MEINS.
ENDCASE.
***エラーチェックが全てOKの場合：テキスト更新
IF W_ERR <> 'X'.
PERFORM FRM_CREATE1_TEXT.
ENDIF.
***2002.11.18 ADD <<<
***2002.11.18 DEL >>>
*      CASE G_NAME2+0(1).
*        WHEN '1'."NAME2が1の時
*          PERFORM FRM_NAME2_1_CHECK.
*        WHEN '2'."NAME2が2の時
*          PERFORM FRM_EKPO_NAME2_2_CHECK.
*        WHEN '3'."NAME2が3の時
*          PERFORM FRM_CREATE1_TEXT.
*        WHEN '9'."NAMEが9の時ﾓﾆﾀﾘｽﾄ作成のみ
*        WHEN OTHERS.              "NAMEの値が9の時と同じﾓﾆﾀﾘｽﾄ作成のみ
*     ENDCASE.
***2002.11.18 DEL <<<
WHEN 4.
CASE G_NAME2+0(1).
WHEN '1'."NAME2が1の時
PERFORM FRM_EKPO_SY_SUBRC_4.
PERFORM FRM_WERKERROR.            "ﾌﾟﾗﾝﾄｴﾗｰの時P_WERKSの抽出
WHEN '2'."NAME2が2の時
PERFORM FRM_EKPO_SY_SUBRC_4.
PERFORM FRM_WERKERROR.            "ﾌﾟﾗﾝﾄｴﾗｰの時P_WERKSの抽出
WHEN '3'."NAME2が3の時
PERFORM FRM_EKPO_SY_SUBRC_4.
WHEN '9'.                           "NAMEが9の時ﾓﾆﾀﾘｽﾄ作成のみ
WHEN OTHERS.              "NAMEの値が9の時と同じﾓﾆﾀﾘｽﾄ作成の時
ENDCASE.

WHEN 8.
MESSAGE A603(Z1) WITH CNS_EKPO CNS_SURASH SY-SUBRC.

ENDCASE.

ENDFORM.                    " FRM_NAME2_CHECK

************************************************************************
*      Form  FRM_EKPO_NAME2_1_CHECK
************************************************************************
*      購買伝票：明細データチェック ( NAME2 = 1 の時 )
************************************************************************
FORM FRM_NAME2_1_CHECK.
*  DATA: L_MEINS TYPE EKPO-MEINS.
***2002.03.28 ADD>>>
PERFORM FRM_MEINS_EXCHANGE USING   GF_REPLY-VRKME
CHANGING L_MEINS.
***2002.03.28 ADD <<<

***正常時テキスト更新(発注番号･明細･プラント･品目コード･数量単位)
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-WERKS = G_WERKS AND G_EKPO-EBELN = G_EBELN AND
IF G_EKPO-WERKS = G_HBMO_CD AND G_EKPO-EBELN = G_EBELN AND
*     G_EKPO-EBELP = G_EBELP AND G_EKPO-MATNR = GF_REPLY-MATNR AND
*     G_EKPO-MEINS = GF_REPLY-MEINS.
G_EKPO-EBELP = G_EBELP AND G_EKPO-MATNR = GF_REPLY-MATNR AND
G_EKPO-MEINS = L_MEINS.
*    G_EKPO-MEINS = GF_REPLY-VRKME.
* ↑
PERFORM FRM_CREATE1_TEXT.

ENDIF.

***モニタリストエラー項目(発注番号･明細･プラント･品目コード･数量単位)
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-WERKS <> G_WERKS.
IF G_EKPO-WERKS <> G_HBMO_CD.
* ↑
PERFORM FRM_WERKERROR.                      "ﾌﾟﾗﾝﾄｴﾗｰのP_WERKSの抽出
* ↓ append 2002/03/31 psd m.arai
GF_LIST-EBELNER = CNS_ASTER23.
* ↑
ENDIF.

IF G_EKPO-EBELN <> G_EBELN.
GF_LIST-EBELNER = CNS_ASTER23.                          "発注番号ｴﾗ-
ENDIF.

IF G_EKPO-EBELP <> G_EBELP.
GF_LIST-EBELNER = CNS_ASTER23.                          "明細番号ｴﾗ-
ENDIF.

* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-MATNR <> GF_REPLY-MATNR.
IF G_EKPO-MATNR <> GF_REPLY-MATNR.
* ↑
GF_LIST-MATNRER = CNS_ASTER18.                          "品目ｺｰﾄﾞｴﾗｰ
ENDIF.

* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-MEINS <> GF_REPLY-MEINS.
* ↓ MODIFY 2002.03.01 PSD M.Arai 数量単位変換対応
*  IF G_EKPO-MEINS <> GF_REPLY-VRKME.
*    数量単位変換

***2002.03.28 DEL >>>
*  PERFORM FRM_MEINS_EXCHANGE USING   GF_REPLY-VRKME
*                             CHANGING L_MEINS.
***2002.03.28 DEL <<<
IF G_EKPO-MEINS <> L_MEINS.
* ↑ MODIFY 2002.03.01 PSD M.ARAI 数量単位変換対応
* ↑ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
GF_LIST-MEINSER = CNS_ASTER3.                               "単位ｴﾗ-
ENDIF.

ENDFORM.                    " FRM_NAME2_1_CHECK


************************************************************************
*      Form  FRM_EKPO_NAME2_2_CHECK
************************************************************************
*      購買伝票：明細データチェック ( NAME2 = 2 の時 )
************************************************************************
FORM FRM_EKPO_NAME2_2_CHECK.
DATA: L_MEINS TYPE EKPO-MEINS.
***2002.03.28 ADD>>>
*  PERFORM FRM_MEINS_EXCHANGE USING   GF_REPLY-VRKME
*                             CHANGING L_MEINS.
***2002.03.28 ADD <<<
***正常時テキスト更新(発注番号･明細･プラント･品目コード･仕入先品目コード
**･数量単位)
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-WERKS = G_WERKS AND G_EKPO-EBELN = G_EBELN AND
IF G_EKPO-WERKS = G_HBMO_CD AND G_EKPO-EBELN = G_EBELN AND
*     G_EKPO-EBELP = G_EBELP AND G_EKPO-MATNR = GF_REPLY-MATNR AND
*     G_EKPO-MEINS = GF_REPLY-MEINS AND G_EKPO-IDNLF = GF_REPLY-IDNLF.
G_EKPO-EBELP = G_EBELP AND
*    G_EKPO-MATNR = GF_REPLY-MATNR AND
*     G_EKPO-MEINS = L_MEINS AND
G_EKPO-IDNLF = GF_REPLY-KDMAT.
* ↑
PERFORM FRM_CREATE1_TEXT.

ENDIF.

***モニタリストエラー項目(発注番号･明細･プラント･品目コード･仕入先品目コ
**ード･数量単位)
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-WERKS <> G_WERKS.
IF G_EKPO-WERKS <> G_HBMO_CD.
* ↑
PERFORM FRM_WERKERROR.                    "ﾌﾟﾗﾝﾄｴﾗｰの時P_WERKSの抽出
* ↓ append 2002/03/31 psd m.arai
GF_LIST-EBELNER = CNS_ASTER23.
* ↑
ENDIF.

IF G_EKPO-EBELN <> G_EBELN.
GF_LIST-EBELNER = CNS_ASTER23.                          "発注番号ｴﾗｰ
ENDIF.

IF G_EKPO-EBELP <> G_EBELP.
GF_LIST-EBELNER = CNS_ASTER23.                          "明細番号ｴﾗｰ
ENDIF.

* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-MATNR <> GF_REPLY-MATNR.
IF G_EKPO-MATNR <> GF_REPLY-MATNR.
* ↑
GF_LIST-MATNRER = CNS_ASTER18.                          "品目ｺｰﾄﾞｴﾗｰ
ENDIF.

* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-MEINS <> GF_REPLY-MEINS.
* ↓ MODIFY 2002.03.01 PSD M.Arai 数量単位変換対応
*  IF G_EKPO-MEINS <> GF_REPLY-VRKME.
***2002.03.28 DEL >>>
*  PERFORM FRM_MEINS_EXCHANGE USING   GF_REPLY-VRKME
*                             CHANGING L_MEINS.
***2002.03.28 DEL <<<
IF G_EKPO-MEINS <> L_MEINS.
* ↑ MODIFY 2002.03.01 PSD M.Arai 数量単位変換対応
* ↑ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応

GF_LIST-MEINSER = CNS_ASTER3.                               "単位ｴﾗｰ
ENDIF.

* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  IF G_EKPO-IDNLF <> GF_REPLY-IDNLF.
IF G_EKPO-IDNLF <> GF_REPLY-KDMAT.
* ↑
GF_LIST-IDNLFER = CNS_ASTER25.                   "仕入先品目ｺｰﾄﾞｴﾗｰ
ENDIF.


ENDFORM.                    " FRM_EKPO_NAME2_2_CHECK

************************************************************************
*      Form  FRM_EKPO_NAME2_3_CHECK
************************************************************************
*      購買伝票：明細データチェック EKPO 取得×の時
************************************************************************
FORM FRM_EKPO_SY_SUBRC_4.

GF_LIST-EBELNER = CNS_ASTER23.                          "発注番号ｴﾗｰ
GF_LIST-EBELNER = CNS_ASTER23.                          "明細番号ｴﾗｰ
GF_LIST-MATNRER = CNS_ASTER18.                          "品目ｺｰﾄﾞｴﾗｰ
GF_LIST-MEINSER = CNS_ASTER3.                               "単位ｴﾗｰ
GF_LIST-IDNLFER = CNS_ASTER25.                    "仕入先品目ｺｰﾄﾞｴﾗｰ

ENDFORM.                    " FRM_EKPO_SY_SUBRC_4

************************************************************************
*      Form  FRM_CREATE1_TEXT
************************************************************************
*      EDI納期回答更新処理 ( 汎用モジュール ) (NAME2 = 1.2,3)
************************************************************************
FORM FRM_CREATE1_TEXT.

***EDI納期回答更新処理***

***ローカルＤＡＴＡ
DATA: L_EBEELNEBELP1   LIKE  THEAD-TDNAME,
LT_TLINE         LIKE  TABLE  OF  TLINE WITH HEADER LINE..

***項目設定
CONCATENATE G_EBELN G_EBELP INTO L_EBEELNEBELP1.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*  LT_TLINE-TDLINE = GF_REPLY-ANSWER.
* ↓ append 2002/03/09 psd m.arai 回答納期書式変更
CONCATENATE
GF_REPLY-BSTDK+0(2)
GF_REPLY-BSTDK+2(2)
GF_REPLY-BSTDK+4(2)
INTO LT_TLINE-TDLINE
SEPARATED BY '/'
.
*  LT_TLINE-TDLINE = GF_REPLY-BSTDK.
* ↑
* ↓ MODIFY 2002/03/22 テキスト更新内容設定不具合
*  APPEND GF_REPLY TO LT_TLINE.
APPEND LT_TLINE.
* ↑
***汎用モジュール（CREATE_TEXT）
CALL FUNCTION 'CREATE_TEXT'
EXPORTING
FID               = 'F04'
FLANGUAGE         = 'J'
FNAME             = L_EBEELNEBELP1
FOBJECT           = 'EKPO'
*     SAVE_DIRECT       = 'X'
*     FFORMAT           = '*'
TABLES
FLINES            = LT_TLINE
EXCEPTIONS
NO_INIT           = 1
NO_SAVE           = 2
OTHERS            = 3.

IF SY-SUBRC <> 0.
MESSAGE S001(Z1) WITH CNS_CREATE SY-SUBRC.
ENDIF.

ENDFORM.                    " FRM_CREATE1_TEXT

************************************************************************
*      Form  FRM_CLEAR1.
************************************************************************
*      ファイル読込項目クリア
************************************************************************
FORM FRM_CLEAR1.

* ↓ MODIFY 2002.02.25 ファイルタイプ変更対応
*   REFRESH   GT_CHANGE.
*   CLEAR     GF_CHANGE.
CLEAR     GF_REPLY.
* ↑
CLEAR     G_DATA.
CLEAR     G_FLAG3.
CLEAR     G_LEN.

ENDFORM.                    " FRM_CLEAR1

************************************************************************
*      Form  FRM_REPORT_LFA1_SELECT
************************************************************************
*      レポート出力処理 仕入先抽出処理
************************************************************************
FORM FRM_REPORT_LFA1_SELECT.

***仕入先抽出処理
SELECT SINGLE NAME1 FROM LFA1
INTO G_NAME1
* ↓MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*                      WHERE LIFNR = GF_REPLY-LIFNR.
WHERE LIFNR = GF_REPLY-UM_CD.
* ↑

CASE SY-SUBRC.
WHEN 0.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*       GF_LIST-LIFNR = GF_REPLY-LIFNR.
GF_LIST-LIFNR = GF_REPLY-UM_CD.
* ↑
GF_LIST-LIFNRNM = G_NAME1.
WHEN 4.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*       GF_LIST-LIFNR = GF_REPLY-LIFNR.
GF_LIST-LIFNR = GF_REPLY-UM_CD.
* ↑
GF_LIST-LIFNRNM = G_NAME1.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_LFA1 CNS_SURASH SY-SUBRC.
ENDCASE.


ENDFORM.                    " FRM_REPORT_LFA1_SELECT

************************************************************************
*      Form  FRM_REPORT_T001W_SELECT
************************************************************************
*      レポート出力処理 プラント抽出(プラント正常時)
************************************************************************
FORM FRM_REPORT_T001W_SELECT.
***プラント抽出処理
SELECT SINGLE * FROM T001W
INTO GF_T001W1
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*                    WHERE WERKS = G_WERKS.
WHERE WERKS = G_HBMO_CD.
* ↑

CASE SY-SUBRC.
WHEN 0.
* ↓ MODIFY 2002.02.25 PSD M.ARAI ファイルタイプ変更対応
*        GF_LIST-WERKS = G_WERKS.
GF_LIST-WERKS = G_HBMO_CD.
* ↑
GF_LIST-WERKSNM = GF_T001W1-NAME1.
WHEN 4.
* ↓ MODIFY 2002.02.25 PSD M.ARAI ファイルタイプ変更対応
*        GF_LIST-WERKS = G_WERKS.
GF_LIST-WERKS = G_HBMO_CD.
GF_LIST-WERKSNM = GF_T001W1-NAME1.
* ↑
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_T001W CNS_SURASH SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_REPORT_T001W_SELECT

************************************************************************
*      Form  FRM_REPORT_T024_SELECT
************************************************************************
*      レポート出力処理   購買グループ抽出処理
************************************************************************
FORM FRM_REPORT_T024_SELECT.

***購買グループ抽出処理
SELECT SINGLE EKNAM FROM T024
INTO G_EKNAM
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*                      WHERE EKGRP = GF_REPLY-EKGRP.
WHERE EKGRP = GF_REPLY-MM_POSITION.
* ↑
CASE SY-SUBRC.
WHEN 0.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*        GF_LIST-EKGRP = GF_REPLY-EKGRP.
GF_LIST-EKGRP = GF_REPLY-MM_POSITION.
* ↑
GF_LIST-EKGRPNM = G_EKNAM.
WHEN 4.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
*        GF_LIST-EKGRP = GF_REPLY-EKGRP.
GF_LIST-EKGRP = GF_REPLY-MM_POSITION.
* ↑
GF_LIST-EKGRPNM = G_EKNAM.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_T024 CNS_SURASH SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_REPORT_T024_SELECT

************************************************************************
*      Form  FRM_REPORT_MAKT_SELECT
************************************************************************
*      レポート出力処理 品目テキスト抽出処理とその他リスト構造に代入
************************************************************************
FORM FRM_REPORT_MAKT_SELECT.
DATA L_NUM(12) TYPE N.

***品目テキスト抽出処理
SELECT SINGLE MAKTX FROM MAKT
INTO G_MATKX
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
WHERE MATNR = GF_REPLY-MATNR
*                    WHERE MATNR = GF_REPLY-KDMAT
* ↑
AND   SPRAS = SY-LANGU.

CASE SY-SUBRC.
WHEN 0.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
GF_LIST-MATNR = GF_REPLY-MATNR.
*      GF_LIST-MATNR = GF_REPLY-KDMAT.
* ↑
GF_LIST-MATNRNM = G_MATKX.
WHEN 4.
* ↓ MODIFY 2002.02.25 PSD M.Arai ファイルタイプ変更対応
GF_LIST-MATNR = GF_REPLY-MATNR.
*      GF_LIST-MATNR = GF_REPLY-KDMAT.
* ↑
GF_LIST-MATNRNM = G_MATKX.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_MAKT CNS_SURASH SY-SUBRC.
ENDCASE.

***その他リスト構造に代入
* ↓ MODIFY 2002.02.25 PSD M.ARAI ファイルタイプ変更対応
*    GF_LIST-EBELN = GF_REPLY-EBELN.
*    GF_LIST-IDNLF = GF_REPLY-IDNLF.
*    GF_LIST-MENGE3+8(3) = GF_REPLY-MENGE1+8(3).
*    GF_LIST-REPLY = GF_REPLY-ANSWER.
*    GF_LIST-MEINS = GF_REPLY-MEINS.
*    GF_LIST-MENGE = GF_REPLY-MENGE.
*    GF_LIST-EINDT = GF_REPLY-EINDT.
GF_LIST-EBELN = GF_REPLY-BSTNK.
GF_LIST-IDNLF = GF_REPLY-KDMAT.
*  GF_LIST-IDNLF = GF_REPLY-MATNR.

* 回答数量
L_NUM = GF_REPLY-KWMENG+0(9).   " 2002/03/30 add
GF_LIST-MENGE3 = L_NUM.        " 2002/03/30 add
L_NUM = GF_REPLY-KWMENG+9(3).
*  GF_LIST-MENGE3 = L_NUM.
GF_LIST-MENGE3 = GF_LIST-MENGE3 + ( L_NUM / 1000 ). " 2002/03/30 add

*   modify 2011/12/8 C.MARUTA DMW3647{
*  GF_LIST-REPLY+0(2) = '20'.
*  GF_LIST-REPLY+2(6) = GF_REPLY-BSTDK.
CONCATENATE GF_REPLY-BSTDK+0(2)
GF_REPLY-BSTDK+2(2)
GF_REPLY-BSTDK+4(2)
INTO GF_LIST-REPLY
SEPARATED BY CNS_SURASH.

* } modify 2011/12/8 C.MARUTA DMW3647

GF_LIST-MEINS = GF_REPLY-VRKME.


* 注文数量
* ↓ modify 2002/03/29 psd m.arai 注文数量不具合対応
**  L_NUM = GF_REPLY-ORDER_NUM+0(9).
**  GF_LIST-MENGE = L_NUM.
*  L_NUM = GF_REPLY-ORDER_NUM+9(3).
**  GF_LIST-MENGE = GF_LIST-MENGE + ( L_NUM / 1000 ).
*  gf_list-menge = l_num.
GF_LIST-MENGE = G_EKPO-MENGE.
* ↑

GF_LIST-EINDT+0(2) = '20'.
GF_LIST-EINDT+2(6) = GF_REPLY-NOUKI.
* ↑

ENDFORM.                    " FRM_REPORT_MAKT_SELECT

************************************************************************
*      Form  FRM_WERKERROR
************************************************************************
*     レポート出力処理 プラント抽出(プラントエラー時)
************************************************************************
FORM FRM_WERKERROR.

****エラーの時P_WERKSでレポート出力
SELECT SINGLE *     FROM T001W
INTO  GF_T001W2
WHERE WERKS = P_WERKS.

G_FLAG9 = CNS_1.

CASE SY-SUBRC.
WHEN 0.
GF_LIST-WERKS = P_WERKS.
GF_LIST-WERKSNM = GF_T001W2-NAME1.
WHEN 4.
MESSAGE S021(Z1) WITH P_WERKS.
G_FLAG6 = CNS_1.
EXIT.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_T001W CNS_SURASH SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_WERKERROR

************************************************************************
*      Form  FRM_CLEAR2.
************************************************************************
*      モニタリスト抽出項目クリア
************************************************************************
FORM FRM_CLEAR2.

CLEAR  G_FLAG1.
CLEAR  GF_LIST.
CLEAR  GF_REPLY.
CLEAR  G_HBMO_CD.
CLEAR  G_EBELN.
CLEAR  G_EBELP.
CLEAR  GF_WYT3.
CLEAR  G_NAME2.
CLEAR  GF_T001W1.
CLEAR  GF_T001W2.
CLEAR  G_NAME1.
CLEAR  G_MATKX.
CLEAR  G_EKNAM.
CLEAR  G_FLAG2.
CLEAR  G_FLAG6.
CLEAR  G_EKPO.
CLEAR  G_FLAG9.

ENDFORM.                    " FRM_CLEAR2

************************************************************************
*      Form  FRM_GET_PRINT_PARAMETERS
************************************************************************
*      プリンタアドレス取得
***********************************************************************
FORM FRM_ADR10.

***ローカルＤＡＴＡ
DATA: L_ADRNR      TYPE   T001W-ADRNR.

SELECT SINGLE  ADRNR FROM T001W
INTO  L_ADRNR
WHERE WERKS = GF_LIST-WERKS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S021(Z1) WITH GF_LIST-WERKS.
G_FLAG7 = CNS_1.
EXIT.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_T001W CNS_SURASH SY-SUBRC.
ENDCASE.

***出力プリンタの取得
SELECT SINGLE PRINT_DEST FROM ADR10
INTO G_PRINT_DEST
WHERE ADDRNUMBER = L_ADRNR
* Add 2010/03/09 --->
and  FLGDEFAULT = CNS_X
* Add 2010/03/09 <---

.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S812(Z1).
G_FLAG7 = CNS_1.
WHEN OTHERS.
MESSAGE A603(Z1) WITH CNS_ADR10 CNS_SURASH SY-SUBRC.
ENDCASE.

ENDFORM.                                                    " FRM_ADR10


************************************************************************
*      Form  FRM_NEW_PAGE_PRINT_ON
************************************************************************
*     モニタリストスプール処理(プラント毎にページ出力)
************************************************************************
FORM FRM_NEW_PAGE_PRINT_ON.

***ＳＰＯＯＬ表題
CONCATENATE TEXT-019 CNS_KAKOAKI GF_LIST-WERKSNM CNS_KAKOTOJI
INTO G_LISTTEXT.

***プラント毎にＳＰＯＯＬ
IF G_WERKSFLAG <> GF_LIST-WERKS.
CLEAR G_LIFNRFLAG.
NEW-PAGE PRINT ON
DESTINATION G_PRINT_DEST
COVER TEXT G_LISTTEXT
IMMEDIATELY  CNS_X
KEEP IN SPOOL CNS_X
LINE-COUNT CNS_58
LINE-SIZE  CNS_170
LAYOUT CNS_X_PAPER
RECEIVER SY-UNAME
NEW-SECTION
NO DIALOG.


IF G_VALID IS INITIAL.
EXIT.
ENDIF.

IF NOT G_PRINT_DEST IS INITIAL.
EXIT.
ENDIF.
ENDIF.

ENDFORM.                    " FRM_NEW_PAGE_PRINT_ON

************************************************************************
*      Form  FRM_GET_PRINT_PARAMETERS
************************************************************************
*      レポート出力（WRITE）モニタリスト
************************************************************************
FORM FRM_WEITE_MONITER_LIST.

***レポート出力
IF G_LIFNRFLAG <> GF_LIST-LIFNR.
WRITE:/2 TEXT-017,
11 GF_LIST-LIFNR,
27 GF_LIST-LIFNRNM.
ENDIF.

WRITE:/2  GF_LIST-EBELN,
27 GF_LIST-MATNR,
47 GF_LIST-MATNRNM,
79 GF_LIST-IDNLF,
104(17) GF_LIST-MENGE3,
123 GF_LIST-MEINS,
129 GF_LIST-REPLY DD/MM/YY.
WRITE:/104(17) GF_LIST-MENGE,
129 GF_LIST-EINDT DD/MM/YY.

WRITE:/2  GF_LIST-EBELNER,
27 GF_LIST-MATNRER,
79 GF_LIST-IDNLFER,
104 GF_LIST-MENGEER,
123 GF_LIST-MEINSER.

ENDFORM.                    " FRM_WEITE_MONITER_LIST

************************************************************************
*      Form  FRM_CLEAR3
************************************************************************
*      プリンタ出力処理項目クリア
************************************************************************
FORM FRM_CLEAR3.

CLEAR G_PRINT_DEST.
CLEAR G_PARAMS.
CLEAR G_VALID.
CLEAR G_WERKSFLAG.
CLEAR G_EKGRPFLAG.
CLEAR G_FLAG8.
CLEAR G_LIFNRFLAG.

ENDFORM.                    " FRM_CLEAR3
*&---------------------------------------------------------------------*
*&      Form  FRM_MEINS_EXCHANGE
*&---------------------------------------------------------------------*
*       数量単位変換
*----------------------------------------------------------------------*
FORM FRM_MEINS_EXCHANGE USING    VALUE(P_VRKME)
CHANGING       P_MEINS.

*---MODIFY START PSD T.SAITOH 2002/03/20 ISOコード→R/3基本数量単位---*
*  SELECT SINGLE MSEHI FROM T006A
*    INTO P_MEINS
*    WHERE SPRAS = 'JA'
*    AND   MSEH3 = P_VRKME.
*
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*      P_MEINS = P_VRKME.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH 'T006' SY-SUBRC.
*  ENDCASE.

CALL FUNCTION 'Z_EUNIT_CONVERSION_FROM_ISO'
EXPORTING
ISOCODE       = P_VRKME
IMPORTING
MSEHI         = P_MEINS
*     RESULT        =
EXCEPTIONS
DB_ERR        = 1
BLANK         = 2
OTHERS        = 3
.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.


*---MODIFY END   PSD T.SAITOH 2002/03/20 ---------------------------*

ENDFORM.                    " FRM_MEINS_EXCHANGE
