************************************************************************
* [プログラム名]
*   トランザクション推移一覧表
* [処理概要]
*  　日別のトランザクション量を一覧で表示する
* [作成]
*  2004/09/06   DMC
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2004/10/29   DMC SEIWA         ダウンロード項目にプラント名を追加
*　　　　　　　　　　　　　　　　   プラントの取得方法を追加修正
*  2004/11/8    DMC MASUDA        登録日の処理削除
*  2012/08/14   ISID              ES-UP
*  2016/07/04   ISID21          Add Vendor Customer and Sales Info.
************************************************************************
REPORT ZB070100 NO STANDARD PAGE HEADING
MESSAGE-ID Z1
LINE-SIZE  180
LINE-COUNT 100.

*----------------------------------------------------------------------*
* TYPES定義
*----------------------------------------------------------------------*
*--- 出力ファイル作成用
TYPES:
BEGIN OF TYP_OUT_TAB,
* Mod ES-UP 2012/10/29 -->
*    RECORD(2000) TYPE C,   "出力用データ結合後の文字列
RECORD TYPE string,   "出力用データ結合後の文字列
* Mod ES-UP 2012/10/29 <--
END   OF TYP_OUT_TAB.

*--- 出力用変換前データ格納用
TYPES:
BEGIN OF TYP_EDIT_TAB,
DTYPE(10) TYPE C,      "データ種
AUART(10) TYPE C,      "伝票タイプ
DTEXT(60) TYPE C,      "テキスト(伝票タイプ)
ITYPE(10) TYPE C,      "移動タイプ
ITEXT(60) TYPE C,      "テキスト(移動タイプ)
WERKS(10) TYPE C,      "プラント
* ADD 2004/10/29 ---->
NAME1(30) TYPE C,      "プラント名
* ADD 2004/10/29 <----
* ADD Start 2016/7/5  ISID21 ---->
LIFNR(10) TYPE C,         "仕入先
LIFNAME(35) TYPE C,     "仕入先名称
KUNNR(10) TYPE C,      "得意先
KUNNAME(35) TYPE C,  "得意先名称
PERNR_VE(8) TYPE C, "営業員名称
VENAME(40) TYPE C,  "営業員名称
PERNR_ZP(8) TYPE C, "営業員アシスタント
ZPNAME(40) TYPE C,  "営業員アシスタント名称
* ADD End 2016/7/5  ISID21 <----
UNAME(10) TYPE C,      "登録ユーザ
NAMET(30) TYPE C,      "登録ユーザ名称
TCODE(20) TYPE C,      "担当者(購買 or 担当グループ)
TNAME(20) TYPE C,      "担当者名称
DATUM(10) TYPE C,      "登録日
FTIME(18) TYPE C,      "最初データ投入時間
LTIME(18) TYPE C,      "最終データ投入時間
STIME(08) TYPE C,      "処理時間
COUNT(14) TYPE C,      "対象データ件数
END   OF TYP_EDIT_TAB.

*--- 会計伝票データ取得用
TYPES:
BEGIN OF TYP_KAIKEI,
BLART LIKE BKPF-BLART, "会計伝票タイプ
CPUDT LIKE BKPF-CPUDT, "登録日
WERKS LIKE BSEG-WERKS, "プラント
USNAM LIKE BKPF-USNAM, "ユーザー名
COUNT TYPE P,          "対象データ件数
MINTM LIKE BKPF-CPUTM, "登録開始時刻
MAXTM LIKE BKPF-CPUTM, "登録終了時刻
*ADD 2004/10/29 ----->
PRCTR LIKE BSEG-PRCTR, "利益センタ
KOSTL LIKE BSEG-KOSTL, "原価センタ
*ADD 2004/10/29 <-----
END   OF TYP_KAIKEI.

*    会計伝票ヘッダデータ取得用
TYPES:
BEGIN OF TYP_BKPF,
CPUDT LIKE BKPF-CPUDT, "登録日
BLART LIKE BKPF-BLART, "伝票タイプ
WERKS LIKE BSEG-WERKS, "プラント　←　2004/10/29　ADD
USNAM LIKE BKPF-USNAM, "ユーザー名
CPUTM LIKE BKPF-CPUTM, "登録時刻
BUKRS LIKE BKPF-BUKRS, "会社コード
BELNR LIKE BKPF-BELNR, "会計伝票番号
GJAHR LIKE BKPF-GJAHR, "会計年度
KOSTL LIKE BSEG-KOSTL,"原価センタ ←　2004/10/29 ADD
PRCTR LIKE BSEG-PRCTR,"利益センタ ←　2004/10/29 ADD
END   OF TYP_BKPF.

*    会計伝票明細データ取得用
TYPES:
BEGIN OF TYP_BSEG,
BUKRS LIKE BKPF-BUKRS, "会社コード
BELNR LIKE BSEG-BELNR, "会計伝票番号
GJAHR LIKE BSEG-GJAHR, "会計年度
WERKS LIKE BSEG-WERKS, "プラント
KOSTL LIKE BSEG-KOSTL,"原価センタ ←　2004/10/29 ADD
PRCTR LIKE BSEG-PRCTR,"利益センタ ←　2004/10/29 ADD
END   OF TYP_BSEG.

*--- 入出庫伝票データ取得用
TYPES:
BEGIN OF TYP_NYUSYU,
BLART LIKE MKPF-BLART,  "伝票タイプ
BWART LIKE MSEG-BWART,  "移動タイプ
CPUDT LIKE MKPF-CPUDT,  "登録日
WERKS LIKE MSEG-WERKS,  "プラント
USNAM LIKE MKPF-USNAM,  "ユーザ名
KUNNR LIKE MSEG-KUNNR,   "得意先
LIFNR  LIKE MSEG-LIFNR,      "仕入先
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
KDAUF LIKE MSEG-KDAUF,    "受注伝票番号
VBELN_IM LIKE MSEG-VBELN_IM,   "出荷伝票
COUNT TYPE P,           "対象データ件数
MINTM LIKE MKPF-CPUTM,  "登録開始時刻
MAXTM LIKE MKPF-CPUTM,  "登録終了時刻
END   OF TYP_NYUSYU.

TYPES:
BEGIN OF TYP_KDAUF,
KDAUF LIKE MSEG-KDAUF,    "受注伝票番号
VBELN_IM LIKE MSEG-VBELN_IM,    "出荷伝票
END   OF TYP_KDAUF.

TYPES:
BEGIN OF TYP_VBELN_IM,
VBELN_IM LIKE MSEG-VBELN_IM,    "出荷伝票
END   OF TYP_VBELN_IM.

TYPES:
BEGIN OF TYP_VBAK_KUNNR,
VBELN LIKE VBAK-VBELN,    "受注伝票番号
KUNNR LIKE VBAK-KUNNR,    "得意先
END   OF TYP_VBAK_KUNNR.


*--- 請求書照合データ取得用
TYPES:
BEGIN OF TYP_SEISYO,
BLART LIKE RBKP-BLART, "伝票タイプ
USNAM LIKE RBKP-USNAM, "ユーザ名
CPUDT LIKE RBKP-CPUDT, "会計伝票登録日
WERKS LIKE RSEG-WERKS, "プラント
COUNT TYPE P,          "対象データ件数
MINTM LIKE RBKP-CPUTM, "登録開始時刻
MAXTM LIKE RBKP-CPUTM, "登録終了時刻
END   OF TYP_SEISYO.

*    請求書照合ヘッダデータ取得用
TYPES:
BEGIN OF TYP_RBKP,
BLART LIKE RBKP-BLART, "伝票タイプ
USNAM LIKE RBKP-USNAM, "ユーザ名
CPUDT LIKE RBKP-CPUDT, "会計伝票登録日
CPUTM LIKE RBKP-CPUTM, "登録開始時刻
BELNR LIKE RBKP-BELNR,
GJAHR LIKE RBKP-GJAHR,
END   OF TYP_RBKP.

*    請求書照合明細データ取得用
TYPES:
BEGIN OF TYP_RSEG,
BELNR LIKE RSEG-BELNR,
GJAHR LIKE RSEG-BELNR,
WERKS LIKE RSEG-WERKS, "プラント
END   OF TYP_RSEG.

*--- 購買伝票データ取得用
TYPES:
BEGIN OF TYP_KOUBAI,
BSART LIKE EKKO-BSART, "伝票タイプ
LIFNR   LIKE EKKO-LIFNR,  "仕入先
KUNNR LIKE VBAK-KUNNR, "得意先コード
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
AEDAT LIKE EKKO-AEDAT, "伝票登録日
WERKS LIKE EKPO-WERKS, "プラント
EKGRP LIKE EKKO-EKGRP, "購買グループ
ERNAM LIKE EKKO-ERNAM, "ユーザ名
COUNT TYPE P,          "対象データ件数
END   OF TYP_KOUBAI.

*    購買伝票ヘッダデータ取得用
TYPES:
BEGIN OF TYP_EKKO,
BSART LIKE EKKO-BSART, "伝票タイプ
LIFNR   LIKE EKKO-LIFNR,  "仕入先
KUNNR LIKE VBAK-KUNNR, "得意先コード
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
AEDAT LIKE EKKO-AEDAT, "伝票登録日
ERNAM LIKE EKKO-ERNAM, "ユーザ名
EKGRP LIKE EKKO-EKGRP, "購買グループ
EBELN LIKE EKKO-EBELN,
END   OF TYP_EKKO.

*    購買伝票明細データ取得用
TYPES:
BEGIN OF TYP_EKPO,
EBELN LIKE EKPO-EBELN,
WERKS LIKE EKPO-WERKS, "プラント
END   OF TYP_EKPO.

*--- 購買依頼データ取得用
TYPES:
BEGIN OF TYP_KOIRAI,
BSART LIKE EBAN-BSART, "購買依頼伝票タイプ
ERNAM LIKE EBAN-ERNAM, "登録者名
EKGRP LIKE EBAN-EKGRP, "購買グループ
WERKS LIKE EBAN-WERKS, "プラント
ERDAT LIKE EBAN-ERDAT, "変更日
COUNT TYPE P,          "対象データ件数
END   OF TYP_KOIRAI.

*--- 出荷伝票データ取得用
TYPES:
BEGIN OF TYP_SYUKKA,
ERNAM LIKE LIKP-ERNAM, "オブジェクト登録者名
ERDAT LIKE LIKP-ERDAT, "レコード登録日
LFART LIKE LIKP-LFART, "出荷伝票タイプ
KUNAG LIKE LIKP-KUNAG,  "受注先
WERKS LIKE LIPS-WERKS, "プラント
VKGRP LIKE LIPS-VKGRP, "営業グループ
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
COUNT TYPE P,          "対象データ件数
MINTM LIKE LIKP-ERZET, "登録開始時刻
MAXTM LIKE LIKP-ERZET, "登録終了時刻
END   OF TYP_SYUKKA.

*    出荷伝票ヘッダデータ取得用
TYPES:
BEGIN OF TYP_LIKP,
ERNAM LIKE LIKP-ERNAM, "オブジェクト登録者名
ERDAT LIKE LIKP-ERDAT, "レコード登録日
LFART LIKE LIKP-LFART, "出荷伝票タイプ
KUNAG LIKE LIKP-KUNAG,  "受注先
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
ERZET LIKE LIKP-ERZET, "登録開始時刻
VBELN LIKE LIKP-VBELN,  "出荷伝票
END   OF TYP_LIKP.

*    出荷伝票明細データ取得用
TYPES:
BEGIN OF TYP_LIPS,
VBELN LIKE LIPS-VBELN,
WERKS LIKE LIPS-WERKS, "プラント
VKGRP LIKE LIPS-VKGRP, "営業グループ
VGBEL LIKE LIPS-VGBEL,  "受注伝票
END   OF TYP_LIPS.

*--- 請求伝票データ取得用
TYPES:
BEGIN OF TYP_SEIKYU,
FKART LIKE VBRK-FKART, "請求タイプ
ERNAM LIKE VBRK-ERNAM, "オブジェクト登録者名
VKGRP LIKE VBRP-VKGRP, "営業グループ
ERDAT LIKE VBRK-ERDAT, "レコード登録日
WERKS LIKE VBRP-WERKS, "プラント
COUNT TYPE P,          "対象データ件数
MINTM LIKE VBRK-ERZET, "登録開始時刻
MAXTM LIKE VBRK-ERZET, "登録終了時刻
END   OF TYP_SEIKYU.

*    請求伝票ヘッダデータ取得用
TYPES:
BEGIN OF TYP_VBRK,
FKART LIKE VBRK-FKART, "請求タイプ
ERNAM LIKE VBRK-ERNAM, "オブジェクト登録者名
ERDAT LIKE VBRK-ERDAT, "レコード登録日
ERZET LIKE VBRK-ERZET, "登録開始時刻
VBELN LIKE VBRK-VBELN,
END   OF TYP_VBRK.

*    請求伝票明細データ取得用
TYPES:
BEGIN OF TYP_VBRP,
VBELN LIKE VBRK-VBELN,
WERKS LIKE VBRP-WERKS, "プラント
VKGRP LIKE VBRP-VKGRP, "営業グループ
END   OF TYP_VBRP.

*--- 販売伝票データ取得用
TYPES:
BEGIN OF TYP_HANBAI,
ERDAT LIKE VBAK-ERDAT, "レコード登録日
ERNAM LIKE VBAK-ERNAM, "オブジェクト登録者名
VKGRP LIKE VBAK-VKGRP, "営業グループ
KUNNR LIKE VBAK-KUNNR, "得意先コード
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
AUART LIKE VBAK-AUART, "販売伝票タイプ
WERKS LIKE VBAP-WERKS, "プラント
COUNT TYPE P,          "対象データ件数
MINTM LIKE VBAK-ERZET, "登録開始時刻
MAXTM LIKE VBAK-ERZET, "登録終了時刻
END   OF TYP_HANBAI.

*    販売伝票ヘッダデータ取得用
TYPES:
BEGIN OF TYP_VBAK,
ERDAT LIKE VBAK-ERDAT, "レコード登録日
ERNAM LIKE VBAK-ERNAM, "オブジェクト登録者名
VKGRP LIKE VBAK-VKGRP, "営業グループ
KUNNR LIKE VBAK-KUNNR, "得意先コード
PERNR_VE LIKE VBPA-PERNR,  "営業員
PERNR_ZP LIKE VBPA-PERNR,   "営業員アシスタント
AUART LIKE VBAK-AUART, "販売伝票タイプ
ERZET LIKE VBAK-ERZET, "登録開始時刻
VBELN LIKE VBAK-VBELN,
END   OF TYP_VBAK.

*  販売伝票営業員
TYPES:
BEGIN OF TYP_PERNR,
VBELN TYPE     VBPA-VBELN,   "販売管理伝票番号
PARVW TYPE    VBPA-PARVW,   "取引先機能
PERNR TYPE     VBPA-PERNR,  "営業員
END OF TYP_PERNR.

*  販売伝票取引情報From購買伝票
TYPES:
BEGIN OF TYP_EKKN_VBPA,
EBELN  TYPE    EKKO-EBELN,    "購買伝票
VBELN TYPE     VBPA-VBELN,   "販売管理伝票番号
PARVW TYPE    VBPA-PARVW,   "取引先機能
KUNNR TYPE    VBPA-KUNNR,    "得意先
PERNR TYPE     VBPA-PERNR,  "営業員
END OF TYP_EKKN_VBPA.

*    販売伝票明細データ取得用
TYPES:
BEGIN OF TYP_VBAP,
VBELN LIKE VBAK-VBELN,
WERKS LIKE VBAP-WERKS, "プラント
END   OF TYP_VBAP.


*--- 伝票タイプテキスト取得用(会計、入出庫、請求書照合で使用)
TYPES:
BEGIN OF TYP_T003T,
BLART LIKE T003T-BLART, "伝票タイプ
LTEXT LIKE T003T-LTEXT, "伝票タイプテキスト
END   OF TYP_T003T.

*--- 取引タイプのテキスト(長)取得用
TYPES:
BEGIN OF TYP_T156T,
BWART LIKE T156T-BWART, "取引タイプ
BTEXT LIKE T156T-BTEXT, "取引タイプテキスト
END   OF TYP_T156T.

*--- 販売伝票タイプ:テキスト取得用
TYPES:
BEGIN OF TYP_TVAKT,
AUART LIKE TVAKT-AUART, "伝票タイプ
BEZEI LIKE TVAKT-BEZEI, "伝票タイプテキスト
END   OF TYP_TVAKT.

*--- 出荷伝票:タイプ:テキスト取得用
TYPES:
BEGIN OF TYP_TVLKT,
LFART LIKE TVLKT-LFART, "伝票タイプ
VTEXT LIKE TVLKT-VTEXT, "伝票タイプテキスト
END   OF TYP_TVLKT.

*--- 請求伝票:伝票タイプ:テキスト取得用
TYPES:
BEGIN OF TYP_TVFKT,
FKART LIKE TVFKT-FKART, "伝票タイプ
VTEXT LIKE TVFKT-VTEXT, "伝票タイプテキスト
END   OF TYP_TVFKT.

*--- 購買伝票タイプに対するテキスト取得用(購買、購買依頼で使用)
TYPES:
BEGIN OF TYP_T161T,
BSART LIKE T161T-BSART, "伝票タイプ
BATXT LIKE T161T-BATXT, "伝票タイプテキスト
END   OF TYP_T161T.

*--- 営業グループ名称取得用
TYPES:
BEGIN OF TYP_TVGRT,
VKGRP LIKE TVGRT-VKGRP, "営業グループ
BEZEI LIKE TVGRT-BEZEI, "内容説明
END   OF TYP_TVGRT.

*--- 購買グループ名称取得用
TYPES:
BEGIN OF TYP_T024,
EKGRP LIKE T024-EKGRP, "購買グループ
EKNAM LIKE T024-EKNAM, "購買グループテキスト
END   OF TYP_T024.


*ADD 2004/10/29 ---->
*--- プラント名称取得用
TYPES:
BEGIN OF TYP_T001W,
WERKS LIKE T001W-WERKS, "プラント
NAME1 LIKE T001W-NAME1, "名称
END   OF TYP_T001W.

*--- 原価センタ名称取得用
TYPES:
BEGIN OF TYP_CSKT,
KOSTL LIKE CSKT-KOSTL, "原価センタ
KTEXT LIKE CSKT-KTEXT, "一般名称
END   OF TYP_CSKT.

*--- 利益センタ名称取得用

TYPES:
BEGIN OF TYP_CEPCT,
PRCTR LIKE CEPCT-PRCTR, "利益センタ
KTEXT LIKE CSKT-KTEXT,  "一般名称
END   OF TYP_CEPCT.

*ADD 2004/10/29 <----

*ADD start by ISDI21 2016/07/18 ---->
TYPES:
BEGIN OF TYP_KUNNR_NAME,
KUNNR LIKE KNA1-KUNNR, "得意先
NAME1 LIKE KNA1-NAME1,  "名称
END   OF TYP_KUNNR_NAME,

BEGIN OF TYP_LIFNR_NAME,
LIFNR  LIKE LFA1-LIFNR, "仕入先
NAME1 LIKE LFA1-NAME1,  "名称
END   OF TYP_LIFNR_NAME,

BEGIN OF TYP_PERNR_NAME,
PERNR  LIKE PA0001-PERNR, "仕入先
ENAME LIKE PA0001-ENAME,  "名称
END   OF TYP_PERNR_NAME.
*ADD end by ISID21 2016/07/18 <----


*----------------------------------------------------------------------*
* 内部テーブル定義
*----------------------------------------------------------------------*
DATA:
* 出力CSVデータ格納用
GT_OUT_TAB  TYPE STANDARD TABLE OF TYP_OUT_TAB,
* 出力データ編集用
GT_EDIT_TAB TYPE STANDARD TABLE OF TYP_EDIT_TAB,

* 会計伝票データ取得用
GT_KAIKEI   TYPE STANDARD TABLE OF TYP_KAIKEI,
* 会計伝票ヘッダデータ取得用
GT_BKPF     TYPE STANDARD TABLE OF TYP_BKPF,
* 会計伝票明細データ取得用
GT_BSEG     TYPE STANDARD TABLE OF TYP_BSEG,

* 入出庫伝票データ取得用
GT_NYUSYU   TYPE STANDARD TABLE OF TYP_NYUSYU,

* 請求書照合データ取得用
GT_SEISYO   TYPE STANDARD TABLE OF TYP_SEISYO,
* 請求書照合ヘッダデータ取得用
GT_RBKP     TYPE STANDARD TABLE OF TYP_RBKP,
* 請求書照合明細データ取得用
GT_RSEG     TYPE STANDARD TABLE OF TYP_RSEG,

* 購買伝票データ取得用
GT_KOUBAI   TYPE STANDARD TABLE OF TYP_KOUBAI,
* 購買伝票ヘッダデータ取得用
GT_EKKO     TYPE STANDARD TABLE OF TYP_EKKO,
* 購買伝票明細データ取得用
GT_EKPO     TYPE STANDARD TABLE OF TYP_EKPO,

* 購買依頼データ取得用
GT_KOIRAI   TYPE STANDARD TABLE OF TYP_KOIRAI,

* 出荷伝票データ取得用
GT_SYUKKA   TYPE STANDARD TABLE OF TYP_SYUKKA,
* 出荷伝票ヘッダデータ取得用
GT_LIKP     TYPE STANDARD TABLE OF TYP_LIKP,
* 出荷伝票明細データ取得用
GT_LIPS     TYPE STANDARD TABLE OF TYP_LIPS,

* 請求伝票データ取得用
GT_SEIKYU   TYPE STANDARD TABLE OF TYP_SEIKYU,
* 請求伝票ヘッダデータ取得用
GT_VBRK     TYPE STANDARD TABLE OF TYP_VBRK,
* 請求伝票データ明細取得用
GT_VBRP     TYPE STANDARD TABLE OF TYP_VBRP,

* 販売伝票データ取得用
GT_HANBAI   TYPE STANDARD TABLE OF TYP_HANBAI,
* 販売伝票ヘッダデータ取得用
GT_VBAK     TYPE STANDARD TABLE OF TYP_VBAK,
* 販売伝票明細データ取得用
GT_VBAP     TYPE STANDARD TABLE OF TYP_VBAP,

* 伝票タイプテキスト取得用
GT_T003T    TYPE STANDARD TABLE OF TYP_T003T,
* 取引タイプのテキスト(長)取得用
GT_T156T    TYPE STANDARD TABLE OF TYP_T156T,
* 販売伝票タイプ:テキスト取得用
GT_TVAKT    TYPE STANDARD TABLE OF TYP_TVAKT,
* 出荷伝票:タイプ:テキスト取得用
GT_TVLKT    TYPE STANDARD TABLE OF TYP_TVLKT,
* 請求伝票:伝票タイプ:テキスト取得用
GT_TVFKT    TYPE STANDARD TABLE OF TYP_TVFKT,
* 購買伝票タイプに対するテキスト取得用
GT_T161T    TYPE STANDARD TABLE OF TYP_T161T,
* 営業グループ名称取得用
GT_TVGRT    TYPE STANDARD TABLE OF TYP_TVGRT,
* 購買グループ名称取得用
GT_T024     TYPE STANDARD TABLE OF TYP_T024,
*ADD 2004/10/29 ---->
* プラント名称取得用
GT_T001W    TYPE STANDARD TABLE OF TYP_T001W,
*  原価センタ名称取得用
GT_CSKT     TYPE STANDARD TABLE OF TYP_CSKT,
*  利益センタ名称取得用
GT_CEPCT     TYPE STANDARD TABLE OF TYP_CEPCT.

*ADD 2004/10/29 <----
*----------------------------------------------------------------------*
* 変数(グローバル)定義
*----------------------------------------------------------------------*
DATA:
GW_OUT_TAB  TYPE TYP_OUT_TAB,    "出力用CSVデータ格納用
GW_EDIT_TAB TYPE TYP_EDIT_TAB,   "出力データ編集用
GW_KAIKEI   TYPE TYP_KAIKEI,     "会計伝票データ取得用
GW_BKPF     TYPE TYP_BKPF,       "会計伝票ヘッダデータ取得用
GW_BSEG     TYPE TYP_BSEG,       "会計伝票明細データ取得用
GW_NYUSYU   TYPE TYP_NYUSYU,     "入出庫伝票データ取得用
GW_SEISYO   TYPE TYP_SEISYO,     "請求書照合データ取得用
GW_RBKP     TYPE TYP_RBKP,       "請求書照合データ取得用
GW_RSEG     TYPE TYP_RSEG,       "請求書照合データ取得用

GW_KOUBAI   TYPE TYP_KOUBAI,     "購買伝票データ取得用
GW_EKKO     TYPE TYP_EKKO,       "購買伝票ヘッダデータ取得用
GW_EKPO     TYPE TYP_EKPO,       "購買伝票明細データ取得用

GW_KOIRAI   TYPE TYP_KOIRAI,     "購買依頼データ取得用

GW_SYUKKA   TYPE TYP_SYUKKA,     "出荷伝票データ取得用
GW_LIKP     TYPE TYP_LIKP,       "出荷伝票ヘッダデータ取得用
GW_LIPS     TYPE TYP_LIPS,       "出荷伝票明細データ取得用

GW_SEIKYU   TYPE TYP_SEIKYU,     "請求伝票データ取得用
GW_VBRK     TYPE TYP_VBRK,       "請求伝票ヘッダデータ取得用
GW_VBRP     TYPE TYP_VBRP,       "請求伝票明細データ取得用

GW_HANBAI   TYPE TYP_HANBAI,     "販売伝票データ取得用
GW_VBAK     TYPE TYP_VBAK,       "販売伝票ヘッダデータ取得用
GW_VBAP     TYPE TYP_VBAP,       "販売伝票明細データ取得用

GW_T003T    TYPE TYP_T003T,      "伝票タイプテキスト取得用
GW_T156T    TYPE TYP_T156T,      "取引タイプのテキスト(長)取得用
GW_TVAKT    TYPE TYP_TVAKT,      "販売伝票タイプ:テキスト取得用
GW_TVLKT    TYPE TYP_TVLKT,      "出荷伝票:タイプ:テキスト取得用
GW_TVFKT    TYPE TYP_TVFKT,      "請求伝票:伝票タイプ:テキスト取得用
GW_T161T    TYPE TYP_T161T,      "購買伝票タイプに対するテキスト取得用
GW_TVGRT    TYPE TYP_TVGRT,      "営業グループ名称取得用
GW_T024     TYPE TYP_T024,       "購買グループ名称取得用
*ADD 2004/10/29 ---->
GW_T001W    TYPE TYP_T001W,      "プラント名称取得用
GW_CSKT     TYPE TYP_CSKT,       "原価センタ名称取得用
GW_CEPCT    TYPE TYP_CEPCT,      "利益センタ名称取得用
*ADD 2004/10/29 <----
GW_WERKS    LIKE T001W-WERKS,    "プラント退避用
GW_COUNT    TYPE I,              "処理件数カウント用
GW_MINTM    TYPE T,              "処理開始時間格納用
GW_MAXTM    TYPE T,              "処理終了時間格納用
GW_LOWDT    TYPE D,              "登録日のデフォルト値設定用
GW_HIGDT    TYPE D,              "登録日のデフォルト値設定用

GW_STIME    TYPE T,              "処理時間計算用

GW_PATH     LIKE RLGRAP-FILENAME,
GW_FILENM   LIKE RLGRAP-FILENAME.
CONSTANTS: CNS_P TYPE C VALUE 'P'. "先頭一文字をPに変換する
*----------------------------------------------------------------------*
* 選択画面定義
*----------------------------------------------------------------------*
SELECTION-SCREEN BEGIN OF BLOCK BL1 WITH FRAME TITLE TEXT-018.

* 会計伝票
SELECTION-SCREEN:BEGIN OF LINE,
COMMENT 5(10) TEXT-001,
POSITION 16.
PARAMETERS:
P_KAIKEI AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-005,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_KAIKEI FOR GW_KAIKEI-BLART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 入出庫伝票
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_NYUSYU AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-006,
COMMENT 35(10) TEXT-014.
SELECT-OPTIONS:
S_NYUSYU FOR GW_NYUSYU-BWART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 請求書照合
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_SEISYO AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-007,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_SEISYO FOR GW_SEISYO-BLART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 購買伝票
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_KOUBAI AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-008,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_KOUBAI FOR GW_KOUBAI-BSART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 購買依頼
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_KOIRAI AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-009,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_KOIRAI FOR GW_KOIRAI-BSART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 出荷伝票
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_SYUKKA AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-010,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_SYUKKA FOR GW_SYUKKA-LFART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 請求伝票
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_SEIKYU AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-011,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_SEIKYU FOR GW_SEIKYU-FKART NO-EXTENSION.
SELECTION-SCREEN END   OF LINE.

* 販売伝票
SELECTION-SCREEN:BEGIN OF LINE,
POSITION 16.
PARAMETERS:
P_HANBAI AS CHECKBOX.
SELECTION-SCREEN:
COMMENT 19(10) TEXT-012,
COMMENT 35(10) TEXT-013.
SELECT-OPTIONS:
S_HANBAI FOR GW_HANBAI-AUART NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* プラント
SELECTION-SCREEN:BEGIN OF LINE,
COMMENT 5(27) TEXT-002.
SELECT-OPTIONS:
S_WERKS FOR GW_WERKS NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* ユーザー
SELECTION-SCREEN:BEGIN OF LINE,
COMMENT 5(27) TEXT-003.
SELECT-OPTIONS:
S_UNAME FOR SY-UNAME NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

* 登録日
SELECTION-SCREEN:BEGIN OF LINE,
COMMENT 5(27) TEXT-004.
SELECT-OPTIONS:
S_DATE FOR SY-DATUM NO-EXTENSION.
SELECTION-SCREEN:END   OF LINE.

SELECTION-SCREEN:SKIP.
SELECTION-SCREEN END OF BLOCK BL1.

* Add 2004/09/21 ---->
SELECTION-SCREEN BEGIN OF BLOCK BL2 WITH FRAME TITLE TEXT-017.
* 出力先選択
SELECTION-SCREEN:BEGIN OF LINE,
COMMENT 5(10) TEXT-015,
POSITION 15.
PARAMETERS:
P_LOCAL RADIOBUTTON GROUP GR1.
SELECTION-SCREEN:POSITION 20.
PARAMETERS:
P_PATH_L  LIKE GW_PATH.
SELECTION-SCREEN:END   OF LINE.
SELECTION-SCREEN:BEGIN OF LINE,
COMMENT 5(10) TEXT-016,
POSITION 15.
PARAMETERS:
P_SERVE  RADIOBUTTON GROUP GR1.
SELECTION-SCREEN:POSITION 20.
PARAMETERS:
P_PATH_S LIKE GW_PATH.
SELECTION-SCREEN:END   OF LINE.

SELECTION-SCREEN END OF BLOCK BL2.
* Add 2004/09/21 <----
*SELECTION-SCREEN PUSHBUTTON /10(2) CHARLY USER-COMMAND ABCD.
*----------------------------------------------------------------------*
INITIALIZATION.
*----------------------------------------------------------------------*
* 登録日のデフォルト設定
GW_LOWDT(6)   = SY-DATUM(6).
GW_LOWDT+6(2) = 01.
GW_HIGDT(4)   = SY-DATUM(4).
GW_HIGDT+4(2) = SY-DATUM+4(2) + 01.
GW_HIGDT+6(2) = 01.
GW_HIGDT      = GW_HIGDT - 1.

S_DATE-LOW  = GW_LOWDT.
S_DATE-HIGH = GW_HIGDT.
APPEND S_DATE.

* 出力先ファイルパス作成

CONCATENATE 'トランザクション推移一覧表('
SY-DATUM
SY-UZEIT
').CSV'
INTO GW_FILENM.

CONCATENATE 'C:\'
GW_FILENM
INTO P_PATH_L.

* 出力先ファイルパス作成
CONCATENATE '\\tecsap01\r3common\work\トランザクション推移一覧表('
SY-DATUM
SY-UZEIT
').CSV'
INTO P_PATH_S.

*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
*----------------------------------------------------------------------*
IF  P_HANBAI IS INITIAL
AND P_KAIKEI IS INITIAL
AND P_KOIRAI IS INITIAL
AND P_KOUBAI IS INITIAL
AND P_NYUSYU IS INITIAL
AND P_SEIKYU IS INITIAL
AND P_SEISYO IS INITIAL
AND P_SYUKKA IS INITIAL.
MESSAGE E400 WITH 'データ種を選択してください'.
ENDIF.

*--- 処理削除 MASUDA 2004/11/8 START ---*
* 登録日の再設定
*  GW_LOWDT(6)   = S_DATE-LOW(6).
*  GW_LOWDT+6(2) = 01.
*  S_DATE-LOW    = GW_LOWDT.
*  GW_HIGDT(4)   = S_DATE-LOW(4).
*  GW_HIGDT+4(2) = S_DATE-LOW+4(2) + 01.
*  GW_HIGDT+6(2) = 01.
*  GW_HIGDT      = GW_HIGDT - 1.
*  S_DATE-HIGH   = GW_HIGDT.
*--- 処理削除 MASUDA 2004/11/8 END   ---*

MODIFY S_DATE INDEX 1.
* Mod 2004/09/21 ---->
IF NOT P_LOCAL IS INITIAL.
MOVE P_PATH_L TO GW_PATH.
ELSE.
MOVE P_PATH_S TO GW_PATH.
ENDIF.
** 出力先ファイルパス作成
*  CONCATENATE '\\tecsap01\r3common\work\トランザクション推移一覧表('
*              SY-DATUM
*              SY-UZEIT
*              ').CSV'
*         INTO GW_PATH.
*
* ファイルの存在チェック
*  OPEN DATASET GW_PATH FOR INPUT.
* すでにファイルが作成されている場合
*  IF SY-SUBRC = 0.
*   MESSAGE E400 WITH '指定のデータはすでにダウンロードされています'.
*  ENDIF.
* Mod 2004/09/21 <----

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_PATH_L.

* Del ES-UP 2012/08/14 -->
*  CALL FUNCTION 'WS_FILENAME_GET'
*       EXPORTING
*            DEF_FILENAME     = GW_FILENM
*            MASK             = ',CSVファイル(*.csv),*.csv.'
*            MODE             = 'S'
*            TITLE            = '出力先'
*       IMPORTING
*            FILENAME         = P_PATH_L
*       EXCEPTIONS
*            INV_WINSYS       = 1
*            NO_BATCH         = 2
*            SELECTION_CANCEL = 3
*            SELECTION_ERROR  = 4
*            OTHERS           = 5.
*
*  IF SY-SUBRC <> 0.
*
*  ENDIF.
* Del ES-UP 2012/08/14 <--

* Add ES-UP 2012/08/14 -->
DATA: L_USER_ACTION TYPE I,
l_path        type string,
l_file        type string,
l_fullpath    type string.

CL_GUI_FRONTEND_SERVICES=>FILE_SAVE_DIALOG(
EXPORTING
WINDOW_TITLE         = '出力先'
*    DEFAULT_EXTENSION    =
*    DEFAULT_FILE_NAME    = DEFAULT_FILE_NAME
*    WITH_ENCODING        = WITH_ENCODING
FILE_FILTER          = 'CSVファイル(*.csv)|*.csv'
*    INITIAL_DIRECTORY    = INITIAL_DIRECTORY
*    PROMPT_ON_OVERWRITE  = 'X'
CHANGING
FILENAME             = l_file
PATH                 = L_PATH
FULLPATH             = l_fullpath
USER_ACTION          = L_USER_ACTION
*    FILE_ENCODING        = FILE_ENCODING
EXCEPTIONS
CNTL_ERROR           = 1
ERROR_NO_GUI         = 2
NOT_SUPPORTED_BY_GUI = 3
OTHERS               = 4 ).

if L_USER_ACTION = CL_GUI_FRONTEND_SERVICES=>ACTION_CANCEL.
MESSAGE ID '00' TYPE 'S' NUMBER '208' WITH '処理中断'.
STOP.
elseif SY-SUBRC = 0.
P_PATH_L = l_fullpath.
else.
MESSAGE I502 WITH 'FILE_SAVE_DIALOG' SY-SUBRC.
STOP.
endif.

* Add ES-UP 2012/08/14 <--

*----------------------------------------------------------------------*
START-OF-SELECTION.
*----------------------------------------------------------------------*
PERFORM INIT_PROC.
PERFORM MAIN_PROC.
PERFORM END_PROC.
*&---------------------------------------------------------------------*
*&      Form INIT_PROC
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
FORM INIT_PROC.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form DATA_GET_PROC
*&---------------------------------------------------------------------*
*       メイン処理
*----------------------------------------------------------------------*
FORM MAIN_PROC.

* 処理対象データ取得、編集処理
PERFORM DATA_EDIT_PROC.
* データ出力処理
PERFORM DATA_DOWN_PROC.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form DATA_EDIT_PROC
*&---------------------------------------------------------------------*
*       処理対象データ取得処理
*----------------------------------------------------------------------*
FORM DATA_EDIT_PROC.

*ADD 2004/10/29 ---->
*プラントデータ取得
PERFORM GET_T001W_DATA.
*ADD 2004/10/29 <----


* 会計伝票
IF NOT P_KAIKEI IS INITIAL.
PERFORM GET_KAIKEI_DATA.
PERFORM EDIT_KAIKEI_DATA.
ENDIF.
* 入出庫伝票
IF NOT P_NYUSYU IS INITIAL.
PERFORM GET_NYUSYU_DATA.
PERFORM EDIT_NYUSYU_DATA.
ENDIF.
* 請求書照合
IF NOT P_SEISYO IS INITIAL.
PERFORM GET_SEISYO_DATA.
PERFORM EDIT_SEISYO_DATA.
ENDIF.
* 購買伝票
IF NOT P_KOUBAI IS INITIAL.
PERFORM GET_KOUBAI_DATA.
PERFORM EDIT_KOUBAI_DATA.
ENDIF.
* 購買依頼
IF NOT P_KOIRAI IS INITIAL.
PERFORM GET_KOIRAI_DATA.
PERFORM EDIT_KOIRAI_DATA.
ENDIF.
* 出荷伝票
IF NOT P_SYUKKA IS INITIAL.
PERFORM GET_SYUKKA_DATA.
PERFORM EDIT_SYUKKA_DATA.
ENDIF.
* 請求伝票
IF NOT P_SEIKYU IS INITIAL.
PERFORM GET_SEIKYU_DATA.
PERFORM EDIT_SEIKYU_DATA.
ENDIF.
* 販売伝票
IF NOT P_HANBAI IS INITIAL.
PERFORM GET_HANBAI_DATA.
PERFORM EDIT_HANBAI_DATA.
ENDIF.

*ADD start by ISID21 2006/07/13 ---->
* テキスト編集
PERFORM EDIT_TEXT_DATA.
*ADD end by ISID21 2006/07/13 ---->

ENDFORM.


*&---------------------------------------------------------------------*
*&      Form  get_t001w_data
*&---------------------------------------------------------------------*
*　　　　　プラント情報の取得
*----------------------------------------------------------------------*
FORM GET_T001W_DATA.
CLEAR:GT_T001W.

SELECT WERKS "プラント
NAME1 "名称
INTO TABLE GT_T001W
FROM T001W.

* 内部テーブルのソート
SORT GT_T001W BY WERKS.

ENDFORM.                    " get_t001w_data
*&---------------------------------------------------------------------*
*&      Form GET_KAIKEI_DATA
*&---------------------------------------------------------------------*
*       会計伝票データ取得処理
*----------------------------------------------------------------------*
FORM GET_KAIKEI_DATA.

*--- ローカル変数宣言
DATA:
GW_COUNT TYPE I,          "処理件数カウント用
GW_WERKS LIKE BSEG-WERKS, "プラント
GW_MINTM TYPE T,          "処理開始時間格納用
GW_MAXTM TYPE T,          "処理終了時間格納用
*ADD 2004/10/29 ----->
GW_WERKSP LIKE BSEG-WERKS,"プラント
GW_PRCTR  LIKE BSEG-PRCTR,"利益センタ
GW_KOSTL  LIKE BSEG-KOSTL."原価センタ
*ADD 2004/10/29 <-----


* 会計伝票ヘッダ(BKPF)よりデータの取得
SELECT CPUDT                "登録日
BLART                "伝票タイプ
USNAM                "ユーザー名
CPUTM                "登録時刻
BUKRS                "会社コード
BELNR                "会計伝票番号
GJAHR                "会計年度
INTO CORRESPONDING  FIELDS OF TABLE  GT_BKPF
FROM BKPF
WHERE CPUDT IN S_DATE
AND BLART IN S_KAIKEI
AND USNAM IN S_UNAME.

* 内部テーブルのソート
SORT GT_BKPF BY CPUDT ASCENDING
BLART ASCENDING
USNAM ASCENDING
CPUTM ASCENDING
BUKRS ASCENDING
BELNR ASCENDING
GJAHR ASCENDING.

* BKPFにデータが存在する場合のみ明細データを取得
IF NOT GT_BKPF[] IS INITIAL.
*   会計伝票明細(BSEG)よりデータ取得
SELECT BUKRS              "会社コード
BELNR              "会計伝票番号
GJAHR              "会計年度
KOSTL              "原価センタ           　 ←2004/10/29 ADD
WERKS              "プラント
PRCTR              "利益センタ              ←2004/10/29 ADD
INTO CORRESPONDING FIELDS OF TABLE GT_BSEG    "←2004/10/29 MOD
*      INTO TABLE GT_BSEG
FROM BSEG
FOR ALL ENTRIES IN GT_BKPF
WHERE BUKRS = GT_BKPF-BUKRS
AND BELNR = GT_BKPF-BELNR
AND GJAHR = GT_BKPF-GJAHR
AND WERKS IN S_WERKS.



*ADD 2004/10/29 ----->
*プラントがSPACEの場合、かつ原価センタまたは利益センタが存在する場合
*原価センタOR利益センタをセットする。
CLEAR:GW_BSEG.
LOOP AT GT_BSEG INTO GW_BSEG.
CLEAR GW_WERKSP.
IF  GW_BSEG-WERKS = SPACE    AND
( GW_BSEG-KOSTL <> SPACE  OR    GW_BSEG-PRCTR <> SPACE ).
IF GW_BSEG-KOSTL <> SPACE.
*原価センタの頭1文字をPに変更し、プラントとする
CONCATENATE CNS_P GW_BSEG-KOSTL+1(3) INTO GW_WERKSP.
GW_BSEG-WERKS = GW_WERKSP.               "原価センタ
ELSE.
IF GW_BSEG-PRCTR <> SPACE.
*利益センタの頭1文字をPに変更し、プラントとする
CONCATENATE CNS_P GW_BSEG-PRCTR+1(3) INTO GW_WERKSP.
GW_BSEG-WERKS =  GW_WERKSP.            "利益センタ
ENDIF.
ENDIF.
MODIFY GT_BSEG FROM GW_BSEG.
ELSE.
ENDIF.
CLEAR:GW_BSEG.
ENDLOOP.

*READでプラントや利益センタを取得するため降順にｿｰﾄに変更
*   内部テーブルのソート
SORT GT_BSEG BY BUKRS ASCENDING
BELNR ASCENDING
GJAHR ASCENDING
*MOD 2004/10/29 ----->
*                   WERKS ASCENDING.
WERKS DESCENDING.
*MOD 2004/10/29 <-----
*ADD 2004/10/29 ----->
LOOP AT GT_BKPF INTO GW_BKPF.
CLEAR:
GW_BSEG.
*   明細データからプラントを読み込む
READ TABLE GT_BSEG INTO GW_BSEG WITH KEY BUKRS = GW_BKPF-BUKRS
BELNR = GW_BKPF-BELNR
GJAHR = GW_BKPF-GJAHR
BINARY SEARCH.
IF SY-SUBRC = 0.
GW_BKPF-WERKS = GW_BSEG-WERKS. "プラント
GW_BKPF-PRCTR = GW_BSEG-PRCTR. "利益センタ
GW_BKPF-KOSTL = GW_BSEG-KOSTL. "原価センタ
MODIFY GT_BKPF FROM GW_BKPF.
ENDIF.
ENDLOOP.
*ADD 2004/10/29 <-----
ENDIF.

LOOP AT GT_BKPF INTO GW_BKPF.

CLEAR:
GW_BSEG,
GW_MINTM,
GW_MAXTM.

*   明細データからプラントを読み込む
READ TABLE GT_BSEG INTO GW_BSEG WITH KEY BUKRS = GW_BKPF-BUKRS
BELNR = GW_BKPF-BELNR
GJAHR = GW_BKPF-GJAHR
BINARY SEARCH.

*   データを変数へ退避させる(AT NEW内で*****にさせないため)
GW_WERKS = GW_BSEG-WERKS.
GW_MINTM = GW_BKPF-CPUTM.
GW_MAXTM = GW_BKPF-CPUTM.
*ADD 2004/10/29 ----->
GW_PRCTR = GW_BSEG-PRCTR. "利益センタ
GW_KOSTL = GW_BSEG-KOSTL. "原価センタ
*ADD 2004/10/29 <-----





AT NEW USNAM.
CLEAR:
GW_COUNT,
GW_KAIKEI.

MOVE-CORRESPONDING GW_BKPF TO GW_KAIKEI.
GW_KAIKEI-WERKS = GW_WERKS.  "プラント
GW_KAIKEI-MINTM = GW_MINTM.  "最初実行時間
GW_KAIKEI-MAXTM = GW_MAXTM.  "最終実行時間
*ADD 2004/10/29 ----->
GW_KAIKEI-PRCTR = GW_PRCTR. "利益センタ
GW_KAIKEI-KOSTL = GW_KOSTL. "原価センタ
*ADD 2004/10/29 <-----


ENDAT.
GW_COUNT = GW_COUNT + 1.   "対象データ件数のカウント

*     現在確保されている最初の実行時間より早い時間の場合
IF GW_KAIKEI-MINTM > GW_BKPF-CPUTM.
*       最初の実行時間を書き換える
GW_KAIKEI-MINTM = GW_BKPF-CPUTM.
ENDIF.
*     現在確保されている最終の実行時間より遅い時間の場合
IF GW_KAIKEI-MAXTM < GW_BKPF-CPUTM.
*       最終の実行時間を書き換える
GW_KAIKEI-MAXTM = GW_BKPF-CPUTM.
ENDIF.

AT END OF USNAM.
GW_KAIKEI-COUNT = GW_COUNT.
APPEND GW_KAIKEI TO GT_KAIKEI.
ENDAT.

ENDLOOP.

* 内部テーブルの解放
FREE:
GT_BKPF,
GT_BSEG.

* 内部テーブルのソート
SORT GT_KAIKEI BY BLART ASCENDING
CPUDT ASCENDING
WERKS ASCENDING
USNAM ASCENDING.

* 伝票タイプのテキスト取得
SELECT BLART
LTEXT
INTO TABLE GT_T003T
FROM T003T
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_T003T BY BLART ASCENDING
LTEXT ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_NYUSYU_DATA
*&---------------------------------------------------------------------*
*      入出庫伝票データ取得処理
*----------------------------------------------------------------------*
FORM GET_NYUSYU_DATA.

*UPD 2006/08/26 ----->
* ローカル変数定義
DATA: LTH_NYUSYU TYPE TYP_NYUSYU,
LTH_KDAUF TYPE TYP_KDAUF,
LTD_KDAUF TYPE TABLE OF TYP_KDAUF,
LTH_VBELN_IM TYPE TYP_VBELN_IM,
LTD_VBELN_IM TYPE TABLE OF TYP_VBELN_IM,
LTH_PERNR   TYPE TYP_PERNR,
LTD_PERNR    TYPE TABLE OF TYP_PERNR,
LTH_KUNNR    TYPE TYP_VBAK_KUNNR,
LTD_KUNNR    TYPE TABLE OF TYP_VBAK_KUNNR,
LTH_NYUSYU_BAK TYPE TYP_NYUSYU,
LW_COUNT TYPE P,
LW_MINTM LIKE MKPF-CPUTM,
LTD_NYUSYU TYPE TABLE OF TYP_NYUSYU.

*  SELECT MKPF~BLART        "伝票タイプ
*         MSEG~BWART        "移動タイプ
*         MKPF~CPUDT        "登録日
*         MKPF~USNAM        "ユーザ名
*         MSEG~WERKS        "プラント
*         MSEG~KUNNR        "得意先
*         MSEG~LIFNR          "仕入先
*         COUNT( * )        "データ件数
*         MIN( MKPF~CPUTM ) "最初データ投入時間
*         MAX( MKPF~CPUTM ) "最終データ投入時間
*    INTO TABLE GT_NYUSYU
*    FROM MKPF
*   INNER JOIN MSEG
*     ON  MKPF~MBLNR = MSEG~MBLNR
*    AND  MKPF~MJAHR = MSEG~MJAHR
*   WHERE MKPF~BLART IN S_NYUSYU
*     AND MKPF~USNAM IN S_UNAME
*     AND MSEG~WERKS IN S_WERKS
*     AND MKPF~CPUDT IN S_DATE
*   GROUP BY MKPF~BLART     "伝票タイプ
*            MSEG~BWART     "移動タイプ
*            MKPF~CPUDT     "登録日
*            MKPF~USNAM     "ユーザ名
*            MSEG~WERKS     "プラント
*            MSEG~KUNNR      "得意先
*            MSEG~LIFNR.       "仕入先

** 内部テーブルのソート
*  SORT GT_NYUSYU BY BLART ASCENDING
*                    BWART ASCENDING
*                    CPUDT ASCENDING
*                    WERKS ASCENDING
*                    USNAM ASCENDING.

SELECT MKPF~BLART AS BLART        "伝票タイプ
MSEG~BWART  AS BWART      "移動タイプ
MKPF~CPUDT AS CPUDT        "登録日
MSEG~WERKS AS WERKS        "プラント
MKPF~USNAM AS USNAM        "ユーザ名
MSEG~KUNNR AS KUNNR       "得意先
MSEG~LIFNR  AS LIFNR        "仕入先
MSEG~KDAUF AS KDAUF      "受注伝票
MSEG~VBELN_IM AS VBELN_IM "出荷伝票
MKPF~CPUTM AS MINTM    "最初データ投入時間
MKPF~CPUTM AS MAXTM  "最終データ投入時間
INTO  CORRESPONDING FIELDS OF TABLE GT_NYUSYU
FROM MKPF
INNER JOIN MSEG
ON  MKPF~MBLNR = MSEG~MBLNR
AND  MKPF~MJAHR = MSEG~MJAHR
WHERE MKPF~BLART IN S_NYUSYU
AND MKPF~USNAM IN S_UNAME
AND MSEG~WERKS IN S_WERKS
AND MKPF~CPUDT IN S_DATE.

* 出荷伝票情報、受注伝票情報を取得する。
LOOP AT GT_NYUSYU INTO LTH_NYUSYU.
IF LTH_NYUSYU-KDAUF IS NOT INITIAL.
LTH_KDAUF-KDAUF = LTH_NYUSYU-KDAUF.
APPEND LTH_KDAUF TO LTD_KDAUF.
CONTINUE.
ENDIF.

IF LTH_NYUSYU-VBELN_IM IS NOT INITIAL.
LTH_VBELN_IM-VBELN_IM = LTH_NYUSYU-VBELN_IM.
APPEND LTH_VBELN_IM TO LTD_VBELN_IM.
ENDIF.
ENDLOOP.

*　出荷伝票の受注伝票を取得する。
IF LTD_VBELN_IM[] IS NOT INITIAL.
SORT LTD_VBELN_IM BY VBELN_IM.
DELETE ADJACENT DUPLICATES FROM LTD_VBELN_IM COMPARING VBELN_IM.

SELECT VGBEL VBELN FROM LIPS
APPENDING TABLE LTD_KDAUF
FOR ALL ENTRIES IN LTD_VBELN_IM
WHERE VBELN = LTD_VBELN_IM-VBELN_IM.
ENDIF.

*　受注伝票より営業員と営業員アシスタントを取得する。
IF LTD_KDAUF[] IS NOT INITIAL.
SORT LTD_KDAUF BY KDAUF VBELN_IM.
DELETE ADJACENT DUPLICATES FROM LTD_KDAUF COMPARING ALL FIELDS.

*   営業員情報を取得する。
SELECT VBELN PARVW PERNR  INTO TABLE LTD_PERNR
FROM VBPA
FOR ALL ENTRIES IN LTD_KDAUF
WHERE VBELN = LTD_KDAUF-KDAUF
AND POSNR = '000000'
AND ( PARVW = 'VE' OR PARVW = 'ZP').

*   得意先を取得する。
SELECT VBELN KUNNR INTO TABLE LTD_KUNNR
FROM VBAK
FOR ALL ENTRIES IN LTD_KDAUF
WHERE VBELN = LTD_KDAUF-KDAUF.
ENDIF.



* 得意先、営業員と営業アシスタントを更新する。
LOOP AT GT_NYUSYU INTO LTH_NYUSYU.
CLEAR: LTH_PERNR,
LTH_KUNNR.

IF LTH_NYUSYU-KDAUF IS INITIAL AND
LTH_NYUSYU-VBELN_IM IS NOT INITIAL.
READ TABLE LTD_KDAUF  INTO  LTH_KDAUF
WITH KEY VBELN_IM = LTH_NYUSYU-VBELN_IM.

IF SY-SUBRC = 0.
LTH_NYUSYU-KDAUF = LTH_KDAUF-KDAUF.
ENDIF.
ENDIF.

IF LTH_NYUSYU-KDAUF IS NOT INITIAL.
READ TABLE LTD_PERNR  INTO  LTH_PERNR
WITH KEY VBELN = LTH_NYUSYU-KDAUF
PARVW = 'VE'.

IF SY-SUBRC = 0.
LTH_NYUSYU-PERNR_VE = LTH_PERNR-PERNR.
ENDIF.


READ TABLE LTD_PERNR  INTO  LTH_PERNR
WITH KEY VBELN = LTH_NYUSYU-KDAUF
PARVW = 'ZP'.

IF SY-SUBRC = 0.
LTH_NYUSYU-PERNR_ZP = LTH_PERNR-PERNR.
ENDIF.

READ TABLE LTD_KUNNR  INTO  LTH_KUNNR
WITH KEY VBELN = LTH_NYUSYU-KDAUF.

IF SY-SUBRC = 0.
LTH_NYUSYU-KUNNR = LTH_KUNNR-KUNNR.
ENDIF.

MODIFY GT_NYUSYU FROM LTH_NYUSYU
TRANSPORTING KUNNR PERNR_VE PERNR_ZP.
ENDIF.

ENDLOOP.

* ソート処理。
SORT GT_NYUSYU BY BLART ASCENDING
BWART ASCENDING
CPUDT ASCENDING
WERKS ASCENDING
USNAM ASCENDING
KUNNR ASCENDING
LIFNR  ASCENDING
PERNR_VE ASCENDING
PERNR_ZP ASCENDING
MINTM ASCENDING.
* 入出庫伝票の集計。
LOOP AT GT_NYUSYU INTO LTH_NYUSYU.
LTH_NYUSYU_BAK = LTH_NYUSYU.

AT NEW PERNR_ZP.
LW_COUNT = 0.
LW_MINTM = LTH_NYUSYU_BAK-MINTM.
ENDAT.

LW_COUNT = LW_COUNT + 1.

AT END OF PERNR_ZP.
LTH_NYUSYU_BAK-COUNT = LW_COUNT.
LTH_NYUSYU_BAK-MINTM = LW_MINTM.
APPEND LTH_NYUSYU_BAK TO LTD_NYUSYU.
ENDAT.
ENDLOOP.
GT_NYUSYU[] = LTD_NYUSYU[].
*UPD 2016/08/26 <-----

* 伝票タイプのテキスト取得
SELECT BLART
LTEXT
INTO TABLE GT_T003T
FROM T003T
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_T003T BY BLART ASCENDING
LTEXT ASCENDING.

* 移動タイプのテキスト取得
SELECT BWART
BTEXT
INTO TABLE GT_T156T
FROM T156T
WHERE SPRAS ='J'.

* 内部テーブルのソート
SORT GT_T156T BY BWART ASCENDING
BTEXT ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_SEISYO_DATA
*&---------------------------------------------------------------------*
*      請求書照合データ取得処理
*----------------------------------------------------------------------*
FORM GET_SEISYO_DATA.

* 請求書照合ヘッダデータ取得
SELECT BLART "伝票タイプ
USNAM "ユーザ名
CPUDT "会計伝票登録日
CPUTM "登録開始時刻
BELNR "請求書伝票の伝票番号
GJAHR "会計年度
INTO TABLE GT_RBKP
FROM RBKP
WHERE BLART IN S_SEISYO
AND USNAM IN S_UNAME
AND CPUDT IN S_DATE.

SORT GT_RBKP BY BLART ASCENDING  "伝票タイプ
USNAM ASCENDING  "ユーザ名
CPUDT ASCENDING  "会計伝票登録日
CPUTM ASCENDING  "登録開始時刻
BELNR ASCENDING  "請求書伝票の伝票番号
GJAHR ASCENDING. "会計年度

IF NOT GT_RBKP[] IS INITIAL.

*   請求書照合明細データ取得
SELECT BELNR "請求書伝票の伝票番号
GJAHR "会計年度
WERKS "プラント
INTO TABLE GT_RSEG
FROM RSEG
FOR ALL ENTRIES IN GT_RBKP
WHERE BELNR = GT_RBKP-BELNR
AND GJAHR = GT_RBKP-GJAHR
AND WERKS IN S_WERKS.

SORT GT_RSEG BY BELNR ASCENDING  "請求書伝票の伝票番号
GJAHR ASCENDING  "会計年度
WERKS ASCENDING. "プラント
ENDIF.

LOOP AT GT_RBKP INTO GW_RBKP.

CLEAR:
GW_RSEG,
GW_MINTM,
GW_MAXTM.

*   明細データからプラントを読み込む
READ TABLE GT_RSEG INTO GW_RSEG WITH KEY BELNR = GW_RBKP-BELNR
GJAHR = GW_RBKP-GJAHR
BINARY SEARCH.
* Add 2004/09/27 -->
IF SY-SUBRC NE 0 .
CONTINUE .
ENDIF .
* Add 2004/09/27 <--

*   データを変数へ退避させる(AT NEW内で*****にさせないため)
GW_WERKS = GW_RSEG-WERKS.
GW_MINTM = GW_RBKP-CPUTM.
GW_MAXTM = GW_RBKP-CPUTM.

AT NEW CPUDT.
CLEAR:
GW_COUNT,
GW_KAIKEI.

MOVE-CORRESPONDING GW_RBKP TO GW_SEISYO.

GW_SEISYO-WERKS = GW_WERKS.  "プラント
GW_SEISYO-MINTM = GW_MINTM.  "最初実行時間
GW_SEISYO-MAXTM = GW_MAXTM.  "最終実行時間

ENDAT.
GW_COUNT = GW_COUNT + 1.   "対象データ件数のカウント

*     現在確保されている最初の実行時間より早い時間の場合
IF GW_SEISYO-MINTM > GW_RBKP-CPUTM.
*       最初の実行時間を書き換える
GW_SEISYO-MINTM = GW_RBKP-CPUTM.
ENDIF.
*     現在確保されている最終の実行時間より遅い時間の場合
IF GW_SEISYO-MAXTM < GW_RBKP-CPUTM.
*       最終の実行時間を書き換える
GW_SEISYO-MAXTM = GW_RBKP-CPUTM.
ENDIF.

AT END OF CPUDT.
GW_SEISYO-COUNT = GW_COUNT.
APPEND GW_SEISYO TO GT_SEISYO.
ENDAT.

ENDLOOP.

* 内部テーブルの解放
FREE:
GT_RBKP,
GT_RSEG.

* 内部テーブルのソート
SORT GT_SEISYO BY BLART ASCENDING
CPUDT ASCENDING
WERKS ASCENDING
USNAM ASCENDING.

* 伝票タイプのテキスト取得
SELECT BLART
LTEXT
INTO TABLE GT_T003T
FROM T003T
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_T003T BY BLART ASCENDING
LTEXT ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_KOUBAI_DATA
*&---------------------------------------------------------------------*
*      購買伝票データ取得処理
*----------------------------------------------------------------------*
FORM GET_KOUBAI_DATA.

* ローカル変数
DATA:
LTH_EKKN_VBPA TYPE TYP_EKKN_VBPA,
LTD_EKKN_VBPA TYPE TABLE OF TYP_EKKN_VBPA,
LW_TABIX TYPE SY-TABIX.

* 購買伝票ヘッダデータ取得
SELECT BSART "伝票タイプ
LIFNR    "仕入先
AEDAT "伝票登録日
ERNAM "ユーザ名
EKGRP "購買グループ
EBELN "購買伝票番号
INTO CORRESPONDING FIELDS OF TABLE GT_EKKO
FROM EKKO
WHERE BSART IN S_KOUBAI
AND AEDAT IN S_DATE
AND ERNAM IN S_UNAME.

* 個別購買の受注取引先情報を取得
SELECT EKKN~EBELN
VBPA~VBELN
VBPA~PARVW
VBPA~KUNNR
VBPA~PERNR
INTO TABLE LTD_EKKN_VBPA
FROM EKKN INNER JOIN VBPA
ON  EKKN~VBELN = VBPA~VBELN
FOR ALL ENTRIES IN GT_EKKO
WHERE EKKN~EBELN = GT_EKKO-EBELN
AND VBPA~POSNR = '000000'
AND ( VBPA~PARVW = 'AG' OR
VBPA~PARVW = 'VE' OR
VBPA~PARVW = 'ZP').


LOOP AT GT_EKKO INTO GW_EKKO.
CLEAR  LTH_EKKN_VBPA.

*   受注先を取得する
READ TABLE LTD_EKKN_VBPA INTO LTH_EKKN_VBPA
WITH KEY EBELN = GW_EKKO-EBELN
PARVW = 'AG'.

IF SY-SUBRC = 0.
GW_EKKO-KUNNR = LTH_EKKN_VBPA-KUNNR.
ENDIF.

*   営業員を取得する。
READ TABLE LTD_EKKN_VBPA INTO LTH_EKKN_VBPA
WITH KEY EBELN = GW_EKKO-EBELN
PARVW = 'VE'.

IF SY-SUBRC = 0.
GW_EKKO-PERNR_VE = LTH_EKKN_VBPA-PERNR.
ENDIF.

*   営業員アシスタントを取得する。
READ TABLE LTD_EKKN_VBPA INTO LTH_EKKN_VBPA
WITH KEY EBELN = GW_EKKO-EBELN
PARVW = 'ZP'.

IF SY-SUBRC = 0.
GW_EKKO-PERNR_ZP = LTH_EKKN_VBPA-PERNR.
ENDIF.

MODIFY GT_EKKO FROM GW_EKKO TRANSPORTING KUNNR PERNR_VE PERNR_ZP.

ENDLOOP.

SORT GT_EKKO BY BSART  "伝票タイプ
AEDAT  "伝票登録日
LIFNR    "仕入先
KUNNR  "得意先
PERNR_VE   "営業員
PERNR_ZP   "営業員アシスタント
ERNAM  "ユーザ名
EKGRP  "購買グループ
EBELN. "購買伝票番号

IF NOT GT_EKKO[] IS INITIAL.
*   購買伝票明細データ取得
SELECT EBELN  "購買伝票番号
WERKS  "プラント
INTO TABLE GT_EKPO
FROM EKPO
FOR ALL ENTRIES IN GT_EKKO
WHERE EBELN = GT_EKKO-EBELN
AND WERKS IN S_WERKS.

SORT GT_EKPO BY EBELN   "購買伝票番号
WERKS.  "プラント
ENDIF.

* 対象外のデータを削除する。
LOOP AT GT_EKKO INTO GW_EKKO.
LW_TABIX = SY-TABIX.

*   明細データからプラントを読み込む
READ TABLE GT_EKPO INTO GW_EKPO WITH KEY EBELN = GW_EKKO-EBELN
BINARY SEARCH.
IF SY-SUBRC NE 0 .
DELETE  GT_EKKO INDEX LW_TABIX .
CONTINUE.
ENDIF .

IF NOT GW_EKPO-WERKS IN S_WERKS  .
DELETE  GT_EKKO INDEX LW_TABIX .
ENDIF .
ENDLOOP.


LOOP AT GT_EKKO INTO GW_EKKO.

CLEAR:
GW_EKPO,
GW_MINTM,
GW_MAXTM.

**   明細データからプラントを読み込む
READ TABLE GT_EKPO INTO GW_EKPO WITH KEY EBELN = GW_EKKO-EBELN
BINARY SEARCH.
*    IF SY-SUBRC NE 0 .
*      CONTINUE .
*    ENDIF .
*   データを変数へ退避させる(AT NEW内で*****にさせないため)
GW_WERKS = GW_EKPO-WERKS.
** Add 2004/09/27 -->
**   選択画面で指定したプラントで絞込み
*    IF NOT GW_EKPO-WERKS IN S_WERKS  .
*      CONTINUE .
*    ENDIF .
** Add 2004/09/27 <--

*    GW_MINTM = GW_EKKO-CPUTM.
*    GW_MAXTM = GW_EKKO-CPUTM.

AT NEW EKGRP.
CLEAR:
GW_COUNT,
GW_KOUBAI.

MOVE-CORRESPONDING GW_EKKO TO GW_KOUBAI.

GW_KOUBAI-WERKS = GW_WERKS.  "プラント
*      GW_KOUBAI-MINTM = GW_MINTM.  "最初実行時間
*      GW_KOUBAI-MAXTM = GW_MAXTM.  "最終実行時間

ENDAT.
GW_COUNT = GW_COUNT + 1.   "対象データ件数のカウント

**     現在確保されている最初の実行時間より早い時間の場合
*      IF GW_KOUBAI-MINTM > GW_EKKO-CPUTM.
**       最初の実行時間を書き換える
*        GW_KOUBAI-MINTM = GW_EKKO-CPUTM.
*      ENDIF.
**     現在確保されている最終の実行時間より遅い時間の場合
*      IF GW_KOUBAI-MAXTM < GW_EKKO-CPUTM.
**       最終の実行時間を書き換える
*        GW_KOUBAI-MAXTM = GW_EKKO-CPUTM.
*      ENDIF.

AT END OF EKGRP.
GW_KOUBAI-COUNT = GW_COUNT.
APPEND GW_KOUBAI TO GT_KOUBAI.
ENDAT.

ENDLOOP.

* 内部テーブルの解放
FREE:
GT_EKKO,
GT_EKPO.

* 内部テーブルのソート
SORT GT_KOUBAI BY BSART ASCENDING
AEDAT ASCENDING
WERKS ASCENDING
LIFNR    ASCENDING
KUNNR  ASCENDING
PERNR_VE   ASCENDING
PERNR_ZP   ASCENDING
ERNAM ASCENDING
EKGRP ASCENDING.

* 伝票タイプのテキスト取得
SELECT BSART
BATXT
INTO TABLE GT_T161T
FROM T161T
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_T161T BY BSART ASCENDING
BATXT ASCENDING.

* 購買グループ名称取得用
SELECT EKGRP  "購買グループ
EKNAM  "購買グループテキスト
INTO TABLE GT_T024
FROM T024.

* 内部テーブルのソート
SORT GT_T024 BY EKGRP ASCENDING
EKNAM ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_KOIRAI_DATA
*&---------------------------------------------------------------------*
*      購買依頼データ取得処理
*----------------------------------------------------------------------*
FORM GET_KOIRAI_DATA.

SELECT BSART           "購買依頼伝票タイプ
ERNAM           "登録者名
EKGRP           "購買グループ
WERKS           "プラント
ERDAT           "変更日
COUNT( * )      "データ件数
INTO TABLE GT_KOIRAI
FROM EBAN
WHERE BSART IN S_KOIRAI
AND ERNAM IN S_UNAME
AND WERKS IN S_WERKS
AND ERDAT IN S_DATE
GROUP BY BSART        "購買依頼伝票タイプ
ERNAM        "登録者名
EKGRP        "購買グループ
WERKS        "プラント
ERDAT.       "変更日

* 内部テーブルのソート
SORT GT_KOIRAI BY BSART ASCENDING
ERDAT ASCENDING
WERKS ASCENDING
ERNAM ASCENDING
EKGRP ASCENDING.

* 伝票タイプのテキスト取得
SELECT BSART
BATXT
INTO TABLE GT_T161T
FROM T161T
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_T161T BY BSART ASCENDING
BATXT ASCENDING.

* 購買グループ名称取得用
SELECT EKGRP  "購買グループ
EKNAM  "購買グループテキスト
INTO TABLE GT_T024
FROM T024.

* 内部テーブルのソート
SORT GT_T024 BY EKGRP ASCENDING
EKNAM ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_SYUKKA_DATA
*&---------------------------------------------------------------------*
*      出荷伝票データ取得処理
*----------------------------------------------------------------------*
FORM GET_SYUKKA_DATA.

DATA: LW_VKGRP LIKE VBRP-VKGRP,
LW_TABIX  LIKE SY-TABIX,
LTH_KDAUF TYPE TYP_KDAUF,
LTD_KDAUF TYPE TABLE OF TYP_KDAUF,
LTH_PERNR   TYPE TYP_PERNR,
LTD_PERNR    TYPE TABLE OF TYP_PERNR.

* 出荷伝票ヘッダデータ取得用
SELECT ERNAM  "オブジェクト登録者名
ERDAT  "レコード登録日
LFART  "出荷伝票タイプ
KUNAG  "受注先
ERZET  "登録開始時刻
VBELN  "出荷伝票番号
INTO CORRESPONDING FIELDS OF TABLE GT_LIKP
FROM LIKP
WHERE ERNAM IN S_UNAME
AND ERDAT IN S_DATE
AND LFART IN S_SYUKKA.

SORT GT_LIKP BY ERNAM  "オブジェクト登録者名
ERDAT  "レコード登録日
LFART  "出荷伝票タイプ
KUNAG  "受注先
ERZET  "登録開始時刻
VBELN. "出荷伝票番号

IF NOT GT_LIKP[] IS INITIAL.
*   出荷伝票明細データ取得用
SELECT VBELN  "出荷伝票番号
WERKS  "プラント
VKGRP  "営業グループ
VGBEL  "受注伝票
INTO TABLE GT_LIPS
FROM LIPS
FOR ALL ENTRIES IN GT_LIKP
WHERE VBELN = GT_LIKP-VBELN
AND WERKS IN S_WERKS.

SORT GT_LIPS BY VBELN  "出荷伝票番号
WERKS  "プラント
VKGRP. "営業グループ
ENDIF.

* Add 2016/08/26 -->
* 明細なしの出荷伝票を削除する
LOOP AT GT_LIKP INTO GW_LIKP.
LW_TABIX = SY-TABIX.

*   明細データからプラントを読み込む
READ TABLE GT_LIPS INTO GW_LIPS WITH KEY VBELN = GW_LIKP-VBELN
BINARY SEARCH.

IF SY-SUBRC NE 0 .
DELETE GT_LIKP INDEX LW_TABIX.
ENDIF .
ENDLOOP.

* 営業員と営業員アシスタントを取得する。
LOOP AT GT_LIPS INTO GW_LIPS.
LTH_KDAUF-KDAUF = GW_LIPS-VGBEL.
LTH_KDAUF-VBELN_IM = GW_LIPS-VBELN.
APPEND LTH_KDAUF TO LTD_KDAUF.
ENDLOOP.

IF LTD_KDAUF[] IS NOT INITIAL.
SORT LTD_KDAUF BY KDAUF VBELN_IM.
DELETE ADJACENT DUPLICATES FROM LTD_KDAUF COMPARING ALL FIELDS.

*   営業員情報を取得する。
SELECT VBELN PARVW PERNR  INTO TABLE LTD_PERNR
FROM VBPA
FOR ALL ENTRIES IN LTD_KDAUF
WHERE VBELN = LTD_KDAUF-KDAUF
AND POSNR = '000000'
AND ( PARVW = 'VE' OR PARVW = 'ZP').
ENDIF.

* 営業員と営業員アシスタントをセットする。
LOOP AT GT_LIKP INTO GW_LIKP.
CLEAR LTH_PERNR.

READ TABLE LTD_KDAUF  INTO  LTH_KDAUF
WITH KEY VBELN_IM = GW_LIKP-VBELN.

IF SY-SUBRC <> 0.
CONTINUE.
ENDIF.

READ TABLE LTD_PERNR  INTO  LTH_PERNR
WITH KEY VBELN = LTH_KDAUF-KDAUF
PARVW = 'VE'.

IF SY-SUBRC = 0.
GW_LIKP-PERNR_VE = LTH_PERNR-PERNR.
ENDIF.


READ TABLE LTD_PERNR  INTO  LTH_PERNR
WITH KEY VBELN = LTH_KDAUF-KDAUF
PARVW = 'ZP'.

IF SY-SUBRC = 0.
GW_LIKP-PERNR_ZP = LTH_PERNR-PERNR.
ENDIF.

MODIFY GT_LIKP FROM GW_LIKP TRANSPORTING PERNR_VE PERNR_ZP.
ENDLOOP.

* ソート
SORT GT_LIKP BY ERNAM  "オブジェクト登録者名
ERDAT  "レコード登録日
LFART  "出荷伝票タイプ
KUNAG  "受注先
PERNR_VE  "営業員
PERNR_ZP   "営業員アシスタント
ERZET  "登録開始時刻
VBELN. "出荷伝票番号
* Add 2016/08/26 <--

LOOP AT GT_LIKP INTO GW_LIKP.

CLEAR:
GW_LIPS,
GW_MINTM,
GW_MAXTM.

**   明細データからプラントを読み込む
READ TABLE GT_LIPS INTO GW_LIPS WITH KEY VBELN = GW_LIKP-VBELN
BINARY SEARCH.
** Add 2004/09/28 -->
*    IF SY-SUBRC NE 0 .
*      CONTINUE .
*    ENDIF .
** Add 2004/09/28 <--

*   データを変数へ退避させる(AT NEW内で*****にさせないため)
GW_WERKS = GW_LIPS-WERKS.
GW_MINTM = GW_LIKP-ERZET.
GW_MAXTM = GW_LIKP-ERZET.
LW_VKGRP = GW_LIPS-VKGRP.

AT NEW PERNR_ZP.
CLEAR:
GW_COUNT,
GW_SYUKKA.

MOVE-CORRESPONDING GW_LIKP TO GW_SYUKKA.

GW_SYUKKA-WERKS = GW_WERKS.  "プラント
GW_SYUKKA-MINTM = GW_MINTM.  "最初実行時間
GW_SYUKKA-MAXTM = GW_MAXTM.  "最終実行時間
GW_SYUKKA-VKGRP = LW_VKGRP.  "営業グループ

ENDAT.
GW_COUNT = GW_COUNT + 1.   "対象データ件数のカウント

*     現在確保されている最初の実行時間より早い時間の場合
IF GW_SYUKKA-MINTM > GW_LIKP-ERZET.
*       最初の実行時間を書き換える
GW_SYUKKA-MINTM = GW_LIKP-ERZET.
ENDIF.
*     現在確保されている最終の実行時間より遅い時間の場合
IF GW_SYUKKA-MAXTM < GW_LIKP-ERZET.
*       最終の実行時間を書き換える
GW_SYUKKA-MAXTM = GW_LIKP-ERZET.
ENDIF.

AT END OF PERNR_ZP.
GW_SYUKKA-COUNT = GW_COUNT.
APPEND GW_SYUKKA TO GT_SYUKKA.
ENDAT.

ENDLOOP.

FREE:GT_LIKP,
GT_LIPS.

* 内部テーブルのソート
SORT GT_SYUKKA BY LFART ASCENDING
ERDAT ASCENDING
WERKS ASCENDING
ERNAM ASCENDING
VKGRP ASCENDING.

* 伝票タイプのテキスト取得
SELECT LFART
VTEXT
INTO TABLE GT_TVLKT
FROM TVLKT
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_TVLKT BY LFART ASCENDING
VTEXT ASCENDING.

* 営業グループ名称取得
SELECT VKGRP  "営業グループ
BEZEI  "内容説明
INTO TABLE GT_TVGRT
FROM TVGRT
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_TVGRT BY VKGRP ASCENDING
BEZEI ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_SEIKYU_DATA
*&---------------------------------------------------------------------*
*      請求伝票データ取得処理
*----------------------------------------------------------------------*
FORM GET_SEIKYU_DATA.

DATA LW_VKGRP LIKE VBRP-VKGRP.

* 請求伝票ヘッダデータ取得用
SELECT FKART  "請求タイプ
ERNAM  "オブジェクト登録者名
ERDAT  "レコード登録日
ERZET  "登録開始時刻
VBELN  "請求伝票
INTO TABLE GT_VBRK
FROM VBRK
WHERE FKART IN S_SEIKYU
AND ERNAM IN S_UNAME
AND ERDAT IN S_DATE.

SORT GT_VBRK BY FKART  "請求タイプ
ERNAM  "オブジェクト登録者名
ERDAT  "レコード登録日
ERZET  "登録開始時刻
VBELN. "請求伝票

IF NOT GT_VBRK[] IS INITIAL.
*   請求伝票明細データ取得用
SELECT VBELN  "請求伝票
WERKS  "プラント
VKGRP  "営業グループ
INTO TABLE GT_VBRP
FROM VBRP
FOR ALL ENTRIES IN GT_VBRK
WHERE VBELN = GT_VBRK-VBELN
AND WERKS IN S_WERKS.

SORT GT_VBRP BY VBELN  "請求伝票
WERKS  "プラント
VKGRP. "営業グループ

ENDIF.

LOOP AT GT_VBRK INTO GW_VBRK.

CLEAR:
GW_VBRP,
GW_MINTM,
GW_MAXTM.

*   明細データからプラントを読み込む
READ TABLE GT_VBRP INTO GW_VBRP WITH KEY VBELN = GW_VBRK-VBELN
BINARY SEARCH.
* Add 2004/09/28 -->
IF SY-SUBRC NE 0 .
CONTINUE .
ENDIF .
* Add 2004/09/28 <--

*   データを変数へ退避させる(AT NEW内で*****にさせないため)
GW_WERKS = GW_VBRP-WERKS.
GW_MINTM = GW_VBRK-ERZET.
GW_MAXTM = GW_VBRK-ERZET.
LW_VKGRP = GW_VBRP-VKGRP.


AT NEW ERDAT.
CLEAR:
GW_COUNT,
GW_SEIKYU.

MOVE-CORRESPONDING GW_VBRK TO GW_SEIKYU.

GW_SEIKYU-WERKS = GW_WERKS.  "プラント
GW_SEIKYU-MINTM = GW_MINTM.  "最初実行時間
GW_SEIKYU-MAXTM = GW_MAXTM.  "最終実行時間
GW_SEIKYU-VKGRP = LW_VKGRP.

ENDAT.
GW_COUNT = GW_COUNT + 1.   "対象データ件数のカウント

*     現在確保されている最初の実行時間より早い時間の場合
IF GW_SEIKYU-MINTM > GW_VBRK-ERZET.
*       最初の実行時間を書き換える
GW_SEIKYU-MINTM = GW_VBRK-ERZET.
ENDIF.
*     現在確保されている最終の実行時間より遅い時間の場合
IF GW_SEIKYU-MAXTM < GW_VBRK-ERZET.
*       最終の実行時間を書き換える
GW_SEIKYU-MAXTM = GW_VBRK-ERZET.
ENDIF.

AT END OF ERDAT.
GW_SEIKYU-COUNT = GW_COUNT.
APPEND GW_SEIKYU TO GT_SEIKYU.
ENDAT.

ENDLOOP.

FREE:GT_VBRK,
GT_VBRP.

* 内部テーブルのソート
SORT GT_SEIKYU BY FKART ASCENDING
ERDAT ASCENDING
WERKS ASCENDING
ERNAM ASCENDING.

* 伝票タイプのテキスト取得
SELECT FKART
VTEXT
INTO TABLE GT_TVFKT
FROM TVFKT
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_TVFKT BY FKART ASCENDING
VTEXT ASCENDING.

* 営業グループ名称取得
SELECT VKGRP  "営業グループ
BEZEI  "内容説明
INTO TABLE GT_TVGRT
FROM TVGRT
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_TVGRT BY VKGRP ASCENDING
BEZEI ASCENDING.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form GET_HANBAI_DATA
*&---------------------------------------------------------------------*
*      販売伝票データ取得処理
*----------------------------------------------------------------------*
FORM GET_HANBAI_DATA.
* ローカル変数
DATA: LW_TABIX TYPE SY-TABIX,
LTH_PERNR   TYPE TYP_PERNR,
LTD_PERNR    TYPE TABLE OF TYP_PERNR.

*    販売伝票ヘッダデータ取得用
SELECT ERDAT   "レコード登録日
ERNAM   "オブジェクト登録者名
VKGRP   "営業グループ
KUNNR    "得意先
AUART   "販売伝票タイプ
ERZET   "登録開始時刻
VBELN   "販売伝票番号
INTO CORRESPONDING FIELDS OF TABLE GT_VBAK
FROM VBAK
WHERE ERDAT IN S_DATE
AND ERNAM IN S_UNAME
AND AUART IN S_HANBAI.

*   営業員情報を取得する。
SELECT VBELN PARVW PERNR  INTO TABLE LTD_PERNR
FROM VBPA
FOR ALL ENTRIES IN GT_VBAK
WHERE VBELN = GT_VBAK-VBELN
AND POSNR = '000000'
AND ( PARVW = 'VE' OR PARVW = 'ZP').

LOOP AT GT_VBAK INTO GW_VBAK.
CLEAR: LTH_PERNR..

READ TABLE LTD_PERNR  INTO  LTH_PERNR
WITH KEY VBELN = GW_VBAK-VBELN
PARVW = 'VE'.

IF SY-SUBRC = 0.
GW_VBAK-PERNR_VE = LTH_PERNR-PERNR.
ENDIF.


READ TABLE LTD_PERNR  INTO  LTH_PERNR
WITH KEY VBELN = GW_VBAK-VBELN
PARVW = 'ZP'.

IF SY-SUBRC = 0.
GW_VBAK-PERNR_ZP = LTH_PERNR-PERNR.
ENDIF.

MODIFY GT_VBAK FROM GW_VBAK TRANSPORTING PERNR_VE PERNR_ZP.

ENDLOOP.

SORT GT_VBAK BY ERDAT   "レコード登録日
ERNAM   "オブジェクト登録者名
VKGRP   "営業グループ
KUNNR       "得意先
PERNR_VE   "営業員
PERNR_ZP   "営業員アシスタント
AUART   "販売伝票タイプ
ERZET   "登録開始時刻
VBELN.  "販売伝票番号

IF NOT GT_VBAK[] IS INITIAL.
*   販売伝票明細データ取得用
SELECT VBELN    "販売伝票番号
WERKS    "プラント
INTO TABLE GT_VBAP
FROM VBAP
FOR ALL ENTRIES IN GT_VBAK
WHERE VBELN = GT_VBAK-VBELN
AND WERKS IN S_WERKS.

SORT GT_VBAP BY VBELN    "販売伝票番号
WERKS.   "プラント
ENDIF.

* Add 2016/08/26 -->
LOOP AT GT_VBAK INTO GW_VBAK.
LW_TABIX = SY-TABIX.

*   明細データからプラントを読み込む
READ TABLE GT_VBAP INTO GW_VBAP WITH KEY VBELN = GW_VBAK-VBELN
BINARY SEARCH.

IF SY-SUBRC NE 0 .
DELETE GT_VBAK  INDEX LW_TABIX.
ENDIF .
ENDLOOP.

* Add 2016/08/26 <--

LOOP AT GT_VBAK INTO GW_VBAK.

CLEAR:
GW_VBAP,
GW_MINTM,
GW_MAXTM.

* Delete 2016/08/26 -->
**   明細データからプラントを読み込む
READ TABLE GT_VBAP INTO GW_VBAP WITH KEY VBELN = GW_VBAK-VBELN
BINARY SEARCH.
** Add 2004/09/28 -->
*    IF SY-SUBRC NE 0 .
*      CONTINUE .
*    ENDIF .
** Add 2004/09/28 <--
* Delete 2016/08/26 <--

*   データを変数へ退避させる(AT NEW内で*****にさせないため)
GW_WERKS = GW_VBAP-WERKS.
GW_MINTM = GW_VBAK-ERZET.
GW_MAXTM = GW_VBAK-ERZET.

AT NEW AUART.
CLEAR:
GW_COUNT,
GW_HANBAI.

MOVE-CORRESPONDING GW_VBAK TO GW_HANBAI.

GW_HANBAI-WERKS = GW_WERKS.  "プラント
GW_HANBAI-MINTM = GW_MINTM.  "最初実行時間
GW_HANBAI-MAXTM = GW_MAXTM.  "最終実行時間

ENDAT.
GW_COUNT = GW_COUNT + 1.   "対象データ件数のカウント

*     現在確保されている最初の実行時間より早い時間の場合
IF GW_HANBAI-MINTM > GW_VBAK-ERZET.
*       最初の実行時間を書き換える
GW_HANBAI-MINTM = GW_VBAK-ERZET.
ENDIF.
*     現在確保されている最終の実行時間より遅い時間の場合
IF GW_HANBAI-MAXTM < GW_VBAK-ERZET.
*       最終の実行時間を書き換える
GW_HANBAI-MAXTM = GW_VBAK-ERZET.
ENDIF.

AT END OF AUART.
GW_HANBAI-COUNT = GW_COUNT.
APPEND GW_HANBAI TO GT_HANBAI.
ENDAT.

ENDLOOP.

FREE:GT_VBAK,
GT_VBAP.

* 内部テーブルのソート
SORT GT_HANBAI BY AUART ASCENDING
ERDAT ASCENDING
WERKS ASCENDING
ERNAM ASCENDING
VKGRP ASCENDING
KUNNR ASCENDING
PERNR_VE ASCENDING
PERNR_ZP ASCENDING.

* 伝票タイプのテキスト取得
SELECT AUART
BEZEI
INTO TABLE GT_TVAKT
FROM TVAKT
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_TVAKT BY AUART ASCENDING
BEZEI ASCENDING.

* 営業グループ名称取得
SELECT VKGRP  "営業グループ
BEZEI  "内容説明
INTO TABLE GT_TVGRT
FROM TVGRT
WHERE SPRAS = 'J'.

* 内部テーブルのソート
SORT GT_TVGRT BY VKGRP ASCENDING
BEZEI ASCENDING.


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_KAIKEI_DATA
*&---------------------------------------------------------------------*
*       会計伝票データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_KAIKEI_DATA.

*ADD 2004/10/29  ---->
PERFORM GET_TEXT.              "原価ｾﾝﾀﾃｷｽﾄと利益ｾﾝﾀﾃｷｽﾄの取得
*ADD 2004/10/29  <----

LOOP AT GT_KAIKEI INTO GW_KAIKEI.

CLEAR:
GW_EDIT_TAB,
GW_T001W,GW_CSKT,GW_CEPCT,"←2004/10/29　ADD
GW_T003T.

*   伝票タイプのテキスト読み込み
READ TABLE GT_T003T INTO GW_T003T WITH KEY BLART = GW_KAIKEI-BLART
BINARY SEARCH.
GW_EDIT_TAB-DTYPE = '会計伝票'.                "データ種
GW_EDIT_TAB-AUART = GW_KAIKEI-BLART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_T003T-LTEXT.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE "移動タイプ
*    GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
WRITE GW_KAIKEI-CPUDT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_KAIKEI-WERKS.           "プラント



*ADD 2004/10/29  ---->*
*@プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_KAIKEI-WERKS
BINARY SEARCH.
IF SY-SUBRC = 0.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
ELSE.
*A原価センタ名の読み込み
READ TABLE GT_CSKT INTO GW_CSKT WITH KEY   KOSTL = GW_KAIKEI-KOSTL.
IF SY-SUBRC = 0.
GW_EDIT_TAB-WERKS = GW_KAIKEI-KOSTL.           "プラント
GW_EDIT_TAB-NAME1 = GW_CSKT-KTEXT.           "原価センタテキスト
ELSE.
*B利益センタ名の読み込み
READ TABLE GT_CEPCT INTO GW_CEPCT WITH  KEY  PRCTR = GW_KAIKEI-PRCTR.
IF SY-SUBRC = 0.
GW_EDIT_TAB-WERKS = GW_KAIKEI-PRCTR.       "プラント
GW_EDIT_TAB-NAME1 = GW_CEPCT-KTEXT.        "原価センタテキス・
ENDIF.
ENDIF.
ENDIF.
*ADD 2004/10/29  <----


GW_EDIT_TAB-UNAME = GW_KAIKEI-USNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_KAIKEI-USNAM
GW_EDIT_TAB-NAMET.
*    GW_EDIT_TAB-TCODE "担当者(購買 or 担当グループ)
WRITE GW_KAIKEI-MINTM TO GW_EDIT_TAB-FTIME     "最初データ投入時間
USING EDIT MASK '__:__:__'.
WRITE GW_KAIKEI-MAXTM TO GW_EDIT_TAB-LTIME     "最終データ投入時間
USING EDIT MASK '__:__:__'.
GW_STIME = GW_KAIKEI-MAXTM - GW_KAIKEI-MINTM.  "処理時間
WRITE GW_STIME TO GW_EDIT_TAB-STIME USING EDIT MASK '__:__:__'.
GW_EDIT_TAB-COUNT = GW_KAIKEI-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:GT_KAIKEI.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_NYUSYU_DATA
*&---------------------------------------------------------------------*
*      入出庫伝票データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_NYUSYU_DATA.

LOOP AT GT_NYUSYU INTO GW_NYUSYU.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_T003T.

*   伝票タイプのテキスト読み込み
READ TABLE GT_T003T INTO GW_T003T WITH KEY BLART = GW_NYUSYU-BLART
BINARY SEARCH.

*   移動タイプのテキスト読み込み
READ TABLE GT_T156T INTO GW_T156T WITH KEY BWART = GW_NYUSYU-BWART
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '入出庫伝票'.              "データ種
GW_EDIT_TAB-AUART = GW_NYUSYU-BLART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_T003T-LTEXT.            "テキスト(伝票タイプ)
GW_EDIT_TAB-ITYPE = GW_NYUSYU-BWART.           "移動タイプ
GW_EDIT_TAB-ITEXT = GW_T156T-BTEXT.            "テキスト(移動タイプ)
WRITE GW_NYUSYU-CPUDT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_NYUSYU-WERKS.           "プラント
GW_EDIT_TAB-KUNNR = GW_NYUSYU-KUNNR.           "得意先
GW_EDIT_TAB-LIFNR = GW_NYUSYU-LIFNR.             "仕入先
GW_EDIT_TAB-PERNR_VE = GW_NYUSYU-PERNR_VE.        "営業員
GW_EDIT_TAB-PERNR_ZP = GW_NYUSYU-PERNR_ZP.        "営業アシスタント


*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_NYUSYU-WERKS
BINARY SEARCH.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----


GW_EDIT_TAB-UNAME = GW_NYUSYU-USNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_NYUSYU-USNAM
GW_EDIT_TAB-NAMET.
*    GW_EDIT_TAB-TCODE = "担当者
WRITE GW_NYUSYU-MINTM TO GW_EDIT_TAB-FTIME     "最初データ投入時間
USING EDIT MASK '__:__:__'.
WRITE GW_NYUSYU-MAXTM TO GW_EDIT_TAB-LTIME     "最終データ投入時間
USING EDIT MASK '__:__:__'.
GW_STIME = GW_NYUSYU-MAXTM - GW_NYUSYU-MINTM.  "処理時間
WRITE GW_STIME TO GW_EDIT_TAB-STIME USING EDIT MASK '__:__:__'.
GW_EDIT_TAB-COUNT = GW_NYUSYU-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:GT_NYUSYU.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_SEISYO_DATA
*&---------------------------------------------------------------------*
*      請求書照合データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_SEISYO_DATA.

LOOP AT GT_SEISYO INTO GW_SEISYO.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_T003T.

*   伝票タイプのテキスト読み込み
READ TABLE GT_T003T INTO GW_T003T WITH KEY BLART = GW_SEISYO-BLART
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '請求書照合'.              "データ種
GW_EDIT_TAB-AUART = GW_SEISYO-BLART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_T003T-LTEXT.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE = GW_SEISYO-"移動タイプ
*    GW_EDIT_TAB-ITEXT = GW_SEISYO-"テキスト(移動タイプ)
WRITE GW_SEISYO-CPUDT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_SEISYO-WERKS.           "プラント

*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_SEISYO-WERKS
BINARY SEARCH.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----








GW_EDIT_TAB-UNAME = GW_SEISYO-USNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_SEISYO-USNAM
GW_EDIT_TAB-NAMET.
*    GW_EDIT_TAB-TCODE = GW_SEISYO-"担当者(購買 or 担当グループ)
WRITE GW_SEISYO-MINTM TO GW_EDIT_TAB-FTIME     "最初データ投入時間
USING EDIT MASK '__:__:__'.
WRITE GW_SEISYO-MAXTM TO GW_EDIT_TAB-LTIME     "最終データ投入時間
USING EDIT MASK '__:__:__'.
GW_STIME = GW_SEISYO-MAXTM - GW_SEISYO-MINTM.  "処理時間
WRITE GW_STIME TO GW_EDIT_TAB-STIME USING EDIT MASK '__:__:__'.

GW_EDIT_TAB-COUNT = GW_SEISYO-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:GT_SEISYO.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_KOUBAI_DATA
*&---------------------------------------------------------------------*
*      購買伝票データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_KOUBAI_DATA.

LOOP AT GT_KOUBAI INTO GW_KOUBAI.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_T161T.

*   伝票タイプのテキスト読み込み
READ TABLE GT_T161T INTO GW_T161T WITH KEY BSART = GW_KOUBAI-BSART
BINARY SEARCH.
*   購買グループのテキスト読み込み
READ TABLE GT_T024 INTO GW_T024 WITH KEY EKGRP = GW_KOUBAI-EKGRP
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '購買伝票'.                "データ種
GW_EDIT_TAB-AUART = GW_KOUBAI-BSART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_T161T-BATXT.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE "移動タイプ
*    GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
WRITE GW_KOUBAI-AEDAT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_KOUBAI-WERKS.           "プラント
GW_EDIT_TAB-LIFNR = GW_KOUBAI-LIFNR.           "仕入先
GW_EDIT_TAB-KUNNR = GW_KOUBAI-KUNNR.       "得意先
GW_EDIT_TAB-PERNR_VE = GW_KOUBAI-PERNR_VE.       "営業員
GW_EDIT_TAB-PERNR_ZP = GW_KOUBAI-PERNR_ZP.       "営業員アシスタント

*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_KOUBAI-WERKS
BINARY SEARCH.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----

GW_EDIT_TAB-UNAME = GW_KOUBAI-ERNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_KOUBAI-ERNAM
GW_EDIT_TAB-NAMET.
GW_EDIT_TAB-TCODE = GW_KOUBAI-EKGRP. "担当者(購買 or 担当グループ)
GW_EDIT_TAB-TNAME = GW_T024-EKNAM.             "担当者名称
*    GW_EDIT_TAB-FTIME "最初データ投入時間
*    GW_EDIT_TAB-LTIME "最終データ投入時間
*    GW_EDIT_TAB-STIME "処理時間
GW_EDIT_TAB-COUNT = GW_KOUBAI-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:GT_KOUBAI.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_KOIRAI_DATA
*&---------------------------------------------------------------------*
*      購買依頼データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_KOIRAI_DATA.

LOOP AT GT_KOIRAI INTO GW_KOIRAI.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_T161T.

*   伝票タイプのテキスト読み込み
READ TABLE GT_T161T INTO GW_T161T WITH KEY BSART = GW_KOIRAI-BSART
BINARY SEARCH.
*   購買グループのテキスト読み込み
READ TABLE GT_T024 INTO GW_T024 WITH KEY EKGRP = GW_KOIRAI-EKGRP
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '購買依頼'.                "データ種
GW_EDIT_TAB-AUART = GW_KOIRAI-BSART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_T161T-BATXT.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE "移動タイプ
*    GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
WRITE GW_KOIRAI-ERDAT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_KOIRAI-WERKS.           "プラント

*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_KOIRAI-WERKS
BINARY SEARCH.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----
GW_EDIT_TAB-UNAME = GW_KOIRAI-ERNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_KOIRAI-ERNAM
GW_EDIT_TAB-NAMET.
GW_EDIT_TAB-TCODE = GW_KOIRAI-EKGRP.   "担当者(購買 or 担当グループ)
GW_EDIT_TAB-TNAME = GW_T024-EKNAM.             "担当者名称
*    GW_EDIT_TAB-FTIME "最初データ投入時間
*    GW_EDIT_TAB-LTIME "最終データ投入時間
*    GW_EDIT_TAB-STIME "処理時間
GW_EDIT_TAB-COUNT = GW_KOIRAI-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:GT_KOIRAI.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_SYUKKA_DATA
*&---------------------------------------------------------------------*
*      出荷伝票データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_SYUKKA_DATA.

LOOP AT GT_SYUKKA INTO GW_SYUKKA.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_TVLKT.

*   伝票タイプのテキスト読み込み
READ TABLE GT_TVLKT INTO GW_TVLKT WITH KEY LFART = GW_SYUKKA-LFART
BINARY SEARCH.
*   営業グループのテキスト読み込み
READ TABLE GT_TVGRT INTO GW_TVGRT WITH KEY VKGRP = GW_SYUKKA-VKGRP
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '出荷伝票'.                "データ種
GW_EDIT_TAB-AUART = GW_SYUKKA-LFART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_TVLKT-VTEXT.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE "移動タイプ
*    GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
WRITE GW_SYUKKA-ERDAT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_SYUKKA-WERKS.           "プラント

*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_SYUKKA-WERKS
BINARY SEARCH.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----

GW_EDIT_TAB-KUNNR = GW_SYUKKA-KUNAG.              "得意先
GW_EDIT_TAB-PERNR_VE = GW_SYUKKA-PERNR_VE.              "営業員
GW_EDIT_TAB-PERNR_ZP = GW_SYUKKA-PERNR_ZP.              "営業員アシスタント
GW_EDIT_TAB-UNAME = GW_SYUKKA-ERNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_SYUKKA-ERNAM
GW_EDIT_TAB-NAMET.
GW_EDIT_TAB-TCODE = GW_SYUKKA-VKGRP.   "担当者(購買 or 担当グループ)
GW_EDIT_TAB-TNAME = GW_TVGRT-BEZEI.            "担当者名称
WRITE GW_SYUKKA-MINTM TO GW_EDIT_TAB-FTIME     "最初データ投入時間
USING EDIT MASK '__:__:__'.
WRITE GW_SYUKKA-MAXTM TO GW_EDIT_TAB-LTIME     "最終データ投入時間
USING EDIT MASK '__:__:__'.
GW_STIME = GW_SYUKKA-MAXTM - GW_SYUKKA-MINTM.  "処理時間
WRITE GW_STIME TO GW_EDIT_TAB-STIME USING EDIT MASK '__:__:__'.
GW_EDIT_TAB-COUNT = GW_SYUKKA-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:
GT_SYUKKA.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_SEIKYU_DATA
*&---------------------------------------------------------------------*
*      請求伝票データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_SEIKYU_DATA.

LOOP AT GT_SEIKYU INTO GW_SEIKYU.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_TVFKT.

*   伝票タイプのテキスト読み込み
READ TABLE GT_TVFKT INTO GW_TVFKT WITH KEY FKART = GW_SEIKYU-FKART
BINARY SEARCH.
*   営業グループのテキスト読み込み
READ TABLE GT_TVGRT INTO GW_TVGRT WITH KEY VKGRP = GW_SEIKYU-VKGRP
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '請求伝票'.                "データ種
GW_EDIT_TAB-AUART = GW_SEIKYU-FKART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_TVFKT-VTEXT.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE "移動タイプ
*    GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
WRITE GW_SEIKYU-ERDAT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_SEIKYU-WERKS.           "プラント

*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_SEIKYU-WERKS
BINARY SEARCH.
GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----
GW_EDIT_TAB-UNAME = GW_SEIKYU-ERNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_SEIKYU-ERNAM
GW_EDIT_TAB-NAMET.
GW_EDIT_TAB-TCODE = GW_SEIKYU-VKGRP. "担当者(購買 or 担当グループ)
GW_EDIT_TAB-TNAME = GW_TVGRT-BEZEI.            "担当者名称
WRITE GW_SEIKYU-MINTM TO GW_EDIT_TAB-FTIME     "最初データ投入時間
USING EDIT MASK '__:__:__'.
WRITE GW_SEIKYU-MAXTM TO GW_EDIT_TAB-LTIME     "最終データ投入時間
USING EDIT MASK '__:__:__'.
GW_STIME = GW_SEIKYU-MAXTM - GW_SEIKYU-MINTM.  "処理時間
WRITE GW_STIME TO GW_EDIT_TAB-STIME USING EDIT MASK '__:__:__'.
GW_EDIT_TAB-COUNT = GW_SEIKYU-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:
GT_SEIKYU.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_HANBAI_DATA
*&---------------------------------------------------------------------*
*      販売伝票データ取得処理
*----------------------------------------------------------------------*
FORM EDIT_HANBAI_DATA.

LOOP AT GT_HANBAI INTO GW_HANBAI.

CLEAR:
GW_EDIT_TAB,
GW_T001W,"←2004/10/29　ADD
GW_TVAKT.

*   伝票タイプのテキスト読み込み
READ TABLE GT_TVAKT INTO GW_TVAKT WITH KEY AUART = GW_HANBAI-AUART
BINARY SEARCH.
*   営業グループのテキスト読み込み
READ TABLE GT_TVGRT INTO GW_TVGRT WITH KEY VKGRP = GW_HANBAI-VKGRP
BINARY SEARCH.

GW_EDIT_TAB-DTYPE = '販売伝票'.                "データ種
GW_EDIT_TAB-AUART = GW_HANBAI-AUART.           "伝票タイプ
GW_EDIT_TAB-DTEXT = GW_TVAKT-BEZEI.            "テキスト(伝票タイプ)
*    GW_EDIT_TAB-ITYPE "移動タイプ
*    GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
WRITE GW_HANBAI-ERDAT TO GW_EDIT_TAB-DATUM
USING EDIT MASK '____/__/__'.            "日付(伝票登録日)
GW_EDIT_TAB-WERKS = GW_HANBAI-WERKS.           "プラント
GW_EDIT_TAB-KUNNR = GW_HANBAI-KUNNR.            "得意先
GW_EDIT_TAB-PERNR_VE = GW_HANBAI-PERNR_VE.        "営業員
GW_EDIT_TAB-PERNR_ZP = GW_HANBAI-PERNR_ZP.        "営業アシスタント

*ADD 2004/10/29  ---->
*   プラント名の読み込み
READ TABLE GT_T001W INTO GW_T001W WITH KEY WERKS = GW_HANBAI-WERKS
BINARY SEARCH.

GW_EDIT_TAB-NAME1 = GW_T001W-NAME1.           "プラント
*ADD 2004/10/29  <----

GW_EDIT_TAB-UNAME = GW_HANBAI-ERNAM.           "登録ユーザー
PERFORM GET_ADRVP_DATA USING GW_HANBAI-ERNAM
GW_EDIT_TAB-NAMET.
GW_EDIT_TAB-TCODE = GW_HANBAI-VKGRP.   "担当者(購買 or 担当グループ)
GW_EDIT_TAB-TNAME = GW_TVGRT-BEZEI.            "担当者名称
WRITE GW_HANBAI-MINTM TO GW_EDIT_TAB-FTIME     "最初データ投入時間
USING EDIT MASK '__:__:__'.
WRITE GW_HANBAI-MAXTM TO GW_EDIT_TAB-LTIME     "最終データ投入時間
USING EDIT MASK '__:__:__'.
GW_STIME = GW_HANBAI-MAXTM - GW_HANBAI-MINTM.  "処理時間
WRITE GW_STIME TO GW_EDIT_TAB-STIME USING EDIT MASK '__:__:__'.
GW_EDIT_TAB-COUNT = GW_HANBAI-COUNT.           "対象件数

APPEND GW_EDIT_TAB TO GT_EDIT_TAB.

ENDLOOP.

* 内部テーブルの解放
FREE:
GT_HANBAI.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form  DATA_DOWN_L_PROC
*&---------------------------------------------------------------------*
*       ユーザのテキストを取得する
*----------------------------------------------------------------------*
FORM GET_ADRVP_DATA USING PA_UNAME
PA_NAMET.

DATA:
LW_KEY(30) TYPE C.

CONCATENATE SY-MANDT PA_UNAME INTO LW_KEY .

SELECT SINGLE ADRP~NAME_TEXT
INTO PA_NAMET
FROM ADRP
INNER JOIN ADRVP
ON ADRP~PERSNUMBER = ADRVP~PERSNUMBER
WHERE ADRVP~APPL_KEY = LW_KEY.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form DATA_DOWN_PROC
*&---------------------------------------------------------------------*
*       データ出力処理
*----------------------------------------------------------------------*
FORM DATA_DOWN_PROC.

IF NOT GT_EDIT_TAB[] IS INITIAL.
PERFORM EDIT_TAB_HEADER.
PERFORM CHANGE_CSV_PROC.
IF NOT P_LOCAL IS INITIAL.
PERFORM DATA_OUTPUT_LOCAL.
ELSE.
PERFORM DATA_OUTPUT_SERVE.
ENDIF.
MESSAGE S400 WITH '処理は正常に終了しました。'.
ELSE.
MESSAGE S400 WITH '処理対象データは存在しません。'.
ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form EDIT_TAB_HEADER
*&---------------------------------------------------------------------*
*       ヘッダ作成処理
*----------------------------------------------------------------------*
FORM EDIT_TAB_HEADER.

CONCATENATE 'データ種'
'伝票タイプ'
'テキスト(伝票タイプ)'
'移動タイプ'
'テキスト(移動タイプ)'
'日付(伝票登録日)'
'プラント'
*ADD 2004/10/29 ---->
'プラント名'
*ADD 2004/10/29 <----
*ADD Start　2016/07/23　ISID21 ---->
'仕入先'
'仕入先名称'
'得意先'
'得意先名称'
'営業員名称'
'営業員名称'
'営業員アシスタント'
'営業員アシスタント名称'
*ADD  End 2016/07/23　ISID21 <----
'登録ユーザー'
'登録ユーザー名称'
'担当者'
'担当者名称'
'最初データ投入時間'
'最終データ投入時間'
'処理時間'
'対象データ件数'
INTO GW_OUT_TAB-RECORD
*ADD Start　2016/07/23　ISID21 ---->
*      SEPARATED BY ','.
SEPARATED BY cl_abap_char_utilities=>horizontal_tab.
*ADD  End 2016/07/23　ISID21 <----

APPEND GW_OUT_TAB TO GT_OUT_TAB.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form CHANGE_CSV_PROC
*&---------------------------------------------------------------------*
*       出力データのCSV形式への変換処理
*----------------------------------------------------------------------*
FORM CHANGE_CSV_PROC.

LOOP AT GT_EDIT_TAB INTO GW_EDIT_TAB.

CONCATENATE GW_EDIT_TAB-DTYPE "データ種
GW_EDIT_TAB-AUART "伝票タイプ
GW_EDIT_TAB-DTEXT "テキスト(伝票タイプ)
GW_EDIT_TAB-ITYPE "移動タイプ
GW_EDIT_TAB-ITEXT "テキスト(移動タイプ)
GW_EDIT_TAB-DATUM "日付(伝票登録日)
GW_EDIT_TAB-WERKS "プラント
*ADD 2004/10/29 ---->
GW_EDIT_TAB-NAME1 "プラント名
*ADD 2004/10/29 <----
*ADD Start　2016/07/23　ISID21 ---->
GW_EDIT_TAB-LIFNR         "仕入先
GW_EDIT_TAB-LIFNAME     "仕入先名称
GW_EDIT_TAB-KUNNR      "得意先
GW_EDIT_TAB-KUNNAME  "得意先名称
GW_EDIT_TAB-PERNR_VE "営業員名称
GW_EDIT_TAB-VENAME   "営業員名称
GW_EDIT_TAB-PERNR_ZP "営業員アシスタント
GW_EDIT_TAB-ZPNAME   "営業員アシスタント名称
*ADD  End 2016/07/23　ISID21 <----
GW_EDIT_TAB-UNAME "登録ユーザー
GW_EDIT_TAB-NAMET "登録ユーザ名称
GW_EDIT_TAB-TCODE "担当者(購買 or 担当グループ)
GW_EDIT_TAB-TNAME "担当者名称
GW_EDIT_TAB-FTIME "最初データ投入時間
GW_EDIT_TAB-LTIME "最終データ投入時間
GW_EDIT_TAB-STIME "処理時間
GW_EDIT_TAB-COUNT "対象件数
INTO GW_OUT_TAB-RECORD
*ADD Start　2016/07/23　ISID21 ---->
*      SEPARATED BY ','.
SEPARATED BY cl_abap_char_utilities=>horizontal_tab.
*ADD  End 2016/07/23　ISID21 <----

APPEND GW_OUT_TAB TO GT_OUT_TAB.

ENDLOOP.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form DATA_OUTPUT_LOCAL
*&---------------------------------------------------------------------*
*       ローカルPCへのデータ出力処理
*----------------------------------------------------------------------*
FORM DATA_OUTPUT_LOCAL.

* Del ES-UP 2012/08/14 -->
*  CALL FUNCTION 'WS_DOWNLOAD'
*       EXPORTING
*            FILENAME                = GW_PATH
*            FILETYPE                = 'ASC'
*       TABLES
*            DATA_TAB                = GT_OUT_TAB
*       EXCEPTIONS
*            FILE_OPEN_ERROR         = 1
*            FILE_WRITE_ERROR        = 2
*            INVALID_FILESIZE        = 3
*            INVALID_TYPE            = 4
*            NO_BATCH                = 5
*            UNKNOWN_ERROR           = 6
*            INVALID_TABLE_WIDTH     = 7
*            GUI_REFUSE_FILETRANSFER = 8
*            CUSTOMER_ERROR          = 9
*            OTHERS                  = 10.
*  IF SY-SUBRC <> 0.
*  ENDIF.
DATA: L_CODEPAGE TYPE ABAP_ENCODING,
l_filename type string.

*--- シフトJISのコードページを取得
L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( 'shift_jis' ).
l_filename = GW_PATH.

CL_GUI_FRONTEND_SERVICES=>GUI_DOWNLOAD(
EXPORTING
*    BIN_FILESIZE              = BIN_FILESIZE
FILENAME                  = l_filename
FILETYPE                  = 'ASC'
*    APPEND                    = SPACE
*    WRITE_FIELD_SEPARATOR     = SPACE
*    HEADER                    = '00'
*    TRUNC_TRAILING_BLANKS     = SPACE
*    WRITE_LF                  = 'X'
*    COL_SELECT                = SPACE
*    COL_SELECT_MASK           = SPACE
*    DAT_MODE                  = SPACE
*    CONFIRM_OVERWRITE         = SPACE
*    NO_AUTH_CHECK             = SPACE
CODEPAGE                  = L_CODEPAGE
*     IGNORE_CERR               = ABAP_FALSE
*    REPLACEMENT               = '#'
*    WRITE_BOM                 = SPACE
*    TRUNC_TRAILING_BLANKS_EOL = 'X'
*    WK1_N_FORMAT              = SPACE
*    WK1_N_SIZE                = SPACE
*    WK1_T_FORMAT              = SPACE
*    WK1_T_SIZE                = SPACE
*    SHOW_TRANSFER_STATUS      = 'X'
*    FIELDNAMES                = FIELDNAMES
*    WRITE_LF_AFTER_LAST_LINE  = 'X'
*  IMPORTING
*    FILELENGTH                = FILELENGTH
CHANGING
DATA_TAB                  = GT_OUT_TAB
EXCEPTIONS
FILE_WRITE_ERROR          = 1
NO_BATCH                  = 2
GUI_REFUSE_FILETRANSFER   = 3
INVALID_TYPE              = 4
NO_AUTHORITY              = 5
UNKNOWN_ERROR             = 6
HEADER_NOT_ALLOWED        = 7
SEPARATOR_NOT_ALLOWED     = 8
FILESIZE_NOT_ALLOWED      = 9
HEADER_TOO_LONG           = 10
DP_ERROR_CREATE           = 11
DP_ERROR_SEND             = 12
DP_ERROR_WRITE            = 13
UNKNOWN_DP_ERROR          = 14
ACCESS_DENIED             = 15
DP_OUT_OF_MEMORY          = 16
DISK_FULL                 = 17
DP_TIMEOUT                = 18
FILE_NOT_FOUND            = 19
DATAPROVIDER_EXCEPTION    = 20
CONTROL_FLUSH_ERROR       = 21
NOT_SUPPORTED_BY_GUI      = 22
ERROR_NO_GUI              = 23
OTHERS                    = 24 ).


* Mod ES-UP 2012/08/14 <--
IF SY-SUBRC <> 0.
*     汎用モジュールエラー
* Mod ES-UP 2012/08/14 -->
*      MESSAGE S502(Z1) WITH 'WS_DOWNLOAD' SY-SUBRC.
MESSAGE S502(Z1) WITH 'GUI_DOWNLOAD' SY-SUBRC.
* Mod ES-UP 2012/08/14 <--
STOP.
ENDIF.

* Del ES-UP 2012/08/14 <--


ENDFORM.
*&---------------------------------------------------------------------*
*&      Form DATA_OUTPUT_SERVE
*&---------------------------------------------------------------------*
*       サーバへのデータ出力処理
*----------------------------------------------------------------------*
FORM DATA_OUTPUT_SERVE.

* Add ES-UP 2012/08/14 -->
constants:
CNS_SJIS TYPE STRING VALUE `shift_jis`.
data:
L_CODEPAGE TYPE CPCODEPAGE.

clear: l_codepage.

L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_SJIS ).

* Add ES-UP 2012/08/14 <--
*   ファイルのオープン
* Mod ES-UP 2012/08/13 -->
*  OPEN DATASET GW_PATH FOR OUTPUT IN TEXT MODE.
OPEN DATASET GW_PATH FOR output
IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
IGNORING CONVERSION ERRORS.
* Mod ES-UP 2012/08/13 <--
*   ファイルを指定のフォルダへ作成
LOOP AT GT_OUT_TAB INTO GW_OUT_TAB.
TRANSFER GW_OUT_TAB-RECORD TO GW_PATH.
ENDLOOP.
* ファイルのクローズ
CLOSE DATASET GW_PATH.

ENDFORM.
*&---------------------------------------------------------------------*
*&      Form END_PROC
*&---------------------------------------------------------------------*
*       終了処理
*----------------------------------------------------------------------*
FORM END_PROC.

ENDFORM.
*----------------------------------------------------------------------*
END-OF-SELECTION.
*----------------------------------------------------------------------*
*----------------------------------------------------------------------*
TOP-OF-PAGE.
*----------------------------------------------------------------------
*&---------------------------------------------------------------------*
*&      Form  get_text
*&---------------------------------------------------------------------*
*      利益センタテキスト、原価センタテキストの取得
*----------------------------------------------------------------------*
FORM GET_TEXT.
CLEAR:GT_CSKT,GT_CEPCT.
*CSKＴ原価センタテキスト
SELECT KOSTL KTEXT "原価センタ　一般名称
FROM CSKT
INTO TABLE GT_CSKT
WHERE SPRAS = 'J'
AND KOKRS = 'C001'.
*利益センタテキスト取得
SELECT PRCTR KTEXT "利益センタ 一般名称
FROM CEPCT
INTO TABLE GT_CEPCT
WHERE SPRAS = 'J'
AND KOKRS = 'C001'.

ENDFORM.                    " get_text

*ADD start by ISID21 2006/07/13 ---->
* テキスト編集
FORM EDIT_TEXT_DATA.
DATA:
LTH_KUNNR_NAME TYPE TYP_KUNNR_NAME,    "得意先名称
LTH_LIFNR_NAME TYPE TYP_LIFNR_NAME,     "仕入先名称
LTH_PERNR_NAME TYPE TYP_PERNR_NAME,  "営業員名称
LTD_KUNNR_NAME TYPE TABLE OF TYP_KUNNR_NAME,    "得意先名称
LTD_LIFNR_NAME TYPE TABLE OF TYP_LIFNR_NAME,     "仕入先名称
LTD_PERNR_NAME TYPE TABLE OF TYP_PERNR_NAME,  "営業員名称
LRG_PERNR          TYPE RANGE OF PA0001-PERNR ,     "営業員
LTH_PERNR          LIKE LINE OF LRG_PERNR,
LTD_EDIT_TAB TYPE TABLE OF TYP_EDIT_TAB.   "出力データ編集用BAK


* 得意先名称
LTD_EDIT_TAB[] = GT_EDIT_TAB[].
SORT LTD_EDIT_TAB BY KUNNR.
DELETE ADJACENT DUPLICATES FROM  LTD_EDIT_TAB
COMPARING KUNNR.

SELECT KUNNR NAME1
INTO  TABLE LTD_KUNNR_NAME
FROM KNA1
FOR ALL ENTRIES IN LTD_EDIT_TAB
WHERE KUNNR = LTD_EDIT_TAB-KUNNR.

* 仕入先名称
LTD_EDIT_TAB[] = GT_EDIT_TAB[].
SORT LTD_EDIT_TAB BY LIFNR.
DELETE ADJACENT DUPLICATES FROM  LTD_EDIT_TAB
COMPARING LIFNR.

SELECT LIFNR NAME1
INTO  TABLE LTD_LIFNR_NAME
FROM LFA1
FOR ALL ENTRIES IN LTD_EDIT_TAB
WHERE LIFNR = LTD_EDIT_TAB-LIFNR.

* 営業員名称
LTD_EDIT_TAB[] = GT_EDIT_TAB[].

LOOP AT LTD_EDIT_TAB INTO GW_EDIT_TAB.
*   営業員
LTH_PERNR-LOW = GW_EDIT_TAB-PERNR_VE.
IF LTH_PERNR-LOW IS NOT INITIAL.
LTH_PERNR-SIGN = 'I'.
LTH_PERNR-OPTION = 'EQ'.
APPEND LTH_PERNR TO LRG_PERNR.
ENDIF.

*   営業員アシスタント
LTH_PERNR-LOW = GW_EDIT_TAB-PERNR_ZP.
IF LTH_PERNR-LOW IS NOT INITIAL.
LTH_PERNR-SIGN = 'I'.
LTH_PERNR-OPTION = 'EQ'.
APPEND LTH_PERNR TO LRG_PERNR.
ENDIF.
ENDLOOP.

SORT LRG_PERNR BY SIGN OPTION LOW.
DELETE ADJACENT DUPLICATES FROM LRG_PERNR COMPARING ALL FIELDS.

SELECT PERNR ENAME
INTO TABLE LTD_PERNR_NAME
FROM PA0001
WHERE PERNR IN LRG_PERNR.

* テーブルのテキスト編集
LOOP AT GT_EDIT_TAB INTO GW_EDIT_TAB.
*    得意先名称
IF GW_EDIT_TAB-KUNNR IS NOT INITIAL.
READ TABLE LTD_KUNNR_NAME INTO LTH_KUNNR_NAME
WITH KEY KUNNR = GW_EDIT_TAB-KUNNR.

IF SY-SUBRC = 0.
GW_EDIT_TAB-KUNNAME = LTH_KUNNR_NAME-NAME1.
ENDIF.
ENDIF.

*    仕入先名称
IF GW_EDIT_TAB-LIFNR IS NOT INITIAL.
READ TABLE LTD_LIFNR_NAME INTO LTH_LIFNR_NAME
WITH KEY LIFNR = GW_EDIT_TAB-LIFNR.

IF SY-SUBRC = 0.
GW_EDIT_TAB-LIFNAME = LTH_LIFNR_NAME-NAME1.
ENDIF.
ENDIF.

* 営業員名称
IF GW_EDIT_TAB-PERNR_VE = '00000000'.
CLEAR: GW_EDIT_TAB-PERNR_VE.
ELSE.
READ TABLE LTD_PERNR_NAME INTO LTH_PERNR_NAME
WITH KEY PERNR = GW_EDIT_TAB-PERNR_VE.

IF SY-SUBRC = 0.
GW_EDIT_TAB-VENAME = LTH_PERNR_NAME-ENAME.
ENDIF.
ENDIF.

* 営業員アシスタント
IF GW_EDIT_TAB-PERNR_ZP = '00000000'.
CLEAR: GW_EDIT_TAB-PERNR_ZP.
ELSE.
READ TABLE LTD_PERNR_NAME INTO LTH_PERNR_NAME
WITH KEY PERNR = GW_EDIT_TAB-PERNR_ZP.

IF SY-SUBRC = 0.
GW_EDIT_TAB-ZPNAME = LTH_PERNR_NAME-ENAME.
ENDIF.
ENDIF.

MODIFY GT_EDIT_TAB FROM GW_EDIT_TAB
TRANSPORTING KUNNAME LIFNAME PERNR_VE VENAME PERNR_ZP ZPNAME.
ENDLOOP.

ENDFORM.
*ADD end by ISID21 2006/07/13 ---->
