***********************************************************************
* PG_NAME                       仕入検収照合状況
* PG_ID                         ZK012I00
* MAKE DATE                     2002/10/03
* CODING BY                     K.KAJISA
* 変更履歴
***********************************************************************
REPORT ZK012I00
NO STANDARD PAGE HEADING
LINE-SIZE  170
LINE-COUNT 58
MESSAGE-ID Y1.

TABLES:YK210,YK230,LFA1.
DATA:BEGIN OF I_YK210 OCCURS 0,
LIFNR    LIKE YK210-LIFNR,        "仕入先
WERKS    LIKE YK210-WERKS,        "プラント
KEKKBN   LIKE YK210-KEKKBN,       "結果区分
WAERS    LIKE YK210-WAERS,        "通貨
KNITXAMT LIKE YK210-KNITXAMT,     "税抜金額
KNTAXAMT LIKE YK210-KNTAXAMT,     "税額
KNETXAMT LIKE YK210-KNETXAMT,     "税込額
END OF I_YK210.
DATA:BEGIN OF I_YK230 OCCURS 0,
LIFNR    LIKE YK230-LIFNR,        "仕入先
WERKS    LIKE YK230-WERKS,        "プラント
KEKKBN   LIKE YK230-KEKKBN,       "結果区分
WAERS    LIKE YK230-WAERS,        "通貨
KNITXAMT LIKE YK230-KNITXAMT,     "税抜金額
KNTAXAMT LIKE YK230-KNTAXAMT,     "税額
KNETXAMT LIKE YK230-KNETXAMT,     "税込額
UPYAMT   LIKE YK230-UPYAMT  ,     "未請求
PIDAMT   LIKE YK230-PIDAMT  ,     "消し込み
END OF I_YK230.
DATA:BEGIN OF I_mach oCCURS 0,
LIFNR    LIKE YK230-LIFNR,        "仕入先
WERKS    LIKE YK230-WERKS,        "プラント
KUBUN(4) TYPE C,                  "仕入/請求区分
KEKKBN   LIKE YK230-KEKKBN,       "結果区分
WAERS    LIKE YK210-WAERS,        "通貨
KNITXAMT LIKE YK230-KNITXAMT,     "税抜金額
KNTAXAMT LIKE YK230-KNTAXAMT,     "税額
KNETXAMT LIKE YK230-KNETXAMT,     "税込額
UPYAMT   LIKE YK230-UPYAMT  ,     "未請求
PIDAMT   LIKE YK230-PIDAMT  ,     "税込額
END OF I_mach.
DATA:BEGIN OF I_LFA1 oCCURS 0,
LIFNR    LIKE LFA1-LIFNR,         "仕入先
NAME1    LIKE LFA1-NAME1,         "仕入先名称
END OF I_LFA1.
DATA CNT_REC TYPE P.
************************************************************************
PARAMETERS:P_BUKRS LIKE YK210-BUKRS MEMORY ID BUK.
select-options:S_LIFNR for yk210-lifnr MEMORY ID lif,
S_werks for yk210-werks MEMORY ID wer.
PARAMETERS:P_zfbdt LIKE sy-datum.
select-options:S_kekkbn for yk210-kekkbn.

************************************************************************
START-OF-SELECTION.
PERFORM INIT_PROC.
PERFORM MAIN_PROC.
************************************************************************
TOP-OF-PAGE.
WRITE: /072 '仕入検収照合状況一覧',
143 'Page.', sy-pagno.
WRITE: /143 '作成日時', sy-datum, sy-uzeit.
ULINE.
WRITE:  /1  '仕入先',
55  '仕入'.
WRITE:  /1  'コード',
12  '名称',
46  'プラント',
55  '請求',
61  '照合結果',
76  '税抜金額',
96  '税額',
116  '税込金額',
136  '未照合',
156  '消込額'.
ULINE.
*&---------------------------------------------------------------------*
*&      Form  INIT_PROC
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
FORM INIT_PROC.
CLEAR:I_YK210,I_YK230,i_mach,I_LFA1.
ENDFORM.                    " INIT_PROC
*&---------------------------------------------------------------------*
*&      Form  MAIN_PROC
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
FORM MAIN_PROC.
PERFORM GET_YK210.
PERFORM GET_YK230.
perform mach_date.
PERFORM WRITE_DATA.

ENDFORM.                    " MAIN_PROC

*&---------------------------------------------------------------------*
*&      Form  GET_YK210
*&---------------------------------------------------------------------*
*       請求データ取得
*----------------------------------------------------------------------*
FORM GET_YK210.

SELECT KEKKBN LIFNR WERKS KNITXAMT KNTAXAMT KNETXAMT WAERS
INTO CORRESPONDING FIELDS OF TABLE i_yk210
from YK210 where BUKRS = P_BUKRS
AND LIFNR IN S_LIFNR
AND WERKS IN S_WERKS
AND ZFBDT = p_ZFBDT
*{   INSERT         TEPK900321                                        1
AND DELFLG <> 'X'
*}   INSERT
AND KEKKBN IN S_KEKKBN.

ENDFORM.                    " GET_YK210
*&---------------------------------------------------------------------*
*&      Form  GET_YK230
*&---------------------------------------------------------------------*
*       請求データ取得
*----------------------------------------------------------------------*
FORM GET_YK230.

SELECT
KEKKBN LIFNR WERKS KNITXAMT KNTAXAMT KNETXAMT UPYAMT PIDAMT WAERS
INTO CORRESPONDING FIELDS OF TABLE i_yk230
from YK230 where BUKRS = P_BUKRS
AND LIFNR IN S_LIFNR
AND WERKS IN S_WERKS
AND ZFBDT = p_ZFBDT
AND KEKKBN IN S_KEKKBN.

ENDFORM.                    " GET_YK210
*&---------------------------------------------------------------------*
*&      Form  mach_date
*&---------------------------------------------------------------------*
*       yk210,yk230マッチング
*----------------------------------------------------------------------*
FORM mach_date.
SORT: I_yk210 by LIFNR WERKS KEKKBN WAERS,
I_yk230 by LIFNR WERKS KEKKBN WAERS.

LOOP AT I_yk210.
AT END OF WAERS.
SUM.
MOVE-CORRESPONDING  I_yk210 to I_MACH.
I_MACH-KUBUN = '請求'.
APPEND I_MACH.
ENDAT.
ENDLOOP.
LOOP AT I_yk230.
AT END OF WAERS.
SUM.
MOVE-CORRESPONDING  I_yk230 to I_MACH.
I_MACH-KUBUN = '仕入'.
APPEND I_MACH.
ENDAT.
ENDLOOP.

SORT I_MACH BY LIFNR WERKS KUBUN KEKKBN WAERS.
SELECT LIFNR NAME1  INTO CORRESPONDING FIELDS OF TABLE i_LFA1
FROM LFA1 FOR ALL ENTRIES IN I_MACH
WHERE LIFNR = I_MACH-LIFNR.
SORT I_LFA1 BY LIFNR.
ENDFORM.                    " mach_date
*&---------------------------------------------------------------------*
*&      Form  WRITE_DATA
*&---------------------------------------------------------------------*
*       帳票出力
*----------------------------------------------------------------------*
FORM WRITE_DATA.
DATA:W_SAI TYPE p,
W_KEKKBN(10) TYPE C.
CLEAR CNT_REC.
LOOP AT I_MACH.
CLEAR W_KEKKBN.
CASE I_MACH-KEKKBN.
WHEN '1'.
W_KEKKBN = '未請求'.
WHEN '2'.
W_KEKKBN = '未計上'.
WHEN '3'.
W_KEKKBN = 'アンマッチ'.
WHEN '4'.
W_KEKKBN = '消込済'.
WHEN '5'.
W_KEKKBN = '一部消込'.
WHEN SPACE.
W_KEKKBN = '未処理'.
ENDCASE.
READ TABLE I_LFA1 WITH KEY LIFNR = I_MACH-LIFNR
BINARY search.
WRITE:  /1 I_MACH-LIFNR,
12 I_LFA1-NAME1,
48 I_MACH-WERKS,
55 I_MACH-KUBUN,
*           58 I_MACH-KEKKBN,
61 W_KEKKBN,
71 I_MACH-KNITXAMT CURRENCY  I_MACH-WAERS,
91 I_MACH-KNTAXAMT CURRENCY  I_MACH-WAERS,
111 I_MACH-KNETXAMT CURRENCY  I_MACH-WAERS,
131 I_MACH-UPYAMT   CURRENCY  I_MACH-WAERS,
151 I_MACH-PIDAMT   CURRENCY  I_MACH-WAERS.
CNT_REC = CNT_REC + 1.
ENDLOOP.
ULINE.
WRITE:/1 '出力件数',CNT_REC.
ENDFORM.                    " WRITE_DATA
