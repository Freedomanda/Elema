*&-------------------------------------------------------------------
*& Report  ZM011000
*&-------------------------------------------------------------------
* [プログラム名]
*   ZM011000        期末残高一覧表
* [処理概要]
*　　　期末時点における商品残高の内訳を示す
* [改定履歴]
*　YYYY/MM/DD   Programar         Description
*  2002/04/05   PSD T.SAITOH      新規開発
*  2002/04/09   PSD T.SAITOH      得意先特殊在庫と仕入先特殊在庫の
*                                 期末残高設定ロジック修正
*  2002/05/09   PSD T.SAITOH      会計数値違い明確化文章表示
*  2002/05/15   PSD T.SAITOH      受注在庫数量取得方法変更
*  2002/05/15   PSD T.SAITOH      パフォーマンス対応（第１回）
*  2002/05/17   PSD T.SAITOH      とりあえず複数保管場所考慮
*  2002/05/17   PSD T.SAITOH      とりあえず複数保管場所考慮2
*  2002/05/17   PSD T.SAITOH      とりあえず複数保管場所考慮3
*  2002/06/20   PSD T.SAITOH      再移送
*  2002/07/04   PSD T.SAITOH      会社コード不具合対応
*  2002/07/05   PSD T.SAITOH      パフォーマンス対応
*  2002/09/20   PSD H.HARUKI      処理日付・時間対応
*  2002/09/21   PSD H.HARUKI      購買グループを条件に追加対応
*  2002/10/17   PSD K.ARAI        販売明細番号抽出先にMSKAHを追加
*  2002/10/17   PSD K.ARAI        パフォーマンス対応
*  2002/10/18   PSD K.ARAI        パフォーマンス対応
*  2002/10/20   PSD K.ARAI        販売明細番号データループの不具合修正
*  2002/10/24   PSD K.ARAI        MBEWH & MSKAH データ抽出方法修正
*  2003/07/22   DMC R.Hata        ダウンロード機能追加
*  2008/04/03   DMC S.Shigemitu   期末残高と月末残高の差異を修正
*  2008/06/06   DMC S.KURATA      棚番取得ロジックを修正
*  2009/05/12   DMC R.Hata        金額ゼロのデータの出力を可能に修正
*  2010/02/22   DMK K.Kajisa      数量倍化表示の不具合を修正
*  2010/04/22   DMK K.Kajisa      アドオンテーブルへ出力する処理を追加
*  2012/08/15   ISID              ES-UP
*  2013/05/23   GSL Y.Hayakawa    アドオンテーブルへ出力できない不具合
*                                 修正
*  2013/07/08   GSL S.Tohtake    単価/在庫金額項目を16ケタに変更
*  2014/09/01   ISID11            コードページUTF-8の改修
*  2014/09/26   ISID11            グローバル化の対応
*  2015/02/04   ISID18            コードページの改修
*&-------------------------------------------------------------------
REPORT ZM011000
LINE-SIZE 153
LINE-COUNT 58
NO STANDARD PAGE HEADING.

*--- 定数項目
CONSTANTS:
CNS_MAX_LFMON(2) TYPE N VALUE 16."会計期間の最大値

CONSTANTS:
CNS_T001(4)    TYPE C VALUE 'T001',
CNS_T001K(5)   TYPE C VALUE 'T001K',
CNS_T001W(5)   TYPE C VALUE 'T001W',
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
CNS_T024(4)    TYPE C VALUE 'T024',
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*
CNS_T001L(5)   TYPE C VALUE 'T001L',
CNS_MARA(4)    TYPE C VALUE 'MARA',
CNS_KNA1(4)    TYPE C VALUE 'KNA1',
CNS_LFA1(4)    TYPE C VALUE 'LFA1',
CNS_MAKT(4)    TYPE C VALUE 'MAKT',
CNS_MBEW(4)    TYPE C VALUE 'MBEW',
CNS_MSLB(4)    TYPE C VALUE 'MSLB',
CNS_MARC(4)    TYPE C VALUE 'MARC',
CNS_MSKA(4)    TYPE C VALUE 'MSKA',
CNS_MARD(4)    TYPE C VALUE 'MARD',
CNS_MSKU(4)    TYPE C VALUE 'MSKU',
CNS_MBEWH(5)   TYPE C VALUE 'MBEWH',
CNS_MSLBH(5)   TYPE C VALUE 'MSLBH',
CNS_MARCH(5)   TYPE C VALUE 'MARCH',
CNS_MSKAH(5)   TYPE C VALUE 'MSKAH',
CNS_MARDH(5)   TYPE C VALUE 'MARDH',
CNS_MSKUH(5)   TYPE C VALUE 'MSKUH',
CNS_X          TYPE C VALUE 'X',
CNS_E          TYPE C VALUE 'E',
CNS_O          TYPE C VALUE 'O',
CNS_W          TYPE C VALUE 'W',
CNS_3_MSLB(6)  TYPE C VALUE '3_MSLB',
CNS_4_MARC(6)  TYPE C VALUE '4_MARC',
CNS_1_MSKA(1)  TYPE C VALUE '1',
CNS_1_MARD(1)  TYPE C VALUE '1',
CNS_2_MSKU(6)  TYPE C VALUE '2_MSKU'.
* Add ES-UP 2012/08/15 -->
**** START UPD 2014/09/01 ISID11 ****
*CONSTANTS CNS_SJIS TYPE STRING VALUE `shift_jis`.
CONSTANTS CNS_UTF TYPE STRING VALUE 'UTF-8'.
**** END UPD 2014/09/01 ISID11 ****
* Add ES-UP 2012/08/15 <--
*  構造宣言
TYPES: BEGIN OF TYP_ZM011000,
BUKRS     TYPE T001K-BUKRS,"会社コード
BWKEY     TYPE MBEW-BWKEY, "プラント
MATNR     TYPE MARA-MATNR, "品目コード
* MATERIAL PATTERN
MPTRN(10) TYPE C,          "保管場所種別
LGORT(10) TYPE C,          "保管場所
LFGJA     TYPE MBEW-LFGJA, "会計年度
LFMON     TYPE MBEW-LFMON, "会計期間
MAKTX     TYPE MAKT-MAKTX, "品目名
BUTXT     TYPE T001-BUTXT, "会社名
PNAME     TYPE T001W-NAME1,"プラント名
LNAME(70) TYPE C,          "保管場所名
LGPBE(10) TYPE C,          "棚番
NUM(8)    TYPE P DECIMALS 2,"数量
MEINS     TYPE MARA-MEINS, "単位
UNTCT(8)  TYPE P DECIMALS 2,"単価
**** START UPD 2015/03/24 ISID12 ****
*  SALK3(8)  TYPE P,          "在庫金額
SALK3(8)  TYPE P DECIMALS 2, "在庫金額
**** END UPD 2015/03/24 ISID12 ****
*  LBKUM     TYPE MBEW-LBKUM, "在庫合計
LBKUM     TYPE P DECIMALS 2,"在庫合計
TOTAL(13)  TYPE P,          "総合計
WAERS     TYPE T001-WAERS, "通貨コード
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
EKGRP    TYPE MARC-EKGRP, "購買グループ
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*

END OF TYP_ZM011000.

* DATA宣言（処理用、帳票出力用）
DATA: GT_EXEC  TYPE TABLE OF TYP_ZM011000,"処理用
GF_EXEC  TYPE          TYP_ZM011000,"処理用構造
GF_EXEC_TMP  TYPE TYP_ZM011000,     "現レコード退避用
GF_EXEC_BEF  TYPE TYP_ZM011000.     "前レコード格納用

* 会社コードマスタ構造
TYPES: BEGIN OF TYP_T001,
BUKRS TYPE T001-BUKRS,
BUTXT TYPE T001-BUTXT,
WAERS TYPE T001-WAERS, "通貨コード
END OF TYP_T001.

DATA: GT_T001 TYPE TABLE OF TYP_T001,
GF_T001 TYPE TYP_T001.

* 評価レベルマスタ構造
TYPES: BEGIN OF TYP_T001K,
BWKEY TYPE T001K-BWKEY,
BUKRS TYPE T001K-BUKRS,
END OF TYP_T001K.

DATA: GT_T001K TYPE TABLE OF TYP_T001K,
GF_T001K TYPE TYP_T001K.

* プラントマスタ構造
TYPES: BEGIN OF TYP_T001W,
WERKS TYPE T001W-WERKS,
NAME1 TYPE T001W-NAME1,
END OF TYP_T001W.

DATA: GT_T001W TYPE TABLE OF TYP_T001W,
GF_T001W TYPE TYP_T001W.

* 品目テキスト構造
TYPES: BEGIN OF TYP_MAKT,
MATNR TYPE MAKT-MATNR,
MAKTX TYPE MAKT-MAKTX,
END OF TYP_MAKT.

DATA: GT_MAKT TYPE TABLE OF TYP_MAKT,
GF_MAKT TYPE TYP_MAKT.

* 保管場所構造
TYPES: BEGIN OF TYP_T001L,
WERKS TYPE T001L-WERKS,
LGORT TYPE T001L-LGORT,
LGOBE TYPE T001L-LGOBE,
END OF TYP_T001L.

DATA: GF_T001L TYPE TYP_T001.

* 一般品目データ構造
TYPES: BEGIN OF TYP_MARA,
MATNR TYPE MARA-MATNR,
MEINS TYPE MARA-MEINS,
END OF TYP_MARA.

DATA: GF_MARA TYPE TYP_MARA.

* 得意先マスタ構造
TYPES: BEGIN OF TYP_KNA1,
KUNNR TYPE KNA1-KUNNR,
NAME1 TYPE KNA1-NAME1,
END OF TYP_KNA1.

DATA: GF_KNA1 TYPE TYP_KNA1.

* 仕入先マスタ構造
TYPES: BEGIN OF TYP_LFA1,
LIFNR TYPE LFA1-LIFNR,
NAME1 TYPE LFA1-NAME1,
END OF TYP_LFA1.

DATA: GF_LFA1 TYPE TYP_LFA1.

* 評価在庫構造
TYPES: BEGIN OF TYP_MBEW,
BUKRS TYPE T001-BUKRS,
BWKEY TYPE MBEW-BWKEY,
MATNR TYPE MBEW-MATNR,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
LBKUM TYPE MBEW-LBKUM,
SALK3 TYPE MBEW-SALK3,
VERPR TYPE MBEW-VERPR,
PEINH TYPE MBEW-PEINH,
*---INSERT START   PSD H.HARUKI 2002/09/20 ---------------------------*
EKGRP TYPE MARC-EKGRP,
*---INSERT END     PSD H.HARUKI 2002/09/20 ---------------------------*
END OF TYP_MBEW.

DATA: GT_MBEW TYPE TABLE OF TYP_MBEW,
GF_MBEW TYPE TYP_MBEW,
GT_MBEW_BEF TYPE TABLE OF TYP_MBEW, "前レコード
GF_MBEW_BEF TYPE TYP_MBEW,          "前レコード
GT_MBEW_EXEC TYPE TABLE OF TYP_MBEW,"処理用
GF_MBEW_EXEC TYPE TYP_MBEW.         "処理用

* MARD構造
TYPES: BEGIN OF TYP_MARD,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LGORT TYPE MARD-LGORT,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
LABST TYPE MARD-LABST,"自社在庫：保管場所
**** START ADD 2015/3/24 ISID12 ****
SPEME TYPE MARD-SPEME,"保留在庫
**** END ADD 2015/3/24 ISID12 ****
LGPBE TYPE MARD-LGPBE,"棚番
END OF TYP_MARD.

DATA: GT_MARD TYPE TABLE OF TYP_MARD,
GF_MARD TYPE TYP_MARD.
* ↓実際はグローバル
DATA: LT_MARD TYPE TABLE OF TYP_MARD,"ローカル用内部テーブル
LF_MARD LIKE GF_MARD.

* MSKA構造
TYPES: BEGIN OF TYP_MSKA,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LGORT TYPE MARD-LGORT,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
SOBKZ TYPE MSKA-SOBKZ,"特殊在庫
KALAB TYPE MSKA-KALAB,"自社在庫：受注在庫
END OF TYP_MSKA.

*DATA: GT_MSKA TYPE TABLE OF TYP_MSKA,
DATA: GF_MSKA TYPE TYP_MSKA.
* ↓実際はグローバル
DATA: LT_MSKA TYPE TABLE OF TYP_MSKA,"ローカル用内部テーブル
LF_MSKA LIKE GF_MSKA.

* MSKU構造
TYPES: BEGIN OF TYP_MSKU,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
KUNNR TYPE MSKU-KUNNR,"得意先
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
SOBKZ TYPE MSKU-SOBKZ,"特殊在庫
KULAB TYPE MSKU-KULAB,"預託在庫
END OF TYP_MSKU.

DATA: GT_MSKU TYPE TABLE OF TYP_MSKU,
GF_MSKU TYPE TYP_MSKU.
* ↓実際はグローバル
DATA: LT_MSKU TYPE TABLE OF TYP_MSKU,"ローカル用内部テーブル
LF_MSKU TYPE TYP_MSKU.

* MSLB構造
TYPES: BEGIN OF TYP_MSLB,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LIFNR TYPE MSLB-LIFNR,"仕入先
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
SOBKZ TYPE MSLB-SOBKZ,"特殊在庫
LBLAB TYPE MSLB-LBLAB,"支給在庫
END OF TYP_MSLB.

DATA: GT_MSLB TYPE TABLE OF TYP_MSLB,
GF_MSLB TYPE TYP_MSLB.
* ↓実際はグローバル
DATA: LT_MSLB TYPE TABLE OF TYP_MSLB,"ローカル用内部テーブル
LF_MSLB LIKE GF_MSLB.

* MARC構造
TYPES: BEGIN OF TYP_MARC,
BUKRS TYPE T001-BUKRS,
WERKS TYPE MARD-WERKS,
MATNR TYPE MARD-MATNR,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
TRAME TYPE MARC-TRAME, "転送中在庫
END OF TYP_MARC.

DATA: GT_MARC TYPE TABLE OF TYP_MARC,
GF_MARC TYPE TYP_MARC.
DATA: LT_MARC TYPE TABLE OF TYP_MARC,"ローカル用内部テーブル
LF_MARC LIKE GF_MARC.

DATA: GW_NUM(8)    TYPE P DECIMALS 2,     "作業用自社在庫数量
GW_LGPBE(10) TYPE C,                "作業用棚番
**** END UPD 2015/3/24 ISID12 ****
*      GW_TOTAL(10) TYPE P,                "作業用総合計
GW_TOTAL(10) TYPE P DECIMALS 2.     "作業用総合計
**** END UPD 2015/3/24 ISID12 ****

*--- このフラグは保管場所種別が１の時のみ作用する。
*---DELETE START PSD T.SAITOH 2002/05/17 ---------------------------*
*DATA: FLG_LGORT_BREAK TYPE C.  "保管場所種別／保管場所ブレイク
*---DELETE END   PSD T.SAITOH 2002/05/17 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
DATA: GF_LIFNR_TMP  TYPE TYP_LFA1,    "仕入先テンポラリ
GF_KUNNR_TMP  TYPE TYP_KNA1.    "得意先テンポラリ
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
* MSKA(H)を統合　ＤＢの内容すべて格納する内部ＴＢＬ
TYPES: BEGIN OF TYP_MSKA_HS,
MATNR TYPE MARD-MATNR,
WERKS TYPE MARD-WERKS,
LGORT TYPE MARD-LGORT,
SOBKZ TYPE MSKA-SOBKZ,"特殊在庫
VBELN TYPE MSKA-VBELN,
POSNR TYPE MSKA-POSNR,
LFGJA TYPE MBEW-LFGJA,
LFMON TYPE MBEW-LFMON,
KALAB TYPE MSKA-KALAB,"自社在庫：受注在庫
END OF TYP_MSKA_HS.

DATA: GT_MSKA_DB TYPE HASHED TABLE OF TYP_MSKA_HS
WITH UNIQUE KEY MATNR
WERKS
LGORT
SOBKZ
VBELN
POSNR
LFGJA
LFMON,
GF_MSKA_DB TYPE TYP_MSKA_HS.
* 伝票番号専用MSKA(H)型
*  TYPES: BEGIN OF TYP_MSKA_NUMBERS,
*    VBELN TYPE MSKA-VBELN,
*    POSNR TYPE MSKA-POSNR,
*    LGORT TYPE MARD-LGORT,
*  END OF TYP_MSKA_NUMBERS.
* 伝票番号専用MSKA(H)テーブル
DATA: GT_MSKA_NUMBERS TYPE TABLE OF TYP_MSKA_HS,
GF_MSKA_NUMBERS TYPE TYP_MSKA_HS.

*---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
* 複数保管場所対応（念のため）業務上はありえないが
* システム的にはありえるため
* 複数保管場所時品目名称非表示対応
DATA: G_FLG_MATNR TYPE C."品目コード
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*
*---INSERT START   PSD H.HARUKI 2002/09/20 ---------------------------*
*  購買グループ　格納
DATA: G_SAVE_EKGRP TYPE MARC-EKGRP .
*---INSERT END     PSD H.HARUKI 2002/09/20 ---------------------------*
*---INSERT START  NDSC R.HATA   2002/11/18 ---------------------------*
DATA : W_BUPER LIKE T009B-POPER ,
W_GJAHR LIKE T009B-BDATJ .
*---INSERT END    NDSC R.HATA   2002/11/18 ---------------------------*
**** START ADD 2015/02/04 ISID18 ****
DATA:
G_OUTPUT_CP  TYPE ZTEGZZM001-Z_OUTPUT_CP,
G_FLGUTF8    TYPE FLAG.
**** END ADD 2015/02/04 ISID18 ****

* Add 2003/07/22 Hata >>>
* Mod 2003/11/05 Hata >>>
TYPES : BEGIN OF TYP_DL ,
*          bukrs(04) Type C ,         "会社コード
*          bwkey(04) Type C ,         "プラント
*          matnr(18) Type C ,         "品目コード
*          mptrn(10) Type C ,         "保管場所種別
*          lgort(10) Type C ,         "保管場所
*          lfgja(04) Type C ,         "会計年度
*          lfmon(02) Type C ,         "会計期間
*          maktx(35) Type C ,         "品目名
*          butxt(25) Type C ,         "会社名
*          pname(30) Type C ,         "プラント名
*          lname(70) Type C ,         "保管場所名
*          lgpbe(10) Type C ,         "棚番
*          num(8)    Type C ,         "数量
*          meins(03) Type C ,         "単位
*          untct(08) Type C ,         "単価
*          salk3(08) Type C ,         "在庫金額
*          lbkum(16) Type C ,         "在庫合計
*          total(13) Type C ,         "総合計
*          waers(03) Type C ,         "通貨コード
*          ekgrp(04) Type C ,         "購買グループ
EKGRP(04) TYPE C ,         "購買グループ
MATNR(18) TYPE C ,         "品目コード
MAKTX(35) TYPE C ,         "品目名
GOKEI(04) TYPE C ,         "合計
LGPBE(10) TYPE C ,         "棚番
LBKUM(16) TYPE C ,         "在庫合計
MEINS(03) TYPE C ,         "単位
*---UPD START   GSL S.TOHTAKE 2013/07/08 ---------------------------*
*          UNTCT(08) TYPE C ,         "単価
*          SALK3(08) TYPE C ,         "在庫金額
UNTCT(16) TYPE C ,         "単価
SALK3(16) TYPE C ,         "在庫金額
*---UPD END     GSL S.TOHTAKE 2013/07/08 ---------------------------*
* Mod 2003/11/05 Hata <<<
END OF TYP_DL .

DATA : GT_DL TYPE TABLE OF TYP_DL ,
GF_DL TYPE TYP_DL .

* Add 2003/07/22 Hata <<<
**** START ADD 2014/09/26 ISID11 ****
DATA : GT_RNG_WERKS   TYPE RANGE_T_WERKS.  "プラント
**** END ADD 2014/09/26 ISID11 ****

*2008/06/06 ADD START
DATA : W_LGPBE TYPE MARD-LGPBE.      "棚番
*2008/06/06 ADD END

*---INSERT START   DMK K.KAJISA 2010/04/22 ---------------------------*
*--アドオンテーブル出力用内部テーブル作成
DATA:GT_ZM0010 TYPE STANDARD TABLE OF ZM0010,
GF_ZM0010 TYPE ZM0010.
*---INSERT END     DMK K.KAJISA 2010/04/22 ---------------------------*

* 選択画面 *----------------------------------------------------*
*SELECTION-SCREEN BEGIN OF LINE.
*SELECTION-SCREEN COMMENT 1(8)  TEXT-001.
PARAMETERS: PR_LFGJA   TYPE  MBEW-LFGJA OBLIGATORY.
*SELECTION-SCREEN COMMENT 16(4) TEXT-002.
PARAMETERS: PR_LFMON   TYPE  MBEW-LFMON OBLIGATORY.
*SELECTION-SCREEN COMMENT 30(4) TEXT-003.
*SELECTION-SCREEN END   OF LINE.

*---MODIFY START PSD T.SAITOH 2002/07/04 ---------------------------*
*SELECT-OPTIONS:S_BUKRS FOR GF_T001-BUKRS  MEMORY ID BUK OBLIGATORY.
PARAMETERS:PR_BUKRS TYPE T001-BUKRS
**** START DEL 2014/09/26 ISID11 ****
*MEMORY ID BUK
**** END DEL 2014/09/26 ISID11 ****
OBLIGATORY.
*---MODIFY END   PSD T.SAITOH 2002/07/04 ---------------------------*
SELECT-OPTIONS:S_WERKS FOR GF_T001W-WERKS MEMORY ID WRK OBLIGATORY.
*---INSERT START   PSD H.HARUKI 2002/09/20 ---------------------------*
SELECT-OPTIONS:S_EKGRP FOR G_SAVE_EKGRP MEMORY ID EKG .
*---INSERT END     PSD H.HARUKI 2002/09/20 ---------------------------*

*Add 2008.10.17 --->
SELECT-OPTIONS:S_MATNR FOR GF_MARD-MATNR .
*Add 2008.10.17 <---


* オプション設定
SELECTION-SCREEN BEGIN OF BLOCK BKOP
WITH FRAME TITLE TEXT-070.
PARAMETERS: PR_PAGE AS CHECKBOX."ページ表示
PARAMETERS: PR_COLR AS CHECKBOX."色表示
SELECTION-SCREEN END   OF BLOCK BKOP.

* Add 2003/07/22 Hata >>>
**** START UPD 2014/09/26 ISID11 ****
*SELECTION-SCREEN BEGIN OF BLOCK DOWN WITH FRAME TITLE TEXT-036.
SELECTION-SCREEN BEGIN OF BLOCK DOWN WITH FRAME.
**** END UPD 2014/09/26 ISID11 ****
PARAMETERS: R_NOT       RADIOBUTTON GROUP R1,
R_DOWN      RADIOBUTTON GROUP R1,
*---INSERT START   DMK K.KAJISA 2010/04/22 ---------------------------*
*-- アドオンテーブルに格納するラジオボタン追加
R_DB        RADIOBUTTON GROUP R1 ,
*---INSERT END     DMK K.KAJISA 2010/04/22 ---------------------------*
P_FILE      LIKE RLGRAP-FILENAME
DEFAULT 'C:\TEST.CSV'.
* Add 2003.09.02 >>>>>
SELECTION-SCREEN BEGIN OF BLOCK DOWN2 WITH FRAME .
PARAMETERS : P_LOCAL  RADIOBUTTON GROUP R2 ,
P_SERVE  RADIOBUTTON GROUP R2 .

SELECTION-SCREEN END   OF BLOCK DOWN2.
* Add 2003.09.02 <<<<<
SELECTION-SCREEN END   OF BLOCK DOWN.

*---------------------------------------------------------------------
AT SELECTION-SCREEN ON BLOCK DOWN.
*---------------------------------------------------------------------
*--- 入力ファイルのチェック
IF R_DOWN = 'X'.
IF P_FILE IS INITIAL.
* ファイルパスを指定してください
MESSAGE E855(Z1).
ENDIF.
ENDIF.

*---------------------------------------------------------------------
AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_FILE.
*---------------------------------------------------------------------
*--- ファイル名呼び出し
PERFORM FRM_CHK_FILE.

* Add 2003/07/22 Hata <<<
*--------------------------------------------------------------*
*--------------------------------------------------------------*
* INITIALIZATION
*--------------------------------------------------------------*
INITIALIZATION.
**** START ADD 2014/09/26 ISID11 ****
GET PARAMETER ID 'BUK' FIELD PR_BUKRS.
**** END ADD 2014/09/26 ISID11 ****
* 指定計上年月→会計期間に変換

PERFORM FRM_CHANGE_CLTOFI USING    SY-DATUM+0(4)
SY-DATUM+4(2)
CHANGING PR_LFGJA
PR_LFMON.

*---------------------------------------------------------------------
* at selection-screen
*---------------------------------------------------------------------
AT SELECTION-SCREEN.
IF SY-UCOMM+0(1) <> '%'.
PERFORM FRM_CHECK_YEAR USING PR_LFGJA.
PERFORM FRM_CHECK_MON  USING PR_LFMON.
PERFORM FRM_CHECK_BUKRS.
PERFORM FRM_CHECK_WERKS.
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
PERFORM FRM_CHECK_EKGRP.
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*
ENDIF.

*---------------------------------------------------------------------
* TOP-OF-PAGE
*---------------------------------------------------------------------
TOP-OF-PAGE.

PERFORM FRM_TOP_OF_PAGE.

*&---------------------------------------------------------------------*
*&      Form  FRM_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*       改ページ処理
*----------------------------------------------------------------------*
FORM FRM_TOP_OF_PAGE.
**** START ADD 2014/09/26 ISID11 ****
DATA:
lf_dummy  TYPE string.
**** END ADD 2014/09/26 ISID11 ****
* 色設定
*  IF PR_COLR = CNS_X.
*   MAIN HEADER
WRITE:/70(18) TEXT-100.         "帳票タイトル
WRITE :
**** START UPD 2014/09/26 ISID11 ****
*          114 '処理日付' ,
*               SY-DATUM ,
*          137 '処理時刻' ,
*               SY-UZEIT .
114 TEXT-102 ,
SY-DATLO ,
137 TEXT-103 ,
SY-TIMLO .
**** END UPD 2014/09/26 ISID11 ****

*   PAGE DISPLAY ON
*  ENDIF.
IF PR_PAGE = CNS_X.
WRITE:/145(2) SY-PAGNO,         "ページ数
148(6) TEXT-069.         "ページ（テキスト）
ENDIF.
WRITE:/01(10) TEXT-050,         "会社コード（テキスト）
12(4)  GF_EXEC_TMP-BUKRS,"会社コード
18(25) GF_EXEC_TMP-BUTXT,"会社名
46(8)  TEXT-051,         "プラント（テキスト）
56(4)  GF_EXEC_TMP-BWKEY,"プラント
62(30) GF_EXEC_TMP-PNAME,"プラント名
**** START ADD 2015/3/24 ISID12 ****
94(6)  TEXT-105,         "通貨（テキスト）
100(5)  GF_EXEC_TMP-WAERS,"通貨
**** END ADD 2015/3/24 ISID12 ****
127(8) TEXT-052,         "会計期間（テキスト）
136(4) PR_LFGJA,         "会計年度
141(4) TEXT-053,         "年度（テキスト）
147(2) PR_LFMON,         "期間
150(4) TEXT-054.         "期間（テキスト）
* UNDER LINE
WRITE:  /1(10) TEXT-066,"－――――
46(8)  TEXT-067,"――――
**** START ADD 2015/3/24 ISID12 ****
94(6)   TEXT-106,"――――
**** END ADD 2015/3/24 ISID12 ****
127(8)  TEXT-067,"――――
141(4)  TEXT-068,"――
150(4)  TEXT-068."――

*---APPEND START PSD T.SAITOH 2002/05/09 ---------------------------*
*    会計数値違い明確化文章
**** START UPD 2014/09/26 ISID11 ****
*  WRITE: /0 TEXT-072.
CLEAR lf_dummy.
MESSAGE s141(Z3) INTO lf_dummy.
WRITE: /0 lf_dummy.
**** END UPD 2014/09/26 ISID11 ****
*---APPEND END   PSD T.SAITOH 2002/05/09 ---------------------------*

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (BLUE)
FORMAT COLOR COL_HEADING ON INTENSIFIED.
* ITEM HEADER （テキスト）
ENDIF.
*  WRITE: /01(10) TEXT-055,"品目コード
*          21(6)  TEXT-056,"品目名
*          53(8)  TEXT-057,"保管場所
*          65(10) TEXT-058,"保管場所名
*          87(4)  TEXT-059,"棚番
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
WRITE: /01(06) TEXT-091,"購買グループ
08(10) TEXT-055,"品目コード
28(6)  TEXT-056,"品目名
60(8)  TEXT-057,"保管場所
72(10) TEXT-058,"保管場所名
93(4)  TEXT-059,"棚番
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
99(4)  TEXT-060,"数量
114(4)  TEXT-061,"単位
120(4)  TEXT-062,"単価
136(8)  TEXT-063,"在庫金額
153(1)  SPACE,   "スペース
/01(153) SY-ULINE."下線
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SETING BLUE
FORMAT COLOR OFF.
ENDIF.

ENDFORM.                    " FRM_TOP_OF_PAGE
*---------------------------------------------------------------------
* START-OF-SELECTION
*---------------------------------------------------------------------
START-OF-SELECTION.
* 初期処理
PERFORM PERIOD_GET .
PERFORM FRM_SELECT_T001K.
PERFORM FRM_SELECT_T001.
PERFORM FRM_SELECT_T001W.
* 抽出処理
PERFORM FRM_EXTRACTION_MBEW.
* 各在庫のデータ選定
PERFORM FRM_EXTRACTIONS.
* 集計処理&帳票出力
PERFORM FRM_COMPUTE.
**** START ADD 2015/02/04 ISID18 ****
* コードページ取得処理
PERFORM FRM_GET_CPAGE.
**** END ADD 2015/02/04 ISID18 ****

* ↓APPEND 2003/07/22 DMC K.MURATA
IF R_DOWN = 'X'.
*--- CHAR型に編集
PERFORM FRM_CHAR_EDIT.
* Mod 2003.09.02 >>>>>
IF P_LOCAL EQ 'X' .
*--- CSVファイルをダウンロード
PERFORM FRM_DATA_DL.
ELSE .
PERFORM FRM_DATA_TRANSFER .
ENDIF .
* Mod 2003.09.02 <<<<<
ENDIF.
* ↑

*---INSERT START   DMK K.KAJISA 2010/04/22 ---------------------------*
*-- 選択画面でアドオンテーブルへの格納を指定した場合、
*   選択画面で指定されたキー項目でアドオンテーブルを削除し、
*   今回出力するリストデータを新規に登録する（洗いがえ）
IF R_DB = 'X'.
PERFORM FRM_DELETE_ZM0010.  "アドオンテーブル削除
PERFORM FRM_INSERT_ZM0010.  "アドオンテーブル新規登録
ENDIF.
*---INSERT END     DMK K.KAJISA 2010/04/22 ---------------------------*

*&---------------------------------------------------------------------*
*&      Form  FRM_extraction_MBEW
*&---------------------------------------------------------------------*
*       MBEW 品目評価：抽出処理
*----------------------------------------------------------------------*
FORM  FRM_EXTRACTION_MBEW.
DATA:L_CNT_MBEW TYPE I."MBEW取得件数
* 抽出
PERFORM FRM_SELECT_MBEW.
PERFORM FRM_SELECT_MBEWH.

* 取得件数
DESCRIBE TABLE GT_MBEW LINES L_CNT_MBEW.
IF L_CNT_MBEW = 0.
MESSAGE S616(Z1).
STOP.
ENDIF.

*---APPEND START PSD T.SAITOH 2002/07/04 ---------------------------*
* 対象外プラントを削除する
DELETE GT_MBEW WHERE BUKRS <> PR_BUKRS.
*---APPEND END   PSD T.SAITOH 2002/07/04 ---------------------------*

* 会社コード／プラント／品目コードを昇順
* 会計年度／会計期間を降順　ソート
SORT GT_MBEW  BY BUKRS ASCENDING
BWKEY ASCENDING
*---INSERT START   PSD H.HARUKI 2002/09/20 ---------------------------*
EKGRP ASCENDING
*---INSERT END     PSD H.HARUKI 2002/09/20 ---------------------------*
MATNR ASCENDING
LFGJA DESCENDING
LFMON DESCENDING.

CLEAR: GF_MBEW_BEF.
* 当月末在庫に該当するレコード特定処理ループ
LOOP AT GT_MBEW INTO GF_MBEW.
*   在庫合計金額が０のものは対象外とする
*---DELETE START DMC R.HATA   2009/05/12 ---------------------------*
*-- 在庫合計金額が０のものは処理対象とする。
*    IF GF_MBEW-SALK3 <= 0.
*---DELETE END   DMC R.HATA   2009/05/12 ---------------------------*
*---APPEND START DMC R.HATA   2009/05/12 ---------------------------*
*-- 評価在庫数合計がゼロ以下のものは対象外とする
IF GF_MBEW-LBKUM <= 0.
*---APPEND END   DMC R.HATA   2009/05/12 ---------------------------*
*     現レコードを前レコードをとして格納
GF_MBEW_BEF = GF_MBEW.
CONTINUE.
ENDIF.
*   会社コード／プラント／品目コード  ブレイクごとに処理
IF NOT ( GF_MBEW-BUKRS  = GF_MBEW_BEF-BUKRS  AND
GF_MBEW-BWKEY  = GF_MBEW_BEF-BWKEY  AND
GF_MBEW-MATNR  = GF_MBEW_BEF-MATNR ).
*     当月末在庫に該当するレコード検索
PERFORM FRM_SPECIFIC_MBEW.
ENDIF.
*   現レコードを前レコードをとして格納
GF_MBEW_BEF = GF_MBEW.
ENDLOOP.
ENDFORM.                    "FRM_EXTRACTION_MBEW
*&---------------------------------------------------------------------*
*&      Form  FRM_CHANGE_CLTOFI
*&---------------------------------------------------------------------*
*       カレンダー年月→会計年月　変換処理
*----------------------------------------------------------------------*
*  -->  p1        カレンダー年
*  <--  p2        カレンダー月
*----------------------------------------------------------------------*
FORM FRM_CHANGE_CLTOFI USING VALUE(PR_YEAR)
VALUE(PR_MON)
CHANGING PR_FI_YEAR
PR_FI_MON.
*--- カレンダー月の判断（１～３）
IF PR_MON >= 1 AND PR_MON <= 3.
PR_FI_YEAR = PR_YEAR - 1.
PR_FI_MON  = PR_MON + 9.
*--- カレンダー月の判断（４～１２）
ELSEIF PR_MON >= 4 AND PR_MON <= 12.
PR_FI_YEAR = PR_YEAR.
PR_FI_MON  = PR_MON - 3.
ELSE.
*--- カレンダー月（例外処理）
ENDIF.

ENDFORM.                    " FRM_CHANGE_CLTOFI
*&===入力チェック======================================================*
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_YEAR
*&---------------------------------------------------------------------*
*       入力チェック：年度
*----------------------------------------------------------------------*
FORM FRM_CHECK_YEAR USING P_YEAR.
* --- 年度に０が入力された場合
IF P_YEAR = 0.
*   "会計年度に[0]は指定できません
MESSAGE S601(Z1) WITH TEXT-002
TEXT-004.
STOP.
ENDIF.
ENDFORM.                    " FRM_CHECK_YEAR
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_MON
*&---------------------------------------------------------------------*
*       入力チェック：月
*----------------------------------------------------------------------*
FORM FRM_CHECK_MON USING P_MON.
* ---期間が０の時
IF P_MON = 0.
*   "会計期間に[0]は指定できません
MESSAGE E601(Z1) WITH TEXT-003
TEXT-004.
STOP.
ENDIF.
* ---期間が範囲外の時
IF NOT ( P_MON >= 1 AND P_MON <= CNS_MAX_LFMON ).
*   "会計期間には１～１２を指定してください。
MESSAGE E700(Z1) WITH TEXT-003
TEXT-005.
STOP.
ENDIF.
ENDFORM.                    " FRM_CHECK_MON

*&---------------------------------------------------------------------*
*&      CHECK_BUKRS
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_BUKRS
*&---------------------------------------------------------------------*
*       会社コード存在チェック
*----------------------------------------------------------------------*
FORM FRM_CHECK_BUKRS.
DATA:LT_DUMMY TYPE TABLE OF TYP_T001.

SELECT BUKRS
FROM T001
INTO CORRESPONDING FIELDS OF TABLE LT_DUMMY
WHERE BUKRS =  PR_BUKRS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE E606(Z1) WITH TEXT-006.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001 SY-SUBRC.
ENDCASE.

**** START ADD 2014/09/26 ISID11 ****
* 選択画面の会社コードの権限チェックを行う
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD PR_BUKRS          "対象会社コード
ID 'ACTVT' FIELD '03'.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'PR_BUKRS'.
MESSAGE E015(Z3) WITH PR_BUKRS.
*   会社コード & では実行する権限がありません。
ENDIF.
**** END ADD 2014/09/26 ISID11 ****

ENDFORM.                    "FRM_CHECK_BUKRS
*&---------------------------------------------------------------------*
*&      CHECK_WERKS
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_WERKS
*&---------------------------------------------------------------------*
*       プラントコード存在チェック
*----------------------------------------------------------------------*
FORM FRM_CHECK_WERKS.
DATA:
**** START ADD 2014/09/26 ISID11 ****
LT_RNG_WERKS TYPE RANGE_T_WERKS,
**** END ADD 2014/09/26 ISID11 ****
LT_DUMMY TYPE TABLE OF TYP_T001W.

SELECT WERKS
FROM T001W
INTO CORRESPONDING FIELDS OF TABLE LT_DUMMY
WHERE WERKS IN S_WERKS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE E606(Z1) WITH TEXT-007.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001W SY-SUBRC.
ENDCASE.

**** START ADD 2014/09/26 ISID11 ****
CLEAR LT_RNG_WERKS.
LT_RNG_WERKS = S_WERKS[].
* プラントチェック
CALL FUNCTION 'ZEG_ZZ_WERKS_CHK'
EXPORTING
IMPBUKRS           = PR_BUKRS
IMPRNGWERKS        = LT_RNG_WERKS
IMPORTING
EXPWERKS           = GT_RNG_WERKS
EXCEPTIONS
WERKS_NOT_EXIST    = 1
WERKS_NO_AUTHORITY = 2
WERKS_BUKRS_ERROR  = 3
OTHERS             = 4.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'PR_BUKRS' .
MESSAGE ID SY-MSGID TYPE 'E'  NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
**** END ADD 2014/09/26 ISID11 ****

ENDFORM.                    "FRM_CHECK_WERKS

*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*

*&---------------------------------------------------------------------*
*&      CHECK_EKGRP
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_EKGRP
*&---------------------------------------------------------------------*
*       購買グループ存在チェック
*----------------------------------------------------------------------*
FORM FRM_CHECK_EKGRP.
DATA:LT_DUMMY TYPE  TABLE OF TYP_MARC.

SELECT EKGRP
FROM T024
INTO CORRESPONDING FIELDS OF TABLE LT_DUMMY
WHERE EKGRP IN S_EKGRP.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE E606(Z1) WITH TEXT-092.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T024 SY-SUBRC.
ENDCASE.

ENDFORM.                    "FRM_CHECK_EKGRP
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*

*&---------------------------------------------------------------------*
*&      SELECT NUMBER 01
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_T001K
*&---------------------------------------------------------------------*
*       プラントコードから会社コードを取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_T001K.

SELECT BWKEY
BUKRS
FROM T001K
INTO CORRESPONDING FIELDS OF TABLE GT_T001K
WHERE
**** START UPD 2014/09/26 ISID11 ****
*    BWKEY IN S_WERKS.
BWKEY IN GT_RNG_WERKS.
**** END UPD 2014/09/26 ISID11 ****

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001K SY-SUBRC.
ENDCASE.

ENDFORM.                    "FRM_SELECT_T001K
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 02
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_T001
*&---------------------------------------------------------------------*
*       会社コードから会社名を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_T001.

SELECT BUKRS
BUTXT
WAERS
FROM T001
INTO CORRESPONDING FIELDS OF TABLE GT_T001
WHERE BUKRS =  PR_BUKRS.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001 SY-SUBRC.
ENDCASE.

ENDFORM.                    "FRM_SELECT_T001
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 03
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_T001W
*&---------------------------------------------------------------------*
*       プラントコードからプラント名を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_T001W.

SELECT WERKS
NAME1
FROM T001W
INTO CORRESPONDING FIELDS OF TABLE GT_T001W
WHERE
**** START UPD 2014/09/26 ISID11 ****
*          WERKS IN S_WERKS.
WERKS IN GT_RNG_WERKS.
**** END UPD 2014/09/26 ISID11 ****

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001W SY-SUBRC.
ENDCASE.

ENDFORM.                    "FRM_SELECT_T001W
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 04
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MBEW
*&---------------------------------------------------------------------*
*       評価在庫情報を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_MBEW.

SELECT BWKEY "プラント
MATNR "品目コード
LFGJA "会計年度
LFMON "会計期間
LBKUM "在庫合計数量
SALK3 "在庫合計金額
VERPR "移動平均原価
PEINH "価格単位
FROM MBEW
INTO CORRESPONDING FIELDS OF GF_MBEW
WHERE
**** START UPD 2014/09/26 ISID11 ****
*        BWKEY IN S_WERKS
BWKEY IN GT_RNG_WERKS
**** END UPD 2014/09/26 ISID11 ****
AND ( LFGJA <  PR_LFGJA
OR   (
LFGJA = PR_LFGJA AND
LFMON <= PR_LFMON
)
)
*Add 2008.10.17 --->
AND MATNR IN S_MATNR
*Add 2008.10.17 <---
*---APPEND START PSD T.SAITOH 2002/07/05 ---------------------------*
*---DELETE START PSD K.ARAI   2002/10/24 ---------------------------*
*---Modify START DMC R.HATA   2009/05/12 ---------------------------*
*-- 評価在庫合計額がゼロ以下でも処理対象にする
AND ( SALK3 > 0
OR  LBKUM > 0 ) .
*---Modify END   DMC R.HATA   2009/05/12 ---------------------------*
*---DELETE END   PSD K.ARAI   2002/10/24 ---------------------------*
*---APPEND END   PSD T.SAITOH 2002/07/05 ---------------------------*

*   会社コードを埋め込む
READ TABLE GT_T001K INTO GF_T001K
WITH KEY BWKEY = GF_MBEW-BWKEY.
GF_MBEW-BUKRS = GF_T001K-BUKRS.

*---MODIFY START   PSD H.HARUKI 2002/09/20 ---------------------------*
*   購買グループが入力範囲内の時　埋め込み　&　内部ＴＢＬに　APPEND

PERFORM EKGRP_GET .
IF SY-SUBRC = 0 .
GF_MBEW-EKGRP = G_SAVE_EKGRP.
APPEND GF_MBEW TO GT_MBEW.
ENDIF .
*      APPEND gf_mbew TO gt_mbew.

*---MODIFY END     PSD H.HARUKI 2002/09/20 ---------------------------*
ENDSELECT.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*     MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MBEW SY-SUBRC.
ENDCASE.

ENDFORM.                    "FRM_SELECT_MBEW
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 05
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MBEWH
*&---------------------------------------------------------------------*
*       評価在庫履歴情報を取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_MBEWH.

SELECT BWKEY "プラント
MATNR "品目コード
LFGJA "会計年度
LFMON "会計期間
LBKUM "在庫合計数量
SALK3 "在庫合計金額
VERPR "移動平均原価
PEINH "価格単位
FROM MBEWH
INTO CORRESPONDING FIELDS OF GF_MBEW
WHERE
**** START UPD 2014/09/26 ISID11 ****
*    BWKEY IN S_WERKS
BWKEY IN GT_RNG_WERKS
**** END UPD 2014/09/26 ISID11 ****

*---MODIFY START PSD K.ARAI   2002/10/24 ---------------------------*
*** 履歴テーブルは「入力値以降」でデータ検索を行う
AND ( LFGJA >  PR_LFGJA
OR   (
LFGJA = PR_LFGJA AND
LFMON >= PR_LFMON
*     AND ( lfgja <  pr_lfgja
*      OR   (
*             lfgja = pr_lfgja AND
*             lfmon <= pr_lfmon
*---MODIFY END   PSD K.ARAI   2002/10/24 ---------------------------*
)
)
*Add 2008.10.17 --->
AND MATNR IN S_MATNR
*Add 2008.10.17 <---
*---APPEND START PSD T.SAITOH 2002/07/05 ---------------------------*
*---DELETE START PSD K.ARAI   2002/10/24 ---------------------------*
*---DELETE START DMC R.HATA   2009/05/12 ---------------------------*
*-- 評価在庫合計額がゼロ以下でも処理対象にする
*---Modify START DMC R.HATA   2009/05/12 ---------------------------*
*   AND SALK3 > 0.
*-- 評価在庫合計額がゼロ以下でも処理対象にする
AND ( SALK3 > 0
OR  LBKUM > 0 ) .
*---Modify END   DMC R.HATA   2009/05/12 ---------------------------*
*---DELETE END   DMC R.HATA   2009/05/12 ---------------------------*
*---DELETE END   PSD K.ARAI   2002/10/24 ---------------------------*
*---APPEND END   PSD T.SAITOH 2002/07/05 ---------------------------*

*   会社コードを埋め込む
READ TABLE GT_T001K INTO GF_T001K
WITH KEY BWKEY = GF_MBEW-BWKEY.
GF_MBEW-BUKRS = GF_T001K-BUKRS.

*---MODIFY START   PSD H.HARUKI 2002/09/20 ---------------------------*
*   購買グループが入力範囲内の時　埋め込み　&　内部ＴＢＬに　APPEND

PERFORM EKGRP_GET.
IF SY-SUBRC = 0 .
GF_MBEW-EKGRP = G_SAVE_EKGRP.
APPEND GF_MBEW TO GT_MBEW.
ENDIF .
*      APPEND gf_mbew TO gt_mbew.

*---MODIFY END     PSD H.HARUKI 2002/09/20 ---------------------------*
ENDSELECT.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
*      MESSAGE S616(Z1).
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MBEW SY-SUBRC.
ENDCASE.

ENDFORM.                    "FRM_SELECT_MBEWH
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 42
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MAKT
*&---------------------------------------------------------------------*
*       品目テキストの取得
*----------------------------------------------------------------------*
*  -->  P_MATNR        品目コード
*  <--  P_MAKTX        品目名
*----------------------------------------------------------------------*
FORM FRM_SELECT_MAKT USING    P_MATNR
CHANGING P_MAKTX.

SELECT SINGLE
MAKTX
FROM MAKT
INTO (P_MAKTX)
WHERE MATNR = P_MATNR
**** START UPD 2014/09/26 ISID11 ****
*           AND SPRAS = 'J'.
AND SPRAS = SY-LANGU.
**** END UPD 2014/09/26 ISID11 ****

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MAKT SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SELECT_MAKT
*&---------------------------------------------------------------------*
*&      SELECT NUMBER 44
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MARA
*&---------------------------------------------------------------------*
*       基本数量単位を取得する
*----------------------------------------------------------------------*
*      -->P_MATNR  品目コード
*      <--P_MEINS  基本数量単位
*----------------------------------------------------------------------*
FORM FRM_SELECT_MARA USING    P_MATNR
CHANGING P_MEINS.
SELECT SINGLE
MEINS
FROM MARA
INTO (P_MEINS)
WHERE MATNR = P_MATNR.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_MARA SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SELECT_MARA
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MBEW
*&---------------------------------------------------------------------*
*       当月末在庫特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MBEW.
DATA:LT_MBEW    TYPE TABLE OF TYP_MBEW,"ローカル内部テーブル
LF_MBEW    LIKE GF_MBEW.

* ①A指定会計期間でMBEWを検索 select number 6
SELECT SINGLE
BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEW
INTO CORRESPONDING FIELDS OF LF_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*     処理用内部へ格納する
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
*    購買グループ SET
LF_MBEW-EKGRP = GF_MBEW-EKGRP .
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*

APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMBEWHを検索 select number 7
SELECT SINGLE
BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEWH
INTO CORRESPONDING FIELDS OF LF_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*     処理用内部へ格納する
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
*    購買グループ SET
LF_MBEW-EKGRP = GF_MBEW-EKGRP .
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*

APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMBEWHから検索
* select number 8
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEWH
INTO CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMBEWから検索
* select number 9
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEW
APPENDING CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MBEW IS INITIAL ).
*     ソート
SORT LT_MBEW BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MBEW INTO LF_MBEW.
*       会社コード挿入
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
*    購買グループ SET
LF_MBEW-EKGRP = GF_MBEW-EKGRP .
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*

*       処理用内部へ格納する
APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMBEWHから検索
* select number 10
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEWH
INTO CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMBEWから検索
* select number 11
SELECT BWKEY
MATNR
LFGJA
LFMON
LBKUM
SALK3
VERPR
PEINH
FROM   MBEW
APPENDING CORRESPONDING FIELDS OF TABLE LT_MBEW
WHERE  MATNR   = GF_MBEW-MATNR
AND  BWKEY   = GF_MBEW-BWKEY
*           AND  MATNR   = GF_MBEW-MATNR
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MBEW
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MBEW IS INITIAL ).
*     ソート
SORT LT_MBEW BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MBEW INTO LF_MBEW.
*       会社コード挿入
LF_MBEW-BUKRS = GF_MBEW-BUKRS.
*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
*    購買グループ SET
LF_MBEW-EKGRP = GF_MBEW-EKGRP .
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*

*       処理用内部へ格納する
APPEND LF_MBEW TO GT_MBEW_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

ENDFORM.                    " FRM_SPECIFIC_MBEW
*&---------------------------------------------------------------------*
*&      Form  FRM_EXTRACTIONS
*&---------------------------------------------------------------------*
*       各在庫の選定処理
*----------------------------------------------------------------------*
FORM FRM_EXTRACTIONS.
DATA:L_CNT_MBEW_EXEC TYPE I."EXEC取得件数
* 取得件数
DESCRIBE TABLE GT_MBEW_EXEC LINES L_CNT_MBEW_EXEC.
IF L_CNT_MBEW_EXEC = 0.
MESSAGE S616(Z1).
STOP.
ENDIF.

*---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
* 受注在庫（販売明細番号取得）
PERFORM FRM_SPECIFIC_MSKA_BEFORE.
* 受注在庫（MSKA全データ取得）
PERFORM FRM_SPECIFIC_MSKA_ALL.
*---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*

LOOP AT GT_MBEW_EXEC INTO GF_MBEW_EXEC.
*---MODIFY START PSD T.SAITOH 2002/05/15 ---------------------------*
*    PERFORM FRM_SPECIFIC_MSKA.
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
*    PERFORM frm_specific_mska_up.
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
PERFORM FRM_SPECIFIC_MSKA_UP.
*    PERFORM FRM_SPECIFIC_MSKA.
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
PERFORM FRM_SPECIFIC_MARD.
PERFORM FRM_SPECIFIC_MSKU_READY.
PERFORM FRM_SPECIFIC_MSLB_READY.
PERFORM FRM_SPECIFIC_MARC.
ENDLOOP.

ENDFORM.                    " FRM_EXTRACTIONS
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MBEW
*&---------------------------------------------------------------------*
*       ＭＢＥＷ共通項目セット
*----------------------------------------------------------------------*
FORM FRM_SET_MBEW.
DATA: LF_T001  TYPE TYP_T001,
LF_T001K TYPE TYP_T001K,
LF_T001W TYPE TYP_T001W.
DATA: L_VERPR(9) TYPE P DECIMALS 2,"移動平均原価作業用
L_SALK3(9) TYPE P DECIMALS 2."在庫合計金額

CLEAR:GF_EXEC.
*  MOVE-CORRESPONDING FIELDS OF GF_MBEW_EXEC GF_EXEC.
GF_EXEC-BUKRS = GF_MBEW_EXEC-BUKRS .
GF_EXEC-BWKEY = GF_MBEW_EXEC-BWKEY .
GF_EXEC-MATNR = GF_MBEW_EXEC-MATNR .
*  保管場所、仕入先、得意先、転送中（テキスト）
*  GF_EXEC-LGORT = GF_MBEW_EXEC-LGORT ."保管場所　後ほど設定
*  GF_EXEC-MPTRN = GF_MBEW_EXEC-MPTRN ."保管場所種別　後ほど設定
GF_EXEC-LFGJA = GF_MBEW_EXEC-LFGJA .
GF_EXEC-LFMON = GF_MBEW_EXEC-LFMON .
*  GF_EXEC-MAKTX = GF_MBEW_EXEC-MAKTX ."品目名
PERFORM FRM_SELECT_MAKT USING    GF_MBEW_EXEC-MATNR
CHANGING GF_EXEC-MAKTX.

*  GF_EXEC-BUTXT = GF_MBEW_EXEC-BUTXT ."会社名
READ TABLE GT_T001 INTO LF_T001
WITH KEY BUKRS = GF_MBEW_EXEC-BUKRS.
GF_EXEC-BUTXT = LF_T001-BUTXT.

*  GF_EXEC-PNAME = GF_MBEW_EXEC-PNAME ."プラント名
READ TABLE GT_T001W INTO LF_T001W
WITH KEY WERKS = GF_MBEW_EXEC-BWKEY.
GF_EXEC-PNAME = LF_T001W-NAME1.

*---INSERT START   PSD H.HARUKI 2002/09/21 ---------------------------*
*  購買グループ
GF_EXEC-EKGRP = GF_MBEW_EXEC-EKGRP .
*---INSERT END     PSD H.HARUKI 2002/09/21 ---------------------------*


*  GF_EXEC-LNAME = GF_MBEW_EXEC-LNAME ."保管所名  後ほど設定
*  GF_EXEC-LGPBE = GF_MBEW_EXEC-LGPBE ."棚番　　　後ほど設定
*  GF_EXEC-NUM = GF_MBEW_EXEC- .       "数量　　　後ほど設定

*  GF_EXEC-MEINS = GF_MBEW_EXEC- .      "単位
PERFORM FRM_SELECT_MARA USING    GF_MBEW_EXEC-MATNR
CHANGING GF_EXEC-MEINS.
*  GF_EXEC-UNTCT = GF_MBEW_EXEC- .     "単価
* 移動平均原価を価格変換する
PERFORM FRM_CURRENCY_AMOUNT USING    LF_T001-WAERS
GF_MBEW_EXEC-VERPR
CHANGING L_VERPR.
MOVE : LF_T001-WAERS TO GF_EXEC-WAERS .


* ０で除算を回避
IF GF_MBEW_EXEC-PEINH <> 0.
GF_EXEC-UNTCT = L_VERPR / GF_MBEW_EXEC-PEINH.
ELSE.
GF_EXEC-UNTCT = 0.
ENDIF.

* 合計金額を価格変換する
PERFORM FRM_CURRENCY_AMOUNT USING    LF_T001-WAERS
GF_MBEW_EXEC-SALK3
CHANGING L_SALK3.

GF_EXEC-SALK3 = L_SALK3 . "合計金額


GF_EXEC-LBKUM = GF_MBEW_EXEC-LBKUM . "合計数量
*  GF_EXEC-TOTAL = GF_MBEW_EXEC- .     "総合計


ENDFORM.                    " FRM_SET_MBEW
*---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA_BEFORE
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理_前処理伝票番号全件取得
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA_BEFORE.
DATA : L_LFMON LIKE MSKAH-LFMON ,
L_LFGJA LIKE MSKAH-LFGJA .
*---APPEND START SOLFIS K.KAJISA 2010/02/22 ---------------------------*
*-- 品目/プラント/受注伝票/明細/保管場所での重複を削除するための一次ITAB
DATA:LT_MSKA_NUMBERS TYPE STANDARD TABLE OF TYP_MSKA_HS,
LF_MSKA_NUMBERS TYPE TYP_MSKA_HS.
REFRESH:LT_MSKA_NUMBERS.
CLEAR:LF_MSKA_NUMBERS.
*---APPEND END   SOLFIS K.KAJISA 2010/02/22 ---------------------------*

* 伝票番号パターンを抽出
SELECT DISTINCT
MATNR
WERKS
LGORT
SOBKZ
VBELN
POSNR
LFGJA
LFMON
INTO CORRESPONDING FIELDS OF TABLE GT_MSKA_NUMBERS
FROM MSKA
FOR ALL ENTRIES IN GT_MBEW_EXEC
WHERE  MATNR = GT_MBEW_EXEC-MATNR
**** START UPD 2014/09/26 ISID11 ****
*          AND  WERKS IN S_WERKS
AND  WERKS IN GT_RNG_WERKS
**** END UPD 2014/09/26 ISID11 ****
AND  KALAB <> 0
AND  (
( LFGJA   =  PR_LFGJA AND
LFMON   <= PR_LFMON
)
OR
(
LFGJA   <  PR_LFGJA
)
)
.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

*---APPEND START PSD K.ARAI   2002/10/17 ---------------------------*
MOVE :  PR_LFGJA TO L_LFGJA ,
PR_LFMON TO L_LFMON .
* MSKAH より伝票番号パターンを抽出
*  ---DELETE START DMC S.SHIGEMITU   2008/04/03  ----------------------*
*  DO .
*  ---DELETE END   DMC S.SHIGEMITU  2008/04/03 -----------------------*

SELECT DISTINCT
MATNR
WERKS
LGORT
SOBKZ
VBELN
POSNR
LFGJA
LFMON
APPENDING CORRESPONDING FIELDS OF TABLE GT_MSKA_NUMBERS
FROM MSKAH
FOR ALL ENTRIES IN GT_MBEW_EXEC
WHERE  MATNR = GT_MBEW_EXEC-MATNR
**** START UPD 2014/09/26 ISID11 ****
*          AND  WERKS IN S_WERKS
AND  WERKS IN GT_RNG_WERKS
**** END UPD 2014/09/26 ISID11 ****
AND  KALAB <> 0
AND  (
*  ---APPEND START DMC S.SHIGEMITU   2008/04/03 ----------------------*
( LFGJA   =  PR_LFGJA AND
LFMON   >= PR_LFMON
)
OR
(
LFGJA   >  PR_LFGJA
)
)
.
*  ---APPEND END DMC S.SHIGEMITU   2008/04/03   ----------------------*

*  ---DELETE START DMC S.SHIGEMITU   2008/04/03  ----------------------*
**  ---MODIFY START PSD K.ARAI   2002/10/24 ---------------------------*
**  ---MODIFY START NDSC R.Hata  2002/11/18 ---------------------------*
*                    LFGJA EQ L_LFGJA
*            AND     LFMON EQ L_LFMON
*
**                   ( lfgja   =  pr_lfgja AND
**                     lfmon   >= pr_lfmon
**                   )
**                   OR
**                   (
**                     lfgja   >  pr_lfgja
**                    ( lfgja   =  pr_lfgja AND
**                      lfmon   <= pr_lfmon
**                    )
**                    OR
**                    (
**                      lfgja   <  pr_lfgja
**  ---MODIFY END   PSD K.ARAI   2002/10/24 ---------------------------*
**               )
**  ---MODIFY END   NDSC R.Hata  2002/11/18 ---------------------------*
*                 )
*             .
*  ---DELETE END   DMC S.SHIGEMITU  2008/04/03 -----------------------*

*   --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*---APPEND START SOLFIS K.KAJISA 2010/02/22 ---------------------------*
*-- 品目/プラント/受注伝票/明細/保管場所での重複を削除
LT_MSKA_NUMBERS[] = GT_MSKA_NUMBERS[].
REFRESH:GT_MSKA_NUMBERS.
SORT LT_MSKA_NUMBERS BY MATNR WERKS VBELN POSNR LGORT.
CLEAR:GF_MSKA_NUMBERS.
LOOP AT LT_MSKA_NUMBERS INTO LF_MSKA_NUMBERS.
IF  LF_MSKA_NUMBERS-MATNR = GF_MSKA_NUMBERS-MATNR
AND LF_MSKA_NUMBERS-WERKS = GF_MSKA_NUMBERS-WERKS
AND LF_MSKA_NUMBERS-VBELN = GF_MSKA_NUMBERS-VBELN
AND LF_MSKA_NUMBERS-POSNR = GF_MSKA_NUMBERS-POSNR
AND LF_MSKA_NUMBERS-LGORT = GF_MSKA_NUMBERS-LGORT.
ELSE.
GF_MSKA_NUMBERS = LF_MSKA_NUMBERS.
APPEND GF_MSKA_NUMBERS TO GT_MSKA_NUMBERS.
ENDIF.
ENDLOOP.
*---APPEND END   SOLFIS K.KAJISA 2010/02/22 ---------------------------*

EXIT .
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.
*  ---DELETE START DMC S.SHIGEMITU   2008/04/03  ----------------------*
*    ADD 1 TO L_LFMON .
*    IF L_LFMON GE 13 .
*      MOVE '01' TO L_LFMON .
*      ADD 1 TO L_LFGJA .
*    ENDIF .
*    IF L_LFMON GE W_BUPER+1(02)
*    AND L_LFGJA GE W_GJAHR .
*      EXIT .
*    ENDIF .
*  ENDDO .
*  ---DELETE END   DMC S.SHIGEMITU  2008/04/03 -----------------------*

*---APPEND END   PSD K.ARAI   2002/10/17 ---------------------------*
ENDFORM.  " FRM_SPECIFIC_MSKA_BEFORE.
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA_ALL
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理_前処理全データ取得
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA_ALL.
DATA: L_RECNUM TYPE I."レコード件数

DESCRIBE TABLE GT_MSKA_NUMBERS LINES L_RECNUM.
* 対象なしの場合は下記のセレクトを行なわない
IF L_RECNUM = 0.
EXIT.
ENDIF.

* MSKA(H)より全データ格納
SELECT MATNR
WERKS
LGORT
SOBKZ
VBELN
POSNR
LFGJA
LFMON
KALAB
INTO CORRESPONDING FIELDS OF TABLE GT_MSKA_DB
FROM MSKA
FOR ALL ENTRIES IN GT_MSKA_NUMBERS
WHERE MATNR = GT_MSKA_NUMBERS-MATNR
AND WERKS = GT_MSKA_NUMBERS-WERKS
AND LGORT = GT_MSKA_NUMBERS-LGORT
AND SOBKZ = GT_MSKA_NUMBERS-SOBKZ
AND VBELN = GT_MSKA_NUMBERS-VBELN
AND POSNR = GT_MSKA_NUMBERS-POSNR
.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

* MSKA(H)より全データ格納
SELECT MATNR
WERKS
LGORT
SOBKZ
VBELN
POSNR
LFGJA
LFMON
KALAB
APPENDING CORRESPONDING FIELDS OF TABLE GT_MSKA_DB
FROM MSKAH
FOR ALL ENTRIES IN GT_MSKA_NUMBERS
WHERE MATNR = GT_MSKA_NUMBERS-MATNR
AND WERKS = GT_MSKA_NUMBERS-WERKS
AND LGORT = GT_MSKA_NUMBERS-LGORT
AND SOBKZ = GT_MSKA_NUMBERS-SOBKZ
AND VBELN = GT_MSKA_NUMBERS-VBELN
AND POSNR = GT_MSKA_NUMBERS-POSNR
.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.


ENDFORM.  " FRM_SPECIFIC_MSKA_ALL.
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA_UP
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理_上階層
*        販売伝票番号＋明細番号
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKA_UP.
*---APPEND START PSD K.ARAI 2002/10/17 ---------------------------*
LOOP AT GT_MSKA_NUMBERS INTO GF_MSKA_NUMBERS
WHERE MATNR = GF_MBEW_EXEC-MATNR
AND WERKS = GF_MBEW_EXEC-BWKEY.
PERFORM FRM_SPECIFIC_MSKA USING GF_MSKA_NUMBERS-VBELN
GF_MSKA_NUMBERS-POSNR
GF_MSKA_NUMBERS-LGORT.
ENDLOOP.
*---APPEND END   PSD K.ARAI 2002/10/17 ---------------------------*

*---DELETE START PSD K.ARAI 2002/10/17 ---------------------------*
*  LOOP AT gt_mska_numbers INTO gf_mska_numbers.
*    PERFORM frm_specific_mska USING gf_mska_numbers-vbeln
*                                    gf_mska_numbers-posnr
*                                    gf_mska_numbers-lgort.
*  ENDLOOP.
*---DELETE END   PSD K.ARAI 2002/10/17 ---------------------------*
ENDFORM.  " FRM_SPECIFIC_MSKA_BEFORE.
*---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKA
*&---------------------------------------------------------------------*
*       １－①受注在庫の特定処理
*----------------------------------------------------------------------*
* --> P_VBELN 販売伝票番号
* --> P_POSNR 明細番号
* --> P_LGORT 保管場所
*----------------------------------------------------------------------*
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
*FORM frm_specific_mska USING p_vbeln p_posnr p_lgort.
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
FORM FRM_SPECIFIC_MSKA USING P_VBELN P_POSNR P_LGORT.
*FORM frm_specific_mska.
*---MODIFY END   PSD K.ARAI 2002/10/18 ---------------------------*
*---MODIFY START PSD K.ARAI 2002/10/18 ---------------------------*
*---DELETE START PSD K.ARAI 2002/10/18 ---------------------------*
*  LOOP AT gt_mska_numbers INTO gf_mska_numbers
*                          where matnr = GF_MBEW_EXEC-matnr
*                            and WERKS = GF_MBEW_EXEC-BWKEY.
*---DELETE END   PSD K.ARAI 2002/10/18 ---------------------------*

*  LOOP AT gt_mska_numbers INTO gf_mska_numbers.
*---MODIFY END   PSD K.ARAI 2002/10/18 ---------------------------*
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
FIELD-SYMBOLS <FS_MSKA> LIKE GT_MSKA_DB.
FIELD-SYMBOLS <FSF_MSKA> LIKE GF_MSKA_DB.

ASSIGN GT_MSKA_DB TO <FS_MSKA>.
*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
ASSIGN GF_MSKA_DB TO <FSF_MSKA>.
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*
CLEAR: LT_MSKA,LF_MSKA.

* ①A指定会計期間でMSKAを検索
* select number 12

*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
*   READ TABLE <FS_MSKA> INTO LF_MSKA
READ TABLE <FS_MSKA> INTO <FSF_MSKA>
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*
WITH TABLE KEY
MATNR   = GF_MBEW_EXEC-MATNR
WERKS   = GF_MBEW_EXEC-BWKEY
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
*---MODIFY START PSD K.ARAI 2002/10/20 ---------------------------*
*                       lgort   = gf_mska_numbers-lgort
LGORT   = P_LGORT
*---MODIFY END   PSD K.ARAI 2002/10/20 ---------------------------*
*                       lgort   = p_lgort
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
SOBKZ   = CNS_E
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
*---MODIFY START PSD K.ARAI 2002/10/20 ---------------------------*
VBELN   = P_VBELN
POSNR   = P_POSNR
*                       vbeln   = gf_mska_numbers-vbeln
*                       posnr   = gf_mska_numbers-posnr
*---MODIFY END   PSD K.ARAI 2002/10/20 ---------------------------*
*                       vbeln   = p_vbeln
*                       posnr   = p_posnr
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
LFGJA   = PR_LFGJA
LFMON   = PR_LFMON.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKA.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMSKAHから検索
* select number 14
*  FIELD-SYMBOLS <FS_MSKA> LIKE GF_MSKA_DB.
LOOP AT GT_MSKA_DB ASSIGNING <FSF_MSKA>
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_E
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
*---MODIFY START PSD K.ARAI 2002/10/20 ---------------------------*
AND  VBELN   = P_VBELN
AND  POSNR   = P_POSNR
*                           AND  vbeln   = gf_mska_numbers-vbeln
*                           AND  posnr   = gf_mska_numbers-posnr
*---MODIFY END   PSD K.ARAI 2002/10/20 ---------------------------*
*                           AND  vbeln   = p_vbeln
*                           AND  posnr   = p_posnr
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
APPEND LF_MSKA TO LT_MSKA.

ENDLOOP.


*  SELECT
*         WERKS
*         MATNR
*         LGORT
*         LFGJA
*         LFMON
*         KALAB
*         SOBKZ
*         FROM   MSKAH
*         INTO CORRESPONDING FIELDS OF TABLE LT_MSKA
*         WHERE  MATNR   = GF_MBEW_EXEC-MATNR
*           AND  WERKS   = GF_MBEW_EXEC-BWKEY
*           AND  SOBKZ   = CNS_E
**---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  VBELN   = P_VBELN
*           AND  POSNR   = P_POSNR
**---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  (
*                  ( LFGJA   = PR_LFGJA AND
*                    LFMON   > PR_LFMON
*                  )
*                  OR
*                  (
*                    LFGJA   > PR_LFGJA
*                  )
*                )
*
.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMSKAから検索
* select number 15
*  SELECT
*         WERKS
*         MATNR
*         LGORT
*         LFGJA
*         LFMON
*         KALAB
*         SOBKZ
*         FROM   MSKA
*         APPENDING CORRESPONDING FIELDS OF TABLE LT_MSKA
*         WHERE  MATNR   = GF_MBEW_EXEC-MATNR
*           AND  WERKS   = GF_MBEW_EXEC-BWKEY
*           AND  SOBKZ   = CNS_E
**---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  VBELN   = P_VBELN
*           AND  POSNR   = P_POSNR
**---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  (
*                  ( LFGJA   = PR_LFGJA AND
*                    LFMON   > PR_LFMON
*                  )
*                  OR
*                  (
*                    LFGJA   > PR_LFGJA
*                  )
*                )
*
*           .
* --- エラーチェック
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.
*    WHEN OTHERS.
*      MESSAGE A603(Z1) WITH SY-REPID
*                            CNS_MSKA
*                            SY-SUBRC.
*  ENDCASE.

IF NOT ( LT_MSKA IS INITIAL ).
*     ソート
SORT LT_MSKA BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKA INTO LF_MSKA.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKA.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMSKAHから検索
* select number 16

LOOP AT GT_MSKA_DB ASSIGNING <FSF_MSKA>
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_E
*---MODIFY START PSD K.ARAI 2002/10/17 ---------------------------*
*---MODIFY START PSD K.ARAI 2002/10/20 ---------------------------*
AND  VBELN   = P_VBELN
AND  POSNR   = P_POSNR
*                       AND  vbeln   = gf_mska_numbers-vbeln
*                       AND  posnr   = gf_mska_numbers-posnr
*---MODIFY END   PSD K.ARAI 2002/10/20 ---------------------------*
*                       AND  vbeln   = p_vbeln
*                       AND  posnr   = p_posnr
*---MODIFY END   PSD K.ARAI 2002/10/17 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.

MOVE-CORRESPONDING <FSF_MSKA> TO LF_MSKA.
APPEND LF_MSKA TO LT_MSKA.

ENDLOOP.

*  SELECT
*         WERKS
*         MATNR
*         LGORT
*         LFGJA
*         LFMON
*         KALAB
*         SOBKZ
*         FROM   MSKAH
*         INTO CORRESPONDING FIELDS OF TABLE LT_MSKA
*         WHERE  MATNR   = GF_MBEW_EXEC-MATNR
*           AND  WERKS   = GF_MBEW_EXEC-BWKEY
*           AND  SOBKZ   = CNS_E
**---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  VBELN   = P_VBELN
*           AND  POSNR   = P_POSNR
**---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  (
*                  ( LFGJA   = PR_LFGJA AND
*                    LFMON   < PR_LFMON
*                  )
*                  OR
*                  (
*                    LFGJA   < PR_LFGJA
*                  )
*                )
*
*           .
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMSKAから検索
* select number 17
*  SELECT
*         WERKS
*         MATNR
*         LGORT
*         LFGJA
*         LFMON
*         KALAB
*         SOBKZ
*         FROM   MSKA
*         APPENDING CORRESPONDING FIELDS OF TABLE LT_MSKA
*         WHERE  MATNR   = GF_MBEW_EXEC-MATNR
*           AND  WERKS   = GF_MBEW_EXEC-BWKEY
*           AND  SOBKZ   = CNS_E
**---APPEND START PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  VBELN   = P_VBELN
*           AND  POSNR   = P_POSNR
**---APPEND END   PSD T.SAITOH 2002/05/15 ---------------------------*
*           AND  (
*                  ( LFGJA   = PR_LFGJA AND
*                    LFMON   < PR_LFMON
*                  )
*                  OR
*                  (
*                    LFGJA   < PR_LFGJA
*                  )
*                )
*
*           .
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKA
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSKA IS INITIAL ).
*     ソート
SORT LT_MSKA BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKA INTO LF_MSKA.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKA.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.
*---APPEND START PSD K.ARAI 2002/10/17 ---------------------------*
*---DELETE START PSD K.ARAI 2002/10/17 ---------------------------*
*  ENDLOOP.
*---DELETE END   PSD K.ARAI 2002/10/17 ---------------------------*
*---APPEND END   PSD K.ARAI 2002/10/17 ---------------------------*
ENDFORM.                    " FRM_SPECIFIC_MSKA
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MSKA
*&---------------------------------------------------------------------*
*       １－①MSKA詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MSKA.
* 保管場所
GF_EXEC-LGORT = LF_MSKA-LGORT.
* 保管場所種別
GF_EXEC-MPTRN = CNS_1_MSKA.
* 保管場所名
* select number 43
SELECT SINGLE
LGOBE
FROM T001L
INTO (GF_EXEC-LNAME)
WHERE WERKS = LF_MSKA-WERKS
AND LGORT = LF_MSKA-LGORT.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001L SY-SUBRC.
ENDCASE.

* 棚番 --- 未設定
* Add 2003/11/05 >>>
SELECT SINGLE LGPBE
FROM  MARD
INTO  GF_EXEC-LGPBE
WHERE MATNR EQ GF_EXEC-MATNR
AND  WERKS EQ LF_MSKA-WERKS
AND  LGORT EQ LF_MSKA-LGORT.
* Add 2003/11/05 <<<

* 数量
GF_EXEC-NUM = LF_MSKA-KALAB.

ENDFORM.                    " FRM_SET_MSKA
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MARD
*&---------------------------------------------------------------------*
*       １－②自社保管場所在庫の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MARD.

CLEAR: LT_MARD,LF_MARD.
*2008/06/06 ADD START
CLEAR: W_LGPBE.
*2008/06/06 ADD END

* ①A指定会計期間でMARDを検索
* select number 18
SELECT SINGLE
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
**** START ADD 2015/03/24 ISID12 ****
SPEME
**** END ADD 2015/03/24 ISID12 ****
LGPBE
*         SOBKZ
FROM   MARD
INTO CORRESPONDING FIELDS OF LF_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMARDHを検索
* select number 19
SELECT SINGLE
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
**** START ADD 2015/03/24 ISID12 ****
SPEME
**** END ADD 2015/03/24 ISID12 ****
*         LGPBE
*         SOBKZ
FROM   MARDH
INTO CORRESPONDING FIELDS OF LF_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*2008/06/06 ADD START
*     指定会計期間以降のレコードをMARDから検索
PERFORM FRM_SEL_MARD.
*     取得した棚番を採用
LF_MARD-LGPBE = W_LGPBE.
*2008/06/06 ADD END
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

*2008/06/06 ADD START
* MARDの棚番を取得する
PERFORM FRM_SEL_MARD.
*2008/06/06 ADD END

* ②A指定会計期間より大きいレコードをMARDHから検索
* select number 20
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
**** START ADD 2015/03/24 ISID12 ****
SPEME
**** END ADD 2015/03/24 ISID12 ****
*         LGPBE
*         SOBKZ
FROM   MARDH
INTO CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMARDから検索
* select number 21
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
**** START ADD 2015/03/24 ISID12 ****
SPEME
**** END ADD 2015/03/24 ISID12 ****
LGPBE
*         SOBKZ
FROM   MARD
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARD IS INITIAL ).
*     ソート
SORT LT_MARD BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARD INTO LF_MARD.
*2008/06/06 ADD START
*     退避しておいたMARDの棚番を採用する
LF_MARD-LGPBE = W_LGPBE.
*2008/06/06 ADD END
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMARDHから検索
* select number 22
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
**** START ADD 2015/03/24 ISID12 ****
SPEME
**** END ADD 2015/03/24 ISID12 ****
*         LGPBE
*         SOBKZ
FROM   MARDH
INTO CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMARDから検索
* select number 23
SELECT
WERKS
MATNR
LGORT
LFGJA
LFMON
LABST
**** START ADD 2015/03/24 ISID12 ****
SPEME
**** END ADD 2015/03/24 ISID12 ****
LGPBE
*         SOBKZ
FROM   MARD
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARD
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARD IS INITIAL ).
*     ソート
SORT LT_MARD BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARD INTO LF_MARD.
*2008/06/06 ADD START
*     退避しておいたMARDの棚番を採用する。
LF_MARD-LGPBE = W_LGPBE.
*2008/06/06 ADD END
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARD.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MARD

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MARD
*&---------------------------------------------------------------------*
*       １－②MARD詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MARD.
* 保管場所
GF_EXEC-LGORT = LF_MARD-LGORT.
* 保管場所種別
GF_EXEC-MPTRN = CNS_1_MARD.
* 保管場所名
* select number 43
SELECT SINGLE
LGOBE
FROM T001L
INTO (GF_EXEC-LNAME)
WHERE WERKS = LF_MARD-WERKS
AND LGORT = LF_MARD-LGORT.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_T001L SY-SUBRC.
ENDCASE.

* 棚番
GF_EXEC-LGPBE = LF_MARD-LGPBE.
* 数量
*  GF_EXEC-NUM = LF_MARD-LABST.
GF_EXEC-NUM = LF_MARD-LABST + LF_MARD-SPEME.

ENDFORM.                    " FRM_SET_MSKA
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKU_ready
*&---------------------------------------------------------------------*
*     ２  MSKU設定　前処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKU_READY.

DATA:  LT_KUNNR TYPE TABLE OF TYP_KNA1,"取得用
LF_KUNNR TYPE TYP_KNA1.         "取得用構造

* 得意先取得--現テーブル SELECT NUMBER 47
SELECT KUNNR
FROM   MSKU
INTO CORRESPONDING FIELDS OF TABLE LT_KUNNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
GROUP BY KUNNR.

* 得意先取得--履歴テーブル SELECT NUMBER 48
SELECT KUNNR
FROM   MSKUH
APPENDING CORRESPONDING FIELDS OF TABLE LT_KUNNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
GROUP BY KUNNR.

* 得意先コードでソート
SORT LT_KUNNR BY KUNNR ASCENDING.

* 得意先ごとに期末在庫を求めるようにする
LOOP AT LT_KUNNR INTO LF_KUNNR.
GF_KUNNR_TMP = LF_KUNNR.
AT NEW KUNNR.
*     得意先特殊在庫当月末在庫設定
PERFORM FRM_SPECIFIC_MSKU.
ENDAT.
ENDLOOP.

ENDFORM.                    " FRM_SPECIFIC_MSKU_ready
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSKU
*&---------------------------------------------------------------------*
*       ２　得意先特殊在庫（預託在庫）の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSKU.

CLEAR: LT_MSKU,LF_MSKU.

* ①A指定会計期間でMSKUを検索
* select number 24
SELECT SINGLE
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKU
INTO CORRESPONDING FIELDS OF LF_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMSKUHを検索
* select number 25
SELECT SINGLE
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKUH
INTO CORRESPONDING FIELDS OF LF_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMSKUHから検索
* select number 26
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKUH
INTO CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMSKUから検索
* select number 27
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKU
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSKU IS INITIAL ).
*     ソート
SORT LT_MSKU BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKU INTO LF_MSKU.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMSKUHから検索
* select number 28
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKUH
INTO CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMSKUから検索
* select number 29
SELECT
WERKS
MATNR
*         LGORT
KUNNR
LFGJA
LFMON
KULAB
*         LGPBE
SOBKZ
FROM   MSKU
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSKU
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_W
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  KUNNR   = GF_KUNNR_TMP-KUNNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSKU
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSKU IS INITIAL ).
*     ソート
SORT LT_MSKU BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSKU INTO LF_MSKU.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSKU.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MSKU

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MSKU
*&---------------------------------------------------------------------*
*       MSKU詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MSKU.
* 保管場所
GF_EXEC-LGORT = LF_MSKU-KUNNR.
* 保管場所種別
GF_EXEC-MPTRN = CNS_2_MSKU.
* 保管場所名
* select number 45
SELECT SINGLE
NAME1
FROM KNA1
INTO (GF_EXEC-LNAME)
WHERE KUNNR = LF_MSKU-KUNNR.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_KNA1 SY-SUBRC.
ENDCASE.

* 棚番(BLANK)
GF_EXEC-LGPBE = SPACE.
* 数量
GF_EXEC-NUM = LF_MSKU-KULAB.

ENDFORM.                    " FRM_SET_MSKU
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSLB_ready
*&---------------------------------------------------------------------*
*       MSLB設定　前処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSLB_READY.

DATA:  LT_LIFNR TYPE TABLE OF TYP_LFA1,"取得用
LF_LIFNR TYPE TYP_LFA1.         "取得用構造

* 仕入先取得--現テーブル SELECT NUMBER 49
SELECT LIFNR
FROM   MSLB
INTO CORRESPONDING FIELDS OF TABLE LT_LIFNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
GROUP BY LIFNR.

* 仕入先取得--履歴テーブル SELECT NUMBER 50
SELECT LIFNR
FROM   MSLBH
APPENDING CORRESPONDING FIELDS OF TABLE LT_LIFNR
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
GROUP BY LIFNR.

* 仕入先でソート
SORT LT_LIFNR BY LIFNR ASCENDING.

* 仕入先ごとに期末在庫を求めるようにする
LOOP AT LT_LIFNR INTO LF_LIFNR.
GF_LIFNR_TMP = LF_LIFNR.
AT NEW LIFNR.
*     仕入先特殊在庫設定
PERFORM FRM_SPECIFIC_MSLB.
ENDAT.
ENDLOOP.

ENDFORM.                    " FRM_SPECIFIC_MSLB_ready
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MSLB
*&---------------------------------------------------------------------*
*       ３仕入先特殊在庫（支給品）の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MSLB.

CLEAR: LT_MSLB,LF_MSLB.
* ①A指定会計期間でMSLBを検索
* select number 30
SELECT SINGLE
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLB
INTO CORRESPONDING FIELDS OF LF_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMSLBHを検索
* select number 31
SELECT SINGLE
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLBH
INTO CORRESPONDING FIELDS OF LF_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMSLBHから検索
* select number 32
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLBH
INTO CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMSLBから検索
* select number 33
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLB
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSLB IS INITIAL ).
*     ソート
SORT LT_MSLB BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSLB INTO LF_MSLB.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMSLBHから検索
* select number 34
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLBH
INTO CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMSLBから検索
* select number 35
SELECT
WERKS
MATNR
*         LGORT
LIFNR
LFGJA
LFMON
LBLAB
*         LGPBE
SOBKZ
FROM   MSLB
APPENDING CORRESPONDING FIELDS OF TABLE LT_MSLB
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  SOBKZ   = CNS_O
*---APPEND START PSD T.SAITOH 2002/04/09 ---------------------------*
AND  LIFNR   = GF_LIFNR_TMP-LIFNR
*---APPEND END   PSD T.SAITOH 2002/04/09 ---------------------------*
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MSLB
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MSLB IS INITIAL ).
*     ソート
SORT LT_MSLB BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MSLB INTO LF_MSLB.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MSLB.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MSLB

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MSLB
*&---------------------------------------------------------------------*
*       MSLB詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MSLB.
* 保管場所
GF_EXEC-LGORT = LF_MSLB-LIFNR.
* 保管場所種別
GF_EXEC-MPTRN = CNS_3_MSLB.
* 保管場所名
* select number 46
SELECT SINGLE
NAME1
FROM LFA1
INTO (GF_EXEC-LNAME)
WHERE LIFNR = LF_MSLB-LIFNR.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID CNS_LFA1 SY-SUBRC.
ENDCASE.

* 棚番(BLANK)
GF_EXEC-LGPBE = SPACE.
* 数量
GF_EXEC-NUM = LF_MSLB-LBLAB.

ENDFORM.                    " FRM_SET_MSLB
*&---------------------------------------------------------------------*
*&      Form  FRM_SPECIFIC_MARC
*&---------------------------------------------------------------------*
*       ４転送中在庫の特定処理
*----------------------------------------------------------------------*
FORM FRM_SPECIFIC_MARC.

CLEAR: LT_MARC,LF_MARC.
* ①A指定会計期間でMARCを検索
* select number 36
SELECT SINGLE
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARC
INTO CORRESPONDING FIELDS OF LF_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ①B指定会計期間でMARCHを検索
* select number 37
SELECT SINGLE
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARCH
INTO CORRESPONDING FIELDS OF LF_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  LFGJA   = PR_LFGJA
AND  LFMON   = PR_LFMON.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ②A指定会計期間より大きいレコードをMARCHから検索
* select number 38
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARCH
INTO CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ②B指定会計期間より大きいレコードをMARCから検索
* select number 39
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARC
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   > PR_LFMON
)
OR
(
LFGJA   > PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARC IS INITIAL ).
*     ソート
SORT LT_MARC BY  LFGJA ASCENDING
LFMON ASCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARC INTO LF_MARC.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.

* ③A指定会計期間より小さいレコードをMARCHから検索
* select number 40
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARCH
INTO CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

* ③B指定会計期間より小さいレコードをMARCから検索
* select number 41
SELECT
WERKS
MATNR
*         LGORT
*         LIFNR
LFGJA
LFMON
TRAME
*         LGPBE
*         SOBKZ
FROM   MARC
APPENDING CORRESPONDING FIELDS OF TABLE LT_MARC
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  (
( LFGJA   = PR_LFGJA AND
LFMON   < PR_LFMON
)
OR
(
LFGJA   < PR_LFGJA
)
)

.
* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARC
SY-SUBRC.
ENDCASE.

IF NOT ( LT_MARC IS INITIAL ).
*     ソート
SORT LT_MARC BY LFGJA DESCENDING
LFMON DESCENDING.
*     1 LOOP ONLY
LOOP AT LT_MARC INTO LF_MARC.
*     MBEW項目設定
PERFORM FRM_SET_MBEW.
*     詳細設定
PERFORM FRM_SET_MARC.
APPEND GF_EXEC TO GT_EXEC.
EXIT.
ENDLOOP.
EXIT.
ENDIF.


ENDFORM.                    " FRM_SPECIFIC_MARC

*&---------------------------------------------------------------------*
*&      Form  FRM_SET_MARC
*&---------------------------------------------------------------------*
*       MARC詳細設定
*----------------------------------------------------------------------*
FORM FRM_SET_MARC.
* 保管場所(BLANK)
GF_EXEC-LGORT = SPACE.
* 保管場所種別
GF_EXEC-MPTRN = CNS_4_MARC.
* 保管場所名(転送中)
GF_EXEC-LNAME = TEXT-071.
* 棚番(BLANK)
GF_EXEC-LGPBE = SPACE.
* 数量
GF_EXEC-NUM = LF_MARC-TRAME.

ENDFORM.                    " FRM_SET_MARC
*&---------------------------------------------------------------------*
*&      Form  FRM_COMPUTE
*&---------------------------------------------------------------------*
*       集計処理
*----------------------------------------------------------------------*
FORM FRM_COMPUTE.
DATA: LF_MATNR_BREAK TYPE C."品目コードブレイクフラグ
DATA: L_CNT_EXEC TYPE I."EXEC取得件数

SORT GT_EXEC BY BUKRS ASCENDING  "会社コード
BWKEY ASCENDING  "プラントコード
EKGRP ASCENDING  "購買グループ
MATNR ASCENDING  "品目コード
MPTRN ASCENDING  "保管場所種別
LGORT ASCENDING  "保管場所コード
LGPBE DESCENDING."棚番

* 在庫数量０ははじく
*---DELETE START DMC R.HATA   2009/05/12 ---------------------------*
*--在庫数量０でも、金額がゼロでなければはじかない
*  DELETE GT_EXEC WHERE NUM = 0.
*---DELETE END   DMC R.HATA   2009/05/12 ---------------------------*
*---APPEND START DMC R.HATA   2009/05/12 ---------------------------*
*--在庫数量と金額が両方０のデータのみをはじく
DELETE GT_EXEC WHERE NUM = 0 AND SALK3 = 0 .
*---APPEND END   DMC R.HATA   2009/05/12 ---------------------------*

* 総合計初期化
CLEAR GW_TOTAL.

* 取得件数
DESCRIBE TABLE GT_EXEC LINES L_CNT_EXEC.
IF L_CNT_EXEC = 0.
MESSAGE S616(Z1).
STOP.
ENDIF.

*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
CLEAR: G_FLG_MATNR.
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*

LOOP AT GT_EXEC INTO GF_EXEC.
GF_EXEC_TMP = GF_EXEC."退避(AT関連ゆえ)
*   会社コードORプラントコード　ブレイク時改ページ
*   ただし最初のレコードは改ページ条件としない
IF SY-TABIX <> 1.
*   会社コードORプラントコード　ブレイク時改ページ
AT NEW BWKEY.
NEW-PAGE.
ENDAT.
ENDIF.
*---DELETE START PSD T.SAITOH 2002/05/17 ---------------------------*
**   保管場所種別　が最後
*    AT END OF MPTRN.
*      FLG_LGORT_BREAK = CNS_X.
*    ENDAT.
*---DELETE END   PSD T.SAITOH 2002/05/17 ---------------------------*

*   保管場所種別／保管場所　が最初

*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
* 複数保管場所対応（念のため）業務上はありえないが
* システム的にはありえるため
*   複数保管場所時の品目名称を非表示 X
AT NEW MATNR.
G_FLG_MATNR = CNS_X.
ENDAT.
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*

*   自社在庫数を初期化する
AT NEW LGORT.
IF GF_EXEC_TMP-MPTRN+0(1) = '1'.
CLEAR: GW_NUM,      "作業用自社在庫数初期化
GW_LGPBE.    "作業用棚番
GW_LGPBE = GF_EXEC_TMP-LGPBE."棚番設定
ENDIF.
ENDAT.
*   自社在庫数を集計する
IF GF_EXEC_TMP-MPTRN+0(1) = '1'.
GW_NUM = GW_NUM + GF_EXEC_TMP-NUM.
*     自社在庫数を確定する
AT END OF LGORT.
PERFORM FRM_WRITE_DETAIL_MPTRN1.
ENDAT.
*      CONTINUE.
*   自社在庫数以外場合
ELSE.
PERFORM FRM_WRITE_DETAIL.
ENDIF.

*   品目コードが最後
AT END OF MATNR.
PERFORM FRM_DETAIL_TOTAL.
ENDAT.

*   会社コード／プラント　最後
AT END OF BWKEY.
PERFORM FRM_ALL_TOTAL.
ENDAT.

*   前レコード格納
GF_EXEC_BEF = GF_EXEC_TMP.

ENDLOOP.

ENDFORM.                    " FRM_COMPUTE
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_DETAIL
*&---------------------------------------------------------------------*
*       明細部分帳票出力処理
*----------------------------------------------------------------------*
FORM FRM_WRITE_DETAIL.
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (BLUE)
FORMAT COLOR COL_HEADING ON INTENSIFIED OFF.
ENDIF.
* 前レコードと同じ品目コードは出力しない
*---MODIFY START PSD T.SAITOH 2002/05/17 ---------------------------*
*  IF GF_EXEC_BEF-MATNR <> GF_EXEC_TMP-MATNR.
IF G_FLG_MATNR = CNS_X.
*---MODIFY END   PSD T.SAITOH 2002/05/17 ---------------------------*
*   保管場所種別フラグを初期化
*---DELETE START PSD T.SAITOH 2002/05/17 ---------------------------*
*    CLEAR FLG_LGORT_BREAK.
*---DELETE END   PSD T.SAITOH 2002/05/17 ---------------------------*

*    WRITE: /1(18)  GF_EXEC_TMP-MATNR,
**           21(10)  GF_EXEC_TMP-MPTRN,
*           21(30)  GF_EXEC_TMP-MAKTX.
*    WRITE: 53(10)  GF_EXEC_TMP-LGORT,
*           65(20)  GF_EXEC_TMP-LNAME,
*           87(10)  GF_EXEC_TMP-LGPBE,
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
WRITE: /1(03)  GF_EXEC_TMP-EKGRP,
8(18)  GF_EXEC_TMP-MATNR,
*           21(10)  GF_EXEC_TMP-MPTRN,
28(30)  GF_EXEC_TMP-MAKTX.
WRITE: 60(10)  GF_EXEC_TMP-LGORT,
72(20)  GF_EXEC_TMP-LNAME,
93(05)  GF_EXEC_TMP-LGPBE,
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
99(13)  GF_EXEC_TMP-NUM
*          99(10)  GW_NUM
.
ELSE.
WRITE  /1(1)   SPACE.
*    WRITE: 53(10)  GF_EXEC_TMP-LGORT,
*           65(20)  GF_EXEC_TMP-LNAME,
*           87(10)  GF_EXEC_TMP-LGPBE,
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
WRITE: 60(10)  GF_EXEC_TMP-LGORT,
72(20)  GF_EXEC_TMP-LNAME,
93(05)  GF_EXEC_TMP-LGPBE,
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
99(13)  GF_EXEC_TMP-NUM
*          99(10)  GW_NUM
.
ENDIF.

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (OFF)
WRITE 153(1) SPACE.
FORMAT COLOR OFF.
ENDIF.

ENDFORM.                    " FRM_WRITE_DETAIL
*&---------------------------------------------------------------------*
*&      Form  FRM_WRITE_DETAIL_MPTRN1
*&---------------------------------------------------------------------*
*       明細：保管場所種別＝１：自社在庫出力
*----------------------------------------------------------------------*
FORM FRM_WRITE_DETAIL_MPTRN1.
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (BLUE)
FORMAT COLOR COL_HEADING ON INTENSIFIED OFF.
ENDIF.
* 前レコードと同じ品目コードでないか
* 保管場所種別が１の最後の場合は出力
*---MODIFY START PSD T.SAITOH 2002/05/17 ---------------------------*
*  IF GF_EXEC_BEF-MATNR <> GF_EXEC_TMP-MATNR OR
*     FLG_LGORT_BREAK = CNS_X.
* 複数保管場所対応（念のため）業務上はありえないが
* システム的にはありえるため
IF G_FLG_MATNR <> SPACE.
*---MODIFY END   PSD T.SAITOH 2002/05/17 ---------------------------*

*   保管場所種別フラグを初期化
*---DELETE START PSD T.SAITOH 2002/05/17 ---------------------------*
*   CLEAR FLG_LGORT_BREAK.
*---MODIFY END   PSD T.SAITOH 2002/05/17 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/05/17 ---------------------------*
* 複数保管場所対応（念のため）業務上はありえないが
* システム的にはありえるため
CLEAR: G_FLG_MATNR.
*---APPEND END   PSD T.SAITOH 2002/05/17 ---------------------------*
*    WRITE: /1(18)  GF_EXEC_TMP-MATNR,
*          21(10)  GF_EXEC_TMP-MPTRN,
*           21(30)  GF_EXEC_TMP-MAKTX.
*    WRITE: 53(10)  GF_EXEC_TMP-LGORT,
*           65(20)  GF_EXEC_TMP-LNAME,
*           87(10)  GW_LGPBE,
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
WRITE: /1(03)  GF_EXEC_TMP-EKGRP,
8(18)  GF_EXEC_TMP-MATNR,
*          21(10)  GF_EXEC_TMP-MPTRN,
28(30)  GF_EXEC_TMP-MAKTX.
WRITE: 60(10)  GF_EXEC_TMP-LGORT,
72(20)  GF_EXEC_TMP-LNAME,
93(05)  GW_LGPBE,
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
99(13)  GW_NUM
.
ELSE.
WRITE  /1(1)   SPACE.
*    WRITE: 53(10)  GF_EXEC_TMP-LGORT,
*           65(20)  GF_EXEC_TMP-LNAME,
*           87(10)  GW_LGPBE,
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
WRITE: 60(10)  GF_EXEC_TMP-LGORT,
72(20)  GF_EXEC_TMP-LNAME,
93(05)  GW_LGPBE,
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
99(13)  GW_NUM
.
ENDIF.
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (OFF)
WRITE 153(1) SPACE.
FORMAT COLOR OFF.
ENDIF.

ENDFORM.                    " FRM_WRITE_DETAIL_MPTRN1
*&---------------------------------------------------------------------*
*&      Form  FRM_DETAIL_TOTAL
*&---------------------------------------------------------------------*
*       明細合計出力
*----------------------------------------------------------------------*
FORM FRM_DETAIL_TOTAL.

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (BLUE)
FORMAT COLOR COL_TOTAL ON INTENSIFIED OFF.
ENDIF.
WRITE:  /1(1)  SPACE,
*         053(4)  TEXT-064,         "合計
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
060(4)  TEXT-064,         "合計
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
099(13) GF_EXEC_TMP-LBKUM,"在庫合計
114(3)  GF_EXEC_TMP-MEINS,"単位
120(15) GF_EXEC_TMP-UNTCT,"単価
136(16) GF_EXEC_TMP-SALK3."在庫金額

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (OFF)
WRITE 153(1) SPACE.
FORMAT COLOR OFF.
ENDIF.
WRITE:/.

*   総合計の計算
GW_TOTAL = GW_TOTAL + GF_EXEC_TMP-SALK3.

ENDFORM.                    " FRM_DETAIL_TOTAL
*&---------------------------------------------------------------------*
*&      Form  FRM_ALL_TOTAL
*&---------------------------------------------------------------------*
*       総合計
*----------------------------------------------------------------------*
FORM FRM_ALL_TOTAL.
* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (BLUE)
FORMAT COLOR COL_TOTAL ON INTENSIFIED.
ENDIF.
WRITE:  /1(1)  SPACE.
*  WRITE:/053(6)  TEXT-065,         "総合計
*---MODIFY START   PSD H.HARUKI 2002/09/21 ---------------------------*
WRITE:/060(6)  TEXT-065,         "総合計
*---MODIFY END    PSD H.HARUKI 2002/09/21 ---------------------------*
136(16) GW_TOTAL.         "在庫金額

* 色設定
IF PR_COLR = CNS_X.
*   COLOR SET (OFF)
WRITE 153(1) SPACE.
FORMAT COLOR OFF.
ENDIF.

WRITE:/.
MOVE : GW_TOTAL TO GF_EXEC-TOTAL .
MODIFY GT_EXEC FROM GF_EXEC
TRANSPORTING TOTAL WHERE BUKRS EQ GF_EXEC-BUKRS
AND  BWKEY EQ GF_EXEC-BWKEY .

CLEAR GW_TOTAL.                  "総合計を初期化

ENDFORM.                    " FRM_ALL_TOTAL
*&---------------------------------------------------------------------*
*&      Form  FRM_CURRENCY_AMOUNT
*&---------------------------------------------------------------------*
*       金額変換処理
*----------------------------------------------------------------------*
*      -->P_WAERS    通貨コード
*      -->P_BEFORE   変換前金額
*      <--P_AFTER    変換後金額
*----------------------------------------------------------------------*
FORM FRM_CURRENCY_AMOUNT             USING    P_WAERS
P_BEFORE
CHANGING P_AFTER.
DATA L_IDOC_AMOUNT(255) TYPE C.
*--- 汎用モジュール金額変換モジュール
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = P_WAERS
SAP_AMOUNT  = P_BEFORE
IMPORTING
IDOC_AMOUNT = L_IDOC_AMOUNT
EXCEPTIONS
OTHERS      = 1.
IF SY-SUBRC <> 1.
P_AFTER = L_IDOC_AMOUNT.
ENDIF.

ENDFORM.                    " FRM_CURRENCY_AMOUNT
*---INSERT START   PSD H.HARUKI 2002/09/20 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  ekgrp_get
*&---------------------------------------------------------------------*
*  評価在庫内部テーブルより購買グループを取得
*----------------------------------------------------------------------*
*  l_ekgrp_flg : 購買グループが範囲内 = '0'
*                              範囲外 = '1'
*----------------------------------------------------------------------*
FORM EKGRP_GET .
SELECT SINGLE
EKGRP
FROM   MARC
INTO G_SAVE_EKGRP
WHERE  MATNR   = GF_MBEW-MATNR
AND  WERKS   = GF_MBEW-BWKEY
AND EKGRP IN S_EKGRP .

ENDFORM.                    " ekgrp_get
*---INSERT END     PSD H.HARUKI 2002/09/20 ---------------------------*
*---INSERT START  NDSC R.HATA   2002/11/18 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  ekgrp_get
*&---------------------------------------------------------------------*
*  評価在庫内部テーブルより購買グループを取得
*----------------------------------------------------------------------*
*  l_ekgrp_flg : 購買グループが範囲内 = '0'
*                              範囲外 = '1'
*----------------------------------------------------------------------*
FORM PERIOD_GET .
CALL FUNCTION 'DATE_TO_PERIOD_CONVERT'
EXPORTING
I_DATE         = SY-DATUM
I_PERIV        = 'V3'
IMPORTING
E_BUPER        = W_BUPER
E_GJAHR        = W_GJAHR
EXCEPTIONS
INPUT_FALSE    = 1
T009_NOTFOUND  = 2
T009B_NOTFOUND = 3
OTHERS         = 4.
IF SY-SUBRC NE 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM .                   " ekgrp_get
*---INSERT START  NDSC R.HATA   2002/11/18 ---------------------------*

*&---------------------------------------------------------------------*
*&      Form  FRM_CHK_FILE
*&---------------------------------------------------------------------*
*       2003/07/22 ADD
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_CHK_FILE.
* Mod ES-UP 2012/08/15 -->
*  CALL FUNCTION 'WS_FILENAME_GET'
*    EXPORTING
**       DEF_FILENAME           = ' '
**       DEF_PATH               = ' '
*     MASK                   = '*.*,ALL Files,*.*. '
*     MODE                   = 'S'
*     TITLE                  = '期末残高一覧表'
*    IMPORTING
*     FILENAME               = P_FILE
**       RC                     =
*    EXCEPTIONS
*      OTHERS                 = 5
*            .
*  IF SY-SUBRC <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*  ENDIF.
** ↑
DATA: L_FILENAME    TYPE STRING,
L_PATH        TYPE STRING,
L_FULLPATH    TYPE STRING,
**** START ADD 2014/09/26 ISID11 ****
L_TITLE       TYPE STRING,
**** END ADD 2014/09/26 ISID11 ****
L_USER_ACTION TYPE I.

**** START ADD 2014/09/26 ISID11 ****
CLEAR L_TITLE.
L_TITLE = TEXT-101.
**** END ADD 2014/09/26 ISID11 ****
CL_GUI_FRONTEND_SERVICES=>FILE_SAVE_DIALOG(
EXPORTING
**** START UPD 2014/09/26 ISID11 ****
*      WINDOW_TITLE         = '期末残高一覧表'
WINDOW_TITLE         = L_TITLE
**** END UPD 2014/09/26 ISID11 ****
*      DEFAULT_EXTENSION    = DEFAULT_EXTENSION
*      DEFAULT_FILE_NAME    = DEFAULT_FILE_NAME
*      WITH_ENCODING        = WITH_ENCODING
*      FILE_FILTER          = FILE_FILTER
*      INITIAL_DIRECTORY    = INITIAL_DIRECTORY
*      PROMPT_ON_OVERWRITE  = 'X'
CHANGING
FILENAME             = L_FILENAME
PATH                 = L_PATH
FULLPATH             = L_FULLPATH
USER_ACTION          = L_USER_ACTION
*      FILE_ENCODING        = FILE_ENCODING
EXCEPTIONS
CNTL_ERROR           = 1
ERROR_NO_GUI         = 2
NOT_SUPPORTED_BY_GUI = 3
OTHERS               = 4 ).
IF SY-SUBRC = 0
AND L_USER_ACTION = CL_GUI_FRONTEND_SERVICES=>ACTION_OK.
P_FILE = L_FULLPATH.
ENDIF.
* Mod ES-UP 2012/08/15 <--
ENDFORM.                    " FRM_CHK_FILE

*&---------------------------------------------------------------------*
*&      Form  FRM_DATA_DL
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_DATA_DL.
* Mod ES-UP 2012/08/15 -->
*  CALL FUNCTION 'WS_DOWNLOAD'
*   EXPORTING
*     FILENAME                      = P_FILE
*     FILETYPE                      = 'DAT'
*     MODE                          = ' '
**   IMPORTING
**    FILELENGTH                    =
*   TABLES
*     DATA_TAB                      = GT_DL
**    FIELDNAMES                    =
*   EXCEPTIONS
*     FILE_OPEN_ERROR               = 1
*     FILE_WRITE_ERROR              = 2
*     INVALID_FILESIZE              = 3
*     INVALID_TYPE                  = 4
*     NO_BATCH                      = 5
*     UNKNOWN_ERROR                 = 6
*     INVALID_TABLE_WIDTH           = 7
*     GUI_REFUSE_FILETRANSFER       = 8
*     CUSTOMER_ERROR                = 9
*     OTHERS                        = 10
*            .
DATA: L_FILENAME TYPE STRING,
L_CODEPAGE TYPE ABAP_ENCODING.
**** START ADD 2015/02/04 ISID18 ****
DATA L_SAPCODEPAGE TYPE STRING.
L_SAPCODEPAGE = G_OUTPUT_CP.
**** END ADD 2015/02/04 ISID18 ****
L_FILENAME = P_FILE.
**** START UPD 2014/09/01 ISID11 ****
*  L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_SJIS ).
**** START UPD 2015/02/04 ISID18 ****
*  L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_UTF ).
IF L_SAPCODEPAGE IS NOT INITIAL.
L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( L_SAPCODEPAGE ).
ENDIF.
**** END UPD 2015/02/04 ISID18 ****
**** END UPD 2014/09/01 ISID11 ****
CL_GUI_FRONTEND_SERVICES=>GUI_DOWNLOAD(
EXPORTING
*      BIN_FILESIZE              = BIN_FILESIZE
FILENAME                  = L_FILENAME
FILETYPE                  = 'DAT'
*      APPEND                    = SPACE
WRITE_FIELD_SEPARATOR     = ABAP_TRUE
*      HEADER                    = '00'
*      TRUNC_TRAILING_BLANKS     = SPACE
*      WRITE_LF                  = 'X'
*      COL_SELECT                = SPACE
*      COL_SELECT_MASK           = SPACE
*      DAT_MODE                  = SPACE
*      CONFIRM_OVERWRITE         = SPACE
*      NO_AUTH_CHECK             = SPACE
CODEPAGE                  = L_CODEPAGE
*      IGNORE_CERR               = ABAP_TRUE
*      REPLACEMENT               = '#'
*      WRITE_BOM                 = SPACE
*      TRUNC_TRAILING_BLANKS_EOL = 'X'
*      WK1_N_FORMAT              = SPACE
*      WK1_N_SIZE                = SPACE
*      WK1_T_FORMAT              = SPACE
*      WK1_T_SIZE                = SPACE
*      SHOW_TRANSFER_STATUS      = 'X'
*      FIELDNAMES                = FIELDNAMES
*      WRITE_LF_AFTER_LAST_LINE  = 'X'
*    IMPORTING
*      FILELENGTH                = FILELENGTH
CHANGING
DATA_TAB                  = GT_DL
EXCEPTIONS
FILE_WRITE_ERROR          = 1
NO_BATCH                  = 2
GUI_REFUSE_FILETRANSFER   = 3
INVALID_TYPE              = 4
NO_AUTHORITY              = 5
UNKNOWN_ERROR             = 6
HEADER_NOT_ALLOWED        = 7
SEPARATOR_NOT_ALLOWED     = 8
FILESIZE_NOT_ALLOWED      = 9
HEADER_TOO_LONG           = 10
DP_ERROR_CREATE           = 11
DP_ERROR_SEND             = 12
DP_ERROR_WRITE            = 13
UNKNOWN_DP_ERROR          = 14
ACCESS_DENIED             = 15
DP_OUT_OF_MEMORY          = 16
DISK_FULL                 = 17
DP_TIMEOUT                = 18
FILE_NOT_FOUND            = 19
DATAPROVIDER_EXCEPTION    = 20
CONTROL_FLUSH_ERROR       = 21
NOT_SUPPORTED_BY_GUI      = 22
ERROR_NO_GUI              = 23
OTHERS                    = 24 ).
* Mod ES-UP 2012/08/15 <--
IF SY-SUBRC = 0.
**** START UPD 2014/09/26 ISID11 ****
*    MESSAGE   S400(Z1) WITH 'ダウンロードに成功しました'.
MESSAGE   S045(Z3).
**** END UPD 2014/09/26 ISID11 ****
ELSE.
**** START UPD 2014/09/26 ISID11 ****
*    MESSAGE  E400(Z1) WITH 'ダウンロードできませんでした'.
MESSAGE  E046(Z3).
**** END UPD 2014/09/26 ISID11 ****
ENDIF.

ENDFORM.                    " FRM_DATA_DL

*---------------------------------------------------------------------*
*       FORM FRM_CHAR_EDIT                                            *
*---------------------------------------------------------------------*
*       ........                                                      *
*---------------------------------------------------------------------*
FORM FRM_CHAR_EDIT.
DATA : L_LGORT LIKE GF_EXEC-LGORT ,
L_MATNR LIKE GF_EXEC-MATNR ,
L_FLAG(1) TYPE C ,
L_NUM   LIKE GF_EXEC-NUM .
* Mod 2003/11/05 >>>
MOVE 'X' TO L_FLAG .
LOOP AT GT_EXEC INTO GF_EXEC.
IF  GF_EXEC-MATNR NE L_MATNR
AND L_FLAG NE 'X' .
*      Write : L_NUM   TO GF_DL-NUM  .
APPEND  GF_DL TO GT_DL .
CLEAR :  GF_DL , L_NUM .
ENDIF .

MOVE :
*           GF_EXEC-BUKRS TO GF_DL-BUKRS,    "CHAR型の項目
*           GF_EXEC-BWKEY TO GF_DL-BWKEY,
GF_EXEC-MATNR TO GF_DL-MATNR,
*           GF_EXEC-MPTRN TO GF_DL-MPTRN,
*           GF_EXEC-LGORT TO GF_DL-LGORT,
*           GF_EXEC-LFGJA TO GF_DL-LFGJA,
*           GF_EXEC-LFMON TO GF_DL-LFMON,
GF_EXEC-MAKTX TO GF_DL-MAKTX,
**** START UPD 2014/09/26 ISID11 ****
*           '合計'
TEXT-104
**** END UPD 2014/09/26 ISID11 ****
TO GF_DL-GOKEI ,
*           GF_EXEC-BUTXT TO GF_DL-BUTXT,
*           GF_EXEC-PNAME TO GF_DL-PNAME,
*           GF_EXEC-LNAME TO GF_DL-LNAME,
GF_EXEC-LGPBE TO GF_DL-LGPBE,
GF_EXEC-MEINS TO GF_DL-MEINS,
*           GF_EXEC-WAERS TO GF_DL-WAERS,
GF_EXEC-EKGRP TO GF_DL-EKGRP.

*    Add GF_EXEC-NUM To L_NUM .
WRITE :
*            GF_EXEC-NUM   TO GF_DL-NUM  ,    "CHAR以外
GF_EXEC-UNTCT TO GF_DL-UNTCT,
GF_EXEC-SALK3 TO GF_DL-SALK3,
GF_EXEC-LBKUM TO GF_DL-LBKUM.
*            GF_EXEC-TOTAL TO GF_DL-TOTAL.
CLEAR L_FLAG .
MOVE : GF_EXEC-MATNR TO L_MATNR .
* Mod 2003/11/05 <<<
ENDLOOP.
APPEND  GF_DL TO GT_DL .
CLEAR   GF_DL .

ENDFORM.                    " FRM_CHAR_EDIT

* Add 2003.09.02 >>>>>
*&---------------------------------------------------------------------*
*&      Form  FRM_DATA_TRANSFER
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_DATA_TRANSFER .
* Mod ES-UP 2012/08/15 -->
*  DATA : W_LINE(1000) TYPE C ,
*         W_TAB TYPE X VALUE '09' .
* Mod ES-UP 2012/10/29 -->
*  DATA : W_LINE(1000) TYPE C ,
DATA : W_LINE TYPE STRING.
* Mod ES-UP 2012/10/29 <--

**** START DEL 2014/09/05 ISID19 ****
*         L_CODEPAGE TYPE ABAP_ENCODING.
**** END DEL 2014/09/05 ISID19 ****

**** START UPD 2014/09/01 ISID11 ****
*  L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_SJIS ).
** Mod ES-UP 2012/08/15 <--
** Mod ES-UP 2012/08/15 -->
**  OPEN DATASET P_FILE FOR OUTPUT IN TEXT MODE .
*  OPEN DATASET P_FILE FOR OUTPUT
*    IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
*    IGNORING CONVERSION ERRORS.
** Mod ES-UP 2012/08/15 <--
**** START ADD 2015/02/04 ISID18 ****
DATA L_SAPCODEPAGE TYPE STRING.
DATA L_CODEPAGE    TYPE ABAP_ENCODING.
L_SAPCODEPAGE = G_OUTPUT_CP.
IF L_SAPCODEPAGE IS NOT INITIAL.
L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( L_SAPCODEPAGE ).
ENDIF.
IF G_FLGUTF8 IS INITIAL.
TRY.
OPEN DATASET P_FILE FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
IGNORING CONVERSION ERRORS.
CATCH CX_SY_CODEPAGE_CONVERTER_INIT.
SY-SUBRC = 8.
ENDTRY.
ELSE.
**** END ADD 2015/02/04 ISID18 ****
**** START UPD 2015/02/04 ISID18 ****
*  OPEN DATASET P_FILE FOR OUTPUT IN TEXT MODE ENCODING UTF-8.
OPEN DATASET P_FILE FOR OUTPUT IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ENDIF.
**** END UPD 2015/02/04 ISID18 ****
**** END UPD 2014/09/01 ISID11 ****

IF SY-SUBRC NE 0 .
**** START UPD 2014/09/26 ISID11 ****
*    MESSAGE S400(Z1) WITH 'ファイルオープンエラー' .
MESSAGE S055(Z3) WITH SPACE.
**** END UPD 2014/09/26 ISID11 ****
STOP .
ENDIF .
CLEAR : GF_DL .
LOOP AT GT_DL INTO GF_DL .
CONCATENATE
* Mod 2003/11/05 Hata >>>
*          GF_DL-bukrs
*          GF_DL-bwkey
*          GF_DL-matnr
*          GF_DL-mptrn
*          GF_DL-lgort
*          GF_DL-lfgja
*          GF_DL-lfmon
*          GF_DL-maktx
*          GF_DL-butxt
*          GF_DL-pname
*          GF_DL-lname
*          GF_DL-lgpbe
*          GF_DL-num
*          GF_DL-meins
*          GF_DL-untct
*          GF_DL-salk3
*          GF_DL-lbkum
*          GF_DL-total
*          GF_DL-waers
*          GF_DL-ekgrp
GF_DL-EKGRP         "購買グループ
GF_DL-MATNR         "品目コード
GF_DL-MAKTX         "品目名
GF_DL-GOKEI         "合計
GF_DL-LGPBE         "棚番
GF_DL-LBKUM         "在庫合計
GF_DL-MEINS         "単位
GF_DL-UNTCT         "単価
GF_DL-SALK3         "在庫金額
* Mod 2003/11/05 Hata <<<
INTO  W_LINE
* Mod ES-UP 2012/08/15 -->
*   SEPARATED BY W_TAB
*   .
SEPARATED BY CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
* Mod ES-UP 2012/08/15 <--
TRANSFER W_LINE TO P_FILE .
CLEAR : GF_DL .
ENDLOOP .
IF SY-SUBRC EQ 0 .
**** START UPD 2014/09/26 ISID11 ****
*    MESSAGE S400(Z1) WITH 'ダウンロードに成功しました'.
MESSAGE S045(Z3).
**** END UPD 2014/09/26 ISID11 ****
ELSE.
**** START UPD 2014/09/26 ISID11 ****
*    MESSAGE E400(Z1) WITH 'ダウンロードできませんでした'.
MESSAGE E046(Z3).
**** END UPD 2014/09/26 ISID11 ****
ENDIF.
ENDFORM .                    "FRM_DATA_TRANSFER
* Add 2003.09.02 <<<<<
*&---------------------------------------------------------------------*
*&      Form  FRM_SEL_MARD
*&---------------------------------------------------------------------*
*       MARDから棚番を取得する
*----------------------------------------------------------------------*
FORM FRM_SEL_MARD.

* 指定会計期間以降のデータの棚番を取得
SELECT  LGPBE
FROM  MARD
UP  TO 1 ROWS
INTO  W_LGPBE
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  ( ( LFGJA   = PR_LFGJA   AND
LFMON   > PR_LFMON ) OR
( LFGJA   > PR_LFGJA ) ).
ENDSELECT.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
EXIT.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

* 指定会計期間以降のデータが取得できなかった場合、
* 指定会計期間以前のデータの棚番を取得
SELECT  LGPBE
FROM  MARD
UP  TO 1 ROWS
INTO  W_LGPBE
WHERE  MATNR   = GF_MBEW_EXEC-MATNR
AND  WERKS   = GF_MBEW_EXEC-BWKEY
AND  ( ( LFGJA   = PR_LFGJA   AND
LFMON   < PR_LFMON ) OR
( LFGJA   < PR_LFGJA ) ).
ENDSELECT.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE A603(Z1) WITH SY-REPID
CNS_MARD
SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SEL_MARD
*---INSERT START   DMK K.KAJISA 2010/04/22 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_DELETE_ZM0010
*&---------------------------------------------------------------------*
*       アドオンテーブルの削除
*----------------------------------------------------------------------*
FORM FRM_DELETE_ZM0010.
DELETE FROM ZM0010 WHERE LFGJA = PR_LFGJA  "会計年度
AND LFMON = PR_LFMON  "会計期間
AND BUKRS = PR_BUKRS  "会社コード
**** START UPD 2014/09/26 ISID11 ****
*                       AND BWKEY IN S_WERKS  "プラント
AND BWKEY IN GT_RNG_WERKS  "プラント
**** END UPD 2014/09/26 ISID11 ****
AND MATNR IN S_MATNR. "品目コード
* 削除成功 or 対象なし
IF SY-SUBRC = 0 OR SY-SUBRC = 4.
EXIT.
* 異常事態
ELSE.
*   テーブルの更新でエラーが発生しました
MESSAGE E639(Z1).
ENDIF.
ENDFORM.                    " FRM_DELETE_ZM0010
*&---------------------------------------------------------------------*
*&      Form  FRM_INSERT_ZM0010
*&---------------------------------------------------------------------*
*       アドオンテーブル新規登録
*----------------------------------------------------------------------*
FORM FRM_INSERT_ZM0010.
DATA : L_LGORT LIKE GF_EXEC-LGORT ,
L_MATNR LIKE GF_EXEC-MATNR ,
L_FLAG(1)     TYPE C,
L_CNT         TYPE I,
L_CNT_C(20)   TYPE C.

DATA:LF_EXEC_OLD     TYPE TYP_ZM011000.
DATA:LT_EXEC         TYPE STANDARD TABLE OF TYP_ZM011000.

REFRESH: GT_ZM0010,LT_EXEC.
CLEAR:   GF_ZM0010,LF_EXEC_OLD.

* 合計行排除
LT_EXEC[] = GT_EXEC.
*---Modify START   GSL Y.Hayakawa 2013/05/23-----------------------*
* レポート表示データから、以下キーの重複行を削除して、アドオンテーブル
* 対象データを残す
* ＜キー項目＞会社コード/評価レベル（プラント）/品目コード
*  DELETE LT_EXEC WHERE MPTRN <> '1'.

DELETE ADJACENT DUPLICATES FROM LT_EXEC
COMPARING BUKRS
BWKEY
MATNR
**** START ADD 2015/03/24 ISID12 ****
LGORT.
**** END ADD 2015/03/24 ISID12 ****
*---Modify END     GSL Y.Hayakawa 2013/05/23-----------------------*
*
LOOP AT LT_EXEC INTO GF_EXEC.
IF GF_EXEC-MATNR <> LF_EXEC_OLD-MATNR  "品目
OR GF_EXEC-LGORT <> LF_EXEC_OLD-LGORT  "保管場所
OR GF_EXEC-LGPBE <> LF_EXEC_OLD-LGPBE. "棚番変わるごとに格納

**** START ADD 2015/03/24 ISID12 ****
GF_EXEC-SALK3 = GF_EXEC-NUM * GF_EXEC-UNTCT.
**** END ADD 2015/03/24 ISID12 ****
CLEAR:GF_ZM0010 .
MOVE:
SY-MANDT      TO GF_ZM0010-MANDT, "クライアント
PR_LFGJA      TO GF_ZM0010-LFGJA, "会計年度
PR_LFMON      TO GF_ZM0010-LFMON, "会計期間
GF_EXEC-BUKRS TO GF_ZM0010-BUKRS, "会社コード
GF_EXEC-BWKEY TO GF_ZM0010-BWKEY, "プラント
GF_EXEC-LGORT TO GF_ZM0010-LGORT, "保管場所
GF_EXEC-MATNR TO GF_ZM0010-MATNR, "品目コード
GF_EXEC-EKGRP TO GF_ZM0010-EKGRP, "購買グループ
GF_EXEC-MAKTX TO GF_ZM0010-MAKTX, "品目テキスト
GF_EXEC-LGPBE TO GF_ZM0010-LGPBE, "棚番
GF_EXEC-MEINS TO GF_ZM0010-MEINS, "単位
GF_EXEC-WAERS TO GF_ZM0010-WAERS, "通貨
SY-DATUM      TO GF_ZM0010-ERDAT, "登録日
SY-UZEIT      TO GF_ZM0010-ERZET, "登録時刻
SY-UNAME      TO GF_ZM0010-ERNAM, "登録者
**** START UPD 2015/03/24 ISID12 ****
*        GF_EXEC-LBKUM TO GF_ZM0010-LBKUM, "在庫合計
GF_EXEC-NUM   TO GF_ZM0010-LBKUM, "在庫合計
**** END UPD 2015/03/24 ISID12 ****
GF_EXEC-UNTCT TO GF_ZM0010-UNTCT, "単価
GF_EXEC-SALK3 TO GF_ZM0010-SALK3. "在庫金額
APPEND  GF_ZM0010 TO GT_ZM0010 .
ENDIF.
LF_EXEC_OLD = GF_EXEC.
ENDLOOP.

IF GT_ZM0010[] IS INITIAL.
*   処理対象データがありません
MESSAGE S204(Z1).
ELSE.
INSERT ZM0010 FROM TABLE GT_ZM0010
ACCEPTING DUPLICATE KEYS.
*   更新成功時は、Iメッセージで件数出力してCOMMIT
IF SY-SUBRC = 0.
COMMIT WORK.
DESCRIBE TABLE  GT_ZM0010 LINES L_CNT.
WRITE L_CNT TO L_CNT_C.
CONDENSE L_CNT_C NO-GAPS.
*     &件のデータを更新しました
MESSAGE I200(Z1) WITH L_CNT_C.

*   更新エラー時は、EメッセージでROLLBACK
ELSE.
ROLLBACK  WORK.
*     テーブルの更新でエラーが発生しました
MESSAGE E639(Z1).
ENDIF.
ENDIF.
ENDFORM.                    " FRM_INSERT_ZM0010
*---INSERT END     DMK K.KAJISA 2010/04/22 ---------------------------*
**** START ADD 2015/02/04 ISID18 ****
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_CPAGE
*&---------------------------------------------------------------------*
*       コードページ取得
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM FRM_GET_CPAGE .

CLEAR:
G_OUTPUT_CP,
G_FLGUTF8.

CALL FUNCTION 'ZEG_ZZ_GLOBAL_PGM_CONFIG_GET'
EXPORTING
IMPPGM      = SY-REPID
IMPBUKRS    = PR_BUKRS
IMPORTING
EXPCODEPAGE = G_OUTPUT_CP
EXPFLGUTF8  = G_FLGUTF8.

ENDFORM.                    " FRM_GET_CPAGE
**** END ADD 2015/02/04 ISID18 ****
*Text symbol text・
*001:Fis.Per.
*002:Year
*003:Per.
*004:[0]
*005:Fiscal Period
*006:Company CD
*007:Plant Code
*050:Company CD
*051:Plant
*052:Fis.Per.
*053:Year
*054:Per.
*055:Mat. Code
*056:Mat.NM
*057:St.Loc.
*058:St.Loc.NM
*059:Bin
*060:Qty
*061:Unit
*062:Pri.
*063:SP value
*064:Sum.
*065:To.Sum
*066:―――――
*067:――――
*068:――
*069:Page
*070:Option Setting
*071:(Trans.)
*091:Pur.Gr
*092:Pur.Group
*100:**Clo. Bal. List**
*101:Clo. Bal. List
*102:Pro.Date
*103:Pro.Time
*104:Sum
*Selection text・
*PR_BUKRS:        Company Code
*PR_COLR:        Color Display
*PR_LFGJA:        Fiscal Year
*PR_LFMON:        Fiscal Period
*PR_PAGE:        Page No. Display
*P_FILE:        Output File Name
*P_LOCAL:        Local PC
*P_SERVE:        Service
*R_DB:        Insert Addon Table
*R_DOWN:        Download Data
*R_NOT:        Not Download
*S_EKGRP:        Purchasing Group
*S_MATNR:        Material Code
*S_WERKS:        Plant
