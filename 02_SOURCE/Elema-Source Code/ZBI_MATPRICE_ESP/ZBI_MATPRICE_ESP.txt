************************************************************************
** Program ID     : ZBI_MATPRICE_ESP
** Program Detail : 品目単価(購買、スケール)
** Author         : NTT DATA SOLFIS
** Creation Date  : 2009.12.02
**
** Modifications  :
** Date        Author        Description
** yyyy.mm.dd  xxxxxxxxxxxx  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
**
** yyyy.mm.dd  xxxxxxxxxxxx  xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
************************************************************************
REPORT ZBI_MATPRICE_ESP.

******************************
* DATA
******************************
* 構造定義 Tr-cd:SE11 ZSBI0022
DATA:
IT_DATA  TYPE STANDARD TABLE OF ZSBI0022,
ZSBI0022 TYPE ZSBI0022.

FIELD-SYMBOLS:
<WA> TYPE ZSBI0022.

* 品目購買情報(プラント別)[A071]の検索条件
DATA:
WA_EINA TYPE EINA,
WA_EINE TYPE EINE,
V_KAPPL TYPE A071-KAPPL,
V_KSCHL TYPE A071-KSCHL,
V_DATBI TYPE A071-DATBI,
V_DATAB TYPE A071-DATAB.

* 条件(明細)[KONP]、条件(一次元の数量スケール)[KONM]の取得
TYPES:
BEGIN OF TY_KONP,
KNUMH TYPE A017-KNUMH,
KOPOS TYPE KONP-KOPOS,
KONWA TYPE KONP-KONWA,
KPEIN TYPE KONP-KPEIN,
KMEIN TYPE KONP-KMEIN,
KBETP TYPE KONP-KBETR,
KSTBM TYPE KONM-KSTBM,
KBETM TYPE KONM-KBETR,
END   OF TY_KONP.
DATA:
IT_EINA TYPE STANDARD TABLE OF ZSBI0022,
IT_A017 TYPE STANDARD TABLE OF A017,
WA_A017 TYPE A017,
IT_KONP TYPE STANDARD TABLE OF TY_KONP,
WA_KONP TYPE TY_KONP.

******************************
* PARAMETERS & SELECT-OPTIONS
******************************
SELECT-OPTIONS:
S_INFNR FOR WA_EINA-INFNR MEMORY ID INF, "購買情報番号
S_MATNR FOR WA_EINA-MATNR MEMORY ID MAT, "品目コード
S_LIFNR FOR WA_EINA-LIFNR MEMORY ID LIF, "仕入先勘定コード
S_WERKS FOR WA_EINE-WERKS MEMORY ID WRK, "プラント
S_EKGRP FOR WA_EINE-EKGRP MEMORY ID EKG, "購買グループ
S_KAPPL FOR V_KAPPL,                     "アプリケーション
S_KSCHL FOR V_KSCHL,                     "条件タイプ
S_DATBI FOR V_DATBI,                     "条件マスタ有効終了日
S_DATAB FOR V_DATAB.                     "条件マスタ有効開始日

*&---------------------------------------------------------------------*
* Tr-cd:SQ02 インフォタイプ生成の際、下記のコメントがないとエラー発生
*&---------------------------------------------------------------------*
* <Query_head>
*----------------------------------------------------------------------*

* 購買情報:一般データ[EINA]、購買情報:購買組織データ[EINE]の取得
SELECT EINA~INFNR EINA~MATNR EINA~LIFNR
EINE~EKORG EINE~ESOKZ EINE~WERKS EINE~EKGRP EINE~NETPR
EINE~WAERS EINE~PEINH EINE~BPRME EINE~EFFPR
INTO TABLE IT_EINA
FROM EINA INNER JOIN EINE
ON EINA~INFNR = EINE~INFNR
WHERE EINA~INFNR IN S_INFNR
AND EINA~LIFNR IN S_LIFNR
AND EINA~MATNR IN S_MATNR
AND EINE~EKGRP IN S_EKGRP
AND EINE~WERKS IN S_WERKS.

* 品目購買情報(プラント別)[A017]の取得
LOOP AT IT_EINA INTO ZSBI0022.
CLEAR:IT_A017, WA_A017.
SELECT *
INTO TABLE IT_A017
FROM A017
WHERE KAPPL IN S_KAPPL
AND KSCHL IN S_KSCHL
AND LIFNR =  ZSBI0022-LIFNR
AND MATNR =  ZSBI0022-MATNR
AND EKORG =  ZSBI0022-EKORG
AND WERKS =  ZSBI0022-WERKS
AND ESOKZ =  ZSBI0022-ESOKZ
AND DATBI IN S_DATBI
AND DATAB IN S_DATAB.
IF SY-SUBRC <> 0.
APPEND ZSBI0022 TO IT_DATA.
CONTINUE.
ENDIF.

* 品目単価(購買、スケール)の内部テーブルにセット
LOOP AT IT_A017 INTO WA_A017.
ZSBI0022-KAPPL = WA_A017-KAPPL.
ZSBI0022-KSCHL = WA_A017-KSCHL.
ZSBI0022-DATBI = WA_A017-DATBI.
ZSBI0022-DATAB = WA_A017-DATAB.
ZSBI0022-KNUMH = WA_A017-KNUMH.

*   条件(明細)[KONP]、条件(一次元の数量スケール)[KONM]の取得
CLEAR:IT_KONP, WA_KONP.
SELECT KONP~KNUMH KONP~KOPOS KONP~KONWA
KONP~KPEIN KONP~KMEIN KONP~KBETR
KONM~KSTBM KONM~KBETR
INTO TABLE IT_KONP
FROM KONP INNER JOIN KONM
ON KONP~KNUMH = KONM~KNUMH
AND KONP~KOPOS = KONM~KOPOS
WHERE KONP~KNUMH = WA_A017-KNUMH.
IF SY-SUBRC <> 0.
APPEND ZSBI0022 TO IT_DATA.
CONTINUE.
ENDIF.

*   品目単価(購買、スケール)の内部テーブルにセット
LOOP AT IT_KONP INTO WA_KONP.
ZSBI0022-KOPOS     = WA_KONP-KOPOS.
ZSBI0022-KONWA     = WA_KONP-KONWA.
ZSBI0022-KPEIN     = WA_KONP-KPEIN.
ZSBI0022-KMEIN     = WA_KONP-KMEIN.
ZSBI0022-KONPKBETR = WA_KONP-KBETP.
ZSBI0022-KSTBM     = WA_KONP-KSTBM.
ZSBI0022-KONMKBETR = WA_KONP-KBETM.

APPEND ZSBI0022 TO IT_DATA.
ENDLOOP.
ENDLOOP.
ENDLOOP.

LOOP AT IT_DATA ASSIGNING <WA>.
MOVE-CORRESPONDING <WA> TO ZSBI0022.
* Tr-cd:SQ02 インフォタイプ生成の際、下記のコメントがないとエラー発生
* <Query_body>
ENDLOOP.
