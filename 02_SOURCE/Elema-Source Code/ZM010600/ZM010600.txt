************************************************************************
* [プログラム名]
*   ZM010600       注文書
*
* [処理概要]
*   ・処理対象の出力レコードもしくは発注伝票/入庫伝票を基に、
* 　　各種伝票やマスタからデータを抽出し、タブ区切りテキスト
*     ファイルに格納する
* [改定履歴]
*　YYYY/MM/DD  Programar         Description
*  2001/01/17  PSD K.Usami       新規開発
*  2002/02/14  PSD M.Arai        手配先範囲指定不具合対応
*  2002/02/15  PSD M.Arai        プリンタ/トレイ設定不具合対応
*  2002/02/20  PSD K.Usami       発注単価の設定方法の変更
*  2002/02/20  PSD K.Usami       通貨の設定
*  2002/02/20  PSD K.Usami       NASTのロック条件の変更
*  2002/02/22  PSD K.Usami       取消伝票・発注外運送費伝票取扱変更
*  2002/02/22  PSD K.Usami       エラーメッセージの変更
*  2002/02/22  PSD K.Usami       入出庫伝票番号の入力チェック変更
*  2002/02/25  PSD K.Usami       個別購買の場合の品目コードの設定
*  2002/02/25  PSD K.Usami       手配先担当者名/電話番号/FAX番号の設定
*  2002/03/07  PSD T.SAITOH      NASTの重複更新を回避
*  2002/03/14  PSD M.ARAI        プラント・購買グループのデフォルト設定
*  2002/04/02  PSD T.SAITOH      同一オブジェクトキーNASTレコード時
*                                ブレイクしていたのを廃止
*  2002/04/02  PSD T.SAITOH      変更取消区分抽出に関わるバグ対応
*  2002/04/02  PSD T.SAITOH      返品明細が'x'のとき帳票名’返品伝票’
*                                としていた判断を廃止
*  2002/04/03  PSD T.SAITOH      金額項目追加（仕様変更）
*  2002/04/03  PSD T.SAITOH      NAST更新エラーバグ対応(通常出力時）
*                                登録日、登録時間を考慮
*  2002/04/03  PSD T.SAITOH      更新記録用内部テーブルにて二重更新
*                       　　　　 をさせないように修正
*  2002/04/03  PSD T.SAITOH      依頼納期条件追加（仕様変更）
*  2002/04/08  PSD T.SAITOH      手配先住所の不具合対応
*  2002/05/13  PSD K.ARAI        「金額」項目へのセット項目変更
*  2002/06/20  PSD T.SAITOH      再移送
*  2002/07/04  PSD T.IIDA        備考データより出荷指示を抜出し別編集
*  2002/07/09  PSD T.SAITOH      購買組織追加
*  2002/07/23  PSD T.SAITOH      変なチェック場所変更
*  2002/07/28  PSD T.SAITOH      納入場所の名称取得項目変更
*  2002/08/04  PSD T.SAITOH      ロック場所変更
*  2002/08/04  PSD T.SAITOH      バグ修正詳細は下記↓
*                  プリンタ/トレイ未取得伝票変数設定後の取得レコードが全
*                  エラー対象レコードとなるバグを修正
*  2002/08/05  PSD T.SAITOH      明細出力桁数を１桁とする対応
*  2002/08/06  PSD T.SAITOH      品目コードに関する変更
*  2002/08/07  PSD T.SAITOH      再出力時：パフォーマンス対応
*  2002/09/22  PSD H.HARUKI      NAST  SELECT条件に
*                  AKTV(アクティビティフラグ)＝SPACE　を追加
*  2003/04/25  NDSC S.IWAKI      パフォーマンス対応
*  2004/04/22  NDSC A.MASUDA     納入場所(住所)に都道府県のﾃﾞｰﾀを追加
*                                出力項目に仕入先コードを追加
*  2005/02/25  DMC  A.MASUDA     担当者名の追加
*  2005/06/22  DMC  A.MASUDA     担当者名の追加の仕様変更
*  2006/11/14  NDSC M.IKEDA      得意先発注番号の追加
*  2006/12/04  NDSC M.IKEDA      証明書テキストの追加
*  2007/12/25  DMC R.HATA
*  2009/06/15  NDSC N.SHIOJIMA   エンドユーザー指定時の注文書出力修正
*& 2012/08/21  ISID              ES-UP
*  2014/09/01  ISID11            コードページUTF-8の改修
*  2015/01/23  ISID11            コードページの再修正
************************************************************************
REPORT  ZM010600                   .
************************************************************************
* TYPES
************************************************************************
* 購買発注伝票存在チェック型
TYPES: BEGIN OF TYP_CHECK_DENPYOU,
EBELN      TYPE EKPO-EBELN,      " 発注番号
EKGRP      TYPE EKKO-EKGRP,      " 購買グループ
WERKS      TYPE EKPO-WERKS,      " プラント
LIFNR      TYPE EKKO-LIFNR,      " 仕入先コード
END   OF TYP_CHECK_DENPYOU.

* NAST型
TYPES: BEGIN OF TYP_NAST,
KAPPL      TYPE NAST-KAPPL,      " アプリケーション
OBJKY      TYPE NAST-OBJKY,      " 対象キー
KSCHL      TYPE NAST-KSCHL,      " メッセージタイプ
LDEST      TYPE NAST-LDEST,      " 出力デバイス
DATVR      TYPE NAST-DATVR,      " 処理日
UHRVR      TYPE NAST-UHRVR,      " 処理時間
*---APPEND START PSD T.SAITOH 2002/04/03 登録日、登録時間を考慮-------*
ERDAT      TYPE NAST-ERDAT,      " 登録日
ERUHR      TYPE NAST-ERUHR,      " 登録時間
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
END   OF TYP_NAST.
*---INSERT START   PSD H.HARUKI 2002/09/22 ---------------------------*
TYPES: BEGIN OF TYP_NAST_UNIQ,
KAPPL TYPE NAST-KAPPL,  " アプリケーション
OBJKY TYPE NAST-OBJKY," 対象キー
KSCHL TYPE NAST-KSCHL," メッセージタイプ
ERDAT TYPE NAST-ERDAT, " 登録日
ERUHR TYPE NAST-ERUHR," 登録時間
DATVR TYPE NAST-DATVR," 処理日
UHRVR TYPE NAST-UHRVR, " 処理時間
LDEST TYPE NAST-LDEST," 出力デバイス
END OF TYP_NAST_UNIQ.

*---INSERT END     PSD H.HARUKI 2002/09/22 ---------------------------*

* 伝票情報型(発注情報)
TYPES: BEGIN OF TYP_DENPYOU,
BSART      TYPE EKKO-BSART,      " 購買伝票タイプ
RESWK      TYPE EKKO-RESWK,      " 在庫転送オーダーにおける･･･
BEDAT      TYPE EKKO-BEDAT,      " 伝票日付
EKORG      TYPE EKKO-EKORG,      " 購買組織
WAERS      TYPE EKKO-WAERS,      " 伝票通貨
EKGRP      TYPE EKKO-EKGRP,      " 購買グループ
EBELN      TYPE EKPO-EBELN,      " 購買発注番号
EBELP      TYPE EKPO-EBELP,      " 購買発注明細
MATNR      TYPE EKPO-MATNR,      " 品目コード
WERKS      TYPE EKPO-WERKS,      " プラント
IDNLF      TYPE EKPO-IDNLF,      " 仕入先品目コード
MENGE      TYPE EKPO-MENGE,      " 購買発注数量
MEINS      TYPE EKPO-MEINS,      " 発注単位
BPUMZ      TYPE EKPO-BPUMZ,      " 変換分子
BPUMN      TYPE EKPO-BPUMN,      " 変換分母
NETPR      TYPE EKPO-NETPR,      " 正味額(伝票通貨)
PEINH      TYPE EKPO-PEINH,      " 価格単位
KNTTP      TYPE EKPO-KNTTP,      " 勘定設定カテゴリ
EVERS      TYPE EKPO-EVERS,      " 出荷指示
TXZ01      TYPE EKPO-TXZ01,      " テキスト(短)
RETPO      TYPE EKPO-RETPO,      " 返品明細
MTART      TYPE EKPO-MTART,      " 品目タイプ
ADRN2      TYPE EKPO-ADRN2,      " 納入先住所コード
ADRNR      TYPE EKPO-ADRNR,      " 納入先住所コード
*---APPEND START PSD T.SAITOH 2002/04/03 金額-----------------------*
NETWR      TYPE EKPO-NETWR,      " 金額
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 ---------------------------*
ERNAM      TYPE EKKO-ERNAM,      " 登録者
VBELV      TYPE VBFA-VBELV,      " 受注伝票番号
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 ---------------------------*
LIFNR(10)     TYPE C,          " 仕入先コード
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
END   OF TYP_DENPYOU.

* 伝票情報型(入出庫情報)
TYPES: BEGIN OF TYP_MSEG,
MBLNR      TYPE MSEG-MBLNR,      " 入出庫伝票番号
MJAHR      TYPE MSEG-MJAHR,      " 入出庫伝票年度
ZEILE      TYPE MSEG-ZEILE,      " 入出庫伝票明細
EBELN      TYPE MSEG-EBELN,      " 購買発注番号
EBELP      TYPE MSEG-EBELP,      " 購買発注明細
BWART      TYPE MSEG-BWART,      " 移動タイプ
SMBLN      TYPE MSEG-SMBLN,      " 入出庫伝票番号・取消
SJAHR      TYPE MSEG-SJAHR,      " 入出庫伝票年度・取消
SMBLP      TYPE MSEG-SMBLP,      " 入出庫伝票明細・取消
BPMNG      TYPE MSEG-BPMNG,      " 購買発注価格単位
BPRME      TYPE MSEG-BPRME,      " 購買管理
DMBTR      TYPE MSEG-DMBTR,      " 国内通貨額
END   OF TYP_MSEG.

* ヘッダ型
TYPES: BEGIN OF TYP_HEAD,
WSTART(7)      TYPE C,     " APIタグ(開始)
WTITLE(100)    TYPE C,     " 帳票名
WEND(5)        TYPE C,     " APIタグ(終了)
KOUMOKU(875)   TYPE C,     " 項目名称
END   OF TYP_HEAD.

* 帳票出力型
TYPES: BEGIN OF TYP_WRITE,
ERROR(1)       TYPE C,     " プリンタ/トレイ未取得伝票
TORIKESHI(1)   TYPE C,     " 取消伝票
* ↓APPEND 2002/02/22 PSD K.Usami
MTART          TYPE EKPO-MTART,      " 発注外運送費伝票
* ↑APPEND 2002/02/22 PSD K.Usami
KAPPL          TYPE NAST-KAPPL,      " アプリケーション
KSCHL          TYPE NAST-KSCHL,      " メッセージタイプ
DATVR          TYPE NAST-DATVR,      " 処理日
UHRVR          TYPE NAST-UHRVR,      " 処理時間
BWART          TYPE MSEG-BWART,      " 移動タイプ
MBLNR          TYPE MSEG-MBLNR,      " 入出庫伝票番号
MJAHR          TYPE MSEG-MJAHR,      " 入出庫伝票年度
ZEILE          TYPE MSEG-ZEILE,      " 入出庫伝票明細
EBELN          TYPE EKPO-EBELN,      " 購買発注番号
WOBJKY         TYPE NAST-OBJKY,      " 伝票番号
PADEST         TYPE TSP03L-PADEST,   " 出力デバイス
LNAME(30)      TYPE C,     " プリンタ/トレイ
DNUM(17)       TYPE C,     " 伝票番号
OBJDES(30)     TYPE C,     " 帳票名
DATUM(8)       TYPE C,     " 出力日
PSTLZ(10)      TYPE C,     " 手配先郵便番号
JUSYO(100)     TYPE C,     " 手配先住所
NAME(35)       TYPE C,     " 手配先名
VERKF(30)      TYPE C,     " 手配先担当者名
TEL(30)        TYPE C,     " 手配先電話番号
FAX(16)        TYPE C,     " 手配先FAX番号
PLANT(30)      TYPE C,     " 部門名
EKNAM(18)      TYPE C,     " 担当者名
EKTEL(12)      TYPE C,     " 担当者電話番号
TELFX(31)      TYPE C,     " 担当者FAX番号
KUBUN(20)      TYPE C,     " 変更取消区分
KDMAT(35)      TYPE C,     " 品目コード
TXZ01(40)      TYPE C,     " 商品名
NNAME(40)      TYPE C,     " 納入場所(名称)
*---MODIFY START NDSC A.MASUDA  2004/04/22 納入場所(住所)--------------*
CITY1(160)     TYPE C,     " 納入場所(住所)
*         CITY1(100)     TYPE C,     " 納入場所(住所)
*---MODIFY END   NDSC A.MASUDA  2004/04/22 納入場所(住所)--------------*
TEL_NUMBER(30) TYPE C,     " 納入場所(電話番号)
HMENGE(15)     TYPE C,     " 発注数(数量)
MEINS(3)       TYPE C,     " 発注数(単位)
TANKA(15)      TYPE C,     " 発注単価
* ↓APPEND 2002/02/20 PSD K.Usami
WAERS      TYPE EKKO-WAERS,      " 伝票通貨
* ↑APPEND 2002/02/20 PSD K.Usami
BIKOU(125)     TYPE C,     " 備考
SLFDT(8)       TYPE C,     " 依頼納期
MENGE(15)      TYPE C,     " 数量
*---APPEND START PSD T.SAITOH 2002/04/03 金額設定-------------------*
NETWR(15)      TYPE C,     " 金額
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START PSD T.SAITOH 2002/04/03 登録日、登録時間考慮--------*
ERDAT          TYPE NAST-ERDAT,"登録日
ERUHR          TYPE NAST-ERUHR,"登録時間
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START PSD T.IIDA 2002/07/04 出荷指示変更-----------------*
EVTXT          TYPE T027B-EVTXT,"出荷指示テキスト
*---APPEND END   PSD T.IIDA 2002/07/04 -----------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 金額-----------------------*
ERNAM(12)     TYPE C,          " 登録者
VBELV(10)     TYPE C,          " 受注伝票番号
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
*---APPEND START NDSC A.MASUDA  2004/04/22 仕入先コード-------------*
LIFNR(10)     TYPE C,          " 仕入先コード
*---APPEND END   NDSC A.MASUDA  2004/04/22 仕入先コード-------------*
*---APPEND START DMC A.MASUDA  2005/02/22 ---------------------------*
TNAME(14)     TYPE C,          " 担当者名
*---APPEND END   DMC A.MASUDA  2005/02/22 ---------------------------*
*---APPEND START NDSC M.IKEDA  2006/11/14 ---------------------------*
BSTKD(35)     TYPE C,          " 得意先発注番号
*---APPEND END   NDSC M.IKEDA  2006/11/14 ---------------------------*
*---APPEND START NDSC M.IKEDA  2006/12/04 ---------------------------*
URZTX(10)     TYPE C,          " 証明書テキスト
*---APPEND END   NDSC M.IKEDA  2006/12/04 ---------------------------*
END   OF TYP_WRITE.

* プラント型
TYPES: BEGIN OF TYP_PLANT,
WERKS      TYPE T001W-WERKS,     " プラント
NAME1      TYPE T001W-NAME1,     " プラント名
ADRNR      TYPE T001W-ADRNR,     " 住所
END   OF TYP_PLANT.

* 購買グループ型
TYPES: BEGIN OF TYP_KOUBAI,
EKGRP      TYPE T024-EKGRP,      " 購買グループ
EKNAM      TYPE T024-EKNAM,      " 購買グループテキスト
EKTEL      TYPE T024-EKTEL,      " 電話番号
TELFX      TYPE T024-TELFX,      " ファクス番号
END   OF TYP_KOUBAI.

* プリンタ/トレイ型
TYPES: BEGIN OF TYP_PRINTA,
LNAME      TYPE TSP03L-LNAME,      " デバイス名(長)
PADEST     TYPE TSP03L-PADEST,     " デバイスの略称
END   OF TYP_PRINTA.

* 手配先名型
TYPES: BEGIN OF TYP_TEHAI,
LIFNR     TYPE LFA1-LIFNR,       " 仕入先コード
NAME2     TYPE LFA1-NAME2,       " 名称
REGIO     TYPE LFA1-REGIO,       " 都道府県
LAND1     TYPE LFA1-LAND1,       " 国コード
PSTLZ     TYPE LFA1-PSTLZ,       " 郵便番号
*---modify START PSD T.SAITOH 2002/04/08 ---------------------------*
*         STRAS     TYPE LFA1-STRAS,       " 都道府県名
STRAS     TYPE ADRC-STREET,       " 都道府県名
*---modify END   PSD T.SAITOH 2002/04/08 ---------------------------*
ORT01     TYPE LFA1-ORT01,       " 市町村名
BEZEI     TYPE T005U-BEZEI,      " 内容説明
LIFN2     TYPE EKPA-LIFN2,       " 他使用先への参照
*---APPEND START PSD T.SAITOH 2002/04/08 ---------------------------*
ADRNR     TYPE LFA1-ADRNR,       "住所コード
*---APPEND END   PSD T.SAITOH 2002/04/08 ---------------------------*
END   OF TYP_TEHAI.

* 手配先担当者名型
TYPES: BEGIN OF TYP_TTANTOU,
VERKF     TYPE LFM1-VERKF,       " 仕入先営業担当
TELF1     TYPE LFM1-TELF1,       " 仕入先電話番号
* ↓APPEND 2002/02/25 PSD K.Usami
TELFX     TYPE LFA1-TELFX,       " 仕入先FAX番号
*  ↑APPEND 2002/02/25 PSD K.Usami
END   OF TYP_TTANTOU.

* 品目コード型
TYPES: BEGIN OF TYP_HINMOKU,
KDMAT     TYPE VBAP-KDMAT,       " 得意先品目コード
ADRNR     TYPE VBPA-ADRNR,       " 住所
END   OF TYP_HINMOKU.

* 納入場所型
TYPES: BEGIN OF TYP_NOUNYU,
STREET     TYPE ADRC-STREET,       " 都道府県名
CITY1      TYPE ADRC-CITY1,        " 市町村
TEL_NUMBER TYPE ADRC-TEL_NUMBER,   " 都道府県名
*---APPEND START PSD T.SAITOH 2002/07/28 ---------------------------*
*         NAME1      TYPE ADRC-NAME1,        " 名称
NAME2      TYPE ADRC-NAME2,        " 名称
*---APPEND END   PSD T.SAITOH 2002/07/28 ---------------------------*
ADRNR      TYPE VBPA-ADRNR,        " 住所
*---APPEND START NDSC A.MASUDA 2004/04/21 ---------------------------*
BEZEI      TYPE T005U-BEZEI,       " 地域(名称)
*---APPEND END   NDSC A.MASUDA 2004/04/21 ---------------------------*
END   OF TYP_NOUNYU.

* 備考型
TYPES: BEGIN OF TYP_BIKOU,
EVTXT     TYPE T027B-EVTXT,      " 出荷指示テキスト
END   OF TYP_BIKOU.

* 依頼納期・数量型
TYPES: BEGIN OF TYP_IRAI,
ETENR     TYPE EKET-ETENR,       " 納入日程行
* Mod 2003.10.30 -->>
*         slfdt     TYPE eket-slfdt,       " 統計的納入期日
EINDT     TYPE EKET-EINDT,       " 納入期日
* Mod 2003.10.30 <<--
MENGE     TYPE EKET-MENGE,       " 計画数量
END   OF TYP_IRAI.

*---APPEND START NDSC M.IKEDA 2006/11/14 ---------------------------*
* 得意先発注番号型
TYPES: BEGIN OF TYP_BSTKD,
BSTKD TYPE VBKD-BSTKD,           "得意先発注番号
END OF TYP_BSTKD.
*---APPEND END   NDSC M.IKEDA 2006/11/14 ---------------------------*

*---APPEND START NDSC M.IKEDA 2006/12/04 ---------------------------*
* 証明書型
TYPES: BEGIN OF TYP_SYOUMEISYO,
URZTP TYPE T069T-URZTP,          "証明書区分
URZTX TYPE T069T-URZTX,          "証明書テキスト
END OF TYP_SYOUMEISYO.
*---APPEND END   NDSC M.IKEDA 2006/12/04 ---------------------------*

* ファイル名
TYPES: BEGIN           OF     TYP_FILENM,
FILENM(58)      TYPE   C,
END             OF     TYP_FILENM.

* 出力タイプ型
TYPES: BEGIN OF TYP_TYPE,
KAPPL      TYPE TNATI-KAPPL,      " アプリケーション
KSCHL      TYPE TNATI-KSCHL,      " メッセージタイプ
OBJDES     TYPE TNATI-OBJDES,      " 名称
END   OF TYP_TYPE.

* 帳票名型(再出力)
TYPES: BEGIN OF TYP_TYOUHYOU,
KAPPL TYPE NAST-KAPPL,           " アプリケーション
KSCHL TYPE NAST-KSCHL,           " メッセージタイプ
ERDAT TYPE NAST-ERDAT,           " 登録日付
ERUHR TYPE NAST-ERUHR,           " 時間
END   OF TYP_TYOUHYOU.

* 出力ファイル型
TYPES: BEGIN OF TYP_DATA,
* Mod ES-UP 2012/10/30 -->
*        DATA(875)       TYPE C,
DATA  TYPE STRING,
* Mod ES-UP 2012/10/30 <--
END   OF TYP_DATA.
***********************************************************************
* DATA
***********************************************************************
* 購買発注伝票存在チェック用
DATA: GF_CHECK_DENPYOU    TYPE          TYP_CHECK_DENPYOU.

* NAST購買発注内部テーブル
DATA: GF_NAST    TYPE          TYP_NAST,
GT_NAST    LIKE TABLE OF GF_NAST.
DATA: TMP_NAST    TYPE          TYP_NAST.

*伝票情報購買発注内部テーブル
DATA: GF_HDENPYOU    TYPE          TYP_DENPYOU,
GT_HDENPYOU    LIKE TABLE OF GF_HDENPYOU.

*伝票情報在庫管理内部テーブル
DATA: GF_MSEG            TYPE TYP_MSEG,
GT_MSEG            LIKE TABLE OF GF_MSEG.
DATA: GF_ZDENPYOU        TYPE TYP_DENPYOU,
GT_ZDENPYOU        LIKE TABLE OF GF_ZDENPYOU.

*取消伝票内部テーブル
DATA: GF_SMSEG            TYPE TYP_MSEG,
GT_SMSEG            LIKE TABLE OF GF_SMSEG.

DATA: GF_TORIKESHI       TYPE TYP_MSEG,
GT_TORIKESHI       LIKE TABLE OF GF_TORIKESHI.

*項目設定時変数
DATA: GF_DENPYOU         TYPE TYP_DENPYOU,
GT_DENPYOU         LIKE TABLE OF GF_DENPYOU.

* 帳票出力用内部テーブル
DATA: GF_WRITE   TYPE          TYP_WRITE,
GT_WRITE   LIKE TABLE OF GF_WRITE.
*---APPEND START PSD T.SAITOH 2002/03/07 重複更新回避用--------------*
DATA: GT_TMP_WRITE LIKE TABLE OF GF_WRITE,
GF_TMP_WRITE TYPE        TYP_WRITE.
*---APPEND END   PSD T.SAITOH 2002/03/07 ---------------------------*

* プラント用内部テーブル
DATA: GF_PLANT   TYPE          TYP_PLANT,
* MODIFY PSD K.ARAI 2002/05/28
GT_PLANT   LIKE HASHED TABLE OF GF_PLANT
WITH UNIQUE KEY WERKS.
*      GT_PLANT   LIKE TABLE OF GF_PLANT.
* MODIFY END
* 購買グループ用内部テーブル
DATA: GF_KOUBAI   TYPE          TYP_KOUBAI,
* MODIFY PSD K.ARAI 2002/05/28
GT_KOUBAI   LIKE HASHED TABLE OF GF_KOUBAI
WITH UNIQUE KEY EKGRP.
*      GT_KOUBAI   LIKE TABLE OF GF_KOUBAI.
* MODIFY END
* プリンタ/トレイ用内部テーブル
DATA: GF_PRINTA   TYPE          TYP_PRINTA,
* MODIFY PSD K.ARAI 2002/05/28
GT_PRINTA   LIKE HASHED TABLE OF GF_PRINTA
WITH UNIQUE KEY LNAME.
*      GT_PRINTA   LIKE TABLE OF GF_PRINTA.
* MODIFY END
* 出力タイプ用内部テーブル
DATA: GF_TYPE   TYPE          TYP_TYPE,
GT_TYPE   LIKE TABLE OF GF_TYPE,
OBJDES1   LIKE GF_TYPE-OBJDES,
OBJDES2   LIKE GF_TYPE-OBJDES.

* 手配先名用内部テーブル
DATA: GF_TEHAI   TYPE          TYP_TEHAI,
GT_TEHAI   LIKE TABLE OF GF_TEHAI.

* 手配先担当者名用内部テーブル
DATA: GF_TTANTOU   TYPE          TYP_TTANTOU,
GT_TTANTOU   LIKE TABLE OF GF_TTANTOU,
VERKF1 LIKE GF_TTANTOU-VERKF,
VERKF2 LIKE GF_TTANTOU-VERKF.

* 品目コード用内部テーブル
DATA: GF_HINMOKU   TYPE          TYP_HINMOKU,
GT_HINMOKU   LIKE TABLE OF GF_HINMOKU.

* 納入場所用内部テーブル
DATA: GF_NOUNYU   TYPE          TYP_NOUNYU,
GT_NOUNYU   LIKE TABLE OF GF_NOUNYU.

* 備考用内部テーブル
DATA: GF_BIKOU   TYPE          TYP_BIKOU,
GT_BIKOU   LIKE TABLE OF GF_BIKOU.
DATA: W_NAME LIKE THEAD-TDNAME,
ITAB_NAME LIKE TABLE OF TLINE,
WA_NAME LIKE TLINE,
BIKOU LIKE TLINE-TDLINE,
TMP_BIKOU LIKE TLINE-TDLINE.

* 依頼納期・数量用内部テーブル
DATA: GF_IRAI   TYPE          TYP_IRAI,
GT_IRAI   LIKE TABLE OF GF_IRAI.

*---APPEND START NDSC M.IKEDA 2006/11/14 ---------------------------*
* 得意先発注番号構造
DATA: GF_BSTKD TYPE TYP_BSTKD.
*---APPEND END   NDSC M.IKEDA 2006/11/14 ---------------------------*

*---APPEND START NDSC M.IKEDA 2006/12/04 ---------------------------*
DATA: WK_URZTP TYPE T069T-URZTP,
*      WK_ERROR_COMENT TYPE STRING.
WK_ERROR_COMENT(100) TYPE C.
* 証明書区分、テキスト用内部テーブル
DATA: GF_SYOUMEISYO TYPE TYP_SYOUMEISYO,
GT_SYOUMEISYO LIKE TABLE OF GF_SYOUMEISYO.
*---APPEND END   NDSC M.IKEDA 2006/12/04 ---------------------------*

* 帳票名(再出力時)用内部テーブル
DATA: GF_TYOUHYOU   TYPE          TYP_TYOUHYOU,
GT_TYOUHYOU   LIKE TABLE OF GF_TYOUHYOU.
DATA: GF_ZTYOUHYOU   TYPE          TYP_TYOUHYOU,
GT_ZTYOUHYOU   LIKE TABLE OF GF_ZTYOUHYOU.

* ロック/アンロック用変数
DATA: WKAPPL LIKE NAST-KAPPL,
WKSCHL LIKE NAST-KSCHL.

* ファイルヘッダ
DATA: GF_HEAD   TYPE          TYP_HEAD.

* 出力ファイル名
DATA: GF_FILENM   TYPE   TYP_FILENM,
PR_FILEN    TYPE RLGRAP-FILENAME.   " ファイル作成先

* 出力ファイルデータ
DATA: GF_DATA        TYPE     TYP_DATA,
GT_DATA     LIKE TABLE OF GF_DATA.
* Del ES-UP 2012/08/21 -->
** タブ
*DATA: XCODE(1) TYPE X.
* Del ES-UP 2012/08/21 <--
DATA: W_CR(1) TYPE X .
DATA: W_LF(1) TYPE X .
*伝票番号
DATA: TMP_OBJKY(18) TYPE C.
DATA: DNUM(17) TYPE C.
*出力データカウンタフラグ
DATA: CNT_FLG TYPE I.
*伝票情報存在チェックフラグ
DATA: HDE_FLG TYPE I,
ZDE_FLG TYPE I.
*プリンタ/トレイエラー伝票チェック
DATA: ERR_FLG TYPE I.
*金額変換用
DATA: I_GF_DENPYOU_NETPR(30) TYPE C,
*---APPEND START PSD T.SAITOH 2002/04/03 ---------------------------*
I_GF_DENPYOU_NETWR(30) TYPE C,
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
TURN_NETPR(10) TYPE P DECIMALS 2,
I_GF_MSEG_DMBTR(30) TYPE C,
TURN_DMBTR(10) TYPE P DECIMALS 2.
* システム項目用変数
DATA: G_REPID                 TYPE SY-REPID,        " プログラムＩＤ
G_DATA                  TYPE SY-DATUM,        " システム日付
G_UNAME                 TYPE SY-UNAME,        " ログオンユーザID
G_UZEIT                 TYPE SY-UZEIT,        " システム時刻
G_TITLE(6)              TYPE C.               " 表題テキスト

* 選択項目
* ↓ 2002.03.04 modify psd m.arai 入力ヘルプ(手配先)不具合対応
*DATA: G_LIFNR(10) TYPE C.
DATA: G_LIFNR TYPE LFA1-LIFNR.
* ↑

*---APPEND START PSD T.SAITOH 2002/08/04 ---------------------------*
* ロックオブジェクト　リターンコード
DATA:G_RETURN_CODE LIKE SY-SUBRC.
*---APPEND END   PSD T.SAITOH 2002/08/04 ---------------------------*

*---APPEND START PSD T.SAITOH 2002/08/07 ---------------------------*
* 再出力処理高速化対応
TYPES: BEGIN OF TYP_EKBE_OBJKY,
EBELN TYPE EKBE-EBELN,"購買発注伝票番号
GJAHR TYPE EKBE-GJAHR,"入出庫伝票年度
BELNR TYPE EKBE-BELNR,"入出庫伝票番号
BUZEI TYPE EKBE-BUZEI,"入出庫伝票明細
END OF TYP_EKBE_OBJKY.
* 購買伝票別の履歴　　　発注番号から紐付く入出庫伝票を格納
DATA: GT_EKBE_OBJKY TYPE TABLE OF TYP_EKBE_OBJKY,
GF_EKBE_OBJKY TYPE TYP_EKBE_OBJKY.

TYPES: BEGIN OF TYP_MSEG_OBJKY,
MBLNR TYPE MSEG-MBLNR,"入出庫伝票年度
MJAHR TYPE MSEG-MJAHR,"入出庫伝票番号
ZEILE TYPE MSEG-ZEILE,"入出庫伝票明細
EBELN TYPE MSEG-EBELN,"購買発注伝票番号
END OF TYP_MSEG_OBJKY.
* 伝票セグメント：品目　入出庫伝票から紐付く発注伝票を格納
DATA: GT_MSEG_OBJKY TYPE TABLE OF TYP_MSEG_OBJKY,
GF_MSEG_OBJKY TYPE TYP_MSEG_OBJKY.

* オブジェクトキー管理内部ＴＢＬ
TYPES: BEGIN OF TYP_OBJKY,
OBJKY TYPE NAST-OBJKY,"オブジェクトキー
END OF TYP_OBJKY.

DATA: GT_OBJKY TYPE SORTED TABLE OF TYP_OBJKY WITH UNIQUE KEY OBJKY,
GF_OBJKY TYPE TYP_OBJKY.
*---APPEND END   PSD T.SAITOH 2002/08/07 ---------------------------*
*---APPEND START DMC A.MASUDA 2005/02/22 ---------------------------*
DATA:G_VBELN LIKE EKKN-VBELN.
DATA:FLG_TEC TYPE C.
* 登録者名内部テーブル
DATA:GF_EKKO TYPE EKKO,
GT_EKKO LIKE TABLE OF GF_EKKO.
*---APPEND END   DMC A.MASUDA 2005/02/22 ---------------------------*
*---------------------------------------------------------------------
* 定数宣言
*---------------------------------------------------------------------
CONSTANTS:   CNS_X          TYPE C VALUE 'X',
CNS_NAST(4)    TYPE C VALUE 'NAST',
CNS_T685T(5)   TYPE C VALUE 'T685T',
CNS_T005U(5)   TYPE C VALUE 'T005U',
CNS_LFA1(9)    TYPE C VALUE 'LFA1 EKPA',
CNS_LFM2(4)    TYPE C VALUE 'LFM2',
CNS_LFM1(4)    TYPE C VALUE 'LFM1',
CNS_T001W(5)   TYPE C VALUE 'T001W',
CNS_T024(4)    TYPE C VALUE 'T024',
CNS_EKKN(14)    TYPE C VALUE 'EKKN VBAP VBPA',
CNS_ADRC(4)    TYPE C VALUE 'ADRC',
CNS_T027B(5)   TYPE C VALUE 'T027B',
CNS_EKKO(9)    TYPE C VALUE 'EKKO EKPO',
CNS_MSEG(4)    TYPE C VALUE 'MSEG',
CNS_EKET(4)    TYPE C VALUE 'EKET',
CNS_TSP03L(6)  TYPE C VALUE 'TSP03L'.
*---APPEND START PSD T.SAITOH 2002/04/03 依頼納期条件追加により定数追加*
CONSTANTS:   CNS_ME(2)      TYPE C VALUE 'ME'.
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START DMC A.MASUDA 2005/02/22 ---------------------------*
CONSTANTS:   CNS_VE(2)      TYPE C VALUE 'VE',
CNS_BATCH(8)   TYPE C VALUE 'WF-BATCH',
CNS_TEC0000(7) TYPE C VALUE 'TEC0000',
*---APPEND END   DMC A.MASUDA 2005/02/22 ---------------------------*
*---APPEND START DMC A.MASUDA 2005/06/22 ---------------------------*
CNS_EDI(8)     TYPE C VALUE 'EDIADMIN'.
*---APPEND END   DMC A.MASUDA 2005/06/22 ---------------------------*
*---APPEND START NDSC M.IKEDA 2006/11/14 ---------------------------*
CONSTANTS:   CNS_VBKD(4)    TYPE C VALUE 'VBKD'.
*---APPEND END   NDSC M.IKEDA 2006/11/14 ---------------------------*
*---APPEND START NDSC M.IKEDA 2006/12/04 ---------------------------*
CONSTANTS:   CNS_T069T(5)   TYPE C VALUE 'T069T'.
*---APPEND END   NDSC M.IKEDA 2006/12/04 ---------------------------*
**** START DEL 2014/09/01 ISID11 ****
** Add ES-UP 2012/08/21 -->
*CONSTANTS CNS_SJIS TYPE STRING VALUE `shift_jis`.
** Add ES-UP 2012/08/21 <--
**** END DEL 2014/09/01 ISID11 ****
************************************************************************
** 選択画面定義
************************************************************************
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
PARAMETERS: PR_EKORG TYPE EKKO-EKORG MEMORY ID EKO OBLIGATORY."購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
* ↓ MODIFY 2002.03.14 PSD M.ARAI プラント/購買グループデフォルト設定
*SELECT-OPTIONS: S_WERKS FOR GF_PLANT-WERKS,     " プラント
*                S_EKGRP FOR GF_KOUBAI-EKGRP,    " 購買グループ
SELECT-OPTIONS: S_WERKS FOR GF_PLANT-WERKS  MEMORY ID WRK,
S_EKGRP FOR GF_KOUBAI-EKGRP MEMORY ID EKG,
* ↑
S_BEDAT FOR GF_HDENPYOU-BEDAT,  " 伝票日付
*                s_LIFNR FOR GF_TEHAI-LIFNR.     " 手配先
S_LIFNR  FOR  G_LIFNR.

*---APPEND START DMC A.MASUDA 2005/02/22 ---------------------------*
SELECT-OPTIONS: S_ERNAM FOR GF_EKKO-ERNAM.      " ユーザーコード
*---APPEND END   DMC A.MASUDA 2005/02/22 ---------------------------*

PARAMETERS: R_TUJOU RADIOBUTTON GROUP RADI.     " 通常出力
PARAMETERS: R_SAI RADIOBUTTON GROUP RADI.       " 再出力

SELECT-OPTIONS: S_EBELN FOR GF_ZDENPYOU-EBELN,    " 発注番号(注文書)
S_MBLNR FOR GF_MSEG-MBLNR.        " 入出庫番号(返品伝票)

SELECT-OPTIONS: S_MJAHR  FOR GF_MSEG-MJAHR.      " 入出庫伝票年度
SELECT-OPTIONS: S_ZEILE FOR GF_MSEG-ZEILE.       " 入出庫伝票明細番号
PARAMETERS:     PR_LNAME TYPE TSP03L-LNAME.      " プリンタ/トレイ
***********************************************************************
* AT SELECTION-SCREEN
***********************************************************************
AT SELECTION-SCREEN.
* 選択拡張ボタンはチェックしない。
IF SY-UCOMM+0(1) <> '%'.
* 初期処理
GET PARAMETER ID 'ZSVF' FIELD PR_FILEN.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE E614(Z1) WITH TEXT-056. "ファイル作成先ディレクトリ
ENDCASE.

* 入力後処理
* ①共通チェック
* a)プラントチェック
IF S_WERKS IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-055. "プラント
ENDIF.
* b) 伝票番号チェック
IF S_EBELN <> ' ' AND S_MBLNR <> ' '.
* ↓APPEND 2002/02/22 PSD K.Usami
*    MESSAGE e605(Z1) WITH text-004 text-005. "発注番号 "入出庫番号
MESSAGE E752(Z1).
* ↑APPEND 2002/02/22 PSD K.Usami
ENDIF.
* c) 入出庫年度・入出庫伝票明細番号チェック
* ↓APPEND 2002/02/22 PSD K.Usami
*  IF s_MBLNR <> ' '.
*    IF s_MJAHR is INITIAL.
*      MESSAGE e006(Z1) WITH text-006. "入出庫年度
*    ENDIF.
*    IF s_ZEILE is INITIAL.
*      MESSAGE e006(Z1) WITH text-007. "入出庫伝票明細番号
*    ENDIF.
*  ENDIF.
IF S_MBLNR IS INITIAL
AND S_MJAHR IS INITIAL
AND S_ZEILE IS INITIAL.
ELSE.
IF S_MBLNR IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-005. "入出庫番号
ENDIF.
IF S_MJAHR IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-006. "入出庫年度
ENDIF.
IF S_ZEILE IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-007. "入出庫伝票明細番号
ENDIF.
ENDIF.
* ↑APPEND 2002/02/22 PSD K.Usami

* d)プリンタ/トレイ取得
SELECT LNAME
PADEST
INTO TABLE GT_PRINTA
FROM TSP03L.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_TSP03L SY-SUBRC.
ENDCASE.
*---プリンタ/トレイチェック
IF PR_LNAME <> ' '.
* MODIFY PSD K.ARAI 2002/05/28
READ TABLE GT_PRINTA WITH TABLE KEY LNAME = PR_LNAME
*    READ TABLE GT_PRINTA WITH KEY LNAME = PR_LNAME
* MODIFY END
INTO GF_PRINTA.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE E614(Z1) WITH TEXT-009."画面入力されたプリンタ/トレイ
ENDCASE.
ENDIF.

*---DELETE START PSD T.SAITOH 2002/07/23 ---------------------------*
** e)購買発注伝票存在チェック
*  SELECT SINGLE
*    B~EBELN
*    A~EKGRP
*    B~WERKS
*    A~LIFNR
*    INTO CORRESPONDING FIELDS OF GF_CHECK_DENPYOU
*    FROM ( EKKO AS A INNER JOIN EKPO     AS B
*        ON A~EBELN = B~EBELN )
*        WHERE   B~EBELN   IN S_EBELN
**---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
*        AND     A~EKORG   = PR_EKORG  "購買組織
**---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
*        AND     A~EKGRP   IN S_EKGRP
*        AND     B~WERKS   IN S_WERKS.
**        AND     a~LIFNR   IN s_LIFNR.
*  CASE SY-SUBRC.
*    WHEN 0.
*    WHEN 4.    " 対象データなし
*      MESSAGE E611(Z1).
*    WHEN 8.    " システムエラー
*      MESSAGE A603(Z1) WITH G_REPID CNS_EKKO SY-SUBRC.
*  ENDCASE.
*
*---DELETE END   PSD T.SAITOH 2002/07/23 ---------------------------*


* ①ラジオボタン:再出力が選択されている場合以下の処理を行う
IF R_SAI = CNS_X.
* a) 伝票番号チェック
IF S_EBELN = ' ' AND S_MBLNR = ' '.
* ↓APPEND 2002/02/22 PSD K.Usami
*      MESSAGE e702(Z1) WITH text-004 text-005. "発注番号 "入出庫番号
MESSAGE E605(Z1) WITH TEXT-004 TEXT-005. "発注番号 "入出庫番号
* ↑APPEND 2002/02/22 PSD K.Usami
ENDIF.
ENDIF.
ENDIF.
************************************************************************
** START-OF-SELECTION
************************************************************************
START-OF-SELECTION.

*---APPEND START PSD T.SAITOH 2002/07/23 ---------------------------*
*--- 購買伝票存在チェック(構造化していないので構造化した）
PERFORM FRM_CHECK_M.
*---APPEND END   PSD T.SAITOH 2002/07/23 ---------------------------*

*--- 初期処理
PERFORM FRM_INIT.
*--- 主処理
* ① 処理データ取得
* a)プラント
PERFORM FRM_GET_PLANT.
* b)購買グループ
PERFORM FRM_GET_KOUBAI.
* c) 出力タイプ取得
PERFORM FRM_GET_TYPE.

* ↓APPEND 2002/02/20 PSD K.Usami
** d) テーブルロック処理
*  PERFORM frm_call_rock.
* ↑APPEND 2002/02/20 PSD K.Usami

* e) NAST情報取得処理
PERFORM FRM_GET_NAST.
* f) MSEG取消情報取得
PERFORM FRM_GET_MSEG.

*---APPEND START NDSC M.IKEDA 2006/12/04 ---------------------------*
* g)証明書区分、証明書テキスト取得
PERFORM FRM_GET_T069T.
*---APPEND END   NDSC M.IKEDA 2006/12/04 ---------------------------*

* ② 出力ファイル作成処理
*---通常処理時
IF R_TUJOU = CNS_X.
PERFORM FRM_MAKE_DATA.
*---再出力処理時
ELSEIF R_SAI = CNS_X.
PERFORM FRM_REMAKE_DATA.
ENDIF.
**---伝票情報存在チェック
*  IF hde_flg <> 1 and zde_flg <> 1.
*    WRITE:/ text-052,
*          / ' ',text-053,text-039,text-037.
*    STOP.
*  ENDIF.

* ↓APPEND 2002/02/22 PSD K.Usami
*---出力データ存在チェック
PERFORM CHECK_WRITEDATA.
* ↑APPEND 2002/02/22 PSD K.Usami

* ③ ファイル出力/NAST更新
PERFORM FRM_WRITE_DATA.

*---正常終了メッセージ出力
IF CNT_FLG <> 0.
WRITE: / TEXT-050.
WRITE: / ' ',G_TITLE,TEXT-041,CNT_FLG,TEXT-046.
ENDIF.

*---APPEND START PSD T.SAITOH 2002/08/05 ---------------------------*
* ロック解除
PERFORM FRM_DEQUEUE_ALL.
*---APPEND END   PSD T.SAITOH 2002/08/05 ---------------------------*

************************************************************************
** END-OF-SELECTION
************************************************************************
END-OF-SELECTION.
*---DELETE START PSD T.SAITOH 2002/08/05 ---------------------------*
** ↓APPEND 2002/02/20 PSD K.Usami
*** ロック解除
**  PERFORM frm_call_unrock.
** ロック解除
*  PERFORM FRM_DEQUEUE_ALL.
** ↑APPEND 2002/02/20 PSD K.Usami
*---DELETE END   PSD T.SAITOH 2002/08/05 ---------------------------*

***********************************************************************
** Form
***********************************************************************
*&---------------------------------------------------------------------*
*&      Form  frm_init
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
FORM FRM_INIT.
* システム項目用変数設定
G_REPID = SY-REPID.       " プログラムＩＤ取得
G_DATA  = SY-DATUM.       " システム日付取得
G_UZEIT = SY-UZEIT.       " システム時刻取得
G_UNAME = SY-UNAME.       " ログオンユーザＩＤ取得
G_TITLE = SY-TITLE+0(6).   " 表題テキスト
ENDFORM.                    " frm_init
*&---------------------------------------------------------------------*
*&      Form  frm_get_plant
*&---------------------------------------------------------------------*
*       プラント
*----------------------------------------------------------------------*
FORM FRM_GET_PLANT.
SELECT
WERKS
NAME1
ADRNR
INTO CORRESPONDING FIELDS OF TABLE GT_PLANT
FROM T001W.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE E600(Z1) WITH TEXT-002." プラントマスタ
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_T001W SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_get_plant
*&---------------------------------------------------------------------*
*&      Form  frm_get_koubai
*&---------------------------------------------------------------------*
*       購買グループ
*----------------------------------------------------------------------*
FORM FRM_GET_KOUBAI.
SELECT EKGRP
EKNAM
EKTEL
TELFX
INTO CORRESPONDING FIELDS OF TABLE GT_KOUBAI
FROM T024.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE E600(Z1) WITH TEXT-003." 購買グループ
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_T024 SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_get_koubai
*&---------------------------------------------------------------------
*&      Form  frm_get_type
*&---------------------------------------------------------------------
*       出力タイプ取得
*----------------------------------------------------------------------
FORM FRM_GET_TYPE.

SELECT
KAPPL
KSCHL
OBJDES
INTO CORRESPONDING FIELDS OF TABLE GT_TYPE
FROM TNATI
WHERE SPRAS = 'J'
* MODIFY PSD K.ARAI 2002/05/28
AND   KAPPL IN ('EF' ,'ME') .
*    AND ( KAPPL = 'EF'
*    OR    KAPPL = 'ME' ).
*MODIFY END

CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE E600(Z1) WITH TEXT-011."条件タイプマスタ
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_T685T SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_set_nast
*&---------------------------------------------------------------------*
*&      Form  frm_call_rock
*&---------------------------------------------------------------------*
*       テーブルロックパラメータ設定
*----------------------------------------------------------------------*
*FORM frm_call_rock.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM01'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM02'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM03'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM04'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM05'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM50'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM51'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM52'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM53'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM54'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM55'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'ME'.
*  WKSCHL = 'WA01'.
*  PERFORM frm_rock_nast USING WKAPPL WKSCHL.
*
*ENDFORM.                    " frm_call_rock

*&---------------------------------------------------------------------*
*&      Form  frm_rock_nast
*&---------------------------------------------------------------------*
*       NASTテーブルロック処理
*----------------------------------------------------------------------*
*FORM frm_rock_nast USING P_WKAPPL P_WKSCHL.
*  CALL FUNCTION 'ENQUEUE_EZNAST'
*   EXPORTING
*     MODE_NAST            = 'E'
*     MANDT                = SY-MANDT
*     KAPPL                = WKAPPL
**   OBJKY                =
*     KSCHL                = WKSCHL
**   SPRAS                =
**   PARNR                =
**   PARVW                =
**   ERDAT                =
**   ERUHR                =
**   X_KAPPL              = ' '
**   X_OBJKY              = ' '
**   X_KSCHL              = ' '
**   X_SPRAS              = ' '
**   X_PARNR              = ' '
**   X_PARVW              = ' '
**   X_ERDAT              = ' '
**   X_ERUHR              = ' '
**   _SCOPE               = '2'
**   _WAIT                = ' '
**   _COLLECT             = ' '
*   EXCEPTIONS
*     FOREIGN_LOCK         = 1
*     SYSTEM_FAILURE       = 2
*     OTHERS               = 3
*            .
**IF SY-SUBRC <> 0.
** MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
**         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
**ENDIF.
*
*  IF SY-SUBRC <> 0.
*    IF SY-SUBRC = 1.
*      MESSAGE s004(Z1) WITH G_TITLE.   " 注文書
*      STOP.
*    ELSE.
*      MESSAGE e001(Z1) WITH 'ENQUEUE_EZNAST' SY-SUBRC.
*    ENDIF.
*  ENDIF.
*
*ENDFORM.                    " frm_rock_nast
*&---------------------------------------------------------------------
*&      Form  frm_get_nast
*&---------------------------------------------------------------------
*       NAST情報取得処理
*----------------------------------------------------------------------
FORM FRM_GET_NAST.
IF R_TUJOU = CNS_X."通常出力時
*---MODIFY START PSD T.SAITOH 2002/08/04 ---------------------------*
*   見づらいので構造化(NAST読込・・・通常出力時）
PERFORM FRM_SELECT_NAST_VSTAT0.
*---MODIFY END   PSD T.SAITOH 2002/08/04 ---------------------------*
ELSEIF R_SAI = CNS_X."再出力時
*---APPEND START PSD T.SAITOH 2002/08/07 ---------------------------*
*   再出力時：パフォーマンス対応
*   オブジェクトキー取得
PERFORM FRM_SELECT_OBJKY.
*---APPEND END   PSD T.SAITOH 2002/08/07 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/08/04 ---------------------------*
*   見づらいので構造化(NAST読込・・・再出力時）
IF GT_OBJKY IS INITIAL.
*     全件
PERFORM FRM_SELECT_NAST_VSTAT1.
ELSE.
*     条件絞る
PERFORM FRM_SELECT_NAST_VSTAT1_RAPID.
ENDIF.
*---MODIFY END   PSD T.SAITOH 2002/08/04 ---------------------------*
ENDIF.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
WRITE: / TEXT-052,
/ ' ',TEXT-054,TEXT-039,TEXT-037.
STOP.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_NAST SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_get_nast
*&---------------------------------------------------------------------*
*&      Form  frm_get_mseg
*&---------------------------------------------------------------------*
*       MSEG取消情報取得
*----------------------------------------------------------------------*
FORM FRM_GET_MSEG.

SELECT
MBLNR
MJAHR
ZEILE
EBELN
EBELP
BWART
SMBLN
SJAHR
SMBLP
BPMNG
BPRME
DMBTR
INTO CORRESPONDING FIELDS OF TABLE GT_SMSEG
FROM MSEG
WHERE    BWART  = '123'
AND    SJAHR IN S_MJAHR
AND    SMBLN IN S_MBLNR
AND    SMBLP IN S_ZEILE.

CASE SY-SUBRC.
WHEN 4.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_MSEG SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_get_mseg
*&---------------------------------------------------------------------*
*&      Form  frm_make_data
*&---------------------------------------------------------------------*
*       出力ファイル作成処理
*----------------------------------------------------------------------*
FORM FRM_MAKE_DATA.
LOOP AT GT_NAST INTO GF_NAST.
* ①項目の設定
IF GF_NAST-KAPPL = 'EF'.
IF S_MBLNR IS INITIAL.
ELSE.
CONTINUE.
ENDIF.
* 購買発注伝票情報取得
*---APPEND START PSD T.SAITOH 2002/08/04 ---------------------------*
* 見づらいので構造化
PERFORM FRM_SELECT_EKKO_EKPO.
*---APPEND END   PSD T.SAITOH 2002/08/04 ---------------------------*

CASE SY-SUBRC.
WHEN 4.
CONTINUE.
WHEN 0.
*---DELETE START PSD T.SAITOH 2002/08/04 ---------------------------*
** ↓APPEND 2002/02/20 PSD K.Usami
** d) テーブルロック処理
*          PERFORM FRM_ENQUEUE_EZNAST.
** ↑APPEND 2002/02/20 PSD K.Usami
*---DELETE END   PSD T.SAITOH 2002/08/04 ---------------------------*
HDE_FLG = 1.
LOOP AT GT_HDENPYOU INTO GF_HDENPYOU.
GF_DENPYOU = GF_HDENPYOU.
PERFORM FRM_KOUMOKU USING GF_DENPYOU.
ENDLOOP.
CLEAR:GF_NAST.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_EKKO SY-SUBRC.
ENDCASE.

ELSEIF GF_NAST-KAPPL = 'ME'.
* 在庫伝票情報取得
*---MODIFY START PSD T.SAITOH 2002/08/04 ---------------------------*
*     見づらいので構造化
PERFORM FRM_SELECT_MSEG.
*---MODIFY END   PSD T.SAITOH 2002/08/04 ---------------------------*
CASE SY-SUBRC.
WHEN 8.
MESSAGE A603(Z1) WITH G_REPID CNS_MSEG SY-SUBRC.
WHEN 4.
CONTINUE.
WHEN 0.
ZDE_FLG = 1.
*---MODIFY START PSD T.SAITOH 2002/08/04 ---------------------------*
*         見づらいので構造化
PERFORM FRM_SELECT_S_EKKO_EKPO.
*---MODIFY END   PSD T.SAITOH 2002/08/04 ---------------------------*
CASE SY-SUBRC.
WHEN 4.
CONTINUE.
WHEN 0.
*---DELETE START PSD T.SAITOH 2002/08/04 ---------------------------*
** ↓APPEND 2002/02/20 PSD K.Usami
** d) テーブルロック処理
*              PERFORM FRM_ENQUEUE_EZNAST.
** ↑APPEND 2002/02/20 PSD K.Usami
*---DELETE END   PSD T.SAITOH 2002/08/04 ---------------------------*
PERFORM FRM_TORIKESHI.
GF_DENPYOU = GF_ZDENPYOU.
PERFORM FRM_KOUMOKU USING GF_DENPYOU.
CLEAR:GF_NAST.
WHEN 8.
MESSAGE A603(Z1) WITH G_REPID CNS_EKKO SY-SUBRC.
ENDCASE.
ENDCASE.
ENDIF.

ENDLOOP.

ENDFORM.                    " frm_make_data
*&---------------------------------------------------------------------*
*&      Form  frm_remake_data
*&---------------------------------------------------------------------*
*       出力ファイル作成処理(再出力時)
*----------------------------------------------------------------------*
FORM FRM_REMAKE_DATA.

SORT GT_NAST ASCENDING BY KAPPL
OBJKY
*---INSERT START   PSD H.HARUKI 2002/09/22 ---------------------------*
KSCHL
*---INSERT END     PSD H.HARUKI 2002/09/22 ---------------------------*
DATVR DESCENDING
UHRVR DESCENDING.
**---INSERT START   PSD H.HARUKI 2002/09/22 ---------------------------*
DATA: LT_NAST TYPE TABLE OF  TYP_NAST_UNIQ ,
LF_NAST TYPE           TYP_NAST_UNIQ .
LOOP AT GT_NAST INTO GF_NAST .
MOVE-CORRESPONDING GF_NAST TO LF_NAST .
APPEND LF_NAST TO LT_NAST .
ENDLOOP .
REFRESH GT_NAST .
LOOP AT LT_NAST INTO LF_NAST .
MOVE-CORRESPONDING  LF_NAST TO GF_NAST .
AT NEW KSCHL .
APPEND GF_NAST TO GT_NAST .
ENDAT .
ENDLOOP .
**---INSERT END     PSD H.HARUKI 2002/09/22 ---------------------------*

LOOP AT GT_NAST INTO GF_NAST.
*---DELETE START PSD T.SAITOH 2002/04/03再出力時同一OBJKY対応のため削除*
*    IF TMP_NAST-OBJKY <> GF_NAST-OBJKY.
*---DELETE END   PSD T.SAITOH 2002/04/03 ---------------------------*
SELECT SINGLE
KAPPL
OBJKY
KSCHL
LDEST
DATVR
UHRVR
*---INSERT START   PSD H.HARUKI 2002/09/22 ---------------------------*
ERDAT
ERUHR
*---INSERT END     PSD H.HARUKI 2002/09/22 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_NAST
FROM NAST
WHERE OBJKY = GF_NAST-OBJKY
*---INSERT START   PSD H.HARUKI 2002/09/22 ---------------------------*
AND ( KAPPL = 'EF'
AND   KSCHL <> 'ZM99' )
*---INSERT END     PSD H.HARUKI 2002/09/22 ---------------------------*
AND   SPRAS = 'J'
AND   NACHA = '1'
AND   VSTAT = '0'
*---APPEND START PSD H.HARUKI 2002/09/22 ---------------------------*
AND  AKTIV = SPACE .
*---APPEND END   PSD H.HARUKI 2002/09/22 ---------------------------*


CASE SY-SUBRC.
WHEN 0.
CONTINUE.
WHEN 4.
WHEN 8.
MESSAGE A603(Z1) WITH G_REPID CNS_NAST SY-SUBRC.
ENDCASE.

* ①項目の設定
IF GF_NAST-KAPPL = 'EF'.
IF S_MBLNR IS INITIAL.
ELSE.
CONTINUE.
ENDIF.
* 購買発注伝票情報取得
SELECT
A~EKORG A~WAERS A~EKGRP A~BSART A~RESWK
B~EBELN B~EBELP B~MATNR B~WERKS
B~IDNLF B~MENGE B~MEINS B~BPUMZ
B~BPUMN B~NETPR B~PEINH B~KNTTP
B~EVERS B~TXZ01 B~RETPO B~ADRN2 B~ADRNR
*---APPEND START PSD T.SAITOH 2002/04/03 金額-----------------------*
B~NETWR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 登録者----------------------*
A~ERNAM
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 登録者----------------------*
A~LIFNR
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE GT_HDENPYOU
FROM ( EKKO AS A INNER JOIN EKPO     AS B
ON A~EBELN = B~EBELN )
WHERE   A~EBELN    = GF_NAST-OBJKY+0(10)
AND     A~EBELN   IN S_EBELN
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKORG   = PR_EKORG  "購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKGRP   IN S_EKGRP
AND     A~BEDAT   IN S_BEDAT
AND     B~WERKS   IN S_WERKS.

CASE SY-SUBRC.
WHEN 4.
CONTINUE.
WHEN 0.
*---DELETE START PSD T.SAITOH 2002/08/04 ---------------------------*
** ↓APPEND 2002/02/20 PSD K.Usami
** d) テーブルロック処理
*          PERFORM FRM_ENQUEUE_EZNAST.
** ↑APPEND 2002/02/20 PSD K.Usami
*---DELETE END   PSD T.SAITOH 2002/08/04 ---------------------------*
HDE_FLG = 1.
LOOP AT GT_HDENPYOU INTO GF_HDENPYOU.
GF_DENPYOU = GF_HDENPYOU.
PERFORM FRM_KOUMOKU USING GF_DENPYOU.
ENDLOOP.
CLEAR:GF_NAST.
WHEN 8.
MESSAGE A603(Z1) WITH G_REPID CNS_EKKO SY-SUBRC.
ENDCASE.
* 在庫伝票情報取得
ELSEIF GF_NAST-KAPPL = 'ME'.
SELECT SINGLE
MBLNR
MJAHR
ZEILE
EBELN
EBELP
BWART
SMBLN
SJAHR
SMBLP
BPMNG
BPRME
DMBTR
INTO CORRESPONDING FIELDS OF GF_MSEG
FROM MSEG
WHERE MBLNR = GF_NAST-OBJKY+0(10)
AND MBLNR IN S_MBLNR
AND MJAHR = GF_NAST-OBJKY+10(4)
AND MJAHR IN S_MJAHR
AND ZEILE = GF_NAST-OBJKY+14(4)
AND ZEILE IN S_ZEILE.

CASE SY-SUBRC.
WHEN 8.
MESSAGE A603(Z1) WITH G_REPID CNS_MSEG SY-SUBRC.
WHEN 4.
CONTINUE.
WHEN 0.
ZDE_FLG = 1.
SELECT SINGLE
A~EKORG A~WAERS A~EKGRP
B~EBELN B~EBELP B~MATNR B~WERKS
B~IDNLF B~MENGE B~MEINS B~BPUMZ
B~BPUMN B~NETPR B~PEINH B~KNTTP
B~EVERS B~TXZ01 B~RETPO B~ADRN2 B~ADRNR
*---APPEND START PSD T.SAITOH 2002/04/03 金額-----------------------*
B~NETWR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 登録者----------------------*
A~ERNAM
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_ZDENPYOU
FROM ( EKKO AS A INNER JOIN EKPO     AS B
ON A~EBELN = B~EBELN )
WHERE   A~EBELN    = GF_MSEG-EBELN
AND     A~EBELN   IN S_EBELN
AND     B~EBELP    = GF_MSEG-EBELP
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKORG   = PR_EKORG  "購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKGRP   IN S_EKGRP
AND     A~BEDAT   IN S_BEDAT
AND     B~WERKS   IN S_WERKS.

CASE SY-SUBRC.
WHEN 4.
CONTINUE.
WHEN 0.
*---DELETE START PSD T.SAITOH 2002/08/04 ---------------------------*
** ↓APPEND 2002/02/20 PSD K.Usami
** d) テーブルロック処理
*              PERFORM FRM_ENQUEUE_EZNAST.
** ↑APPEND 2002/02/20 PSD K.Usami
*---DELETE END   PSD T.SAITOH 2002/08/04 ---------------------------*
PERFORM FRM_TORIKESHI.
GF_DENPYOU = GF_ZDENPYOU.
PERFORM FRM_KOUMOKU USING GF_DENPYOU.
CLEAR:GF_NAST.
WHEN 8.
MESSAGE A603(Z1) WITH G_REPID CNS_EKKO SY-SUBRC.
ENDCASE.
ENDCASE.
ENDIF.
*---DELETE START PSD T.SAITOH 2002/04/03再出力時同一OBJKY対応のため削除*
*    ENDIF.
*---DELETE END   PSD T.SAITOH 2002/04/03 ---------------------------*

ENDLOOP.

ENDFORM.                    " frm_remake_data
*&---------------------------------------------------------------------*
*&      Form  frm_torikeshi
*&---------------------------------------------------------------------*
*       取消伝票チェック
*----------------------------------------------------------------------*
FORM FRM_TORIKESHI.

READ TABLE GT_SMSEG WITH KEY SMBLN = GF_MSEG-MBLNR
SJAHR = GF_MSEG-MJAHR
SMBLP = GF_MSEG-ZEILE
INTO GF_SMSEG.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-TORIKESHI = CNS_X.
ENDCASE.

ENDFORM.                    " frm_torikeshi
*&---------------------------------------------------------------------*
*&      Form  frm_koumoku
*&---------------------------------------------------------------------*
*       項目の設定
*----------------------------------------------------------------------*
FORM FRM_KOUMOKU USING P_GF_DENPYOU.
DATA : L_NETWR LIKE EKPO-NETWR.
*---APPEND START NDSC R.HATA  2003/01/15 受注伝票-------------------*
*---------------2003/04/25 UPDATE START S.IWAKI(NDSC)
*           Select VBELV From VBFA Into GF_WRITE-VBELV
*                       Where VBELN EQ GF_DENPYOU-EBELN .
*                  Exit .
*           EndSelect .
SELECT SINGLE VBELN INTO  GF_WRITE-VBELV
FROM EKKN WHERE EBELN = GF_DENPYOU-EBELN
AND EBELP = GF_DENPYOU-EBELP
AND ZEKKN = '01'.
*---------------2003/04/25 UPDATE START S.IWAKI(NDSC)
MOVE GF_DENPYOU-ERNAM TO GF_WRITE-ERNAM .
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*


* ①更新条件項目設定

GF_WRITE-KAPPL = GF_NAST-KAPPL.
GF_WRITE-KSCHL = GF_NAST-KSCHL.
GF_WRITE-EBELN = GF_DENPYOU-EBELN.
GF_WRITE-DATVR = GF_NAST-DATVR.
GF_WRITE-UHRVR = GF_NAST-UHRVR.
*---APPEND START PSD T.SAITOH 2002/04/03 登録日、登録時間を考慮------*
GF_WRITE-ERDAT = GF_NAST-ERDAT."登録日
GF_WRITE-ERUHR = GF_NAST-ERUHR."登録時間
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*

IF GF_NAST-KAPPL = 'ME'.
GF_WRITE-MBLNR = GF_MSEG-MBLNR.
GF_WRITE-MJAHR = GF_MSEG-MJAHR.
GF_WRITE-ZEILE = GF_MSEG-ZEILE.
GF_WRITE-BWART = GF_MSEG-BWART.
CONCATENATE
GF_WRITE-MBLNR
GF_WRITE-MJAHR
GF_WRITE-ZEILE
INTO GF_WRITE-WOBJKY.
ELSEIF GF_NAST-KAPPL = 'EF'.
GF_WRITE-WOBJKY = GF_WRITE-EBELN.
ENDIF.

* ↓APPEND 2002/02/22 PSD K.Usami
* 発注外運送費伝票変数設定
IF GF_DENPYOU-MTART = 'Z001'.
GF_WRITE-MTART = CNS_X.
*---APPEND START PSD T.SAITOH 2002/08/04 ---------------------------*
*   ロック個所変更とすでにロックされていた場合対象外処理追加
PERFORM FRM_ENQUEUE_EZNAST.
IF G_RETURN_CODE <> 0.
EXIT.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/08/04 ---------------------------*
APPEND GF_WRITE TO GT_WRITE.
EXIT.
ENDIF.
* ↑APPEND 2002/02/22 PSD K.Usami

* ②出力項目設定
* ｱ) ヘッダ行の設定
PERFORM FRM_HEAD.
* ｲ) 伝票番号
CONCATENATE
GF_DENPYOU-WERKS+1(2)
'-'
GF_DENPYOU-EBELN
'-'
*---MODIFY START PSD T.SAITOH 2002/08/05 ---------------------------*
*   明細番号は１桁とする
*    GF_DENPYOU-EBELP+2(3)
GF_DENPYOU-EBELP+3(1)
*---MODIFY END   PSD T.SAITOH 2002/08/05 ---------------------------*
INTO DNUM.
GF_WRITE-DNUM = DNUM.
* ｳ) プリンタ/トレイ
IF PR_LNAME <> ' '.
GF_WRITE-LNAME = PR_LNAME.
*↓APPEND 2002/02/15 プリンタ/トレイ設定不具合対応
* MODIFY PSD K.ARAI 2002/05/28
READ TABLE GT_PRINTA WITH TABLE KEY LNAME = PR_LNAME
*    READ TABLE GT_PRINTA WITH KEY LNAME = PR_LNAME
* MODIFY END
INTO GF_PRINTA.
GF_WRITE-PADEST = GF_PRINTA-PADEST.
* ↑
ELSE.
READ TABLE GT_PRINTA WITH KEY PADEST = GF_NAST-LDEST
INTO GF_PRINTA.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-LNAME = GF_PRINTA-LNAME.
GF_WRITE-PADEST = GF_PRINTA-PADEST.
*---APPEND START PSD T.SAITOH 2002/08/04 ---------------------------*
*       プリンタ/トレイ未取得伝票変数設定後の取得レコードが全て
*       エラー対象レコードとなるバグを修正
GF_WRITE-ERROR = SPACE. " プリンタ/トレイ取得伝票変数設定
*---APPEND END   PSD T.SAITOH 2002/08/04 ---------------------------*
WHEN 4.
GF_WRITE-ERROR = CNS_X. " プリンタ/トレイ未取得伝票変数設定
*---APPEND START PSD T.SAITOH 2002/08/04 ---------------------------*
*   ロック個所変更とすでにロックされていた場合対象外処理追加
PERFORM FRM_ENQUEUE_EZNAST .
IF G_RETURN_CODE <> 0.
EXIT.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/08/04 ---------------------------*
*---APPEND START DMC A.MASUDA 2005/02/22 ---------------------------*
CLEAR:GF_WRITE-TNAME.
* 担当者名の設定②
PERFORM FRM_SET_TNAME USING    GF_DENPYOU-EBELN
GF_DENPYOU-EBELP
CHANGING GF_WRITE-TNAME.
* 担当者名取得時
IF ( GF_WRITE-TNAME <> SPACE ) OR
( GF_WRITE-TNAME = SPACE AND FLG_TEC = CNS_X ).
APPEND GF_WRITE TO GT_WRITE.
ENDIF.
*---APPEND END   DMC A.MASUDA 2005/02/22 ---------------------------*
APPEND GF_WRITE TO GT_WRITE.
EXIT.
ENDCASE.
ENDIF.
* ｴ) 帳票名
*---MODIFY START PSD T.SAITOH 2002/04/02 ---------------------------*
* このロジックでは返品伝票以外の変更取消区分は取得できないため廃止
*---DELETE START PSD T.SAITOH 2002/04/02 ---------------------------*
*  IF GF_DENPYOU-RETPO = CNS_X. " 返品伝票
*    GF_WRITE-OBJDES = TEXT-048.
*  ELSE.
*    READ TABLE GT_TYPE WITH KEY KAPPL = GF_NAST-KAPPL
*                                KSCHL = GF_NAST-KSCHL
*                                INTO GF_TYPE.
*    CASE SY-SUBRC.
*      WHEN 0.
*        SPLIT GF_TYPE-OBJDES AT '/' INTO OBJDES1 OBJDES2.
*        GF_WRITE-OBJDES = OBJDES1.
*      WHEN 4.
*    ENDCASE.
*
*  ENDIF.
*---DELETE END   PSD T.SAITOH 2002/04/02 ---------------------------*
* 返品伝票のみ再設定のロジックに変更
READ TABLE GT_TYPE WITH KEY KAPPL = GF_NAST-KAPPL
KSCHL = GF_NAST-KSCHL
INTO GF_TYPE.
CASE SY-SUBRC.
WHEN 0.
SPLIT GF_TYPE-OBJDES AT '/' INTO OBJDES1 OBJDES2.
GF_WRITE-OBJDES = OBJDES1.
WHEN 4.
ENDCASE.

* 仕様変更により廃止（返品伝票判断）
*   IF GF_DENPYOU-RETPO = CNS_X. " 返品伝票
*     GF_WRITE-OBJDES = TEXT-048.
*   ENDIF.

*---MODIFY END   PSD T.SAITOH 2002/04/02 ---------------------------*

* ｵ) 出力日
GF_WRITE-DATUM = G_DATA.

* ｶ) 手配先郵便番号/手配先住所
SELECT SINGLE
A~LIFNR A~NAME2 A~REGIO A~LAND1
A~PSTLZ A~STRAS A~ORT01 B~LIFN2
*---APPEND START PSD T.SAITOH 2002/04/08 ---------------------------*
A~ADRNR
*---APPEND END   PSD T.SAITOH 2002/04/08 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_TEHAI
FROM ( LFA1 AS A INNER JOIN EKPA     AS B
ON A~LIFNR = B~LIFN2 )
WHERE   B~EBELN    = GF_DENPYOU-EBELN
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
AND     B~EKORG   = PR_EKORG  "購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
AND     B~PARVW    = 'BA'.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-PSTLZ = GF_TEHAI-PSTLZ.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_LFA1 SY-SUBRC.
ENDCASE.

SELECT SINGLE
BEZEI
INTO CORRESPONDING FIELDS OF GF_TEHAI
FROM T005U
WHERE   BLAND    = GF_TEHAI-REGIO
AND     SPRAS    = 'J'
AND     LAND1    = GF_TEHAI-LAND1.

CASE SY-SUBRC.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_T005U SY-SUBRC.
WHEN 4.    " 対象データなし
WHEN 0.
*---APPEND START PSD T.SAITOH 2002/04/08 ---------------------------*
PERFORM FRM_SELECT_ADRC USING GF_TEHAI-ADRNR
CHANGING GF_TEHAI-STRAS.
*---APPEND END   PSD T.SAITOH 2002/04/08 ---------------------------*
CONCATENATE
GF_TEHAI-BEZEI
GF_TEHAI-STRAS
GF_TEHAI-ORT01
INTO GF_WRITE-JUSYO.
*---APPEND START NDSC A.MASUDA 2004/04/22 ---------------------------*
GF_WRITE-LIFNR = GF_TEHAI-LIFNR.
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*


ENDCASE.
* ｷ) 手配先名
IF GF_DENPYOU-BSART = 'UB'.
* MODIFY PSD K.ARAI 2002/05/28
READ TABLE GT_PLANT WITH TABLE KEY WERKS = GF_DENPYOU-RESWK
*    READ TABLE GT_PLANT WITH KEY WERKS = GF_DENPYOU-RESWK
* MODIFY END
INTO GF_PLANT.
GF_WRITE-NAME = GF_PLANT-NAME1.
* ↓APPEND 2002/02/14 PSD M.Arai 手配先範囲指定不具合対応
IF NOT GF_DENPYOU-RESWK IN S_LIFNR.
CLEAR GF_WRITE.
EXIT.
ENDIF.
* ↑
ELSE.
GF_WRITE-NAME = GF_TEHAI-NAME2.
* ↓APPEND 2002/02/14 PSD M.Arai 手配先範囲指定不具合対応
IF NOT GF_TEHAI-LIFNR IN S_LIFNR.
CLEAR GF_WRITE.
EXIT.
ENDIF.
* ↑
ENDIF.

* ｸ) 手配先担当者名･手配先電話番号･手配先FAX番号
IF GF_DENPYOU-BSART = 'UB'.
ELSE.
SELECT SINGLE
VERKF
TELF1
INTO CORRESPONDING FIELDS OF GF_TTANTOU
FROM LFM2
WHERE LIFNR = GF_TEHAI-LIFN2
AND   EKORG = GF_DENPYOU-EKORG
AND   WERKS = GF_DENPYOU-WERKS.

* ↓APPEND 2002/02/25 PSD K.Usami
IF SY-SUBRC = 0 AND GF_TTANTOU-VERKF <> ' '.
SPLIT GF_TTANTOU-VERKF AT '@' INTO VERKF1 VERKF2.
GF_WRITE-VERKF = VERKF1."手配先担当者名
GF_WRITE-TEL = VERKF2."手配先電話番号
GF_WRITE-FAX = GF_TTANTOU-TELF1."手配先FAX番号

ELSEIF SY-SUBRC = 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_LFM1 SY-SUBRC.
ELSEIF ( SY-SUBRC = 0 AND GF_TTANTOU-VERKF = ' ' )
OR SY-SUBRC = 4.
SELECT SINGLE
VERKF
TELF1
INTO CORRESPONDING FIELDS OF GF_TTANTOU
FROM LFM1
WHERE LIFNR = GF_TEHAI-LIFN2
AND   EKORG = GF_DENPYOU-EKORG.

IF SY-SUBRC = 0 AND GF_TTANTOU-VERKF <> ' '.
SPLIT GF_TTANTOU-VERKF AT '@' INTO VERKF1 VERKF2.
GF_WRITE-VERKF = VERKF1."手配先担当者名
GF_WRITE-TEL = VERKF2."手配先電話番号
GF_WRITE-FAX = GF_TTANTOU-TELF1."手配先FAX番号

ELSEIF SY-SUBRC = 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_LFM1 SY-SUBRC.
ELSEIF ( SY-SUBRC = 0 AND GF_TTANTOU-VERKF = ' ' )
OR SY-SUBRC = 4.
SELECT SINGLE
TELFX
TELF1
INTO CORRESPONDING FIELDS OF GF_TTANTOU
FROM LFA1
WHERE LIFNR = GF_TEHAI-LIFN2.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-TEL = GF_TTANTOU-TELF1."手配先電話番号
GF_WRITE-FAX = GF_TTANTOU-TELFX."手配先FAX番号

WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_LFM1 SY-SUBRC.
ENDCASE.
ENDIF.
ENDIF.
ENDIF.
* ↑APPEND 2002/02/25 PSD K.Usami

*    CASE SY-SUBRC.
*      WHEN 0.
*        SPLIT GF_TTANTOU-VERKF AT '@' INTO VERKF1 VERKF2.
*        GF_WRITE-VERKF = VERKF1.
*      WHEN 8.    " システムエラー
*        MESSAGE a603(Z1) WITH G_REPID CNS_LFM2 SY-SUBRC.
*      WHEN 4.    " 対象データなし
*        SELECT SINGLE
*          VERKF
*          TELF1
*          INTO CORRESPONDING FIELDS OF GF_TTANTOU
*          FROM LFM1
*          WHERE LIFNR = GF_TEHAI-LIFN2
*          AND   EKORG = GF_DENPYOU-EKORG.
*
*        CASE SY-SUBRC.
*          WHEN 0.
*            SPLIT GF_TTANTOU-VERKF AT '@' INTO VERKF1 VERKF2.
*            GF_WRITE-VERKF = VERKF1.
*          WHEN 8.    " システムエラー
*            MESSAGE a603(Z1) WITH G_REPID CNS_LFM1 SY-SUBRC.
*          WHEN 4.    " 対象データなし
*            SELECT SINGLE
*            VERKF
*            TELF1
*            INTO CORRESPONDING FIELDS OF GF_TTANTOU
*            FROM LFM1
*            WHERE LIFNR = GF_TEHAI-LIFN2.
*            CASE SY-SUBRC.
*              WHEN 0.
*                SPLIT GF_TTANTOU-VERKF AT '@' INTO VERKF1 VERKF2.
*                GF_WRITE-VERKF = VERKF1.
*              WHEN 8.    " システムエラー
*                MESSAGE a603(Z1) WITH G_REPID CNS_LFM1 SY-SUBRC.
*            ENDCASE.
*        ENDCASE.
*    ENDCASE.
*  ENDIF.
*
** ｺ) 手配先電話番号
*  GF_WRITE-TEL = VERKF2.
*
** ｻ) 手配先FAX番号
*  GF_WRITE-FAX = GF_TTANTOU-TELF1.

* ｼ) 部門名
* MODIFY PSD K.ARAI 2002/05/28
READ TABLE GT_PLANT WITH TABLE KEY WERKS = GF_DENPYOU-WERKS
*  READ TABLE GT_PLANT WITH KEY WERKS = GF_DENPYOU-WERKS
* MODIFY END
INTO GF_PLANT.

GF_WRITE-PLANT = GF_PLANT-NAME1.

* ｽ) 担当者名
* MODIFY PSD K.ARAI 2002/05/28
READ TABLE GT_KOUBAI WITH TABLE KEY EKGRP = GF_DENPYOU-EKGRP
*  READ TABLE GT_KOUBAI WITH KEY EKGRP = GF_DENPYOU-EKGRP
* MODIFY END
INTO GF_KOUBAI.
GF_WRITE-EKNAM = GF_KOUBAI-EKNAM.

* ｾ) 担当者電話番号
GF_WRITE-EKTEL = GF_KOUBAI-EKTEL.

* ｿ) 担当者FAX番号
GF_WRITE-TELFX = GF_KOUBAI-TELFX.

* ﾀ) 変更取消区分
GF_WRITE-KUBUN = OBJDES2.

* ﾁ) 品目コード
*---MODIFY START PSD T.SAITOH 2002/08/06 ---------------------------*
IF GF_DENPYOU-IDNLF <> ' '.
GF_WRITE-KDMAT = GF_DENPYOU-IDNLF.
ELSE.
GF_WRITE-KDMAT = GF_DENPYOU-MATNR.
ENDIF.
*  IF GF_DENPYOU-KNTTP = 'M'.
*    SELECT SINGLE
*    B~KDMAT
*    C~ADRNR
*    INTO CORRESPONDING FIELDS OF GF_HINMOKU
*    FROM ( EKKN AS A INNER JOIN VBAP     AS B
*    ON  A~VBELN = B~VBELN
*    AND A~VBELP = B~POSNR
*                     INNER JOIN VBPA     AS C
*    ON  B~VBELN = C~VBELN )
*    WHERE   A~EBELN    = GF_DENPYOU-EBELN
*    AND     A~EBELP    = GF_DENPYOU-EBELP
*    AND     C~POSNR    = '000000'
*    AND     C~PARVW    = 'WE'.
*
*    CASE SY-SUBRC.
*      WHEN 0.
** ↓APPEND 2002/02/25 PSD K.Usami
**        GF_WRITE-KDMAT = GF_HINMOKU-KDMAT.
*        IF GF_HINMOKU-KDMAT <> ' '.
*          GF_WRITE-KDMAT = GF_HINMOKU-KDMAT.
*        ELSE.
*          IF GF_DENPYOU-IDNLF <> ' '.
*            GF_WRITE-KDMAT = GF_DENPYOU-IDNLF.
*          ELSE.
*            GF_WRITE-KDMAT = GF_DENPYOU-MATNR.
*          ENDIF.
*        ENDIF.
** ↑APPEND 2002/02/25 PSD K.Usami
*      WHEN 8.    " システムエラー
*        MESSAGE A603(Z1) WITH G_REPID CNS_EKKN SY-SUBRC.
*      WHEN 4.    " 対象データなし
*        IF GF_DENPYOU-IDNLF <> ' '.
*          GF_WRITE-KDMAT = GF_DENPYOU-IDNLF.
*        ELSE.
*          GF_WRITE-KDMAT = GF_DENPYOU-MATNR.
*        ENDIF.
*    ENDCASE.
*
*  ELSE.
*    IF GF_DENPYOU-IDNLF <> ' '.
*      GF_WRITE-KDMAT = GF_DENPYOU-IDNLF.
*    ELSE.
*      GF_WRITE-KDMAT = GF_DENPYOU-MATNR.
*    ENDIF.
*
*  ENDIF.
*---MODIFY END   PSD T.SAITOH 2002/08/06 ---------------------------*

* ﾂ) 商品名
GF_WRITE-TXZ01 = GF_DENPYOU-TXZ01.

* ﾃ) 納入場所(名称)
IF GF_DENPYOU-ADRNR <> ' '.
SELECT SINGLE
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    STREET
*    CITY1
*    TEL_NUMBER
ADRC~STREET
ADRC~CITY1
ADRC~TEL_NUMBER
*---APPEND START PSD T.SAITOH 2002/07/28 ---------------------------*
*    NAME1
*    NAME2
ADRC~NAME2
*---APPEND END   PSD T.SAITOH 2002/07/28 ---------------------------*
*---MODIFY END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*
T005U~BEZEI
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_NOUNYU
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    FROM ADRC
*    FROM ADRC
*    INNER JOIN T005U
*       ON T005U~BLAND = ADRC~REGION
*    WHERE ADDRNUMBER = GF_DENPYOU-ADRNR
*      AND T005U~SPRAS = 'J'
*      AND T005U~LAND1 = 'JP'.
*---MODIFY END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---MODIFY START D.YI 2007/11/15 ---------------------------*
FROM ADRC
INNER JOIN T005U
ON   T005U~BLAND = ADRC~REGION
AND T005U~SPRAS = ADRC~LANGU
AND T005U~LAND1 = ADRC~COUNTRY
WHERE ADDRNUMBER = GF_DENPYOU-ADRNR.
*---MODIFY END   D.YI 2007/11/15 ---------------------------*


* ↓APPEND 2002/02/14 PSD M.Arai 納入場所設定不具合対応
CASE SY-SUBRC.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_ADRC SY-SUBRC.
WHEN 0.
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*        GF_WRITE-NNAME = GF_NOUNYU-NAME1.
GF_WRITE-NNAME = GF_NOUNYU-NAME2.
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
ENDCASE.
* ↑

ELSEIF GF_DENPYOU-ADRN2 <> ' '.
SELECT SINGLE
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    STREET
*    CITY1
*    TEL_NUMBER
ADRC~STREET
ADRC~CITY1
ADRC~TEL_NUMBER
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*    NAME1
*    NAME2
ADRC~NAME2
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
*---MODIFY END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*
T005U~BEZEI
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_NOUNYU
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    FROM ADRC
*    FROM ADRC
*    INNER JOIN T005U
*       ON T005U~BLAND = ADRC~REGION
*    WHERE ADDRNUMBER = GF_DENPYOU-ADRN2
*      AND T005U~SPRAS = 'J'
*      AND T005U~LAND1 = 'JP'.
*---MODIFY END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---MODIFY START D.YI 2007/11/15 ---------------------------*
FROM ADRC
INNER JOIN T005U
ON   T005U~BLAND = ADRC~REGION
AND T005U~SPRAS = ADRC~LANGU
AND T005U~LAND1 = ADRC~COUNTRY
WHERE ADDRNUMBER = GF_DENPYOU-ADRN2.
*---MODIFY END   D.YI 2007/11/15 ---------------------------*
CASE SY-SUBRC.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_ADRC SY-SUBRC.
WHEN 0.
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*        GF_WRITE-NNAME = GF_NOUNYU-NAME1.
GF_WRITE-NNAME = GF_NOUNYU-NAME2.
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
ENDCASE.

ELSEIF GF_DENPYOU-ADRNR  = ' ' AND
GF_DENPYOU-ADRN2 = ' ' AND
GF_DENPYOU-EVERS = 'Z1'.
SELECT SINGLE
B~KDMAT
C~ADRNR
INTO CORRESPONDING FIELDS OF GF_NOUNYU
FROM ( EKKN AS A       INNER JOIN VBAP     AS B
ON A~VBELN = B~VBELN
AND A~VBELP = B~POSNR ) INNER JOIN VBPA     AS C
ON B~VBELN = C~VBELN
WHERE  A~EBELN    = GF_DENPYOU-EBELN
AND    A~EBELP    = GF_DENPYOU-EBELP
AND    C~POSNR    = '000000'
AND    C~PARVW    = 'WE'.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_EKKN SY-SUBRC.
ENDCASE.

SELECT SINGLE
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    STREET
*    CITY1
*    TEL_NUMBER
ADRC~STREET
ADRC~CITY1
ADRC~TEL_NUMBER
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*    NAME1
*---APPEND START   NDSC A.MASUDA 2004/04/22 ---------------------------*
*    NAME2
ADRC~NAME2
T005U~BEZEI
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_NOUNYU
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    FROM ADRC
*    FROM ADRC
*    INNER JOIN T005U
*       ON T005U~BLAND = ADRC~REGION
*    WHERE ADDRNUMBER = GF_NOUNYU-ADRNR
*      AND T005U~SPRAS = 'J'
*      AND T005U~LAND1 = 'JP'.
*---MODIFY END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---MODIFY START D.YI 2007/11/15 ---------------------------*
FROM ADRC
INNER JOIN T005U
ON   T005U~BLAND = ADRC~REGION
AND T005U~SPRAS = ADRC~LANGU
AND T005U~LAND1 = ADRC~COUNTRY
WHERE ADDRNUMBER = GF_NOUNYU-ADRNR.
*---MODIFY END   D.YI 2007/11/15 ---------------------------*
CASE SY-SUBRC.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_ADRC SY-SUBRC.
WHEN 0.
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*        GF_WRITE-NNAME = GF_NOUNYU-NAME1.
GF_WRITE-NNAME = GF_NOUNYU-NAME2.
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
ENDCASE.

ELSE.
* MODIFY PSD K.ARAI 2002/05/28
READ TABLE GT_PLANT INTO GF_PLANT
WITH TABLE  KEY  WERKS =  GF_DENPYOU-WERKS
.
*    READ TABLE GT_PLANT WITH KEY GF_DENPYOU-WERKS
*    INTO GF_PLANT.
* MODIFY END

SELECT SINGLE
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    STREET
*    CITY1
*    TEL_NUMBER
ADRC~STREET
ADRC~CITY1
ADRC~TEL_NUMBER
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*    NAME1
*---APPEND START   NDSC A.MASUDA 2004/04/22 ---------------------------*
*    NAME2
ADRC~NAME2
T005U~BEZEI
*---APPEND END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_NOUNYU
*---MODIFY START NDSC A.MASUDA 2004/04/22 ---------------------------*
*    FROM ADRC
*    FROM ADRC
*    INNER JOIN T005U
*       ON T005U~BLAND = ADRC~REGION
*    WHERE ADDRNUMBER = GF_PLANT-ADRNR
*      AND T005U~SPRAS = 'J'
*      AND T005U~LAND1 = 'JP'.
*---MODIFY END   NDSC A.MASUDA 2004/04/22 ---------------------------*
*---MODIFY START D.YI 2007/11/15 ---------------------------*
FROM ADRC
INNER JOIN T005U
ON   T005U~BLAND = ADRC~REGION
AND T005U~SPRAS = ADRC~LANGU
AND T005U~LAND1 = ADRC~COUNTRY
WHERE ADDRNUMBER = GF_PLANT-ADRNR.
*---MODIFY END   D.YI 2007/11/15 ---------------------------*
CASE SY-SUBRC.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_ADRC SY-SUBRC.
WHEN 0.
*---MODIFY START PSD T.SAITOH 2002/07/28 ---------------------------*
*        GF_WRITE-NNAME = GF_NOUNYU-NAME1.
GF_WRITE-NNAME = GF_NOUNYU-NAME2.
*---MODIFY END   PSD T.SAITOH 2002/07/28 ---------------------------*
ENDCASE.

ENDIF.

* ﾄ) 納入場所(住所)
CONCATENATE
*---APPEND START NDSC A.MASUDA 2004/04/22 ---------------------------*
GF_NOUNYU-BEZEI
*---APPEND END NDSC A.MASUDA 2004/04/22 ---------------------------*
GF_NOUNYU-STREET
GF_NOUNYU-CITY1
INTO GF_WRITE-CITY1.

* ﾅ) 納入場所(電話番号)
GF_WRITE-TEL_NUMBER = GF_NOUNYU-TEL_NUMBER.

* ﾆ) 発注数(数量)
IF GF_NAST-KAPPL = 'EF'.
IF GF_DENPYOU-RETPO = CNS_X.
GF_WRITE-HMENGE = GF_DENPYOU-MENGE * -1.
ELSE.
GF_WRITE-HMENGE =  GF_DENPYOU-MENGE.
ENDIF.

ELSEIF GF_NAST-KAPPL = 'ME'.
GF_WRITE-HMENGE = GF_MSEG-BPMNG * -1.
ENDIF.

IF GF_WRITE-HMENGE < 0.
SHIFT GF_WRITE-HMENGE RIGHT CIRCULAR.
ENDIF.
CONDENSE GF_WRITE-HMENGE NO-GAPS.

* ﾇ) 発注数(単位)
IF GF_NAST-KAPPL = 'EF'.
WRITE GF_DENPYOU-MEINS TO GF_WRITE-MEINS.
ELSEIF GF_NAST-KAPPL = 'ME'.
WRITE GF_MSEG-BPRME TO GF_WRITE-MEINS.
ENDIF.

* ﾈ) 発注単価
IF GF_DENPYOU-BSART = 'UB'.
GF_WRITE-TANKA = ' '.
ELSE.

* ↓APPEND 2002/02/20 PSD K.Usami
*    IF GF_NAST-KAPPL = 'EF'.
*---正味額の価格変換
I_GF_DENPYOU_NETPR = 0.

CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = GF_DENPYOU-WAERS
SAP_AMOUNT  = GF_DENPYOU-NETPR
IMPORTING
IDOC_AMOUNT = I_GF_DENPYOU_NETPR.

TURN_NETPR = I_GF_DENPYOU_NETPR.   " GF_DENPYOU_NETPR
IF GF_DENPYOU-PEINH = 0.
GF_WRITE-TANKA = 0.
ELSE.
GF_WRITE-TANKA = TURN_NETPR / GF_DENPYOU-PEINH.
ENDIF.
*---APPEND START PSD K.ARAI   2002/05/13 ---------------------------*
*---金額項目左詰にする
CONDENSE GF_WRITE-TANKA NO-GAPS.
*---APPEND END   PSD K.ARAI   2002/05/13 ---------------------------*

*    ELSEIF GF_NAST-KAPPL = 'ME'.
*      I_GF_MSEG_DMBTR = 0.
*
*      CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
*           EXPORTING
*                CURRENCY    = GF_DENPYOU-WAERS
*                SAP_AMOUNT  = GF_MSEG-DMBTR
*           IMPORTING
*                IDOC_AMOUNT = I_GF_MSEG_DMBTR.
*
*      TURN_DMBTR = I_GF_MSEG_DMBTR.   " GF_MSEG_DMBTR
*      IF GF_MSEG-BPMNG = 0.
*        GF_WRITE-TANKA = 0.
*      ELSE.
*        GF_WRITE-TANKA = TURN_DMBTR / GF_MSEG-BPMNG.
*      ENDIF.
*    ENDIF.
ENDIF.

* 通貨
GF_WRITE-WAERS = GF_DENPYOU-WAERS.

* ↑APPEND 2002/02/20 PSD K.Usami

* ﾉ) 備考
*---MODIFY START PSD T.IIDA 2002/07/04 ---------------------------*
* 出荷指示テキストを備考より抜出し別編集とするので後に記述し
* ここではコメントとする。これにより関連箇所もコメントにします
*-----------------------------------------------------------------*
*  IF GF_DENPYOU-EVERS <> ' '.
*    SELECT SINGLE
*          EVTXT
*          INTO CORRESPONDING FIELDS OF GF_BIKOU
*          FROM T027B
*          WHERE EVERS = GF_DENPYOU-EVERS
*          AND   SPRAS = 'J'.
*
*    CASE SY-SUBRC.
*      WHEN 0.
*      WHEN 4.    " 対象データなし
*      WHEN 8.    " システムエラー
*        MESSAGE A603(Z1) WITH G_REPID CNS_T027B SY-SUBRC.
*    ENDCASE.
*
*    CONCATENATE
*    GF_DENPYOU-EBELN
*    GF_DENPYOU-EBELP
*    INTO W_NAME.
*
*    PERFORM FRM_READ_TEXT USING W_NAME.
*    CONCATENATE
*    GF_BIKOU-EVTXT
*    BIKOU
*    INTO GF_WRITE-BIKOU SEPARATED BY SPACE.
*
*  ELSEIF GF_DENPYOU-EVERS = ' '.
CONCATENATE
GF_DENPYOU-EBELN
GF_DENPYOU-EBELP
INTO W_NAME.

PERFORM FRM_READ_TEXT USING W_NAME.
GF_WRITE-BIKOU = BIKOU.

*  ENDIF.
*---MODIFY END PSD T.IIDA 2002/07/04 -------------------------------*

* ﾊ) 依頼納期
*---MODIFY START PSD T.SAITOH 2002/04/03 ---------------------------*
* 依頼納期条件追加：入庫返品の時も空白を設定する
*（NAST-KAPPL = 'ME'(在庫管理))
*  IF GF_DENPYOU-RETPO = CNS_X. " 返品伝票
IF GF_DENPYOU-RETPO = CNS_X OR GF_WRITE-KAPPL = CNS_ME. " 返品伝票
*---MODIFY END   PSD T.SAITOH 2002/04/03 ---------------------------*
GF_WRITE-SLFDT = ' '.
ELSE.

SELECT
ETENR
* Mod 2003.10.30 -->>
*     slfdt
EINDT
* Mod 2003.10.30 <<--
MENGE
INTO CORRESPONDING FIELDS OF TABLE GT_IRAI
FROM EKET
WHERE EBELN = GF_DENPYOU-EBELN
AND   EBELP = GF_DENPYOU-EBELP
AND   ETENR = '001'.

CASE SY-SUBRC.
WHEN 0.
SORT GT_IRAI ASCENDING BY ETENR.
READ TABLE GT_IRAI INDEX 1 INTO GF_IRAI.
* Mod 2003.10.30 -->>
*        gf_write-slfdt = gf_irai-slfdt.
GF_WRITE-SLFDT = GF_IRAI-EINDT.
* Mod 2003.10.30 <<--
GF_WRITE-MENGE = ' '.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_EKET SY-SUBRC.
ENDCASE.
ENDIF.
*---APPEND START PSD K.ARAI   2002/05/13 金額項目設定----------------*
IF GF_NAST-KAPPL = 'ME'.
L_NETWR = GF_MSEG-DMBTR.
ELSE.
L_NETWR = GF_DENPYOU-NETWR.
ENDIF.
*---APPEND END   PSD K.ARAI   2002/05/13 金額項目設定----------------*

*---APPEND START PSD T.SAITOH 2002/04/03 金額項目設定----------------*
* 金額
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_IDOC'
EXPORTING
CURRENCY    = GF_DENPYOU-WAERS
*---MODIFY START PSD K.ARAI   2002/05/13 金額項目設定----------------*
SAP_AMOUNT  = L_NETWR
*           SAP_AMOUNT  = GF_DENPYOU-NETWR
*---MODIFY END   PSD K.ARAI   2002/05/13 金額項目設定----------------*
IMPORTING
IDOC_AMOUNT = I_GF_DENPYOU_NETWR.

GF_WRITE-NETWR = I_GF_DENPYOU_NETWR.

IF GF_WRITE-NETWR < 0.
SHIFT GF_WRITE-NETWR RIGHT CIRCULAR.
ENDIF.
CONDENSE GF_WRITE-NETWR NO-GAPS.
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*

*---APPEND START PSD T.IIDA 2002/04/03 出荷指示テキスト----------------*
IF GF_DENPYOU-EVERS <> ' '.
SELECT SINGLE
EVTXT
INTO CORRESPONDING FIELDS OF GF_BIKOU
FROM T027B
WHERE EVERS = GF_DENPYOU-EVERS
AND   SPRAS = 'J'.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-EVTXT = GF_BIKOU-EVTXT.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_T027B SY-SUBRC.
ENDCASE.
ENDIF.
*---APPEND END PSD T.IIDA 2002/04/03 出荷指示テキスト------------------*

* ③帳票出力用内部TBLへのレコード追加
*---APPEND START PSD T.SAITOH 2002/08/04 ---------------------------*
*   ロック個所変更とすでにロックされていた場合対象外処理追加
PERFORM FRM_ENQUEUE_EZNAST.
IF G_RETURN_CODE <> 0.
EXIT.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/08/04 ---------------------------*

*---APPEND START NDSC M.IKEDA 2006/11/14 ---------------------------*
CLEAR: GF_WRITE-BSTKD.
* 得意先発注番号の設定
SELECT SINGLE
BSTKD
INTO GF_BSTKD
FROM VBKD
WHERE VBELN = GF_WRITE-VBELV
AND POSNR = 000000.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-BSTKD = GF_BSTKD-BSTKD.
WHEN 4.    " 対象データなし
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_VBKD SY-SUBRC.
ENDCASE.
*---APPEND END   NDSC M.IKEDA 2006/11/14 ---------------------------*

*---APPEND START NDSC M.IKEDA 2006/12/04 ---------------------------*
CLEAR: WK_URZTP,
WK_ERROR_COMENT,
GF_SYOUMEISYO.
SELECT SINGLE
URZTP
INTO WK_URZTP
FROM EINA
* Mod 2007.02.07 --->
*  WHERE LIFNR = GF_WRITE-LIFNR
*  AND MATNR = GF_WRITE-KDMAT.
WHERE LIFNR = GF_DENPYOU-LIFNR
AND MATNR = GF_DENPYOU-MATNR.
* Mod 2007.02.07 <---

CASE SY-SUBRC.
WHEN 0.
READ TABLE GT_SYOUMEISYO
WITH KEY URZTP = WK_URZTP INTO GF_SYOUMEISYO.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE-URZTX = GF_SYOUMEISYO-URZTX.
WHEN OTHERS.
MESSAGE E400(Z1) WITH '証明書区分が設定されていません'.
ENDCASE.
WHEN OTHERS.
*      MESSAGE E400(Z1) WITH WK_ERROR_COMENT.
CONCATENATE GF_WRITE-EBELN '：購買情報エラー' INTO WK_ERROR_COMENT
.
MESSAGE I400(Z1) WITH WK_ERROR_COMENT.
CONCATENATE '品目:' GF_WRITE-KDMAT '、仕入先：' GF_WRITE-LIFNR
'購買情報未登録' INTO WK_ERROR_COMENT.
MESSAGE I400(Z1) WITH WK_ERROR_COMENT.
ENDCASE.
*---APPEND END   NDSC M.IKEDA 2006/12/04 ---------------------------*

*---APPEND START DMC A.MASUDA 2005/02/22 ---------------------------*
*  APPEND GF_WRITE TO GT_WRITE.
CLEAR:GF_WRITE-TNAME.
* 担当者名の設定③
PERFORM FRM_SET_TNAME USING    GF_DENPYOU-EBELN
GF_DENPYOU-EBELP
CHANGING GF_WRITE-TNAME.
* 担当者名取得時
IF ( GF_WRITE-TNAME <> SPACE ) OR
( GF_WRITE-TNAME = SPACE AND FLG_TEC = CNS_X ).
APPEND GF_WRITE TO GT_WRITE.
ENDIF.
*---APPEND END   DMC A.MASUDA 2005/02/22 ---------------------------*
TMP_NAST = GF_NAST.
PERFORM FRM_CLEAR.

ENDFORM.                    " frm_koumoku
*&---------------------------------------------------------------------*
*&      Form  frm_write_data
*&---------------------------------------------------------------------*
*       ファイル出力/NAST更新
*----------------------------------------------------------------------*
FORM FRM_WRITE_DATA.
**** START ADD 2015/01/23 ISID11 ****
DATA:
L_FILENAME TYPE  ZTEGZZM001-Z_OUTPUT_FN,
L_Z_OUTPUT_CP TYPE  ZTEGZZM001-Z_OUTPUT_CP,
L_FLGUTF8  TYPE  FLAG.
**** END ADD 2015/01/23 ISID11 ****

SORT GT_WRITE ASCENDING BY LNAME.

* ｱ) ファイル名

**** START ADD 2015/01/23 ISID11 ****
CALL FUNCTION 'ZEG_ZZ_GLOBAL_PGM_CONFIG_GET'
EXPORTING
IMPPGM      = SY-REPID
IMPBUKRS    = 'C001'
IMPORTING
EXPFILENAME = L_FILENAME
EXPCODEPAGE = L_Z_OUTPUT_CP
EXPFLGUTF8  = L_FLGUTF8.
**** END ADD 2015/01/23 ISID11 ****

CONCATENATE
PR_FILEN
**** START UPD 2015/01/23 ISID11 ****
*    G_REPID      " プログラムID
L_FILENAME   "帳票ID
**** END UPD 2015/01/23 ISID11 ****
G_UNAME      " R/3ログインユーザID
G_UZEIT      " タイムスタンプ
'.txt'       " 拡張子
INTO GF_FILENM.

* ｲ) ファイル出力/NAST更新
PERFORM FRM_WRITE_FILE
**** START ADD 2015/01/23 ISID11 ****
USING L_Z_OUTPUT_CP
L_FLGUTF8.
**** END ADD 2015/01/23 ISID11 ****


ENDFORM.                    " frm_write_data
*&---------------------------------------------------------------------*
*&      Form  frm_unrock_nast
*&---------------------------------------------------------------------*
*       ロック解除
*----------------------------------------------------------------------*
*FORM frm_unrock_nast USING P_WKAPPL P_WKSCHL.
*  CALL FUNCTION 'DEQUEUE_EZNAST'
*   EXPORTING
*     MODE_NAST       = 'E'
*     MANDT           = SY-MANDT
*     KAPPL           = WKAPPL
**   OBJKY           =
*     KSCHL           = WKSCHL
**   SPRAS           =
**   PARNR           =
**   PARVW           =
**   ERDAT           =
**   ERUHR           =
**   X_KAPPL         = ' '
**   X_OBJKY         = ' '
**   X_KSCHL         = ' '
**   X_SPRAS         = ' '
**   X_PARNR         = ' '
**   X_PARVW         = ' '
**   X_ERDAT         = ' '
**   X_ERUHR         = ' '
**   _SCOPE          = '3'
**   _SYNCHRON       = ' '
**   _COLLECT        = ' '
*            .
*  IF SY-SUBRC <> 0.
*    MESSAGE e001(Z1) WITH 'DEQUEUE_EZNAST' SY-SUBRC.
*  ENDIF.
*
*ENDFORM.                    " frm_unrock_nast
*&---------------------------------------------------------------------*
*&      Form  frm_DEQUEUE_ALL
*&---------------------------------------------------------------------*
*       ロック解除
*----------------------------------------------------------------------*
FORM FRM_DEQUEUE_ALL.

CALL FUNCTION 'DEQUEUE_ALL'
* EXPORTING
*   _SYNCHRON       = ' '
.

IF SY-SUBRC <> 0.
MESSAGE E001(Z1) WITH 'DEQUEUE_ALL' SY-SUBRC.
ENDIF.

ENDFORM.                    " frm_DEQUEUE_ALL
*&---------------------------------------------------------------------
*&      Form  frm_write_file
*&---------------------------------------------------------------------
*       ファイル出力/NAST更新
*----------------------------------------------------------------------
FORM FRM_WRITE_FILE
**** START ADD 2015/01/23 ISID11 ****
USING I_Z_OUTPUT_CP  TYPE ZTEGZZM001-Z_OUTPUT_CP
I_FLGUTF8      TYPE FLAG.

DATA:
L_CODEPAGE TYPE ABAP_ENCODING,
L_SAPCODEPAGE TYPE STRING,
L_SUBRC    TYPE SY-SUBRC.
**** END ADD 2015/01/23 ISID11 ****

**** START DEL 2014/09/01 ISID11 ****
**** START ADD 2015/01/23 ISID11 ****
IF I_FLGUTF8 IS INITIAL.

L_SAPCODEPAGE = I_Z_OUTPUT_CP.

IF L_SAPCODEPAGE IS NOT INITIAL.

L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( L_SAPCODEPAGE ).

ENDIF.

TRY .
OPEN DATASET GF_FILENM FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
IGNORING CONVERSION ERRORS.

L_SUBRC = SY-SUBRC.

CATCH CX_SY_CODEPAGE_CONVERTER_INIT.

L_SUBRC = 8.

ENDTRY.

ELSE.
**** END ADD 2015/01/23 ISID11 ****
** Mod ES-UP 2012/08/21 -->
** ファイルオープン
**  OPEN DATASET GF_FILENM FOR OUTPUT IN TEXT MODE.
*  DATA L_CODEPAGE TYPE ABAP_ENCODING.
*  L_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( CNS_SJIS ).
**** END DEL 2014/09/01 ISID11 ****
OPEN DATASET GF_FILENM FOR OUTPUT
**** START UPD 2014/09/01 ISID11 ****
*    IN LEGACY TEXT MODE CODE PAGE L_CODEPAGE
IN TEXT MODE ENCODING UTF-8
**** END UPD 2014/09/01 ISID11 ****
IGNORING CONVERSION ERRORS.

**** START ADD 2015/01/23 ISID11 ****
L_SUBRC = SY-SUBRC.
**** END ADD 2015/01/23 ISID11 ****

** Mod ES-UP 2012/08/21 <--

**** START ADD 2015/01/23 ISID11 ****
ENDIF.
**** END ADD 2015/01/23 ISID11 ****

**** START UPD 2015/01/23 ISID11 ****
*  CASE SY-SUBRC.
CASE L_SUBRC.
**** END UPD 2015/01/23 ISID11 ****
WHEN 0.
TRANSFER: GF_HEAD-WSTART TO GF_FILENM,
GF_HEAD-WTITLE TO GF_FILENM,
GF_HEAD-WEND TO GF_FILENM,
GF_HEAD-KOUMOKU TO GF_FILENM.
WHEN OTHERS.
WRITE: / TEXT-051.
WRITE: / ' ',G_TITLE,TEXT-039,TEXT-047,TEXT-045.
STOP.
ENDCASE.

* ①ファイル出力処理
LOOP AT GT_WRITE INTO GF_WRITE.
* タブ区切りファイル作成
PERFORM FRM_TAB.
* プリンタ/トレイ未取得伝票チェック
IF GF_WRITE-ERROR = CNS_X.
IF ERR_FLG = 0.
WRITE: / TEXT-052,
/ ' ',TEXT-038,GF_WRITE-DNUM,
TEXT-039,TEXT-008,TEXT-041,TEXT-042.
ERR_FLG = 1.
ELSEIF ERR_FLG = 1.
WRITE: / ' ',TEXT-038,GF_WRITE-DNUM,
TEXT-039,TEXT-008,TEXT-041,TEXT-042.
ENDIF.
CONTINUE.
ENDIF.

*---取消伝票チェック・発注外運送費伝票チェック
IF GF_WRITE-TORIKESHI = CNS_X
* ↓APPEND 2002/02/22 PSD K.Usami
OR GF_WRITE-MTART = CNS_X.
* ↑APPEND 2002/02/22 PSD K.Usami
*---処理ステータス更新処理
PERFORM FRM_UPDATE_NAST.
CONTINUE.
ENDIF.

* データ出力
* Mod ES-UP 2012/10/30 -->
*    TRANSFER GF_DATA TO GF_FILENM.
TRANSFER GF_DATA-DATA TO GF_FILENM.
* Mod ES-UP 2012/10/30 <--
CNT_FLG = CNT_FLG + 1.
*---処理ステータス更新処理
PERFORM FRM_UPDATE_NAST.

TMP_OBJKY = GF_WRITE-WOBJKY.
ENDLOOP.

* ファイルクローズ
COMMIT WORK.
CLOSE DATASET GF_FILENM.

ENDFORM.                    " frm_write_file
*&---------------------------------------------------------------------*
*&      Form  frm_read_text
*&---------------------------------------------------------------------*
*       汎用モジュール'READ_TEXT'
*----------------------------------------------------------------------*
FORM FRM_READ_TEXT USING    P_W_NAME
* APPEND PSD K.ARAI 2002/05/28
LIKE THEAD-TDNAME.
* APPEND END
CLEAR : BIKOU.

CALL FUNCTION 'READ_TEXT'
EXPORTING
*     CLIENT                        = SY-MANDT
ID                            = 'F02'
LANGUAGE                      = 'J'
NAME                          = W_NAME
OBJECT                        = 'EKPO'
*     ARCHIVE_HANDLE                = 0
*     LOCAL_CAT                     = ' '
*   IMPORTING
*     HEADER                        =
TABLES
LINES                         = ITAB_NAME
EXCEPTIONS
ID                            = 1
LANGUAGE                      = 2
NAME                          = 3
NOT_FOUND                     = 4
OBJECT                        = 5
REFERENCE_CHECK               = 6
WRONG_ACCESS_TO_ARCHIVE       = 7
OTHERS                        = 8
.
*  IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
*  ENDIF.

IF SY-SUBRC = 0.
*    READ TABLE itab_NAME INTO wa_NAME INDEX 1.
LOOP AT ITAB_NAME INTO WA_NAME.
IF SY-TABIX > 1.
CONCATENATE TMP_BIKOU WA_NAME-TDLINE
INTO BIKOU SEPARATED BY SPACE.
ELSE.
BIKOU = WA_NAME-TDLINE.
ENDIF.
TMP_BIKOU = BIKOU.
ENDLOOP.
ELSEIF SY-SUBRC = 8.
MESSAGE E001(Z1) WITH 'READ_TEXT' SY-SUBRC.
ELSE.
GF_WRITE-BIKOU = ' '.
ENDIF.

ENDFORM.                    " frm_read_text
*&---------------------------------------------------------------------*
*&      Form  frm_clear
*&---------------------------------------------------------------------*
*       作業領域の初期化
*----------------------------------------------------------------------*
FORM FRM_CLEAR.
CLEAR: GF_DENPYOU,
GF_MSEG,
GF_PLANT,
GF_KOUBAI,
GF_PRINTA,
GF_TYPE,
OBJDES1,
OBJDES2,
GF_TEHAI,
GF_TTANTOU,
GF_NOUNYU,
VERKF1,
VERKF2,
GF_HINMOKU,
GF_BIKOU,
GF_IRAI,
W_NAME,
WA_NAME,
GF_WRITE.

ENDFORM.                    " frm_clear
*&---------------------------------------------------------------------*
*&      Form  frm_call_unrock
*&---------------------------------------------------------------------*
*       テーブルロック解除パラメータ設定
*----------------------------------------------------------------------*
*FORM frm_call_unrock.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM01'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM02'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM03'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM04'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM05'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM50'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM51'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM52'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM53'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM54'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'EF'.
*  WKSCHL = 'ZM55'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*  WKAPPL = 'ME'.
*  WKSCHL = 'WA01'.
*  PERFORM frm_unrock_nast USING WKAPPL WKSCHL.
*
*ENDFORM.                    " frm_call_unrock
*&---------------------------------------------------------------------
*&      Form  frm_update_nast
*&---------------------------------------------------------------------
*       NASTテーブルステータス更新処理
*----------------------------------------------------------------------
FORM FRM_UPDATE_NAST.
*---DELETE START PSD T.SAITOH 2002/04/02 明細レベルで更新対応---------*
*                                        同一のOBJキーでも処理する
*  IF TMP_OBJKY = GF_WRITE-WOBJKY.
*    EXIT.
*  ENDIF.
*---DELETE END   PSD T.SAITOH 2002/04/02 ---------------------------*

* 通常出力時
IF R_TUJOU = CNS_X.
*---APPEND START PSD T.SAITOH 2002/04/03 明細レベル更新のためNAST更新-*
*                                        は1度のみとする
READ TABLE GT_TMP_WRITE INTO GF_TMP_WRITE
WITH KEY KAPPL = GF_WRITE-KAPPL
WOBJKY = GF_WRITE-WOBJKY
KSCHL = GF_WRITE-KSCHL
ERDAT = GF_WRITE-ERDAT
ERUHR = GF_WRITE-ERUHR.
IF SY-SUBRC = 0.
*      処理済レコードなのでEXIT
EXIT.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
IF GF_WRITE-TORIKESHI = CNS_X " 取消伝票
* ↓APPEND 2002/02/22 PSD K.Usami
OR GF_WRITE-MTART = CNS_X.    " 発注外運送費伝票
* ↑APPEND 2002/02/22 PSD K.Usami
UPDATE NAST
SET VSTAT = '1'
WHERE KAPPL = GF_WRITE-KAPPL
AND   OBJKY = GF_WRITE-WOBJKY
AND   KSCHL = GF_WRITE-KSCHL
AND   SPRAS = 'J'
AND   NACHA = '1'
*---APPEND START PSD T.SAITOH 2002/04/03 登録日、登録時間考慮--------*
AND   ERDAT = GF_WRITE-ERDAT
AND   ERUHR = GF_WRITE-ERUHR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
AND   DATVR = GF_WRITE-DATVR
AND   UHRVR = GF_WRITE-UHRVR.
ELSE.
UPDATE NAST
SET VSTAT = '1'
USNAM = G_UNAME
DATVR = G_DATA
UHRVR = G_UZEIT
LDEST = GF_WRITE-PADEST
WHERE KAPPL = GF_WRITE-KAPPL
AND   OBJKY = GF_WRITE-WOBJKY
AND   KSCHL = GF_WRITE-KSCHL
AND   SPRAS = 'J'
AND   NACHA = '1'
*---APPEND START PSD T.SAITOH 2002/04/03 登録日、登録時間考慮--------*
AND   ERDAT = GF_WRITE-ERDAT
AND   ERUHR = GF_WRITE-ERUHR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
AND   DATVR = GF_WRITE-DATVR
AND   UHRVR = GF_WRITE-UHRVR.
ENDIF.
*---APPEND START PSD T.SAITOH 2002/04/03 明細レベル更新のためNAST更新-*
*                                        は1度のみとする
*                                        通常出力も重複更新可能性あり
*                                        ゆえに対応
IF SY-SUBRC = 0.          "update命令のリターン値を残すためのif文
APPEND GF_WRITE TO  GT_TMP_WRITE.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
ENDIF.
* 再出力時
IF R_SAI = CNS_X.
*---APPEND START PSD T.SAITOH 2002/03/07 ---------------------------*
READ TABLE GT_TMP_WRITE INTO GF_TMP_WRITE
WITH KEY KAPPL = GF_WRITE-KAPPL
WOBJKY = GF_WRITE-WOBJKY
KSCHL = GF_WRITE-KSCHL
DATVR = GF_WRITE-DATVR
UHRVR = GF_WRITE-UHRVR.

IF SY-SUBRC = 0.
*     処理済レコードなのでEXIT
EXIT.
ENDIF.
*---APPEND END   PSD T.SAITOH 2002/03/07 ---------------------------*
UPDATE NAST
SET DATVR = G_DATA
USNAM = G_UNAME
UHRVR = G_UZEIT
LDEST = GF_WRITE-PADEST
WHERE KAPPL = GF_WRITE-KAPPL
AND   OBJKY = GF_WRITE-WOBJKY
AND   KSCHL = GF_WRITE-KSCHL
AND   SPRAS = 'J'
AND   NACHA = '1'
AND   DATVR = GF_WRITE-DATVR
AND   UHRVR = GF_WRITE-UHRVR.
*---APPEND START PSD T.SAITOH 2002/03/07 重複更新を回避--------------*
APPEND GF_WRITE TO  GT_TMP_WRITE.
*---APPEND END   PSD T.SAITOH 2002/03/07 ---------------------------*
ENDIF.

CASE SY-SUBRC.
WHEN 0.
WHEN OTHERS.    " 対象データなし
ROLLBACK WORK.
DELETE DATASET GF_FILENM.
WRITE: / TEXT-049.
WRITE: / ' ',TEXT-043,G_TITLE,TEXT-044,TEXT-045.
STOP.
ENDCASE.
ENDFORM.                    " frm_update_nast
*&---------------------------------------------------------------------*
*&      Form  frm_tab
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM FRM_TAB.
* Mod ES-UP 2012/08/21 -->
*  XCODE = '09'.
*  CONCATENATE GF_WRITE-LNAME      XCODE
*              GF_WRITE-DNUM       XCODE
*              GF_WRITE-OBJDES     XCODE
*              GF_WRITE-DATUM      XCODE
*              GF_WRITE-PSTLZ      XCODE
*              GF_WRITE-JUSYO      XCODE
*              GF_WRITE-NAME       XCODE
*              GF_WRITE-VERKF      XCODE
*              GF_WRITE-TEL        XCODE
*              GF_WRITE-FAX        XCODE
*              GF_WRITE-PLANT      XCODE
*              GF_WRITE-EKNAM      XCODE
*              GF_WRITE-EKTEL      XCODE
*              GF_WRITE-TELFX      XCODE
*              GF_WRITE-KUBUN      XCODE
*              GF_WRITE-KDMAT      XCODE
*              GF_WRITE-TXZ01      XCODE
*              GF_WRITE-NNAME      XCODE
*              GF_WRITE-CITY1      XCODE
*              GF_WRITE-TEL_NUMBER XCODE
*              GF_WRITE-HMENGE     XCODE
*              GF_WRITE-MEINS      XCODE
*              GF_WRITE-TANKA      XCODE
** ↓APPEND 2002/02/20 PSD K.Usami
*              GF_WRITE-WAERS      XCODE
** ↑APPEND 2002/02/20 PSD K.Usami
*              GF_WRITE-BIKOU      XCODE
*              GF_WRITE-SLFDT      XCODE
**---DELETE START PSD T.SAITOH 2002/04/03 ---------------------------*
**              GF_WRITE-MENGE      XCODE
**---DELETE END   PSD T.SAITOH 2002/04/03 ---------------------------*
**---MODIFY START PSD T.IIDA   2002/07/04 ---------------------------*
**---APPEND START PSD T.SAITOH 2002/04/03 ---------------------------*
**              GF_WRITE-NETWR
*              GF_WRITE-NETWR      XCODE
*              GF_WRITE-EVTXT
**---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
**---APPEND START NDSC R.HATA  2003/01/15 ---------------------------*
*              XCODE  GF_WRITE-ERNAM
*              XCODE  GF_WRITE-VBELV
**---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
**---APPEND START NDSC A.MASUDA  2004/04/22 仕入先コード-------------*
*              XCODE  GF_WRITE-LIFNR
**---APPEND END   NDSC A.MASUDA  2004/04/22 仕入先コード-------------*
**---APPEND START DMC A.MASUDA 2005/02/22 ------------------------------*
*              XCODE GF_WRITE-TNAME
**---APPEND END   DMC A.MASUDA 2005/02/22 ------------------------------*
**---APPEND START NDSC M.IKEDA 2006/11/14 得意先発注番号----------------*
*              XCODE GF_WRITE-BSTKD
**---APPEND END   NDSC M.IKEDA 2006/11/14 ------------------------------*
**---APPEND START NDSC M.IKEDA 2006/12/04 証明書テキスト----------------*
*              XCODE GF_WRITE-URZTX
**---APPEND END   NDSC M.IKEDA 2006/12/04 ------------------------------*
*         INTO GF_DATA.
CONCATENATE GF_WRITE-LNAME
GF_WRITE-DNUM
GF_WRITE-OBJDES
GF_WRITE-DATUM
GF_WRITE-PSTLZ
GF_WRITE-JUSYO
GF_WRITE-NAME
GF_WRITE-VERKF
GF_WRITE-TEL
GF_WRITE-FAX
GF_WRITE-PLANT
GF_WRITE-EKNAM
GF_WRITE-EKTEL
GF_WRITE-TELFX
GF_WRITE-KUBUN
GF_WRITE-KDMAT
GF_WRITE-TXZ01
GF_WRITE-NNAME
GF_WRITE-CITY1
GF_WRITE-TEL_NUMBER
GF_WRITE-HMENGE
GF_WRITE-MEINS
GF_WRITE-TANKA
GF_WRITE-WAERS
GF_WRITE-BIKOU
GF_WRITE-SLFDT
GF_WRITE-NETWR
GF_WRITE-EVTXT
GF_WRITE-ERNAM
GF_WRITE-VBELV
GF_WRITE-LIFNR
GF_WRITE-TNAME
GF_WRITE-BSTKD
GF_WRITE-URZTX
* Mod ES-UP 2012/10/30 -->
*         INTO GF_DATA
INTO GF_DATA-DATA
* Mod ES-UP 2012/10/30 <--
SEPARATED BY CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
* Mod ES-UP 2012/08/21 <--
ENDFORM.                    " frm_tab
*&---------------------------------------------------------------------*
*&      Form  frm_head
*&---------------------------------------------------------------------*
*       ヘッダ行の設定
*----------------------------------------------------------------------*
FORM FRM_HEAD.

GF_HEAD-WSTART  = '<start>'.       " APIタグ(開始)

CONCATENATE
'VrSetDocName2=' " API関数(文書名)
'"'              " ダブルクォート
SYST-TITLE       " 帳票名
'('              " 右カッコ
SYST-UNAME       " ユーザID
')'              " 左カッコ
'"'              " ダブルクォート
INTO GF_HEAD-WTITLE.

GF_HEAD-WEND    = '<end>'.         " APIタグ(終了)
* Mod ES-UP 2012/08/21 -->
*  XCODE = '09'.
*  CONCATENATE
*    TEXT-012 XCODE
*    TEXT-013 XCODE
*    TEXT-014 XCODE
*    TEXT-015 XCODE
*    TEXT-016 XCODE
*    TEXT-017 XCODE
*    TEXT-018 XCODE
*    TEXT-019 XCODE
*    TEXT-020 XCODE
*    TEXT-021 XCODE
*    TEXT-022 XCODE
*    TEXT-023 XCODE
*    TEXT-024 XCODE
*    TEXT-025 XCODE
*    TEXT-026 XCODE
*    TEXT-027 XCODE
*    TEXT-028 XCODE
*    TEXT-029 XCODE
*    TEXT-030 XCODE
*    TEXT-031 XCODE
*    TEXT-032 XCODE
*    TEXT-033 XCODE
*    TEXT-034 XCODE
** ↓APPEND 2002/02/20 PSD K.Usami
*    TEXT-057 XCODE
** ↑APPEND 2002/02/20 PSD K.Usami
*    TEXT-035 XCODE
*    TEXT-001 XCODE
**---DELETE START PSD T.SAITOH 2002/04/03 数量項目削除----------------*
**    TEXT-010 XCODE
**---DELETE END   PSD T.SAITOH 2002/04/03 ---------------------------*
**---MODIFY START PSD T.IIDA 2002/07/04 出荷指示TXT追加----------------*
**---APPEND START PSD T.SAITOH 2002/04/03 金額項目追加----------------*
**    TEXT-058
*    TEXT-058 XCODE
**---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*    TEXT-059
**---MODIFY END   PSD T.IIDA 2002/07/04 ------------------------------*
**---APPEND START NDSC R.HATA  2003/01/15 登録者----------------------*
*    XCODE TEXT-060
*    XCODE TEXT-061
**---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
**---APPEND START NDSC A.MASUDA  2004/04/22 仕入先コード-------------*
*    XCODE TEXT-062
**---APPEND END   NDSC A.MASUDA  2004/04/22 仕入先コード-------------*
**---APPEND START DMC A.MASUDA 2005/02/22 ------------------------------*
*    XCODE TEXT-063
**---APPEND END   DMC A.MASUDA 2005/02/22 ------------------------------*
**---APPEND START NDSC M.IKEDA 2006/11/14 得意先発注番号----------------*
*    XCODE TEXT-064
**---APPEND END   NDSC M.IKEDA 2006/11/14 ------------------------------*
**---APPEND START NDSC M.IKEDA 2006/12/04 証明書テキスト----------------*
*    XCODE TEXT-065
**---APPEND END   NDSC M.IKEDA 2006/12/04 ------------------------------*
*  INTO GF_HEAD-KOUMOKU.              " 項目名称
CONCATENATE
TEXT-012
TEXT-013
TEXT-014
TEXT-015
TEXT-016
TEXT-017
TEXT-018
TEXT-019
TEXT-020
TEXT-021
TEXT-022
TEXT-023
TEXT-024
TEXT-025
TEXT-026
TEXT-027
TEXT-028
TEXT-029
TEXT-030
TEXT-031
TEXT-032
TEXT-033
TEXT-034
TEXT-057
TEXT-035
TEXT-001
TEXT-058
TEXT-059
TEXT-060
TEXT-061
TEXT-062
TEXT-063
TEXT-064
TEXT-065
INTO GF_HEAD-KOUMOKU               " 項目名称
SEPARATED BY CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB.
* Mod ES-UP 2012/08/21 <--
ENDFORM.                    " frm_head
*&---------------------------------------------------------------------*
*&      Form  frm_ENQUEUE_EZNAST
*&---------------------------------------------------------------------*
*       NASTテーブルロック処理
*----------------------------------------------------------------------*
FORM FRM_ENQUEUE_EZNAST.

CLEAR G_RETURN_CODE.

CALL FUNCTION 'ENQUEUE_EZNAST'
EXPORTING
MODE_NAST      = 'E'
MANDT          = SY-MANDT
KAPPL          = GF_NAST-KAPPL
OBJKY          = GF_NAST-OBJKY
KSCHL          = GF_NAST-KSCHL
SPRAS          = 'J'
*     PARNR          =
*     PARVW          =
*     ERDAT          =
*     ERUHR          =
*     X_KAPPL        = ' '
*     X_OBJKY        = ' '
*     X_KSCHL        = ' '
*     X_SPRAS        = ' '
*     X_PARNR        = ' '
*     X_PARVW        = ' '
*     X_ERDAT        = ' '
*     X_ERUHR        = ' '
*     _SCOPE         = '2'
*     _WAIT          = ' '
*     _COLLECT       = ' '
EXCEPTIONS
FOREIGN_LOCK   = 1
SYSTEM_FAILURE = 2
OTHERS         = 3.

CASE SY-SUBRC.
WHEN 0.
WHEN 1.
WHEN OTHERS.
MESSAGE E001(Z1) WITH 'ENQUEUE_EZNAST' SY-SUBRC.
ENDCASE.

G_RETURN_CODE = SY-SUBRC.

*
*  IF SY-SUBRC <> 0.
*    IF SY-SUBRC = 1.
*      MESSAGE S004(Z1) WITH G_TITLE.   " 注文書
*      STOP.
*    ELSE.
*      MESSAGE E001(Z1) WITH 'ENQUEUE_EZNAST' SY-SUBRC.
*    ENDIF.
*  ENDIF.
*
ENDFORM.                    " frm_ENQUEUE_EZNAST
*&---------------------------------------------------------------------*
*&      Form  check_writedata
*&---------------------------------------------------------------------*
*       出力データ存在チェック
*----------------------------------------------------------------------*
FORM CHECK_WRITEDATA.

DATA: L_CNT_GT_WRITE(8) TYPE N, " 出力用内部TBL件数
CNT_XDATA TYPE I VALUE 0. " 更新のみデータカウントフラグ

DESCRIBE TABLE GT_WRITE LINES L_CNT_GT_WRITE.

LOOP AT GT_WRITE INTO GF_WRITE
WHERE TORIKESHI = CNS_X  " 取消伝票
OR MTART = CNS_X.     " 発注外運送費伝票
CNT_XDATA = CNT_XDATA + 1.
ENDLOOP.

IF GT_WRITE IS INITIAL.
WRITE:/ TEXT-052,
/ ' ', TEXT-037.
STOP.

ELSEIF L_CNT_GT_WRITE = CNT_XDATA.
LOOP AT GT_WRITE INTO GF_WRITE.
PERFORM FRM_UPDATE_NAST.
ENDLOOP.
WRITE:/ TEXT-052,
/ ' ', TEXT-037.
STOP.
ENDIF.
ENDFORM.                    " check_writedata
*---APPEND START PSD T.SAITOH 2002/04/08 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_ADRC
*&---------------------------------------------------------------------*
*       アドレスから都道府県６０バイトを取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_ADRC USING P_ADDRESS
CHANGING P_NEW_ADDRESS.
DATA:LT_ADRC TYPE TABLE OF ADRC,
LF_ADRC TYPE ADRC.

SELECT STREET
INTO CORRESPONDING FIELDS OF TABLE LT_ADRC
FROM ADRC WHERE ADDRNUMBER = P_ADDRESS.

LOOP AT LT_ADRC INTO LF_ADRC.
P_NEW_ADDRESS = LF_ADRC-STREET.
EXIT.
ENDLOOP.

* --- エラーチェック
CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN OTHERS.
MESSAGE E603(Z1) WITH SY-REPID
CNS_ADRC
SY-SUBRC.
ENDCASE.


ENDFORM.                    " FRM_SELECT_ADRC
*---APPEND END   PSD T.SAITOH 2002/04/08 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_M
*&---------------------------------------------------------------------*
*       購買伝票存在チェック
*----------------------------------------------------------------------*
FORM FRM_CHECK_M.
*---APPEND START PSD T.SAITOH 2002/07/23 ---------------------------*
* e)購買発注伝票存在チェック
SELECT SINGLE
B~EBELN
A~EKGRP
B~WERKS
A~LIFNR
INTO CORRESPONDING FIELDS OF GF_CHECK_DENPYOU
FROM ( EKKO AS A INNER JOIN EKPO     AS B
ON A~EBELN = B~EBELN )
WHERE   B~EBELN   IN S_EBELN
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKORG   = PR_EKORG  "購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKGRP   IN S_EKGRP
AND     B~WERKS   IN S_WERKS.
*        AND     a~LIFNR   IN s_LIFNR.
CASE SY-SUBRC.
WHEN 0.
WHEN 4.    " 対象データなし
MESSAGE S611(Z1).
STOP.
WHEN 8.    " システムエラー
MESSAGE A603(Z1) WITH G_REPID CNS_EKKO SY-SUBRC.
ENDCASE.

*---APPEND END   PSD T.SAITOH 2002/07/23 ---------------------------*

ENDFORM.                    " FRM_CHECK_M
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_NAST_VSTAT0
*&---------------------------------------------------------------------*
*       NAST読込通常出力
*----------------------------------------------------------------------*
FORM FRM_SELECT_NAST_VSTAT0.

SELECT
KAPPL
OBJKY
KSCHL
LDEST
DATVR
UHRVR
*---APPEND START PSD T.SAITOH 2002/04/03 登録日、登録時間考慮--------*
ERDAT
ERUHR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE GT_NAST
FROM NAST
*---MODIFY START PSD T.SAITOH 2002/08/07 ---------------------------*
WHERE ( ( KAPPL = 'EF'
AND   KSCHL <> 'ZM99' )
OR  ( KAPPL = 'ME'
AND   KSCHL = 'WA01' ) )
AND   SPRAS = 'J'
AND   NACHA = '1'
AND   VSTAT = '0'
*---APPEND START PSD H.HARUKI 2002/09/22 ---------------------------*
AND  AKTIV = SPACE .
*---APPEND END   PSD H.HARUKI 2002/09/22 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/08/07 ---------------------------*

ENDFORM.                    " FRM_SELECT_NAST_VSTAT0
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_NAST_VSTAT1
*&---------------------------------------------------------------------*
*       NAST読込再出力
*----------------------------------------------------------------------*
FORM FRM_SELECT_NAST_VSTAT1.

SELECT
KAPPL
OBJKY
KSCHL
LDEST
DATVR
UHRVR
INTO CORRESPONDING FIELDS OF TABLE GT_NAST
FROM NAST
*---APPEND START PSD T.SAITOH 2002/08/07 ---------------------------*
*    FOR ALL ENTRIES IN GT_OBJKY
*---APPEND END   PSD T.SAITOH 2002/08/07 ---------------------------*
*---MODIFY START PSD T.SAITOH 2002/08/07 ---------------------------*
WHERE ( ( KAPPL = 'EF'
AND   KSCHL <> 'ZM99' )
OR  ( KAPPL = 'ME'
AND   KSCHL = 'WA01' ) )
*---APPEND START PSD T.SAITOH 2002/08/07 ---------------------------*
*    AND   OBJKY = GT_OBJKY-OBJKY
*---APPEND END   PSD T.SAITOH 2002/08/07 ---------------------------*
AND   SPRAS = 'J'
AND   NACHA = '1'
AND   VSTAT = '1'
*---APPEND START PSD H.HARUKI 2002/09/22 ---------------------------*
AND  AKTIV = SPACE .
*---APPEND END   PSD H.HARUKI 2002/09/22 ---------------------------*
*---MODIFY END   PSD T.SAITOH 2002/08/07 ---------------------------*

ENDFORM.                    " FRM_SELECT_NAST_VSTAT1
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_EKKO_EKPO
*&---------------------------------------------------------------------*
*       EKKO＆EKPO読込
*----------------------------------------------------------------------*
FORM FRM_SELECT_EKKO_EKPO.

SELECT
A~EKORG A~WAERS A~EKGRP A~BSART A~RESWK
B~EBELN B~EBELP B~MATNR B~WERKS
B~IDNLF B~MENGE B~MEINS B~BPUMZ
B~BPUMN B~NETPR B~PEINH B~KNTTP
B~EVERS B~TXZ01 B~RETPO B~MTART
B~ADRN2 B~ADRNR
*---APPEND START PSD T.SAITOH 2002/04/03 金額-----------------------*
B~NETWR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 登録者----------------------*
A~ERNAM
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
*---APPEND START NDSC R.HATA  2007/02/07 登録者----------------------*
A~LIFNR
*---APPEND END   NDSC R.HATA  2007/02/07 ---------------------------*

INTO CORRESPONDING FIELDS OF TABLE GT_HDENPYOU
FROM ( EKKO AS A INNER JOIN EKPO     AS B
ON A~EBELN = B~EBELN )
WHERE   A~EBELN    = GF_NAST-OBJKY+0(10)
AND     A~EBELN   IN S_EBELN
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKORG   = PR_EKORG  "購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKGRP   IN S_EKGRP
AND     A~BEDAT   IN S_BEDAT
AND     B~WERKS   IN S_WERKS.

ENDFORM.                    " FRM_SELECT_EKKO_EKPO
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MSEG
*&---------------------------------------------------------------------*
*       MSEG読込
*----------------------------------------------------------------------*
FORM FRM_SELECT_MSEG.

SELECT SINGLE
MBLNR
MJAHR
ZEILE
EBELN
EBELP
BWART
SMBLN
SJAHR
SMBLP
BPMNG
BPRME
DMBTR
INTO CORRESPONDING FIELDS OF GF_MSEG
FROM MSEG
WHERE MBLNR = GF_NAST-OBJKY+0(10)
AND MBLNR IN S_MBLNR
AND MJAHR = GF_NAST-OBJKY+10(4)
AND MJAHR IN S_MJAHR
AND ZEILE = GF_NAST-OBJKY+14(4)
AND    ZEILE IN S_ZEILE.

ENDFORM.                    " FRM_SELECT_MSEG
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_S_EKKO_EKPO
*&---------------------------------------------------------------------*
*       SELECT SINGLE EKKO&EKPO
*----------------------------------------------------------------------*
FORM FRM_SELECT_S_EKKO_EKPO.

SELECT SINGLE
A~EKORG A~WAERS A~EKGRP
B~EBELN B~EBELP B~MATNR B~WERKS
B~IDNLF B~MENGE B~MEINS B~BPUMZ
B~BPUMN B~NETPR B~PEINH B~KNTTP
B~EVERS B~TXZ01 B~RETPO B~ADRN2 B~ADRNR
*---APPEND START PSD T.SAITOH 2002/04/03 ---------------------------*
B~NETWR
*---APPEND END   PSD T.SAITOH 2002/04/03 ---------------------------*
*---APPEND START NDSC R.HATA  2003/01/15 登録者----------------------*
A~ERNAM
*---APPEND END   NDSC R.HATA  2003/01/15 ---------------------------*
INTO CORRESPONDING FIELDS OF GF_ZDENPYOU
FROM ( EKKO AS A INNER JOIN EKPO     AS B
ON A~EBELN = B~EBELN )
WHERE   A~EBELN    = GF_MSEG-EBELN
AND     A~EBELN   IN S_EBELN
AND     B~EBELP    = GF_MSEG-EBELP
*---APPEND START PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKORG   = PR_EKORG  "購買組織
*---APPEND END   PSD T.SAITOH 2002/07/09 ---------------------------*
AND     A~EKGRP   IN S_EKGRP
AND     A~BEDAT   IN S_BEDAT
AND     B~WERKS   IN S_WERKS.

ENDFORM.                    " FRM_SELECT_S_EKKO_EKPO
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_OBJKY
*&---------------------------------------------------------------------*
*       オブジェクトキーの取得
*----------------------------------------------------------------------*
FORM FRM_SELECT_OBJKY.

*  発注番号に'*'を入力したら下記の処理は無駄なのでEXIT
IF S_EBELN-LOW+0(1) = '*'.
EXIT.
ENDIF.
*  入出庫番号に'*'を入力したら下記の処理は無駄なのでEXIT
IF S_MBLNR-LOW+0(1) = '*'.
EXIT.
ENDIF.

IF S_EBELN IS INITIAL.
*    入出庫番号入力時
PERFORM FRM_SELECT_MSEG_OBJKY.
ELSE.
*    発注番号入力時
PERFORM FRM_SELECT_EKBE_OBJKY.
ENDIF.

*  オブジェクトキー管理
PERFORM FRM_SET_OBJKY.

ENDFORM.                    " FRM_SELECT_OBJKY
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_MSEG_OBJKY
*&---------------------------------------------------------------------*
*       MSEG から指定された範囲に紐付く発注伝票を取得する
*----------------------------------------------------------------------*
FORM FRM_SELECT_MSEG_OBJKY.

SELECT MBLNR
MJAHR
ZEILE
EBELN
INTO CORRESPONDING FIELDS OF TABLE GT_MSEG_OBJKY
FROM MSEG
WHERE MBLNR IN S_MBLNR
AND MJAHR IN S_MJAHR
AND ZEILE IN S_ZEILE.

CASE SY-SUBRC.
WHEN 0.
WHEN 4. " NO-DATA
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'MSEG' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SELECT_MSEG_OBJKY
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_EKBE_OBJKY
*&---------------------------------------------------------------------*
*       EKBE から指定された範囲に紐付く入出庫伝票を取得する
*----------------------------------------------------------------------*
FORM FRM_SELECT_EKBE_OBJKY.

SELECT EBELN
INTO CORRESPONDING FIELDS OF TABLE GT_EKBE_OBJKY
FROM EKKO
WHERE EBELN IN S_EBELN.

CASE SY-SUBRC.
WHEN 0.
WHEN 4. " NO-DATA
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKO' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SELECT_EKBE_OBJKY
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_OBJKY
*&---------------------------------------------------------------------*
*       オブジェクトキー管理
*----------------------------------------------------------------------*
FORM FRM_SET_OBJKY.

* 発注番号から紐付いた伝票番号
LOOP AT GT_EKBE_OBJKY INTO GF_EKBE_OBJKY.
*   発注番号
GF_OBJKY-OBJKY = GF_EKBE_OBJKY-EBELN.
INSERT GF_OBJKY INTO TABLE GT_OBJKY.
CLEAR GF_OBJKY.
*   入出庫番号
*    GF_OBJKY-OBJKY+0(10) = GF_EKBE_OBJKY-BELNR."入出庫伝票番号
*    GF_OBJKY-OBJKY+10(4)  = GF_EKBE_OBJKY-GJAHR."年度
*    GF_OBJKY-OBJKY+14(4) = GF_EKBE_OBJKY-BUZEI."明細
*    INSERT GF_OBJKY INTO TABLE GT_OBJKY.
*    CLEAR GF_OBJKY.
ENDLOOP.

* 入出庫伝票番号から紐付いた伝票番号
LOOP AT GT_MSEG_OBJKY INTO GF_MSEG_OBJKY.
*   発注番号
GF_OBJKY-OBJKY = GF_MSEG_OBJKY-EBELN.
INSERT GF_OBJKY INTO TABLE GT_OBJKY.
CLEAR GF_OBJKY.
*   入出庫番号
GF_OBJKY-OBJKY+0(10) = GF_MSEG_OBJKY-MBLNR."入出庫伝票番号
GF_OBJKY-OBJKY+10(4)  = GF_MSEG_OBJKY-MJAHR."年度
GF_OBJKY-OBJKY+14(4) = GF_MSEG_OBJKY-ZEILE."明細
INSERT GF_OBJKY INTO TABLE GT_OBJKY.
CLEAR GF_OBJKY.
ENDLOOP.

ENDFORM.                    " FRM_SET_OBJKY
*&---------------------------------------------------------------------*
*&      Form  FRM_SELECT_NAST_VSTAT1_RAPID
*&---------------------------------------------------------------------*
*       条件で絞るNAST読込（再出力時）
*----------------------------------------------------------------------*
FORM FRM_SELECT_NAST_VSTAT1_RAPID.

SELECT
KAPPL
OBJKY
KSCHL
LDEST
DATVR
UHRVR
*---INSERT START   PSD H.HARUKI 2002/09/22 ---------------------------*
ERDAT
ERUHR
*---INSERT END     PSD H.HARUKI 2002/09/22 ---------------------------*
INTO CORRESPONDING FIELDS OF TABLE GT_NAST
FROM NAST
FOR ALL ENTRIES IN GT_OBJKY
WHERE ( ( KAPPL = 'EF'
AND   KSCHL <> 'ZM99' )
OR  ( KAPPL = 'ME'
AND   KSCHL = 'WA01' ) )
AND   OBJKY = GT_OBJKY-OBJKY
AND   SPRAS = 'J'
AND   NACHA = '1'
AND   VSTAT = '1'
*---APPEND START PSD H.HARUKI 2002/09/22 ---------------------------*
AND  AKTIV = SPACE .
*---APPEND END   PSD H.HARUKI 2002/09/22 ---------------------------*

ENDFORM.                    " FRM_SELECT_NAST_VSTAT1_RAPID
*---APPEND START DMC A.MASUDA 2005/02/22 ---------------------------*
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_TNAME
*&---------------------------------------------------------------------*
*       担当者名の設定
*----------------------------------------------------------------------*
*      -->P_G1_EBELN  購買発注番号
*      -->P_G1_EBELP  購買発注明細
*      <--P_G1_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_TNAME USING    P_G1_EBELN TYPE EKPO-EBELN
P_G1_EBELP TYPE EKPO-EBELP
CHANGING P_G1_TNAME.

* 販売管理伝票番号の設定
PERFORM FRM_SET_VBELN USING    P_G1_EBELN              " 購買伝票
P_G1_EBELP              " 購買伝票明細
CHANGING G_VBELN.                " 販売管理伝票
* 販売管理伝票番号、明細が存在しない場合は、在庫品で処理
IF G_VBELN = SPACE.
* 購買伝票ヘッダ(EKKO)の登録者から担当者名の取得
PERFORM FRM_SET_EKKO_ERNAM USING    P_G1_EBELN       " 購買伝票
CHANGING P_G1_TNAME.      " 担当者名
* 販売管理伝票番号、明細が存在した場合は、個別購買で処理
ELSE.
* 販売伝票ヘッダ(VBAK)の登録者から担当者名の取得
PERFORM FRM_SET_VBAK_ERNAM USING    G_VBELN          " 販売管理伝票
CHANGING P_G1_TNAME.      " 担当者名
* 取得された担当者名が 'WF-BATCH' の場合
IF P_G1_TNAME+0(8) = CNS_BATCH
OR P_G1_TNAME+0(8) = CNS_EDI.
CLEAR:P_G1_TNAME.
* 営業員コードから担当者名の取得
PERFORM FRM_SET_PERNR USING    G_VBELN             " 販売管理伝票
CHANGING P_G1_TNAME.         " 担当者名
ENDIF.
ENDIF.

ENDFORM.                    " FRM_SET_TNAME
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_VBELN
*&---------------------------------------------------------------------*
*       販売管理伝票番号の設定
*----------------------------------------------------------------------*
*      -->P_G2_EBELN  購買伝票番号
*      -->P_G2_EBELP  購買伝票明細番号
*      <--P_G_VBELN   販売管理伝票番号
*----------------------------------------------------------------------*
FORM FRM_SET_VBELN USING    P_G2_EBELN
P_G2_EBELP
CHANGING P_G_VBELN.

DATA:L_VBELN LIKE EKKN-VBELN.
DATA:L_VBELP LIKE EKKN-VBELP.
CLEAR:L_VBELN,L_VBELP,P_G_VBELN.

SELECT SINGLE VBELN
VBELP
INTO (L_VBELN , L_VBELP )
FROM EKKN
WHERE EBELN = P_G2_EBELN
AND EBELP = P_G2_EBELP.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
MOVE L_VBELN TO P_G_VBELN.
WHEN 4. " NO-DATA
CLEAR:P_G_VBELN.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKN' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_VBELN
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_EKKO_ERNAM
*&---------------------------------------------------------------------*
*       購買伝票ヘッダ(EKKO)の登録者から担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G2_EBELN  購買伝票番号
*      <--P_G2_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_EKKO_ERNAM USING    P_G2_EBELN
CHANGING P_G2_TNAME.

DATA:L_ERNAM LIKE EKKO-ERNAM.
CLEAR:L_ERNAM,P_G2_TNAME,FLG_TEC.

SELECT SINGLE ERNAM
INTO L_ERNAM
FROM EKKO
WHERE EBELN = P_G2_EBELN
AND ERNAM IN S_ERNAM.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
IF L_ERNAM = CNS_TEC0000.
CLEAR:P_G2_TNAME.
MOVE CNS_X TO FLG_TEC.
ELSE.
PERFORM FRM_GET_TNAME USING    L_ERNAM
CHANGING P_G2_TNAME.
ENDIF.
WHEN 4. " NO-DATA
CLEAR:P_G2_TNAME.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'EKKO' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_EKKO_ERNAM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_VBAK_ERNAM
*&---------------------------------------------------------------------*
*       販売伝票ヘッダ(VBAK)の登録者から担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G_VBELN   販売管理伝票番号
*      <--P_G2_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_VBAK_ERNAM USING    P_G_VBELN
CHANGING P_G2_TNAME.

DATA:L_ERNAM LIKE VBAK-ERNAM.
CLEAR:L_ERNAM,P_G2_TNAME,FLG_TEC.

SELECT SINGLE ERNAM
INTO L_ERNAM
FROM VBAK
WHERE VBELN = P_G_VBELN
AND ( ERNAM IN S_ERNAM
*---APPEND START DMC A.MASUDA 2005/06/22 ---------------------------*
OR ERNAM = CNS_BATCH
OR ERNAM = CNS_TEC0000
OR ERNAM = CNS_EDI ).
*---APPEND END   DMC A.MASUDA 2005/06/22 ---------------------------*


CASE SY-SUBRC.
WHEN 0. " GET-DATA
IF L_ERNAM = CNS_BATCH
OR L_ERNAM = CNS_EDI.
MOVE L_ERNAM TO P_G2_TNAME.
ELSEIF L_ERNAM = CNS_TEC0000.
CLEAR:P_G2_TNAME.
MOVE CNS_X TO FLG_TEC.
ELSE.
PERFORM FRM_GET_TNAME USING    L_ERNAM
CHANGING P_G2_TNAME.
ENDIF.
WHEN 4. " NO-DATA
CLEAR:P_G2_TNAME.
*---DELETE START NDSC. N.SHIOJIMA 2009/06/15 ---------------------------
*---APPEND START DMC A.MASUDA 2005/06/22 ---------------------------*
*      PERFORM FRM_SET_PERNR USING    P_G_VBELN           " 販売管理伝票
*                            CHANGING P_G2_TNAME.         " 担当者名
*      IF P_G2_TNAME IS INITIAL.
*        CLEAR:P_G2_TNAME.
*        MOVE CNS_X TO FLG_TEC.
*      ENDIF.
*---APPEND END   DMC A.MASUDA 2005/06/22 ---------------------------*
*---DELETE END NDSC. N.SHIOJIMA 2009/06/15 ---------------------------
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'VBAK' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_VBAK_ERNAM
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_PERNR
*&---------------------------------------------------------------------*
*       営業員コードから担当者名の取得
*----------------------------------------------------------------------*
*      -->P_G_VBELN   販売管理伝票番号
*      <--P_G2_TNAME  担当者名
*----------------------------------------------------------------------*
FORM FRM_SET_PERNR USING    P_G_VBELN
CHANGING P_G2_TNAME.

DATA:L_PERNR LIKE VBPA-PERNR.
CLEAR:L_PERNR,P_G2_TNAME.

SELECT SINGLE PERNR
INTO L_PERNR
FROM VBPA
WHERE VBELN = P_G_VBELN
AND PARVW = CNS_VE.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
WHEN 4. " NO-DATA
CLEAR:P_G2_TNAME.
* APPEND START DMC A.MASUDA 2005/06/22 -->
MOVE CNS_X TO FLG_TEC.
* APPEND END   DMC A.MASUDA 2005/06/22 <--
EXIT.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'VBPA' SY-SUBRC.
ENDCASE.

DATA:L_NACHN LIKE PA0002-NACHN.
DATA:L_VORNA LIKE PA0002-VORNA.
CLEAR:L_NACHN,L_VORNA.

SELECT SINGLE NACHN VORNA
INTO (L_NACHN , L_VORNA)
FROM PA0002
WHERE PERNR = L_PERNR.

CASE SY-SUBRC.
WHEN 0. " GET-DATA
CONCATENATE L_NACHN
L_VORNA
INTO P_G2_TNAME.
REPLACE '　' WITH SPACE INTO P_G2_TNAME.
WHEN 4. " NO-DATA
CLEAR:P_G2_TNAME.
WHEN 8. " SYSTEM ERROR
MESSAGE A603(Z1) WITH SY-REPID 'PA0002' SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_PERNR
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_TNAME
*&---------------------------------------------------------------------*
*       ユーザのテキストを取得する
*----------------------------------------------------------------------*
*      -->P_L_ERNAM  ユーザ
*      <--P_L_TNAME  テキスト
*----------------------------------------------------------------------*
FORM FRM_GET_TNAME USING    P_L_ERNAM
CHANGING P_L_TNAME.

DATA:L_KEY(30) TYPE C.
CLEAR:P_L_TNAME,L_KEY.
CONCATENATE SY-MANDT P_L_ERNAM INTO L_KEY .

SELECT SINGLE ADRP~NAME_TEXT
INTO P_L_TNAME
FROM ADRP
INNER JOIN ADRVP
ON ADRP~PERSNUMBER = ADRVP~PERSNUMBER
WHERE ADRVP~APPL_KEY = L_KEY.

ENDFORM.                    " FRM_GET_TNAME
*&---------------------------------------------------------------------*
*&      Form  FRM_GET_T069T
*&---------------------------------------------------------------------*
*       証明書区分、証明書テキストを取得する
*----------------------------------------------------------------------*
FORM FRM_GET_T069T.

SELECT URZTP
URZTX
INTO CORRESPONDING FIELDS OF TABLE GT_SYOUMEISYO
FROM T069T
WHERE SPRAS = 'JA'.

CASE SY-SUBRC.
WHEN 0.
WHEN OTHERS.
MESSAGE E400(Z1) WITH
'証明書区分、証明書テキストを取得できませんでした'.
ENDCASE.

ENDFORM.                    " FRM_GET_T069T
