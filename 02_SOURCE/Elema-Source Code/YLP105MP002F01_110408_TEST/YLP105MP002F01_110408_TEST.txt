*&---------------------------------------------------------------------*
*&  INCLUDE           /A1F/YLP105MP002F01                              *
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  a1f_get_stock_info
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_STOCK_INFO .

DATA : A1F_WL_ECRPES LIKE CRPES ,
A1F_WL_IMT61D LIKE MT61D .
DATA : A1F_TL_MDPSX LIKE TABLE OF MDPS WITH HEADER LINE ,
A1F_TL_MDEZX LIKE TABLE OF MDEZ WITH HEADER LINE ,
A1F_TL_MDSUX LIKE TABLE OF MDSU WITH HEADER LINE ,
A1F_TL_PLAFM LIKE TABLE OF PLAF WITH HEADER LINE ,
A1F_TL_PLAFD LIKE TABLE OF PLAF WITH HEADER LINE ,
A1F_TL_MDFAM LIKE TABLE OF MDFA WITH HEADER LINE ,
A1F_TL_MDFAD LIKE TABLE OF MDFA WITH HEADER LINE ,
A1F_TL_MDRSM LIKE TABLE OF MDRS WITH HEADER LINE ,
A1F_TL_MDRSD LIKE TABLE OF MDRS WITH HEADER LINE .

IF /A1F/YLNS0011-YL_DWERK IS INITIAL
OR /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
EXIT .
ENDIF .

A1F_WL_ECRPES-KZUMT = 'X' .

*2006/04/06 ARAI DELETE - START
*バージョン違いによる下記汎用モジュールがエラーになってしまう件
*4.6cバージョンでコピーしなおした

*  CALL FUNCTION '/A1F/YLR105FM_MD_ABBL_REPORTIN'
*    EXPORTING
*      EMATNR          = /A1F/YLNS0011-YL_MATNR_SALE
*      EWERKS          = /A1F/YLNS0011-YL_DWERK
*      ECRPES          = A1F_WL_ECRPES
*    IMPORTING
*      IMT61D          = A1F_WL_IMT61D
*    TABLES
*      MDPSX           = A1F_TL_MDPSX
*      MDEZX           = A1F_TL_MDEZX
*      MDSUX           = A1F_TL_MDSUX
*      PLAFM           = A1F_TL_PLAFM
*      PLAFD           = A1F_TL_PLAFD
*      MDFAM           = A1F_TL_MDFAM
*      MDFAD           = A1F_TL_MDFAD
*      MDRSM           = A1F_TL_MDRSM
*      MDRSD           = A1F_TL_MDRSD
*    EXCEPTIONS
*      ERROR_MATMASTER = 1
*      OTHERS          = 2.
*2006/04/06 ARAI DELETE - END

*2006/04/06 ARAI ADD - START
CALL FUNCTION 'Y_MD_ABBL_REPORTING'
EXPORTING
EMATNR          = /A1F/YLNS0011-YL_MATNR_SALE
EWERKS          = /A1F/YLNS0011-YL_DWERK
ECRPES          = A1F_WL_ECRPES
IMPORTING
IMT61D          = A1F_WL_IMT61D
TABLES
MDPSX           = A1F_TL_MDPSX
MDEZX           = A1F_TL_MDEZX
MDSUX           = A1F_TL_MDSUX
PLAFM           = A1F_TL_PLAFM
PLAFD           = A1F_TL_PLAFD
MDFAM           = A1F_TL_MDFAM
MDFAD           = A1F_TL_MDFAD
MDRSM           = A1F_TL_MDRSM
MDRSD           = A1F_TL_MDRSD
EXCEPTIONS
ERROR_MATMASTER = 1
OTHERS          = 2.
*2006/04/06 ARAI ADD - END

IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.


IF SY-SUBRC <> 0.
MESSAGE E161(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK .
ENDIF.

* 手元在庫の設定
READ TABLE A1F_TL_MDPSX WITH KEY DELKZ = 'WB' .
IF SY-SUBRC = 0 .
/A1F/YLNS0011-YL_TMTZIK = A1F_TL_MDPSX-MNG01 .
ELSE .
MESSAGE E161(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK .
ENDIF .

CLEAR : /A1F/YLNS0011-YL_JTYUGUKI ,
/A1F/YLNS0011-YL_HTYUGUKI .
LOOP AT A1F_TL_MDPSX
WHERE KNTTP = SPACE.
* 受注数量合計の設定
IF A1F_TL_MDPSX-DELKZ = 'MB'      "出庫
OR A1F_TL_MDPSX-DELKZ = 'VC'   "指図
OR A1F_TL_MDPSX-DELKZ = 'VJ'   "納入
OR A1F_TL_MDPSX-DELKZ = 'WA' . "出庫
/A1F/YLNS0011-YL_JTYUGUKI = /A1F/YLNS0011-YL_JTYUGUKI
+ A1F_TL_MDPSX-MNG01 .
ENDIF .
* 発注数量合計の設定
IF A1F_TL_MDPSX-DELKZ = 'BE'      "購買発注明細日程計画行
OR A1F_TL_MDPSX-DELKZ = 'E1'   "外注発注
OR A1F_TL_MDPSX-DELKZ = 'LA'   "出荷通知
OR A1F_TL_MDPSX-DELKZ = 'MR'   "入出庫予定
OR A1F_TL_MDPSX-DELKZ = 'VH'   "得意先からの受託品/預託品の戻り
OR A1F_TL_MDPSX-DELKZ = 'VT'   "返品 (利用可能在庫確認)
OR A1F_TL_MDPSX-DELKZ = 'WE' . "入庫
/A1F/YLNS0011-YL_HTYUGUKI = /A1F/YLNS0011-YL_HTYUGUKI
+ A1F_TL_MDPSX-MNG01 .
ENDIF .

IF A1F_TL_MDPSX-DELKZ = 'RP' . "返品明細
/A1F/YLNS0011-YL_HTYUGUKI = /A1F/YLNS0011-YL_HTYUGUKI
- A1F_TL_MDPSX-MNG01 .
ENDIF .
ENDLOOP .

* 未引当在庫の計算
/A1F/YLNS0011-YL_MHKATZIK = /A1F/YLNS0011-YL_TMTZIK
+ /A1F/YLNS0011-YL_HTYUGUKI
- /A1F/YLNS0011-YL_JTYUGUKI .

* 総在庫数の計算
/A1F/YLNS0011-YL_SUZIKSU = /A1F/YLNS0011-YL_TMTZIK
+ /A1F/YLNS0011-YL_HTYUGUKI .

IF /A1F/YLNS0011-YL_VBELN IS INITIAL
AND /A1F/YLNS0011-YL_EBELN IS INITIAL .
* 発注後未引当在庫の計算
/A1F/YLNS0011-YL_HTYUGSU = /A1F/YLNS0011-YL_MHKATZIK
+ /A1F/YLNS0011-YL_HTYUSU
- /A1F/YLNS0011-YL_JTYUSU .
ENDIF .

ENDFORM.                    " a1f_get_stock_info
*&---------------------------------------------------------------------*
*&      Form  a1f_get_matnr
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_MATNR .

* 得意先コードと得意先品目コードのチェック
IF /A1F/YLNS0011-YL_KDMAT IS INITIAL
OR /A1F/YLNS0011-YL_TKISKCD IS INITIAL .
ELSE .
SELECT SINGLE * FROM  KNMT
INTO A1F_WG_KNMT
WHERE  VKORG  = /A1F/YLNS0011-VKORG
AND    VTWEG  = /A1F/YLNS0011-VTWEG
AND    KUNNR  = /A1F/YLNS0011-YL_TKISKCD
AND    KDMAT  = /A1F/YLNS0011-YL_KDMAT .
IF SY-SUBRC NE 0 .
MESSAGE E150(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD
/A1F/YLNS0011-YL_KDMAT .
ENDIF .
/A1F/YLNS0011-YL_MATNR_SALE = A1F_WG_KNMT-MATNR .
ENDIF .

* 得意先コードと品目コードのチェック
IF /A1F/YLNS0011-YL_KDMAT IS INITIAL .
IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL
OR /A1F/YLNS0011-YL_TKISKCD IS INITIAL .
ELSE .
SELECT SINGLE * FROM  KNMT
INTO A1F_WG_KNMT
WHERE  VKORG  = /A1F/YLNS0011-VKORG
AND    VTWEG  = /A1F/YLNS0011-VTWEG
AND    KUNNR  = /A1F/YLNS0011-YL_TKISKCD
AND    MATNR  = /A1F/YLNS0011-YL_MATNR_SALE .
IF SY-SUBRC NE 0 .
MESSAGE I150(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD
/A1F/YLNS0011-YL_MATNR_SALE .
ENDIF .
/A1F/YLNS0011-YL_KDMAT = A1F_WG_KNMT-KDMAT .
ENDIF .
ENDIF .

ENDFORM.                    " a1f_get_matnr
*&---------------------------------------------------------------------*
*&      Form  a1f_set_cursor_9000_001
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SET_CURSOR_9000_001 .

IF /A1F/YLNS0011-YL_TKISKCD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_TKISKCD'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_KDMAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_KDMAT'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_MATNR_SALE'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-VKBUR IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-VKBUR'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-VKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-VKGRP'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-EKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP'.
EXIT .
ENDIF .


ENDFORM.                    " a1f_set_cursor_9000_001
*&---------------------------------------------------------------------*
*&      Form  a1f_get_initial_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_INITIAL_DATA .

* 品目マスタ：基本ビューの取得
SELECT SINGLE * FROM  MARA
INTO A1F_WG_MARA
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE .
IF SY-SUBRC NE 0 .
MESSAGE E152(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE .
ENDIF .

* 品目マスタ：販売ビューの取得
SELECT SINGLE * FROM  MVKE
INTO A1F_WG_MVKE
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND  VKORG  = /A1F/YLNS0011-VKORG
AND  VTWEG  = /A1F/YLNS0011-VTWEG.
IF SY-SUBRC NE 0 .
MESSAGE E153(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE .
ENDIF .

* 得意先マスタ：基本ビューの取得
SELECT SINGLE * FROM  KNA1
INTO A1F_WG_KNA1
WHERE  KUNNR  = /A1F/YLNS0011-YL_TKISKCD .
IF SY-SUBRC NE 0 .
MESSAGE E154(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD .
ENDIF .

* 得意先マスタ：販売ビューの取得
SELECT SINGLE * FROM  KNVV
INTO A1F_WG_KNVV
WHERE  KUNNR  = /A1F/YLNS0011-YL_TKISKCD
AND  VKORG  = /A1F/YLNS0011-VKORG
AND  VTWEG  = /A1F/YLNS0011-VTWEG
AND  SPART  = /A1F/YLNS0011-SPART.
IF SY-SUBRC NE 0 .
MESSAGE E155(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD .
ENDIF .

* 得意先マスタ：取引先機能の取得
SELECT * FROM  KNVP
INTO TABLE A1F_TG_KNVP
WHERE  KUNNR  = /A1F/YLNS0011-YL_TKISKCD
AND  VKORG  = /A1F/YLNS0011-VKORG
AND  VTWEG  = /A1F/YLNS0011-VTWEG
AND  SPART  = /A1F/YLNS0011-SPART.
IF SY-SUBRC NE 0 .
MESSAGE E156(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD .
ENDIF .

* 品目テキストの取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
SELECT SINGLE MAKTX FROM  MAKT
INTO /A1F/YLNS0011-YL_MAKTX_SALE
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    SPRAS  = SY-LANGU.
IF SY-SUBRC NE 0 .
MESSAGE E151(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
SY-LANGU .
ENDIF .
ENDIF .

* 基本数量単位の設定
/A1F/YLNS0011-YL_MEINS = A1F_WG_MARA-MEINS .

* 伝票タイプの設定
PERFORM A1F_EXIT_SET_AUART CHANGING /A1F/YLNS0011-YL_AUART .

* 営業所の設定
IF /A1F/YLNS0011-VKBUR IS INITIAL .
/A1F/YLNS0011-VKBUR = A1F_WG_KNVV-VKBUR .
ENDIF .
IF /A1F/YLNS0011-VKBUR IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-VKBUR' .
MESSAGE E203(/A1F/YLMS0100) .
ENDIF .

* 営業グループの設定
IF /A1F/YLNS0011-VKGRP IS INITIAL .
/A1F/YLNS0011-VKGRP = A1F_WG_KNVV-VKGRP .
ENDIF .
IF /A1F/YLNS0011-VKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-VKGRP' .
MESSAGE E204(/A1F/YLMS0100) .
ENDIF .

* プラントの設定
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
/A1F/YLNS0011-YL_DWERK = A1F_WG_KNVV-VWERK .
ENDIF .
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK' .
MESSAGE E207(/A1F/YLMS0100) .
ENDIF .

* 品目マスタ：会計ビューの取得
SELECT SINGLE * FROM  MBEW
INTO A1F_WG_MBEW
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND  BWKEY  = /A1F/YLNS0011-YL_DWERK .
IF SY-SUBRC NE 0 .
MESSAGE E158(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
ENDIF .

* 品目マスタ：プラントビューの取得
SELECT SINGLE * FROM  MARC
INTO A1F_WG_MARC
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND  WERKS  = /A1F/YLNS0011-YL_DWERK .
IF SY-SUBRC NE 0 .
MESSAGE E217(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
ENDIF .


* BAPIによる受注関連データの取得
CLEAR : A1F_WG_SOLD_TO_PARTY_SIM ,
A1F_WG_SHIP_TO_PARTY_SIM ,
A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM ,
A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_MESSAGETABLE_SIM .
REFRESH : A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_MESSAGETABLE_SIM .

A1F_WG_ORDER_HEADER_IN_SIM-DOC_TYPE = /A1F/YLNS0011-YL_AUART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_ORG = /A1F/YLNS0011-VKORG .
A1F_WG_ORDER_HEADER_IN_SIM-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
A1F_WG_ORDER_HEADER_IN_SIM-DIVISION = /A1F/YLNS0011-SPART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_GRP = /A1F/YLNS0011-VKGRP .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_OFF = /A1F/YLNS0011-VKBUR .
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = SY-DATUM .
ELSE .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
ENDIF .

CLEAR A1F_TG_ORDER_PARTNERS_SIM .
REFRESH A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'SP' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .
A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = 1.
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CALL FUNCTION 'BAPI_SALESORDER_SIMULATE'
EXPORTING
ORDER_HEADER_IN     = A1F_WG_ORDER_HEADER_IN_SIM
CONVERT_PARVW_AUART = 'X'
IMPORTING
SOLD_TO_PARTY       = A1F_WG_SOLD_TO_PARTY_SIM
SHIP_TO_PARTY       = A1F_WG_SHIP_TO_PARTY_SIM
BILLING_PARTY       = A1F_WG_BILLING_PARTY_SIM
RETURN              = A1F_WG_RETURN_SIM
TABLES
ORDER_ITEMS_IN      = A1F_TG_ORDER_ITEMS_IN_SIM
ORDER_PARTNERS      = A1F_TG_ORDER_PARTNERS_SIM
ORDER_SCHEDULE_IN   = A1F_TG_ORDER_SCHEDULE_IN_SIM
ORDER_ITEMS_OUT     = A1F_TG_ORDER_ITEMS_OUT_SIM
ORDER_SCHEDULE_EX   = A1F_TG_ORDER_SCHEDULE_EX_SIM
ORDER_CONDITION_EX  = A1F_TG_ORDER_CONDITION_EX_SIM
ORDER_INCOMPLETE    = A1F_TG_ORDER_INCOMPLETE_SIM
MESSAGETABLE        = A1F_TG_MESSAGETABLE_SIM
PARTNERADDRESSES    = A1F_TG_PARTNERADDRESSES_SIM.

* 2009/06/19 INSERT START
IF /A1F/YLNS0011-YL_VBELN IS INITIAL AND
/A1F/YLNS0011-YL_EBELN IS INITIAL .
* 2009/06/19 INSERT END
LOOP AT A1F_TG_MESSAGETABLE_SIM .
MESSAGE ID A1F_TG_MESSAGETABLE_SIM-ID
TYPE A1F_TG_MESSAGETABLE_SIM-TYPE
NUMBER A1F_TG_MESSAGETABLE_SIM-NUMBER
WITH A1F_TG_MESSAGETABLE_SIM-MESSAGE_V1
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V2
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V3
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V4 .
ENDLOOP .
* 2009/06/19 INSERT START
ENDIF .
* 2009/06/19 INSERT END

* 2009/06/19 INSERT START
IF /A1F/YLNS0011-YL_VBELN IS INITIAL AND
/A1F/YLNS0011-YL_EBELN IS INITIAL .
* 2009/06/19 INSERT END
*   得意先品目テキストの設定
IF NOT ( /A1F/YLNS0011-YL_KDMAT IS INITIAL ) .
/A1F/YLNS0011-YL_POSTX = A1F_WG_KNMT-POSTX .
ELSE .
IF /A1F/YLNS0011-YL_POSTX IS INITIAL .
/A1F/YLNS0011-YL_POSTX = /A1F/YLNS0011-YL_MAKTX_SALE .
ENDIF .
ENDIF .
* 2009/06/19 INSERT START
ENDIF .
* 2009/06/19 INSERT END

* 与信金額（売上額）の取得
PERFORM A1F_EXIT_GET_SAUFT
CHANGING A1F_WG_BILLING_PARTY_SIM .

* 受注日付の設定
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
/A1F/YLNS0011-YL_AUDAT = SY-DATUM .
ENDIF .

* 更新タイプの設定
/A1F/YLNS0011-YL_KUSNTYP = TEXT-100. "新規受注' .

* 明細カテゴリタイプの設定
READ TABLE A1F_TG_ORDER_ITEMS_OUT_SIM INDEX 1 .
IF A1F_TG_ORDER_ITEMS_OUT_SIM-ITEM_CATEG IN A1F_RG_PSTYV_TAB .
/A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110 . "個別購買発注' .
ELSEIF A1F_TG_ORDER_ITEMS_OUT_SIM-ITEM_CATEG IN A1F_RG_PSTYV_TAN .
/A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 . "在庫品' .
ELSE .
MESSAGE E162(/A1F/YLMS0100) WITH
A1F_TG_ORDER_ITEMS_OUT_SIM-ITEM_CATEG.
ENDIF .

* 受注単位の設定
IF A1F_WG_MVKE-VRKME IS INITIAL .
/A1F/YLNS0011-YL_VRKME = A1F_WG_MARA-MEINS .
ELSE .
/A1F/YLNS0011-YL_VRKME = A1F_WG_MVKE-VRKME .
ENDIF .

** 2007/09/13 DELETE START
** 品目マスタの単位と販売価格マスタの単位のチェック
**  に関する不具合対応
** 単位チェックは単価取得時に行うため、数量入力後に実施する
*** 2007/07/21 INSERT START
*** 品目マスタの単位と販売価格マスタの単位のチェック
*** 品目マスタの単位と販売価格マスタの単位が異なる場合エラーとする
*  READ TABLE A1F_TG_ORDER_CONDITION_EX_SIM WITH KEY
*                                     COND_TYPE = A1F_CNS_KSCHL
*                                     CONDISACTI = SPACE .
*** 2007/09/10 INSERT START
*** 品目マスタの単位と販売価格マスタの単位のチェック
***  に関する不具合対応
*** 品目マスタの単位と販売価格マスタの単位が異なる場合
***  エラーとするが、品目マスタ上で販売単位がスペースの
***  場合は基本数量単位との比較を行う
*  IF /A1F/YLNS0011-YL_VRKME IS INITIAL .
*   IF A1F_TG_ORDER_CONDITION_EX_SIM-COND_UNIT
*              NE /A1F/YLNS0011-YL_MEINS .
*      MESSAGE E224(/A1F/YLMS0100) .
*    ENDIF .
*  ELSE .
*** 2007/09/10 INSERT END
*    IF A1F_TG_ORDER_CONDITION_EX_SIM-COND_UNIT
*                   NE /A1F/YLNS0011-YL_VRKME .
*      MESSAGE E224(/A1F/YLMS0100) .
*    ENDIF .
*** 2007/07/21 INSERT END
*** 2007/09/10 INSERT START
*** 品目マスタの単位と販売価格マスタの単位のチェック
***  に関する不具合対応
*** 品目マスタの単位と販売価格マスタの単位が異なる場合
***  エラーとするが、品目マスタ上で販売単位がスペースの
***  場合は基本数量単位との比較を行う
*  ENDIF .
*** 2007/09/10 INSERT END
** 2007/09/10 DELETE END


* 指定出荷日付の設定
*  IF /A1F/YLNS0011-YL_VDATU IS INITIAL .
*    /A1F/YLNS0011-YL_VDATU = SY-DATUM .
*  ENDIF .

* 出荷先コードの取得
DATA : A1F_WL_KNVP_WE_CNT LIKE SY-TABIX .
CLEAR A1F_WL_KNVP_WE_CNT .
LOOP AT A1F_TG_KNVP
WHERE PARVW = 'WE' .
A1F_WL_KNVP_WE_CNT = A1F_WL_KNVP_WE_CNT + 1 .
ENDLOOP .

IF A1F_WL_KNVP_WE_CNT = 1 .
READ TABLE A1F_TG_KNVP WITH KEY
PARVW = 'WE'
PARZA = '000' .
IF SY-SUBRC = 0.
/A1F/YLNS0011-YL_SYKSKCD = A1F_TG_KNVP-KUNN2 .
ELSE .
MESSAGE W157(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_TKISKCD .
ENDIF .
ELSE .
CLEAR /A1F/YLNS0011-YL_SYKSKCD .
ENDIF .

* 得意先名称
/A1F/YLNS0011-YL_TKISKNM = A1F_WG_KNA1-NAME1 .

* 受注単価、単位数量（per）
*  DATA : A1F_WL_RETURN_CURR_EX LIKE BAPIRETURN .
*  DATA : A1F_WL_BAPICURR LIKE BAPICURR-BAPICURR .
*  READ TABLE A1F_TG_ORDER_CONDITION_EX_SIM WITH KEY
*                                     COND_TYPE = A1F_CNS_KSCHL
*                                     CONDISACTI = SPACE .
*  IF SY-SUBRC = 0.
*    A1F_WL_BAPICURR = A1F_TG_ORDER_CONDITION_EX_SIM-COND_VALUE .
*    CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_INTERNAL'
*      EXPORTING
*        CURRENCY             = A1F_TG_ORDER_CONDITION_EX_SIM-CURRENCY
*        AMOUNT_EXTERNAL      = A1F_WL_BAPICURR
*        MAX_NUMBER_OF_DIGITS = '13'
*      IMPORTING
*        AMOUNT_INTERNAL      = /A1F/YLNS0011-YL_JTYUTNK
*        RETURN               = A1F_WL_RETURN_CURR_EX.
*    IF A1F_WL_RETURN_CURR_EX-TYPE NE 'E' .
*      /A1F/YLNS0011-YL_KPEIN = A1F_TG_ORDER_CONDITION_EX_SIM-COND_P_UNT
*      .
*    ELSE .
*      CLEAR /A1F/YLNS0011-YL_JTYUTNK .
*      /A1F/YLNS0011-YL_KPEIN = 1 .
*    ENDIF .
*  ELSE .
*    CLEAR /A1F/YLNS0011-YL_JTYUTNK .
*    /A1F/YLNS0011-YL_KPEIN = 1 .
*  ENDIF .
*  A1F_WG_MASTER_TANKA_SALE = /A1F/YLNS0011-YL_JTYUTNK .
*
*  PERFORM A1F_EXIT_GET_JTYUTNK
*      CHANGING /A1F/YLNS0011-YL_JTYUTNK
*               /A1F/YLNS0011-YL_KPEIN .

* 受注通貨
/A1F/YLNS0011-YL_JTYTUK = A1F_WG_KNVV-WAERS .

* 売上原価
/A1F/YLNS0011-YL_URAGGNK = A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH .
* 粗利
* 与信限度額の設定
*CRED_LIMIT 得意先与信限度額
/A1F/YLNS0011-YL_YSNGK = A1F_WG_BILLING_PARTY_SIM-CRED_LIMIT .
* 与信残高の設定
*ORDER_VALS 与信限度チェックにおける売上金額合計
*RCVBL_VALS 債権合計 (与信限度チェック用)
*CRED_LIAB  与信限度チェックのための関連特殊仕訳債権額
/A1F/YLNS0011-YL_YSNZNDK = A1F_WG_BILLING_PARTY_SIM-CRED_LIMIT
- A1F_WG_BILLING_PARTY_SIM-ORDER_VALS
- A1F_WG_BILLING_PARTY_SIM-RCVBL_VALS
- A1F_WG_BILLING_PARTY_SIM-CRED_LIAB .


** 2007/07/21 INSERT START
** 出荷指示備考の取得
** 得意先品目情報マスタの得意先品目情報テキストから取得し表示する

DATA : A1F_WL_ID LIKE THEAD-TDID ,
A1F_WL_LANGUAGE LIKE THEAD-TDSPRAS  ,
A1F_WL_NAME LIKE THEAD-TDNAME ,
A1F_WL_OBJECT LIKE THEAD-TDOBJECT .

DATA : A1F_TL_INLINES LIKE TABLE OF TLINE WITH HEADER LINE .

DATA : BEGIN OF A1F_WL_KNMT_KEY ,
VKORG LIKE KNMT-VKORG ,
VTWEG LIKE KNMT-VTWEG ,
KUNNR LIKE KNMT-KUNNR ,
MATNR LIKE KNMT-MATNR ,
END OF A1F_WL_KNMT_KEY .

CLEAR : A1F_WL_ID  ,
A1F_WL_LANGUAGE   ,
A1F_WL_NAME  ,
A1F_WL_OBJECT  .
CLEAR : A1F_TL_INLINES  ,
A1F_TG_LINES_YL_SYKSJBKU .
REFRESH : A1F_TL_INLINES  ,
A1F_TG_LINES_YL_SYKSJBKU .

A1F_WL_KNMT_KEY-VKORG = A1F_WG_KNMT-VKORG .
A1F_WL_KNMT_KEY-VTWEG = A1F_WG_KNMT-VTWEG .
A1F_WL_KNMT_KEY-KUNNR = A1F_WG_KNMT-KUNNR .
A1F_WL_KNMT_KEY-MATNR = A1F_WG_KNMT-MATNR .

A1F_WL_NAME = A1F_WL_KNMT_KEY .
A1F_WL_LANGUAGE = SY-LANGU .
A1F_WL_ID = '0001' .
A1F_WL_OBJECT = 'KNMT' .

CALL FUNCTION 'READ_TEXT_INLINE'
EXPORTING
ID              = A1F_WL_ID
INLINE_COUNT    = 100
LANGUAGE        = A1F_WL_LANGUAGE
NAME            = A1F_WL_NAME
OBJECT          = A1F_WL_OBJECT
TABLES
INLINES         = A1F_TL_INLINES
LINES           = A1F_TG_LINES_YL_SYKSJBKU
EXCEPTIONS
ID              = 1
LANGUAGE        = 2
NAME            = 3
NOT_FOUND       = 4
OBJECT          = 5
REFERENCE_CHECK = 6
OTHERS          = 7.
IF SY-SUBRC <> 0.
CLEAR /A1F/YLNS0011-YL_SYKSJBKU .
ELSE .
READ TABLE A1F_TL_INLINES INDEX 1 .
/A1F/YLNS0011-YL_SYKSJBKU = A1F_TL_INLINES-TDLINE .
ENDIF.
** 2007/07/21 INSERT END


* 購買発注側の品目コードへコピー
/A1F/YLNS0011-YL_MATNR_PURC = /A1F/YLNS0011-YL_MATNR_SALE .
/A1F/YLNS0011-YL_MAKTX_PURC = /A1F/YLNS0011-YL_MAKTX_SALE .

* 発注単位INFORECORD_GENERAL-PO_UNIT
IF A1F_WG_MARA-BSTME IS INITIAL .
/A1F/YLNS0011-YL_BSTME = A1F_WG_MARA-MEINS .
ELSE .
/A1F/YLNS0011-YL_BSTME = A1F_WG_MARA-BSTME .
ENDIF .

* 単位数量（per）INFORECORD_PURCHORG-PRICE_UNIT
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
/A1F/YLNS0011-YL_PEINH = 1 .
ENDIF .

* 発注通貨INFORECORD_PURCHORG-CURRENCY
/A1F/YLNS0011-YL_HTYUTUK = A1F_WG_T001-WAERS .

* 発注日付
/A1F/YLNS0011-YL_BEDAT = SY-DATUM .
* 納入日付
*  /A1F/YLNS0011-YL_EEIND = SY-DATUM + A1F_WG_MARC-WEBAZ .

* 購買情報取得
DATA A1F_WL_PURCHORG_LINE_COUNT LIKE SY-TABIX .
DATA A1F_WL_GENERAL_LINE_COUNT LIKE SY-TABIX .
CALL FUNCTION 'BAPI_INFORECORD_GETLIST'
EXPORTING
MATERIAL            = /A1F/YLNS0011-YL_MATNR_PURC
PURCH_ORG           = /A1F/YLNS0011-EKORG
INFO_TYPE           = '0'
PLANT               = /A1F/YLNS0011-YL_DWERK
TABLES
INFORECORD_GENERAL  = A1F_TG_INFORECORD_GENERAL
INFORECORD_PURCHORG = A1F_TG_INFORECORD_PURCHORG
RETURN              = A1F_TG_RETURN_PURC_INFO.
*
* 供給元一覧を参照し、購買情報を限定する
PERFORM A1F_VENDORGET_AND_DELETE
TABLES A1F_TG_INFORECORD_GENERAL
A1F_TG_INFORECORD_PURCHORG
USING  /A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_DWERK
SY-DATUM .
*
DESCRIBE TABLE A1F_TG_INFORECORD_GENERAL LINES
A1F_WL_GENERAL_LINE_COUNT.
IF A1F_WL_GENERAL_LINE_COUNT NE 1.
MESSAGE W163(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
A1F_WL_GENERAL_LINE_COUNT.
EXIT .
ENDIF .
*
READ TABLE A1F_TG_INFORECORD_GENERAL INDEX 1 .

* 仕入先コードの設定
/A1F/YLNS0011-YL_SIRSKCD = A1F_TG_INFORECORD_GENERAL-VENDOR .

SELECT SINGLE * FROM  LFA1
INTO A1F_WG_LFA1
WHERE  LIFNR  = /A1F/YLNS0011-YL_SIRSKCD.
IF SY-SUBRC NE 0 .
MESSAGE E164(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_SIRSKCD.
ENDIF .

SELECT SINGLE * FROM  LFM1
INTO A1F_WG_LFM1
WHERE  LIFNR  = /A1F/YLNS0011-YL_SIRSKCD
AND  EKORG  = /A1F/YLNS0011-EKORG.
IF SY-SUBRC NE 0 .
MESSAGE E164(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_SIRSKCD.
ENDIF .
IF A1F_WG_LFM1-WAERS IS INITIAL .
MESSAGE E216(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_SIRSKCD.
ENDIF .

* 仕入先名の設定
/A1F/YLNS0011-YL_SIRSKNM = A1F_WG_LFA1-NAME1 .

* 仕入先品目コード
/A1F/YLNS0011-YL_IDNLF = A1F_TG_INFORECORD_GENERAL-VEND_MAT .

* 発注通貨INFORECORD_PURCHORG-CURRENCY
/A1F/YLNS0011-YL_HTYUTUK = A1F_WG_LFM1-WAERS .

* 仕入先品目名

* 発注単位INFORECORD_GENERAL-PO_UNIT
/A1F/YLNS0011-YL_BSTME = A1F_TG_INFORECORD_GENERAL-PO_UNIT .

DESCRIBE TABLE A1F_TG_INFORECORD_PURCHORG LINES
A1F_WL_PURCHORG_LINE_COUNT.
IF A1F_WL_PURCHORG_LINE_COUNT NE 1.
MESSAGE W165(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_SIRSKCD
A1F_WL_PURCHORG_LINE_COUNT.
EXIT .
ENDIF .

READ TABLE A1F_TG_INFORECORD_PURCHORG INDEX 1 .

DATA : A1F_WL_RETURN_CURR_EX LIKE BAPIRETURN .
DATA : A1F_WL_BAPICURR LIKE BAPICURR-BAPICURR .

CLEAR : A1F_WL_RETURN_CURR_EX ,
A1F_WL_BAPICURR .

* 発注単価INFORECORD_PURCHORG-NET_PRICE
*  A1F/YLNS0011-YL_HTYUTNK = A1F_TG_INFORECORD_PURCHORG-NET_PRICE .
A1F_WG_MASTER_TANKA_PURC = A1F_TG_INFORECORD_PURCHORG-NET_PRICE .

* 単位数量（per）INFORECORD_PURCHORG-PRICE_UNIT
/A1F/YLNS0011-YL_PEINH = A1F_TG_INFORECORD_PURCHORG-PRICE_UNIT .
* 発注通貨INFORECORD_PURCHORG-CURRENCY
/A1F/YLNS0011-YL_HTYUTUK = A1F_TG_INFORECORD_PURCHORG-CURRENCY .

* 購買グループの設定
* Change By Mis-Ohno
*  IF /A1F/YLNS0011-EKGRP IS INITIAL .
*    /A1F/YLNS0011-EKGRP = A1F_TG_INFORECORD_PURCHORG-PUR_GROUP .
*  ENDIF .
*    IF /A1F/YLNS0011-EKGRP IS INITIAL .
*      SET CURSOR FIELD '/A1F/YLNS0011-EKGRP' .
*      MESSAGE E208(/A1F/YLMS0100) .
*    ENDIF .
IF /A1F/YLNS0011-EKGRP IS INITIAL .
DATA WK_PUR_GROUP LIKE A1F_WG_KNVV-VKGRP .

SELECT SINGLE EKGRP FROM T024
INTO WK_PUR_GROUP
WHERE EKGRP = A1F_WG_KNVV-VKGRP .

IF NOT SY-SUBRC = 0 .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP' .
MESSAGE E118(/A1F/YLMS0100) WITH A1F_WG_KNVV-VKGRP .
ELSE .
/A1F/YLNS0011-EKGRP = WK_PUR_GROUP .
ENDIF .
ENDIF .
* End Change

* 直送区分（出荷指示）の設定
/A1F/YLNS0011-YL_TYKSUKBN = A1F_TG_INFORECORD_PURCHORG-SHIPPING .

* 購買情報テキストの取得
PERFORM A1F_GET_PURCH_TEXT USING A1F_TG_INFORECORD_GENERAL
A1F_TG_INFORECORD_PURCHORG .


ENDFORM.                    " a1f_get_initial_data
*&---------------------------------------------------------------------*
*&      Form  a1f_set_cursor_9000_002
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SET_CURSOR_9000_002 .

SET CURSOR FIELD '/A1F/YLNS0011-YL_JTYUSU'.

IF /A1F/YLNS0011-YL_BSTKD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTKD'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_JTYUSU'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_VRKME IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_VRKME'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_AUDAT'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_VDATU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_VDATU'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_SYKSKCD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_SYKSKCD'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_JTYUTNK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_JTYUTNK'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_SIRSKCD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_SIRSKCD'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_BEDAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BEDAT'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_EEIND IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_EEIND'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_IDNLF IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_IDNLF'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_HTYUSU'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_BSTME IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_HTYUTNK'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_BEDAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BEDAT'.
EXIT .
ENDIF .


ENDFORM.                    " a1f_set_cursor_9000_002
*&---------------------------------------------------------------------*
*&      Form  A1F_Calculation_sales_Amount
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALCULATION_SALES_AMOUNT .

DATA : A1F_WL_T685A LIKE T685A .
DATA : A1F_WL_NETWR TYPE P DECIMALS 3 .

** 2009/06/11 INSERT START
** 発注のみの場合、発注金額が計算されない不具合対応
IF /A1F/YLNS0011-YL_HTYUNSKBN IS INITIAL .
** 2009/06/11 INSERT END
IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL
OR /A1F/YLNS0011-YL_TKISKCD IS INITIAL .
EXIT .
ENDIF .


*   販売金額の計算
IF NOT ( /A1F/YLNS0011-YL_JTYUTNK IS INITIAL ) .
IF /A1F/YLNS0011-YL_KPEIN IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_KPEIN' .
MESSAGE E177(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_KPEIN NE 100
AND /A1F/YLNS0011-YL_KPEIN NE 1000
AND /A1F/YLNS0011-YL_KPEIN NE 10000
AND /A1F/YLNS0011-YL_KPEIN NE 1 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_KPEIN' .
MESSAGE E178(/A1F/YLMS0100) .
ENDIF .
SELECT SINGLE * FROM  T685A
INTO A1F_WL_T685A
WHERE  KAPPL  = 'V'
AND    KSCHL  = A1F_CNS_KSCHL.
IF SY-SUBRC NE 0 .
MESSAGE E160(/A1F/YLMS0100) .
ENDIF .

IF A1F_WL_T685A-TXPRF = SPACE . "四捨五入
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_JTYUTNK /
/A1F/YLNS0011-YL_KPEIN )
* /A1F/YLNS0011-YL_JTYUSU ) .
ELSEIF A1F_WL_T685A-TXPRF = 'A' . "切上
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_JTYUTNK /
/A1F/YLNS0011-YL_KPEIN )
* /A1F/YLNS0011-YL_JTYUSU ) + '0.005' .
ELSEIF A1F_WL_T685A-TXPRF = 'B' . "切捨て
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_JTYUTNK /
/A1F/YLNS0011-YL_KPEIN )
* /A1F/YLNS0011-YL_JTYUSU ) - '0.005' .
ENDIF .
ENDIF .
** 2009/06/11 INSERT START
** 発注のみの場合、発注金額が計算されない不具合対応
ENDIF .
** 2009/06/11 INSERT END

* 売上金額
/A1F/YLNS0011-YL_JYYUKNGK = A1F_WL_NETWR .
DATA : A1F_WL_EXCH_RATE LIKE BAPI1093_0 ,
A1F_WL_RETURN_EXCH LIKE BAPIRET1 .
* 売上金額（国内通貨）
IF /A1F/YLNS0011-YL_JTYTUK NE /A1F/YLNS0011-YL_WAERS
AND NOT ( /A1F/YLNS0011-YL_JYYUKNGK IS INITIAL ) .
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_JTYTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
IF SY-SUBRC NE 0
OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
MESSAGE E160(/A1F/YLMS0100) WITH
A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_JTYTUK
/A1F/YLNS0011-YL_WAERS.
ENDIF .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK
* A1F_WL_EXCH_RATE-EXCH_RATE.
ELSE .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
ENDIF .

* 売上原価
IF NOT ( /A1F/YLNS0011-YL_JTYUSU IS INITIAL ) .
/A1F/YLNS0011-YL_URAGGNK = ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
* /A1F/YLNS0011-YL_JTYUSU .
ENDIF .
* 粗利
/A1F/YLNS0011-YL_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C -
/A1F/YLNS0011-YL_URAGGNK .

* 購買金額の計算
IF /A1F/YLNS0011-YL_MSYUFLG NE SPACE .
CLEAR /A1F/YLNS0011-YL_HTYUTNK .
ENDIF .

CLEAR A1F_WL_NETWR .
IF NOT ( /A1F/YLNS0011-YL_HTYUTNK IS INITIAL ) .
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_PEINH' .
MESSAGE E194(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_PEINH NE 100
AND /A1F/YLNS0011-YL_PEINH NE 1000
AND /A1F/YLNS0011-YL_PEINH NE 10000
AND /A1F/YLNS0011-YL_PEINH NE 1 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_PEINH' .
MESSAGE E195(/A1F/YLMS0100) .
ENDIF .
SELECT SINGLE * FROM  T685A
INTO A1F_WL_T685A
WHERE  KAPPL  = 'M'
AND    KSCHL  = A1F_CNS_KSCHL_P.
IF SY-SUBRC NE 0 .
MESSAGE E160(/A1F/YLMS0100) .
ENDIF .

IF A1F_WL_T685A-TXPRF = SPACE . "四捨五入
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) .
ELSEIF A1F_WL_T685A-TXPRF = 'A' . "切上
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) + '0.005' .
ELSEIF A1F_WL_T685A-TXPRF = 'B' . "切捨て
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) - '0.005' .
ENDIF .
ENDIF .

* 発注金額
/A1F/YLNS0011-YL_HTYUKNGK = A1F_WL_NETWR .
* 購買金額（国内通貨）
IF /A1F/YLNS0011-YL_HTYUTUK NE /A1F/YLNS0011-YL_WAERS
AND NOT ( /A1F/YLNS0011-YL_HTYUKNGK IS INITIAL ) .
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_HTYUTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
IF SY-SUBRC NE 0
OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK .
MESSAGE E160(/A1F/YLMS0100) WITH
A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_HTYUTUK
/A1F/YLNS0011-YL_WAERS.
ENDIF .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK
* A1F_WL_EXCH_RATE-EXCH_RATE.
ELSE .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK .
ENDIF .

DATA : A1F_WL_MARM LIKE MARM .

* 販売数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_VRKME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
/A1F/YLNS0011-YL_JTYUSU_C = /A1F/YLNS0011-YL_JTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    MEINH  = /A1F/YLNS0011-YL_VRKME .
IF SY-SUBRC NE 0 .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_VRKME.
ENDIF .

/A1F/YLNS0011-YL_JTYUSU_C = ( /A1F/YLNS0011-YL_JTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

* 購買数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_HTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME .
ENDIF .

/A1F/YLNS0011-YL_HTYUSU_C = ( /A1F/YLNS0011-YL_HTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " A1F_Calculation_sales_Amount
*&---------------------------------------------------------------------*
*&      Form  A1F_CALCULATION_Purc_AMOUNT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALCULATION_PURC_AMOUNT .

DATA : A1F_WL_MARM LIKE MARM .

IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 .
* 発注数の計算
*    IF /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
*      /A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_JTYUSU_C
*                              - /A1F/YLNS0011-YL_MHKATZIK .
*      IF /A1F/YLNS0011-YL_HTYUSU_C < 0 .
*        CLEAR : /A1F/YLNS0011-YL_HTYUSU ,
*                /A1F/YLNS0011-YL_HTYUSU_C.
*      ENDIF.
*    ENDIF.
ELSE .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_JTYUSU_C .
ENDIF .

* 基本数量単位から発注単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU_C IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU = /A1F/YLNS0011-YL_HTYUSU_C .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME' .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME.
ENDIF .

/A1F/YLNS0011-YL_HTYUSU = ( /A1F/YLNS0011-YL_HTYUSU_C
* A1F_WL_MARM-UMREN )
/ A1F_WL_MARM-UMREZ .
ENDIF .


ENDFORM.                    " A1F_CALCULATION_Purc_AMOUNT
*&---------------------------------------------------------------------*
*&      Form  a1f_clear_all
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CLEAR_ALL .

CLEAR : /A1F/YLNS0011-VKBUR,
/A1F/YLNS0011-VKGRP,
/A1F/YLNS0011-YL_DWERK,
/A1F/YLNS0011-EKGRP,
/A1F/YLNS0011-YL_AUART,
/A1F/YLNS0011-YL_BSTKD,
/A1F/YLNS0011-YL_KDMAT,
/A1F/YLNS0011-YL_POSTX,
/A1F/YLNS0011-YL_AUDAT,
/A1F/YLNS0011-YL_MATNR_SALE,
/A1F/YLNS0011-YL_MAKTX_SALE,
/A1F/YLNS0011-YL_JTYUSU,
/A1F/YLNS0011-YL_VDATU,
/A1F/YLNS0011-YL_KUSNTYP,
/A1F/YLNS0011-YL_MISIKTGRTYP,
/A1F/YLNS0011-YL_TKISKCD,
/A1F/YLNS0011-YL_SYKSKCD,
/A1F/YLNS0011-YL_SYKSKNM,
/A1F/YLNS0011-YL_VBELN,
/A1F/YLNS0011-YL_YSNGK,
/A1F/YLNS0011-YL_YSNZNDK,
/A1F/YLNS0011-YL_TKISKNM,
/A1F/YLNS0011-YL_LIFSK,
/A1F/YLNS0011-YL_KPEIN,
/A1F/YLNS0011-YL_VRKME,
/A1F/YLNS0011-YL_JTYUTNK,
/A1F/YLNS0011-YL_JYYUKNGK,
/A1F/YLNS0011-YL_JTYTUK,
/A1F/YLNS0011-YL_URAGGNK,
/A1F/YLNS0011-YL_ARARI,
/A1F/YLNS0011-YL_SYKSJBKU,
/A1F/YLNS0011-YL_NUHNSYBKU,
/A1F/YLNS0011-YL_SYNIBKU,
/A1F/YLNS0011-YL_TMTZIK,
/A1F/YLNS0011-YL_JTYUGUKI,
/A1F/YLNS0011-YL_HTYUGUKI,
/A1F/YLNS0011-YL_MHKATZIK,
/A1F/YLNS0011-YL_MEINS,
/A1F/YLNS0011-YL_SIRSKCD,
/A1F/YLNS0011-YL_SIRSKNM,
/A1F/YLNS0011-YL_BEDAT,
/A1F/YLNS0011-YL_EEIND,
/A1F/YLNS0011-YL_HTYUNSKBN,
/A1F/YLNS0011-YL_EBELN,
/A1F/YLNS0011-YL_MATNR_PURC,
/A1F/YLNS0011-YL_MAKTX_PURC,
/A1F/YLNS0011-YL_IDNLF,
/A1F/YLNS0011-YL_TXZ01,
/A1F/YLNS0011-YL_HTYUSU,
/A1F/YLNS0011-YL_BSTME,
/A1F/YLNS0011-YL_HTYUTNK,
/A1F/YLNS0011-YL_HTYUKNGK,
/A1F/YLNS0011-YL_HTYUTUK,
/A1F/YLNS0011-YL_PEINH,
/A1F/YLNS0011-YL_EDIBKU,
/A1F/YLNS0011-YL_EDIBKU2,
/A1F/YLNS0011-YL_EDISNT,
/A1F/YLNS0011-YL_TUMNSYBKU,
/A1F/YLNS0011-YL_SMDNEDIBKU,
/A1F/YLNS0011-YL_HTYUZNITRNBKU ,
/A1F/YLNS0011-YL_MSYUFLG ,
/A1F/YLNS0011-YL_TYKSUKBN.


CLEAR : A1F_WG_KNMT ,
A1F_WG_MBEW ,
A1F_WG_T001 ,
A1F_WG_MARA ,
A1F_WG_MVKE ,
A1F_WG_KNA1 ,
A1F_WG_KNVV ,
A1F_WG_LFA1 ,
A1F_WG_LFM1 ,
A1F_WG_ORDER_HEADER_IN_SIM  ,
A1F_WG_SOLD_TO_PARTY_SIM    ,
A1F_WG_SHIP_TO_PARTY_SIM    ,
A1F_WG_BILLING_PARTY_SIM    ,
A1F_WG_RETURN_SIM           .

CLEAR : A1F_TG_KNVP  ,
A1F_TG_ORDER_ITEMS_IN_SIM       ,
A1F_TG_ORDER_PARTNERS_SIM       ,
A1F_TG_ORDER_SCHEDULE_IN_SIM    ,
A1F_TG_ORDER_ITEMS_OUT_SIM      ,
A1F_TG_ORDER_SCHEDULE_EX_SIM    ,
A1F_TG_ORDER_CONDITION_EX_SIM   ,
A1F_TG_ORDER_INCOMPLETE_SIM     ,
A1F_TG_MESSAGETABLE_SIM         ,
A1F_TG_PARTNERADDRESSES_SIM     ,
A1F_TG_INFORECORD_GENERAL      ,
A1F_TG_INFORECORD_PURCHORG      ,
A1F_TG_RETURN_PURC_INFO         ,
A1F_WG_POHEADER           ,
A1F_WG_POHEADERX           ,
A1F_WG_POADDRVENDOR        ,
A1F_WG_TESTRUN             ,
A1F_WG_MEMORY_UNCOMPLETE   ,
A1F_WG_MEMORY_COMPLETE     ,
A1F_WG_NO_MESSAGING        ,
A1F_WG_NO_MESSAGE_REQ      ,
A1F_WG_NO_AUTHORITY        ,
A1F_WG_NO_PRICE_FROM_PO    ,
A1F_WG_EXPPURCHASEORDER   ,
A1F_WG_EXPHEADER          ,
A1F_TG_RETURN_PURC ,
A1F_TG_POITEM      ,
A1F_TG_POITEMX  ,
A1F_TG_POADDRDELIVERY  ,
A1F_TG_POSCHEDULE  ,
A1F_TG_POSCHEDULEX  ,
A1F_TG_POACCOUNT  ,
A1F_TG_POACCOUNTPROFITSEGMENT  ,
A1F_TG_POACCOUNTX  ,
A1F_TG_POCOND ,
A1F_TG_POCONDX  ,
A1F_TG_POLIMITS  ,
A1F_TG_POCONTRACTLIMITS  ,
A1F_TG_POSERVICES  ,
A1F_TG_POSRVACCESSVALUES  ,
A1F_TG_POSERVICESTEXT ,
A1F_TG_EXTENSIONIN  ,
A1F_TG_EXTENSIONOUT ,
A1F_TG_POPARTNER ,
A1F_WG_WARNING_CNT ,
A1F_WG_MASTER_TANKA_SALE ,
A1F_WG_MASTER_TANKA_PURC  ,
A1F_TG_LINES_YL_EDIBKU  ,
A1F_TG_LINES_YL_TUMNSYBKU  .

REFRESH : A1F_TG_KNVP  ,
A1F_TG_ORDER_ITEMS_IN_SIM       ,
A1F_TG_ORDER_PARTNERS_SIM       ,
A1F_TG_ORDER_SCHEDULE_IN_SIM    ,
A1F_TG_ORDER_ITEMS_OUT_SIM      ,
A1F_TG_ORDER_SCHEDULE_EX_SIM    ,
A1F_TG_ORDER_CONDITION_EX_SIM   ,
A1F_TG_ORDER_INCOMPLETE_SIM     ,
A1F_TG_MESSAGETABLE_SIM         ,
A1F_TG_PARTNERADDRESSES_SIM     ,
A1F_TG_INFORECORD_GENERAL      ,
A1F_TG_INFORECORD_PURCHORG      ,
A1F_TG_RETURN_PURC_INFO         ,
A1F_TG_RETURN_PURC ,
A1F_TG_POITEM      ,
A1F_TG_POITEMX  ,
A1F_TG_POADDRDELIVERY  ,
A1F_TG_POSCHEDULE  ,
A1F_TG_POSCHEDULEX  ,
A1F_TG_POACCOUNT  ,
A1F_TG_POACCOUNTPROFITSEGMENT  ,
A1F_TG_POACCOUNTX  ,
A1F_TG_POCOND ,
A1F_TG_POCONDX  ,
A1F_TG_POLIMITS  ,
A1F_TG_POCONTRACTLIMITS  ,
A1F_TG_POSERVICES  ,
A1F_TG_POSRVACCESSVALUES  ,
A1F_TG_POSERVICESTEXT ,
A1F_TG_EXTENSIONIN  ,
A1F_TG_EXTENSIONOUT ,
A1F_TG_POPARTNER ,
A1F_TG_LINES_YL_EDIBKU  ,
A1F_TG_LINES_YL_TUMNSYBKU  .
** 2007/07/20 INSERT START
** 出荷先住所変更対応
CLEAR : A1F_WG_FES_ADDR1_COMPLETE ,
A1F_WG_FES_VBADR ,
A1F_WG_FEF_ATTRIBUTES ,
A1F_WG_ADDR1_OUT .
** 2007/07/20 INSERT END

** 2007/07/21 INSERT START
** 出荷指示備考の取得
** 得意先品目情報マスタの得意先品目情報テキストから取得し表示する
CLEAR : A1F_TG_LINES_YL_SYKSJBKU .
REFRESH : A1F_TG_LINES_YL_SYKSJBKU .
** 2007/07/21 INSERT END


ENDFORM.                    " a1f_clear_all
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_md04
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MD04 .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.

CALL TRANSACTION 'MD04' AND SKIP FIRST SCREEN .


ENDFORM.                    " a1f_call_tran_md04
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_mmbe
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MMBE .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD SPACE.
SET PARAMETER ID 'LAG' FIELD SPACE.
SET PARAMETER ID 'CHA' FIELD SPACE.

CALL TRANSACTION 'MMBE' AND SKIP FIRST SCREEN .


ENDFORM.                    " a1f_call_tran_mmbe
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_mb51
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MB51 .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
SET PARAMETER ID 'LAG' FIELD SPACE.
SET PARAMETER ID 'CHA' FIELD SPACE.
SET PARAMETER ID 'LIF' FIELD SPACE.
SET PARAMETER ID 'KUN' FIELD SPACE.
SET PARAMETER ID 'BWA' FIELD SPACE.
SET PARAMETER ID 'USR' FIELD SPACE.

CALL TRANSACTION 'MB51' AND SKIP FIRST SCREEN .

ENDFORM.                    " a1f_call_tran_mb51
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_migo
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MIGO .

SET PARAMETER ID 'BSA' FIELD 'UB'.

CALL TRANSACTION 'ME21N' .


ENDFORM.                    " a1f_call_tran_migo
*&---------------------------------------------------------------------*
*&      Form  a1f_check_and_save_data
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CHECK_AND_SAVE_DATA .

DATA : A1F_WL_TMP_MENGE LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_ANSWER_01(1)  .
DATA : A1F_WL_ANSWER_02(1)  .
DATA : A1F_WL_ANSWER_03(1)  .
DATA : A1F_WL_TMP_TEXT(100)  .

CLEAR : A1F_WG_WARNING_CNT .

* 販売系データチェック
IF /A1F/YLNS0011-YL_HTYUNSKBN = SPACE .
PERFORM A1F_SALES_DATA_CHECK .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUSU = 0
AND /A1F/YLNS0011-YL_HTYUNSKBN = SPACE .
*発注処理を行わないかを確認するポップアップ
CALL FUNCTION 'POPUP_CONTINUE_YES_NO'
EXPORTING
TEXTLINE1 = TEXT-121
TEXTLINE2 = TEXT-122
TITEL     = TEXT-120
IMPORTING
ANSWER    = A1F_WL_ANSWER_01.
IF A1F_WL_ANSWER_01 NE 'J' .
EXIT .
ENDIF .
ELSEIF /A1F/YLNS0011-YL_HTYUNSKBN NE SPACE .
CALL FUNCTION 'POPUP_CONTINUE_YES_NO'
EXPORTING
TEXTLINE1 = TEXT-128
TEXTLINE2 = TEXT-129
TITEL     = TEXT-127
IMPORTING
ANSWER    = A1F_WL_ANSWER_03.
IF A1F_WL_ANSWER_03 NE 'J' .
EXIT .
ENDIF .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUSU NE 0
OR /A1F/YLNS0011-YL_HTYUNSKBN NE SPACE .
* 購買系データチェック
PERFORM A1F_PURCHASE_DATA_CHECK .
ENDIF .

IF NOT ( A1F_WG_WARNING_CNT IS INITIAL ) .
CLEAR A1F_WL_TMP_TEXT .
CONCATENATE TEXT-124 A1F_WG_WARNING_CNT TEXT-125
INTO A1F_WL_TMP_TEXT .
CALL FUNCTION 'POPUP_CONTINUE_YES_NO'
EXPORTING
TEXTLINE1 = A1F_WL_TMP_TEXT
TEXTLINE2 = TEXT-126
TITEL     = TEXT-123
IMPORTING
ANSWER    = A1F_WL_ANSWER_02.
IF A1F_WL_ANSWER_02 NE 'J' .
EXIT .
ENDIF .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUSU = 0
AND /A1F/YLNS0011-YL_HTYUNSKBN = SPACE .
PERFORM A1F_SALES_DATA_EXEC .
ELSEIF /A1F/YLNS0011-YL_HTYUNSKBN NE SPACE .
PERFORM A1F_PURCHASE_DATA_EXEC .
ELSE .
PERFORM A1F_SALES_DATA_EXEC .
PERFORM A1F_PURCHASE_DATA_EXEC .
PERFORM A1F_SALES_DATA_CHANGE .
ENDIF .

ENDFORM.                    " a1f_check_and_save_data
*&---------------------------------------------------------------------*
*&      Form  a1f_Simulate_sales_order
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SIMULATE_SALES_ORDER .

CLEAR : A1F_WG_SOLD_TO_PARTY_SIM ,
A1F_WG_SHIP_TO_PARTY_SIM ,
A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM .
CLEAR : A1F_TG_ORDER_ITEMS_IN_SIM,
A1F_TG_ORDER_PARTNERS_SIM,
A1F_TG_ORDER_SCHEDULE_IN_SIM,
A1F_TG_ORDER_ITEMS_OUT_SIM,
A1F_TG_ORDER_SCHEDULE_EX_SIM,
A1F_TG_ORDER_CONDITION_EX_SIM,
A1F_TG_ORDER_INCOMPLETE_SIM,
A1F_TG_MESSAGETABLE_SIM,
A1F_TG_PARTNERADDRESSES_SIM.
REFRESH : A1F_TG_ORDER_ITEMS_IN_SIM,
A1F_TG_ORDER_PARTNERS_SIM,
A1F_TG_ORDER_SCHEDULE_IN_SIM,
A1F_TG_ORDER_ITEMS_OUT_SIM,
A1F_TG_ORDER_SCHEDULE_EX_SIM,
A1F_TG_ORDER_CONDITION_EX_SIM,
A1F_TG_ORDER_INCOMPLETE_SIM,
A1F_TG_MESSAGETABLE_SIM,
A1F_TG_PARTNERADDRESSES_SIM.

A1F_WG_ORDER_HEADER_IN_SIM-DOC_TYPE = /A1F/YLNS0011-YL_AUART .
A1F_WG_ORDER_HEADER_IN_SIM-REQ_DATE_H = /A1F/YLNS0011-YL_VDATU .
A1F_WG_ORDER_HEADER_IN_SIM-PURCH_NO = /A1F/YLNS0011-YL_BSTKD .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
*  A1F_WG_ORDER_HEADER_IN_SIM- = /A1F/YLNS0011-YL_AUDAT .

CLEAR A1F_TG_ORDER_PARTNERS_SIM .
REFRESH A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'AG' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'WE' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_SYKSKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .
A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = /A1F/YLNS0011-YL_JTYUSU.
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .

DATA : A1F_WL_TMP_VALUE LIKE BAPICURR-BAPICURR .
CLEAR : A1F_WL_TMP_VALUE .

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YLNS0011-YL_JTYTUK
AMOUNT_INTERNAL = /A1F/YLNS0011-YL_JTYUTNK
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
IF SY-SUBRC = 0 .
A1F_TG_ORDER_ITEMS_IN_SIM-COND_VALUE = A1F_WL_TMP_VALUE .
ELSE .
CLEAR A1F_TG_ORDER_ITEMS_IN_SIM-COND_VALUE .
ENDIF .

A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = /A1F/YLNS0011-YL_JTYUSU.
A1F_TG_ORDER_ITEMS_IN_SIM-COND_TYPE = A1F_CNS_KSCHL.
A1F_TG_ORDER_ITEMS_IN_SIM-COND_P_UNT = /A1F/YLNS0011-YL_KPEIN.
A1F_TG_ORDER_ITEMS_IN_SIM-COND_D_UNT = /A1F/YLNS0011-YL_VRKME.
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CALL FUNCTION 'BAPI_SALESORDER_SIMULATE'
EXPORTING
ORDER_HEADER_IN     = A1F_WG_ORDER_HEADER_IN_SIM
CONVERT_PARVW_AUART = 'X'
IMPORTING
SOLD_TO_PARTY       = A1F_WG_SOLD_TO_PARTY_SIM
SHIP_TO_PARTY       = A1F_WG_SHIP_TO_PARTY_SIM
BILLING_PARTY       = A1F_WG_BILLING_PARTY_SIM
RETURN              = A1F_WG_RETURN_SIM
TABLES
ORDER_ITEMS_IN      = A1F_TG_ORDER_ITEMS_IN_SIM
ORDER_PARTNERS      = A1F_TG_ORDER_PARTNERS_SIM
ORDER_SCHEDULE_IN   = A1F_TG_ORDER_SCHEDULE_IN_SIM
ORDER_ITEMS_OUT     = A1F_TG_ORDER_ITEMS_OUT_SIM
ORDER_SCHEDULE_EX   = A1F_TG_ORDER_SCHEDULE_EX_SIM
ORDER_CONDITION_EX  = A1F_TG_ORDER_CONDITION_EX_SIM
ORDER_INCOMPLETE    = A1F_TG_ORDER_INCOMPLETE_SIM
MESSAGETABLE        = A1F_TG_MESSAGETABLE_SIM
PARTNERADDRESSES    = A1F_TG_PARTNERADDRESSES_SIM.

DELETE ADJACENT DUPLICATES FROM A1F_TG_MESSAGETABLE_SIM
COMPARING TYPE NUMBER .

LOOP AT A1F_TG_MESSAGETABLE_SIM .
MESSAGE ID A1F_TG_MESSAGETABLE_SIM-ID
TYPE A1F_TG_MESSAGETABLE_SIM-TYPE
NUMBER A1F_TG_MESSAGETABLE_SIM-NUMBER
WITH A1F_TG_MESSAGETABLE_SIM-MESSAGE_V1
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V2
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V3
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V4 .
IF A1F_TG_MESSAGETABLE_SIM-TYPE = 'W' .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDLOOP .

ENDFORM.                    " a1f_Simulate_sales_order
*&---------------------------------------------------------------------*
*&      Form  a1f_Simulate_Purchase_order
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SIMULATE_PURCHASE_ORDER .

DATA : A1F_WL_TMP_VALUE LIKE BAPICURR-BAPICURR .

CLEAR : A1F_WG_POHEADER,
A1F_WG_EXPPURCHASEORDER,
A1F_WG_EXPHEADER,
A1F_TG_RETURN_PURC,
A1F_TG_POITEM,
A1F_TG_POITEMX,
A1F_TG_POSCHEDULE ,
A1F_TG_POSCHEDULEX ,
A1F_TG_POCOND,
A1F_TG_POCONDX.
*          A1F_TG_POTEXTHEADER.
REFRESH : A1F_TG_RETURN_PURC,
A1F_TG_POITEM,
A1F_TG_POITEMX,
A1F_TG_POSCHEDULE ,
A1F_TG_POSCHEDULEX ,
A1F_TG_POCOND,
A1F_TG_POCONDX.
*          A1F_TG_POTEXTHEADER.

A1F_WG_POHEADER-COMP_CODE = /A1F/YLNS0011-BUKRS .
A1F_WG_POHEADER-DOC_TYPE = A1F_CNS_DOC_TYPE .
A1F_WG_POHEADER-VENDOR = /A1F/YLNS0011-YL_SIRSKCD .
A1F_WG_POHEADER-PURCH_ORG = /A1F/YLNS0011-EKORG .
A1F_WG_POHEADER-PUR_GROUP = /A1F/YLNS0011-EKGRP .
A1F_WG_POHEADER-DOC_DATE = /A1F/YLNS0011-YL_BEDAT .
*  A1F_WG_POHEADER-SALES_PERS = /A1F/YLNS0011- .

A1F_WG_POHEADERX-COMP_CODE = 'X' .
A1F_WG_POHEADERX-DOC_TYPE = 'X' .
A1F_WG_POHEADERX-VENDOR = 'X' .
A1F_WG_POHEADERX-PURCH_ORG = 'X' .
A1F_WG_POHEADERX-PUR_GROUP = 'X' .
A1F_WG_POHEADERX-DOC_DATE = 'X' .
*  A1F_WG_POHEADERx-SALES_PERS = /A1F/YLNS0011- .
IF /A1F/YLNS0011-YL_MSYUFLG NE SPACE .
A1F_TG_POITEM-FREE_ITEM = 'X' .
A1F_TG_POITEMX-FREE_ITEM = 'X' .
ENDIF .

A1F_TG_POITEM-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TG_POITEM-SHORT_TEXT = /A1F/YLNS0011-YL_MAKTX_PURC .
A1F_TG_POITEM-MATERIAL = /A1F/YLNS0011-YL_MATNR_PURC .
A1F_TG_POITEM-PLANT = /A1F/YLNS0011-YL_DWERK .
A1F_TG_POITEM-VEND_MAT = /A1F/YLNS0011-YL_IDNLF .
A1F_TG_POITEM-QUANTITY = /A1F/YLNS0011-YL_HTYUSU .
A1F_TG_POITEM-PO_UNIT = /A1F/YLNS0011-YL_BSTME .
A1F_TG_POITEM-SHIPPING = /A1F/YLNS0011-YL_TYKSUKBN .
APPEND A1F_TG_POITEM .
A1F_TG_POITEMX-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TG_POITEMX-SHORT_TEXT = 'X' .
A1F_TG_POITEMX-MATERIAL = 'X' .
A1F_TG_POITEMX-PLANT = 'X' .
A1F_TG_POITEMX-VEND_MAT = 'X' .
A1F_TG_POITEMX-QUANTITY = 'X' .
A1F_TG_POITEMX-PO_UNIT = 'X' .
A1F_TG_POITEMX-SHIPPING = 'X' .
APPEND A1F_TG_POITEMX .

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YLNS0011-YL_HTYUTUK
AMOUNT_INTERNAL = /A1F/YLNS0011-YL_HTYUTNK
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
IF SY-SUBRC = 0 .
A1F_TG_POCOND-COND_VALUE = A1F_WL_TMP_VALUE .
ELSE .
CLEAR A1F_TG_POCOND-COND_VALUE .
ENDIF .
A1F_TG_POCOND-ITM_NUMBER = A1F_CNS_NUMBER_P .
A1F_TG_POCOND-COND_ST_NO = '001' .
A1F_TG_POCOND-COND_COUNT = '01' .
A1F_TG_POCOND-COND_TYPE = A1F_CNS_KSCHL_P .
A1F_TG_POCOND-CURRENCY = /A1F/YLNS0011-YL_HTYUTUK .
A1F_TG_POCOND-COND_P_UNT = /A1F/YLNS0011-YL_PEINH .
IF A1F_TG_INFORECORD_PURCHORG-INFO_REC IS INITIAL .
A1F_TG_POCOND-CHANGE_ID = 'U' .
ELSE .
A1F_TG_POCOND-CHANGE_ID = 'U' .
ENDIF .
APPEND A1F_TG_POCOND .

A1F_TG_POCONDX-ITM_NUMBER = A1F_CNS_NUMBER_P .
A1F_TG_POCONDX-COND_ST_NO = '001' .
A1F_TG_POCONDX-ITM_NUMBERX = 'X'.
A1F_TG_POCONDX-COND_ST_NOX = 'X' .
A1F_TG_POCONDX-COND_COUNT = 'X' .
A1F_TG_POCONDX-COND_TYPE = 'X' .
A1F_TG_POCONDX-COND_VALUE = 'X' .
A1F_TG_POCONDX-CURRENCY = 'X' .
A1F_TG_POCONDX-COND_P_UNT = 'X' .
A1F_TG_POCONDX-CHANGE_ID = 'X' .
APPEND A1F_TG_POCONDX .

A1F_TG_POSCHEDULE-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TG_POSCHEDULE-DELIVERY_DATE = /A1F/YLNS0011-YL_EEIND .
A1F_TG_POSCHEDULE-QUANTITY = /A1F/YLNS0011-YL_HTYUSU .
APPEND A1F_TG_POSCHEDULE .
A1F_TG_POSCHEDULEX-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TG_POSCHEDULEX-DELIVERY_DATE = 'X' .
A1F_TG_POSCHEDULEX-QUANTITY = 'X' .
APPEND A1F_TG_POSCHEDULEX .

*  A1F_TG_POTEXTHEADER-TEXT_ID = A1F_CNS_TDID_P01 .
*  A1F_TG_POTEXTHEADER-TEXT_LINE = /A1F/YLNS0011-YL_EDIBKU .
*  APPEND A1F_TG_POTEXTHEADER .
*  A1F_TG_POTEXTHEADER-TEXT_ID = A1F_CNS_TDID_P02 .
*  A1F_TG_POTEXTHEADER-TEXT_LINE = /A1F/YLNS0011-YL_EDISNT .
*  APPEND A1F_TG_POTEXTHEADER .
*  A1F_TG_POTEXTHEADER-TEXT_ID = A1F_CNS_TDID_P03 .
*  A1F_TG_POTEXTHEADER-TEXT_LINE = /A1F/YLNS0011-YL_TUMNSYBKU .
*  APPEND A1F_TG_POTEXTHEADER .
*  A1F_TG_POTEXTHEADER-TEXT_ID = A1F_CNS_TDID_P04 .
*  A1F_TG_POTEXTHEADER-TEXT_LINE = /A1F/YLNS0011-YL_SMDNEDIBKU .
*  APPEND A1F_TG_POTEXTHEADER .
*  A1F_TG_POTEXTHEADER-TEXT_ID = A1F_CNS_TDID_P05 .
*  A1F_TG_POTEXTHEADER-TEXT_LINE = /A1F/YLNS0011-YL_HTYUZNITRNBKU .
*  APPEND A1F_TG_POTEXTHEADER .

CALL FUNCTION 'BAPI_PO_CREATE1'
EXPORTING
POHEADER         = A1F_WG_POHEADER
POHEADERX        = A1F_WG_POHEADERX
TESTRUN          = 'X'
IMPORTING
EXPPURCHASEORDER = A1F_WG_EXPPURCHASEORDER
EXPHEADER        = A1F_WG_EXPHEADER
TABLES
RETURN           = A1F_TG_RETURN_PURC
POITEM           = A1F_TG_POITEM
POITEMX          = A1F_TG_POITEMX
POSCHEDULE       = A1F_TG_POSCHEDULE
POSCHEDULEX      = A1F_TG_POSCHEDULEX
POCOND           = A1F_TG_POCOND
POCONDX          = A1F_TG_POCONDX.
*            POTEXTHEADER     = A1F_TG_POTEXTHEADER.

LOOP AT A1F_TG_RETURN_PURC
WHERE NOT ( NUMBER IS INITIAL ) .
MESSAGE ID A1F_TG_RETURN_PURC-ID
TYPE A1F_TG_RETURN_PURC-TYPE
NUMBER A1F_TG_RETURN_PURC-NUMBER
WITH A1F_TG_RETURN_PURC-MESSAGE_V1
A1F_TG_RETURN_PURC-MESSAGE_V2
A1F_TG_RETURN_PURC-MESSAGE_V3
A1F_TG_RETURN_PURC-MESSAGE_V4 .
IF A1F_TG_RETURN_PURC-TYPE = 'W' .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDLOOP .


ENDFORM.                    " a1f_Simulate_Purchase_order
*&---------------------------------------------------------------------*
*&      Form  a1f_sales_data_check
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_CHECK .

DATA : A1F_WL_TMP_MENGE LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_ARARI LIKE /A1F/YLNS0011-YL_JYYUKNGK .
DATA : A1F_WL_TMP_KNGK LIKE /A1F/YLNS0011-YL_JYYUKNGK .
DATA : A1F_WL_TMP_MENGE2 LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_MENGE3 LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_SAI_HI TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_SAI_LO TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_JTYTNK_MS LIKE /A1F/YLNS0011-YL_JTYUTNK .
DATA : A1F_WL_TMP_JTYTNK_HI LIKE /A1F/YLNS0011-YL_JTYUTNK2.
DATA : A1F_WL_TMP_JTYTNK_LO LIKE /A1F/YLNS0011-YL_JTYUTNK .

DATA : A1F_WL_OUTPUT_ARARI(11) .

* 与信チェック
*  IF NOT ( /A1F/YLNS0011-YL_YSNGK IS INITIAL ) .
IF /A1F/YLNS0011-YL_YSNZNDK < /A1F/YLNS0011-YL_JYYUKNGK .
MESSAGE E215(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_YSNZNDK
/A1F/YLNS0011-YL_JYYUKNGK .
ENDIF .
*  ENDIF .

* 得意先品目コードが空白の場合（得意先と品目で得意先品目マスタが
* 登録されていない場合、受注不可の為エラーとする
IF /A1F/YLNS0011-YL_KDMAT IS INITIAL .
MESSAGE E218(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_TKISKCD .
ENDIF .

* 得意先発注番号       /A1F/YLNS0011-YL_BSTKD,
IF /A1F/YLNS0011-YL_BSTKD IS INITIAL .
MESSAGE E166(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 得意先品目テキストが空白の場合、品目マスタのテキストをコピー
IF /A1F/YLNS0011-YL_POSTX IS INITIAL .
/A1F/YLNS0011-YL_POSTX = /A1F/YLNS0011-YL_MAKTX_SALE .
ENDIF .

* 得意先品目テキスト         /A1F/YLNS0011-YL_POSTX,
IF NOT ( /A1F/YLNS0011-YL_KDMAT IS INITIAL )
AND /A1F/YLNS0011-YL_POSTX IS INITIAL .
MESSAGE E167(/A1F/YLMS0100) .
ENDIF .

* 受注日付         /A1F/YLNS0011-YL_AUDAT,
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
MESSAGE E168(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_AUDAT < SY-DATUM .
MESSAGE W169(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ELSEIF /A1F/YLNS0011-YL_AUDAT > SY-DATUM .
MESSAGE W170(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 販売品目テキスト         /A1F/YLNS0011-YL_MAKTX_SALE,
IF /A1F/YLNS0011-YL_MAKTX_SALE IS INITIAL .
MESSAGE E174(/A1F/YLMS0100) .
ENDIF .

* 受注数量       /A1F/YLNS0011-YL_JTYUSU,
IF /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
MESSAGE E175(/A1F/YLMS0100) .
ENDIF .

* 指定出荷日付       /A1F/YLNS0011-YL_VDATU,
IF /A1F/YLNS0011-YL_VDATU IS INITIAL .
MESSAGE E171(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_VDATU < SY-DATUM .
MESSAGE W172(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 出荷先コード       /A1F/YLNS0011-YL_SYKSKCD,
IF /A1F/YLNS0011-YL_SYKSKCD IS INITIAL .
MESSAGE E176(/A1F/YLMS0100) .
ENDIF .

* 価格単位数量        /A1F/YLNS0011-YL_KPEIN,
IF /A1F/YLNS0011-YL_KPEIN IS INITIAL .
MESSAGE E177(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_KPEIN NE 100
AND /A1F/YLNS0011-YL_KPEIN NE 1000
AND /A1F/YLNS0011-YL_KPEIN NE 10000
AND /A1F/YLNS0011-YL_KPEIN NE 1 .
MESSAGE E178(/A1F/YLMS0100) .
ENDIF .

* 受注単価       /A1F/YLNS0011-YL_JTYUTNK,
** 2007/07/21 DELETE START
** 売価０円対応
** 売価が０円でも受注登録を可能とする
*  IF /A1F/YLNS0011-YL_JTYUTNK IS INITIAL .
*    MESSAGE E179(/A1F/YLMS0100) .
*  ENDIF .
** 2007/07/21 DELETE END
** 2007/07/21 INSERT START
** 売価０円対応
** 売価が０円でも受注登録を可能とする
IF NOT ( /A1F/YLNS0011-YL_JTYUTNK IS INITIAL ) .
** 2007/07/21 INSERT END
A1F_WL_TMP_SAI_HI = /A1F/YLNS0011-YL_PROZ1_SALE .
A1F_WL_TMP_SAI_LO = /A1F/YLNS0011-YL_PROZ2_SALE .
A1F_WL_TMP_JTYTNK_HI =   A1F_WG_MASTER_TANKA_SALE
+ ( A1F_WG_MASTER_TANKA_SALE
* ( A1F_WL_TMP_SAI_HI / 100 ) ) .
A1F_WL_TMP_JTYTNK_LO = A1F_WG_MASTER_TANKA_SALE
- ( A1F_WG_MASTER_TANKA_SALE
* ( A1F_WL_TMP_SAI_LO / 100 ) ) .
IF NOT ( A1F_WG_MASTER_TANKA_SALE IS INITIAL ) .
IF /A1F/YLNS0011-YL_JTYUTNK BETWEEN A1F_WL_TMP_JTYTNK_LO
AND A1F_WL_TMP_JTYTNK_HI.
ELSE.
MESSAGE E205(/A1F/YLMS0100) WITH A1F_WG_MASTER_TANKA_SALE
/A1F/YLNS0011-YL_JTYUTNK.
ENDIF .
ENDIF .


* 粗利        /A1F/YLNS0011-YL_ARARI,
IF /A1F/YLNS0011-YL_ARARI <= 0 .
WRITE /A1F/YLNS0011-YL_ARARI
CURRENCY /A1F/YLNS0011-YL_JTYTUK
TO A1F_WL_OUTPUT_ARARI .
MESSAGE W180(/A1F/YLMS0100) WITH A1F_WL_OUTPUT_ARARI.
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

** 2007/07/21 INSERT START
** 売価０円対応
** 売価が０円でも受注登録を可能とする
ENDIF .
** 2007/07/21 INSERT END

* 受注数量と発注数量のチェック
IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110
AND /A1F/YLNS0011-YL_HTYUSU_C NE /A1F/YLNS0011-YL_JTYUSU_C .
MESSAGE E191(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
A1F_WL_TMP_MENGE = /A1F/YLNS0011-YL_HTYUSU_C
+ /A1F/YLNS0011-YL_MHKATZIK .
IF /A1F/YLNS0011-YL_JTYUSU_C > A1F_WL_TMP_MENGE .
MESSAGE W192(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

DATA : A1F_WL_EXCH_RATE LIKE BAPI1093_0 ,
A1F_WL_RETURN_EXCH LIKE BAPIRET1 .
* 換算レートの取得
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
IF /A1F/YLNS0011-YL_HTYUTUK NE /A1F/YLNS0011-YL_WAERS .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_HTYUTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
IF SY-SUBRC NE 0
OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
MESSAGE E160(/A1F/YLMS0100) WITH
A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_JTYTUK
/A1F/YLNS0011-YL_WAERS.
ENDIF .
ELSE .
A1F_WL_EXCH_RATE-EXCH_RATE = 1 .
ENDIF .

* 発注金額        /A1F/YLNS0011-YL_HTYUKNGK,
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- /A1F/YLNS0011-YL_HTYUKNGK_C .
IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110
AND A1F_WL_TMP_ARARI <= 0 .
WRITE A1F_WL_TMP_ARARI
CURRENCY /A1F/YLNS0011-YL_WAERS
TO A1F_WL_OUTPUT_ARARI .
MESSAGE W196(/A1F/YLMS0100) WITH A1F_WL_OUTPUT_ARARI .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 .
IF /A1F/YLNS0011-YL_JTYUSU <= /A1F/YLNS0011-YL_MHKATZIK.
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_ARARI .
ELSE .
A1F_WL_TMP_MENGE2 = /A1F/YLNS0011-YL_HTYUSU
+ /A1F/YLNS0011-YL_MHKATZIK .
IF /A1F/YLNS0011-YL_JTYUSU > A1F_WL_TMP_MENGE2 .
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- ( ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
* /A1F/YLNS0011-YL_MHKATZIK )
- /A1F/YLNS0011-YL_HTYUKNGK_C .
ELSE .
A1F_WL_TMP_MENGE3 = /A1F/YLNS0011-YL_JTYUSU
- /A1F/YLNS0011-YL_MHKATZIK .
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- ( ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
* /A1F/YLNS0011-YL_MHKATZIK )
- ( ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* A1F_WL_TMP_MENGE3 ) *
A1F_WL_EXCH_RATE-EXCH_RATE ).
ENDIF .
ENDIF.
IF  A1F_WL_TMP_ARARI <= 0 .
WRITE A1F_WL_TMP_ARARI
CURRENCY /A1F/YLNS0011-YL_WAERS
TO A1F_WL_OUTPUT_ARARI .
MESSAGE W197(/A1F/YLMS0100) WITH A1F_WL_OUTPUT_ARARI .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDIF .

* 受注伝票登録のシュミレーション
PERFORM A1F_SIMULATE_SALES_ORDER .


ENDFORM.                    " a1f_sales_data_check
*&---------------------------------------------------------------------*
*&      Form  a1f_PURCHASE_data_check
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_PURCHASE_DATA_CHECK .

DATA : A1F_WL_TMP_MENGE LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_SAI_HI TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_SAI_LO TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_HTYTNK_MS LIKE /A1F/YLNS0011-YL_HTYUTNK .
DATA : A1F_WL_TMP_HTYTNK_HI LIKE /A1F/YLNS0011-YL_HTYUTNK .
DATA : A1F_WL_TMP_HTYTNK_LO LIKE /A1F/YLNS0011-YL_HTYUTNK .

* 購買グループ
IF /A1F/YLNS0011-EKGRP IS INITIAL .
MESSAGE E208(/A1F/YLMS0100) .
ENDIF .

* 仕入先コード        /A1F/YLNS0011-YL_SIRSKCD,
IF /A1F/YLNS0011-YL_SIRSKCD IS INITIAL .
MESSAGE E181(/A1F/YLMS0100) .
ENDIF .

* 発注日付        /A1F/YLNS0011-YL_BEDAT,
IF /A1F/YLNS0011-YL_BEDAT IS INITIAL .
MESSAGE E182(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_BEDAT < SY-DATUM .
MESSAGE W183(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ELSEIF /A1F/YLNS0011-YL_BEDAT > SY-DATUM .
MESSAGE W184(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 納入日付        /A1F/YLNS0011-YL_EEIND,
IF /A1F/YLNS0011-YL_EEIND IS INITIAL .
MESSAGE E185(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_EEIND < SY-DATUM .
MESSAGE W186(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
*  ELSEIF /A1F/YLNS0011-YL_EEIND > SY-DATUM .
*    MESSAGE W187(/A1F/YLMS0100) .
ENDIF .

* 発注品目テキスト        /A1F/YLNS0011-YL_MAKTX_PURC,
IF /A1F/YLNS0011-YL_MAKTX_PURC IS INITIAL .
MESSAGE E188(/A1F/YLMS0100) .
ENDIF .

* 直送区分        /A1F/YLNS0011-YL_YL_TYKSUKBN,
DATA : A1F_WL_ADDR_SUBRC LIKE SY-SUBRC .
PERFORM A1F_EXIT_GET_ADDR_CHECK USING A1F_WL_ADDR_SUBRC .
IF A1F_WL_ADDR_SUBRC = 0 .
IF NOT ( /A1F/YLNS0011-YL_TYKSUKBN IS INITIAL ) .
MESSAGE W222(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDIF .

* 発注品目コード        /A1F/YLNS0011-YL_IDNLF,
** 2007/07/21 INSERT START
** 仕入先品目コードのエラーチェック
** EDI仕入先以外の場合仕入先品目コードのチェックは行わない
DATA : A1F_WL_ADDR_SUBRC2 LIKE SY-SUBRC .
PERFORM A1F_EXIT_GET_ADDR_CHECK USING A1F_WL_ADDR_SUBRC2 .
IF A1F_WL_ADDR_SUBRC2 = 9 .
** 2007/07/21 INSERT END
IF /A1F/YLNS0011-YL_IDNLF IS INITIAL .
MESSAGE W189(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
** 2007/07/21 INSERT START
** 仕入先品目コードのエラーチェック
ENDIF .
** 2007/07/21 INSERT END

* 発注数量        /A1F/YLNS0011-YL_HTYUSU,
IF /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
MESSAGE E190(/A1F/YLMS0100) .
ENDIF .

* 発注単価        /A1F/YLNS0011-YL_HTYUTNK,
DATA : A1F_LW_HATYUTNK LIKE /A1F/YLNS0011-YL_HTYUTNK.
CLEAR A1F_LW_HATYUTNK.

IF /A1F/YLNS0011-YL_MSYUFLG = SPACE .
IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
MESSAGE E193(/A1F/YLMS0100) .
ENDIF .
A1F_WL_TMP_SAI_HI = /A1F/YLNS0011-YL_PROZ1_PURC .
A1F_WL_TMP_SAI_LO = /A1F/YLNS0011-YL_PROZ2_PURC .
A1F_WL_TMP_HTYTNK_HI =   A1F_WG_MASTER_TANKA_PURC
+ ( A1F_WG_MASTER_TANKA_PURC
* ( A1F_WL_TMP_SAI_HI / 100 ) ) .
A1F_WL_TMP_HTYTNK_LO = A1F_WG_MASTER_TANKA_PURC
- ( A1F_WG_MASTER_TANKA_PURC
* ( A1F_WL_TMP_SAI_LO / 100 ) ) .
IF NOT ( A1F_WG_MASTER_TANKA_PURC IS INITIAL ) .

*2009/10/14 発注単価チェック方法変更
A1F_LW_HATYUTNK = /A1F/YLNS0011-YL_HTYUTNK
/ /A1F/YLNS0011-YL_PEINH.
IF A1F_LW_HATYUTNK BETWEEN A1F_WL_TMP_HTYTNK_LO
AND A1F_WL_TMP_HTYTNK_HI.

*      IF /A1F/YLNS0011-YL_HTYUTNK BETWEEN A1F_WL_TMP_HTYTNK_LO
*                                          AND A1F_WL_TMP_HTYTNK_HI.
ELSE.
MESSAGE E206(/A1F/YLMS0100) WITH A1F_WG_MASTER_TANKA_PURC
/A1F/YLNS0011-YL_HTYUTNK.
ENDIF .
ENDIF .
ENDIF .

* 価格単位数量        /A1F/YLNS0011-YL_PEINH,
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
MESSAGE E194(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_PEINH NE 100
AND /A1F/YLNS0011-YL_PEINH NE 1000
AND /A1F/YLNS0011-YL_PEINH NE 10000
AND /A1F/YLNS0011-YL_PEINH NE 1 .
MESSAGE E195(/A1F/YLMS0100) .
ENDIF .

* EDI備考の未表示データのチェック
DATA : A1F_TG_LINES_YL_EDIBKU_LINE LIKE SY-TABIX .
CLEAR A1F_TG_LINES_YL_EDIBKU_LINE .
DESCRIBE TABLE A1F_TG_LINES_YL_EDIBKU
LINES A1F_TG_LINES_YL_EDIBKU_LINE .
IF A1F_TG_LINES_YL_EDIBKU_LINE > 2 .
MESSAGE W219(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 注文書備考の未表示データのチェック
DATA : A1F_TG_LINES_YL_TUMNSYBKU_LINE LIKE SY-TABIX .
CLEAR A1F_TG_LINES_YL_TUMNSYBKU_LINE .
DESCRIBE TABLE A1F_TG_LINES_YL_TUMNSYBKU
LINES A1F_TG_LINES_YL_TUMNSYBKU_LINE .
IF A1F_TG_LINES_YL_TUMNSYBKU_LINE > 1 .
MESSAGE W220(/A1F/YLMS0100) .
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .


* 発注伝票登録のシュミレーション
PERFORM A1F_SIMULATE_PURCHASE_ORDER .



ENDFORM.                    " a1f_PURCHASE_data_check
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_DATA_EXEC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_EXEC .

DATA : A1F_WL_TMP_VALUE LIKE BAPICURR-BAPICURR .
CLEAR : A1F_WL_TMP_VALUE .

DATA : A1F_WL_ORDER_HEADER_IN  LIKE BAPISDHD1 ,
A1F_WL_ORDER_HEADER_INX LIKE BAPISDHD1X ,
A1F_WL_SALESDOCUMENT LIKE BAPIVBELN-VBELN.

DATA : A1F_TL_RETURN_SALE         LIKE TABLE OF BAPIRET2 WITH HEADER
LINE ,
A1F_TL_ORDER_ITEMS_IN      LIKE TABLE OF BAPISDITM WITH HEADER
LINE ,
A1F_TL_ORDER_ITEMS_INX     LIKE TABLE OF BAPISDITMX WITH HEADER
LINE ,
A1F_TL_ORDER_PARTNERS      LIKE TABLE OF BAPIPARNR WITH HEADER
LINE ,
A1F_TL_PARTNERADDRESSES    LIKE TABLE OF BAPIADDR1 WITH HEADER
LINE ,
A1F_TL_ORDER_SCHEDULES_IN  LIKE TABLE OF BAPISCHDL WITH HEADER
LINE ,
A1F_TL_ORDER_SCHEDULES_INX LIKE TABLE OF BAPISCHDLX WITH HEADER
LINE ,
A1F_TL_ORDER_CONDITIONS_IN LIKE TABLE OF BAPICOND WITH HEADER
LINE ,
A1F_TL_CONDITIONS_INX      LIKE TABLE OF BAPICONDX WITH HEADER
LINE ,
A1F_TL_ORDER_TEXT          LIKE TABLE OF BAPISDTEXT WITH HEADER
LINE .

CLEAR  : A1F_WL_ORDER_HEADER_IN   ,
A1F_WL_ORDER_HEADER_INX  ,
A1F_WL_SALESDOCUMENT ,
A1F_TL_RETURN_SALE          ,
A1F_TL_ORDER_ITEMS_IN       ,
A1F_TL_ORDER_ITEMS_INX      ,
A1F_TL_ORDER_PARTNERS       ,
A1F_TL_PARTNERADDRESSES     ,
A1F_TL_ORDER_SCHEDULES_IN   ,
A1F_TL_ORDER_SCHEDULES_INX  ,
A1F_TL_ORDER_CONDITIONS_IN  ,
A1F_TL_CONDITIONS_INX       ,
A1F_TL_ORDER_TEXT           .

REFRESH : A1F_TL_RETURN_SALE       ,
A1F_TL_ORDER_ITEMS_IN       ,
A1F_TL_ORDER_ITEMS_INX      ,
A1F_TL_ORDER_PARTNERS       ,
A1F_TL_PARTNERADDRESSES     ,
A1F_TL_ORDER_SCHEDULES_IN   ,
A1F_TL_ORDER_SCHEDULES_INX  ,
A1F_TL_ORDER_CONDITIONS_IN  ,
A1F_TL_CONDITIONS_INX       ,
A1F_TL_ORDER_TEXT           .

A1F_WL_ORDER_HEADER_IN-DOC_TYPE   = /A1F/YLNS0011-YL_AUART .
A1F_WL_ORDER_HEADER_IN-SALES_ORG  = /A1F/YLNS0011-VKORG .
A1F_WL_ORDER_HEADER_IN-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
A1F_WL_ORDER_HEADER_IN-DIVISION   = /A1F/YLNS0011-SPART .
A1F_WL_ORDER_HEADER_IN-SALES_GRP  = /A1F/YLNS0011-VKGRP .
A1F_WL_ORDER_HEADER_IN-SALES_OFF  = /A1F/YLNS0011-VKBUR .
A1F_WL_ORDER_HEADER_IN-REQ_DATE_H = /A1F/YLNS0011-YL_VDATU .
A1F_WL_ORDER_HEADER_IN-PURCH_NO_C = /A1F/YLNS0011-YL_BSTKD .
A1F_WL_ORDER_HEADER_IN-DOC_DATE   = /A1F/YLNS0011-YL_AUDAT .
A1F_WL_ORDER_HEADER_IN-DLV_BLOCK  = /A1F/YLNS0011-YL_LIFSK .
A1F_WL_ORDER_HEADER_IN-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
** 2007/07/21 INSERT START
** 得意先発注日付の追加
A1F_WL_ORDER_HEADER_IN-PURCH_DATE = /A1F/YLNS0011-YL_TKISKHCDT .
** 2007/07/21 INSERT END


A1F_WL_ORDER_HEADER_INX-DOC_TYPE   = 'X' .
A1F_WL_ORDER_HEADER_INX-SALES_ORG  = 'X' .
A1F_WL_ORDER_HEADER_INX-DISTR_CHAN = 'X' .
A1F_WL_ORDER_HEADER_INX-DIVISION   = 'X' .
A1F_WL_ORDER_HEADER_INX-SALES_GRP  = 'X' .
A1F_WL_ORDER_HEADER_INX-SALES_OFF  = 'X' .
A1F_WL_ORDER_HEADER_INX-REQ_DATE_H = 'X' .
A1F_WL_ORDER_HEADER_INX-PURCH_NO_C = 'X' .
A1F_WL_ORDER_HEADER_INX-DOC_DATE   = 'X' .
A1F_WL_ORDER_HEADER_INX-DLV_BLOCK  = 'X' .
A1F_WL_ORDER_HEADER_INX-PRICE_DATE = 'X' .
** 2007/07/21 INSERT START
** 得意先発注日付の追加
A1F_WL_ORDER_HEADER_INX-PURCH_DATE = 'X' .
** 2007/07/21 INSERT END

A1F_TL_ORDER_PARTNERS-PARTN_ROLE = 'AG' .
A1F_TL_ORDER_PARTNERS-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TL_ORDER_PARTNERS .
A1F_TL_ORDER_PARTNERS-PARTN_ROLE = 'WE' .
A1F_TL_ORDER_PARTNERS-PARTN_NUMB = /A1F/YLNS0011-YL_SYKSKCD .
** 2007/07/20 INSERT START
** 出荷先住所変更対応
** 2007/09/10 INSERT START
** 出荷先住所変更対応 不具合対応
IF NOT ( A1F_WG_ADDR1_OUT-NAME1 IS INITIAL ) .
** 2007/09/10 INSERT END
A1F_TL_ORDER_PARTNERS-TELEPHONE2 = A1F_WG_FES_VBADR-TELF2 .
A1F_TL_ORDER_PARTNERS-TELEBOX = A1F_WG_FES_VBADR-TELBX .
A1F_TL_ORDER_PARTNERS-TELETEX_NO = A1F_WG_FES_VBADR-TELTX .
A1F_TL_ORDER_PARTNERS-TELEX_NO = A1F_WG_FES_VBADR-TELX1 .
A1F_TL_ORDER_PARTNERS-ADDR_TYPE = A1F_WG_FES_VBADR-ADDRESS_TYPE .
A1F_TL_ORDER_PARTNERS-UNLOAD_PT = A1F_WG_FEF_ATTRIBUTES-ABLAD .
A1F_TL_ORDER_PARTNERS-ADDR_LINK = '9990000001' .
** 2007/09/10 INSERT START
** 出荷先住所変更対応 不具合対応
ENDIF .
** 2007/09/10 INSERT END
** 2007/07/20 INSERT END
APPEND A1F_TL_ORDER_PARTNERS .

** 2007/07/20 INSERT START
** 出荷先住所変更対応
** 2007/09/10 INSERT START
** 出荷先住所変更対応 不具合対応
IF NOT ( A1F_WG_ADDR1_OUT-NAME1 IS INITIAL ) .
** 2007/09/10 INSERT END
A1F_TL_PARTNERADDRESSES-ADDR_NO = '9990000001' .
A1F_TL_PARTNERADDRESSES-TITLE = A1F_WG_ADDR1_OUT-TITLE .
A1F_TL_PARTNERADDRESSES-NAME = A1F_WG_ADDR1_OUT-NAME1 .
A1F_TL_PARTNERADDRESSES-NAME_2 = A1F_WG_ADDR1_OUT-NAME2 .
A1F_TL_PARTNERADDRESSES-NAME_3 = A1F_WG_ADDR1_OUT-NAME3 .
A1F_TL_PARTNERADDRESSES-NAME_4 = A1F_WG_ADDR1_OUT-NAME4 .
A1F_TL_PARTNERADDRESSES-C_O_NAME = A1F_WG_ADDR1_OUT-NAME_CO .
A1F_TL_PARTNERADDRESSES-CITY = A1F_WG_ADDR1_OUT-CITY1 .
A1F_TL_PARTNERADDRESSES-DISTRICT = A1F_WG_ADDR1_OUT-CITY2 .
A1F_TL_PARTNERADDRESSES-CITY_NO = A1F_WG_ADDR1_OUT-CITY_CODE .
A1F_TL_PARTNERADDRESSES-DISTRCT_NO = A1F_WG_ADDR1_OUT-CITYP_CODE .
A1F_TL_PARTNERADDRESSES-CHCKSTATUS = A1F_WG_ADDR1_OUT-CHCKSTATUS .
A1F_TL_PARTNERADDRESSES-REGIOGROUP = A1F_WG_ADDR1_OUT-REGIOGROUP .
A1F_TL_PARTNERADDRESSES-POSTL_COD1 = A1F_WG_ADDR1_OUT-POST_CODE1 .
A1F_TL_PARTNERADDRESSES-POSTL_COD2 = A1F_WG_ADDR1_OUT-POST_CODE2 .
A1F_TL_PARTNERADDRESSES-POSTL_COD3 = A1F_WG_ADDR1_OUT-POST_CODE3 .
A1F_TL_PARTNERADDRESSES-PO_BOX = A1F_WG_ADDR1_OUT-PO_BOX .
A1F_TL_PARTNERADDRESSES-PO_BOX_CIT = A1F_WG_ADDR1_OUT-PO_BOX_LOC .
A1F_TL_PARTNERADDRESSES-PBOXCIT_NO = A1F_WG_ADDR1_OUT-CITY_CODE2 .
A1F_TL_PARTNERADDRESSES-DELIV_DIS = A1F_WG_ADDR1_OUT-POSTALAREA .
A1F_TL_PARTNERADDRESSES-TRANSPZONE = A1F_WG_ADDR1_OUT-TRANSPZONE .
A1F_TL_PARTNERADDRESSES-STREET = A1F_WG_ADDR1_OUT-STREET .
A1F_TL_PARTNERADDRESSES-STREET_LNG = A1F_WG_ADDR1_OUT-STREET .
A1F_TL_PARTNERADDRESSES-STREET_NO = A1F_WG_ADDR1_OUT-STREETCODE .
A1F_TL_PARTNERADDRESSES-STR_ABBR = A1F_WG_ADDR1_OUT-STREETABBR .
A1F_TL_PARTNERADDRESSES-HOUSE_NO = A1F_WG_ADDR1_OUT-HOUSE_NUM1 .
A1F_TL_PARTNERADDRESSES-HOUSE_NO2 = A1F_WG_ADDR1_OUT-HOUSE_NUM2 .
A1F_TL_PARTNERADDRESSES-STR_SUPPL1 = A1F_WG_ADDR1_OUT-STR_SUPPL1 .
A1F_TL_PARTNERADDRESSES-STR_SUPPL2 = A1F_WG_ADDR1_OUT-STR_SUPPL2 .
A1F_TL_PARTNERADDRESSES-STR_SUPPL3 = A1F_WG_ADDR1_OUT-STR_SUPPL3 .
A1F_TL_PARTNERADDRESSES-LOCATION = A1F_WG_ADDR1_OUT-LOCATION .
A1F_TL_PARTNERADDRESSES-BUILDING = A1F_WG_ADDR1_OUT-BUILDING .
A1F_TL_PARTNERADDRESSES-BUILD_LONG = A1F_WG_ADDR1_OUT-BUILDING .
A1F_TL_PARTNERADDRESSES-FLOOR = A1F_WG_ADDR1_OUT-FLOOR .
A1F_TL_PARTNERADDRESSES-ROOM_NO = A1F_WG_ADDR1_OUT-ROOMNUMBER .
A1F_TL_PARTNERADDRESSES-COUNTRY = A1F_WG_ADDR1_OUT-COUNTRY .
A1F_TL_PARTNERADDRESSES-LANGU = A1F_WG_ADDR1_OUT-LANGU .
A1F_TL_PARTNERADDRESSES-REGION = A1F_WG_ADDR1_OUT-REGION .
A1F_TL_PARTNERADDRESSES-SORT1 = A1F_WG_ADDR1_OUT-SORT1 .
A1F_TL_PARTNERADDRESSES-SORT2 = A1F_WG_ADDR1_OUT-SORT2 .
A1F_TL_PARTNERADDRESSES-TIME_ZONE = A1F_WG_ADDR1_OUT-TIME_ZONE .
A1F_TL_PARTNERADDRESSES-TAXJURCODE = A1F_WG_ADDR1_OUT-TAXJURCODE .
A1F_TL_PARTNERADDRESSES-ADR_NOTES = A1F_WG_ADDR1_OUT-REMARK .
A1F_TL_PARTNERADDRESSES-COMM_TYPE = A1F_WG_ADDR1_OUT-DEFLT_COMM .

DATA A1F_WL_ADTEL TYPE SZADR_ADTEL_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADTEL_TAB INDEX 1
INTO A1F_WL_ADTEL.
A1F_TL_PARTNERADDRESSES-TEL1_NUMBR =
A1F_WL_ADTEL-ADTEL-TEL_NUMBER .
A1F_TL_PARTNERADDRESSES-TEL1_EXT =
A1F_WL_ADTEL-ADTEL-TEL_EXTENS .

DATA A1F_WL_ADFAX TYPE SZADR_ADFAX_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADFAX_TAB INDEX 1
INTO A1F_WL_ADFAX.
A1F_TL_PARTNERADDRESSES-FAX_NUMBER =
A1F_WL_ADFAX-ADFAX-FAX_NUMBER .
A1F_TL_PARTNERADDRESSES-FAX_EXTENS =
A1F_WL_ADFAX-ADFAX-FAX_EXTENS .

DATA A1F_WL_ADSMTP TYPE SZADR_ADSMTP_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADSMTP_TAB INDEX 1
INTO A1F_WL_ADSMTP.

A1F_TL_PARTNERADDRESSES-E_MAIL =
A1F_WL_ADSMTP-ADSMTP-SMTP_ADDR.

APPEND A1F_TL_PARTNERADDRESSES .
** 2007/09/10 INSERT START
** 出荷先住所変更対応 不具合対応
ENDIF .
** 2007/09/10 INSERT END
** 2007/07/20 INSERT END

A1F_TL_ORDER_ITEMS_IN-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_ITEMS_IN-MATERIAL   = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TL_ORDER_ITEMS_IN-PLANT      = /A1F/YLNS0011-YL_DWERK .
A1F_TL_ORDER_ITEMS_IN-SHORT_TEXT = /A1F/YLNS0011-YL_POSTX .
A1F_TL_ORDER_ITEMS_IN-CUST_MAT35 = /A1F/YLNS0011-YL_KDMAT .
A1F_TL_ORDER_ITEMS_IN-SALES_UNIT = /A1F/YLNS0011-YL_VRKME .
APPEND A1F_TL_ORDER_ITEMS_IN .

A1F_TL_ORDER_ITEMS_INX-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_ITEMS_INX-MATERIAL   = 'X' .
A1F_TL_ORDER_ITEMS_INX-PLANT      = 'X' .
A1F_TL_ORDER_ITEMS_INX-SHORT_TEXT = 'X' .
A1F_TL_ORDER_ITEMS_INX-CUST_MAT35 = 'X' .
A1F_TL_ORDER_ITEMS_INX-SALES_UNIT = 'X' .
APPEND A1F_TL_ORDER_ITEMS_INX .

A1F_TL_ORDER_SCHEDULES_IN-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_SCHEDULES_IN-REQ_DATE   = /A1F/YLNS0011-YL_VDATU .
A1F_TL_ORDER_SCHEDULES_IN-REQ_QTY    = /A1F/YLNS0011-YL_JTYUSU .
APPEND A1F_TL_ORDER_SCHEDULES_IN .

A1F_TL_ORDER_SCHEDULES_INX-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_SCHEDULES_INX-REQ_DATE   = 'X' .
A1F_TL_ORDER_SCHEDULES_INX-REQ_QTY    = 'X' .
APPEND A1F_TL_ORDER_SCHEDULES_INX .

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YLNS0011-YL_JTYTUK
AMOUNT_INTERNAL = /A1F/YLNS0011-YL_JTYUTNK
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
IF SY-SUBRC = 0 .
A1F_TL_ORDER_CONDITIONS_IN-COND_VALUE = A1F_WL_TMP_VALUE .
ELSE .
CLEAR A1F_TL_ORDER_CONDITIONS_IN-COND_VALUE .
ENDIF .

A1F_TL_ORDER_CONDITIONS_IN-ITM_NUMBER = A1F_CNS_NUMBER_S .
** 2007/09/27 DELETE START
** 価格決定の切り上げ、切り捨ての条件タイプへの対応
*  A1F_TL_ORDER_CONDITIONS_IN-COND_TYPE  = A1F_CNS_KSCHL .
** 2007/09/27 DELETE END
** 2007/09/27 INSERT START
** 価格決定の切り上げ、切り捨ての条件タイプへの対応
IF A1F_WG_KNVV-KALKS = '2'
OR A1F_WG_KNVV-KALKS = '6'
OR A1F_WG_KNVV-KALKS = '7' .
A1F_TL_ORDER_CONDITIONS_IN-COND_TYPE  = A1F_CNS_KSCHL1 .
ELSEIF A1F_WG_KNVV-KALKS = '3'
OR A1F_WG_KNVV-KALKS = '8'
OR A1F_WG_KNVV-KALKS = '9' .
A1F_TL_ORDER_CONDITIONS_IN-COND_TYPE  = A1F_CNS_KSCHL2 .
ELSE .
A1F_TL_ORDER_CONDITIONS_IN-COND_TYPE  = A1F_CNS_KSCHL .
ENDIF .
** 2007/09/27 INSERT END
A1F_TL_ORDER_CONDITIONS_IN-CURRENCY   = /A1F/YLNS0011-YL_JTYTUK .
A1F_TL_ORDER_CONDITIONS_IN-COND_P_UNT = /A1F/YLNS0011-YL_KPEIN .
APPEND A1F_TL_ORDER_CONDITIONS_IN .

A1F_TL_ORDER_TEXT-LANGU = SY-LANGU .
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_NUHNSYBKU = SPACE .
ELSE .
** 2007/06/19 INSERT END
A1F_TL_ORDER_TEXT-TEXT_ID = A1F_CNS_TDID_S02 .
A1F_TL_ORDER_TEXT-TEXT_LINE = /A1F/YLNS0011-YL_NUHNSYBKU .
APPEND A1F_TL_ORDER_TEXT .
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_SYNIBKU = SPACE .
ELSE .
** 2007/06/19 INSERT END
A1F_TL_ORDER_TEXT-TEXT_ID = A1F_CNS_TDID_S03 .
A1F_TL_ORDER_TEXT-TEXT_LINE = /A1F/YLNS0011-YL_SYNIBKU .
APPEND A1F_TL_ORDER_TEXT .
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_SYKSJBKU = SPACE .
ELSE .
** 2007/06/19 INSERT END
A1F_TL_ORDER_TEXT-ITM_NUMBER = 10 .
A1F_TL_ORDER_TEXT-TEXT_ID = A1F_CNS_TDID_S01 .
A1F_TL_ORDER_TEXT-TEXT_LINE = /A1F/YLNS0011-YL_SYKSJBKU .
APPEND A1F_TL_ORDER_TEXT .
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
EXPORTING
ORDER_HEADER_IN     = A1F_WL_ORDER_HEADER_IN
ORDER_HEADER_INX    = A1F_WL_ORDER_HEADER_INX
CONVERT             = 'X'
IMPORTING
SALESDOCUMENT       = A1F_WL_SALESDOCUMENT
TABLES
RETURN              = A1F_TL_RETURN_SALE
ORDER_ITEMS_IN      = A1F_TL_ORDER_ITEMS_IN
ORDER_ITEMS_INX     = A1F_TL_ORDER_ITEMS_INX
ORDER_PARTNERS      = A1F_TL_ORDER_PARTNERS
ORDER_SCHEDULES_IN  = A1F_TL_ORDER_SCHEDULES_IN
ORDER_SCHEDULES_INX = A1F_TL_ORDER_SCHEDULES_INX
ORDER_CONDITIONS_IN = A1F_TL_ORDER_CONDITIONS_IN
ORDER_TEXT          = A1F_TL_ORDER_TEXT
PARTNERADDRESSES    = A1F_TL_PARTNERADDRESSES.

LOOP AT A1F_TL_RETURN_SALE
WHERE TYPE NE 'W' .
MESSAGE ID A1F_TL_RETURN_SALE-ID
TYPE A1F_TL_RETURN_SALE-TYPE
NUMBER A1F_TL_RETURN_SALE-NUMBER
WITH A1F_TL_RETURN_SALE-MESSAGE_V1
A1F_TL_RETURN_SALE-MESSAGE_V2
A1F_TL_RETURN_SALE-MESSAGE_V3
A1F_TL_RETURN_SALE-MESSAGE_V4 .
ENDLOOP .

/A1F/YLNS0011-YL_VBELN = A1F_WL_SALESDOCUMENT  .
COMMIT WORK AND WAIT .

** 2007/07/21 INSERT START
** 売価０円対応
** 売価が０円でも受注登録を可能とする
IF /A1F/YLNS0011-YL_JTYUTNK IS INITIAL .
PERFORM A1F_SALES_PRICE_DELETE .
ENDIF .
** 2007/07/21 INSERT END

MESSAGE S223(/A1F/YLMS0100) .


ENDFORM.                    " A1F_SALES_DATA_EXEC
*&---------------------------------------------------------------------*
*&      Form  A1F_PURCHASE_DATA_EXEC
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_PURCHASE_DATA_EXEC .

DATA : A1F_WL_TMP_VALUE LIKE BAPICURR-BAPICURR .
DATA : A1F_WL_TMP_SALES_PERS LIKE BAPIMEPOHEADER-SALES_PERS .

DATA : A1F_WL_POHEADER          LIKE BAPIMEPOHEADER  ,
A1F_WL_POHEADERX         LIKE BAPIMEPOHEADERX  ,
A1F_WL_EXPPURCHASEORDER  LIKE BAPIMEPOHEADER-PO_NUMBER ,
A1F_WL_EXPHEADER         LIKE BAPIMEPOHEADER.

DATA : A1F_TL_RETURN_PURC      LIKE TABLE OF BAPIRET2
WITH HEADER LINE,
A1F_TL_POITEM     LIKE TABLE OF BAPIMEPOITEM WITH HEADER LINE ,
A1F_TL_POITEMX LIKE TABLE OF BAPIMEPOITEMX WITH HEADER LINE ,
A1F_TL_POSCHEDULE LIKE TABLE OF BAPIMEPOSCHEDULE
WITH HEADER LINE ,
A1F_TL_POSCHEDULEX LIKE TABLE OF BAPIMEPOSCHEDULX
WITH HEADER LINE ,
A1F_TL_POCOND LIKE TABLE OF BAPIMEPOCOND WITH HEADER LINE ,
A1F_TL_POCONDX LIKE TABLE OF BAPIMEPOCONDX WITH HEADER LINE ,
A1F_TL_POADDRDELIVERY LIKE TABLE OF BAPIMEPOADDRDELIVERY
WITH HEADER LINE .
*         A1F_TL_POTEXTHEADER LIKE TABLE OF BAPIMEPOTEXTHEADER
*         WITH HEADER LINE ,
*         A1F_TL_POADDRDELIVERY LIKE TABLE OF BAPIMEPOADDRDELIVERY
*         WITH HEADER LINE ,
*         A1F_TL_POTEXTITEM LIKE TABLE OF BAPIMEPOTEXT WITH HEADER LINE.

CLEAR : A1F_WL_POHEADER,
A1F_WL_POHEADERX ,
A1F_WL_EXPPURCHASEORDER,
A1F_WL_EXPHEADER,
A1F_TL_RETURN_PURC,
A1F_TL_POITEM,
A1F_TL_POITEMX,
A1F_TL_POSCHEDULE ,
A1F_TL_POSCHEDULEX ,
A1F_TL_POCOND,
A1F_TL_POCONDX,
A1F_TL_POADDRDELIVERY.
*          A1F_TL_POTEXTHEADER,
*          A1F_TL_POADDRDELIVERY,
*          A1F_TL_POTEXTITEM.
REFRESH : A1F_TL_RETURN_PURC,
A1F_TL_POITEM,
A1F_TL_POITEMX,
A1F_TL_POSCHEDULE ,
A1F_TL_POSCHEDULEX ,
A1F_TL_POCOND,
A1F_TL_POCONDX,
A1F_TL_POADDRDELIVERY.
*          A1F_TL_POTEXTHEADER,
*          A1F_TL_POADDRDELIVERY,
*          A1F_TL_POTEXTITEM.

CONCATENATE /A1F/YLNS0011-YL_VBELN A1F_CNS_NUMBER_S
INTO A1F_WL_TMP_SALES_PERS SEPARATED BY SPACE .

A1F_WL_POHEADER-COMP_CODE = /A1F/YLNS0011-BUKRS .
A1F_WL_POHEADER-DOC_TYPE = A1F_CNS_DOC_TYPE .
A1F_WL_POHEADER-VENDOR = /A1F/YLNS0011-YL_SIRSKCD .
A1F_WL_POHEADER-PURCH_ORG = /A1F/YLNS0011-EKORG .
A1F_WL_POHEADER-PUR_GROUP = /A1F/YLNS0011-EKGRP .
A1F_WL_POHEADER-DOC_DATE = /A1F/YLNS0011-YL_BEDAT .

A1F_WL_POHEADERX-COMP_CODE = 'X' .
A1F_WL_POHEADERX-DOC_TYPE = 'X' .
A1F_WL_POHEADERX-VENDOR = 'X' .
A1F_WL_POHEADERX-PURCH_ORG = 'X' .
A1F_WL_POHEADERX-PUR_GROUP = 'X' .
A1F_WL_POHEADERX-DOC_DATE = 'X' .

IF ZZZ_SP_TEST <> SPACE .
A1F_WL_POHEADER-SALES_PERS = A1F_WL_TMP_SALES_PERS .
A1F_WL_POHEADERX-SALES_PERS = 'X' .
ELSE .
CLEAR : A1F_WL_POHEADER-SALES_PERS ,
A1F_WL_POHEADERX-SALES_PERS .
ENDIF .

IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110 .
PERFORM A1F_GET_PREQ_NO USING    /A1F/YLNS0011-YL_VBELN
A1F_CNS_NUMBER_S
CHANGING A1F_TL_POITEM-PREQ_NO
A1F_TL_POITEM-PREQ_ITEM .
A1F_TL_POITEMX-PREQ_NO   = 'X' .
A1F_TL_POITEMX-PREQ_ITEM = 'X' .
ENDIF .

IF /A1F/YLNS0011-YL_MSYUFLG NE SPACE .
A1F_TL_POITEM-FREE_ITEM = 'X' .
A1F_TL_POITEMX-FREE_ITEM = 'X' .
ENDIF .

A1F_TL_POITEM-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TL_POITEM-SHORT_TEXT = /A1F/YLNS0011-YL_MAKTX_PURC .
A1F_TL_POITEM-MATERIAL = /A1F/YLNS0011-YL_MATNR_PURC .
A1F_TL_POITEM-PLANT = /A1F/YLNS0011-YL_DWERK .
A1F_TL_POITEM-VEND_MAT = /A1F/YLNS0011-YL_IDNLF .
A1F_TL_POITEM-QUANTITY = /A1F/YLNS0011-YL_HTYUSU .
A1F_TL_POITEM-PO_UNIT = /A1F/YLNS0011-YL_BSTME .
A1F_TL_POITEM-VEND_MAT = /A1F/YLNS0011-YL_IDNLF .
A1F_TL_POITEM-SHIPPING = /A1F/YLNS0011-YL_TYKSUKBN .
APPEND A1F_TL_POITEM .
A1F_TL_POITEMX-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TL_POITEMX-SHORT_TEXT = 'X' .
A1F_TL_POITEMX-MATERIAL = 'X' .
A1F_TL_POITEMX-PLANT = 'X' .
A1F_TL_POITEMX-VEND_MAT = 'X' .
A1F_TL_POITEMX-QUANTITY = 'X' .
A1F_TL_POITEMX-PO_UNIT = 'X' .
A1F_TL_POITEMX-VEND_MAT = 'X' .
** 2008/06/24 DELETE START
** 直送区分を空白にした場合でも反映されない事象に対する
** 対応
*  A1F_TL_POITEMX-SHIPPING = /A1F/YLNS0011-YL_TYKSUKBN .
** 2008/06/24 DELETE END
** 2008/06/24 INSERT START
** 直送区分を空白にした場合でも反映されない事象に対する
** 対応
A1F_TL_POITEMX-SHIPPING = 'X' .
** 2008/06/24 INSERT END
APPEND A1F_TL_POITEMX .

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YLNS0011-YL_HTYUTUK
AMOUNT_INTERNAL = /A1F/YLNS0011-YL_HTYUTNK
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
IF SY-SUBRC = 0 .
A1F_TL_POCOND-COND_VALUE = A1F_WL_TMP_VALUE .
ELSE .
CLEAR A1F_TL_POCOND-COND_VALUE .
ENDIF .
A1F_TL_POCOND-ITM_NUMBER = A1F_CNS_NUMBER_P .
A1F_TL_POCOND-COND_COUNT = '10' .
A1F_TL_POCOND-COND_TYPE = A1F_CNS_KSCHL_P2.
A1F_TL_POCOND-CURRENCY = /A1F/YLNS0011-YL_HTYUTUK .
A1F_TL_POCOND-COND_P_UNT = /A1F/YLNS0011-YL_PEINH .
IF A1F_TG_INFORECORD_PURCHORG-INFO_REC IS INITIAL .
A1F_TL_POCOND-CHANGE_ID = 'I' .
ELSE .
A1F_TL_POCOND-CHANGE_ID = 'U' .
ENDIF .
APPEND A1F_TL_POCOND .

A1F_TL_POCONDX-ITM_NUMBER = A1F_CNS_NUMBER_P .
A1F_TL_POCONDX-ITM_NUMBERX = 'X'.
A1F_TL_POCONDX-COND_COUNT = 'X' .
A1F_TL_POCONDX-COND_TYPE = 'X' .
A1F_TL_POCONDX-COND_VALUE = 'X' .
A1F_TL_POCONDX-CURRENCY = 'X' .
A1F_TL_POCONDX-COND_P_UNT = 'X' .
A1F_TL_POCONDX-CHANGE_ID = 'X' .
APPEND A1F_TL_POCONDX .

A1F_TL_POSCHEDULE-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TL_POSCHEDULE-DELIVERY_DATE = /A1F/YLNS0011-YL_EEIND .
A1F_TL_POSCHEDULE-QUANTITY = /A1F/YLNS0011-YL_HTYUSU .
APPEND A1F_TL_POSCHEDULE .
A1F_TL_POSCHEDULEX-PO_ITEM = A1F_CNS_NUMBER_P .
A1F_TL_POSCHEDULEX-DELIVERY_DATE = 'X' .
A1F_TL_POSCHEDULEX-QUANTITY = 'X' .
APPEND A1F_TL_POSCHEDULEX .

*  A1F_TL_POTEXTITEM-TEXT_FORM = '*' .
*  A1F_TL_POTEXTITEM-PO_ITEM = 10 .
*  A1F_TL_POTEXTITEM-TEXT_ID = A1F_CNS_TDID_P01 .
*  A1F_TL_POTEXTITEM-TEXT_LINE = /A1F/YLNS0011-YL_EDIBKU .
*  APPEND A1F_TL_POTEXTITEM .
*  A1F_TL_POTEXTITEM-TEXT_LINE = /A1F/YLNS0011-YL_EDIBKU2 .
*  APPEND A1F_TL_POTEXTITEM .
*  LOOP AT A1F_TG_LINES_YL_EDIBKU FROM 3 .
*    A1F_TL_POTEXTITEM-TEXT_LINE = A1F_TG_LINES_YL_EDIBKU-TDLINE .
*    APPEND A1F_TL_POTEXTITEM .
*  ENDLOOP .
*  A1F_TL_POTEXTITEM-TEXT_ID = A1F_CNS_TDID_P02 .
*  A1F_TL_POTEXTITEM-TEXT_LINE = /A1F/YLNS0011-YL_EDISNT .
*  APPEND A1F_TL_POTEXTITEM .
*  A1F_TL_POTEXTITEM-TEXT_ID = A1F_CNS_TDID_P03 .
*  A1F_TL_POTEXTITEM-TEXT_LINE = /A1F/YLNS0011-YL_TUMNSYBKU .
*  APPEND A1F_TL_POTEXTITEM .
*  LOOP AT A1F_TG_LINES_YL_TUMNSYBKU FROM 2 .
*    A1F_TL_POTEXTITEM-TEXT_LINE = A1F_TG_LINES_YL_TUMNSYBKU-TDLINE .
*    APPEND A1F_TL_POTEXTITEM .
*  ENDLOOP .
*  A1F_TL_POTEXTITEM-TEXT_ID = A1F_CNS_TDID_P04 .
*  A1F_TL_POTEXTITEM-TEXT_LINE = /A1F/YLNS0011-YL_SMDNEDIBKU .
*  APPEND A1F_TL_POTEXTITEM .
*  A1F_TL_POTEXTITEM-TEXT_ID = A1F_CNS_TDID_P05 .
*  A1F_TL_POTEXTITEM-TEXT_LINE = /A1F/YLNS0011-YL_HTYUZNITRNBKU .
*  APPEND A1F_TL_POTEXTITEM .

DATA : A1F_WL_ADDR_SUBRC LIKE SY-SUBRC .
PERFORM A1F_EXIT_GET_ADDR_CHECK USING A1F_WL_ADDR_SUBRC .
IF A1F_WL_ADDR_SUBRC = 0 .
IF NOT ( /A1F/YLNS0011-YL_TYKSUKBN IS INITIAL ) .
A1F_TL_POADDRDELIVERY-PO_ITEM = 10 .
** 2007/07/20 INSERT START
** 出荷先住所変更対応
IF A1F_WG_FES_VBADR-NAME1 IS INITIAL .
** 2007/07/20 INSERT END
SELECT SINGLE ADRNR FROM  KNA1
INTO  A1F_TL_POADDRDELIVERY-ADDR_NO
WHERE  KUNNR  = /A1F/YLNS0011-YL_SYKSKCD.
APPEND A1F_TL_POADDRDELIVERY .
** 2007/07/20 INSERT START
** 出荷先住所変更対応
ELSE .
PERFORM A1F_SET_ADDR_TO_PO_DELIV
CHANGING A1F_TL_POADDRDELIVERY .
APPEND A1F_TL_POADDRDELIVERY .
ENDIF .
** 2007/07/20 INSERT END
ENDIF .
ENDIF .

** 2009/05/21 UPDATE START
*  CALL FUNCTION 'BAPI_PO_CREATE1'
*       EXPORTING
*            POHEADER         = A1F_WL_POHEADER
*            POHEADERX        = A1F_WL_POHEADERX
*       IMPORTING
*            EXPPURCHASEORDER = A1F_WL_EXPPURCHASEORDER
*            EXPHEADER        = A1F_WL_EXPHEADER
*       TABLES
*            RETURN           = A1F_TL_RETURN_PURC
*            POITEM           = A1F_TL_POITEM
*            POITEMX          = A1F_TL_POITEMX
*            POSCHEDULE       = A1F_TL_POSCHEDULE
*            POSCHEDULEX      = A1F_TL_POSCHEDULEX
*            POCOND           = A1F_TL_POCOND
*            POCONDX          = A1F_TL_POCONDX
*            POADDRDELIVERY   = A1F_TL_POADDRDELIVERY.
**            POTEXTITEM       = A1F_TL_POTEXTITEM.

CALL FUNCTION 'Z_PO_CREATE' DESTINATION 'NONE'
EXPORTING
POHEADER         = A1F_WL_POHEADER
POHEADERX        = A1F_WL_POHEADERX
IMPORTING
EXPPURCHASEORDER = A1F_WL_EXPPURCHASEORDER
EXPHEADER        = A1F_WL_EXPHEADER
TABLES
RETURN           = A1F_TL_RETURN_PURC
POITEM           = A1F_TL_POITEM
POITEMX          = A1F_TL_POITEMX
POSCHEDULE       = A1F_TL_POSCHEDULE
POSCHEDULEX      = A1F_TL_POSCHEDULEX
POCOND           = A1F_TL_POCOND
POCONDX          = A1F_TL_POCONDX
POADDRDELIVERY   = A1F_TL_POADDRDELIVERY.

** 2009/05/21 UPDATE END
LOOP AT A1F_TL_RETURN_PURC
WHERE NOT ( NUMBER IS INITIAL )
AND TYPE = 'E' .
MESSAGE ID A1F_TL_RETURN_PURC-ID
TYPE A1F_TL_RETURN_PURC-TYPE
NUMBER A1F_TL_RETURN_PURC-NUMBER
WITH A1F_TL_RETURN_PURC-MESSAGE_V1
A1F_TL_RETURN_PURC-MESSAGE_V2
A1F_TL_RETURN_PURC-MESSAGE_V3
A1F_TL_RETURN_PURC-MESSAGE_V4 .
ENDLOOP .

/A1F/YLNS0011-YL_EBELN = A1F_WL_EXPPURCHASEORDER .
*  COMMIT WORK AND WAIT.                    "2009/05/21 DELETE

** 2009/05/21 INSERT START
CALL FUNCTION 'RFC_CONNECTION_CLOSE'
EXPORTING
DESTINATION          = 'NONE'
EXCEPTIONS
DESTINATION_NOT_OPEN = 1
OTHERS               = 2.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
** 2009/05/21 INSERT END

PERFORM A1F_EXIT_SAVE_POTEXT .

MESSAGE S223(/A1F/YLMS0100) .

ENDFORM.                    " A1F_PURCHASE_DATA_EXEC
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_DATA_change
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_CHANGE .

IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110 .
EXIT .
ENDIF .

IF ZZZ_SP_TEST = SPACE .
EXIT .
ENDIF.

DATA : A1F_WL_TMP_TEXT LIKE BAPISDTEXT-TEXT_LINE .
CLEAR : A1F_WL_TMP_TEXT .

DATA : A1F_WL_CHORDER_HEADER_INX LIKE BAPISDH1X ,
A1F_WL_CHSALESDOCUMENT LIKE BAPIVBELN-VBELN .

DATA : A1F_TL_CHRETURN_SALE  LIKE TABLE OF BAPIRET2 WITH HEADER
LINE ,
A1F_TL_CHORDER_ITEMS_IN      LIKE TABLE OF BAPISDITM WITH
HEADER LINE ,
A1F_TL_CHORDER_ITEMS_INX     LIKE TABLE OF BAPISDITMX WITH
HEADER LINE ,
A1F_TL_CHORDER_TEXT          LIKE TABLE OF BAPISDTEXT WITH
HEADER LINE .

CLEAR  : A1F_WL_CHORDER_HEADER_INX  ,
A1F_WL_CHSALESDOCUMENT ,
A1F_TL_CHRETURN_SALE          ,
A1F_TL_CHORDER_ITEMS_IN       ,
A1F_TL_CHORDER_ITEMS_INX      ,
A1F_TL_CHORDER_TEXT           .

REFRESH : A1F_TL_CHRETURN_SALE       ,
A1F_TL_CHORDER_ITEMS_IN       ,
A1F_TL_CHORDER_ITEMS_INX      ,
A1F_TL_CHORDER_TEXT           .

A1F_WL_CHSALESDOCUMENT = /A1F/YLNS0011-YL_VBELN .

A1F_WL_CHORDER_HEADER_INX-UPDATEFLAG   = 'U' .

A1F_TL_CHORDER_ITEMS_IN-ITM_NUMBER = A1F_CNS_NUMBER_S .
APPEND A1F_TL_CHORDER_ITEMS_IN .

A1F_TL_CHORDER_ITEMS_INX-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_CHORDER_ITEMS_INX-UPDATEFLAG = 'U' .
APPEND A1F_TL_CHORDER_ITEMS_INX .

CONCATENATE /A1F/YLNS0011-YL_EBELN A1F_CNS_NUMBER_P
INTO A1F_WL_TMP_TEXT SEPARATED BY SPACE .
A1F_TL_CHORDER_TEXT-DOC_NUMBER = /A1F/YLNS0011-YL_VBELN .
A1F_TL_CHORDER_TEXT-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_CHORDER_TEXT-TEXT_ID = A1F_CNS_TDID_S04 .
A1F_TL_CHORDER_TEXT-TEXT_LINE = A1F_WL_TMP_TEXT .
A1F_TL_CHORDER_TEXT-LANGU = SY-LANGU .
APPEND A1F_TL_CHORDER_TEXT .

CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
EXPORTING
SALESDOCUMENT    = A1F_WL_CHSALESDOCUMENT
ORDER_HEADER_INX = A1F_WL_CHORDER_HEADER_INX
TABLES
RETURN           = A1F_TL_CHRETURN_SALE
ORDER_ITEM_IN    = A1F_TL_CHORDER_ITEMS_IN
ORDER_ITEM_INX   = A1F_TL_CHORDER_ITEMS_INX
ORDER_TEXT       = A1F_TL_CHORDER_TEXT.

LOOP AT A1F_TL_CHRETURN_SALE
WHERE TYPE NE 'W'
AND TYPE NE 'I'.
MESSAGE ID A1F_TL_CHRETURN_SALE-ID
TYPE A1F_TL_CHRETURN_SALE-TYPE
NUMBER A1F_TL_CHRETURN_SALE-NUMBER
WITH A1F_TL_CHRETURN_SALE-MESSAGE_V1
A1F_TL_CHRETURN_SALE-MESSAGE_V2
A1F_TL_CHRETURN_SALE-MESSAGE_V3
A1F_TL_CHRETURN_SALE-MESSAGE_V4 .
ENDLOOP .

/A1F/YLNS0011-YL_VBELN = A1F_WL_CHSALESDOCUMENT  .
COMMIT WORK .

MESSAGE S223(/A1F/YLMS0100) .

ENDFORM.                    " A1F_SALES_DATA_change
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PREQ_NO
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_/A1F/YLNS0011_YL_VBELN  text
*      -->P_A1F_CNS_NUMBER_S  text
*      <--P_A1F_TL_POITEM_PREQ_NO  text
*      <--P_A1F_TL_POITEM_PREQ_ITEM  text
*----------------------------------------------------------------------*
*{   REPLACE        D05K906803                                        1
*\FORM A1F_GET_PREQ_NO  USING    P_/A1F/YLNS0011_YL_VBELN
FORM A1F_GET_PREQ_NO  USING    P_YLNS0011_YL_VBELN
*}   REPLACE
P_A1F_CNS_NUMBER_S
CHANGING P_A1F_TL_POITEM_PREQ_NO
P_A1F_TL_POITEM_PREQ_ITEM.

DATA : A1F_TL_VBEP      LIKE TABLE OF VBEP WITH HEADER LINE .

SELECT        * FROM  VBEP
INTO TABLE A1F_TL_VBEP
*{   REPLACE        D05K906803                                        2
*\         WHERE  VBELN  = P_/A1F/YLNS0011_YL_VBELN
WHERE  VBELN  = P_YLNS0011_YL_VBELN
*}   REPLACE
AND    POSNR  = P_A1F_CNS_NUMBER_S.
IF SY-SUBRC NE 0 .
MESSAGE E199(/A1F/YLMS0100) .
ENDIF .

LOOP AT A1F_TL_VBEP
WHERE NOT ( BANFN IS INITIAL ) .
P_A1F_TL_POITEM_PREQ_NO = A1F_TL_VBEP-BANFN .
P_A1F_TL_POITEM_PREQ_ITEM = A1F_TL_VBEP-BNFPO .
ENDLOOP .

ENDFORM.                    " A1F_GET_PREQ_NO
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_VA02
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_VA02 .

SET PARAMETER ID 'AUN' FIELD /A1F/YLNS0011-YL_VBELN.

CALL TRANSACTION 'VA02' AND SKIP FIRST SCREEN .

ENDFORM.                    " A1F_CALL_TRAN_VA02
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_ME22N
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_ME22N .

SET PARAMETER ID 'BES' FIELD /A1F/YLNS0011-YL_EBELN.

CALL TRANSACTION 'ME22N' .


ENDFORM.                    " A1F_CALL_TRAN_ME22N
*&---------------------------------------------------------------------*
*&      Form  a1f_exchange_sunit_to_bnit
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_EXCHANGE_SUNIT_TO_BNIT .

DATA : A1F_WL_MARM LIKE MARM .

* 販売数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_VRKME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
/A1F/YLNS0011-YL_JTYUSU_C = /A1F/YLNS0011-YL_JTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    MEINH  = /A1F/YLNS0011-YL_VRKME .
IF SY-SUBRC NE 0 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_VRKME' .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_VRKME.
ENDIF .

/A1F/YLNS0011-YL_JTYUSU_C = ( /A1F/YLNS0011-YL_JTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " a1f_exchange_sunit_to_bnit
*&---------------------------------------------------------------------*
*&      Form  a1f_exchange_punit_to_bunit
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_EXCHANGE_PUNIT_TO_BUNIT .

DATA : A1F_WL_MARM LIKE MARM .

* 発注数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_HTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME' .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME.
ENDIF .

/A1F/YLNS0011-YL_HTYUSU_C = ( /A1F/YLNS0011-YL_HTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " a1f_exchange_punit_to_bunit
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PURCH_TEXT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TG_INFORECORD_PURCHORG_INF  text
*----------------------------------------------------------------------*
FORM A1F_GET_PURCH_TEXT  USING    P_GENERAL STRUCTURE BAPIEINA
P_PURCHORG STRUCTURE BAPIEINE .

DATA : A1F_WL_ID LIKE THEAD-TDID ,
A1F_WL_LANGUAGE LIKE THEAD-TDSPRAS  ,
A1F_WL_NAME LIKE THEAD-TDNAME ,
A1F_WL_OBJECT LIKE THEAD-TDOBJECT .

DATA : A1F_TL_INLINES LIKE TABLE OF TLINE WITH HEADER LINE .

* 購買情報注記（EDI用備考）の取得
CLEAR : A1F_WL_ID  ,
A1F_WL_LANGUAGE   ,
A1F_WL_NAME  ,
A1F_WL_OBJECT  .
CLEAR : A1F_TL_INLINES  ,
A1F_TG_LINES_YL_EDIBKU .
REFRESH : A1F_TL_INLINES  ,
A1F_TG_LINES_YL_EDIBKU .

A1F_WL_NAME = P_GENERAL-INFO_REC .
A1F_WL_LANGUAGE = SY-LANGU .
A1F_WL_ID = 'AT' .
A1F_WL_OBJECT = 'EINA' .

CALL FUNCTION 'READ_TEXT_INLINE'
EXPORTING
ID              = A1F_WL_ID
INLINE_COUNT    = 100
LANGUAGE        = A1F_WL_LANGUAGE
NAME            = A1F_WL_NAME
OBJECT          = A1F_WL_OBJECT
TABLES
INLINES         = A1F_TL_INLINES
LINES           = A1F_TG_LINES_YL_EDIBKU
EXCEPTIONS
ID              = 1
LANGUAGE        = 2
NAME            = 3
NOT_FOUND       = 4
OBJECT          = 5
REFERENCE_CHECK = 6
OTHERS          = 7.
IF SY-SUBRC <> 0.
CLEAR /A1F/YLNS0011-YL_EDIBKU .
CLEAR /A1F/YLNS0011-YL_EDIBKU2 .
ELSE .
READ TABLE A1F_TL_INLINES INDEX 1 .
/A1F/YLNS0011-YL_EDIBKU = A1F_TL_INLINES-TDLINE .
READ TABLE A1F_TG_LINES_YL_EDIBKU INDEX 2 .
IF SY-SUBRC = 0 .
/A1F/YLNS0011-YL_EDIBKU2 = A1F_TG_LINES_YL_EDIBKU-TDLINE .
ENDIF .
ENDIF.

* 購買情報テキスト（注文書用備考）の取得
DATA  : BEGIN OF A1F_WL_NAME_02 ,
INFO_REC   LIKE BAPIEINE-INFO_REC ,
PURCH_ORG  LIKE BAPIEINE-PURCH_ORG ,
INFO_TYPE  LIKE BAPIEINE-INFO_TYPE ,
PLANT      LIKE BAPIEINE-PLANT ,
END OF A1F_WL_NAME_02 .

CLEAR : A1F_WL_ID  ,
A1F_WL_LANGUAGE   ,
A1F_WL_NAME_02  ,
A1F_WL_NAME  ,
A1F_WL_OBJECT  .
CLEAR : A1F_TL_INLINES  ,
A1F_TG_LINES_YL_TUMNSYBKU    .
REFRESH : A1F_TL_INLINES  ,
A1F_TG_LINES_YL_TUMNSYBKU    .

A1F_WL_NAME_02-INFO_REC   = P_PURCHORG-INFO_REC .
A1F_WL_NAME_02-PURCH_ORG  = P_PURCHORG-PURCH_ORG .
A1F_WL_NAME_02-INFO_TYPE  = P_PURCHORG-INFO_TYPE .
A1F_WL_NAME_02-PLANT      = P_PURCHORG-PLANT .
A1F_WL_NAME = A1F_WL_NAME_02 .
A1F_WL_LANGUAGE = SY-LANGU .
A1F_WL_ID = 'BT' .
A1F_WL_OBJECT = 'EINE' .

CALL FUNCTION 'READ_TEXT_INLINE'
EXPORTING
ID              = A1F_WL_ID
INLINE_COUNT    = 100
LANGUAGE        = A1F_WL_LANGUAGE
NAME            = A1F_WL_NAME
OBJECT          = A1F_WL_OBJECT
TABLES
INLINES         = A1F_TL_INLINES
LINES           = A1F_TG_LINES_YL_TUMNSYBKU
EXCEPTIONS
ID              = 1
LANGUAGE        = 2
NAME            = 3
NOT_FOUND       = 4
OBJECT          = 5
REFERENCE_CHECK = 6
OTHERS          = 7.
IF SY-SUBRC <> 0.
CLEAR /A1F/YLNS0011-YL_TUMNSYBKU .
ELSE .
READ TABLE A1F_TL_INLINES INDEX 1 .
/A1F/YLNS0011-YL_TUMNSYBKU = A1F_TL_INLINES-TDLINE .
ENDIF.

ENDFORM.                    " A1F_GET_PURCH_TEXT
*&---------------------------------------------------------------------*
*&      Form  A1F_VENDORGET_AND_DELETE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TG_INFORECORD_GENERAL  text
*      -->P_A1F_TG_INFORECORD_PURCHORG  text
*      -->P_/A1F/YLNS0011_YL_MATNR  text
*      -->P_/A1F/YLNS0011_YL_DWERK  text
*      -->P_SY_DATUM  text
*----------------------------------------------------------------------*
FORM A1F_VENDORGET_AND_DELETE
TABLES   P_GENERAL STRUCTURE BAPIEINA
P_PURCHORG STRUCTURE BAPIEINE
USING    P_MATNR
P_DWERK
P_DATUM.

DATA : A1F_TL_SOURCES_OF_SUPPLY LIKE TABLE OF BAPISOSY
WITH HEADER LINE ,
A1F_TL_SOS_RETURN LIKE TABLE OF BAPIRETURN
WITH HEADER LINE .
DATA : A1F_WL_SOS_LINE LIKE SY-TABIX .

CALL FUNCTION 'BAPI_SOURCEDETERMIN_GETSOS'
EXPORTING
MATERIAL          = P_MATNR
PLANT             = P_DWERK
DELIV_DATE        = P_DATUM
TABLES
SOURCES_OF_SUPPLY = A1F_TL_SOURCES_OF_SUPPLY
RETURN            = A1F_TL_SOS_RETURN.

READ TABLE A1F_TL_SOS_RETURN WITH KEY TYPE = 'E' .

PERFORM A1F_EXIT_GET_SOS_DATA
TABLES A1F_TL_SOURCES_OF_SUPPLY
USING P_MATNR P_DWERK P_DATUM
CHANGING SY-SUBRC .

IF SY-SUBRC = 0 .
EXIT .
ENDIF .

DESCRIBE TABLE A1F_TL_SOURCES_OF_SUPPLY LINES A1F_WL_SOS_LINE.
DATA : A1F_WL_FLIFN LIKE EORD-FLIFN .
IF A1F_WL_SOS_LINE NE 1 .
LOOP AT A1F_TL_SOURCES_OF_SUPPLY .
CLEAR A1F_WL_FLIFN .
SELECT SINGLE FLIFN FROM  EORD
INTO A1F_WL_FLIFN
WHERE  MATNR  = P_MATNR
AND    WERKS  = P_DWERK
AND    LIFNR  = A1F_TL_SOURCES_OF_SUPPLY-FIXED_VEND .
IF A1F_WL_FLIFN IS INITIAL .
DELETE A1F_TL_SOURCES_OF_SUPPLY .
ENDIF .
ENDLOOP .
ENDIF .

DESCRIBE TABLE A1F_TL_SOURCES_OF_SUPPLY LINES A1F_WL_SOS_LINE.
IF A1F_WL_SOS_LINE NE 1 .
EXIT .
ENDIF .

READ TABLE A1F_TL_SOURCES_OF_SUPPLY INDEX 1 .
DELETE P_GENERAL
WHERE INFO_REC NE A1F_TL_SOURCES_OF_SUPPLY-INFO_REC .
DELETE P_PURCHORG
WHERE INFO_REC NE A1F_TL_SOURCES_OF_SUPPLY-INFO_REC .
DELETE P_PURCHORG
WHERE PLANT NE P_DWERK .


ENDFORM.                    " A1F_VENDORGET_AND_DELETE
*&---------------------------------------------------------------------*
*&      Form  a1f_get_YL_EEIND
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_YL_EEIND .

IF NOT ( /A1F/YLNS0011-YL_EEIND IS INITIAL ) .
EXIT .
ENDIF .



DATA : A1F_WL_ADD_DAY TYPE P .
DATA : A1F_WL_TMP_DAY LIKE SY-DATUM .
DATA : A1F_WL_T001W_FABKL LIKE T001W-FABKL.

* 2009/09/02 直送区分の設定関係なく発注納期計算を実施
* するよう仕様変更が発生した。
* IF /A1F/YLNS0011-YL_TYKSUKBN IS INITIAL .

SELECT SINGLE FABKL FROM  T001W
INTO A1F_WL_T001W_FABKL
WHERE  WERKS  = /A1F/YLNS0011-YL_DWERK .
IF SY-SUBRC NE 0 .
EXIT .
ENDIF .

* Change By Mis-Ohno
*  A1F_WL_ADD_DAY = A1F_WG_MARC-WEBAZ + 3 .
A1F_WL_ADD_DAY = A1F_WG_MARC-WEBAZ .
* End Change

/A1F/YLNS0011-YL_EEIND = /A1F/YLNS0011-YL_VDATU .

DO A1F_WL_ADD_DAY TIMES .
IF /A1F/YLNS0011-YL_EEIND <= SY-DATUM .
EXIT .
ENDIF .
/A1F/YLNS0011-YL_EEIND = /A1F/YLNS0011-YL_EEIND - 1 .
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
CORRECT_OPTION               = '-'
DATE                         = /A1F/YLNS0011-YL_EEIND
FACTORY_CALENDAR_ID          = A1F_WL_T001W_FABKL
IMPORTING
DATE                         = A1F_WL_TMP_DAY
EXCEPTIONS
CALENDAR_BUFFER_NOT_LOADABLE = 1
CORRECT_OPTION_INVALID       = 2
DATE_AFTER_RANGE             = 3
DATE_BEFORE_RANGE            = 4
DATE_INVALID                 = 5
FACTORY_CALENDAR_NOT_FOUND   = 6
OTHERS                       = 7.
IF SY-SUBRC <> 0.
EXIT .
ENDIF.

/A1F/YLNS0011-YL_EEIND = A1F_WL_TMP_DAY .

ENDDO .

*  ELSE .
*    /A1F/YLNS0011-YL_EEIND = /A1F/YLNS0011-YL_VDATU .
*
*  ENDIF .

DATA : A1F_WL_TMP_EEIND LIKE /A1F/YLNS0011-YL_EEIND .
A1F_WL_TMP_EEIND = SY-DATUM .
DO A1F_TG_INFORECORD_PURCHORG-PLND_DELRY TIMES .
A1F_WL_TMP_EEIND = A1F_WL_TMP_EEIND + 1 .
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
CORRECT_OPTION               = '+'
DATE                         = A1F_WL_TMP_EEIND
FACTORY_CALENDAR_ID          = A1F_WL_T001W_FABKL
IMPORTING
DATE                         = A1F_WL_TMP_DAY
EXCEPTIONS
CALENDAR_BUFFER_NOT_LOADABLE = 1
CORRECT_OPTION_INVALID       = 2
DATE_AFTER_RANGE             = 3
DATE_BEFORE_RANGE            = 4
DATE_INVALID                 = 5
FACTORY_CALENDAR_NOT_FOUND   = 6
OTHERS                       = 7.
IF SY-SUBRC <> 0.
EXIT .
ENDIF.

A1F_WL_TMP_EEIND = A1F_WL_TMP_DAY .
ENDDO .

IF A1F_WL_TMP_EEIND > /A1F/YLNS0011-YL_EEIND .
MESSAGE W221(/A1F/YLMS0100) WITH A1F_WL_TMP_EEIND .
ENDIF .


ENDFORM.                    " a1f_get_YL_EEIND
*&---------------------------------------------------------------------*
*&      Form  a1f_exit_set_auart
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_/A1F/YLNS0011_YL_AUART  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_SET_AUART CHANGING P_AUART.

CASE A1F_WG_KNVV-KTGRD .
WHEN '03' .
P_AUART = 'ZOR' .
WHEN OTHERS .
P_AUART = 'TA' .
ENDCASE .

ENDFORM.                    " a1f_exit_set_auart
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_SAUFT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_A1F_WG_BILLING_PARTY_SIM  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_SAUFT
CHANGING P_BILLING_PARTY STRUCTURE BAPIPAYER.

IF NOT ( P_BILLING_PARTY-ORDER_VALS IS INITIAL ) .
EXIT .
ENDIF .

DATA A1F_WL_OLIKW LIKE S067-OLIKW .
CLEAR A1F_WL_OLIKW .
SELECT SINGLE OLIKW FROM  S067
INTO A1F_WL_OLIKW
WHERE  KKBER  = P_BILLING_PARTY-C_CTR_AREA
AND    KNKLI  = P_BILLING_PARTY-CRED_ACCNT.
IF SY-SUBRC = 0 .
P_BILLING_PARTY-ORDER_VALS = A1F_WL_OLIKW .
ELSE.
CLEAR P_BILLING_PARTY-ORDER_VALS .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_SAUFT
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_JTYUTNK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_/A1F/YLNS0011_YL_JTYUTNK  text
*      <--P_/A1F/YLNS0011_YL_KPEIN  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_JTYUTNK CHANGING P_JTYUTNK
P_KPEIN.

IF NOT ( P_JTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

DATA : A1F_TL_A901 LIKE TABLE OF A901 WITH HEADER LINE ,
A1F_WL_KONH LIKE KONH ,
A1F_TL_KONP LIKE TABLE OF KONP WITH HEADER LINE ,
A1F_TL_KONM LIKE TABLE OF KONM WITH HEADER LINE .

SELECT        * FROM  A901
INTO TABLE A1F_TL_A901
WHERE  KAPPL     = 'V'
AND    KSCHL     = A1F_CNS_KSCHL
AND    VKORGAU   = /A1F/YLNS0011-VKORG
AND    VTWEG     = /A1F/YLNS0011-VTWEG
AND    SPART     = /A1F/YLNS0011-SPART
AND    KUNNR     = /A1F/YLNS0011-YL_TKISKCD
AND    DATBI    >= /A1F/YLNS0011-YL_AUDAT
AND    DATAB    <= /A1F/YLNS0011-YL_AUDAT
AND    ZZZKDMAT  = /A1F/YLNS0011-YL_KDMAT .

READ TABLE A1F_TL_A901 INDEX 1 .

SELECT SINGLE * FROM  KONH
INTO A1F_WL_KONH
WHERE  KNUMH  = A1F_TL_A901-KNUMH.

SELECT        * FROM  KONP
INTO TABLE A1F_TL_KONP
WHERE  KNUMH  = A1F_TL_A901-KNUMH.

READ TABLE A1F_TL_KONP INDEX 1 .

P_KPEIN = A1F_TL_KONP-KPEIN .

** 2007/09/13 INSERT START
** 品目マスタの単位と販売価格マスタの単位のチェック
**  に関する不具合対応
*** 品目マスタの単位と販売価格マスタの単位のチェック
*** 品目マスタの単位と販売価格マスタの単位が異なる場合エラーとする
IF /A1F/YLNS0011-YL_VRKME IS INITIAL .
IF A1F_TL_KONP-KMEIN
NE /A1F/YLNS0011-YL_MEINS .
MESSAGE E224(/A1F/YLMS0100) .
ENDIF .
ELSE .
IF A1F_TL_KONP-KMEIN
NE /A1F/YLNS0011-YL_VRKME .
MESSAGE E224(/A1F/YLMS0100) .
ENDIF .
ENDIF .
** 2007/09/13 INSERT END




SELECT        * FROM  KONM
INTO TABLE A1F_TL_KONM
WHERE  KNUMH  = A1F_TL_A901-KNUMH.

DATA : BEGIN OF A1F_TL_TYP_KONM ,
KSTBM_F LIKE KONM-KSTBM ,
KSTBM_T LIKE KONM-KSTBM ,
KBETR   LIKE KONM-KBETR ,
END OF A1F_TL_TYP_KONM .

DATA A1F_TL_TMP_KONM LIKE TABLE OF A1F_TL_TYP_KONM
WITH HEADER LINE .

IF SY-SUBRC NE 0 .
P_JTYUTNK = A1F_TL_KONP-KBETR .
ELSE .
LOOP AT A1F_TL_KONM .
IF SY-TABIX = 1 .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ELSE .
A1F_TL_TMP_KONM-KSTBM_T = A1F_TL_KONM-KSTBM .
APPEND A1F_TL_TMP_KONM .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ENDIF .
AT LAST .
A1F_TL_TMP_KONM-KSTBM_T = '999999999999.999' .
APPEND A1F_TL_TMP_KONM .
ENDAT .
ENDLOOP .

LOOP AT A1F_TL_TMP_KONM
WHERE KSTBM_F <= /A1F/YLNS0011-YL_JTYUSU
AND KSTBM_T >  /A1F/YLNS0011-YL_JTYUSU.
P_JTYUTNK = A1F_TL_TMP_KONM-KBETR .
EXIT .
ENDLOOP .
IF SY-SUBRC NE 0 .
CLEAR P_JTYUTNK  .
ENDIF .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_JTYUTNK
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_SOS_DATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TL_SOURCES_OF_SUPPLY  text
*      -->P_P_MATNR  text
*      -->P_P_DWERK  text
*      -->P_P_DATUM  text
*      <--P_SY_SUBRC  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_SOS_DATA
TABLES   P_SOS STRUCTURE BAPISOSY
USING    P_P_MATNR P_P_DWERK P_P_DATUM
CHANGING P_SUBRC.

DATA A1F_WL_TMP_LINES LIKE SY-TABIX.

DESCRIBE TABLE P_SOS LINES A1F_WL_TMP_LINES .

IF P_SUBRC NE 0 .
IF A1F_WL_TMP_LINES NE 0 .
EXIT .
ENDIF .
ENDIF .

REFRESH P_SOS .
CLEAR P_SOS .

DATA : A1F_TL_EORD LIKE TABLE OF EORD WITH HEADER LINE .

SELECT        * FROM  EORD
INTO TABLE A1F_TL_EORD
WHERE  MATNR  = P_P_MATNR
AND    WERKS  = P_P_DWERK
AND    VDATU  <= P_P_DATUM
AND    BDATU  >= P_P_DATUM
AND    FLIFN  = 'X' .

IF SY-SUBRC NE 0 .
P_SUBRC = SY-SUBRC .
EXIT .
ENDIF .

LOOP AT A1F_TL_EORD .
P_SOS-FIXED_VEND = A1F_TL_EORD-LIFNR .   "固定仕入先
P_SOS-SUPPL_PLNT = A1F_TL_EORD-RESWK .   "品目を供給するプラント
P_SOS-AGREEMENT = A1F_TL_EORD-EBELN .   "購買契約番号
P_SOS-AGMT_ITEM = A1F_TL_EORD-EBELP .   "購買契約の明細番号
P_SOS-DOC_CAT = A1F_TL_EORD-VRTYP .   "購買伝票カテゴリ
P_SOS-PURCH_ORG = A1F_TL_EORD-EKORG .   "購買組織
P_SOS-PO_UNIT = A1F_TL_EORD-MEINS .   "発注単位
*P_SOS-ITEM_CAT = A1F_TL_EORD-   "購買伝票の明細カテゴリ
P_SOS-PUR_MAT = A1F_TL_EORD-MATNR .   "品目コード
*P_SOS-ITEM_CAT_EXT = A1F_TL_EORD-   "購買伝票の明細カテゴリ
*P_SOS-PO_UNIT_ISO = A1F_TL_EORD-   "ISO コードによる発注単位
*P_SOS-INFO_REC = A1F_TL_EORD-   "購買情報番号
SELECT SINGLE INFNR FROM  EINA
INTO P_SOS-INFO_REC
WHERE  MATNR  = A1F_TL_EORD-MATNR
AND    LIFNR  = A1F_TL_EORD-LIFNR
AND    LOEKZ  = SPACE .
IF SY-SUBRC NE 0 .
CLEAR P_SOS-INFO_REC .
ENDIF .
APPEND P_SOS .
ENDLOOP .
P_SUBRC = 9 .

ENDFORM.                    " A1F_EXIT_GET_SOS_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_SALES_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_SALES_PRICE.

IF NOT ( /A1F/YLNS0011-YL_JTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

* BAPIによる受注関連データの取得
CLEAR : A1F_WG_SOLD_TO_PARTY_SIM ,
A1F_WG_SHIP_TO_PARTY_SIM ,
A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM ,
A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_MESSAGETABLE_SIM .
REFRESH : A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_MESSAGETABLE_SIM .

A1F_WG_ORDER_HEADER_IN_SIM-DOC_TYPE = /A1F/YLNS0011-YL_AUART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_ORG = /A1F/YLNS0011-VKORG .
A1F_WG_ORDER_HEADER_IN_SIM-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
A1F_WG_ORDER_HEADER_IN_SIM-DIVISION = /A1F/YLNS0011-SPART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_GRP = /A1F/YLNS0011-VKGRP .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_OFF = /A1F/YLNS0011-VKBUR .
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = SY-DATUM .
ELSE .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
ENDIF .

CLEAR A1F_TG_ORDER_PARTNERS_SIM .
REFRESH A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'SP' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .
A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = /A1F/YLNS0011-YL_JTYUSU.
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CALL FUNCTION 'BAPI_SALESORDER_SIMULATE'
EXPORTING
ORDER_HEADER_IN     = A1F_WG_ORDER_HEADER_IN_SIM
CONVERT_PARVW_AUART = 'X'
IMPORTING
SOLD_TO_PARTY       = A1F_WG_SOLD_TO_PARTY_SIM
SHIP_TO_PARTY       = A1F_WG_SHIP_TO_PARTY_SIM
BILLING_PARTY       = A1F_WG_BILLING_PARTY_SIM
RETURN              = A1F_WG_RETURN_SIM
TABLES
ORDER_ITEMS_IN      = A1F_TG_ORDER_ITEMS_IN_SIM
ORDER_PARTNERS      = A1F_TG_ORDER_PARTNERS_SIM
ORDER_SCHEDULE_IN   = A1F_TG_ORDER_SCHEDULE_IN_SIM
ORDER_ITEMS_OUT     = A1F_TG_ORDER_ITEMS_OUT_SIM
ORDER_SCHEDULE_EX   = A1F_TG_ORDER_SCHEDULE_EX_SIM
ORDER_CONDITION_EX  = A1F_TG_ORDER_CONDITION_EX_SIM
ORDER_INCOMPLETE    = A1F_TG_ORDER_INCOMPLETE_SIM
MESSAGETABLE        = A1F_TG_MESSAGETABLE_SIM
PARTNERADDRESSES    = A1F_TG_PARTNERADDRESSES_SIM.

*  LOOP AT A1F_TG_MESSAGETABLE_SIM .
*    MESSAGE ID A1F_TG_MESSAGETABLE_SIM-ID
*            TYPE A1F_TG_MESSAGETABLE_SIM-TYPE
*            NUMBER A1F_TG_MESSAGETABLE_SIM-NUMBER
*            WITH A1F_TG_MESSAGETABLE_SIM-MESSAGE_V1
*                 A1F_TG_MESSAGETABLE_SIM-MESSAGE_V2
*                 A1F_TG_MESSAGETABLE_SIM-MESSAGE_V3
*                 A1F_TG_MESSAGETABLE_SIM-MESSAGE_V4 .
*  ENDLOOP .

* 受注単価、単位数量（per）
*  DATA : A1F_WL_RETURN_CURR_EX LIKE BAPIRETURN .
*  DATA : A1F_WL_BAPICURR LIKE BAPICURR-BAPICURR .
*  READ TABLE A1F_TG_ORDER_CONDITION_EX_SIM WITH KEY
*                                     COND_TYPE = A1F_CNS_KSCHL
*                                     CONDISACTI = SPACE .
*  IF SY-SUBRC = 0.
*    A1F_WL_BAPICURR = A1F_TG_ORDER_CONDITION_EX_SIM-COND_VALUE .
*    CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_INTERNAL'
*      EXPORTING
*        CURRENCY             = A1F_TG_ORDER_CONDITION_EX_SIM-CURRENCY
*        AMOUNT_EXTERNAL      = A1F_WL_BAPICURR
*        MAX_NUMBER_OF_DIGITS = '13'
*      IMPORTING
*        AMOUNT_INTERNAL      = /A1F/YLNS0011-YL_JTYUTNK
*        RETURN               = A1F_WL_RETURN_CURR_EX.
*    IF A1F_WL_RETURN_CURR_EX-TYPE NE 'E' .
*      /A1F/YLNS0011-YL_KPEIN = A1F_TG_ORDER_CONDITION_EX_SIM-COND_P_UNT
*      .
*    ELSE .
*      CLEAR /A1F/YLNS0011-YL_JTYUTNK .
*      /A1F/YLNS0011-YL_KPEIN = 1 .
*    ENDIF .
*  ELSE .
*    CLEAR /A1F/YLNS0011-YL_JTYUTNK .
*    /A1F/YLNS0011-YL_KPEIN = 1 .
*  ENDIF .

PERFORM A1F_EXIT_GET_JTYUTNK
CHANGING /A1F/YLNS0011-YL_JTYUTNK
/A1F/YLNS0011-YL_KPEIN .

A1F_WG_MASTER_TANKA_SALE = /A1F/YLNS0011-YL_JTYUTNK .




ENDFORM.                    " A1F_GET_SALES_PRICE
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_save_potext
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_EXIT_SAVE_POTEXT.

DATA : A1F_TL_BDCDATA LIKE TABLE OF BDCDATA
WITH HEADER LINE .
DATA : A1F_TL_SP_RETURN LIKE TABLE OF BAPIRET2
WITH HEADER LINE .

DATA : A1F_WL_EDIB_3 LIKE TLINE-TDLINE .
DATA : A1F_WL_EDIB_4 LIKE TLINE-TDLINE .
DATA : A1F_WL_EDIB_5 LIKE TLINE-TDLINE .
DATA : A1F_WL_TYUM_2 LIKE TLINE-TDLINE .
DATA : A1F_WL_TYUM_3 LIKE TLINE-TDLINE .
DATA : A1F_WL_TYUM_4 LIKE TLINE-TDLINE .
DATA : A1F_WL_TYUM_5 LIKE TLINE-TDLINE .

READ TABLE A1F_TG_LINES_YL_EDIBKU INDEX 3 .
IF SY-SUBRC = 0 .
A1F_WL_EDIB_3 = A1F_TG_LINES_YL_EDIBKU-TDLINE .
ELSE .
CLEAR A1F_WL_EDIB_3 .
ENDIF .

READ TABLE A1F_TG_LINES_YL_EDIBKU INDEX 4 .
IF SY-SUBRC = 0 .
A1F_WL_EDIB_4 = A1F_TG_LINES_YL_EDIBKU-TDLINE .
ELSE .
CLEAR A1F_WL_EDIB_4 .
ENDIF .

READ TABLE A1F_TG_LINES_YL_EDIBKU INDEX 5 .
IF SY-SUBRC = 0 .
A1F_WL_EDIB_5 = A1F_TG_LINES_YL_EDIBKU-TDLINE .
ELSE .
CLEAR A1F_WL_EDIB_5 .
ENDIF .

READ TABLE A1F_TG_LINES_YL_TUMNSYBKU INDEX 2 .
IF SY-SUBRC = 0 .
A1F_WL_TYUM_2 = A1F_TG_LINES_YL_TUMNSYBKU-TDLINE .
ELSE .
CLEAR A1F_WL_TYUM_2 .
ENDIF .

READ TABLE A1F_TG_LINES_YL_TUMNSYBKU INDEX 3 .
IF SY-SUBRC = 0 .
A1F_WL_TYUM_3 = A1F_TG_LINES_YL_TUMNSYBKU-TDLINE .
ELSE .
CLEAR A1F_WL_TYUM_3 .
ENDIF .

READ TABLE A1F_TG_LINES_YL_TUMNSYBKU INDEX 4 .
IF SY-SUBRC = 0 .
A1F_WL_TYUM_4 = A1F_TG_LINES_YL_TUMNSYBKU-TDLINE .
ELSE .
CLEAR A1F_WL_TYUM_4 .
ENDIF .

READ TABLE A1F_TG_LINES_YL_TUMNSYBKU INDEX 5 .
IF SY-SUBRC = 0 .
A1F_WL_TYUM_5 = A1F_TG_LINES_YL_TUMNSYBKU-TDLINE .
ELSE .
CLEAR A1F_WL_TYUM_5 .
ENDIF .

PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
'SAPMM06E'             '0105'                  'X',
'BDC_OKCODE'           '/00'                   ' ',
'RM06E-BSTNR'          /A1F/YLNS0011-YL_EBELN  ' ',
'SAPMM06E'             '0120'                  'X',
'RM06E-EEIND(1)'     /A1F/YLNS0011-YL_EEIND       ' ',
'BDC_CURSOR'           'RM06E-BSTPO(01)'       ' ',
'BDC_OKCODE'           '=TXP'                  ' ',
'RM06E-TCSELFLAG(01)'  'X'                     ' ',
'SAPMM06E'             '0106'                  'X'.
*注文書備考
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_TUMNSYBKU = SPACE
AND A1F_WL_TYUM_2 = SPACE
AND A1F_WL_TYUM_3 = SPACE
AND A1F_WL_TYUM_4 = SPACE
AND A1F_WL_TYUM_5 = SPACE .
ELSE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'BDC_CURSOR'           'RM06E-LTEX1(01)'       ' ',
'BDC_OKCODE'           '=TEDE'                 ' ',
'SAPLSTXX'             '1100'                  'X',
'BDC_OKCODE'           '=TXBA'                 ' '.
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_TUMNSYBKU NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(02)' '*'                     ' ',
'RSTXT-TXLINE(02)'     /A1F/YLNS0011-YL_TUMNSYBKU ' '.
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_TYUM_2 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(03)' '*'                     ' ',
'RSTXT-TXLINE(03)'     A1F_WL_TYUM_2           ' '.

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_TYUM_3 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(04)' '*'                     ' ',
'RSTXT-TXLINE(04)'     A1F_WL_TYUM_3           ' '.

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_TYUM_4 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(05)' '*'                     ' ',
'RSTXT-TXLINE(05)'     A1F_WL_TYUM_4           ' '.

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_TYUM_5 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(06)' '*'                     ' ',
'RSTXT-TXLINE(06)'     A1F_WL_TYUM_5           ' '.
** 2007/06/19 INSERT START
**  テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
ENDIF .
** 2007/06/19 INSERT END

*発注算一覧備考
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_HTYUZNITRNBKU = SPACE .
ELSE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'SAPMM06E'             '0106'                  'X',
'BDC_CURSOR'           'RM06E-LTEX1(03)'       ' ',
'BDC_OKCODE'           '=TEDE'                 ' ',
'SAPLSTXX'             '1100'                  'X',
'BDC_OKCODE'           '=TXBA'                 ' ',
'RSTXT-TXPARGRAPH(02)' '*'                     ' ',
'RSTXT-TXLINE(02)' /A1F/YLNS0011-YL_HTYUZNITRNBKU ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END
*
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'SAPMM06E'             '0106'                  'X',
'BDC_CURSOR'           'RM06E-LTEX1(01)'       ' ',
'BDC_OKCODE'           '=VW'                 ' '.
*ＥＤＩ備考
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_EDIBKU = SPACE
AND /A1F/YLNS0011-YL_EDIBKU2 = SPACE
AND A1F_WL_EDIB_3 = SPACE
AND A1F_WL_EDIB_4 = SPACE
AND A1F_WL_EDIB_5 = SPACE .
ELSE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'SAPMM06E'             '0106'                  'X',
'BDC_CURSOR'           'RM06E-LTEX1(01)'       ' ',
'BDC_OKCODE'           '=TEDE'                 ' ',
'SAPLSTXX'             '1100'                  'X',
'BDC_OKCODE'           '=TXBA'                 ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_EDIBKU NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(02)' '*'                     ' ',
'RSTXT-TXLINE(02)'     /A1F/YLNS0011-YL_EDIBKU ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_EDIBKU2 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(03)' '*'                     ' ',
'RSTXT-TXLINE(03)'     /A1F/YLNS0011-YL_EDIBKU2 ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_EDIB_3 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(04)' '*'                     ' ',
'RSTXT-TXLINE(04)'     A1F_WL_EDIB_3           ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_EDIB_4 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(05)' '*'                     ' ',
'RSTXT-TXLINE(05)'     A1F_WL_EDIB_4           ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF A1F_WL_EDIB_5 NE SPACE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'RSTXT-TXPARGRAPH(06)' '*'                     ' ',
'RSTXT-TXLINE(06)'     A1F_WL_EDIB_5           ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
ENDIF .
** 2007/06/19 INSERT END

*ＥＤＩその他
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_EDISNT = SPACE .
ELSE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'SAPMM06E'             '0106'                  'X',
'BDC_CURSOR'           'RM06E-LTEX1(02)'       ' ',
'BDC_OKCODE'           '=TEDE'                 ' ',
'SAPLSTXX'             '1100'                  'X',
'BDC_OKCODE'           '=TXBA'                 ' ',
'RSTXT-TXPARGRAPH(02)' '*'                     ' ',
'RSTXT-TXLINE(02)'     /A1F/YLNS0011-YL_EDISNT ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

*住電ＥＤＩ備考
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
IF /A1F/YLNS0011-YL_SMDNEDIBKU = SPACE .
ELSE .
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'SAPMM06E'             '0106'                  'X',
'BDC_CURSOR'           'RM06E-LTEX1(03)'       ' ',
'BDC_OKCODE'           '=TEDE'                 ' ',
'SAPLSTXX'             '1100'                  'X',
'BDC_OKCODE'           '=TXBA'                 ' ',
'RSTXT-TXPARGRAPH(02)' '*'                     ' ',
'RSTXT-TXLINE(02)' /A1F/YLNS0011-YL_SMDNEDIBKU ' '.
** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
ENDIF .
** 2007/06/19 INSERT END

** 2007/06/19 INSERT START
** テキストがＳＰＡＣＥの場合テキスト更新を行わ・
** 改行の消去
PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
** 2007/06/19 INSERT END
'SAPMM06E'             '0106'                  'X',
'BDC_CURSOR'           'RM06E-LTEX1(01)'       ' ',
'BDC_OKCODE'           '=BU'                 ' '.


PERFORM A1F_CALL_TRANSCTION TABLES A1F_TL_BDCDATA
A1F_TL_SP_RETURN
USING 'ME22'.



ENDFORM.                    " A1F_EXIT_save_potext
*&---------------------------------------------------------------------*
*&      Form  a1f_GENERATE_BDCDATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TL_BDCDATA  text
*      -->P_2256   text
*      -->P_2257   text
*      -->P_2258   text
*----------------------------------------------------------------------*
FORM A1F_GENERATE_BDCDATA
TABLES   P_A1F_TL_BDCDATA STRUCTURE BDCDATA
USING    P_PROGRAM P_DYNPRO P_DYNBEGIN.

CLEAR P_A1F_TL_BDCDATA.

IF P_DYNBEGIN = 'X'.
P_A1F_TL_BDCDATA-PROGRAM  = P_PROGRAM.
P_A1F_TL_BDCDATA-DYNPRO   = P_DYNPRO.
P_A1F_TL_BDCDATA-DYNBEGIN = P_DYNBEGIN.
APPEND P_A1F_TL_BDCDATA.
ELSEIF P_DYNBEGIN = ' '.
P_A1F_TL_BDCDATA-FNAM = P_PROGRAM.
P_A1F_TL_BDCDATA-FVAL = P_DYNPRO.
APPEND P_A1F_TL_BDCDATA.
ENDIF.


ENDFORM.                    " a1f_GENERATE_BDCDATA
*&---------------------------------------------------------------------*
*&      Form  a1f_CALL_TRANSCTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TL_BDCDATA  text
*      -->P_P_A1F_TL_KNMT_RETURN  text
*      -->P_2281   text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRANSCTION  TABLES   P_A1F_TL_BDCDATA
STRUCTURE BDCDATA
P_BAPIRET2
STRUCTURE BAPIRET2
USING  P_TCODE .

DATA : A1F_TL_BDCMSGCOLL LIKE TABLE OF BDCMSGCOLL
WITH HEADER LINE .

DATA A1F_WL_SY_SUBRC LIKE SY-SUBRC .

CLEAR P_BAPIRET2 .
REFRESH P_BAPIRET2 .

DATA A1F_WL_OPT LIKE CTU_PARAMS .

A1F_WL_OPT-DISMODE = 'E' .
A1F_WL_OPT-UPDMODE = 'S' .
A1F_WL_OPT-DEFSIZE = 'X' .

CALL TRANSACTION P_TCODE
USING P_A1F_TL_BDCDATA
OPTIONS FROM A1F_WL_OPT
MESSAGES INTO A1F_TL_BDCMSGCOLL .

A1F_WL_SY_SUBRC = SY-SUBRC .

LOOP AT A1F_TL_BDCMSGCOLL .
P_BAPIRET2-TYPE = A1F_TL_BDCMSGCOLL-MSGTYP .
P_BAPIRET2-ID = A1F_TL_BDCMSGCOLL-MSGID.
P_BAPIRET2-NUMBER = A1F_TL_BDCMSGCOLL-MSGNR.
P_BAPIRET2-MESSAGE_V1 = A1F_TL_BDCMSGCOLL-MSGV1.
P_BAPIRET2-MESSAGE_V2 = A1F_TL_BDCMSGCOLL-MSGV2.
P_BAPIRET2-MESSAGE_V3 = A1F_TL_BDCMSGCOLL-MSGV3.
P_BAPIRET2-MESSAGE_V4 = A1F_TL_BDCMSGCOLL-MSGV4.
APPEND P_BAPIRET2 .
ENDLOOP.

SY-SUBRC = A1F_WL_SY_SUBRC .

ENDFORM.                    " a1f_CALL_TRANSCTION
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PURCHES_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_PURCHES_PRICE.

IF NOT ( /A1F/YLNS0011-YL_HTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

PERFORM A1F_EXIT_GET_HTYUTNK
CHANGING /A1F/YLNS0011-YL_HTYUTNK
/A1F/YLNS0011-YL_PEINH .



ENDFORM.                    " A1F_GET_PURCHES_PRICE
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_HTYUTNK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_/A1F/YLNS0011_YL_HTYUTNK  text
*      <--P_/A1F/YLNS0011_YL_PEINH  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_HTYUTNK CHANGING P_HTYUTNK
P_PEINH.

IF NOT ( P_HTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

DATA : A1F_TL_A017 LIKE TABLE OF A017 WITH HEADER LINE ,
A1F_WL_KONH LIKE KONH ,
A1F_TL_KONP LIKE TABLE OF KONP WITH HEADER LINE ,
A1F_TL_KONM LIKE TABLE OF KONM WITH HEADER LINE .

SELECT        * FROM  A017
INTO TABLE A1F_TL_A017
WHERE  KAPPL     = 'M'
AND    EKORG   = /A1F/YLNS0011-EKORG
AND    WERKS   = /A1F/YLNS0011-YL_DWERK
AND    LIFNR     = /A1F/YLNS0011-YL_SIRSKCD
AND    DATBI    >= /A1F/YLNS0011-YL_BEDAT
AND    DATAB    <= /A1F/YLNS0011-YL_BEDAT
AND    MATNR  = /A1F/YLNS0011-YL_MATNR_PURC .

LOOP AT A1F_TL_A017 .
IF A1F_TL_A017-KSCHL(1) NE 'Z' .
DELETE A1F_TL_A017 .
ENDIF .
ENDLOOP .


READ TABLE A1F_TL_A017 INDEX 1 .

SELECT SINGLE * FROM  KONH
INTO A1F_WL_KONH
WHERE  KNUMH  = A1F_TL_A017-KNUMH.

SELECT        * FROM  KONP
INTO TABLE A1F_TL_KONP
WHERE  KNUMH  = A1F_TL_A017-KNUMH.

READ TABLE A1F_TL_KONP INDEX 1 .

P_PEINH = A1F_TL_KONP-KPEIN .

SELECT        * FROM  KONM
INTO TABLE A1F_TL_KONM
WHERE  KNUMH  = A1F_TL_A017-KNUMH.

DATA : BEGIN OF A1F_TL_TYP_KONM ,
KSTBM_F LIKE KONM-KSTBM ,
KSTBM_T LIKE KONM-KSTBM ,
KBETR   LIKE KONM-KBETR ,
END OF A1F_TL_TYP_KONM .

DATA A1F_TL_TMP_KONM LIKE TABLE OF A1F_TL_TYP_KONM
WITH HEADER LINE .

IF SY-SUBRC NE 0 .
P_HTYUTNK = A1F_TL_KONP-KBETR .
A1F_WG_MASTER_TANKA_PURC = A1F_TL_KONP-KBETR .
ELSE .
LOOP AT A1F_TL_KONM .
IF SY-TABIX = 1 .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ELSE .
A1F_TL_TMP_KONM-KSTBM_T = A1F_TL_KONM-KSTBM .
APPEND A1F_TL_TMP_KONM .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ENDIF .
AT LAST .
A1F_TL_TMP_KONM-KSTBM_T = '999999999999.999' .
APPEND A1F_TL_TMP_KONM .
ENDAT .
ENDLOOP .

LOOP AT A1F_TL_TMP_KONM
WHERE KSTBM_F <= /A1F/YLNS0011-YL_HTYUSU
AND KSTBM_T >  /A1F/YLNS0011-YL_HTYUSU.
P_HTYUTNK = A1F_TL_TMP_KONM-KBETR .
A1F_WG_MASTER_TANKA_PURC = A1F_TL_TMP_KONM-KBETR .
EXIT .
ENDLOOP .
IF SY-SUBRC NE 0 .
CLEAR P_HTYUTNK  .
ENDIF .
ENDIF .




ENDFORM.                    " A1F_EXIT_GET_HTYUTNK
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_addr_check
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_WL_ADDR_SUBRC  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_ADDR_CHECK USING    P_SUBRC.

DATA : A1F_TL_B951 LIKE TABLE OF B951 WITH HEADER LINE ,
A1F_WL_KONH LIKE KONH ,
A1F_WL_NACHA LIKE NACH-NACHA .

SELECT        * FROM  B951
INTO TABLE A1F_TL_B951
WHERE  LIFNR  = /A1F/YLNS0011-YL_SIRSKCD.

READ TABLE A1F_TL_B951 INDEX 1 .

SELECT SINGLE NACHA FROM  NACH
INTO A1F_WL_NACHA
WHERE  KNUMH  = A1F_TL_B951-KNUMH.

IF A1F_WL_NACHA = 6 .
P_SUBRC = 9 .
ENDIF .



ENDFORM.                    " A1F_EXIT_GET_addr_check
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_YMP120TC001
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_YMP120TC001.

** 2009/06/11 UPDATE START
** 品目マスタメンテのトランザクションコードを
** バリアント付に変更
*  CALL TRANSACTION 'YMP120TC001' .
CALL TRANSACTION 'YMP1' .
** 2009/06/11 UPDATE END

ENDFORM.                    " A1F_CALL_TRAN_YMP120TC001
** 2007/07/20 INSERT START
** 出荷先住所変更対応
*&---------------------------------------------------------------------*
*&      Form  A1F_CHECK_AND_PICK_DATA
*&---------------------------------------------------------------------*
*       出荷先住所変更対応
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*

FORM A1F_CHECK_AND_PICK_DATA.

DATA: A1F_WL_CURSORFIELD(100).

GET CURSOR FIELD A1F_WL_CURSORFIELD.

IF A1F_WL_CURSORFIELD = '/A1F/YLNS0011-YL_SYKSKCD'
AND NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .

PERFORM A1F_POPUP_SYKSKDATA .

ENDIF .

ENDFORM.                    " A1F_CHECK_AND_PICK_DATA
*&---------------------------------------------------------------------*
*&      Form  a1f_popup_sykskdata
*&---------------------------------------------------------------------*
*       出荷先住所変更対応
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_POPUP_SYKSKDATA.

DATA A1F_WL_ADRNR LIKE KNA1-ADRNR .
TYPES: BEGIN OF LV09A_ATTRIBUTES_SHOW_WA,
ABLAD TYPE XFLAG,
STCEG TYPE XFLAG,
STCD1 TYPE XFLAG,
STCD2 TYPE XFLAG,
STCD3 TYPE XFLAG,
STCD4 TYPE XFLAG,
STCDT TYPE XFLAG,
STKZN TYPE XFLAG,
J_1KFREPRE TYPE XFLAG,
J_1KFTBUS TYPE XFLAG,
J_1KFTIND TYPE XFLAG           .
TYPES: END OF LV09A_ATTRIBUTES_SHOW_WA.
DATA A1F_WL_FIF_ATTRIBUTES_S TYPE LV09A_ATTRIBUTES_SHOW_WA .

A1F_WL_FIF_ATTRIBUTES_S-ABLAD = 'X' .
A1F_WL_FIF_ATTRIBUTES_S-STCEG = 'X' .

SELECT SINGLE ADRNR FROM  KNA1
INTO A1F_WL_ADRNR
WHERE  KUNNR  = /A1F/YLNS0011-YL_SYKSKCD.

CALL FUNCTION 'SD_PARTNER_ADDR_DIALOG_INTERN'
EXPORTING
FIF_ADDRESS_NUMBER           = A1F_WL_ADRNR
FIF_ADRDA                    = 'B'
FIF_ADDRESS_HANDLE_TO_CREATE = 'WE $0001'
FIF_ATTRIBUTES               = A1F_WG_FEF_ATTRIBUTES
FIF_ATTRIBUTES_SHOWN         = A1F_WL_FIF_ATTRIBUTES_S
FIF_TITLE_PARVW              = 'WE'
IMPORTING
FES_ADDR1_COMPLETE           = A1F_WG_FES_ADDR1_COMPLETE
FES_VBADR                    = A1F_WG_FES_VBADR
FEF_ATTRIBUTES               = A1F_WG_FEF_ATTRIBUTES
FES_NEW_ADDRESS              = A1F_WG_ADDR1_OUT
EXCEPTIONS
INTERNAL_ERROR               = 1
NO_ADDRESS                   = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " a1f_popup_sykskdata
*&---------------------------------------------------------------------*
*&      Form  A1F_SET_ADDR_TO_PO_DELIV
*&---------------------------------------------------------------------*
*       出荷先住所変更対応：直送指定時の発注伝票納入先への反映
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SET_ADDR_TO_PO_DELIV
CHANGING P_POADDRDELIVERY STRUCTURE BAPIMEPOADDRDELIVERY.

P_POADDRDELIVERY-TITLE = A1F_WG_ADDR1_OUT-TITLE .
P_POADDRDELIVERY-NAME = A1F_WG_ADDR1_OUT-NAME1 .
P_POADDRDELIVERY-NAME_2 = A1F_WG_ADDR1_OUT-NAME2 .
P_POADDRDELIVERY-NAME_3 = A1F_WG_ADDR1_OUT-NAME3 .
P_POADDRDELIVERY-NAME_4 = A1F_WG_ADDR1_OUT-NAME4 .
P_POADDRDELIVERY-C_O_NAME = A1F_WG_ADDR1_OUT-NAME_CO .
P_POADDRDELIVERY-CITY = A1F_WG_ADDR1_OUT-CITY1 .
P_POADDRDELIVERY-DISTRICT = A1F_WG_ADDR1_OUT-CITY2 .
P_POADDRDELIVERY-CITY_NO = A1F_WG_ADDR1_OUT-CITY_CODE .
P_POADDRDELIVERY-DISTRCT_NO = A1F_WG_ADDR1_OUT-CITYP_CODE .
P_POADDRDELIVERY-CHCKSTATUS = A1F_WG_ADDR1_OUT-CHCKSTATUS .
P_POADDRDELIVERY-REGIOGROUP = A1F_WG_ADDR1_OUT-REGIOGROUP .
P_POADDRDELIVERY-POSTL_COD1 = A1F_WG_ADDR1_OUT-POST_CODE1 .
P_POADDRDELIVERY-POSTL_COD2 = A1F_WG_ADDR1_OUT-POST_CODE2 .
P_POADDRDELIVERY-POSTL_COD3 = A1F_WG_ADDR1_OUT-POST_CODE3 .
P_POADDRDELIVERY-PO_BOX = A1F_WG_ADDR1_OUT-PO_BOX .
P_POADDRDELIVERY-PO_BOX_CIT = A1F_WG_ADDR1_OUT-PO_BOX_LOC .
P_POADDRDELIVERY-PBOXCIT_NO = A1F_WG_ADDR1_OUT-CITY_CODE2 .
P_POADDRDELIVERY-DELIV_DIS = A1F_WG_ADDR1_OUT-POSTALAREA .
P_POADDRDELIVERY-TRANSPZONE = A1F_WG_ADDR1_OUT-TRANSPZONE .
P_POADDRDELIVERY-STREET = A1F_WG_ADDR1_OUT-STREET .
P_POADDRDELIVERY-STREET_LNG = A1F_WG_ADDR1_OUT-STREET .
P_POADDRDELIVERY-STREET_NO = A1F_WG_ADDR1_OUT-STREETCODE .
P_POADDRDELIVERY-STR_ABBR = A1F_WG_ADDR1_OUT-STREETABBR .
P_POADDRDELIVERY-HOUSE_NO = A1F_WG_ADDR1_OUT-HOUSE_NUM1 .
P_POADDRDELIVERY-HOUSE_NO2 = A1F_WG_ADDR1_OUT-HOUSE_NUM2 .
P_POADDRDELIVERY-STR_SUPPL1 = A1F_WG_ADDR1_OUT-STR_SUPPL1 .
P_POADDRDELIVERY-STR_SUPPL2 = A1F_WG_ADDR1_OUT-STR_SUPPL2 .
P_POADDRDELIVERY-STR_SUPPL3 = A1F_WG_ADDR1_OUT-STR_SUPPL3 .
P_POADDRDELIVERY-LOCATION = A1F_WG_ADDR1_OUT-LOCATION .
P_POADDRDELIVERY-BUILDING = A1F_WG_ADDR1_OUT-BUILDING .
P_POADDRDELIVERY-BUILD_LONG = A1F_WG_ADDR1_OUT-BUILDING .
P_POADDRDELIVERY-FLOOR = A1F_WG_ADDR1_OUT-FLOOR .
P_POADDRDELIVERY-ROOM_NO = A1F_WG_ADDR1_OUT-ROOMNUMBER .
P_POADDRDELIVERY-COUNTRY = A1F_WG_ADDR1_OUT-COUNTRY .
P_POADDRDELIVERY-LANGU = A1F_WG_ADDR1_OUT-LANGU .
P_POADDRDELIVERY-REGION = A1F_WG_ADDR1_OUT-REGION .
P_POADDRDELIVERY-SORT1 = A1F_WG_ADDR1_OUT-SORT1 .
P_POADDRDELIVERY-SORT2 = A1F_WG_ADDR1_OUT-SORT2 .
P_POADDRDELIVERY-TIME_ZONE = A1F_WG_ADDR1_OUT-TIME_ZONE .
P_POADDRDELIVERY-TAXJURCODE = A1F_WG_ADDR1_OUT-TAXJURCODE .
P_POADDRDELIVERY-ADR_NOTES = A1F_WG_ADDR1_OUT-REMARK .
P_POADDRDELIVERY-COMM_TYPE = A1F_WG_ADDR1_OUT-DEFLT_COMM .

DATA A1F_WL_ADTEL TYPE SZADR_ADTEL_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADTEL_TAB INDEX 1
INTO A1F_WL_ADTEL.
P_POADDRDELIVERY-TEL1_NUMBR =
A1F_WL_ADTEL-ADTEL-TEL_NUMBER .
P_POADDRDELIVERY-TEL1_EXT =
A1F_WL_ADTEL-ADTEL-TEL_EXTENS .

DATA A1F_WL_ADFAX TYPE SZADR_ADFAX_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADFAX_TAB INDEX 1
INTO A1F_WL_ADFAX.
P_POADDRDELIVERY-FAX_NUMBER =
A1F_WL_ADFAX-ADFAX-FAX_NUMBER .
P_POADDRDELIVERY-FAX_EXTENS =
A1F_WL_ADFAX-ADFAX-FAX_EXTENS .

DATA A1F_WL_ADSMTP TYPE SZADR_ADSMTP_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADSMTP_TAB INDEX 1
INTO A1F_WL_ADSMTP.

P_POADDRDELIVERY-E_MAIL =
A1F_WL_ADSMTP-ADSMTP-SMTP_ADDR.

ENDFORM.                    " A1F_SET_ADDR_TO_PO_DELIV
** 2007/07/20 INSERT END

** 2007/07/21 INSERT START
** 発注のみ実施する機能の追加
** 発注のみを実施する機能を追加し、発注のみの場合は販売関連
** の情報の入力を不要とする。
*&---------------------------------------------------------------------*
*&      Form  A1F_SET_CURSOR_9000_003
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SET_CURSOR_9000_003.

IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_MATNR_SALE'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-EKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP'.
EXIT .
ENDIF .

ENDFORM.                    " A1F_SET_CURSOR_9000_003
*&---------------------------------------------------------------------*
*&      Form  A1F_SET_CURSOR_9000_004
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SET_CURSOR_9000_004.

SET CURSOR FIELD '/A1F/YLNS0011-YL_SIRSKCD'.

IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-EKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_SIRSKCD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_SIRSKCD'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_BEDAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BEDAT'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_EEIND IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_EEIND'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_IDNLF IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_IDNLF'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_HTYUSU'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_BSTME IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_HTYUTNK'.
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_BEDAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BEDAT'.
EXIT .
ENDIF .

ENDFORM.                    " A1F_SET_CURSOR_9000_004
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_INITIAL_DATA2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_GET_INITIAL_DATA2.

* 受注を行わずに発注を行うフラグを建てる
/A1F/YLNS0011-YL_HTYUNSKBN = 'X' .

* 品目マスタ：基本ビューの取得
SELECT SINGLE * FROM  MARA
INTO A1F_WG_MARA
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE .
IF SY-SUBRC NE 0 .
MESSAGE E152(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE .
ENDIF .

* 品目マスタ：販売ビューの取得
SELECT SINGLE * FROM  MVKE
INTO A1F_WG_MVKE
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND  VKORG  = /A1F/YLNS0011-VKORG
AND  VTWEG  = /A1F/YLNS0011-VTWEG.
IF SY-SUBRC NE 0 .
MESSAGE E153(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE .
ENDIF .

* 品目テキストの取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
SELECT SINGLE MAKTX FROM  MAKT
INTO /A1F/YLNS0011-YL_MAKTX_SALE
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    SPRAS  = SY-LANGU.
IF SY-SUBRC NE 0 .
MESSAGE E151(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
SY-LANGU .
ENDIF .
ENDIF .

* 基本数量単位の設定
/A1F/YLNS0011-YL_MEINS = A1F_WG_MARA-MEINS .

* プラントの設定
IF /A1F/YLNS0011-YL_DWERK IS INITIAL.

* 発注のみ実施の場合、プラント取得元はパラメータID
* いままでは、品目マスタに登録されているプラントの代表
* 2009/10/26 変更
*    SELECT SINGLE WERKS FROM  MARC
*           INTO /A1F/YLNS0011-YL_DWERK
*           WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE .

SELECT SINGLE PARVA FROM USR05
INTO /A1F/YLNS0011-YL_DWERK
WHERE BNAME = SY-UNAME
AND PARID = 'WRK'.

ENDIF .
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK' .
MESSAGE E207(/A1F/YLMS0100) .
ENDIF .

* 品目マスタ：会計ビューの取得
SELECT SINGLE * FROM  MBEW
INTO A1F_WG_MBEW
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND  BWKEY  = /A1F/YLNS0011-YL_DWERK .
IF SY-SUBRC NE 0 .
MESSAGE E158(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
ENDIF .

* 品目マスタ：プラントビューの取得
SELECT SINGLE * FROM  MARC
INTO A1F_WG_MARC
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND  WERKS  = /A1F/YLNS0011-YL_DWERK .
IF SY-SUBRC NE 0 .
MESSAGE E217(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
ENDIF .


* 購買発注側の品目コードへコピー
/A1F/YLNS0011-YL_MATNR_PURC = /A1F/YLNS0011-YL_MATNR_SALE .
/A1F/YLNS0011-YL_MAKTX_PURC = /A1F/YLNS0011-YL_MAKTX_SALE .

* 発注単位INFORECORD_GENERAL-PO_UNIT
IF A1F_WG_MARA-BSTME IS INITIAL .
/A1F/YLNS0011-YL_BSTME = A1F_WG_MARA-MEINS .
ELSE .
/A1F/YLNS0011-YL_BSTME = A1F_WG_MARA-BSTME .
ENDIF .

* 単位数量（per）INFORECORD_PURCHORG-PRICE_UNIT
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
/A1F/YLNS0011-YL_PEINH = 1 .
ENDIF .

* 発注通貨INFORECORD_PURCHORG-CURRENCY
/A1F/YLNS0011-YL_HTYUTUK = A1F_WG_T001-WAERS .

* 発注日付
/A1F/YLNS0011-YL_BEDAT = SY-DATUM .
* 納入日付
*  /A1F/YLNS0011-YL_EEIND = SY-DATUM + A1F_WG_MARC-WEBAZ .

* 購買情報取得
DATA A1F_WL_PURCHORG_LINE_COUNT LIKE SY-TABIX .
DATA A1F_WL_GENERAL_LINE_COUNT LIKE SY-TABIX .
CALL FUNCTION 'BAPI_INFORECORD_GETLIST'
EXPORTING
MATERIAL            = /A1F/YLNS0011-YL_MATNR_PURC
PURCH_ORG           = /A1F/YLNS0011-EKORG
INFO_TYPE           = '0'
PLANT               = /A1F/YLNS0011-YL_DWERK
TABLES
INFORECORD_GENERAL  = A1F_TG_INFORECORD_GENERAL
INFORECORD_PURCHORG = A1F_TG_INFORECORD_PURCHORG
RETURN              = A1F_TG_RETURN_PURC_INFO.
*
* 供給元一覧を参照し、購買情報を限定する
PERFORM A1F_VENDORGET_AND_DELETE
TABLES A1F_TG_INFORECORD_GENERAL
A1F_TG_INFORECORD_PURCHORG
USING  /A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_DWERK
SY-DATUM .
*
DESCRIBE TABLE A1F_TG_INFORECORD_GENERAL LINES
A1F_WL_GENERAL_LINE_COUNT.
IF A1F_WL_GENERAL_LINE_COUNT NE 1.
MESSAGE W163(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
A1F_WL_GENERAL_LINE_COUNT.
EXIT .
ENDIF .
*
READ TABLE A1F_TG_INFORECORD_GENERAL INDEX 1 .

* 仕入先コードの設定
/A1F/YLNS0011-YL_SIRSKCD = A1F_TG_INFORECORD_GENERAL-VENDOR .

SELECT SINGLE * FROM  LFA1
INTO A1F_WG_LFA1
WHERE  LIFNR  = /A1F/YLNS0011-YL_SIRSKCD.
IF SY-SUBRC NE 0 .
MESSAGE E164(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_SIRSKCD.
ENDIF .

SELECT SINGLE * FROM  LFM1
INTO A1F_WG_LFM1
WHERE  LIFNR  = /A1F/YLNS0011-YL_SIRSKCD
AND  EKORG  = /A1F/YLNS0011-EKORG.
IF SY-SUBRC NE 0 .
MESSAGE E164(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_SIRSKCD.
ENDIF .
IF A1F_WG_LFM1-WAERS IS INITIAL .
MESSAGE E216(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_SIRSKCD.
ENDIF .

* 仕入先名の設定
/A1F/YLNS0011-YL_SIRSKNM = A1F_WG_LFA1-NAME1 .

* 仕入先品目コード
/A1F/YLNS0011-YL_IDNLF = A1F_TG_INFORECORD_GENERAL-VEND_MAT .

* 発注通貨INFORECORD_PURCHORG-CURRENCY
/A1F/YLNS0011-YL_HTYUTUK = A1F_WG_LFM1-WAERS .

* 仕入先品目名

* 発注単位INFORECORD_GENERAL-PO_UNIT
/A1F/YLNS0011-YL_BSTME = A1F_TG_INFORECORD_GENERAL-PO_UNIT .

DESCRIBE TABLE A1F_TG_INFORECORD_PURCHORG LINES
A1F_WL_PURCHORG_LINE_COUNT.
IF A1F_WL_PURCHORG_LINE_COUNT NE 1.
MESSAGE W165(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_SIRSKCD
A1F_WL_PURCHORG_LINE_COUNT.
EXIT .
ENDIF .

READ TABLE A1F_TG_INFORECORD_PURCHORG INDEX 1 .

DATA : A1F_WL_RETURN_CURR_EX LIKE BAPIRETURN .
DATA : A1F_WL_BAPICURR LIKE BAPICURR-BAPICURR .

CLEAR : A1F_WL_RETURN_CURR_EX ,
A1F_WL_BAPICURR .

* 発注単価INFORECORD_PURCHORG-NET_PRICE
*  A1F/YLNS0011-YL_HTYUTNK = A1F_TG_INFORECORD_PURCHORG-NET_PRICE .
A1F_WG_MASTER_TANKA_PURC = A1F_TG_INFORECORD_PURCHORG-NET_PRICE .

* 単位数量（per）INFORECORD_PURCHORG-PRICE_UNIT
/A1F/YLNS0011-YL_PEINH = A1F_TG_INFORECORD_PURCHORG-PRICE_UNIT .
* 発注通貨INFORECORD_PURCHORG-CURRENCY
/A1F/YLNS0011-YL_HTYUTUK = A1F_TG_INFORECORD_PURCHORG-CURRENCY .

* 購買グループの設定
IF /A1F/YLNS0011-EKGRP IS INITIAL .
/A1F/YLNS0011-EKGRP = A1F_TG_INFORECORD_PURCHORG-PUR_GROUP .
ENDIF .
IF /A1F/YLNS0011-EKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP' .
MESSAGE E208(/A1F/YLMS0100) .
ENDIF .

* 直送区分（出荷指示）の設定
/A1F/YLNS0011-YL_TYKSUKBN = A1F_TG_INFORECORD_PURCHORG-SHIPPING .

* 購買情報テキストの取得
PERFORM A1F_GET_PURCH_TEXT USING A1F_TG_INFORECORD_GENERAL
A1F_TG_INFORECORD_PURCHORG .

ENDFORM.                    " A1F_GET_INITIAL_DATA2
** 2007/07/21 INSERT END
** 2007/07/21 INSERT START
** 売価０円対応
** 売価が０円でも受注登録を可能とする
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_PRICE_DELETE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_SALES_PRICE_DELETE.

DATA : A1F_TL_BDCDATA LIKE TABLE OF BDCDATA
WITH HEADER LINE .
DATA : A1F_TL_SP_RETURN LIKE TABLE OF BAPIRET2
WITH HEADER LINE .

PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
'SAPMV45A'             '0102'                  'X',
'BDC_OKCODE'           '/00'                   ' ',
'VBAK-VBELN'          /A1F/YLNS0011-YL_VBELN  ' ',
'SAPMV45A'             '4001'                  'X',
'BDC_OKCODE'           '=PKO1'                  ' ',
'RV45A-VBAP_SELKZ(01)' 'X'                     ' ',

'SAPMV45A'             '5003'                  'X',
'BDC_OKCODE'           '=SICH'                  ' ',
'KOMV-KBETR(01)'       '0'                     ' ',
'KOMV-KBETR(02)'       '0'                     ' ',
'SAPLSPO2'             '0100'                  'X',
'BDC_OKCODE'           '=OPT1'                  ' '.


PERFORM A1F_CALL_TRANSCTION TABLES A1F_TL_BDCDATA
A1F_TL_SP_RETURN
USING 'VA02'.

ENDFORM.                    " A1F_SALES_PRICE_DELETE
** 2007/07/21 INSERT END
** 2009/06/11 INSERT START
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_VA01
*&---------------------------------------------------------------------*
*       受注伝票登録呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_VA01.

CALL TRANSACTION 'VA01' .

ENDFORM.                    " A1F_CALL_TRAN_VA01
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_CO06
*&---------------------------------------------------------------------*
*       バックオーダ呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_CO06.

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
SET PARAMETER ID 'PRR' FIELD SPACE.

CALL TRANSACTION 'CO06' AND SKIP FIRST SCREEN .

ENDFORM.                    " A1F_CALL_TRAN_CO06
** 2009/06/11 INSERT END
** 2009/06/19 INSERT START
*&---------------------------------------------------------------------*
*&      Form  A1F_RELOAD
*&---------------------------------------------------------------------*
*       データ再取得処理
*----------------------------------------------------------------------*
FORM A1F_RELOAD.

* 変数初期化
CLEAR : A1F_WG_EKGRP ,
A1F_WG_WERKS_P ,
A1F_WG_WERKS_S ,
A1F_WG_VKBUR ,
A1F_WG_VKGRP .

IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
*   受注伝票情報取得
PERFORM A1F_GET_SALES_DATA .
ENDIF .

IF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
* 　発注伝票情報取得
PERFORM A1F_GET_PURCHASE_DATA .
ENDIF .

* 表示データ取得
PERFORM A1F_GET_INITIAL_DATA .

* 出荷先住所変更対応
IF NOT ( A1F_WG_ADDR1_OUT-NAME1 IS INITIAL ) .
/A1F/YLNS0011-YL_SYKSKNM = A1F_WG_ADDR1_OUT-NAME1 .
ELSE.
IF NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .
SELECT SINGLE NAME1 FROM  KNA1
INTO /A1F/YLNS0011-YL_SYKSKNM
WHERE  KUNNR  = /A1F/YLNS0011-YL_SYKSKCD.
ENDIF .
ENDIF .

ENDFORM.                    " A1F_RELOAD
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_SALES_DATA
*&---------------------------------------------------------------------*
*       受注伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_SALES_DATA.

* 受注伝票情報取得
CLEAR A1F_WG_KNUMV_S.
SELECT SINGLE
K~AUDAT                        "伝票日付 (受信日/送信日)
K~AUART                        "販売伝票タイプ
K~LIFSK                        "出荷ブロック (伝票ヘッダ)
K~VKORG                        "販売組織
K~VTWEG                        "流通チャネル
K~SPART                        "製品部門
K~VKGRP                        "営業グループ
K~VKBUR                        "営業所
K~VDATU                        "指定納入期日
K~BSTNK                        "得意先発注番号
K~BSTDK                        "得意先発注日付
K~KUNNR                        "受注先
P~PSTYV                        "取引タイプ
P~KDMAT                        "得意先品目コード
P~ARKTX                        "得意先品目テキスト
P~MATNR                        "品目コード
P~KWMENG                       "受注数量
P~VRKME                        "受注単位
P~KPEIN                        "Per
P~WAERK                        "受注通貨
P~NETWR                        "受注金額
P~NETPR                        "受注単価
P~WERKS                        "プラント
K~KNUMV                        "伝票条件番号
INTO (/A1F/YLNS0011-YL_AUDAT,       /A1F/YLNS0011-YL_AUART,
/A1F/YLNS0011-YL_LIFSK,       /A1F/YLNS0011-VKORG,
/A1F/YLNS0011-VTWEG,          /A1F/YLNS0011-SPART,
/A1F/YLNS0011-VKGRP,          /A1F/YLNS0011-VKBUR,
/A1F/YLNS0011-YL_VDATU,       /A1F/YLNS0011-YL_BSTKD,
/A1F/YLNS0011-YL_TKISKHCDT,   /A1F/YLNS0011-YL_TKISKCD,
/A1F/YLNS0011-YL_MISIKTGRTYP, /A1F/YLNS0011-YL_KDMAT,
/A1F/YLNS0011-YL_POSTX,       /A1F/YLNS0011-YL_MATNR_SALE,
/A1F/YLNS0011-YL_JTYUSU,      /A1F/YLNS0011-YL_VRKME,
/A1F/YLNS0011-YL_KPEIN,       /A1F/YLNS0011-YL_JTYTUK,
/A1F/YLNS0011-YL_JYYUKNGK,    /A1F/YLNS0011-YL_JTYUTNK,
/A1F/YLNS0011-YL_DWERK,       A1F_WG_KNUMV_S)
FROM VBAK AS K
INNER JOIN VBAP AS P
ON K~VBELN = P~VBELN
WHERE K~VBELN = /A1F/YLNS0011-YL_VBELN
AND P~POSNR = A1F_CNS_NUMBER_S.

IF SY-SUBRC = 0 .
A1F_WG_WERKS_S = /A1F/YLNS0011-YL_DWERK.
A1F_WG_VKBUR   = /A1F/YLNS0011-VKBUR .
A1F_WG_VKGRP   = /A1F/YLNS0011-VKGRP .
ELSE .
MESSAGE S099(/A1F/YLMS0100) .
*   受注情報が取得できません
EXIT .
ENDIF .

* 受注伝票の取引先(出荷先)を取得
SELECT SINGLE
KUNNR
ADRNR
INTO (/A1F/YLNS0011-YL_SYKSKCD, A1F_WG_ADRNR_SH)
FROM VBPA
WHERE VBELN = /A1F/YLNS0011-YL_VBELN
AND POSNR = '000000'
AND PARVW = A1F_CNS_PARVW_SHIP .

IF SY-SUBRC = 0 .
A1F_SYKSKCD_OLD = /A1F/YLNS0011-YL_SYKSKCD.
ELSE .
CLEAR A1F_SYKSKCD_OLD .
MESSAGE W096(/A1F/YLMS0100) .
*   出荷先の情報が取得できません
ENDIF .

* 基本数量単位の取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
PERFORM A1F_GET_MEINS USING    /A1F/YLNS0011-YL_MATNR_SALE
CHANGING /A1F/YLNS0011-YL_MEINS.
ENDIF .

ENDFORM.                    " A1F_GET_SALES_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PURCHASE_DATA
*&---------------------------------------------------------------------*
*       発注伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_PURCHASE_DATA.

* 発注伝票情報取得
CLEAR A1F_WG_KNUMV_P .
SELECT SINGLE
K~LIFNR                  "仕入先勘定コード
K~EKORG                  "購買組織
K~EKGRP                  "購買グループ
K~WAERS                  "通貨コード
K~BEDAT                  "購買伝票日付
P~TXZ01                  "テキスト（短）
P~MATNR                  "品目コード
P~WERKS                  "プラント
P~IDNLF                  "仕入先の品目コード
P~MENGE                  "購買発注数量
P~MEINS                  "発注単位
P~NETPR                  "購買伝票における正味価格 (伝票通貨)
P~PEINH                  "価格単位
P~NETWR                  "購買発注通貨による正味発注額
P~EVERS                  "出荷指示
K~KNUMV                  "伝票条件番号
INTO (/A1F/YLNS0011-YL_SIRSKCD,    /A1F/YLNS0011-EKORG,
/A1F/YLNS0011-EKGRP,         /A1F/YLNS0011-YL_HTYUTUK,
/A1F/YLNS0011-YL_BEDAT,      /A1F/YLNS0011-YL_MAKTX_PURC,
/A1F/YLNS0011-YL_MATNR_PURC, /A1F/YLNS0011-YL_DWERK,
/A1F/YLNS0011-YL_IDNLF,      /A1F/YLNS0011-YL_HTYUSU,
/A1F/YLNS0011-YL_BSTME,      /A1F/YLNS0011-YL_HTYUTNK,
/A1F/YLNS0011-YL_PEINH,      /A1F/YLNS0011-YL_HTYUKNGK,
/A1F/YLNS0011-YL_TYKSUKBN,   A1F_WG_KNUMV_P)
FROM EKKO AS K
INNER JOIN EKPO AS P
ON K~EBELN = P~EBELN
WHERE K~EBELN = /A1F/YLNS0011-YL_EBELN
AND P~EBELP = A1F_CNS_NUMBER_P.

IF SY-SUBRC = 0 .
A1F_WG_EKGRP   = /A1F/YLNS0011-EKGRP.
A1F_WG_WERKS_P = /A1F/YLNS0011-YL_DWERK.
ELSE.
MESSAGE S100(/A1F/YLMS0100).
*   発注情報が取得できません
EXIT .
ENDIF .

* 納入日程情報の取得
SELECT SINGLE
EINDT
INTO /A1F/YLNS0011-YL_EEIND
FROM EKET
WHERE EBELN = /A1F/YLNS0011-YL_EBELN
AND EBELP = A1F_CNS_NUMBER_P
AND ETENR = A1F_CNS_COUNTER.

IF SY-SUBRC <> 0 .
MESSAGE S095(/A1F/YLMS0100).
*   納入日程行情報が取得できません
EXIT .
ENDIF .

* 基本数量単位の取得
IF /A1F/YLNS0011-YL_MEINS IS INITIAL .
PERFORM A1F_GET_MEINS USING    /A1F/YLNS0011-YL_MATNR_PURC
CHANGING /A1F/YLNS0011-YL_MEINS.
ENDIF .

* 在庫情報用に受注側の品目コードに発注の品目コードをセット
IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
/A1F/YLNS0011-YL_MATNR_SALE = /A1F/YLNS0011-YL_MATNR_PURC .
ENDIF.

ENDFORM.                    " A1F_GET_PURCHASE_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_MEINS
*&---------------------------------------------------------------------*
*       基本数量単位取得処理
*----------------------------------------------------------------------*
*      -->P_/A1F/YLNS0011_YL_MATNR_SALE  品目コード
*      <--P_/A1F/YLNS0011_YL_MEINS       基本数量単位
*----------------------------------------------------------------------*
FORM A1F_GET_MEINS USING    P_MATNR  TYPE MARA-MATNR
CHANGING P_MEINS  TYPE MARA-MEINS.

SELECT SINGLE
MEINS
INTO P_MEINS
FROM MARA
WHERE MATNR = P_MATNR .

IF SY-SUBRC <> 0 .
MESSAGE W152(/A1F/YLMS0100) WITH P_MATNR.
*   品目コード &1 の品目マスタ：基本ビューが取得できません（マスターエラ
ENDIF .

ENDFORM.                    " A1F_GET_MEINS
** 2009/06/19 INSERT END
