*&---------------------------------------------------------------------*
*& Include /A1F/YLP105MP002TOP                               モジュール*
*&                                                                     *
*&---------------------------------------------------------------------*

PROGRAM  /A1F/YLP105MP002                                            .

TABLES /A1F/YLNS0011 .

*発注データ保持用(初期値取得用）
DATA : A1F_WG_MENGE LIKE EKPO-MENGE,
A1F_WG_EINDT LIKE EKET-EINDT,
A1F_WG_NETPR LIKE EKPO-NETPR,
A1F_WG_TYKSUKBN LIKE EKPO-EVERS.

*受注数量初期保持用
DATA : A1F_GW_KWMENG LIKE VBAP-KWMENG.

*条件タイプ
CONSTANTS :
A1F_CNS_KSCHL    LIKE T685A-KSCHL VALUE 'ZPR0' ,  "得意先品目価格
A1F_CNS_KSCHL_P  LIKE T685A-KSCHL VALUE 'ZPB1' ,  "品目単価(四捨五入)
A1F_CNS_KSCHL_A  LIKE KONV-KSCHL  VALUE 'VPRS' .  "原価

*明細カテゴリ
CONSTANTS :
A1F_CNS_PSTYV_1  LIKE VBAP-PSTYV  VALUE 'TAN' ,   "標準明細
A1F_CNS_PSTYV_2  LIKE VBAP-PSTYV  VALUE 'TAB' ,   "個別購買発注
A1F_CNS_PSTYV_3  LIKE VBAP-PSTYV  VALUE 'ZTAN' ,  "標準明細子会社
A1F_CNS_PSTYV_4  LIKE VBAP-PSTYV  VALUE 'ZTAB' .  "個別購買発注　子

*テキストID
CONSTANTS :
A1F_CNS_ID_SYK   TYPE THEAD-TDID  VALUE '9001' ,  "出荷指示備考
A1F_CNS_ID_NHN   TYPE THEAD-TDID  VALUE '0002' ,  "納品書備考
A1F_CNS_ID_SYNI  TYPE THEAD-TDID  VALUE '0001' ,  "社内備考

A1F_CNS_ID_EDI   TYPE THEAD-TDID  VALUE 'F05'  ,  "EDI用備考
A1F_CNS_ID_SNT   TYPE THEAD-TDID  VALUE 'F06'  ,  "EDIその他
A1F_CNS_ID_TYMN  TYPE THEAD-TDID  VALUE 'F02'  ,  "注文書用備考
A1F_CNS_ID_SMDN  TYPE THEAD-TDID  VALUE 'F07'  ,  "住電EDI備考
A1F_CNS_ID_HTY   TYPE THEAD-TDID  VALUE 'F04'  .  "発注残一覧備考

*取引先機能
CONSTANTS :
A1F_CNS_PARVW_SHIP LIKE VBPA-PARVW VALUE 'WE' .

*明細カテゴリの分別用
RANGES : A1F_RG_PSTYV_TAN FOR VBAP-PSTYV ,                  "#EC NEEDED
A1F_RG_PSTYV_TAB FOR VBAP-PSTYV .                  "#EC NEEDED

*明細番号初期値
CONSTANTS :
A1F_CNS_NUMBER_S LIKE BAPISDITM-ITM_NUMBER VALUE '000010' , "販売
A1F_CNS_NUMBER_P LIKE BAPIMEPOITEM-PO_ITEM VALUE '00010' .  "購買


*納入日程行カウンタ初期値
CONSTANTS :
A1F_CNS_COUNTER  LIKE BAPISCHDL-SCHED_LINE VALUE '0001' .   "購買

*換算レートタイプ
CONSTANTS :
A1F_CNS_RATE_TYPE LIKE BAPI1093_1-RATE_TYPE VALUE 'M' .

*テキストオブジェクト
CONSTANTS :
A1F_CNS_OBJECT_VBBK  TYPE THEAD-TDOBJECT VALUE 'VBBK' ,
A1F_CNS_OBJECT_VBBP  TYPE THEAD-TDOBJECT VALUE 'VBBP' ,
A1F_CNS_OBJECT_EKPO  TYPE THEAD-TDOBJECT VALUE 'EKPO' .

*出荷先の住所番号用ワーク
DATA : A1F_WG_ADRNR_SH     LIKE VBPA-ADRNR ,
A1F_SYKSKCD_OLD     LIKE VBPA-KUNNR .

*出荷先住所内容変更有無管理フラグ
DATA : A1F_FLG_ADDR_CHANGE  TYPE XFLAG .

*変更完了フラグ
DATA : A1F_FLG_SAVE_OK  TYPE C .

DATA : A1F_WG_MBEW LIKE MBEW ,
A1F_WG_T001 LIKE T001 ,
A1F_WG_MARC LIKE MARC ,
A1F_WG_KNA1 LIKE KNA1 ,
A1F_WG_KNVV LIKE KNVV ,                              "#EC NEEDED
A1F_WG_ORDER_HEADER_IN_SIM LIKE BAPISDHEAD ,
A1F_WG_SOLD_TO_PARTY_SIM   LIKE BAPISOLDTO ,         "#EC NEEDED
A1F_WG_SHIP_TO_PARTY_SIM   LIKE BAPISHIPTO ,         "#EC NEEDED
A1F_WG_BILLING_PARTY_SIM   LIKE BAPIPAYER  ,
A1F_WG_RETURN_SIM          LIKE BAPIRETURN .         "#EC NEEDED

DATA :
A1F_TG_ORDER_ITEMS_IN_SIM
LIKE TABLE OF BAPIITEMIN WITH HEADER LINE ,
A1F_TG_ORDER_PARTNERS_SIM
LIKE TABLE OF BAPIPARTNR WITH HEADER LINE ,
A1F_TG_ORDER_SCHEDULE_IN_SIM
LIKE TABLE OF BAPISCHDL  WITH HEADER LINE ,
A1F_TG_ORDER_ITEMS_OUT_SIM
LIKE TABLE OF BAPIITEMEX WITH HEADER LINE ,
A1F_TG_ORDER_SCHEDULE_EX_SIM
LIKE TABLE OF BAPISDHEDU WITH HEADER LINE ,
A1F_TG_ORDER_CONDITION_EX_SIM
LIKE TABLE OF BAPICOND   WITH HEADER LINE ,
A1F_TG_ORDER_INCOMPLETE_SIM
LIKE TABLE OF BAPIINCOMP WITH HEADER LINE ,
A1F_TG_MESSAGETABLE_SIM
LIKE TABLE OF BAPIRET2   WITH HEADER LINE ,
A1F_TG_PARTNERADDRESSES_SIM
LIKE TABLE OF BAPIADDR1  WITH HEADER LINE .

DATA :
A1F_TG_INFORECORD_PURCHORG
LIKE TABLE OF BAPIEINE WITH HEADER LINE .          "#EC NEEDED

DATA : A1F_WG_WARNING_CNT(3) .
DATA : A1F_WG_MASTER_TANKA_SALE LIKE /A1F/YLNS0011-YL_JTYUTNK .
DATA : A1F_WG_MASTER_TANKA_PURC LIKE /A1F/YLNS0011-YL_HTYUTNK .
* Mod ES-UP 2012/09/07 -->
** 出荷先住所変更対応
*TYPES: BEGIN OF SZADR_ADDR1_LINE,
*         NATION LIKE ADRC-NATION,
*         DATA LIKE ADDR1_DATA,
*       END OF SZADR_ADDR1_LINE,
*       BEGIN OF SZADR_ADTEL_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADTEL LIKE ADTEL,
*       END OF SZADR_ADTEL_LINE,
*       BEGIN OF SZADR_ADFAX_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADFAX LIKE ADFAX,
*       END OF SZADR_ADFAX_LINE,
*       BEGIN OF SZADR_ADTTX_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADTTX LIKE ADTTX,
*       END OF SZADR_ADTTX_LINE,
*       BEGIN OF SZADR_ADTLX_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADTLX LIKE ADTLX,
*       END OF SZADR_ADTLX_LINE,
*       BEGIN OF SZADR_ADSMTP_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADSMTP LIKE ADSMTP,
*       END OF SZADR_ADSMTP_LINE,
*       BEGIN OF SZADR_ADRML_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADRML LIKE ADRML,
*       END OF SZADR_ADRML_LINE,
*       BEGIN OF SZADR_ADX400_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADX400 LIKE ADX400,
*       END OF SZADR_ADX400_LINE,
*       BEGIN OF SZADR_ADRFC_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADRFC LIKE ADRFC,
*       END OF SZADR_ADRFC_LINE,
*       BEGIN OF SZADR_ADPRT_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADPRT LIKE ADPRT,
*       END OF SZADR_ADPRT_LINE,
*       BEGIN OF SZADR_ADSSF_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADSSF LIKE ADSSF,
*       END OF SZADR_ADSSF_LINE,
*       BEGIN OF SZADR_ADURI_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADURI LIKE ADURI,
*       END OF SZADR_ADURI_LINE,
*       BEGIN OF SZADR_ADPAG_LINE,
*         DATE_FROM LIKE ADRC-DATE_FROM,
*         ADPAG LIKE ADPAG,
*       END OF SZADR_ADPAG_LINE,
*       BEGIN OF SZADR_ADRCT_LINE,
*         ADDR_REM LIKE ADDR_REM,
*       END OF SZADR_ADRCT_LINE,
*       BEGIN OF SZADR_ADRT_LINE,
*         ADCOMREM LIKE ADCOMREM,
*       END OF SZADR_ADRT_LINE.
*
*
*TYPES: BEGIN OF SZADR_ADDR1_COMPLETE,
*         ADDRNUMBER LIKE ADDR1_SEL-ADDRNUMBER,
*         ADDRHANDLE LIKE ADDR1_SEL-ADDRHANDLE,
*         ADDR1_TAB TYPE SZADR_ADDR1_LINE OCCURS 0,
*         ADTEL_TAB TYPE SZADR_ADTEL_LINE OCCURS 0,
*         ADFAX_TAB TYPE SZADR_ADFAX_LINE OCCURS 0,
*         ADTTX_TAB TYPE SZADR_ADTTX_LINE OCCURS 0,
*         ADTLX_TAB TYPE SZADR_ADTLX_LINE OCCURS 0,
*         ADSMTP_TAB TYPE SZADR_ADSMTP_LINE OCCURS 0,
*         ADRML_TAB TYPE SZADR_ADRML_LINE OCCURS 0,
*         ADX400_TAB TYPE SZADR_ADX400_LINE OCCURS 0,
*         ADRFC_TAB TYPE SZADR_ADRFC_LINE OCCURS 0,
*         ADPRT_TAB TYPE SZADR_ADPRT_LINE OCCURS 0,          "*178i
*         ADSSF_TAB TYPE SZADR_ADSSF_LINE OCCURS 0,          "*178i
*         ADURI_TAB TYPE SZADR_ADURI_LINE OCCURS 0,          "*178i
*         ADPAG_TAB TYPE SZADR_ADPAG_LINE OCCURS 0,          "*178i
*         ADRCT_TAB TYPE SZADR_ADRCT_LINE OCCURS 0,
*         ADRT_TAB TYPE SZADR_ADRT_LINE OCCURS 0,
*    END OF SZADR_ADDR1_COMPLETE.
type-pools szadr.
* Mod ES-UP 2012/09/07 <--

TYPES: BEGIN OF LV09A_ATTRIBUTES_WA,
ABLAD LIKE VBPA-ABLAD,
STCEG LIKE KNA1-STCEG,
STCD1 LIKE VBPAVB-STCD1,
STCD2 LIKE VBPAVB-STCD2,
STCD3 LIKE VBPAVB-STCD3,
STCD4 LIKE VBPAVB-STCD4,
STKZN LIKE VBPAVB-STKZN,
STCDT LIKE VBPAVB-STCDT,
J_1KFREPRE LIKE VBPAVB-J_1KFREPRE,
J_1KFTBUS LIKE VBPAVB-J_1KFTBUS,
J_1KFTIND LIKE VBPAVB-J_1KFTIND         .
TYPES: END OF LV09A_ATTRIBUTES_WA.
DATA A1F_WG_FEF_ATTRIBUTES TYPE LV09A_ATTRIBUTES_WA .
DATA A1F_WG_FES_ADDR1_COMPLETE TYPE SZADR_ADDR1_COMPLETE .
DATA A1F_WG_FES_VBADR TYPE VBADR .                          "#EC NEEDED

* ワーク
DATA : A1F_WG_EKGRP       TYPE EKKO-EKGRP,
A1F_WG_WERKS_P     TYPE EKPO-WERKS,
A1F_WG_WERKS_S     TYPE VBAP-WERKS,
A1F_WG_VKBUR       TYPE VBAK-VKBUR,
A1F_WG_VKGRP       TYPE VBAK-VKGRP.

DATA A1F_WG_ADDR1_OUT LIKE ADDR1_DATA .

* パラメータIDイニシャル用項目
DATA : A1F_VBELN_INI  TYPE VBAK-VBELN ,
A1F_EBELN_INI  TYPE EKKO-EBELN .

* GUIステータス用ワーク
TYPES : BEGIN OF TAB_TYPE,
FCODE LIKE RSMPE-FUNC,
END   OF TAB_TYPE.

DATA : A1F_TG_TAB TYPE STANDARD TABLE OF TAB_TYPE ,
A1F_WG_TAB TYPE                   TAB_TYPE .

DATA : A1F_WG_KNUMV_S     TYPE KONV-KNUMV ,
A1F_WG_KNUMV_P     TYPE KONV-KNUMV .

*>>> 【ES-UP】課題№241 2013/01/10
data: i_ekpo_F02 type table of TLINE, "注文書備考(購買発注テキスト)
i_ekpo_F04 type table of TLINE, "発注残一覧備考
i_ekpo_F05 type table of TLINE, "EDI備考(購買情報注記)
i_ekpo_F06 type table of TLINE, "EDI送信用(その他)
i_ekpo_F07 type table of TLINE. "住電試験書区分
*<<< 【ES-UP】課題№241 2013/01/10

* DMW1823 受注変更時条件単位が変更になってしまう不具合対応
DATA : A1F_WG_KMEIN TYPE VBAP-KMEIN.

LOAD-OF-PROGRAM.
* 初期化
CLEAR : A1F_RG_PSTYV_TAB,
A1F_RG_PSTYV_TAN.
REFRESH : A1F_RG_PSTYV_TAB,
A1F_RG_PSTYV_TAN.

* 明細カテゴリ初期値設定
A1F_RG_PSTYV_TAB-SIGN = 'I' .
A1F_RG_PSTYV_TAB-OPTION = 'EQ' .
A1F_RG_PSTYV_TAB-LOW = 'TAB' .                  "個別購買発注
APPEND A1F_RG_PSTYV_TAB.
A1F_RG_PSTYV_TAB-LOW = 'ZTAB' .                 "個別購買発注　子
APPEND A1F_RG_PSTYV_TAB.

A1F_RG_PSTYV_TAN-SIGN = 'I' .
A1F_RG_PSTYV_TAN-OPTION = 'EQ' .
A1F_RG_PSTYV_TAN-LOW = 'TAN' .                  "標準明細
APPEND A1F_RG_PSTYV_TAN.
A1F_RG_PSTYV_TAN-LOW = 'ZTAN' .                 "標準明細子会社
APPEND A1F_RG_PSTYV_TAN.

* 項目パラメータ取得
IF /A1F/YLNS0011-BUKRS IS INITIAL .             "会社コード
GET PARAMETER ID 'BUK' FIELD /A1F/YLNS0011-BUKRS.
ENDIF .

* 会社情報取得
SELECT SINGLE * FROM  T001
INTO A1F_WG_T001
WHERE  BUKRS  = /A1F/YLNS0011-BUKRS.
IF SY-SUBRC NE 0 .
MESSAGE E200(/A1F/YLMS0100) WITH /A1F/YLNS0011-BUKRS .
*   システムエラー：会社コードデータ（&1）が取得できませんでした。
ENDIF .

* 受注通貨にセット
/A1F/YLNS0011-YL_WAERS = A1F_WG_T001-WAERS .

* 実行元確認
IF SY-TCODE = 'YLP105MP003_LINK' .
GET PARAMETER ID 'ZVBN' FIELD /A1F/YLNS0011-YL_VBELN.
GET PARAMETER ID 'ZEBN' FIELD /A1F/YLNS0011-YL_EBELN.

PERFORM A1F_GET_DATA_9000 .
PERFORM A1F_CALCULATION_SALES_AMOUNT .      " 販売金額の計算

PERFORM A1F_GET_STOCK_INFO .                " 在庫情報の取得

IF NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .
SELECT SINGLE NAME1 FROM  KNA1
INTO /A1F/YLNS0011-YL_SYKSKNM
WHERE  KUNNR  = /A1F/YLNS0011-YL_SYKSKCD.
ENDIF .
ENDIF .
