*&---------------------------------------------------------------------*
*&  INCLUDE           /A1F/YLP105MP002F01                              *
*&[改定履歴]
*& YYYY/MM/DD  Programar         Description
*& 2012/09/07  ISID              ES-UP
*&---------------------------------------------------------------------*
*&---------------------------------------------------------------------*
*&      Form  a1f_get_stock_info
*&---------------------------------------------------------------------*
*       在庫情報取得処理
*----------------------------------------------------------------------*
FORM A1F_GET_STOCK_INFO .

DATA : A1F_WL_ECRPES LIKE CRPES ,
A1F_WL_IMT61D LIKE MT61D .                         "#EC NEEDED
DATA : A1F_TL_MDPSX LIKE TABLE OF MDPS WITH HEADER LINE ,
A1F_TL_MDEZX LIKE TABLE OF MDEZ WITH HEADER LINE ,
A1F_TL_MDSUX LIKE TABLE OF MDSU WITH HEADER LINE ,
A1F_TL_PLAFM LIKE TABLE OF PLAF WITH HEADER LINE ,
A1F_TL_PLAFD LIKE TABLE OF PLAF WITH HEADER LINE ,
A1F_TL_MDFAM LIKE TABLE OF MDFA WITH HEADER LINE ,
A1F_TL_MDFAD LIKE TABLE OF MDFA WITH HEADER LINE ,
A1F_TL_MDRSM LIKE TABLE OF MDRS WITH HEADER LINE ,
A1F_TL_MDRSD LIKE TABLE OF MDRS WITH HEADER LINE .

IF /A1F/YLNS0011-YL_DWERK IS INITIAL OR
/A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
EXIT .
ENDIF .

A1F_WL_ECRPES-KZUMT = 'X' .
* Ins ES-UP 2013/01/15 --->
CALL FUNCTION 'Z_PRE_MD_ABBL_REPORTING'.
* Ins ES-UP 2013/01/15 <---
* Mod ES-UP 2012/09/07 -->
*  CALL FUNCTION 'Y_MD_ABBL_REPORTING'
CALL FUNCTION 'MD_ABBL_REPORTING'
* Mod ES-UP 2012/09/07 <--
EXPORTING
EMATNR          = /A1F/YLNS0011-YL_MATNR_SALE
EWERKS          = /A1F/YLNS0011-YL_DWERK
ECRPES          = A1F_WL_ECRPES
IMPORTING
IMT61D          = A1F_WL_IMT61D
TABLES
MDPSX           = A1F_TL_MDPSX
MDEZX           = A1F_TL_MDEZX
MDSUX           = A1F_TL_MDSUX
PLAFM           = A1F_TL_PLAFM
PLAFD           = A1F_TL_PLAFD
MDFAM           = A1F_TL_MDFAM
MDFAD           = A1F_TL_MDFAD
MDRSM           = A1F_TL_MDRSM
MDRSD           = A1F_TL_MDRSD
EXCEPTIONS
ERROR_MATMASTER = 1
OTHERS          = 2.

IF SY-SUBRC <> 0.
MESSAGE E161(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK .
*   品目コード &1 プラント &2 在庫情報の取得が出来ません
ENDIF.

* 手元在庫の設定
READ TABLE A1F_TL_MDPSX WITH KEY DELKZ = 'WB' .
IF SY-SUBRC = 0 .
/A1F/YLNS0011-YL_TMTZIK = A1F_TL_MDPSX-MNG01 .
ELSE .
MESSAGE E161(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK .
*   品目コード &1 プラント &2 在庫情報の取得が出来ません
ENDIF .

CLEAR : /A1F/YLNS0011-YL_JTYUGUKI ,
/A1F/YLNS0011-YL_HTYUGUKI .
LOOP AT A1F_TL_MDPSX
WHERE KNTTP = SPACE.
*   受注数量合計の設定
IF A1F_TL_MDPSX-DELKZ = 'MB'      "出庫
OR A1F_TL_MDPSX-DELKZ = 'VC'   "指図
OR A1F_TL_MDPSX-DELKZ = 'VJ'   "納入
OR A1F_TL_MDPSX-DELKZ = 'WA' . "出庫
/A1F/YLNS0011-YL_JTYUGUKI = /A1F/YLNS0011-YL_JTYUGUKI
+ A1F_TL_MDPSX-MNG01 .
ENDIF .
*   発注数量合計の設定
IF A1F_TL_MDPSX-DELKZ = 'BE'      "購買発注明細日程計画行
OR A1F_TL_MDPSX-DELKZ = 'E1'   "外注発注
OR A1F_TL_MDPSX-DELKZ = 'LA'   "出荷通知
OR A1F_TL_MDPSX-DELKZ = 'MR'   "入出庫予定
OR A1F_TL_MDPSX-DELKZ = 'VH'   "得意先からの受託品/預託品の戻り
OR A1F_TL_MDPSX-DELKZ = 'VT'   "返品 (利用可能在庫確認)
OR A1F_TL_MDPSX-DELKZ = 'WE' . "入庫
/A1F/YLNS0011-YL_HTYUGUKI = /A1F/YLNS0011-YL_HTYUGUKI
+ A1F_TL_MDPSX-MNG01 .
ENDIF .

IF A1F_TL_MDPSX-DELKZ = 'RP' . "返品明細
/A1F/YLNS0011-YL_HTYUGUKI = /A1F/YLNS0011-YL_HTYUGUKI
- A1F_TL_MDPSX-MNG01 .
ENDIF .
ENDLOOP .

* 未引当在庫の計算
/A1F/YLNS0011-YL_MHKATZIK = /A1F/YLNS0011-YL_TMTZIK
+ /A1F/YLNS0011-YL_HTYUGUKI
- /A1F/YLNS0011-YL_JTYUGUKI .

* 総在庫数の計算
/A1F/YLNS0011-YL_SUZIKSU = /A1F/YLNS0011-YL_TMTZIK
+ /A1F/YLNS0011-YL_HTYUGUKI .

*  IF /A1F/YLNS0011-YL_VBELN IS INITIAL
*     AND /A1F/YLNS0011-YL_EBELN IS INITIAL .

* 発注後未引当在庫の計算
* 2009/10/26 変更時の引当数量計算方法変更
* 発注後=未引当数量-画面上の受注数量+従来の受注数量

/A1F/YLNS0011-YL_HTYUGSU = /A1F/YLNS0011-YL_MHKATZIK
- /A1F/YLNS0011-YL_JTYUSU
+ A1F_GW_KWMENG.
*  ENDIF .

ENDFORM.                    " a1f_get_stock_info
*&---------------------------------------------------------------------*
*&      Form  a1f_set_cursor_9000_001
*&---------------------------------------------------------------------*
*       カーソル設定(受注伝票情報)
*----------------------------------------------------------------------*
FORM A1F_SET_CURSOR_9000_001 .

* 得意先発注番号
IF /A1F/YLNS0011-YL_BSTKD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTKD'.
EXIT .
ENDIF .

* 得意先品目テキスト
IF /A1F/YLNS0011-YL_POSTX IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_POSTX'.
EXIT .
ENDIF .

* 受注日付
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_AUDAT'.
EXIT .
ENDIF .

* 受注数量
IF /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_JTYUSU'.
EXIT .
ENDIF .

* 指定出荷日付
IF /A1F/YLNS0011-YL_VDATU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_VDATU'.
EXIT .
ENDIF .

* 出荷先コード
IF /A1F/YLNS0011-YL_SYKSKCD IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_SYKSKCD'.
EXIT .
ENDIF .

* 価格単位数量(販売)
IF /A1F/YLNS0011-YL_KPEIN IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_KPEIN'.
EXIT .
ENDIF .

ENDFORM.                    " a1f_set_cursor_9000_001
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_INITIAL_DATA
*&---------------------------------------------------------------------*
*       表示データ取得
*----------------------------------------------------------------------*
FORM A1F_GET_INITIAL_DATA .

*ローカル定義
DATA : A1F_TH_INLINES TYPE TLINE ,
A1F_TD_INLINES TYPE TABLE OF TLINE .

DATA : A1F_WL_NAME    TYPE THEAD-TDNAME.


IF NOT ( /A1F/YLNS0011-YL_TKISKCD IS INITIAL ) .
*   得意先名称取得
SELECT SINGLE
NAME1
INTO /A1F/YLNS0011-YL_TKISKNM
FROM KNA1
WHERE KUNNR = /A1F/YLNS0011-YL_TKISKCD .
IF SY-SUBRC <> 0 .
MESSAGE W097(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_TKISKCD .
*     得意先 &1 の名称が取得できません
ENDIF .

*   得意先マスタ：販売ビューの取得
SELECT SINGLE * FROM  KNVV
INTO A1F_WG_KNVV
WHERE  KUNNR  = /A1F/YLNS0011-YL_TKISKCD
AND  VKORG  = /A1F/YLNS0011-VKORG
AND  VTWEG  = /A1F/YLNS0011-VTWEG
AND  SPART  = /A1F/YLNS0011-SPART.
IF SY-SUBRC NE 0 .
MESSAGE W155(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_TKISKCD .
*     得意先マスタ &1 の販売データが取得できません（マスターエラー）
ENDIF .

*   品目テキストの取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
SELECT SINGLE MAKTX FROM  MAKT
*             INTO /A1F/YLNS0011-YL_MAKTX_SALE
INTO /A1F/YLNS0011-YL_POSTX
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    SPRAS  = SY-LANGU.
IF SY-SUBRC NE 0 .
MESSAGE W151(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_MATNR_SALE
SY-LANGU .
*       品目コード &1 言語 &2 の品目テキストは登録されていません。
ENDIF .
ENDIF .

*   品目マスタ：会計ビューの取得
SELECT * FROM  MBEW
INTO A1F_WG_MBEW
UP TO 1 ROWS
WHERE MATNR = /A1F/YLNS0011-YL_MATNR_SALE
AND BWKEY = /A1F/YLNS0011-YL_DWERK .
ENDSELECT .
IF SY-SUBRC NE 0 .
MESSAGE W158(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
*     品目コード &1 プラント &2 会計ビューが
*     取得できません（マスターエラー）
ENDIF .

*   BAPIによる受注関連データの取得
CLEAR : A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM .

A1F_WG_ORDER_HEADER_IN_SIM-DOC_TYPE   = /A1F/YLNS0011-YL_AUART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_ORG  = /A1F/YLNS0011-VKORG .
A1F_WG_ORDER_HEADER_IN_SIM-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
A1F_WG_ORDER_HEADER_IN_SIM-DIVISION   = /A1F/YLNS0011-SPART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_GRP  = /A1F/YLNS0011-VKGRP .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_OFF  = /A1F/YLNS0011-VKBUR .
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = SY-DATUM .
ELSE .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
ENDIF .

CLEAR A1F_TG_ORDER_PARTNERS_SIM .
REFRESH A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'SP' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .
A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
*>>> ES-UP mod 2013/01/08 課題№239
*    A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = 1.
*>>> ES-UP mod 2013/01/08 課題№239
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CALL FUNCTION 'BAPI_SALESORDER_SIMULATE'
EXPORTING
ORDER_HEADER_IN     = A1F_WG_ORDER_HEADER_IN_SIM
CONVERT_PARVW_AUART = 'X'
IMPORTING
BILLING_PARTY       = A1F_WG_BILLING_PARTY_SIM
RETURN              = A1F_WG_RETURN_SIM
TABLES
ORDER_ITEMS_IN      = A1F_TG_ORDER_ITEMS_IN_SIM
ORDER_PARTNERS      = A1F_TG_ORDER_PARTNERS_SIM.

LOOP AT A1F_TG_MESSAGETABLE_SIM .
MESSAGE ID A1F_TG_MESSAGETABLE_SIM-ID
TYPE A1F_TG_MESSAGETABLE_SIM-TYPE
NUMBER A1F_TG_MESSAGETABLE_SIM-NUMBER
WITH A1F_TG_MESSAGETABLE_SIM-MESSAGE_V1
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V2
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V3
A1F_TG_MESSAGETABLE_SIM-MESSAGE_V4 .
ENDLOOP .

*   与信金額（売上額）の取得
PERFORM  A1F_EXIT_GET_SAUFT  CHANGING  A1F_WG_BILLING_PARTY_SIM .

*   更新タイプの設定
/A1F/YLNS0011-YL_KUSNTYP = TEXT-100. "受注照会' .

*   明細カテゴリタイプの設定
CASE /A1F/YLNS0011-YL_MISIKTGRTYP .
WHEN A1F_CNS_PSTYV_2 OR
A1F_CNS_PSTYV_4 .
/A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110 . "個別購買発注' .
WHEN A1F_CNS_PSTYV_1 OR
A1F_CNS_PSTYV_3 .
/A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 . "在庫品' .
ENDCASE .

*   与信限度額の設定
**** START ADD 2014/11/12 ISID11 ****
*   与信通貨コード
SELECT SINGLE WAERS
INTO /A1F/YLNS0011-YL_YSNWAERS
FROM T014
WHERE KKBER = A1F_WG_BILLING_PARTY_SIM-C_CTR_AREA.
**** END ADD 2014/11/12 ISID11 ****
*  CRED_LIMIT 得意先与信限度額
/A1F/YLNS0011-YL_YSNGK = A1F_WG_BILLING_PARTY_SIM-CRED_LIMIT .
*   与信残高の設定
*  ORDER_VALS 与信限度チェックにおける売上金額合計
*  RCVBL_VALS 債権合計 (与信限度チェック用)
*  CRED_LIAB  与信限度チェックのための関連特殊仕訳債権額
/A1F/YLNS0011-YL_YSNZNDK = A1F_WG_BILLING_PARTY_SIM-CRED_LIMIT
- A1F_WG_BILLING_PARTY_SIM-ORDER_VALS
- A1F_WG_BILLING_PARTY_SIM-RCVBL_VALS
- A1F_WG_BILLING_PARTY_SIM-CRED_LIAB .

*   テキスト名作成(受注伝票用)
A1F_WL_NAME = /A1F/YLNS0011-YL_VBELN .

*   納品書備考の取得
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_NHN
A1F_CNS_OBJECT_VBBK
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_NUHNSYBKU = A1F_TH_INLINES-TDLINE .

*   社内備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SYNI
A1F_CNS_OBJECT_VBBK
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_SYNIBKU = A1F_TH_INLINES-TDLINE .

*   テキスト名作成(受注伝票明細用)
CONCATENATE /A1F/YLNS0011-YL_VBELN
A1F_CNS_NUMBER_S
INTO A1F_WL_NAME .

*   出荷指示備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SYK
A1F_CNS_OBJECT_VBBP
A1F_WL_NAME.

READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_SYKSJBKU = A1F_TH_INLINES-TDLINE .
ENDIF .

** 発注通貨INFORECORD_PURCHORG-CURRENCY
*  /A1F/YLNS0011-YL_HTYUTUK = A1F_WG_T001-WAERS .

IF NOT ( /A1F/YLNS0011-YL_SIRSKCD IS INITIAL ) .
*   仕入先名の取得
SELECT SINGLE
NAME1
INTO /A1F/YLNS0011-YL_SIRSKNM
FROM LFA1
WHERE LIFNR = /A1F/YLNS0011-YL_SIRSKCD .
IF SY-SUBRC <> 0 .
MESSAGE W094(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_SIRSKCD.
*     仕入先 &1 の名称が取得できません
ENDIF .

*   無商品判定
IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
/A1F/YLNS0011-YL_MSYUFLG = 'X' .
ELSE .
CLEAR /A1F/YLNS0011-YL_MSYUFLG .
ENDIF.

*   テキスト名作成(購買伝票用)
CONCATENATE /A1F/YLNS0011-YL_EBELN
A1F_CNS_NUMBER_P
INTO A1F_WL_NAME .

*   EDI用備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_EDI
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.
*>>> 【ES-UP】課題№241 2013/01/10
CLEAR I_EKPO_F05.
APPEND LINES OF A1F_TD_INLINES TO I_EKPO_F05.
*<<< 【ES-UP】課題№241 2013/01/10
READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_EDIBKU = A1F_TH_INLINES-TDLINE .
CLEAR A1F_TH_INLINES.

READ TABLE A1F_TD_INLINES INDEX 2 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_EDIBKU2 = A1F_TH_INLINES-TDLINE .

*   EDI用その他の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SNT
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.
*>>> 【ES-UP】課題№241 2013/01/10
CLEAR I_EKPO_F06.
APPEND LINES OF A1F_TD_INLINES TO I_EKPO_F06.
*<<< 【ES-UP】課題№241 2013/01/10
READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_EDISNT = A1F_TH_INLINES-TDLINE .

*   注文書用備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_TYMN
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.
*>>> 【ES-UP】課題№241 2013/01/10
CLEAR I_EKPO_F02.
APPEND LINES OF A1F_TD_INLINES TO I_EKPO_F02.
*<<< 【ES-UP】課題№241 2013/01/10
READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_TUMNSYBKU = A1F_TH_INLINES-TDLINE .

*   住電EDI備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_SMDN
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.
*>>> 【ES-UP】課題№241 2013/01/10
CLEAR I_EKPO_F07.
APPEND LINES OF A1F_TD_INLINES TO I_EKPO_F07.
*<<< 【ES-UP】課題№241 2013/01/10
READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_SMDNEDIBKU = A1F_TH_INLINES-TDLINE .

*   発注残一覧備考の取得
CLEAR   A1F_TH_INLINES .
REFRESH A1F_TD_INLINES .
PERFORM  A1F_READ_TEXT  TABLES  A1F_TD_INLINES
USING   A1F_CNS_ID_HTY
A1F_CNS_OBJECT_EKPO
A1F_WL_NAME.
*>>> 【ES-UP】課題№241 2013/01/10
CLEAR I_EKPO_F04.
APPEND LINES OF A1F_TD_INLINES TO I_EKPO_F04.
*<<< 【ES-UP】課題№241 2013/01/10
READ TABLE A1F_TD_INLINES INDEX 1 INTO A1F_TH_INLINES .
/A1F/YLNS0011-YL_HTYUZNITRNBKU = A1F_TH_INLINES-TDLINE .
ENDIF.

ENDFORM.                    " a1f_get_initial_data
*&---------------------------------------------------------------------*
*&      Form  a1f_set_cursor_9000_002
*&---------------------------------------------------------------------*
*       カーソル設定(発注伝票表示)
*----------------------------------------------------------------------*
FORM A1F_SET_CURSOR_9000_002 .

* プラントの設定
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
/A1F/YLNS0011-YL_DWERK = A1F_WG_WERKS_S .
ENDIF .
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK' .
MESSAGE E207(/A1F/YLMS0100) .
*   プラントが未入力です
ENDIF .


* 購買グループ
IF /A1F/YLNS0011-EKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP'.
EXIT .
ENDIF .

* 納入日付
IF /A1F/YLNS0011-YL_EEIND IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_EEIND'.
EXIT .
ENDIF .

* 品目テキスト
IF /A1F/YLNS0011-YL_MAKTX_PURC IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_MAKTX_PURC'.
EXIT .
ENDIF .

* 仕入先品目コード
IF /A1F/YLNS0011-YL_IDNLF IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_IDNLF'.
EXIT .
ENDIF .

* 発注数量
IF /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_HTYUSU'.
EXIT .
ENDIF .

* 発注単価
IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_HTYUTNK'.
EXIT .
ENDIF .

* 価格単位数量
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME'.
EXIT .
ENDIF .

ENDFORM.                    " a1f_set_cursor_9000_002
*&---------------------------------------------------------------------*
*&      Form  A1F_Calculation_sales_Amount
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALCULATION_SALES_AMOUNT .

DATA : A1F_WL_T685A LIKE T685A .
DATA : A1F_WL_NETWR TYPE P DECIMALS 6 .

*  IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL
*    OR /A1F/YLNS0011-YL_TKISKCD IS INITIAL .
*    EXIT .
*  ENDIF .

* 販売金額の計算
IF NOT ( /A1F/YLNS0011-YL_JTYUTNK IS INITIAL ) .
IF /A1F/YLNS0011-YL_KPEIN IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_KPEIN' .
MESSAGE E177(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_KPEIN NE 100
AND /A1F/YLNS0011-YL_KPEIN NE 1000
AND /A1F/YLNS0011-YL_KPEIN NE 10000
AND /A1F/YLNS0011-YL_KPEIN NE 1 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_KPEIN' .
MESSAGE E178(/A1F/YLMS0100) .
ENDIF .
SELECT SINGLE * FROM  T685A
INTO A1F_WL_T685A
WHERE  KAPPL  = 'V'
AND    KSCHL  = A1F_CNS_KSCHL.
IF SY-SUBRC NE 0 .
MESSAGE E160(/A1F/YLMS0100) WITH A1F_CNS_KSCHL.
*     条件タイプ &1 のマスタが取得できません。
ENDIF .

IF A1F_WL_T685A-TXPRF = SPACE . "四捨五入
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_JTYUTNK /
/A1F/YLNS0011-YL_KPEIN )
* /A1F/YLNS0011-YL_JTYUSU ) .
ELSEIF A1F_WL_T685A-TXPRF = 'A' . "切上
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_JTYUTNK /
/A1F/YLNS0011-YL_KPEIN )
* /A1F/YLNS0011-YL_JTYUSU ) + '0.005' .
ELSEIF A1F_WL_T685A-TXPRF = 'B' . "切捨て
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_JTYUTNK /
/A1F/YLNS0011-YL_KPEIN )
* /A1F/YLNS0011-YL_JTYUSU ) - '0.005' .
ENDIF .
ENDIF .

* 売上金額
/A1F/YLNS0011-YL_JYYUKNGK = A1F_WL_NETWR .
DATA : A1F_WL_EXCH_RATE LIKE BAPI1093_0 ,
A1F_WL_RETURN_EXCH LIKE BAPIRET1 .
* 売上金額（国内通貨）
IF /A1F/YLNS0011-YL_JTYTUK NE /A1F/YLNS0011-YL_WAERS
AND NOT ( /A1F/YLNS0011-YL_JYYUKNGK IS INITIAL ) .
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_JTYTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
**** START UPD 2014/09/12 ISID11 ****
*    IF SY-SUBRC NE 0
*      OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
IF A1F_WL_RETURN_EXCH-TYPE = 'E' .
**** END UPD 2014/09/12 ISID11 ****
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
MESSAGE E202(/A1F/YLMS0100) WITH A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_JTYTUK
/A1F/YLNS0011-YL_WAERS.
*     換算レートの取得に失敗しました。（Type &1 From &2 To &3）
ENDIF .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK
* A1F_WL_EXCH_RATE-EXCH_RATE.
ELSE .
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
ENDIF .

** 売上原価（2009/08/24 : 伝票から取得するよう変更）本ロジックC/O
*  IF NOT ( /A1F/YLNS0011-YL_JTYUSU IS INITIAL ) .
*   /A1F/YLNS0011-YL_URAGGNK = ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
*                                            * /A1F/YLNS0011-YL_JTYUSU.
*  ENDIF .

* 粗利
/A1F/YLNS0011-YL_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C -
/A1F/YLNS0011-YL_URAGGNK .

* 購買金額の計算
IF /A1F/YLNS0011-YL_MSYUFLG NE SPACE .
CLEAR /A1F/YLNS0011-YL_HTYUTNK .
ENDIF .

CLEAR A1F_WL_NETWR .
IF NOT ( /A1F/YLNS0011-YL_HTYUTNK IS INITIAL ) .
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_PEINH' .
MESSAGE E194(/A1F/YLMS0100) .
ELSEIF /A1F/YLNS0011-YL_PEINH NE 100
AND /A1F/YLNS0011-YL_PEINH NE 1000
AND /A1F/YLNS0011-YL_PEINH NE 10000
AND /A1F/YLNS0011-YL_PEINH NE 1 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_PEINH' .
MESSAGE E195(/A1F/YLMS0100) .
ENDIF .
SELECT SINGLE * FROM  T685A
INTO A1F_WL_T685A
WHERE  KAPPL  = 'M'
AND    KSCHL  = A1F_CNS_KSCHL_P.
IF SY-SUBRC NE 0 .
MESSAGE E160(/A1F/YLMS0100) WITH A1F_CNS_KSCHL_P.
*     条件タイプ &1 のマスタが取得できません。
ENDIF .

IF A1F_WL_T685A-TXPRF = SPACE . "四捨五入
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) .
ELSEIF A1F_WL_T685A-TXPRF = 'A' . "切上
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) + '0.005' .
ELSEIF A1F_WL_T685A-TXPRF = 'B' . "切捨て
A1F_WL_NETWR = ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* /A1F/YLNS0011-YL_HTYUSU ) - '0.005' .
ENDIF .
ENDIF .

* 発注金額
/A1F/YLNS0011-YL_HTYUKNGK = A1F_WL_NETWR .
* 購買金額（国内通貨）
IF /A1F/YLNS0011-YL_HTYUTUK NE /A1F/YLNS0011-YL_WAERS
AND NOT ( /A1F/YLNS0011-YL_HTYUKNGK IS INITIAL ) .
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_HTYUTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
**** START UPD 2014/09/12 ISID11 ****
*    IF SY-SUBRC NE 0
*      OR A1F_WL_RETURN_EXCH-TYPE = 'E' .
IF A1F_WL_RETURN_EXCH-TYPE = 'E' .
**** END UPD 2014/09/12 ISID11 ****
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK .
MESSAGE E202(/A1F/YLMS0100) WITH A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_HTYUTUK
/A1F/YLNS0011-YL_WAERS.
*     換算レートの取得に失敗しました。（Type &1 From &2 To &3）
ENDIF .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK
* A1F_WL_EXCH_RATE-EXCH_RATE.
ELSE .
/A1F/YLNS0011-YL_HTYUKNGK_C = /A1F/YLNS0011-YL_HTYUKNGK .
ENDIF .

DATA : A1F_WL_MARM LIKE MARM .

* 販売数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_VRKME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
/A1F/YLNS0011-YL_JTYUSU_C = /A1F/YLNS0011-YL_JTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    MEINH  = /A1F/YLNS0011-YL_VRKME .
IF SY-SUBRC NE 0 .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_VRKME.
ENDIF .

/A1F/YLNS0011-YL_JTYUSU_C = ( /A1F/YLNS0011-YL_JTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

* 購買数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_HTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME .
ENDIF .

/A1F/YLNS0011-YL_HTYUSU_C = ( /A1F/YLNS0011-YL_HTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " A1F_Calculation_sales_Amount
*&---------------------------------------------------------------------*
*&      Form  A1F_CALCULATION_Purc_AMOUNT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALCULATION_PURC_AMOUNT .

DATA : A1F_WL_MARM LIKE MARM .

IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 .
ELSE .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_JTYUSU_C .
ENDIF .

* 基本数量単位から発注単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU_C IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU = /A1F/YLNS0011-YL_HTYUSU_C .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME' .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME.
ENDIF .

/A1F/YLNS0011-YL_HTYUSU = ( /A1F/YLNS0011-YL_HTYUSU_C
* A1F_WL_MARM-UMREN )
/ A1F_WL_MARM-UMREZ .
ENDIF .


ENDFORM.                    " A1F_CALCULATION_Purc_AMOUNT
*&---------------------------------------------------------------------*
*&      Form  a1f_clear_all
*&---------------------------------------------------------------------*
*       画面項目初期化
*----------------------------------------------------------------------*
FORM A1F_CLEAR_ALL .

* ロック解除
PERFORM  A1F_SALES_DATA_UNLOCK     USING /A1F/YLNS0011-YL_VBELN .
PERFORM  A1F_PURCHASE_DATA_UNLOCK  USING /A1F/YLNS0011-YL_EBELN .

CLEAR: /A1F/YLNS0011-VKBUR,               "営業所
/A1F/YLNS0011-VKGRP,               "営業グループ
/A1F/YLNS0011-YL_DWERK,            "プラント
/A1F/YLNS0011-EKGRP,               "購買グループ
/A1F/YLNS0011-YL_AUART,            "受注タイプ
/A1F/YLNS0011-YL_BSTKD,            "得意先発注番号
/A1F/YLNS0011-YL_KDMAT,            "得意先品目コード
/A1F/YLNS0011-YL_POSTX,            "得意先品目テキスト
/A1F/YLNS0011-YL_AUDAT,            "受注日付
/A1F/YLNS0011-YL_MATNR_SALE,       "品目コード
/A1F/YLNS0011-YL_MAKTX_SALE,       "品目テキスト
/A1F/YLNS0011-YL_JTYUSU,           "受注数量
/A1F/YLNS0011-YL_VDATU,            "出荷指定日付
/A1F/YLNS0011-YL_KUSNTYP,          "更新タイプ
/A1F/YLNS0011-YL_MISIKTGRTYP,      "明細カテゴリタイプ
/A1F/YLNS0011-YL_TKISKCD,          "得意先コード
/A1F/YLNS0011-YL_SYKSKCD,          "出荷先コード
/A1F/YLNS0011-YL_VBELN,            "受注伝票番号
**** START ADD 2014/11/12 ISID11 ****
/A1F/YLNS0011-YL_YSNWAERS,
**** END ADD 2014/11/12 ISID11 ****
/A1F/YLNS0011-YL_YSNGK,            "与信額
/A1F/YLNS0011-YL_YSNZNDK,          "与信残高
/A1F/YLNS0011-YL_TKISKNM,          "得意先名
/A1F/YLNS0011-YL_LIFSK,            "出荷ブロック
/A1F/YLNS0011-YL_KPEIN,            "Per(受注)
/A1F/YLNS0011-YL_VRKME,            "単位(受注)
/A1F/YLNS0011-YL_JTYUTNK,          "受注単価
/A1F/YLNS0011-YL_JYYUKNGK,         "受注金額
/A1F/YLNS0011-YL_JTYTUK,           "受注通貨
/A1F/YLNS0011-YL_URAGGNK,
/A1F/YLNS0011-YL_ARARI,
/A1F/YLNS0011-YL_SYKSJBKU,
/A1F/YLNS0011-YL_NUHNSYBKU,
/A1F/YLNS0011-YL_SYNIBKU,
/A1F/YLNS0011-YL_TMTZIK,
/A1F/YLNS0011-YL_JTYUGUKI,
/A1F/YLNS0011-YL_HTYUGUKI,
/A1F/YLNS0011-YL_SUZIKSU,
/A1F/YLNS0011-YL_HTYUGSU,
/A1F/YLNS0011-YL_MHKATZIK,
/A1F/YLNS0011-YL_MEINS,
/A1F/YLNS0011-YL_SIRSKCD,
/A1F/YLNS0011-YL_SIRSKNM,
/A1F/YLNS0011-YL_BEDAT,
/A1F/YLNS0011-YL_EEIND,
/A1F/YLNS0011-YL_HTYUNSKBN,
/A1F/YLNS0011-YL_EBELN,
/A1F/YLNS0011-YL_MATNR_PURC,
/A1F/YLNS0011-YL_MAKTX_PURC,
/A1F/YLNS0011-YL_IDNLF,
/A1F/YLNS0011-YL_TXZ01,
/A1F/YLNS0011-YL_HTYUSU,
/A1F/YLNS0011-YL_BSTME,
/A1F/YLNS0011-YL_HTYUTNK,
/A1F/YLNS0011-YL_HTYUKNGK,
/A1F/YLNS0011-YL_HTYUTUK,
/A1F/YLNS0011-YL_PEINH,
/A1F/YLNS0011-YL_EDIBKU,
/A1F/YLNS0011-YL_EDIBKU2,
/A1F/YLNS0011-YL_EDISNT,
/A1F/YLNS0011-YL_TUMNSYBKU,
/A1F/YLNS0011-YL_SMDNEDIBKU,
/A1F/YLNS0011-YL_HTYUZNITRNBKU ,
/A1F/YLNS0011-YL_MSYUFLG ,
/A1F/YLNS0011-YL_TYKSUKBN ,
/A1F/YLNS0011-YL_SYKSKNM ,
/A1F/YLNS0011-YL_TKISKHCDT .

CLEAR : A1F_WG_MBEW ,
A1F_WG_T001 ,
A1F_WG_KNA1 ,
A1F_WG_KNVV ,
A1F_WG_ORDER_HEADER_IN_SIM ,
A1F_WG_SOLD_TO_PARTY_SIM ,
A1F_WG_SHIP_TO_PARTY_SIM ,
A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM .

CLEAR : A1F_TG_ORDER_ITEMS_IN_SIM ,
A1F_TG_ORDER_PARTNERS_SIM ,
A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_PARTNERADDRESSES_SIM ,
A1F_TG_INFORECORD_PURCHORG ,
A1F_WG_WARNING_CNT ,
A1F_WG_MASTER_TANKA_SALE ,
A1F_WG_MASTER_TANKA_PURC .

REFRESH : A1F_TG_ORDER_ITEMS_IN_SIM ,
A1F_TG_ORDER_PARTNERS_SIM ,
A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_PARTNERADDRESSES_SIM ,
A1F_TG_INFORECORD_PURCHORG .

CLEAR : A1F_WG_FES_ADDR1_COMPLETE ,
A1F_WG_FES_VBADR ,
A1F_WG_FEF_ATTRIBUTES ,
A1F_WG_ADRNR_SH ,
A1F_WG_ADDR1_OUT .

CLEAR : A1F_FLG_SAVE_OK .

* パラメータIDクリア
PERFORM A1F_CLEAR_PARAMETER_ID .

ENDFORM.                    " a1f_clear_all
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_md04
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MD04 .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.

CALL TRANSACTION 'MD04' AND SKIP FIRST SCREEN .


ENDFORM.                    " a1f_call_tran_md04
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_mmbe
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MMBE .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD SPACE.
SET PARAMETER ID 'LAG' FIELD SPACE.
SET PARAMETER ID 'CHA' FIELD SPACE.

CALL TRANSACTION 'MMBE' AND SKIP FIRST SCREEN .


ENDFORM.                    " a1f_call_tran_mmbe
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_mb51
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MB51 .

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
SET PARAMETER ID 'LAG' FIELD SPACE.
SET PARAMETER ID 'CHA' FIELD SPACE.
SET PARAMETER ID 'LIF' FIELD SPACE.
SET PARAMETER ID 'KUN' FIELD SPACE.
SET PARAMETER ID 'BWA' FIELD SPACE.
SET PARAMETER ID 'USR' FIELD SPACE.
*>>> ES-UP 課題№242 2013/01/09
SET PARAMETER ID 'AUN' FIELD SPACE.
SET PARAMETER ID 'KPO' FIELD SPACE.
*<<< ES-UP 課題№242 2013/01/09

CALL TRANSACTION 'MB51' AND SKIP FIRST SCREEN .

ENDFORM.                    " a1f_call_tran_mb51
*&---------------------------------------------------------------------*
*&      Form  a1f_call_tran_migo
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_MIGO .

SET PARAMETER ID 'BSA' FIELD 'UB'.

CALL TRANSACTION 'ME21N' .


ENDFORM.                    " a1f_call_tran_migo
*&---------------------------------------------------------------------*
*&      Form  a1f_check_and_save_data
*&---------------------------------------------------------------------*
*       保存処理
*----------------------------------------------------------------------*
FORM A1F_CHECK_AND_SAVE_DATA .

DATA : A1F_WL_ANSWER_02(1)  .
DATA : A1F_WL_TMP_TEXT(100)  .
**** START ADD 2014/09/12 ISID11 ****
DATA:  A1F_WL_TEXTLINE_02   TYPE CHAR128.
**** END ADD 2014/09/12 ISID11 ****
CLEAR : A1F_WG_WARNING_CNT .

* 販売系データチェック
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
PERFORM A1F_SALES_DATA_CHECK .
ENDIF .

IF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
* 購買系データチェック
PERFORM A1F_PURCHASE_DATA_CHECK .
ENDIF .

IF NOT ( A1F_WG_WARNING_CNT IS INITIAL ) .
CLEAR A1F_WL_TMP_TEXT .
**** START UPD 2014/09/12 ISID11 ****
*    CONCATENATE TEXT-124 A1F_WG_WARNING_CNT TEXT-125
*                INTO A1F_WL_TMP_TEXT .
MESSAGE E116(Z3) WITH A1F_WG_WARNING_CNT INTO A1F_WL_TMP_TEXT.
CLEAR A1F_WL_TEXTLINE_02.
MESSAGE E117(Z3) INTO A1F_WL_TEXTLINE_02.
**** END UPD 2014/09/12 ISID11 ****
CALL FUNCTION 'POPUP_CONTINUE_YES_NO'
EXPORTING
TEXTLINE1 = A1F_WL_TMP_TEXT
**** START UPD 2014/09/12 ISID11 ****
*              TEXTLINE2 = TEXT-126
TEXTLINE2 = A1F_WL_TEXTLINE_02
**** END UPD 2014/09/12 ISID11 ****
TITEL     = TEXT-123
IMPORTING
ANSWER    = A1F_WL_ANSWER_02.
IF A1F_WL_ANSWER_02 NE 'J' .
EXIT .
ENDIF .
ENDIF .

IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) AND
/A1F/YLNS0011-YL_EBELN IS INITIAL .
PERFORM A1F_SALES_DATA_EXEC .                 "受注伝票変更処理
*   保存完了で、照会モードにする
A1F_FLG_SAVE_OK = 'X' .
EXIT.
ENDIF .

IF /A1F/YLNS0011-YL_VBELN IS INITIAL AND
NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
PERFORM A1F_PURCHASE_DATA_EXEC .              "発注伝票変更処理
*   保存完了で、照会モードにする
A1F_FLG_SAVE_OK = 'X' .
EXIT.
ENDIF.

IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) AND
NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
PERFORM A1F_SALES_DATA_EXEC .                 "受注伝票変更処理
PERFORM A1F_PURCHASE_DATA_EXEC .              "発注伝票変更処理
*   保存完了で、照会モードにする
A1F_FLG_SAVE_OK = 'X' .
ENDIF .

ENDFORM.                    " a1f_check_and_save_data
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_DATA_CHECK
*&---------------------------------------------------------------------*
*       販売系データチェック
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_CHECK .

DATA : A1F_WL_TMP_MENGE LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_ARARI LIKE /A1F/YLNS0011-YL_JTYUTNK2 .
DATA : A1F_WL_TMP_MENGE2 LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_MENGE3 LIKE /A1F/YLNS0011-YL_JTYUSU .
DATA : A1F_WL_TMP_SAI_HI TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_SAI_LO TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_JTYTNK_HI LIKE /A1F/YLNS0011-YL_JTYUTNK2.
DATA : A1F_WL_TMP_JTYTNK_LO LIKE /A1F/YLNS0011-YL_JTYUTNK2.

DATA : A1F_WL_OUTPUT_ARARI(11) .

* 与信チェック

* 2010.08.10 DMW2170 与信チェック方法変更   - insert start /arai
DATA : A1F_WL_TMP_JUTYU LIKE VBAP-NETWR.
DATA : A1F_WL_TMP_SAGAKU LIKE VBAP-NETWR.

IF NOT /A1F/YLNS0011-YL_VBELN IS INITIAL. "変更時のみ実施

CLEAR A1F_WL_TMP_JUTYU.
SELECT SINGLE NETWR INTO A1F_WL_TMP_JUTYU
FROM VBAP
WHERE VBELN = /A1F/YLNS0011-YL_VBELN
AND POSNR = A1F_CNS_NUMBER_S.

*   検索が成功した場合のみ実施
IF SY-SUBRC = 0.
CLEAR A1F_WL_TMP_SAGAKU.
*      確認する差額を求める（現状画面から元々の受注金額を減算）
A1F_WL_TMP_SAGAKU = /A1F/YLNS0011-YL_JYYUKNGK - A1F_WL_TMP_JUTYU.

IF A1F_WL_TMP_SAGAKU <= 0.  "現状が少ないケースだからチェック不要
ELSE.
IF /A1F/YLNS0011-YL_YSNZNDK < A1F_WL_TMP_SAGAKU .
* 2010.08.10 DMW2170 与信チェック方法変更   - insert end /arai

* 2010.08.10 DMW2170 与信チェック方法変更   - delete start /arai
*        IF /A1F/YLNS0011-YL_YSNZNDK < /A1F/YLNS0011-YL_JYYUKNGK .
* 2010.08.10 DMW2170 与信チェック方法変更   - delete end /arai

MESSAGE E215(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_YSNZNDK
/A1F/YLNS0011-YL_JYYUKNGK .
*   与信超過のため保存できません（ &1 > &2 )
ENDIF .
ENDIF.
ENDIF.
ENDIF.

* 得意先発注番号       /A1F/YLNS0011-YL_BSTKD,
IF /A1F/YLNS0011-YL_BSTKD IS INITIAL .
MESSAGE E166(/A1F/YLMS0100) .
*   得意先発注番号が未入力です
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

** 得意先品目テキストが空白の場合、品目マスタのテキストをコピー
*  IF /A1F/YLNS0011-YL_POSTX IS INITIAL .
*    /A1F/YLNS0011-YL_POSTX = /A1F/YLNS0011-YL_MAKTX_SALE .
*  ENDIF .

* 得意先品目テキスト         /A1F/YLNS0011-YL_POSTX,
IF NOT ( /A1F/YLNS0011-YL_KDMAT IS INITIAL ) AND
/A1F/YLNS0011-YL_POSTX IS INITIAL .
MESSAGE E167(/A1F/YLMS0100) .
*   得意先品目テキストが未入力です
ENDIF .

* 受注日付         /A1F/YLNS0011-YL_AUDAT,
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
MESSAGE E168(/A1F/YLMS0100) .
*   受注日付が未入力です
ELSEIF /A1F/YLNS0011-YL_AUDAT < SY-DATUM .
MESSAGE W169(/A1F/YLMS0100) .
*   受注日付が過去になっています
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ELSEIF /A1F/YLNS0011-YL_AUDAT > SY-DATUM .
MESSAGE W170(/A1F/YLMS0100) .
*   受注日付が未来になっています
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 受注数量       /A1F/YLNS0011-YL_JTYUSU,
IF /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
MESSAGE E175(/A1F/YLMS0100) .
*   受注数量が未入力です
ENDIF .

* 指定出荷日付       /A1F/YLNS0011-YL_VDATU,
IF /A1F/YLNS0011-YL_VDATU IS INITIAL .
MESSAGE E171(/A1F/YLMS0100) .
*   指定出荷日付が未入力です
ELSEIF /A1F/YLNS0011-YL_VDATU < SY-DATUM .
MESSAGE W172(/A1F/YLMS0100) .
*   指定出荷日付が過去になっています
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 出荷先コード       /A1F/YLNS0011-YL_SYKSKCD,
IF /A1F/YLNS0011-YL_SYKSKCD IS INITIAL .
MESSAGE E176(/A1F/YLMS0100) .
*   出荷先コードが未入力です
ENDIF .

* 価格単位数量        /A1F/YLNS0011-YL_KPEIN,
IF /A1F/YLNS0011-YL_KPEIN IS INITIAL .
MESSAGE E177(/A1F/YLMS0100) .
*   価格単位数量（販売）が未入力です
ELSEIF /A1F/YLNS0011-YL_KPEIN NE 100
AND /A1F/YLNS0011-YL_KPEIN NE 1000
AND /A1F/YLNS0011-YL_KPEIN NE 10000
AND /A1F/YLNS0011-YL_KPEIN NE 1 .
MESSAGE E178(/A1F/YLMS0100) .
*   価格単位数量（販売）には 1 か 100 を入力してください
ENDIF .

* 受注単価       /A1F/YLNS0011-YL_JTYUTNK,
* 売価０円対応。売価が０円でも受注登録を可能とする
IF NOT ( /A1F/YLNS0011-YL_JTYUTNK IS INITIAL ) .
A1F_WL_TMP_SAI_HI = /A1F/YLNS0011-YL_PROZ1_SALE .
A1F_WL_TMP_SAI_LO = /A1F/YLNS0011-YL_PROZ2_SALE .
A1F_WL_TMP_JTYTNK_HI =   A1F_WG_MASTER_TANKA_SALE
+ ( A1F_WG_MASTER_TANKA_SALE
* ( A1F_WL_TMP_SAI_HI / 100 ) ) .
A1F_WL_TMP_JTYTNK_LO = A1F_WG_MASTER_TANKA_SALE
- ( A1F_WG_MASTER_TANKA_SALE
* ( A1F_WL_TMP_SAI_LO / 100 ) ) .
IF NOT ( A1F_WG_MASTER_TANKA_SALE IS INITIAL ) .
IF /A1F/YLNS0011-YL_JTYUTNK BETWEEN A1F_WL_TMP_JTYTNK_LO
AND A1F_WL_TMP_JTYTNK_HI.
ELSE.
MESSAGE E205(/A1F/YLMS0100) WITH A1F_WG_MASTER_TANKA_SALE
/A1F/YLNS0011-YL_JTYUTNK.
*       受注単価：入力単価とマスタ単価の差異が許容範囲を
*       超えています。(&1→&2)
ENDIF .
ENDIF .


* 粗利        /A1F/YLNS0011-YL_ARARI,
IF /A1F/YLNS0011-YL_ARARI <= 0 .
WRITE /A1F/YLNS0011-YL_ARARI CURRENCY /A1F/YLNS0011-YL_JTYTUK
TO A1F_WL_OUTPUT_ARARI .
MESSAGE W180(/A1F/YLMS0100) WITH A1F_WL_OUTPUT_ARARI.
*     粗利が &1 です
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDIF .

* 受注数量と発注数量のチェック
IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110 AND
/A1F/YLNS0011-YL_HTYUSU_C NE /A1F/YLNS0011-YL_JTYUSU_C .
MESSAGE E191(/A1F/YLMS0100) .
*   個別購買品で受注数量と発注数量が異なります
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
A1F_WL_TMP_MENGE = /A1F/YLNS0011-YL_HTYUSU_C
+ /A1F/YLNS0011-YL_MHKATZIK .
IF /A1F/YLNS0011-YL_JTYUSU_C > A1F_WL_TMP_MENGE .
MESSAGE W192(/A1F/YLMS0100) .
*   発注数量が不足しています
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

DATA : A1F_WL_EXCH_RATE LIKE BAPI1093_0 ,
A1F_WL_RETURN_EXCH LIKE BAPIRET1 .
* 換算レートの取得
CLEAR : A1F_WL_EXCH_RATE  ,
A1F_WL_RETURN_EXCH .
IF /A1F/YLNS0011-YL_HTYUTUK NE /A1F/YLNS0011-YL_WAERS AND
NOT ( /A1F/YLNS0011-YL_HTYUTUK IS INITIAL ) .
CALL FUNCTION 'BAPI_EXCHANGERATE_GETDETAIL'
EXPORTING
RATE_TYPE  = A1F_CNS_RATE_TYPE
FROM_CURR  = /A1F/YLNS0011-YL_HTYUTUK
TO_CURRNCY = /A1F/YLNS0011-YL_WAERS
DATE       = SY-DATUM
IMPORTING
EXCH_RATE  = A1F_WL_EXCH_RATE
RETURN     = A1F_WL_RETURN_EXCH.
**** START UPD 2014/09/12 ISID11 ****
*    IF SY-SUBRC NE 0 OR
*       A1F_WL_RETURN_EXCH-TYPE = 'E' .
IF A1F_WL_RETURN_EXCH-TYPE = 'E' .
**** END UPD 2014/09/12 ISID11 ****
/A1F/YLNS0011-YL_JYYUKNGK_C = /A1F/YLNS0011-YL_JYYUKNGK .
MESSAGE E202(/A1F/YLMS0100) WITH A1F_CNS_RATE_TYPE
/A1F/YLNS0011-YL_HTYUTUK
/A1F/YLNS0011-YL_WAERS.
*     換算レートの取得に失敗しました。（Type &1 From &2 To &3）
ENDIF .
ELSE .
A1F_WL_EXCH_RATE-EXCH_RATE = 1 .
ENDIF .

* 発注金額        /A1F/YLNS0011-YL_HTYUKNGK,
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- /A1F/YLNS0011-YL_HTYUKNGK_C .
IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-110
AND A1F_WL_TMP_ARARI <= 0 .
WRITE A1F_WL_TMP_ARARI CURRENCY /A1F/YLNS0011-YL_WAERS
TO A1F_WL_OUTPUT_ARARI .
MESSAGE W196(/A1F/YLMS0100) WITH A1F_WL_OUTPUT_ARARI .
*   発注金額で計算した粗利が &1 です
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
IF /A1F/YLNS0011-YL_MISIKTGRTYP = TEXT-111 .
IF /A1F/YLNS0011-YL_JTYUSU <= /A1F/YLNS0011-YL_MHKATZIK.
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_ARARI .
ELSE .
A1F_WL_TMP_MENGE2 = /A1F/YLNS0011-YL_HTYUSU
+ /A1F/YLNS0011-YL_MHKATZIK .
IF /A1F/YLNS0011-YL_JTYUSU > A1F_WL_TMP_MENGE2 .
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- ( ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
* /A1F/YLNS0011-YL_MHKATZIK )
- /A1F/YLNS0011-YL_HTYUKNGK_C .
ELSE .
A1F_WL_TMP_MENGE3 = /A1F/YLNS0011-YL_JTYUSU
- /A1F/YLNS0011-YL_MHKATZIK .
A1F_WL_TMP_ARARI = /A1F/YLNS0011-YL_JYYUKNGK_C
- ( ( A1F_WG_MBEW-VERPR / A1F_WG_MBEW-PEINH )
* /A1F/YLNS0011-YL_MHKATZIK )
- ( ( ( /A1F/YLNS0011-YL_HTYUTNK /
/A1F/YLNS0011-YL_PEINH )
* A1F_WL_TMP_MENGE3 ) *
A1F_WL_EXCH_RATE-EXCH_RATE ).
ENDIF .
ENDIF.
IF  A1F_WL_TMP_ARARI <= 0 .
WRITE A1F_WL_TMP_ARARI CURRENCY /A1F/YLNS0011-YL_WAERS
TO A1F_WL_OUTPUT_ARARI .
MESSAGE W197(/A1F/YLMS0100) WITH A1F_WL_OUTPUT_ARARI .
*     在庫金額、発注金額で計算した粗利が &1 です
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDIF .

ENDFORM.                    " A1F_SALES_DATA_CHECK
*&---------------------------------------------------------------------*
*&      Form  a1f_PURCHASE_data_check
*&---------------------------------------------------------------------*
*       購買系データチェック
*----------------------------------------------------------------------*
FORM A1F_PURCHASE_DATA_CHECK .

DATA : A1F_WL_TMP_SAI_HI TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_SAI_LO TYPE P DECIMALS 5 .
DATA : A1F_WL_TMP_HTYTNK_HI LIKE /A1F/YLNS0011-YL_JTYUTNK2 .
DATA : A1F_WL_TMP_HTYTNK_LO LIKE /A1F/YLNS0011-YL_JTYUTNK2 .

* 購買グループ
IF /A1F/YLNS0011-EKGRP IS INITIAL .
MESSAGE E208(/A1F/YLMS0100) .
*   購買グループが未入力です
ENDIF .

* 納入日付        /A1F/YLNS0011-YL_EEIND,
IF /A1F/YLNS0011-YL_EEIND IS INITIAL .
MESSAGE E185(/A1F/YLMS0100) .
*   納入日付が未入力です
ELSEIF /A1F/YLNS0011-YL_EEIND < SY-DATUM .
MESSAGE W186(/A1F/YLMS0100) .
*   納入日付が過去になっています
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .

* 発注品目テキスト        /A1F/YLNS0011-YL_MAKTX_PURC,
IF /A1F/YLNS0011-YL_MAKTX_PURC IS INITIAL .
MESSAGE E188(/A1F/YLMS0100) .
*   購買品目テキストが未入力です
ENDIF .

* 直送区分        /A1F/YLNS0011-YL_YL_TYKSUKBN,
DATA : A1F_WL_ADDR_SUBRC LIKE SY-SUBRC .
PERFORM A1F_EXIT_GET_ADDR_CHECK USING A1F_WL_ADDR_SUBRC .
IF A1F_WL_ADDR_SUBRC = 0 .
IF NOT ( /A1F/YLNS0011-YL_TYKSUKBN IS INITIAL ) .
MESSAGE W222(/A1F/YLMS0100) .
*     直送指定のため発注伝票の納入先は出荷先の住所がコピーされます
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDIF .

* 発注品目コード        /A1F/YLNS0011-YL_IDNLF,
* 仕入先品目コードのエラーチェック
* EDI仕入先の場合、仕入先品目コードをチェック
DATA : A1F_WL_ADDR_SUBRC2 LIKE SY-SUBRC .
PERFORM A1F_EXIT_GET_ADDR_CHECK USING A1F_WL_ADDR_SUBRC2 .
IF A1F_WL_ADDR_SUBRC2 = 9 .
IF /A1F/YLNS0011-YL_IDNLF IS INITIAL .
MESSAGE W189(/A1F/YLMS0100) .
*     仕入先品目コードが未入力です
A1F_WG_WARNING_CNT = A1F_WG_WARNING_CNT + 1 .
ENDIF .
ENDIF .

* 発注数量        /A1F/YLNS0011-YL_HTYUSU,
IF /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
MESSAGE E190(/A1F/YLMS0100) .
*   発注数量が未入力です
ENDIF .

* 発注単価        /A1F/YLNS0011-YL_HTYUTNK,
IF /A1F/YLNS0011-YL_MSYUFLG = SPACE .
IF /A1F/YLNS0011-YL_HTYUTNK IS INITIAL .
MESSAGE E193(/A1F/YLMS0100) .
*     発注単価を入力してください
ENDIF .
A1F_WL_TMP_SAI_HI = /A1F/YLNS0011-YL_PROZ1_PURC .
A1F_WL_TMP_SAI_LO = /A1F/YLNS0011-YL_PROZ2_PURC .
A1F_WL_TMP_HTYTNK_HI =   A1F_WG_MASTER_TANKA_PURC
+ ( A1F_WG_MASTER_TANKA_PURC
* ( A1F_WL_TMP_SAI_HI / 100 ) ) .
A1F_WL_TMP_HTYTNK_LO = A1F_WG_MASTER_TANKA_PURC
- ( A1F_WG_MASTER_TANKA_PURC
* ( A1F_WL_TMP_SAI_LO / 100 ) ) .
IF NOT ( A1F_WG_MASTER_TANKA_PURC IS INITIAL ) .
IF /A1F/YLNS0011-YL_HTYUTNK BETWEEN A1F_WL_TMP_HTYTNK_LO
AND A1F_WL_TMP_HTYTNK_HI.
ELSE.
MESSAGE E206(/A1F/YLMS0100) WITH A1F_WG_MASTER_TANKA_PURC
/A1F/YLNS0011-YL_HTYUTNK.
*       発注単価：入力単価とマスタ単価の差異が許容範囲を
*       超えています。(&1→&2)
ENDIF .
ENDIF .
ENDIF .

* 価格単位数量        /A1F/YLNS0011-YL_PEINH,
IF /A1F/YLNS0011-YL_PEINH IS INITIAL .
MESSAGE E194(/A1F/YLMS0100) .
*   価格単位数量（購買）が未入力です
ELSEIF /A1F/YLNS0011-YL_PEINH NE 100
AND /A1F/YLNS0011-YL_PEINH NE 1000
AND /A1F/YLNS0011-YL_PEINH NE 10000
AND /A1F/YLNS0011-YL_PEINH NE 1 .
MESSAGE E195(/A1F/YLMS0100) .
*   価格単位数量（購買）には 1 か 100 を入力してください
ENDIF .

ENDFORM.                    " a1f_PURCHASE_data_check
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_DATA_EXEC
*&---------------------------------------------------------------------*
*       受注伝票変更処理
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_EXEC .

DATA : A1F_WL_ORDER_HEADER_IN  LIKE BAPISDH1 ,
A1F_WL_ORDER_HEADER_INX LIKE BAPISDH1X ,
A1F_WL_BAPI_VIEW        LIKE ORDER_VIEW .

DATA : A1F_TL_RETURN_SALE
LIKE TABLE OF BAPIRET2   WITH HEADER LINE ,
A1F_TL_ORDER_ITEMS_IN
LIKE TABLE OF BAPISDITM  WITH HEADER LINE ,
A1F_TL_ORDER_ITEMS_INX
LIKE TABLE OF BAPISDITMX WITH HEADER LINE ,
A1F_TL_PARTNERCHANGES
LIKE TABLE OF BAPIPARNRC WITH HEADER LINE ,
A1F_TL_PARTNERADDRESSES
LIKE TABLE OF BAPIADDR1  WITH HEADER LINE ,
A1F_TL_ORDER_SCHEDULES_IN
LIKE TABLE OF BAPISCHDL  WITH HEADER LINE ,
A1F_TL_ORDER_SCHEDULES_INX
LIKE TABLE OF BAPISCHDLX WITH HEADER LINE ,
A1F_TL_CONDITIONS_IN
LIKE TABLE OF BAPICOND   WITH HEADER LINE ,
A1F_TL_CONDITIONS_INX
LIKE TABLE OF BAPICONDX  WITH HEADER LINE ,
A1F_TL_ORDER_TEXT
LIKE TABLE OF BAPISDTEXT WITH HEADER LINE ,
A1F_TL_SALES_DOCS
LIKE TABLE OF SALES_KEY  WITH HEADER LINE ,
A1F_TL_TEXTLINES_OUT
LIKE TABLE OF BAPITEXTLI WITH HEADER LINE .

CLEAR : A1F_WL_ORDER_HEADER_IN ,
A1F_WL_ORDER_HEADER_INX ,
A1F_WL_BAPI_VIEW ,
A1F_TL_SALES_DOCS ,
A1F_TL_TEXTLINES_OUT ,
A1F_TL_RETURN_SALE ,
A1F_TL_ORDER_ITEMS_IN ,
A1F_TL_ORDER_ITEMS_INX ,
A1F_TL_PARTNERCHANGES ,
A1F_TL_PARTNERADDRESSES ,
A1F_TL_ORDER_SCHEDULES_IN ,
A1F_TL_ORDER_SCHEDULES_INX ,
A1F_TL_CONDITIONS_IN ,
A1F_TL_CONDITIONS_INX ,
A1F_TL_ORDER_TEXT .

REFRESH : A1F_TL_RETURN_SALE ,
A1F_TL_ORDER_ITEMS_IN ,
A1F_TL_ORDER_ITEMS_INX ,
A1F_TL_PARTNERCHANGES ,
A1F_TL_PARTNERADDRESSES ,
A1F_TL_ORDER_SCHEDULES_IN ,
A1F_TL_ORDER_SCHEDULES_INX ,
A1F_TL_CONDITIONS_IN ,
A1F_TL_CONDITIONS_INX ,
A1F_TL_SALES_DOCS ,
A1F_TL_TEXTLINES_OUT ,
A1F_TL_ORDER_TEXT .

* 受注ヘッダ情報編集
* 販売組織
A1F_WL_ORDER_HEADER_IN-SALES_ORG  = /A1F/YLNS0011-VKORG .
* 流通チャネル
A1F_WL_ORDER_HEADER_IN-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
* 製品部門
A1F_WL_ORDER_HEADER_IN-DIVISION   = /A1F/YLNS0011-SPART .
* 営業所
A1F_WL_ORDER_HEADER_IN-SALES_OFF  = /A1F/YLNS0011-VKBUR .
* 営業グループ
A1F_WL_ORDER_HEADER_IN-SALES_GRP  = /A1F/YLNS0011-VKGRP .
* 指定出荷日付
* 指定出荷日付は明細納期を設定する
*  A1F_WL_ORDER_HEADER_IN-REQ_DATE_H = /A1F/YLNS0011-YL_VDATU .
* 得意先発注番号
A1F_WL_ORDER_HEADER_IN-PURCH_NO_C = /A1F/YLNS0011-YL_BSTKD .
* 受注日付
A1F_WL_ORDER_HEADER_IN-DOC_DATE   = /A1F/YLNS0011-YL_AUDAT .
A1F_WL_ORDER_HEADER_IN-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
* 出荷ブロック
A1F_WL_ORDER_HEADER_IN-DLV_BLOCK  = /A1F/YLNS0011-YL_LIFSK .
* 得意先発注日付
A1F_WL_ORDER_HEADER_IN-PURCH_DATE = /A1F/YLNS0011-YL_TKISKHCDT .

A1F_WL_ORDER_HEADER_INX-UPDATEFLAG = 'U' .
A1F_WL_ORDER_HEADER_INX-SALES_ORG  = 'X' .
A1F_WL_ORDER_HEADER_INX-DISTR_CHAN = 'X' .
A1F_WL_ORDER_HEADER_INX-DIVISION   = 'X' .
A1F_WL_ORDER_HEADER_INX-SALES_GRP  = 'X' .
A1F_WL_ORDER_HEADER_INX-SALES_OFF  = 'X' .
*  A1F_WL_ORDER_HEADER_INX-REQ_DATE_H = 'X' .
A1F_WL_ORDER_HEADER_INX-PURCH_NO_C = 'X' .
A1F_WL_ORDER_HEADER_INX-DOC_DATE   = 'X' .
A1F_WL_ORDER_HEADER_INX-DLV_BLOCK  = 'X' .
A1F_WL_ORDER_HEADER_INX-PRICE_DATE = 'X' .
A1F_WL_ORDER_HEADER_INX-PURCH_DATE = 'X' .


* 取引先機能情報(出荷先)
A1F_TL_PARTNERCHANGES-DOCUMENT   = /A1F/YLNS0011-YL_VBELN .
*  A1F_TL_PARTNERCHANGES-ITM_NUMBER = A1F_CNS_NUMBER_S
A1F_TL_PARTNERCHANGES-UPDATEFLAG = 'U' .
A1F_TL_PARTNERCHANGES-PARTN_ROLE = 'WE' .
A1F_TL_PARTNERCHANGES-P_NUMB_OLD = A1F_SYKSKCD_OLD .
A1F_TL_PARTNERCHANGES-P_NUMB_NEW = /A1F/YLNS0011-YL_SYKSKCD .
A1F_TL_PARTNERCHANGES-ADDRESS    = A1F_WG_ADRNR_SH .

IF A1F_FLG_ADDR_CHANGE = 'X' .
A1F_TL_PARTNERCHANGES-ADDR_LINK  = '9990000001' .
ENDIF .

APPEND A1F_TL_PARTNERCHANGES .

** 取引先機能情報(出荷先)
*  A1F_TL_ORDER_PARTNERS-PARTN_ROLE = 'WE' .
*  A1F_TL_ORDER_PARTNERS-PARTN_NUMB = /A1F/YLNS0011-YL_SYKSKCD .
*
** 出荷先住所変更対応
*  IF NOT ( A1F_WG_ADDR1_OUT-NAME1 IS INITIAL ) .
*    A1F_TL_ORDER_PARTNERS-TELEPHONE2 = A1F_WG_FES_VBADR-TELF2 .
*    A1F_TL_ORDER_PARTNERS-TELEBOX    = A1F_WG_FES_VBADR-TELBX .
*    A1F_TL_ORDER_PARTNERS-TELETEX_NO = A1F_WG_FES_VBADR-TELTX .
*    A1F_TL_ORDER_PARTNERS-TELEX_NO   = A1F_WG_FES_VBADR-TELX1 .
*    A1F_TL_ORDER_PARTNERS-ADDR_TYPE  = A1F_WG_FES_VBADR-ADDRESS_TYPE .
*    A1F_TL_ORDER_PARTNERS-UNLOAD_PT  = A1F_WG_FEF_ATTRIBUTES-ABLAD .
*    A1F_TL_ORDER_PARTNERS-ADDR_LINK  = '9990000001' .
*  ENDIF .
*
*  APPEND A1F_TL_ORDER_PARTNERS .

* 出荷先住所変更対応
IF A1F_FLG_ADDR_CHANGE = 'X' .
A1F_TL_PARTNERADDRESSES-ADDR_NO    = '9990000001' .
A1F_TL_PARTNERADDRESSES-TITLE      = A1F_WG_ADDR1_OUT-TITLE .
A1F_TL_PARTNERADDRESSES-NAME       = A1F_WG_ADDR1_OUT-NAME1 .
A1F_TL_PARTNERADDRESSES-NAME_2     = A1F_WG_ADDR1_OUT-NAME2 .
A1F_TL_PARTNERADDRESSES-NAME_3     = A1F_WG_ADDR1_OUT-NAME3 .
A1F_TL_PARTNERADDRESSES-NAME_4     = A1F_WG_ADDR1_OUT-NAME4 .
A1F_TL_PARTNERADDRESSES-C_O_NAME   = A1F_WG_ADDR1_OUT-NAME_CO .
A1F_TL_PARTNERADDRESSES-CITY       = A1F_WG_ADDR1_OUT-CITY1 .
A1F_TL_PARTNERADDRESSES-DISTRICT   = A1F_WG_ADDR1_OUT-CITY2 .
A1F_TL_PARTNERADDRESSES-CITY_NO    = A1F_WG_ADDR1_OUT-CITY_CODE .
A1F_TL_PARTNERADDRESSES-DISTRCT_NO = A1F_WG_ADDR1_OUT-CITYP_CODE .
A1F_TL_PARTNERADDRESSES-CHCKSTATUS = A1F_WG_ADDR1_OUT-CHCKSTATUS .
A1F_TL_PARTNERADDRESSES-REGIOGROUP = A1F_WG_ADDR1_OUT-REGIOGROUP .
A1F_TL_PARTNERADDRESSES-POSTL_COD1 = A1F_WG_ADDR1_OUT-POST_CODE1 .
A1F_TL_PARTNERADDRESSES-POSTL_COD2 = A1F_WG_ADDR1_OUT-POST_CODE2 .
A1F_TL_PARTNERADDRESSES-POSTL_COD3 = A1F_WG_ADDR1_OUT-POST_CODE3 .
A1F_TL_PARTNERADDRESSES-PO_BOX     = A1F_WG_ADDR1_OUT-PO_BOX .
A1F_TL_PARTNERADDRESSES-PO_BOX_CIT = A1F_WG_ADDR1_OUT-PO_BOX_LOC .
A1F_TL_PARTNERADDRESSES-PBOXCIT_NO = A1F_WG_ADDR1_OUT-CITY_CODE2 .
A1F_TL_PARTNERADDRESSES-DELIV_DIS  = A1F_WG_ADDR1_OUT-POSTALAREA .
A1F_TL_PARTNERADDRESSES-TRANSPZONE = A1F_WG_ADDR1_OUT-TRANSPZONE .
A1F_TL_PARTNERADDRESSES-STREET     = A1F_WG_ADDR1_OUT-STREET .
A1F_TL_PARTNERADDRESSES-STREET_LNG = A1F_WG_ADDR1_OUT-STREET .
A1F_TL_PARTNERADDRESSES-STREET_NO  = A1F_WG_ADDR1_OUT-STREETCODE .
A1F_TL_PARTNERADDRESSES-STR_ABBR   = A1F_WG_ADDR1_OUT-STREETABBR .
A1F_TL_PARTNERADDRESSES-HOUSE_NO   = A1F_WG_ADDR1_OUT-HOUSE_NUM1 .
A1F_TL_PARTNERADDRESSES-HOUSE_NO2  = A1F_WG_ADDR1_OUT-HOUSE_NUM2 .
A1F_TL_PARTNERADDRESSES-STR_SUPPL1 = A1F_WG_ADDR1_OUT-STR_SUPPL1 .
A1F_TL_PARTNERADDRESSES-STR_SUPPL2 = A1F_WG_ADDR1_OUT-STR_SUPPL2 .
A1F_TL_PARTNERADDRESSES-STR_SUPPL3 = A1F_WG_ADDR1_OUT-STR_SUPPL3 .
A1F_TL_PARTNERADDRESSES-LOCATION   = A1F_WG_ADDR1_OUT-LOCATION .
A1F_TL_PARTNERADDRESSES-BUILDING   = A1F_WG_ADDR1_OUT-BUILDING .
A1F_TL_PARTNERADDRESSES-BUILD_LONG = A1F_WG_ADDR1_OUT-BUILDING .
A1F_TL_PARTNERADDRESSES-FLOOR      = A1F_WG_ADDR1_OUT-FLOOR .
A1F_TL_PARTNERADDRESSES-ROOM_NO    = A1F_WG_ADDR1_OUT-ROOMNUMBER .
A1F_TL_PARTNERADDRESSES-COUNTRY    = A1F_WG_ADDR1_OUT-COUNTRY .
A1F_TL_PARTNERADDRESSES-LANGU      = A1F_WG_ADDR1_OUT-LANGU .
A1F_TL_PARTNERADDRESSES-REGION     = A1F_WG_ADDR1_OUT-REGION .
A1F_TL_PARTNERADDRESSES-SORT1      = A1F_WG_ADDR1_OUT-SORT1 .
A1F_TL_PARTNERADDRESSES-SORT2      = A1F_WG_ADDR1_OUT-SORT2 .
A1F_TL_PARTNERADDRESSES-TIME_ZONE  = A1F_WG_ADDR1_OUT-TIME_ZONE .
A1F_TL_PARTNERADDRESSES-TAXJURCODE = A1F_WG_ADDR1_OUT-TAXJURCODE .
A1F_TL_PARTNERADDRESSES-ADR_NOTES  = A1F_WG_ADDR1_OUT-REMARK .
A1F_TL_PARTNERADDRESSES-COMM_TYPE  = A1F_WG_ADDR1_OUT-DEFLT_COMM .

DATA A1F_WL_ADTEL TYPE SZADR_ADTEL_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADTEL_TAB
INDEX 1 INTO A1F_WL_ADTEL.
A1F_TL_PARTNERADDRESSES-TEL1_NUMBR = A1F_WL_ADTEL-ADTEL-TEL_NUMBER.
A1F_TL_PARTNERADDRESSES-TEL1_EXT   = A1F_WL_ADTEL-ADTEL-TEL_EXTENS.

DATA A1F_WL_ADFAX TYPE SZADR_ADFAX_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADFAX_TAB
INDEX 1 INTO A1F_WL_ADFAX.
A1F_TL_PARTNERADDRESSES-FAX_NUMBER = A1F_WL_ADFAX-ADFAX-FAX_NUMBER.
A1F_TL_PARTNERADDRESSES-FAX_EXTENS = A1F_WL_ADFAX-ADFAX-FAX_EXTENS.

DATA A1F_WL_ADSMTP TYPE SZADR_ADSMTP_LINE .
READ TABLE A1F_WG_FES_ADDR1_COMPLETE-ADSMTP_TAB
INDEX 1 INTO A1F_WL_ADSMTP.

A1F_TL_PARTNERADDRESSES-E_MAIL = A1F_WL_ADSMTP-ADSMTP-SMTP_ADDR.

APPEND A1F_TL_PARTNERADDRESSES .
ENDIF .

* 受注明細情報編集
* 受注明細番号
A1F_TL_ORDER_ITEMS_IN-ITM_NUMBER = A1F_CNS_NUMBER_S .
* 品目コード
A1F_TL_ORDER_ITEMS_IN-MATERIAL   = /A1F/YLNS0011-YL_MATNR_SALE .
* プラント
A1F_TL_ORDER_ITEMS_IN-PLANT      = /A1F/YLNS0011-YL_DWERK .
** 得意先品目テキスト
A1F_TL_ORDER_ITEMS_IN-SHORT_TEXT = /A1F/YLNS0011-YL_MAKTX_SALE.
* 受注数量単位
A1F_TL_ORDER_ITEMS_IN-SALES_UNIT = /A1F/YLNS0011-YL_VRKME .

APPEND A1F_TL_ORDER_ITEMS_IN .

A1F_TL_ORDER_ITEMS_INX-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_ITEMS_INX-UPDATEFLAG = 'U' .
A1F_TL_ORDER_ITEMS_INX-MATERIAL   = 'X' .
A1F_TL_ORDER_ITEMS_INX-PLANT      = 'X' .
A1F_TL_ORDER_ITEMS_INX-SHORT_TEXT = 'X' .
A1F_TL_ORDER_ITEMS_INX-SALES_UNIT = 'X' .

APPEND A1F_TL_ORDER_ITEMS_INX .

* 納入日程行編集
* 受注明細番号
A1F_TL_ORDER_SCHEDULES_IN-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_SCHEDULES_IN-SCHED_LINE = '0001' .
* 受注数量
A1F_TL_ORDER_SCHEDULES_IN-REQ_QTY    = /A1F/YLNS0011-YL_JTYUSU .
A1F_TL_ORDER_SCHEDULES_IN-REQ_DATE   = /A1F/YLNS0011-YL_VDATU .
APPEND A1F_TL_ORDER_SCHEDULES_IN .

A1F_TL_ORDER_SCHEDULES_INX-ITM_NUMBER = A1F_CNS_NUMBER_S .
A1F_TL_ORDER_SCHEDULES_INX-SCHED_LINE = '0001' .
A1F_TL_ORDER_SCHEDULES_INX-UPDATEFLAG = 'U' .
A1F_TL_ORDER_SCHEDULES_INX-REQ_QTY    = 'X' .
A1F_TL_ORDER_SCHEDULES_INX-REQ_DATE   = 'X' .

APPEND A1F_TL_ORDER_SCHEDULES_INX .

* 条件編集

* INSERT START by hasebe 2009/11/11
* 分納済みの伝票に対して受注単価の設定が行われないように
* 条件を追加。
* A1F_CHECK_VBFAを実行するとA1F_WL_SUBRCに請求済み数量
* が設定される。ゼロの場合のみ価格設定を実行する

DATA   A1F_WL_SUBRC LIKE SY-SUBRC .
PERFORM A1F_CHECK_VBFA CHANGING A1F_WL_SUBRC .
IF A1F_WL_SUBRC = 0 .

* INSERT END by hasebe 2009/11/11

SELECT KPOSN
STUNR
ZAEHK
KSCHL
INTO (A1F_TL_CONDITIONS_IN-ITM_NUMBER,
A1F_TL_CONDITIONS_IN-COND_ST_NO,
A1F_TL_CONDITIONS_IN-COND_COUNT,
A1F_TL_CONDITIONS_IN-COND_TYPE)
FROM KONV UP TO 1 ROWS
WHERE KNUMV = A1F_WG_KNUMV_S
AND KPOSN = A1F_CNS_NUMBER_S
AND STUNR = '012'
*    AND KHERK = 'C'
AND KINAK = SPACE.
ENDSELECT .

DATA : A1F_WL_TMP_VALUE LIKE BAPICURR-BAPICURR .
**** START ADD 2014/09/12 ISID11 ****
DATA : A1F_WL_ISO_LANGUE TYPE T002-LAISO.
**** END ADD 2014/09/12 ISID11 ****
CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YLNS0011-YL_JTYTUK
AMOUNT_INTERNAL = /A1F/YLNS0011-YL_JTYUTNK
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
A1F_TL_CONDITIONS_IN-COND_VALUE = A1F_WL_TMP_VALUE .

A1F_TL_CONDITIONS_IN-CURRENCY   = /A1F/YLNS0011-YL_JTYTUK .
A1F_TL_CONDITIONS_IN-COND_P_UNT = /A1F/YLNS0011-YL_KPEIN .
*   DMW1823 販売価格単位不具合修正  T.arai(MIS) - modify start
*   A1F_TL_CONDITIONS_IN-COND_UNIT  = /A1F/YLNS0011-YL_VRKME .
A1F_TL_CONDITIONS_IN-COND_UNIT  = A1F_WG_KMEIN.
*   DMW1823 販売価格単位不具合修正  T.arai(MIS) - modify e n d
APPEND A1F_TL_CONDITIONS_IN .

A1F_TL_CONDITIONS_INX-ITM_NUMBER =  A1F_TL_CONDITIONS_IN-ITM_NUMBER .
A1F_TL_CONDITIONS_INX-COND_ST_NO =  A1F_TL_CONDITIONS_IN-COND_ST_NO .
A1F_TL_CONDITIONS_INX-COND_COUNT =  A1F_TL_CONDITIONS_IN-COND_COUNT .
A1F_TL_CONDITIONS_INX-COND_TYPE  =  A1F_TL_CONDITIONS_IN-COND_TYPE .
A1F_TL_CONDITIONS_INX-UPDATEFLAG = 'X' .
A1F_TL_CONDITIONS_INX-COND_VALUE = 'X' .
A1F_TL_CONDITIONS_INX-CURRENCY   = 'X' .
A1F_TL_CONDITIONS_INX-COND_UNIT  = 'X' .
A1F_TL_CONDITIONS_INX-COND_P_UNT = 'X' .
APPEND A1F_TL_CONDITIONS_INX .

ENDIF .

* テキスト項目編集
* テキスト情報取得
A1F_TL_SALES_DOCS-VBELN = /A1F/YLNS0011-YL_VBELN .
APPEND A1F_TL_SALES_DOCS .

A1F_WL_BAPI_VIEW-TEXT = 'X' .

CALL FUNCTION 'BAPISDORDER_GETDETAILEDLIST'
EXPORTING
I_BAPI_VIEW             = A1F_WL_BAPI_VIEW
*     I_MEMORY_READ           =
TABLES
SALES_DOCUMENTS         = A1F_TL_SALES_DOCS
*     ORDER_HEADERS_OUT       =
*     ORDER_ITEMS_OUT         =
*     ORDER_SCHEDULES_OUT     =
*     ORDER_BUSINESS_OUT      =
*     ORDER_PARTNERS_OUT      =
*     ORDER_ADDRESS_OUT       =
*     ORDER_STATUSHEADERS_OUT =
*     ORDER_STATUSITEMS_OUT   =
*     ORDER_CONDITIONS_OUT    =
*     ORDER_COND_HEAD         =
*     ORDER_COND_ITEM         =
*     ORDER_COND_QTY_SCALE    =
*     ORDER_COND_VAL_SCALE    =
*     ORDER_CONTRACTS_OUT     =
*     ORDER_TEXTHEADERS_OUT   =
ORDER_TEXTLINES_OUT     = A1F_TL_TEXTLINES_OUT
*     ORDER_FLOWS_OUT         =
*     ORDER_CFGS_CUREFS_OUT   =
*     ORDER_CFGS_CUCFGS_OUT   =
*     ORDER_CFGS_CUINS_OUT    =
*     ORDER_CFGS_CUPRTS_OUT   =
*     ORDER_CFGS_CUVALS_OUT   =
*     ORDER_CFGS_CUBLBS_OUT   =
*     ORDER_CFGS_CUVKS_OUT    =
*     ORDER_BILLINGPLANS_OUT  =
*     ORDER_BILLINGDATES_OUT  =
*     ORDER_CREDITCARDS_OUT   =
*     EXTENSIONOUT            =
.
** 共通使用項目設定
*  A1F_TL_ORDER_TEXT-DOC_NUMBER = /A1F/YLNS0011-YL_VBELN .
*  A1F_TL_ORDER_TEXT-LANGU      = 'J' .
*  A1F_TL_ORDER_TEXT-LANGU_ISO  = 'JA' .
*  A1F_TL_ORDER_TEXT-FUNCTION   = '005' .

* 納品書備考
*  A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_CNS_ID_NHN .
*  A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_NUHNSYBKU .
*  A1F_TL_ORDER_TEXT-FORMAT_COL = SPACE .
READ TABLE A1F_TL_TEXTLINES_OUT WITH KEY TEXT_ID = A1F_CNS_ID_NHN
INTO A1F_TL_TEXTLINES_OUT .
IF SY-SUBRC = 0 .
IF /A1F/YLNS0011-YL_NUHNSYBKU IS INITIAL .
A1F_TL_ORDER_TEXT-FUNCTION   = '003' .
ELSE .
A1F_TL_ORDER_TEXT-FUNCTION   = A1F_TL_TEXTLINES_OUT-OPERATION .
ENDIF .
A1F_TL_ORDER_TEXT-DOC_NUMBER = /A1F/YLNS0011-YL_VBELN .
A1F_TL_ORDER_TEXT-LANGU      = A1F_TL_TEXTLINES_OUT-LANGU .
A1F_TL_ORDER_TEXT-LANGU_ISO  = A1F_TL_TEXTLINES_OUT-LANGU_ISO .
A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_TL_TEXTLINES_OUT-TEXT_ID .
A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_NUHNSYBKU .
A1F_TL_ORDER_TEXT-FORMAT_COL = A1F_TL_TEXTLINES_OUT-FORMAT_COL .
APPEND A1F_TL_ORDER_TEXT .
ELSE.
IF NOT ( /A1F/YLNS0011-YL_NUHNSYBKU IS INITIAL ).
A1F_TL_ORDER_TEXT-DOC_NUMBER = /A1F/YLNS0011-YL_VBELN .
A1F_TL_ORDER_TEXT-FUNCTION   = '005' .
**** START UPD 2014/09/12 ISID11 ****
*      A1F_TL_ORDER_TEXT-LANGU      = 'J' .
*      A1F_TL_ORDER_TEXT-LANGU_ISO  = 'JA' .
A1F_TL_ORDER_TEXT-LANGU      = SY-LANGU.
*     変換: 1 桁の SAP 言語キー -> 2 桁の ISO 言語キー
PERFORM A1F_LANGU_ISO_CHG CHANGING A1F_WL_ISO_LANGUE.
A1F_TL_ORDER_TEXT-LANGU_ISO  = A1F_WL_ISO_LANGUE.
**** END UPD 2014/09/12 ISID11 ****
A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_CNS_ID_NHN .
A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_NUHNSYBKU .
A1F_TL_ORDER_TEXT-FORMAT_COL = SPACE .
APPEND A1F_TL_ORDER_TEXT .
ENDIF .
ENDIF .

* 社内備考
*  A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_CNS_ID_SYNI .
*  A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_SYNIBKU .
*  A1F_TL_ORDER_TEXT-FORMAT_COL = SPACE .
READ TABLE A1F_TL_TEXTLINES_OUT WITH KEY TEXT_ID = A1F_CNS_ID_SYNI
INTO A1F_TL_TEXTLINES_OUT .
IF SY-SUBRC = 0 .
IF /A1F/YLNS0011-YL_SYNIBKU IS INITIAL .
A1F_TL_ORDER_TEXT-FUNCTION   = '003' .
ELSE .
A1F_TL_ORDER_TEXT-FUNCTION   = A1F_TL_TEXTLINES_OUT-OPERATION .
ENDIF .
A1F_TL_ORDER_TEXT-LANGU      = A1F_TL_TEXTLINES_OUT-LANGU .
A1F_TL_ORDER_TEXT-LANGU_ISO  = A1F_TL_TEXTLINES_OUT-LANGU_ISO .
A1F_TL_ORDER_TEXT-FUNCTION   = A1F_TL_TEXTLINES_OUT-OPERATION .
A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_TL_TEXTLINES_OUT-TEXT_ID .
A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_SYNIBKU .
A1F_TL_ORDER_TEXT-FORMAT_COL = A1F_TL_TEXTLINES_OUT-FORMAT_COL .
APPEND A1F_TL_ORDER_TEXT .
ELSE.
IF NOT ( /A1F/YLNS0011-YL_SYNIBKU IS INITIAL ).
A1F_TL_ORDER_TEXT-DOC_NUMBER = /A1F/YLNS0011-YL_VBELN .
A1F_TL_ORDER_TEXT-FUNCTION   = '005' .
**** START UPD 2014/09/12 ISID11 ****
*      A1F_TL_ORDER_TEXT-LANGU      = 'J' .
*      A1F_TL_ORDER_TEXT-LANGU_ISO  = 'JA' .
A1F_TL_ORDER_TEXT-LANGU      = SY-LANGU.
*     変換: 1 桁の SAP 言語キー -> 2 桁の ISO 言語キー
PERFORM A1F_LANGU_ISO_CHG CHANGING A1F_WL_ISO_LANGUE.
A1F_TL_ORDER_TEXT-LANGU_ISO  = A1F_WL_ISO_LANGUE.
**** END UPD 2014/09/12 ISID11 ****
A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_CNS_ID_SYNI .
A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_SYNIBKU .
A1F_TL_ORDER_TEXT-FORMAT_COL = SPACE .
APPEND A1F_TL_ORDER_TEXT .
ENDIF .
ENDIF .

* 出荷指示備考
*  A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_CNS_ID_SYK .
*  A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_SYKSJBKU .
*  A1F_TL_ORDER_TEXT-FORMAT_COL = '*' .
READ TABLE A1F_TL_TEXTLINES_OUT WITH KEY TEXT_ID = A1F_CNS_ID_SYK
INTO A1F_TL_TEXTLINES_OUT .
IF SY-SUBRC = 0 .
IF /A1F/YLNS0011-YL_SYKSJBKU IS INITIAL .
A1F_TL_ORDER_TEXT-FUNCTION   = '003' .
ELSE .
A1F_TL_ORDER_TEXT-FUNCTION   = A1F_TL_TEXTLINES_OUT-OPERATION .
ENDIF .
A1F_TL_ORDER_TEXT-LANGU      = A1F_TL_TEXTLINES_OUT-LANGU .
A1F_TL_ORDER_TEXT-LANGU_ISO  = A1F_TL_TEXTLINES_OUT-LANGU_ISO .
A1F_TL_ORDER_TEXT-FUNCTION   = A1F_TL_TEXTLINES_OUT-OPERATION .
A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_TL_TEXTLINES_OUT-TEXT_ID .
A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_SYKSJBKU .
A1F_TL_ORDER_TEXT-FORMAT_COL = A1F_TL_TEXTLINES_OUT-FORMAT_COL .
A1F_TL_ORDER_TEXT-ITM_NUMBER = A1F_CNS_NUMBER_S .
APPEND A1F_TL_ORDER_TEXT .
ELSE.
IF NOT ( /A1F/YLNS0011-YL_SYKSJBKU IS INITIAL ).
A1F_TL_ORDER_TEXT-DOC_NUMBER = /A1F/YLNS0011-YL_VBELN .
A1F_TL_ORDER_TEXT-FUNCTION   = '005' .
**** START UPD 2014/09/12 ISID11 ****
*      A1F_TL_ORDER_TEXT-LANGU      = 'J' .
*      A1F_TL_ORDER_TEXT-LANGU_ISO  = 'JA' .
A1F_TL_ORDER_TEXT-LANGU      = SY-LANGU.
*     変換: 1 桁の SAP 言語キー -> 2 桁の ISO 言語キー
PERFORM A1F_LANGU_ISO_CHG CHANGING A1F_WL_ISO_LANGUE.
A1F_TL_ORDER_TEXT-LANGU_ISO  = A1F_WL_ISO_LANGUE.
**** END UPD 2014/09/12 ISID11 ****
A1F_TL_ORDER_TEXT-TEXT_ID    = A1F_CNS_ID_SYK .
A1F_TL_ORDER_TEXT-TEXT_LINE  = /A1F/YLNS0011-YL_SYKSJBKU .
A1F_TL_ORDER_TEXT-FORMAT_COL = SPACE .
A1F_TL_ORDER_TEXT-ITM_NUMBER = A1F_CNS_NUMBER_S .
APPEND A1F_TL_ORDER_TEXT .
ENDIF .
ENDIF .

* 受注伝票更新
CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
EXPORTING
SALESDOCUMENT    = /A1F/YLNS0011-YL_VBELN
ORDER_HEADER_IN  = A1F_WL_ORDER_HEADER_IN
ORDER_HEADER_INX = A1F_WL_ORDER_HEADER_INX
TABLES
RETURN           = A1F_TL_RETURN_SALE
ORDER_ITEM_IN    = A1F_TL_ORDER_ITEMS_IN
ORDER_ITEM_INX   = A1F_TL_ORDER_ITEMS_INX
PARTNERCHANGES   = A1F_TL_PARTNERCHANGES
PARTNERADDRESSES = A1F_TL_PARTNERADDRESSES
SCHEDULE_LINES   = A1F_TL_ORDER_SCHEDULES_IN
SCHEDULE_LINESX  = A1F_TL_ORDER_SCHEDULES_INX
CONDITIONS_IN    = A1F_TL_CONDITIONS_IN
CONDITIONS_INX   = A1F_TL_CONDITIONS_INX
ORDER_TEXT       = A1F_TL_ORDER_TEXT.
LOOP AT A1F_TL_RETURN_SALE WHERE TYPE NE 'W' .
MESSAGE ID     A1F_TL_RETURN_SALE-ID
TYPE   A1F_TL_RETURN_SALE-TYPE
NUMBER A1F_TL_RETURN_SALE-NUMBER
WITH   A1F_TL_RETURN_SALE-MESSAGE_V1
A1F_TL_RETURN_SALE-MESSAGE_V2
A1F_TL_RETURN_SALE-MESSAGE_V3
A1F_TL_RETURN_SALE-MESSAGE_V4 .
ENDLOOP .

COMMIT WORK AND WAIT .

** 受注単価変更処理
*  PERFORM A1F_SALES_PRICE_UPDATE .

MESSAGE S223(/A1F/YLMS0100) .
* 伝票登録が完了いたしました

* 2009/10/26 受注登録終了したら、初期受注数量を変更
A1F_GW_KWMENG =  /A1F/YLNS0011-YL_JTYUSU.

* 保持しているワークの初期値を、変更完了後の状態に変更する
/A1F/YLNS0011-YL_SYKSKCD = A1F_SYKSKCD_OLD .
CLEAR A1F_FLG_ADDR_CHANGE .

ENDFORM.                    " A1F_SALES_DATA_EXEC
*&---------------------------------------------------------------------*
*&      Form  A1F_PURCHASE_DATA_EXEC
*&---------------------------------------------------------------------*
*       発注伝票変更処理
*----------------------------------------------------------------------*
FORM A1F_PURCHASE_DATA_EXEC .

DATA : A1F_WL_TMP_VALUE         LIKE BAPICURR-BAPICURR .
DATA : A1F_WL_POHEADER          LIKE BAPIMEPOHEADER ,
A1F_WL_POHEADERX         LIKE BAPIMEPOHEADERX ,
A1F_WL_FLG(1).  "数量、単価、納期に変更があったらPopup

DATA : A1F_TL_RETURN_PURC       LIKE TABLE OF BAPIRET2
WITH HEADER LINE,
A1F_TL_POITEM            LIKE TABLE OF BAPIMEPOITEM
WITH HEADER LINE ,
A1F_TL_POITEMX           LIKE TABLE OF BAPIMEPOITEMX
WITH HEADER LINE ,
A1F_TL_POSCHEDULE        LIKE TABLE OF BAPIMEPOSCHEDULE
WITH HEADER LINE ,
A1F_TL_POSCHEDULEX       LIKE TABLE OF BAPIMEPOSCHEDULX
WITH HEADER LINE ,
A1F_TL_POCOND            LIKE TABLE OF BAPIMEPOCOND
WITH HEADER LINE ,
A1F_TL_POCONDX           LIKE TABLE OF BAPIMEPOCONDX
WITH HEADER LINE .

CLEAR : A1F_WL_POHEADER ,
A1F_WL_POHEADERX ,
A1F_TL_RETURN_PURC ,
A1F_TL_POITEM ,
A1F_TL_POITEMX ,
A1F_TL_POSCHEDULE ,
A1F_TL_POSCHEDULEX ,
A1F_TL_POCOND ,
A1F_TL_POCONDX .
REFRESH : A1F_TL_RETURN_PURC ,
A1F_TL_POITEM ,
A1F_TL_POITEMX ,
A1F_TL_POSCHEDULE ,
A1F_TL_POSCHEDULEX ,
A1F_TL_POCOND ,
A1F_TL_POCONDX .

* 発注ヘッダ情報
A1F_WL_POHEADER-PUR_GROUP  = /A1F/YLNS0011-EKGRP .

A1F_WL_POHEADERX-PUR_GROUP  = 'X' .

* 発注明細情報
IF /A1F/YLNS0011-YL_MSYUFLG = SPACE .
A1F_TL_POITEM-FREE_ITEM = SPACE .
ELSE .
A1F_TL_POITEM-FREE_ITEM = 'X' .
ENDIF .
A1F_TL_POITEMX-FREE_ITEM = 'X' .

A1F_TL_POITEM-PO_ITEM    = A1F_CNS_NUMBER_P .
A1F_TL_POITEM-SHORT_TEXT = /A1F/YLNS0011-YL_MAKTX_PURC .
A1F_TL_POITEM-PLANT      = /A1F/YLNS0011-YL_DWERK .
A1F_TL_POITEM-VEND_MAT   = /A1F/YLNS0011-YL_IDNLF .
A1F_TL_POITEM-QUANTITY   = /A1F/YLNS0011-YL_HTYUSU .
A1F_TL_POITEM-PO_UNIT    = /A1F/YLNS0011-YL_BSTME .
A1F_TL_POITEM-ORDERPR_UN = /A1F/YLNS0011-YL_BSTME .
A1F_TL_POITEM-NET_PRICE  = /A1F/YLNS0011-YL_HTYUTNK .
A1F_TL_POITEM-PRICE_UNIT = /A1F/YLNS0011-YL_PEINH .
A1F_TL_POITEM-SHIPPING   = /A1F/YLNS0011-YL_TYKSUKBN .
APPEND A1F_TL_POITEM .

A1F_TL_POITEMX-PO_ITEM    = A1F_CNS_NUMBER_P .
A1F_TL_POITEMX-PO_ITEMX   = 'X' .
A1F_TL_POITEMX-SHORT_TEXT = 'X' .
A1F_TL_POITEMX-PLANT      = 'X' .
A1F_TL_POITEMX-VEND_MAT   = 'X' .
A1F_TL_POITEMX-QUANTITY   = 'X' .
A1F_TL_POITEMX-PO_UNIT    = 'X' .
A1F_TL_POITEMX-ORDERPR_UN = 'X' .
A1F_TL_POITEMX-NET_PRICE  = 'X' .
A1F_TL_POITEMX-PRICE_UNIT = 'X' .
A1F_TL_POITEMX-SHIPPING   = 'X' .
APPEND A1F_TL_POITEMX .

* 条件
* 条件情報取得
SELECT KPOSN                          "条件明細番号
STUNR                          "ステップ番号
ZAEHK                          "条件カウンタ
INTO (A1F_TL_POCOND-ITM_NUMBER,
A1F_TL_POCOND-COND_ST_NO,
A1F_TL_POCOND-COND_COUNT)
FROM KONV UP TO 1 ROWS
WHERE KNUMV = A1F_WG_KNUMV_P
AND KSCHL = A1F_CNS_KSCHL_P.
*     AND KINAK = SPACE .
ENDSELECT .

CALL FUNCTION 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
EXPORTING
CURRENCY        = /A1F/YLNS0011-YL_HTYUTUK
AMOUNT_INTERNAL = /A1F/YLNS0011-YL_HTYUTNK
IMPORTING
AMOUNT_EXTERNAL = A1F_WL_TMP_VALUE.
**** START UPD 2014/09/12 ISID11 ****
*  IF SY-SUBRC = 0 .
*    A1F_TL_POCOND-COND_VALUE = A1F_WL_TMP_VALUE .
*  ELSE .
*    CLEAR A1F_TL_POCOND-COND_VALUE .
*  ENDIF .
A1F_TL_POCOND-COND_VALUE = A1F_WL_TMP_VALUE .
**** END UPD 2014/09/12 ISID11 ****

A1F_TL_POCOND-CONDITION_NO  = A1F_WG_KNUMV_P .
A1F_TL_POCOND-ITM_NUMBER    = A1F_TL_POCOND-ITM_NUMBER .
A1F_TL_POCOND-COND_ST_NO    = A1F_TL_POCOND-COND_ST_NO .
A1F_TL_POCOND-COND_COUNT    = A1F_TL_POCOND-COND_COUNT .
A1F_TL_POCOND-COND_TYPE     = A1F_CNS_KSCHL_P .
*  A1F_TL_POCOND-COND_VALUE    = /A1F/YLNS0011-YL_HTYUTNK.
A1F_TL_POCOND-CURRENCY      = /A1F/YLNS0011-YL_HTYUTUK .
A1F_TL_POCOND-COND_UNIT     = /A1F/YLNS0011-YL_BSTME.
A1F_TL_POCOND-COND_P_UNT    = /A1F/YLNS0011-YL_PEINH .
A1F_TL_POCOND-CHANGE_ID     = 'U' .
APPEND A1F_TL_POCOND .

A1F_TL_POCONDX-CONDITION_NO  = A1F_WG_KNUMV_P .
A1F_TL_POCONDX-ITM_NUMBER    = A1F_TL_POCOND-ITM_NUMBER .
A1F_TL_POCONDX-COND_ST_NO    = A1F_TL_POCOND-COND_ST_NO .
A1F_TL_POCONDX-CONDITION_NOX = 'X' .
A1F_TL_POCONDX-ITM_NUMBERX   = 'X' .
A1F_TL_POCONDX-COND_COUNT    = 'X' .
A1F_TL_POCONDX-COND_TYPE     = 'X' .
A1F_TL_POCONDX-COND_VALUE    = 'X' .
A1F_TL_POCONDX-CURRENCY      = 'X' .
A1F_TL_POCONDX-COND_UNIT     = 'X' .
A1F_TL_POCONDX-COND_P_UNT    = 'X' .
A1F_TL_POCONDX-CHANGE_ID     = 'X' .
APPEND A1F_TL_POCONDX .

* 納入日程
A1F_TL_POSCHEDULE-PO_ITEM       = A1F_CNS_NUMBER_P .
A1F_TL_POSCHEDULE-SCHED_LINE    = A1F_CNS_COUNTER .
A1F_TL_POSCHEDULE-DELIVERY_DATE = /A1F/YLNS0011-YL_EEIND .
APPEND A1F_TL_POSCHEDULE .

A1F_TL_POSCHEDULEX-PO_ITEM       = A1F_CNS_NUMBER_P .
A1F_TL_POSCHEDULEX-SCHED_LINE    = A1F_CNS_COUNTER .
A1F_TL_POSCHEDULEX-PO_ITEMX      = 'X' .
A1F_TL_POSCHEDULEX-DELIVERY_DATE = 'X' .
APPEND A1F_TL_POSCHEDULEX .

* 初期値との変更チェック
* 数量、単価、納期、直送区分に変更があった場合はBAPI実行後メッセージ
CLEAR : A1F_WL_FLG.
IF A1F_WG_MENGE NE /A1F/YLNS0011-YL_HTYUSU.
A1F_WL_FLG = 'X'.
ENDIF.
IF A1F_WG_NETPR NE /A1F/YLNS0011-YL_HTYUTNK.
A1F_WL_FLG = 'X'.
ENDIF.
IF A1F_WG_EINDT NE /A1F/YLNS0011-YL_EEIND.
A1F_WL_FLG = 'X'.
ENDIF.
IF A1F_WG_TYKSUKBN NE /A1F/YLNS0011-YL_TYKSUKBN.
A1F_WL_FLG = 'X'.
ENDIF.


* 発注伝票変更
CALL FUNCTION 'BAPI_PO_CHANGE'
EXPORTING
PURCHASEORDER = /A1F/YLNS0011-YL_EBELN
POHEADER      = A1F_WL_POHEADER
POHEADERX     = A1F_WL_POHEADERX
TABLES
RETURN        = A1F_TL_RETURN_PURC
POITEM        = A1F_TL_POITEM
POITEMX       = A1F_TL_POITEMX
POCONDHEADER  = A1F_TL_POCOND
POCONDHEADERX = A1F_TL_POCONDX
POCOND        = A1F_TL_POCOND
POCONDX       = A1F_TL_POCONDX
POSCHEDULE    = A1F_TL_POSCHEDULE
POSCHEDULEX   = A1F_TL_POSCHEDULEX.
LOOP AT A1F_TL_RETURN_PURC
WHERE NOT ( NUMBER IS INITIAL )
AND TYPE = 'E' .
MESSAGE ID A1F_TL_RETURN_PURC-ID
TYPE A1F_TL_RETURN_PURC-TYPE
NUMBER A1F_TL_RETURN_PURC-NUMBER
WITH A1F_TL_RETURN_PURC-MESSAGE_V1
A1F_TL_RETURN_PURC-MESSAGE_V2
A1F_TL_RETURN_PURC-MESSAGE_V3
A1F_TL_RETURN_PURC-MESSAGE_V4 .
ENDLOOP .

IF NOT A1F_WL_FLG IS INITIAL.
MESSAGE I227(/A1F/YLMS0100) .
CLEAR A1F_WL_FLG.
ENDIF.

COMMIT WORK AND WAIT .

* 発注テキスト情報変更
PERFORM A1F_EXIT_SAVE_POTEXT .

MESSAGE S223(/A1F/YLMS0100) .
* 伝票登録が完了いたしました

ENDFORM.                    " A1F_PURCHASE_DATA_EXEC
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_VA02
*&---------------------------------------------------------------------*
*       受注伝票変更(VA02)
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_VA02 .

* ロック解除
PERFORM  A1F_SALES_DATA_UNLOCK  USING /A1F/YLNS0011-YL_VBELN .

SET PARAMETER ID 'AUN' FIELD /A1F/YLNS0011-YL_VBELN.

CALL TRANSACTION 'VA02' AND SKIP FIRST SCREEN .

WAIT UP TO 2 SECONDS .

* 再ロック
PERFORM  A1F_SALES_DATA_LOCK  USING /A1F/YLNS0011-YL_VBELN .

ENDFORM.                    " A1F_CALL_TRAN_VA02
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_ME22N
*&---------------------------------------------------------------------*
*       発注伝票変更(ME22N)
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_ME22N .

* ロック解除
PERFORM  A1F_PURCHASE_DATA_UNLOCK  USING /A1F/YLNS0011-YL_EBELN .

SET PARAMETER ID 'BES' FIELD /A1F/YLNS0011-YL_EBELN.

CALL TRANSACTION 'ME22N' .

WAIT UP TO 2 SECONDS .

* 再ロック
PERFORM  A1F_PURCHASE_DATA_LOCK  USING /A1F/YLNS0011-YL_EBELN .

ENDFORM.                    " A1F_CALL_TRAN_ME22N
*&---------------------------------------------------------------------*
*&      Form  a1f_exchange_sunit_to_bnit
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_EXCHANGE_SUNIT_TO_BNIT .

DATA : A1F_WL_MARM LIKE MARM .

* 販売数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_VRKME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_JTYUSU IS INITIAL .
/A1F/YLNS0011-YL_JTYUSU_C = /A1F/YLNS0011-YL_JTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_SALE
AND    MEINH  = /A1F/YLNS0011-YL_VRKME .
IF SY-SUBRC NE 0 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_VRKME' .
MESSAGE E201(/A1F/YLMS0100) WITH
/A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_VRKME.
*     品目 &1 に対して代替単位 &2 は登録されていません。
ENDIF .

/A1F/YLNS0011-YL_JTYUSU_C = ( /A1F/YLNS0011-YL_JTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " a1f_exchange_sunit_to_bnit
*&---------------------------------------------------------------------*
*&      Form  a1f_exchange_punit_to_bunit
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_EXCHANGE_PUNIT_TO_BUNIT .

DATA : A1F_WL_MARM LIKE MARM .

* 発注数量単位から基本数量単位への変換
IF /A1F/YLNS0011-YL_BSTME = /A1F/YLNS0011-YL_MEINS
OR /A1F/YLNS0011-YL_HTYUSU IS INITIAL .
/A1F/YLNS0011-YL_HTYUSU_C = /A1F/YLNS0011-YL_HTYUSU .
ELSE .
CLEAR A1F_WL_MARM .
SELECT SINGLE * FROM  MARM
INTO A1F_WL_MARM
WHERE  MATNR  = /A1F/YLNS0011-YL_MATNR_PURC
AND    MEINH  = /A1F/YLNS0011-YL_BSTME .
IF SY-SUBRC NE 0 .
SET CURSOR FIELD '/A1F/YLNS0011-YL_BSTME' .
MESSAGE E201(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_MATNR_PURC
/A1F/YLNS0011-YL_BSTME.
*     品目 &1 に対して代替単位 &2 は登録されていません。
ENDIF .

/A1F/YLNS0011-YL_HTYUSU_C = ( /A1F/YLNS0011-YL_HTYUSU
* A1F_WL_MARM-UMREZ )
/ A1F_WL_MARM-UMREN .
ENDIF .

ENDFORM.                    " a1f_exchange_punit_to_bunit
*&---------------------------------------------------------------------*
*&      Form  a1f_get_YL_EEIND
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_GET_YL_EEIND .

IF NOT ( /A1F/YLNS0011-YL_EEIND IS INITIAL ) .
EXIT .
ENDIF .



DATA : A1F_WL_ADD_DAY TYPE P .
DATA : A1F_WL_TMP_DAY LIKE SY-DATUM .
DATA : A1F_WL_T001W_FABKL LIKE T001W-FABKL.


IF /A1F/YLNS0011-YL_EBELN IS INITIAL .
EXIT .
ENDIF .

IF /A1F/YLNS0011-YL_TYKSUKBN IS INITIAL .

SELECT SINGLE FABKL FROM  T001W
INTO A1F_WL_T001W_FABKL
WHERE  WERKS  = /A1F/YLNS0011-YL_DWERK .
IF SY-SUBRC NE 0 .
EXIT .
ENDIF .


A1F_WL_ADD_DAY = A1F_WG_MARC-WEBAZ + 3 .

/A1F/YLNS0011-YL_EEIND = /A1F/YLNS0011-YL_VDATU .

DO A1F_WL_ADD_DAY TIMES .
IF /A1F/YLNS0011-YL_EEIND <= SY-DATUM .
EXIT .
ENDIF .
/A1F/YLNS0011-YL_EEIND = /A1F/YLNS0011-YL_EEIND - 1 .
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
CORRECT_OPTION               = '-'
DATE                         = /A1F/YLNS0011-YL_EEIND
FACTORY_CALENDAR_ID          = A1F_WL_T001W_FABKL
IMPORTING
DATE                         = A1F_WL_TMP_DAY
EXCEPTIONS
CALENDAR_BUFFER_NOT_LOADABLE = 1
CORRECT_OPTION_INVALID       = 2
DATE_AFTER_RANGE             = 3
DATE_BEFORE_RANGE            = 4
DATE_INVALID                 = 5
FACTORY_CALENDAR_NOT_FOUND   = 6
OTHERS                       = 7.
IF SY-SUBRC <> 0.
EXIT .
ENDIF.

/A1F/YLNS0011-YL_EEIND = A1F_WL_TMP_DAY .

ENDDO .
ELSE .
/A1F/YLNS0011-YL_EEIND = /A1F/YLNS0011-YL_VDATU .
ENDIF .

DATA : A1F_WL_TMP_EEIND LIKE /A1F/YLNS0011-YL_EEIND .
A1F_WL_TMP_EEIND = SY-DATUM .
DO A1F_TG_INFORECORD_PURCHORG-PLND_DELRY TIMES .
A1F_WL_TMP_EEIND = A1F_WL_TMP_EEIND + 1 .
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
CORRECT_OPTION               = '+'
DATE                         = A1F_WL_TMP_EEIND
FACTORY_CALENDAR_ID          = A1F_WL_T001W_FABKL
IMPORTING
DATE                         = A1F_WL_TMP_DAY
EXCEPTIONS
CALENDAR_BUFFER_NOT_LOADABLE = 1
CORRECT_OPTION_INVALID       = 2
DATE_AFTER_RANGE             = 3
DATE_BEFORE_RANGE            = 4
DATE_INVALID                 = 5
FACTORY_CALENDAR_NOT_FOUND   = 6
OTHERS                       = 7.
IF SY-SUBRC <> 0.
EXIT .
ENDIF.

A1F_WL_TMP_EEIND = A1F_WL_TMP_DAY .
ENDDO .

IF A1F_WL_TMP_EEIND > /A1F/YLNS0011-YL_EEIND .
MESSAGE W221(/A1F/YLMS0100) WITH A1F_WL_TMP_EEIND .
*   納入日付に間に合いますか？　現実的な納入日付は &1 です
ENDIF .

ENDFORM.                    " a1f_get_YL_EEIND
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_SAUFT
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_A1F_WG_BILLING_PARTY_SIM  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_SAUFT
CHANGING P_BILLING_PARTY STRUCTURE BAPIPAYER.

IF NOT ( P_BILLING_PARTY-ORDER_VALS IS INITIAL ) .
EXIT .
ENDIF .

DATA A1F_WL_OLIKW LIKE S067-OLIKW .
CLEAR A1F_WL_OLIKW .
SELECT  OLIKW
INTO  A1F_WL_OLIKW
FROM  S067 UP TO 1 ROWS
WHERE  KKBER = P_BILLING_PARTY-C_CTR_AREA
AND  KNKLI = P_BILLING_PARTY-CRED_ACCNT.
ENDSELECT .
IF SY-SUBRC = 0 .
P_BILLING_PARTY-ORDER_VALS = A1F_WL_OLIKW .
ELSE.
CLEAR P_BILLING_PARTY-ORDER_VALS .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_SAUFT
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_JTYUTNK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_/A1F/YLNS0011_YL_JTYUTNK  text
*      <--P_/A1F/YLNS0011_YL_KPEIN  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_JTYUTNK CHANGING P_JTYUTNK
P_KPEIN.

IF NOT ( P_JTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

DATA : A1F_TL_A901 LIKE TABLE OF A901 WITH HEADER LINE ,
A1F_WL_KONH LIKE KONH ,                            "#EC NEEDED
A1F_TL_KONP LIKE TABLE OF KONP WITH HEADER LINE ,
A1F_TL_KONM LIKE TABLE OF KONM WITH HEADER LINE .

SELECT        * FROM  A901
INTO TABLE A1F_TL_A901
WHERE  KAPPL     = 'V'
AND    KSCHL     = A1F_CNS_KSCHL
AND    VKORGAU   = /A1F/YLNS0011-VKORG
AND    VTWEG     = /A1F/YLNS0011-VTWEG
AND    SPART     = /A1F/YLNS0011-SPART
AND    KUNNR     = /A1F/YLNS0011-YL_TKISKCD
AND    DATBI    >= /A1F/YLNS0011-YL_AUDAT
AND    DATAB    <= /A1F/YLNS0011-YL_AUDAT
AND    ZZZKDMAT  = /A1F/YLNS0011-YL_KDMAT .

READ TABLE A1F_TL_A901 INDEX 1 .

SELECT SINGLE * FROM  KONH
INTO A1F_WL_KONH
WHERE  KNUMH  = A1F_TL_A901-KNUMH.

SELECT        * FROM  KONP
INTO TABLE A1F_TL_KONP
WHERE  KNUMH  = A1F_TL_A901-KNUMH.

READ TABLE A1F_TL_KONP INDEX 1 .

P_KPEIN = A1F_TL_KONP-KPEIN .

IF /A1F/YLNS0011-YL_VRKME IS INITIAL .
IF A1F_TL_KONP-KMEIN
NE /A1F/YLNS0011-YL_MEINS .
MESSAGE E224(/A1F/YLMS0100) .
ENDIF .
ELSE .
IF A1F_TL_KONP-KMEIN
NE /A1F/YLNS0011-YL_VRKME .
MESSAGE E224(/A1F/YLMS0100) .
ENDIF .
ENDIF .

SELECT        * FROM  KONM
INTO TABLE A1F_TL_KONM
WHERE  KNUMH  = A1F_TL_A901-KNUMH.

DATA : BEGIN OF A1F_TL_TYP_KONM ,
KSTBM_F LIKE KONM-KSTBM ,
KSTBM_T LIKE KONM-KSTBM ,
KBETR   LIKE KONM-KBETR ,
END OF A1F_TL_TYP_KONM .

DATA A1F_TL_TMP_KONM LIKE TABLE OF A1F_TL_TYP_KONM
WITH HEADER LINE .

IF SY-SUBRC NE 0 .
P_JTYUTNK = A1F_TL_KONP-KBETR .
ELSE .
LOOP AT A1F_TL_KONM .
IF SY-TABIX = 1 .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ELSE .
A1F_TL_TMP_KONM-KSTBM_T = A1F_TL_KONM-KSTBM .
APPEND A1F_TL_TMP_KONM .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ENDIF .
AT LAST .
A1F_TL_TMP_KONM-KSTBM_T = '999999999999.999' .
APPEND A1F_TL_TMP_KONM .
ENDAT .
ENDLOOP .

LOOP AT A1F_TL_TMP_KONM
WHERE KSTBM_F <= /A1F/YLNS0011-YL_JTYUSU
AND KSTBM_T >  /A1F/YLNS0011-YL_JTYUSU.
P_JTYUTNK = A1F_TL_TMP_KONM-KBETR .
EXIT .
ENDLOOP .
IF SY-SUBRC NE 0 .
CLEAR P_JTYUTNK  .
ENDIF .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_JTYUTNK
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_SALES_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_GET_SALES_PRICE.

IF NOT ( /A1F/YLNS0011-YL_JTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

* BAPIによる受注関連データの取得
CLEAR : A1F_WG_SOLD_TO_PARTY_SIM ,
A1F_WG_SHIP_TO_PARTY_SIM ,
A1F_WG_BILLING_PARTY_SIM ,
A1F_WG_RETURN_SIM ,
A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_MESSAGETABLE_SIM .
REFRESH : A1F_TG_ORDER_SCHEDULE_IN_SIM ,
A1F_TG_ORDER_ITEMS_OUT_SIM ,
A1F_TG_ORDER_SCHEDULE_EX_SIM ,
A1F_TG_ORDER_CONDITION_EX_SIM ,
A1F_TG_ORDER_INCOMPLETE_SIM ,
A1F_TG_MESSAGETABLE_SIM ,
A1F_TG_MESSAGETABLE_SIM .

A1F_WG_ORDER_HEADER_IN_SIM-DOC_TYPE = /A1F/YLNS0011-YL_AUART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_ORG = /A1F/YLNS0011-VKORG .
A1F_WG_ORDER_HEADER_IN_SIM-DISTR_CHAN = /A1F/YLNS0011-VTWEG .
A1F_WG_ORDER_HEADER_IN_SIM-DIVISION = /A1F/YLNS0011-SPART .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_GRP = /A1F/YLNS0011-VKGRP .
A1F_WG_ORDER_HEADER_IN_SIM-SALES_OFF = /A1F/YLNS0011-VKBUR .
IF /A1F/YLNS0011-YL_AUDAT IS INITIAL .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = SY-DATUM .
ELSE .
A1F_WG_ORDER_HEADER_IN_SIM-PRICE_DATE = /A1F/YLNS0011-YL_AUDAT .
ENDIF .

CLEAR A1F_TG_ORDER_PARTNERS_SIM .
REFRESH A1F_TG_ORDER_PARTNERS_SIM .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_ROLE = 'SP' .
A1F_TG_ORDER_PARTNERS_SIM-PARTN_NUMB = /A1F/YLNS0011-YL_TKISKCD .
APPEND A1F_TG_ORDER_PARTNERS_SIM .

CLEAR A1F_TG_ORDER_ITEMS_IN_SIM .
REFRESH A1F_TG_ORDER_ITEMS_IN_SIM .
A1F_TG_ORDER_ITEMS_IN_SIM-MATERIAL = /A1F/YLNS0011-YL_MATNR_SALE .
A1F_TG_ORDER_ITEMS_IN_SIM-PLANT = /A1F/YLNS0011-YL_DWERK .
*>>> ES-UP mod 2013/01/08 課題№239
*  A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = /A1F/YLNS0011-YL_JTYUSU.
A1F_TG_ORDER_ITEMS_IN_SIM-REQ_QTY = /A1F/YLNS0011-YL_JTYUSU * 1000.
*<<< ES-UP mod 2013/01/08 課題№239
APPEND A1F_TG_ORDER_ITEMS_IN_SIM .

CALL FUNCTION 'BAPI_SALESORDER_SIMULATE'
EXPORTING
ORDER_HEADER_IN     = A1F_WG_ORDER_HEADER_IN_SIM
CONVERT_PARVW_AUART = 'X'
IMPORTING
SOLD_TO_PARTY       = A1F_WG_SOLD_TO_PARTY_SIM
SHIP_TO_PARTY       = A1F_WG_SHIP_TO_PARTY_SIM
BILLING_PARTY       = A1F_WG_BILLING_PARTY_SIM
RETURN              = A1F_WG_RETURN_SIM
TABLES
ORDER_ITEMS_IN      = A1F_TG_ORDER_ITEMS_IN_SIM
ORDER_PARTNERS      = A1F_TG_ORDER_PARTNERS_SIM
ORDER_SCHEDULE_IN   = A1F_TG_ORDER_SCHEDULE_IN_SIM
ORDER_ITEMS_OUT     = A1F_TG_ORDER_ITEMS_OUT_SIM
ORDER_SCHEDULE_EX   = A1F_TG_ORDER_SCHEDULE_EX_SIM
ORDER_CONDITION_EX  = A1F_TG_ORDER_CONDITION_EX_SIM
ORDER_INCOMPLETE    = A1F_TG_ORDER_INCOMPLETE_SIM
MESSAGETABLE        = A1F_TG_MESSAGETABLE_SIM
PARTNERADDRESSES    = A1F_TG_PARTNERADDRESSES_SIM.

PERFORM A1F_EXIT_GET_JTYUTNK
CHANGING /A1F/YLNS0011-YL_JTYUTNK
/A1F/YLNS0011-YL_KPEIN .

A1F_WG_MASTER_TANKA_SALE = /A1F/YLNS0011-YL_JTYUTNK .

ENDFORM.                    " A1F_GET_SALES_PRICE
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_save_potext
*&---------------------------------------------------------------------*
*       発注テキスト情報変更
*----------------------------------------------------------------------*
FORM A1F_EXIT_SAVE_POTEXT.
*>>> 【ES-UP】課題№241 2013/01/10
*  DATA : A1F_TL_BDCDATA LIKE TABLE OF BDCDATA
*                                   WITH HEADER LINE .
*  DATA : A1F_TL_SP_RETURN LIKE TABLE OF BAPIRET2
*                                 WITH HEADER LINE .
*
*  PERFORM A1F_GENERATE_BDCDATA
*         TABLES A1F_TL_BDCDATA
*         USING:
*           'SAPMM06E'             '0105'                  'X',
*           'BDC_OKCODE'           '/00'                   ' ',
*           'RM06E-BSTNR'          /A1F/YLNS0011-YL_EBELN  ' ',
*
*           'SAPMM06E'             '0120'                  'X',
*           'BDC_OKCODE'           '=TXP'                  ' ',
*           'RM06E-TCSELFLAG(01)'  'X'                     ' '.
*
*  PERFORM A1F_GENERATE_BDCDATA
*         TABLES A1F_TL_BDCDATA
*         USING:
*           'SAPMM06E'           '0106'                            'X',
*           'BDC_OKCODE'         '=VW'                             ' ',
*           'RM06E-SELKZ(01)'    'X'                               ' ',
*           'RM06E-LTEX1(01)'    /A1F/YLNS0011-YL_TUMNSYBKU        ' ',
*           'RM06E-SELKZ(03)'    'X'                               ' ',
*           'RM06E-LTEX1(03)'    /A1F/YLNS0011-YL_HTYUZNITRNBKU    ' '.
*
*  PERFORM A1F_GENERATE_BDCDATA
*         TABLES A1F_TL_BDCDATA
*         USING:
*           'SAPMM06E'           '0106'                        'X',
*           'BDC_OKCODE'         '=BU'                         ' ',
*           'RM06E-SELKZ(01)'    'X'                           ' ',
*           'RM06E-LTEX1(01)'    /A1F/YLNS0011-YL_EDIBKU       ' ',
*           'RM06E-LTEX2(01)'    /A1F/YLNS0011-YL_EDIBKU2      ' ',
*           'RM06E-SELKZ(02)'    'X'                           ' ',
*           'RM06E-LTEX1(02)'    /A1F/YLNS0011-YL_EDISNT       ' ',
*           'RM06E-SELKZ(03)'    'X'                           ' ',
*           'RM06E-LTEX1(03)'    /A1F/YLNS0011-YL_SMDNEDIBKU   ' '.
*
*  PERFORM A1F_GENERATE_BDCDATA
*         TABLES A1F_TL_BDCDATA
*         USING:
*           'SAPLSPO1'      '0300'    'X',
*           'BDC_OKCODE'    '=YES'    ' '.
*
*
** 発注伝票更新（テキスト）
*  PERFORM A1F_CALL_TRANSCTION TABLES A1F_TL_BDCDATA
*                                     A1F_TL_SP_RETURN
*                            USING 'ME22'.
*
DATA: I_TLINE  TYPE TABLE OF TLINE,
L_TLINE  TYPE TLINE.
* 注文書備考(購買発注テキスト)
CLEAR: L_TLINE, I_TLINE.
L_TLINE-TDFORMAT = '*'.
L_TLINE-TDLINE = /A1F/YLNS0011-YL_TUMNSYBKU.
APPEND L_TLINE TO I_TLINE.
APPEND LINES OF I_EKPO_F02 FROM 2 TO I_TLINE.
PERFORM EKPO_SAVE_TEXT USING /A1F/YLNS0011-YL_EBELN
'F02'
I_TLINE.
* 発注残一覧備考
CLEAR: L_TLINE, I_TLINE.
L_TLINE-TDFORMAT = '*'.
L_TLINE-TDLINE = /A1F/YLNS0011-YL_HTYUZNITRNBKU.
APPEND L_TLINE TO I_TLINE.
APPEND LINES OF I_EKPO_F04 FROM 2 TO I_TLINE.
PERFORM EKPO_SAVE_TEXT USING /A1F/YLNS0011-YL_EBELN
'F04'
I_TLINE.
* EDI備考(購買発注テキスト)
CLEAR: L_TLINE, I_TLINE.
L_TLINE-TDFORMAT = '*'.
L_TLINE-TDLINE = /A1F/YLNS0011-YL_EDIBKU.
APPEND L_TLINE TO I_TLINE.
L_TLINE-TDLINE = /A1F/YLNS0011-YL_EDIBKU2.
APPEND L_TLINE TO I_TLINE.
APPEND LINES OF I_EKPO_F05 FROM 3 TO I_TLINE.
PERFORM EKPO_SAVE_TEXT USING /A1F/YLNS0011-YL_EBELN
'F05'
I_TLINE.
* EDI送信用(その他)
CLEAR: L_TLINE, I_TLINE.
L_TLINE-TDFORMAT = '*'.
L_TLINE-TDLINE = /A1F/YLNS0011-YL_EDISNT.
APPEND L_TLINE TO I_TLINE.
APPEND LINES OF I_EKPO_F06 FROM 2 TO I_TLINE.
PERFORM EKPO_SAVE_TEXT USING /A1F/YLNS0011-YL_EBELN
'F06'
I_TLINE.
* 住電試験書区分
CLEAR: L_TLINE, I_TLINE.
L_TLINE-TDFORMAT = '*'.
L_TLINE-TDLINE = /A1F/YLNS0011-YL_SMDNEDIBKU.
APPEND L_TLINE TO I_TLINE.
APPEND LINES OF I_EKPO_F07 FROM 2 TO I_TLINE.
PERFORM EKPO_SAVE_TEXT USING /A1F/YLNS0011-YL_EBELN
'F07'
I_TLINE.
*<<< 【ES-UP】課題№241 2013/01/10
ENDFORM.                    " A1F_EXIT_save_potext
*>>> 【ES-UP】課題№241 2013/01/10
FORM EKPO_SAVE_TEXT USING L_EBELN  TYPE EKPO-EBELN
L_TDID   TYPE THEAD-TDID
I_TLINE  TYPE TLINE_T.
DATA: L_HEADER TYPE THEAD,
L_EBELP  TYPE EKPO-EBELP VALUE '00010'.

L_HEADER-TDOBJECT     = 'EKPO'.
L_HEADER-TDNAME(10)   = L_EBELN.
L_HEADER-TDNAME+10(5) = L_EBELP.
L_HEADER-TDID         = L_TDID.
L_HEADER-TDSPRAS      = SY-LANGU.
*
CALL FUNCTION 'SAVE_TEXT'
EXPORTING
HEADER          = L_HEADER
SAVEMODE_DIRECT = 'X'
TABLES
LINES           = I_TLINE
EXCEPTIONS
ID              = 1  "テキストID が無効
LANGUAGE        = 2  "言語が無効
NAME            = 3  "テキスト名が無効
OBJECT          = 4. "テキストオブジェクトが無効
COMMIT WORK.
ENDFORM.                    "ekpo_save_text
*<<< 【ES-UP】課題№241 2013/01/10
*&---------------------------------------------------------------------*
*&      Form  a1f_GENERATE_BDCDATA
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TL_BDCDATA  text
*      -->P_2256   text
*      -->P_2257   text
*      -->P_2258   text
*----------------------------------------------------------------------*
FORM A1F_GENERATE_BDCDATA
TABLES   P_A1F_TL_BDCDATA STRUCTURE BDCDATA
USING    P_PROGRAM P_DYNPRO P_DYNBEGIN.

CLEAR P_A1F_TL_BDCDATA.

IF P_DYNBEGIN = 'X'.
P_A1F_TL_BDCDATA-PROGRAM  = P_PROGRAM.
P_A1F_TL_BDCDATA-DYNPRO   = P_DYNPRO.
P_A1F_TL_BDCDATA-DYNBEGIN = P_DYNBEGIN.
APPEND P_A1F_TL_BDCDATA.
ELSEIF P_DYNBEGIN = ' '.
P_A1F_TL_BDCDATA-FNAM = P_PROGRAM.
P_A1F_TL_BDCDATA-FVAL = P_DYNPRO.
APPEND P_A1F_TL_BDCDATA.
ENDIF.

ENDFORM.                    " a1f_GENERATE_BDCDATA
*&---------------------------------------------------------------------*
*&      Form  a1f_CALL_TRANSCTION
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_A1F_TL_BDCDATA  text
*      -->P_P_A1F_TL_KNMT_RETURN  text
*      -->P_2281   text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRANSCTION  TABLES   P_A1F_TL_BDCDATA
STRUCTURE BDCDATA
P_BAPIRET2
STRUCTURE BAPIRET2
USING  P_TCODE .

DATA : A1F_TL_BDCMSGCOLL LIKE TABLE OF BDCMSGCOLL
WITH HEADER LINE .

DATA A1F_WL_SY_SUBRC LIKE SY-SUBRC .

CLEAR P_BAPIRET2 .
REFRESH P_BAPIRET2 .

DATA A1F_WL_OPT LIKE CTU_PARAMS .

A1F_WL_OPT-DISMODE = 'E' .
A1F_WL_OPT-UPDMODE = 'S' .
A1F_WL_OPT-DEFSIZE = 'X' .

CALL TRANSACTION P_TCODE
USING P_A1F_TL_BDCDATA
OPTIONS FROM A1F_WL_OPT
MESSAGES INTO A1F_TL_BDCMSGCOLL .

A1F_WL_SY_SUBRC = SY-SUBRC .

LOOP AT A1F_TL_BDCMSGCOLL .
P_BAPIRET2-TYPE = A1F_TL_BDCMSGCOLL-MSGTYP .
P_BAPIRET2-ID = A1F_TL_BDCMSGCOLL-MSGID.
P_BAPIRET2-NUMBER = A1F_TL_BDCMSGCOLL-MSGNR.
P_BAPIRET2-MESSAGE_V1 = A1F_TL_BDCMSGCOLL-MSGV1.
P_BAPIRET2-MESSAGE_V2 = A1F_TL_BDCMSGCOLL-MSGV2.
P_BAPIRET2-MESSAGE_V3 = A1F_TL_BDCMSGCOLL-MSGV3.
P_BAPIRET2-MESSAGE_V4 = A1F_TL_BDCMSGCOLL-MSGV4.
APPEND P_BAPIRET2 .
ENDLOOP.

SY-SUBRC = A1F_WL_SY_SUBRC .

ENDFORM.                    " a1f_CALL_TRANSCTION
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PURCHES_PRICE
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_GET_PURCHES_PRICE.

IF NOT ( /A1F/YLNS0011-YL_HTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

PERFORM A1F_EXIT_GET_HTYUTNK
CHANGING /A1F/YLNS0011-YL_HTYUTNK
/A1F/YLNS0011-YL_PEINH .

ENDFORM.                    " A1F_GET_PURCHES_PRICE
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_HTYUTNK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_/A1F/YLNS0011_YL_HTYUTNK  text
*      <--P_/A1F/YLNS0011_YL_PEINH  text
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_HTYUTNK CHANGING P_HTYUTNK
P_PEINH.

IF NOT ( P_HTYUTNK IS INITIAL ) .
EXIT .
ENDIF .

DATA : A1F_TL_A017 LIKE TABLE OF A017 WITH HEADER LINE ,
A1F_WL_KONH LIKE KONH ,                            "#EC NEEDED
A1F_TL_KONP LIKE TABLE OF KONP WITH HEADER LINE ,
A1F_TL_KONM LIKE TABLE OF KONM WITH HEADER LINE .

SELECT        * FROM  A017
INTO TABLE A1F_TL_A017
WHERE  KAPPL     = 'M'
AND    EKORG   = /A1F/YLNS0011-EKORG
AND    WERKS   = /A1F/YLNS0011-YL_DWERK
AND    LIFNR     = /A1F/YLNS0011-YL_SIRSKCD
AND    DATBI    >= /A1F/YLNS0011-YL_BEDAT
AND    DATAB    <= /A1F/YLNS0011-YL_BEDAT
AND    MATNR  = /A1F/YLNS0011-YL_MATNR_PURC .

LOOP AT A1F_TL_A017 .
IF A1F_TL_A017-KSCHL(1) NE 'Z' .
DELETE A1F_TL_A017 .
ENDIF .
ENDLOOP .

READ TABLE A1F_TL_A017 INDEX 1 .

SELECT SINGLE * FROM  KONH
INTO A1F_WL_KONH
WHERE  KNUMH  = A1F_TL_A017-KNUMH.

SELECT        * FROM  KONP
INTO TABLE A1F_TL_KONP
WHERE  KNUMH  = A1F_TL_A017-KNUMH.

READ TABLE A1F_TL_KONP INDEX 1 .

P_PEINH = A1F_TL_KONP-KPEIN .

SELECT        * FROM  KONM
INTO TABLE A1F_TL_KONM
WHERE  KNUMH  = A1F_TL_A017-KNUMH.

DATA : BEGIN OF A1F_TL_TYP_KONM ,
KSTBM_F LIKE KONM-KSTBM ,
KSTBM_T LIKE KONM-KSTBM ,
KBETR   LIKE KONM-KBETR ,
END OF A1F_TL_TYP_KONM .

DATA A1F_TL_TMP_KONM LIKE TABLE OF A1F_TL_TYP_KONM
WITH HEADER LINE .

IF SY-SUBRC NE 0 .
P_HTYUTNK = A1F_TL_KONP-KBETR .
A1F_WG_MASTER_TANKA_PURC = A1F_TL_KONP-KBETR .
ELSE .
LOOP AT A1F_TL_KONM .
IF SY-TABIX = 1 .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ELSE .
A1F_TL_TMP_KONM-KSTBM_T = A1F_TL_KONM-KSTBM .
APPEND A1F_TL_TMP_KONM .
A1F_TL_TMP_KONM-KSTBM_F = A1F_TL_KONM-KSTBM .
A1F_TL_TMP_KONM-KBETR   = A1F_TL_KONM-KBETR .
ENDIF .
AT LAST .
A1F_TL_TMP_KONM-KSTBM_T = '999999999999.999' .
APPEND A1F_TL_TMP_KONM .
ENDAT .
ENDLOOP .

LOOP AT A1F_TL_TMP_KONM
WHERE KSTBM_F <= /A1F/YLNS0011-YL_HTYUSU
AND KSTBM_T >  /A1F/YLNS0011-YL_HTYUSU.
P_HTYUTNK = A1F_TL_TMP_KONM-KBETR .
A1F_WG_MASTER_TANKA_PURC = A1F_TL_TMP_KONM-KBETR .
EXIT .
ENDLOOP .
IF SY-SUBRC NE 0 .
CLEAR P_HTYUTNK  .
ENDIF .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_HTYUTNK
*&---------------------------------------------------------------------*
*&      Form  A1F_EXIT_GET_addr_check
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      -->P_SUBRC  戻り値
*----------------------------------------------------------------------*
FORM A1F_EXIT_GET_ADDR_CHECK USING    P_SUBRC.

DATA : A1F_TL_B951  LIKE TABLE OF B951 WITH HEADER LINE ,
A1F_WL_NACHA LIKE NACH-NACHA .

SELECT * FROM  B951
INTO TABLE A1F_TL_B951
WHERE LIFNR = /A1F/YLNS0011-YL_SIRSKCD.

READ TABLE A1F_TL_B951 INDEX 1 .

SELECT SINGLE NACHA FROM  NACH
INTO A1F_WL_NACHA
WHERE KNUMH = A1F_TL_B951-KNUMH.

IF A1F_WL_NACHA = 6 .                 "EDI
P_SUBRC = 9 .
ENDIF .

ENDFORM.                    " A1F_EXIT_GET_addr_check
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_YMP120TC001
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_YMP120TC001.


SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'KUN' FIELD /A1F/YLNS0011-YL_TKISKCD.
SET PARAMETER ID 'LIF' FIELD /A1F/YLNS0011-YL_SIRSKCD.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
CALL TRANSACTION 'ZMP2' .

ENDFORM.                    " A1F_CALL_TRAN_YMP120TC001
*&---------------------------------------------------------------------*
*&      Form  A1F_CHECK_AND_PICK_DATA
*&---------------------------------------------------------------------*
*       出荷先住所変更対応
*----------------------------------------------------------------------*
FORM A1F_CHECK_AND_PICK_DATA.

DATA: A1F_WL_CURSORFIELD(100).

GET CURSOR FIELD A1F_WL_CURSORFIELD.

IF A1F_WL_CURSORFIELD = '/A1F/YLNS0011-YL_SYKSKCD'
AND NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .

PERFORM A1F_POPUP_SYKSKDATA .

ENDIF .

ENDFORM.                    " A1F_CHECK_AND_PICK_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_POPUP_SYKSKDATA
*&---------------------------------------------------------------------*
*       出荷先住所変更対応
*----------------------------------------------------------------------*
FORM A1F_POPUP_SYKSKDATA.

TYPES: BEGIN OF LV09A_ATTRIBUTES_SHOW_WA,
ABLAD TYPE XFLAG,
STCEG TYPE XFLAG,
STCD1 TYPE XFLAG,
STCD2 TYPE XFLAG,
STCD3 TYPE XFLAG,
STCD4 TYPE XFLAG,
STCDT TYPE XFLAG,
STKZN TYPE XFLAG,
J_1KFREPRE TYPE XFLAG,
J_1KFTBUS TYPE XFLAG,
J_1KFTIND TYPE XFLAG           .
TYPES: END OF LV09A_ATTRIBUTES_SHOW_WA.
DATA A1F_WL_FIF_ATTRIBUTES_S TYPE LV09A_ATTRIBUTES_SHOW_WA .

A1F_WL_FIF_ATTRIBUTES_S-ABLAD = 'X' .
A1F_WL_FIF_ATTRIBUTES_S-STCEG = 'X' .

CALL FUNCTION 'SD_PARTNER_ADDR_DIALOG_INTERN'
EXPORTING
FIF_ADDRESS_NUMBER           = A1F_WG_ADRNR_SH
FIF_ADRDA                    = 'B'
FIF_ADDRESS_HANDLE_TO_CREATE = 'WE $0001'
FIF_ATTRIBUTES               = A1F_WG_FEF_ATTRIBUTES
FIF_ATTRIBUTES_SHOWN         = A1F_WL_FIF_ATTRIBUTES_S
FIF_TITLE_PARVW              = 'WE'
IMPORTING
FES_ADDR1_COMPLETE           = A1F_WG_FES_ADDR1_COMPLETE
FES_VBADR                    = A1F_WG_FES_VBADR
FEF_ATTRIBUTES               = A1F_WG_FEF_ATTRIBUTES
FEF_CAM_CHANGED              = A1F_FLG_ADDR_CHANGE
FES_NEW_ADDRESS              = A1F_WG_ADDR1_OUT
EXCEPTIONS
INTERNAL_ERROR               = 1
NO_ADDRESS                   = 2
OTHERS                       = 3.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " A1F_POPUP_SYKSKDATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_INITIAL_DATA2
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_GET_INITIAL_DATA2.

* ローカル定義
DATA : A1F_WL_MBEW LIKE MBEW .                            "#EC NEEDED


IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
*   営業所の設定
IF /A1F/YLNS0011-VKBUR IS INITIAL .
/A1F/YLNS0011-VKBUR = A1F_WG_VKBUR .
ENDIF .
IF /A1F/YLNS0011-VKBUR IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-VKBUR' .
MESSAGE E203(/A1F/YLMS0100) .
*     営業所が未入力です
ENDIF .

*   営業グループの設定
IF /A1F/YLNS0011-VKGRP IS INITIAL .
/A1F/YLNS0011-VKGRP = A1F_WG_VKGRP .
ENDIF .
IF /A1F/YLNS0011-VKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-VKGRP' .
MESSAGE E204(/A1F/YLMS0100) .
*     営業グループが未入力です
ENDIF .

*   プラントの設定
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
/A1F/YLNS0011-YL_DWERK = A1F_WG_WERKS_S .
ENDIF .
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK' .
MESSAGE E207(/A1F/YLMS0100) .
*     プラントが未入力です
ENDIF .

**** START ADD 2014/09/12 ISID11 ****
*   会社コードとプラントの関連チェック
PERFORM A1F_CHK_INITIAL_WERKS.
**** END ADD 2014/09/12 ISID11 ****

*   組み合わせチェック
SELECT * FROM MBEW
INTO A1F_WL_MBEW UP TO 1 ROWS
WHERE MATNR = /A1F/YLNS0011-YL_MATNR_SALE
AND BWKEY = /A1F/YLNS0011-YL_DWERK .
ENDSELECT .
IF SY-SUBRC NE 0 .
MESSAGE E158(/A1F/YLMS0100) WITH /A1F/YLNS0011-YL_MATNR_SALE
/A1F/YLNS0011-YL_DWERK.
*     品目コード &1 プラント &2 会計ビューが
*     取得できません（マスターエラー）
ENDIF .
ENDIF .

IF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
*   プラントの設定
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
/A1F/YLNS0011-YL_DWERK = A1F_WG_WERKS_P .
ENDIF .
IF /A1F/YLNS0011-YL_DWERK IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK' .
MESSAGE E207(/A1F/YLMS0100) .
*     プラントが未入力です
ENDIF .

*   購買グループの設定
IF /A1F/YLNS0011-EKGRP IS INITIAL .
/A1F/YLNS0011-EKGRP = A1F_WG_EKGRP .
ENDIF .
IF /A1F/YLNS0011-EKGRP IS INITIAL .
SET CURSOR FIELD '/A1F/YLNS0011-EKGRP' .
MESSAGE E208(/A1F/YLMS0100) .
*     購買グループが未入力です
ENDIF .
ENDIF .

ENDFORM.                    " A1F_GET_INITIAL_DATA2
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_VA01
*&---------------------------------------------------------------------*
*       受注伝票登録呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_VA01.

CALL TRANSACTION 'VA01' .

ENDFORM.                    " A1F_CALL_TRAN_VA01
*&---------------------------------------------------------------------*
*&      Form  A1F_CALL_TRAN_CO06
*&---------------------------------------------------------------------*
*       バックオーダ呼び出し
*----------------------------------------------------------------------*
FORM A1F_CALL_TRAN_CO06.

SET PARAMETER ID 'MAT' FIELD /A1F/YLNS0011-YL_MATNR_SALE.
SET PARAMETER ID 'WRK' FIELD /A1F/YLNS0011-YL_DWERK.
SET PARAMETER ID 'PRR' FIELD SPACE.

CALL TRANSACTION 'CO06' AND SKIP FIRST SCREEN .

ENDFORM.                    " A1F_CALL_TRAN_CO06
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_ACCOUNT_ASSIGN
*&---------------------------------------------------------------------*
*       紐付け伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_ACCOUNT_ASSIGN.

* 受注伝票番号を入力されていた場合
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
*   購買伝票勘定設定から発注伝票番号を取得
SELECT EBELN                              "購買伝票番号
INTO /A1F/YLNS0011-YL_EBELN
FROM EKKN UP TO 1 ROWS                  "購買伝票勘定設定
WHERE VBELN = /A1F/YLNS0011-YL_VBELN     "販売管理伝票番号
AND VBELP = '000010'                   "販売伝票明細
AND VETEN = '0001' .                   "納入日程行
ENDSELECT.
IF SY-SUBRC <> 0 .
*     受注伝票のみの表示
CLEAR /A1F/YLNS0011-YL_EBELN .
ENDIF .
ENDIF .

* 発注伝票番号を入力されていた場合
IF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
*   購買伝票勘定設定から発注伝票番号を取得
SELECT SINGLE
VBELN                              "販売管理伝票番号
INTO /A1F/YLNS0011-YL_VBELN
FROM EKKN                               "購買伝票勘定設定
WHERE EBELN = /A1F/YLNS0011-YL_EBELN     "販売伝票番号
AND EBELP = '00010'                    "販売伝票明細番号
AND ZEKKN = '01'                       "勘定設定の連続番号
AND VBELN <> SPACE .                   "販売管理伝票番号
IF SY-SUBRC <> 0 .
*     発注伝票のみの表示
CLEAR /A1F/YLNS0011-YL_VBELN .
ENDIF .
ENDIF .

ENDFORM.                    " A1F_GET_ACCOUNT_ASSIGN
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_SALES_DATA
*&---------------------------------------------------------------------*
*       受注伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_SALES_DATA.

* 受注伝票情報取得
CLEAR : A1F_WG_KNUMV_S , A1F_GW_KWMENG.
SELECT SINGLE
K~AUDAT                        "伝票日付 (受信日/送信日)
K~AUART                        "販売伝票タイプ
K~LIFSK                        "出荷ブロック (伝票ヘッダ)
K~VKORG                        "販売組織
K~VTWEG                        "流通チャネル
K~SPART                        "製品部門
K~VKGRP                        "営業グループ
K~VKBUR                        "営業所
K~VDATU                        "指定納入期日
K~BSTNK                        "得意先発注番号
K~BSTDK                        "得意先発注日付
K~KUNNR                        "受注先
K~KNUMV                        "伝票条件番号
P~PSTYV                        "取引タイプ
P~KDMAT                        "得意先品目コード
P~ARKTX                        "得意先品目テキスト
P~MATNR                        "品目コード
P~KWMENG                       "受注数量
P~VRKME                        "受注単位
P~KPEIN                        "Per
P~WAERK                        "受注通貨
P~NETWR                        "受注金額
P~NETPR                        "受注単価
P~WERKS                        "プラント
K~KNUMV                        "伝票条件番号
*DMW1823 伝票単価単位変更対応　2010.4.23 T.arai(MIS) - start
P~KMEIN                        "条件単位
*DMW1823 伝票単価単位変更対応　2010.4.23 T.arai(MIS) - e n d
INTO (/A1F/YLNS0011-YL_AUDAT,       /A1F/YLNS0011-YL_AUART,
/A1F/YLNS0011-YL_LIFSK,       /A1F/YLNS0011-VKORG,
/A1F/YLNS0011-VTWEG,          /A1F/YLNS0011-SPART,
/A1F/YLNS0011-VKGRP,          /A1F/YLNS0011-VKBUR,
/A1F/YLNS0011-YL_VDATU,       /A1F/YLNS0011-YL_BSTKD,
/A1F/YLNS0011-YL_TKISKHCDT,   /A1F/YLNS0011-YL_TKISKCD,
A1F_WG_KNUMV_S,
/A1F/YLNS0011-YL_MISIKTGRTYP, /A1F/YLNS0011-YL_KDMAT,
/A1F/YLNS0011-YL_MAKTX_SALE,  /A1F/YLNS0011-YL_MATNR_SALE,
/A1F/YLNS0011-YL_JTYUSU,      /A1F/YLNS0011-YL_VRKME,
/A1F/YLNS0011-YL_KPEIN,       /A1F/YLNS0011-YL_JTYTUK,
/A1F/YLNS0011-YL_JYYUKNGK,    /A1F/YLNS0011-YL_JTYUTNK,
/A1F/YLNS0011-YL_DWERK,       A1F_WG_KNUMV_S,
*DMW1823 伝票単価単位変更対応　2010.4.23 T.arai(MIS) - start
A1F_WG_KMEIN)
*DMW1823 伝票単価単位変更対応　2010.4.23 T.arai(MIS) - e n d
FROM VBAK AS K
INNER JOIN VBAP AS P
ON K~VBELN = P~VBELN
WHERE K~VBELN = /A1F/YLNS0011-YL_VBELN
**** START ADD 2014/09/12 ISID11 ****
AND K~BUKRS_VF = /A1F/YLNS0011-BUKRS
**** END ADD 2014/09/12 ISID11 ****
AND P~POSNR = A1F_CNS_NUMBER_S.

IF SY-SUBRC = 0 .
A1F_WG_WERKS_S = /A1F/YLNS0011-YL_DWERK.
A1F_WG_VKBUR   = /A1F/YLNS0011-VKBUR .
A1F_WG_VKGRP   = /A1F/YLNS0011-VKGRP .

*受注検索時の数量保持
A1F_GW_KWMENG = /A1F/YLNS0011-YL_JTYUSU.

*DMW2762 得意先発注番号対応 2011.1.31 M.hasebe(MIS) - START
SELECT SINGLE BSTKD FROM VBKD INTO /A1F/YLNS0011-YL_BSTKD
WHERE VBELN = /A1F/YLNS0011-YL_VBELN .
*DMW2762 得意先発注番号対応 2011.1.31 M.hasebe(MIS) - E N D

ELSE .
MESSAGE S099(/A1F/YLMS0100) .
*   受注情報が取得できません
EXIT .
ENDIF .

DATA : A1F_WL_JTYUTNK_C(12) TYPE C .
DATA : A1F_WL_KWERT LIKE KONV-KWERT.

* 売上原価を取得
SELECT SINGLE KWERT FROM KONV
INTO A1F_WL_KWERT
WHERE KNUMV = A1F_WG_KNUMV_S
AND KPOSN = A1F_CNS_NUMBER_S
AND KSCHL = A1F_CNS_KSCHL_A.

/A1F/YLNS0011-YL_URAGGNK = A1F_WL_KWERT.
*  CLEAR : A1F_WL_JTYUTNK_C.
*  WRITE /A1F/YLNS0011-YL_URAGGNK TO A1F_WL_JTYUTNK_C
*                                    CURRENCY /A1F/YLNS0011-YL_JTYTUK .
*  /A1F/YLNS0011-YL_URAGGNK = A1F_WL_JTYUTNK_C.

* 指定納期を取得
SELECT SINGLE EDATU FROM VBEP
INTO /A1F/YLNS0011-YL_VDATU
WHERE VBELN = /A1F/YLNS0011-YL_VBELN
AND POSNR = A1F_CNS_NUMBER_S
AND ETENR = '0001'
AND WMENG > 0.

* 受注伝票の取引先(出荷先)を取得
SELECT SINGLE
KUNNR
ADRNR
INTO (/A1F/YLNS0011-YL_SYKSKCD, A1F_WG_ADRNR_SH)
FROM VBPA
WHERE VBELN = /A1F/YLNS0011-YL_VBELN
AND POSNR = '000000'
AND PARVW = A1F_CNS_PARVW_SHIP .

IF SY-SUBRC = 0 .
A1F_SYKSKCD_OLD = /A1F/YLNS0011-YL_SYKSKCD.
ELSE .
CLEAR A1F_SYKSKCD_OLD .
MESSAGE W096(/A1F/YLMS0100) .
*   出荷先の情報が取得できません
ENDIF .

* 基本数量単位の取得
IF NOT ( /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL ) .
PERFORM A1F_GET_MEINS USING    /A1F/YLNS0011-YL_MATNR_SALE
CHANGING /A1F/YLNS0011-YL_MEINS.
ENDIF .

ENDFORM.                    " A1F_GET_SALES_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_PURCHASE_DATA
*&---------------------------------------------------------------------*
*       発注伝票情報取得
*----------------------------------------------------------------------*
FORM A1F_GET_PURCHASE_DATA.

* 発注伝票情報取得
CLEAR : A1F_WG_KNUMV_P , A1F_WG_MENGE , A1F_WG_EINDT , A1F_WG_NETPR.
SELECT SINGLE
K~LIFNR                  "仕入先勘定コード
K~EKORG                  "購買組織
K~EKGRP                  "購買グループ
K~WAERS                  "通貨コード
K~BEDAT                  "購買伝票日付
P~TXZ01                  "テキスト（短）
P~MATNR                  "品目コード
P~WERKS                  "プラント
P~IDNLF                  "仕入先の品目コード
P~MENGE                  "購買発注数量
P~MEINS                  "発注単位
P~NETPR                  "購買伝票における正味価格 (伝票通貨)
P~PEINH                  "価格単位
P~NETWR                  "購買発注通貨による正味発注額
P~EVERS                  "出荷指示
K~KNUMV                  "伝票条件番号
INTO (/A1F/YLNS0011-YL_SIRSKCD,    /A1F/YLNS0011-EKORG,
/A1F/YLNS0011-EKGRP,         /A1F/YLNS0011-YL_HTYUTUK,
/A1F/YLNS0011-YL_BEDAT,      /A1F/YLNS0011-YL_MAKTX_PURC,
/A1F/YLNS0011-YL_MATNR_PURC, /A1F/YLNS0011-YL_DWERK,
/A1F/YLNS0011-YL_IDNLF,      /A1F/YLNS0011-YL_HTYUSU,
/A1F/YLNS0011-YL_BSTME,      /A1F/YLNS0011-YL_HTYUTNK,
/A1F/YLNS0011-YL_PEINH,      /A1F/YLNS0011-YL_HTYUKNGK,
/A1F/YLNS0011-YL_TYKSUKBN,   A1F_WG_KNUMV_P)
FROM EKKO AS K
INNER JOIN EKPO AS P
ON K~EBELN = P~EBELN
WHERE K~EBELN = /A1F/YLNS0011-YL_EBELN
**** START ADD 2014/09/12 ISID11 ****
AND K~BUKRS = /A1F/YLNS0011-BUKRS
**** END ADD 2014/09/12 ISID11 ****
AND P~EBELP = A1F_CNS_NUMBER_P.

IF SY-SUBRC = 0 .
A1F_WG_EKGRP   = /A1F/YLNS0011-EKGRP.
A1F_WG_WERKS_P = /A1F/YLNS0011-YL_DWERK.
A1F_WG_MENGE   = /A1F/YLNS0011-YL_HTYUSU.    "初期値保持用
A1F_WG_NETPR   = /A1F/YLNS0011-YL_HTYUTNK.   "初期値保持用
A1F_WG_TYKSUKBN = /A1F/YLNS0011-YL_TYKSUKBN. "初期値保持用
ELSE.
MESSAGE S100(/A1F/YLMS0100).
*   発注情報が取得できません
EXIT .
ENDIF .

* 納入日程情報の取得
SELECT SINGLE
EINDT
INTO /A1F/YLNS0011-YL_EEIND
FROM EKET
WHERE EBELN = /A1F/YLNS0011-YL_EBELN
AND EBELP = A1F_CNS_NUMBER_P
AND ETENR = A1F_CNS_COUNTER.

IF SY-SUBRC <> 0 .
MESSAGE S095(/A1F/YLMS0100).
*   納入日程行情報が取得できません
EXIT .
ENDIF .

A1F_WG_EINDT = /A1F/YLNS0011-YL_EEIND.        "初期値保持用

* 基本数量単位の取得
IF /A1F/YLNS0011-YL_MEINS IS INITIAL .
PERFORM A1F_GET_MEINS USING    /A1F/YLNS0011-YL_MATNR_PURC
CHANGING /A1F/YLNS0011-YL_MEINS.
ENDIF .

* 在庫情報用に受注側の品目コードに発注の品目コードをセット
IF /A1F/YLNS0011-YL_MATNR_SALE IS INITIAL .
/A1F/YLNS0011-YL_MATNR_SALE = /A1F/YLNS0011-YL_MATNR_PURC .
ENDIF.

ENDFORM.                    " A1F_GET_PURCHASE_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_MEINS
*&---------------------------------------------------------------------*
*       基本数量単位取得処理
*----------------------------------------------------------------------*
*      -->P_/A1F/YLNS0011_YL_MATNR_SALE  品目コード
*      <--P_/A1F/YLNS0011_YL_MEINS       基本数量単位
*----------------------------------------------------------------------*
FORM A1F_GET_MEINS USING    P_MATNR  TYPE MARA-MATNR
CHANGING P_MEINS  TYPE MARA-MEINS.

SELECT SINGLE
MEINS
INTO P_MEINS
FROM MARA
WHERE MATNR = P_MATNR .

IF SY-SUBRC <> 0 .
MESSAGE W152(/A1F/YLMS0100) WITH P_MATNR.
*   品目コード &1 の品目マスタ：基本ビューが取得できません（マスターエラ
ENDIF .

ENDFORM.                    " A1F_GET_MEINS
*&---------------------------------------------------------------------*
*&      Form  A1F_READ_TEXT
*&---------------------------------------------------------------------*
*       テキスト読み込み処理
*----------------------------------------------------------------------*
*      -->P_INLINES  テキストデータ
*      -->P_ID       テキストID
*      -->P_OBJECT   テキストオブジェクト
*      -->P_NAME     テキスト名
*----------------------------------------------------------------------*
FORM A1F_READ_TEXT TABLES   P_INLINES  STRUCTURE TLINE
USING    P_ID       TYPE THEAD-TDID
P_OBJECT   TYPE THEAD-TDOBJECT
P_NAME     TYPE THEAD-TDNAME.

* テキスト読み込み
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = P_ID
LANGUAGE                = SY-LANGU
NAME                    = P_NAME
OBJECT                  = P_OBJECT
TABLES
LINES                   = P_INLINES
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.
IF SY-SUBRC <> 0.
*    MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*            WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " A1F_READ_TEXT
*&---------------------------------------------------------------------*
*&      Form  A1F_CLEAR_SALES_DATA
*&---------------------------------------------------------------------*
*       受注伝票情報初期化
*----------------------------------------------------------------------*
FORM A1F_CLEAR_SALES_DATA.

CLEAR : /A1F/YLNS0011-VKORG,                "販売組織
/A1F/YLNS0011-VTWEG,                "流通チャネル
/A1F/YLNS0011-SPART,                "製品部門
/A1F/YLNS0011-VKBUR,                "営業所
/A1F/YLNS0011-VKGRP,                "営業グループ
/A1F/YLNS0011-YL_DWERK,             "プラント
/A1F/YLNS0011-EKGRP,                "購買グループ
/A1F/YLNS0011-YL_AUART,             "受注タイプ
/A1F/YLNS0011-YL_BSTKD,             "得意先発注番号
/A1F/YLNS0011-YL_KDMAT,             "得意先品目コード
/A1F/YLNS0011-YL_POSTX,             "得意先品目テキスト
/A1F/YLNS0011-YL_AUDAT,             "受注日付
/A1F/YLNS0011-YL_MATNR_SALE,        "品目コード
/A1F/YLNS0011-YL_MAKTX_SALE,        "品目テキスト
/A1F/YLNS0011-YL_JTYUSU,            "受注数量
/A1F/YLNS0011-YL_VDATU,             "指定出荷日付
/A1F/YLNS0011-YL_KUSNTYP,           "更新タイプ
/A1F/YLNS0011-YL_MISIKTGRTYP,       "明細カテゴリタイプ
/A1F/YLNS0011-YL_TKISKCD,           "得意先コード
/A1F/YLNS0011-YL_SYKSKCD,           "出荷先コード
/A1F/YLNS0011-YL_VBELN,             "受注伝票番号
**** START ADD 2014/11/12 ISID11 ****
/A1F/YLNS0011-YL_YSNWAERS,          "与信通貨
**** END ADD 2014/11/12 ISID11 ****
/A1F/YLNS0011-YL_YSNGK,             "与信額
/A1F/YLNS0011-YL_YSNZNDK,           "与信残高
/A1F/YLNS0011-YL_TKISKNM,           "得意先名
/A1F/YLNS0011-YL_LIFSK,             "出荷ブロック
/A1F/YLNS0011-YL_KPEIN,             "Per
/A1F/YLNS0011-YL_VRKME,             "単位
/A1F/YLNS0011-YL_JTYUTNK,           "受注単価
/A1F/YLNS0011-YL_JYYUKNGK,          "受注金額
/A1F/YLNS0011-YL_JTYTUK,            "受注通貨
/A1F/YLNS0011-YL_URAGGNK,           "売上原価
/A1F/YLNS0011-YL_ARARI,             "粗利
/A1F/YLNS0011-YL_SYKSJBKU,          "出荷指示備考
/A1F/YLNS0011-YL_NUHNSYBKU,         "納品書備考
/A1F/YLNS0011-YL_SYNIBKU,           "社内備考
/A1F/YLNS0011-YL_TMTZIK,            "実在庫
/A1F/YLNS0011-YL_JTYUGUKI,          "受注数量
/A1F/YLNS0011-YL_HTYUGUKI,          "発注数量
/A1F/YLNS0011-YL_MHKATZIK,          "未引当在庫
/A1F/YLNS0011-YL_SUZIKSU,           "総在庫数量
/A1F/YLNS0011-YL_SYKSKNM,           "出荷先名
/A1F/YLNS0011-YL_TKISKHCDT.         "得意先発注日付

ENDFORM.                    " A1F_CLEAR_SALES_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_CLEAR_PURCHASE_DATA
*&---------------------------------------------------------------------*
*       発注伝票情報初期化
*----------------------------------------------------------------------*
FORM A1F_CLEAR_PURCHASE_DATA.

CLEAR :
/A1F/YLNS0011-EKORG,                "購買組織
/A1F/YLNS0011-EKGRP,                "購買グループ
/A1F/YLNS0011-YL_TMTZIK,            "実在庫
/A1F/YLNS0011-YL_JTYUGUKI,          "受注数量
/A1F/YLNS0011-YL_HTYUGUKI,          "発注数量
/A1F/YLNS0011-YL_MHKATZIK,          "未引当在庫
/A1F/YLNS0011-YL_SUZIKSU,           "総在庫数量
/A1F/YLNS0011-YL_SIRSKCD,           "仕入先コード
/A1F/YLNS0011-YL_SIRSKNM,           "仕入先名
/A1F/YLNS0011-YL_BEDAT,             "発注日付
/A1F/YLNS0011-YL_EEIND,             "納入日付
/A1F/YLNS0011-YL_EBELN,             "発注伝票番号
/A1F/YLNS0011-YL_MATNR_PURC,        "品目コード
/A1F/YLNS0011-YL_MAKTX_PURC,        "品目テキスト
/A1F/YLNS0011-YL_IDNLF,             "仕入先品目コード
/A1F/YLNS0011-YL_TXZ01,             "仕入先品目名
/A1F/YLNS0011-YL_HTYUSU,            "発注数量
/A1F/YLNS0011-YL_HTYUSU_C,          "発注数量(基本数量単位)
/A1F/YLNS0011-YL_BSTME,             "発注単位
/A1F/YLNS0011-YL_HTYUTNK,           "発注単価
/A1F/YLNS0011-YL_HTYUKNGK,          "発注金額
/A1F/YLNS0011-YL_HTYUKNGK_C,        "発注金額(基本数量単位)
/A1F/YLNS0011-YL_HTYUTUK,           "発注通貨
/A1F/YLNS0011-YL_PEINH,             "Per
/A1F/YLNS0011-YL_EDIBKU,            "EDI備考
/A1F/YLNS0011-YL_EDIBKU2,           "EDI備考(２行目)
/A1F/YLNS0011-YL_EDISNT,            "EDIその他
/A1F/YLNS0011-YL_TUMNSYBKU,         "注文書用備考
/A1F/YLNS0011-YL_SMDNEDIBKU,        "住電EDI備考
/A1F/YLNS0011-YL_HTYUZNITRNBKU ,    "発注残一覧備考
/A1F/YLNS0011-YL_MSYUFLG ,          "無償フラグ
/A1F/YLNS0011-YL_TYKSUKBN.          "直送区分

ENDFORM.                    " A1F_CLEAR_PURCHASE_DATA
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_PRICE_UPDATE
*&---------------------------------------------------------------------*
*       受注単価変更処理
*----------------------------------------------------------------------*
FORM A1F_SALES_PRICE_UPDATE.

* ローカル定義
DATA : A1F_TL_BDCDATA   LIKE TABLE OF BDCDATA  WITH HEADER LINE ,
A1F_TL_SP_RETURN LIKE TABLE OF BAPIRET2 WITH HEADER LINE ,

A1F_WL_JTYUTNK_C(12) TYPE C .


WRITE /A1F/YLNS0011-YL_JTYUTNK TO A1F_WL_JTYUTNK_C
CURRENCY /A1F/YLNS0011-YL_JTYTUK .

PERFORM A1F_GENERATE_BDCDATA
TABLES A1F_TL_BDCDATA
USING:
'SAPMV45A'          '0102'                      'X',
'BDC_OKCODE'        '/00'                       ' ',
'VBAK-VBELN'        /A1F/YLNS0011-YL_VBELN      ' ',

'SAPMV45A'          '4001'                      'X',
'BDC_OKCODE'        '=SICH'                     ' ',
'BDC_SUBSCR'        'SAPMV45A'                  ' ',
'BDC_SUBSCR'        'SAPMV45A'                  ' ',
'BDC_SUBSCR'        'SAPMV45A'                  ' ',
'BDC_SUBSCR'        'SAPMV45A'                  ' ',
'BDC_SUBSCR'        'SAPMV45A'                  ' ',
'BDC_CURSOR'        'KOMV-KBETR(01)'            ' ',
'KOMV-KBETR(01)'    A1F_WL_JTYUTNK_C            ' '.

* 受注伝票変更
PERFORM A1F_CALL_TRANSCTION TABLES A1F_TL_BDCDATA
A1F_TL_SP_RETURN
USING 'VA02'.

ENDFORM.                    " A1F_SALES_PRICE_UPDATE
*&---------------------------------------------------------------------*
*&      Form  A1F_RELOAD
*&---------------------------------------------------------------------*
*       データ再取得処理
*----------------------------------------------------------------------*
FORM A1F_RELOAD.

* 変数初期化
CLEAR : A1F_WG_EKGRP ,
A1F_WG_WERKS_P ,
A1F_WG_WERKS_S ,
A1F_WG_VKBUR ,
A1F_WG_VKGRP .

IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
*   受注伝票情報取得
PERFORM A1F_GET_SALES_DATA .
ENDIF .

IF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
* 　発注伝票情報取得
PERFORM A1F_GET_PURCHASE_DATA .
ENDIF .

* 表示データ取得
PERFORM A1F_GET_INITIAL_DATA .

* 出荷先住所変更対応
IF NOT ( A1F_WG_ADDR1_OUT-NAME1 IS INITIAL ) .
/A1F/YLNS0011-YL_SYKSKNM = A1F_WG_ADDR1_OUT-NAME1 .
ELSE.
IF NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .
SELECT SINGLE NAME1 FROM  KNA1
INTO /A1F/YLNS0011-YL_SYKSKNM
WHERE  KUNNR  = /A1F/YLNS0011-YL_SYKSKCD.
ENDIF .
ENDIF .

ENDFORM.                    " A1F_RELOAD
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_DATA_LOCK
*&---------------------------------------------------------------------*
*       受注伝票ロック処理
*----------------------------------------------------------------------*
*      -->P_VBELN  受注伝票番号
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_LOCK USING    P_VBELN  TYPE VBAK-VBELN.

CALL FUNCTION 'ENQUEUE_EVVBAKE'
EXPORTING
VBELN = P_VBELN.
IF SY-SUBRC <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " A1F_SALES_DATA_LOCK
*&---------------------------------------------------------------------*
*&      Form  A1F_PURCHASE_DATA_LOCK
*&---------------------------------------------------------------------*
*       発注伝票ロック処理
*----------------------------------------------------------------------*
*      -->P_EBELN  発注伝票番号
*----------------------------------------------------------------------*
FORM A1F_PURCHASE_DATA_LOCK USING    P_EBELN  TYPE EKKO-EBELN.

CALL FUNCTION 'ENQUEUE_EMEKKOE'
EXPORTING
EBELN = P_EBELN
EBELP = A1F_CNS_NUMBER_P.

IF NOT /A1F/YLNS0011-YL_VBELN IS INITIAL.
CALL FUNCTION 'ENQUEUE_EVVBAKE'
EXPORTING
VBELN = /A1F/YLNS0011-YL_VBELN.
ENDIF.


ENDFORM.                    " A1F_PURCHASE_DATA_LOCK
*&---------------------------------------------------------------------*
*&      Form  A1F_SALES_DATA_UNLOCK
*&---------------------------------------------------------------------*
*       受注伝票ロック解除処理
*----------------------------------------------------------------------*
*      -->P_VBELN  受注伝票番号
*----------------------------------------------------------------------*
FORM A1F_SALES_DATA_UNLOCK USING    P_VBELN  TYPE VBAK-VBELN.

CALL FUNCTION 'DEQUEUE_EVVBAKE'
EXPORTING
VBELN = P_VBELN.

ENDFORM.                    " A1F_SALES_DATA_UNLOCK
*&---------------------------------------------------------------------*
*&      Form  A1F_PURCHASE_DATA_UNLOCK
*&---------------------------------------------------------------------*
*       発注伝票ロック解除処理
*----------------------------------------------------------------------*
*      -->P_EBELN  発注伝票番号
*----------------------------------------------------------------------*
FORM A1F_PURCHASE_DATA_UNLOCK USING    P_EBELN  TYPE EKKO-EBELN.

CALL FUNCTION 'DEQUEUE_EMEKKOE'
EXPORTING
EBELN = P_EBELN
EBELP = A1F_CNS_NUMBER_P.


IF NOT /A1F/YLNS0011-YL_VBELN IS INITIAL.
CALL FUNCTION 'DEQUEUE_EVVBAKE'
EXPORTING
VBELN = /A1F/YLNS0011-YL_VBELN.
ENDIF.


ENDFORM.                    " A1F_PURCHASE_DATA_UNLOCK
*&---------------------------------------------------------------------*
*&      Form  A1F_VIEW
*&---------------------------------------------------------------------*
*       照会 <-> 変更 切り替え処理
*----------------------------------------------------------------------*
FORM A1F_VIEW.

* ロック解除
PERFORM  A1F_SALES_DATA_UNLOCK     USING /A1F/YLNS0011-YL_VBELN .
PERFORM  A1F_PURCHASE_DATA_UNLOCK  USING /A1F/YLNS0011-YL_EBELN .

* 引き渡しパラメータ判定
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
SET PARAMETER ID 'ZVBN' FIELD /A1F/YLNS0011-YL_VBELN.
SET PARAMETER ID 'ZEBN' FIELD A1F_EBELN_INI.
ELSEIF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
SET PARAMETER ID 'ZEBN' FIELD /A1F/YLNS0011-YL_EBELN.
SET PARAMETER ID 'ZVBN' FIELD A1F_VBELN_INI.
ELSE .
EXIT .
ENDIF .

LEAVE TO TRANSACTION 'ZLP3_LINK' .

ENDFORM.                                                    " A1F_VIEW
*&---------------------------------------------------------------------*
*&      Form  A1F_GET_DATA_9000
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
FORM A1F_GET_DATA_9000.

* 伝票番号の入力状況確認
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) AND
NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ) .
MESSAGE E098(/A1F/YLMS0100) .
*   伝票番号は受注または発注のどちらか一つを入力してください
ENDIF .

IF SY-UCOMM = 'B006' OR
SY-UCOMM = 'B007' .
EXIT .
ENDIF .

* 紐付け伝票情報取得
PERFORM A1F_GET_ACCOUNT_ASSIGN .

* 変数初期化
CLEAR : A1F_WG_EKGRP ,
A1F_WG_WERKS_P ,
A1F_WG_WERKS_S ,
A1F_WG_VKBUR ,
A1F_WG_VKGRP .

* 受注伝票番号入力確認
IF /A1F/YLNS0011-YL_VBELN IS INITIAL .
*   受注伝票情報初期化
PERFORM A1F_CLEAR_SALES_DATA .
ELSE .
*   受注伝票情報取得
PERFORM A1F_GET_SALES_DATA .
ENDIF .

* 発注伝票番号入力確認
IF /A1F/YLNS0011-YL_EBELN IS INITIAL .
*   発注伝票情報初期化
PERFORM A1F_CLEAR_PURCHASE_DATA .
ELSE .
* 　発注伝票情報取得
PERFORM A1F_GET_PURCHASE_DATA .
ENDIF .

* 伝票番号がどちらも未入力の場合、基本数量単位を初期化
IF /A1F/YLNS0011-YL_VBELN IS INITIAL AND
/A1F/YLNS0011-YL_EBELN IS INITIAL .
CLEAR /A1F/YLNS0011-YL_MEINS .             "基本数量単位
ENDIF .

* 表示データ取得
PERFORM A1F_GET_INITIAL_DATA .

* 販売金額の計算
PERFORM A1F_CALCULATION_SALES_AMOUNT .

* 在庫情報の取得
PERFORM A1F_GET_STOCK_INFO .

* 出荷先住所変更対応
IF NOT ( A1F_WG_ADDR1_OUT-NAME1 IS INITIAL ) .
/A1F/YLNS0011-YL_SYKSKNM = A1F_WG_ADDR1_OUT-NAME1 .
ELSE.
IF NOT ( /A1F/YLNS0011-YL_SYKSKCD IS INITIAL ) .
SELECT SINGLE NAME1 FROM  KNA1
INTO /A1F/YLNS0011-YL_SYKSKNM
WHERE  KUNNR  = /A1F/YLNS0011-YL_SYKSKCD.
ENDIF .
* 出荷先住所変更対応
ENDIF .

* データロック
IF NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .
PERFORM A1F_SALES_DATA_LOCK  USING /A1F/YLNS0011-YL_VBELN .
ELSEIF NOT ( /A1F/YLNS0011-YL_EBELN IS INITIAL ).
PERFORM A1F_PURCHASE_DATA_LOCK  USING /A1F/YLNS0011-YL_EBELN .
ENDIF.

ENDFORM.                    " A1F_GET_DATA_9000
*&---------------------------------------------------------------------*
*&      Form  A1F_SET_PARAMETER_ID
*&---------------------------------------------------------------------*
*       パラメータID設定処理
*----------------------------------------------------------------------*
FORM A1F_SET_PARAMETER_ID.

SET PARAMETER ID 'ZVBN' FIELD /A1F/YLNS0011-YL_VBELN.
SET PARAMETER ID 'ZEBN' FIELD /A1F/YLNS0011-YL_EBELN.

ENDFORM.                    " A1F_SET_PARAMETER_ID
*&---------------------------------------------------------------------*
*&      Form  A1F_CLEAR_PARAMETER_ID
*&---------------------------------------------------------------------*
*       パラメータID初期化処理
*----------------------------------------------------------------------*
FORM A1F_CLEAR_PARAMETER_ID.

* パラメータIDクリア
SET PARAMETER ID 'ZEBN' FIELD A1F_EBELN_INI.
SET PARAMETER ID 'ZVBN' FIELD A1F_VBELN_INI.

ENDFORM.                    " A1F_CLEAR_PARAMETER_ID
*&---------------------------------------------------------------------*
*&      Form  A1F_DEFAULT_SCREEN
*&---------------------------------------------------------------------*
*       初期画面項目設定
*----------------------------------------------------------------------*
FORM A1F_DEFAULT_SCREEN.

LOOP AT SCREEN .
IF SCREEN-GROUP1 = '001' OR
SCREEN-GROUP1 = '002' .
SCREEN-INPUT  = 0 .
MODIFY SCREEN .
ENDIF .
IF SCREEN-GROUP3 = '001' .
SCREEN-INPUT  = 0 .
MODIFY SCREEN .
ENDIF .
IF SCREEN-NAME = '/A1F/YLNS0011-YL_DWERK' .
SCREEN-INPUT  = 0 .
MODIFY SCREEN .
ENDIF .
IF A1F_FLG_SAVE_OK IS INITIAL .
IF SCREEN-NAME = 'A1F_B006'      "受注変更ボタン
OR SCREEN-NAME = 'A1F_B007' .  "発注変更ボタン
SCREEN-INPUT  = 0 .
SCREEN-INVISIBLE = 1 .
MODIFY SCREEN .
ENDIF .
ENDIF .
IF SCREEN-GROUP1 = '999' .
SCREEN-INVISIBLE = 1 .
MODIFY SCREEN .
ENDIF.
ENDLOOP .

ENDFORM.                    " A1F_DEFAULT_SCREEN
*&---------------------------------------------------------------------*
*&      Form  a1f_mod_scr_JTYUTNK
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM A1F_MOD_SCR_JTYUTNK.

CHECK NOT ( /A1F/YLNS0011-YL_VBELN IS INITIAL ) .

DATA   A1F_WL_SUBRC LIKE SY-SUBRC .
PERFORM A1F_CHECK_VBFA CHANGING A1F_WL_SUBRC .

LOOP AT SCREEN .
IF SCREEN-NAME = '/A1F/YLNS0011-YL_JTYUTNK' .
IF A1F_WL_SUBRC IS INITIAL.
SCREEN-INPUT  = 1 .
MODIFY SCREEN .
ELSE .
SCREEN-INPUT  = 0 .
MODIFY SCREEN .
ENDIF .
ENDIF .
ENDLOOP .


ENDFORM.                    " a1f_mod_scr_JTYUTNK
*&---------------------------------------------------------------------*
*&      Form  a1f_check_vbfa
*&---------------------------------------------------------------------*
*       text
*----------------------------------------------------------------------*
*      <--P_A1F_WL_SUBRC  text
*----------------------------------------------------------------------*
FORM A1F_CHECK_VBFA CHANGING P_A1F_WL_SUBRC LIKE SY-SUBRC.

DATA   A1F_TL_VBFA LIKE TABLE OF VBFA .
DATA   A1F_WL_VBFA LIKE VBFA .
DATA   A1F_WL_RFMNG LIKE VBFA-RFMNG .

CLEAR A1F_WL_RFMNG .

SELECT        * FROM  VBFA
INTO TABLE A1F_TL_VBFA
WHERE  VBELV    = /A1F/YLNS0011-YL_VBELN
AND    POSNV    = A1F_CNS_NUMBER_S
AND  ( VBTYP_N  = 'N'
OR VBTYP_N  = 'M' ).

LOOP AT A1F_TL_VBFA INTO A1F_WL_VBFA .
IF A1F_WL_VBFA-VBTYP_N = 'M' .
A1F_WL_RFMNG = A1F_WL_RFMNG + A1F_WL_VBFA-RFMNG .
ELSE .
A1F_WL_RFMNG = A1F_WL_RFMNG - A1F_WL_VBFA-RFMNG .
ENDIF .
ENDLOOP .

P_A1F_WL_SUBRC = A1F_WL_RFMNG .

ENDFORM.                    " a1f_check_vbfa
**** START ADD 2014/09/12 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  A1F_CHK_BUKRS_INPUT
*&---------------------------------------------------------------------*
*       画面更新、会社コード変更の場合、チェックを処理する
*----------------------------------------------------------------------*
*  -->  P_BUKRS        会社コード
*----------------------------------------------------------------------*
FORM A1F_CHK_BUKRS_INPUT USING P_BUKRS TYPE /A1F/YLNS0011-BUKRS.
DATA:
A1F_WL_VKORG TYPE TVKO-VKORG,
A1F_WL_EKORG TYPE T024E-EKORG.

* 選択画面の会社コードの存在チェックを行う
* PBO初めで処理同じ
SELECT SINGLE * FROM  T001
INTO A1F_WG_T001
WHERE  BUKRS  = /A1F/YLNS0011-BUKRS.
IF SY-SUBRC <> 0 .
SET CURSOR FIELD '/A1F/YLNS0011-BUKRS'.
MESSAGE E200(/A1F/YLMS0100) WITH /A1F/YLNS0011-BUKRS .
*   システムエラー：会社コードデータ（&1）が取得できませんでした。
ENDIF .
* 国内通貨を格納
/A1F/YLNS0011-YL_WAERS = A1F_WG_T001-WAERS .

* 選択画面の会社コードの権限チェックを行う
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD /A1F/YLNS0011-BUKRS          "対象会社コード
ID 'ACTVT' FIELD '03'.
IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YLNS0011-BUKRS'.
MESSAGE E015(Z3) WITH /A1F/YLNS0011-BUKRS.
*   会社コード & では実行する権限がありません。
ENDIF.

* 会社コードと販売組織の関連チェック
IF /A1F/YLNS0011-VKORG IS NOT INITIAL.
SELECT SINGLE VKORG
INTO A1F_WL_VKORG
FROM TVKO
WHERE BUKRS = /A1F/YLNS0011-BUKRS
AND VKORG = /A1F/YLNS0011-VKORG.
IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YLNS0011-VKORG'.
MESSAGE E077(Z3) WITH /A1F/YLNS0011-BUKRS /A1F/YLNS0011-VKORG.
*     会社コード&と販売組織&の組合せチェックが失敗しました。
ENDIF.
ENDIF.
* 会社コードと購買組織の関連チェック
IF /A1F/YLNS0011-EKORG IS NOT INITIAL.
SELECT SINGLE EKORG
INTO A1F_WL_EKORG
FROM T024E
WHERE BUKRS = /A1F/YLNS0011-BUKRS
AND EKORG = /A1F/YLNS0011-EKORG.
IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YLNS0011-EKORG'.
MESSAGE E078(Z3) WITH /A1F/YLNS0011-BUKRS /A1F/YLNS0011-EKORG.
*     会社コード&と購買組織&の組合せチェックが失敗しました。
ENDIF.
ENDIF.
ENDFORM.                    " A1F_CHK_BUKRS_INPUT
*&---------------------------------------------------------------------*
*&      Form  A1F_CHK_INITIAL_WERKS
*&---------------------------------------------------------------------*
*       会社コードとプラントの関連チェック
*----------------------------------------------------------------------*
FORM A1F_CHK_INITIAL_WERKS .
DATA A1F_WL_WERKS   TYPE WERKS.     "一時プラント
A1F_WL_WERKS = /A1F/YLNS0011-YL_DWERK.
* 会社コードとプラントの関連チェック（会社コートとプラントの両方が入力した場合）
CALL FUNCTION 'ZEG_ZZ_WERKS_CHK'
EXPORTING
IMPBUKRS                 = /A1F/YLNS0011-BUKRS
IMPWERKS                 = A1F_WL_WERKS
*     IMPRNGWERKS              =
*   IMPORTING
*     EXPWERKS                 =
*     EXPTABRET                =
EXCEPTIONS
WERKS_NOT_EXIST          = 1
WERKS_NO_AUTHORITY       = 2
WERKS_BUKRS_ERROR        = 3
OTHERS                   = 4
.
IF SY-SUBRC <> 0.
SET CURSOR FIELD '/A1F/YLNS0011-YL_DWERK' .
MESSAGE ID SY-MSGID TYPE 'E'  NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
ENDFORM.                   " A1F_CHK_INITIAL_WERKS
*&---------------------------------------------------------------------*
*&      Form  A1F_LANGU_ISO_CHG
*&---------------------------------------------------------------------*
*       変換: 1 桁の SAP 言語キー -> 2 桁の ISO 言語キー
*----------------------------------------------------------------------*
*      <--P_A1F_WL_ISO_LANGUE  2 桁の ISO 言語キー
*----------------------------------------------------------------------*
FORM A1F_LANGU_ISO_CHG  CHANGING P_A1F_WL_ISO_LANGUE TYPE T002-LAISO.
CLEAR P_A1F_WL_ISO_LANGUE.
CALL FUNCTION 'CONVERSION_EXIT_ISOLA_OUTPUT'
EXPORTING
INPUT  = SY-LANGU
IMPORTING
OUTPUT = P_A1F_WL_ISO_LANGUE.
ENDFORM.                    " A1F_LANGU_ISO_CHG
**** END ADD 2014/09/12 ISID11 ****
