************************************************************************
* [プログラム名]
*   ZS010810    受注残リスト作成
*               ※ZS010805に基づいて新規受注残データ更新を作成
*
* [処理概要]
*   発注情報の把握のため、選択画面で指定された下記の帳票を出力する。
*     ①受注残一覧表
*       営業所/営業グループ(営業員)/得意先レベルの帳票を出力
*       →得意先合計･営業グループ合計(営業員)/営業所合計を出力
*     ②全社
*       営業所レベルの帳票出力
*     ③営業所
*       営業所/営業グループレベルの帳票出力
*
* [改定履歴]
* 2012/05/09 SOLFIS趙    項目追加
*                        ・原価(移動平均原価)
*                        ・原価(発注伝票)
*                        ・発注通貨
* 2014/09/25 ISID11      グローバル化の対応
* 2014/11/13 ISID11      レポートの通貨コード表示対応
************************************************************************

REPORT  ZS010810_BK20150327.

************************************************************************
* TABLES
************************************************************************
TABLES:
TVKBT,
TVGRT,
PA0002,
ZS0040.

************************************************************************
* TYPES
************************************************************************
TYPE-POOLS SLIS.

* 営業所内部ＴＢＬ型
TYPES: BEGIN OF TYP_EIGYOUSHO,
VKBUR TYPE TVKBT-VKBUR,                          "営業所コード
BEZEI TYPE TVKBT-BEZEI,                              "テキスト
END OF TYP_EIGYOUSHO.

* 営業グループ内部ＴＢＬ型
TYPES: BEGIN OF TYP_EIGYOUGRP,
VKGRP TYPE TVGRT-VKGRP,                          "営業グループ
BEZEI TYPE TVGRT-BEZEI,                              "テキスト
END OF TYP_EIGYOUGRP.

* 個人情報内部ＴＢＬ型
TYPES: BEGIN OF TYP_KOJIN_INFO,
PERNR TYPE PA0002-PERNR,                           "従業員番号
NACHN TYPE PA0002-NACHN,                                   "姓
END OF TYP_KOJIN_INFO.

* 分析(受注残)内部ＴＢＬ型
TYPES: BEGIN OF TYP_BUNSEKI_A,
VBELN     TYPE ZS0040-VBELN,                     "販売伝票番号
POSNR     TYPE ZS0040-POSNR,                     "販売伝票明細
BSTNK     TYPE ZS0040-BSTNK,                   "得意先発注番号
NOUKI     TYPE ZS0040-NOUKI,                     "分納日程日付
AUDAT     TYPE ZS0040-AUDAT,                         "伝票日付
AUART     TYPE ZS0040-AUART,                       "伝票タイプ
PSTYV     TYPE ZS0040-PSTYV,                     "明細カテゴリ
KUNNR     TYPE ZS0040-KUNNR,                     "得意先コード
VKBUR     TYPE ZS0040-VKBUR,                           "営業所
VKGRP     TYPE ZS0040-VKGRP,                     "営業グループ
MATNR     TYPE ZS0040-MATNR,                       "品目コード
MAKTX     TYPE ZS0040-MAKTX,                     "品目テキスト
JUCHU     TYPE ZS0040-JUCHU,                         "受注数量
PICKUP    TYPE ZS0040-PICKUP,                      "引当済数量
SHUKKA    TYPE ZS0040-SHUKKA,                      "出荷済数量
VRKME     TYPE ZS0040-VRKME,                         "販売単位
JUCHUKG   TYPE ZS0040-JUCHUKG,                       "受注金額
SHUKKAKG  TYPE ZS0040-SHUKKAKG,                    "出荷済金額
SHUKKOKG  TYPE ZS0040-SHUKKOKG,                    "出庫済金額
SEIKYUKG  TYPE ZS0040-SEIKYUKG,                    "売上済金額
WAERK     TYPE ZS0040-WAERK,                       "通貨コード
JTANKA    TYPE ZS0040-JTANKA,                        "受注単価
TANITANKA TYPE ZS0040-TANITANKA,                     "単位単価
YUSOUTOU  TYPE ZS0040-YUSOUTOU,                    "輸送手段等
END OF TYP_BUNSEKI_A.

* 分析(全社･営業所)ＴＢＬ型
TYPES: BEGIN OF TYP_BUNSEKI_B,
VBELN    TYPE ZS0040-VBELN,                      "販売伝票番号
POSNR    TYPE ZS0040-POSNR,                      "販売明細番号
AUART    TYPE ZS0040-AUART,                        "伝票タイプ
VKBUR    TYPE ZS0040-VKBUR,                            "営業所
VKGRP    TYPE ZS0040-VKGRP,                      "営業グループ
JUCHUKG  TYPE ZS0040-JUCHUKG,                        "受注金額
SEIKYUKG TYPE ZS0040-SEIKYUKG,                     "売上済金額
WAERK    TYPE ZS0040-WAERK,                       "通貨コード
END OF TYP_BUNSEKI_B.

* 帳票出力用情報取得ＴＢＬ-Ａ型
TYPES: BEGIN OF TYP_VBPA_KD,
PERNR   TYPE VBPA-PERNR,                            "従業員No.
ADRNR   TYPE VBPA-ADRNR,                                 "住所
BSTDK_E TYPE VBKD-BSTDK_E,             "出荷先の得意先発注日付
KURSK   TYPE VBKD-KURSK,            "換算レート－価格設定/統計
END OF TYP_VBPA_KD.

* 帳票出力用情報取得ＴＢＬ-Ｂ型
TYPES: BEGIN OF TYP_VBAP,
KDMAT  TYPE VBAP-KDMAT,                      "得意先品目コード
WAVWR  TYPE VBAP-WAVWR,                                  "原価
* 2012/05/09 ADD START
WERKS  TYPE VBAP-WERKS,                               "プラント
* 2012/05/09 ADD END
END OF TYP_VBAP.

* 帳票出力用情報取得ＴＢＬ-Ｃ型
TYPES: BEGIN OF TYP_VBEP_EKPO,
EBELN TYPE EKPO-EBELN,                           "購買発注伝票
EBELP TYPE EKPO-EBELP,                           "購買発注明細
MENGE TYPE EKPO-MENGE,                               "発注数量
LIFNR TYPE EKKO-LIFNR,                           "仕入先コード
EVERS TYPE EKPO-EVERS,                               "出荷指示
* 2012/05/09 ADD START
WAERS TYPE EKKO-WAERS,                             "通貨コード
NETPR TYPE EKPO-NETPR,                               "正味価格
PEINH TYPE EKPO-PEINH,                               "価格単位
* 2012/05/09 ADD END
END OF TYP_VBEP_EKPO.

* 帳票出力用情報取得ＴＢＬ-Ｄ型
TYPES: BEGIN OF TYP_VBPA,
PERNR   TYPE VBPA-PERNR,                            "従業員No.
END OF TYP_VBPA.

TYPES: BEGIN OF T_ZS0030,
ZKEY     TYPE ZS0030-ZKEY,                               "キー
REPCD    TYPE ZS0030-REPCD,                    "レポートコード
END OF T_ZS0030.

************************************************************************
* DATA
************************************************************************
*--- 内部テーブル
* 営業所内部ＴＢＬ
DATA: GF_EIGYOUSHO TYPE TYP_EIGYOUSHO,
GT_EIGYOUSHO LIKE TABLE OF GF_EIGYOUSHO.

* 営業グループ内部ＴＢＬ
DATA: GF_EIGYOUGRP TYPE TYP_EIGYOUGRP,
GT_EIGYOUGRP LIKE TABLE OF GF_EIGYOUGRP.

* 個人情報内部ＴＢＬ
DATA: GF_KOJIN_INFO TYPE TYP_KOJIN_INFO,
GT_KOJIN_INFO LIKE TABLE OF GF_KOJIN_INFO.

* 分析(受注残)内部ＴＢＬ
DATA: GF_BUNSEKI_A TYPE TYP_BUNSEKI_A,
GT_BUNSEKI_A LIKE TABLE OF GF_BUNSEKI_A.

* 分析(全社･営業所)内部ＴＢＬ
DATA: GF_BUNSEKI_B TYPE TYP_BUNSEKI_B,
GT_BUNSEKI_B LIKE TABLE OF GF_BUNSEKI_B.

* 帳票出力用(詳細)内部ＴＢＬ
DATA: GF_WRITE_A   TYPE ZSLIST_V08_07,
GT_WRITE_A   LIKE TABLE OF GF_WRITE_A.

* 帳票出力用(全社･営業所)内部ＴＢＬ
DATA: GF_WRITE_B   TYPE ZSLIST_V08_06,
GT_WRITE_B   LIKE TABLE OF GF_WRITE_B.

DATA: GT_ZS0030     TYPE HASHED TABLE OF T_ZS0030
WITH UNIQUE KEY ZKEY,
GF_ZS0030     TYPE T_ZS0030.

*--- 構造
DATA : GF_VBPA_KD   TYPE TYP_VBPA_KD,
GF_VBAP      TYPE TYP_VBAP,
GF_VBEP_EKPO TYPE TYP_VBEP_EKPO,
GF_VBPA      TYPE TYP_VBPA.

*--- DATA
DATA: YEARS   TYPE D,                               "納入期日変換処理用
YEARS_1 TYPE D,                               "納入期日変処理換用
YEARS_2 TYPE D,                               "納入期日変換処理用
YEARS_3 TYPE D.                               "納入期日変換処理用

DATA: LM_ZANKIN TYPE P DECIMALS 4,                "受注残金額(前月以前)
TM_ZANKIN TYPE P DECIMALS 4,                    "受注残金額(当月)
N1M_ZANKIN TYPE P DECIMALS 4,                   "受注残金額(翌月)
N2M_ZANKIN TYPE P DECIMALS 4,                 "受注残金額(翌々月)
N3M_ZANKIN TYPE P DECIMALS 4,               "受注残金額(翌々翌月)
N4M_ZANKIN TYPE P DECIMALS 4.           "受注残金額(翌々翌月以降)
**** START ADD 2014/09/25 ISID11 ****
DATA: GF_RNG_VKBUR  TYPE RANGE OF TVKBT-VKBUR,       "対象営業所
GF_WAERS      TYPE T001-WAERS.
**** END ADD 2014/09/25 ISID11 ****
*--- リストビューア関連
DATA: GF_REPID      LIKE SY-REPID,                        "レポートＩＤ
GF_LAYOUT     TYPE SLIS_LAYOUT_ALV,               "レイアウト構造
GF_VARIANT    TYPE DISVARIANT.              "バリアント保存設定用

* REUSE_ALV_FIELDCATALOG_MERGE
DATA: GT_FIELDCAT_ALV TYPE SLIS_T_FIELDCAT_ALV.

* REUSE_ALV_COMMENTARY_WRITE
DATA: GF_HEAD_ALV   TYPE SLIS_LISTHEADER,                   "ヘッダ構造
GT_HEAD_ALV   TYPE SLIS_T_LISTHEADER.            "ヘッダ用内部TBL

* ABAPリストビューアヘッダデータ保持
DATA: GF_HEADER_A   LIKE GF_WRITE_A,                    "ヘッダ表示情報
GF_HEADER_B   LIKE GF_WRITE_B.

* REUSE_ALV_LIST_DISPLAY
DATA: TOP_OF_PAGE   TYPE SLIS_FORMNAME VALUE 'TOP_OF_PAGE'.

* REUSE_ALV_EVENT
DATA: GF_EVENT      TYPE SLIS_ALV_EVENT,               "イベント情報構造
GT_EVENT      TYPE SLIS_T_EVENT.              "イベント情報内部TBL

* ALV出力用内部ＴＢＬ
DATA: GT_ALV_A      TYPE TABLE OF ZSLIST_V08_07
WITH HEADER LINE.
DATA: GT_ALV_B      TYPE TABLE OF ZSLIST_V08_06
WITH HEADER LINE.

*ALVステータス印刷拒否設定----*
DATA: GF_PRINT      TYPE SLIS_PRINT_ALV.

************************************************************************
* CONSTANTS
************************************************************************
CONSTANTS:
CNS_X                  TYPE C VALUE 'X',
**** START DEL 2014/09/25 ISID11 ****
*  CNS_JA(2)              TYPE C VALUE 'JA',
**** END DEL 2014/09/25 ISID11 ****
CNS_TVKBT(5)           TYPE C VALUE 'TVKBT',
CNS_TVGRT(5)           TYPE C VALUE 'TVGRT',
CNS_PA0002(6)          TYPE C VALUE 'PA0002',
CNS_ZS0040(6)          TYPE C VALUE 'ZS0040',
CNS_VBPA_VBKD(9)       TYPE C VALUE 'VBPA VBKD',
CNS_VBAP(4)            TYPE C VALUE 'VBAP',
CNS_VBEP_EKPO_EKKO(14) TYPE C VALUE 'VBEP EKPO EKKO',
CNS_EKET(4)            TYPE C VALUE 'EKET',
CNS_LFA1(4)            TYPE C VALUE 'LFA1',
CNS_ZS0030(6)          TYPE C VALUE 'ZS0030',
* 2012/05/09 ADD START
CNS_MBEW(4)            TYPE C VALUE 'MBEW',
* 2012/05/09 ADD END
CNS_READTXT(9)         TYPE C VALUE 'READ_TEXT',
CNS_AG(2)              TYPE C VALUE 'AG',
CNS_VE(2)              TYPE C VALUE 'VE',
CNS_ZSEO(4)            TYPE C VALUE 'ZSEO',
CNS_ZSEK(4)            TYPE C VALUE 'ZSEK',
CNS_RE(2)              TYPE C VALUE 'RE',
CNS_KR(2)              TYPE C VALUE 'KR',
CNS_ZRE(3)             TYPE C VALUE 'ZRE'.


************************************************************************
* 選択画面
************************************************************************
**** START ADD 2014/09/25 ISID11 ****
PARAMETERS P_BUKRS TYPE T001-BUKRS OBLIGATORY.
SELECTION-SCREEN SKIP 1.
**** END ADD 2014/09/25 ISID11 ****
* 受注残一覧
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS R_BALANC RADIOBUTTON GROUP RD_1 DEFAULT 'X'.
SELECTION-SCREEN COMMENT 2(10) TEXT-001  FOR FIELD R_BALANC.
SELECTION-SCREEN END OF LINE.
* 受注残一覧の検索条件
SELECTION-SCREEN BEGIN OF BLOCK B01 WITH FRAME TITLE TEXT-004.
* 営業所
PARAMETERS P_VKBUR TYPE TVKBT-VKBUR.
* 営業グループ
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS R_EIGYOG RADIOBUTTON GROUP RD_2 DEFAULT 'X'.
SELECTION-SCREEN COMMENT 4(12) TEXT-005 FOR FIELD S_VKGRP.
SELECTION-SCREEN POSITION 30.
SELECT-OPTIONS S_VKGRP FOR TVGRT-VKGRP.
SELECTION-SCREEN END OF LINE.
* 営業員コード
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS R_EIGYOI RADIOBUTTON GROUP RD_2.
SELECTION-SCREEN COMMENT 4(12) TEXT-006 FOR FIELD S_PERNR.
SELECTION-SCREEN POSITION 30.
SELECT-OPTIONS S_PERNR FOR PA0002-PERNR.
SELECTION-SCREEN END OF LINE.
* 得意先コード
SELECT-OPTIONS S_KUNNR FOR ZS0040-KUNNR.
* 希望納期
SELECT-OPTIONS S_DATUM FOR SY-DATUM.
SELECTION-SCREEN END OF BLOCK B01.

SELECTION-SCREEN SKIP.

* 全社(受注残金一覧表)
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS R_ZENSHA  RADIOBUTTON GROUP RD_1.
SELECTION-SCREEN COMMENT 2(20) TEXT-002 FOR FIELD R_ZENSHA.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN SKIP.

* 営業所(受注残金一覧表)
SELECTION-SCREEN BEGIN OF LINE.
PARAMETERS R_EIGYOS RADIOBUTTON GROUP RD_1.
SELECTION-SCREEN COMMENT 2(22) TEXT-003 FOR FIELD R_EIGYOS.
SELECTION-SCREEN END OF LINE.
* 営業所(受注残金一覧表)の検索条件
SELECTION-SCREEN BEGIN OF BLOCK B02 WITH FRAME TITLE TEXT-004.
SELECT-OPTIONS S_VKBUR FOR TVKBT-VKBUR.    "営業所
SELECTION-SCREEN END OF BLOCK B02.

**** START ADD 2014/09/25 ISID11 ****
************************************************************************
* INITIALIZATION                                                       *
************************************************************************
INITIALIZATION.
GET PARAMETER ID 'BUK' FIELD P_BUKRS.
**** END ADD 2014/09/25 ISID11 ****

************************************************************************
* AT SELECTION-SCREEN                                                  *
************************************************************************
* 2-1 入力チェック処理
AT SELECTION-SCREEN.

CASE CNS_X.
WHEN R_BALANC.
PERFORM FRM_CHECK_ZANDAKA.
WHEN R_EIGYOS.
PERFORM FRM_CHECK_EIGYOUSHO.
ENDCASE.
**** START ADD 2014/09/25 ISID11 ****
* 入力チェック：会社コード
PERFORM FRM_CHECK_BUKRS USING P_BUKRS
P_VKBUR
S_VKBUR[].
**** END ADD 2014/09/25 ISID11 ****

************************************************************************
* START-OF-SELECTION
************************************************************************
START-OF-SELECTION.

*対象データ抽出処理
CASE CNS_X.
* 受注残一覧表を選択
WHEN R_BALANC.
PERFORM FRM_SEL_JUCHUZANICHIRAN.                    "対象データ抽出
PERFORM FRM_MAKE_ZANDAKA.                    "帳票(詳細)内部TBL作成
PERFORM FRM_WRITE_ICHIRAN_A.                    "帳票(詳細)出力処理
* 全社・営業所(受注残金額一覧表)を選択
WHEN OTHERS.
PERFORM FRM_SEL_KINGAKUICHIRAN.                     "対象データ抽出
PERFORM FRM_MAKE_KINGAKUICHIRAN.     "帳票(会社・営業所)内部TBL作成
PERFORM FRM_WRITE_ICHIRAN_B.            "帳票(会社・営業所)出力処理
ENDCASE.
*&---------------------------------------------------------------------*
*&      Form  frm_check_zandaka
*&---------------------------------------------------------------------*
*       ラジオボタン：受注残一覧選択時
*----------------------------------------------------------------------*
FORM FRM_CHECK_ZANDAKA.

* 営業所コード入力チェック
IF P_VKBUR IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-M01.
ENDIF.

ENDFORM.                    " frm_check_zandaka
*&---------------------------------------------------------------------*
*&      Form  frm_check_eigyousho
*&---------------------------------------------------------------------*
*       ラジオボタン：営業所選択時
*----------------------------------------------------------------------*
FORM FRM_CHECK_EIGYOUSHO.

* 営業所コード入力チェック
IF S_VKBUR IS INITIAL.
MESSAGE E006(Z1) WITH TEXT-M02.
ENDIF.

ENDFORM.                    " frm_check_zensha
*&---------------------------------------------------------------------*
*&      Form  frm_sel_juchuzanichiran
*&---------------------------------------------------------------------*
*       受注残一覧選択時
*----------------------------------------------------------------------*
FORM FRM_SEL_JUCHUZANICHIRAN.

* 営業所抽出処理
PERFORM FRM_SEL_EIGYOUSHO_A.

* 営業グループ抽出処理
PERFORM FRM_SEL_EIGYOUGRP_A.

* 営業員抽出処理
PERFORM FRM_SEL_EIGYOUIN.

* 受注残分析情報抽出処理
PERFORM FRM_SEL_BUNSEKI_A.

ENDFORM.                    " frm_sel_juchuzanichiran
*&---------------------------------------------------------------------*
*&      Form  frm_sel_eigyousho_a
*&---------------------------------------------------------------------*
*       営業所抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_EIGYOUSHO_A.

SELECT *
FROM TVKBT
INTO CORRESPONDING FIELDS OF TABLE GT_EIGYOUSHO
WHERE
**** START UPD 2014/09/25 ISID11 ****
*    SPRAS = CNS_JA
SPRAS = SY-LANGU
**** END UPD 2014/09/25 ISID11 ****
AND VKBUR = P_VKBUR.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M01.
STOP.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_TVKBT SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_eigyousho_a
*&---------------------------------------------------------------------*
*&      Form  frm_sel_eigyougrp_a
*&---------------------------------------------------------------------*
*       営業グループ抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_EIGYOUGRP_A.

SELECT *
FROM TVGRT
INTO CORRESPONDING FIELDS OF TABLE GT_EIGYOUGRP
WHERE
**** START UPD 2014/09/25 ISID11 ****
*    SPRAS = CNS_JA
SPRAS = SY-LANGU
**** END UPD 2014/09/25 ISID11 ****
AND VKGRP IN S_VKGRP.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M03.
STOP.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_TVGRT SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_eigyougrp_a
*&---------------------------------------------------------------------*
*&      Form  frm_sel_eigyouin
*&---------------------------------------------------------------------*
*       営業員抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_EIGYOUIN.

SELECT *
FROM PA0002
INTO CORRESPONDING FIELDS OF TABLE GT_KOJIN_INFO
WHERE PERNR IN S_PERNR.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_PA0002 SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_eigyouin
*&---------------------------------------------------------------------*
*&      Form  frm_sel_bunseki_a
*&---------------------------------------------------------------------*
*       受注残分析情報抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_BUNSEKI_A.

SELECT *
FROM ZS0040
INTO CORRESPONDING FIELDS OF TABLE GT_BUNSEKI_A
WHERE VKBUR = P_VKBUR
AND VKGRP IN S_VKGRP
AND KUNNR IN S_KUNNR
AND NOUKI IN S_DATUM.

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M04.
STOP.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_ZS0040 SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_bunseki_a
*&---------------------------------------------------------------------*
*&      Form  frm_make_zandaka
*&---------------------------------------------------------------------*
*       受注残一覧選択時
*----------------------------------------------------------------------*
FORM FRM_MAKE_ZANDAKA.

*--- ループ処理開始
LOOP AT GT_BUNSEKI_A INTO GF_BUNSEKI_A.

* 初期化処理
CLEAR:GF_WRITE_A.

*   分析(受注残)内部TBL非加工項目の帳票出力用(詳細)内部TBLへの設定
PERFORM FRM_SET_INFO_1B.
*   営業所テキストの設定
PERFORM FRM_SET_INFO_1C.
*   営業グループ名の設定
PERFORM FRM_SET_INFO_1D.
*   受注伝票の取引先機能及びビジネスデータ取得
PERFORM FRM_SET_INFO_1E_STEP1.
*   営業員コードの設定
PERFORM FRM_WHEN_EIGYOIN_CHECK.
*   営業員名の取得
PERFORM FRM_SET_INFO_1E_STEP2.

*   営業員指定時　かつ　営業員指定がブランクでない　かつ
*   営業員名がない場合対象外とする
IF R_EIGYOI = CNS_X       AND
NOT S_PERNR IS INITIAL AND
GF_WRITE_A-NACHN IS INITIAL.
CONTINUE.
ENDIF.

*   得意先名の設定
PERFORM FRM_SET_INFO_1F.
*   未出荷数量の設定
GF_WRITE_A-MSHUKKA = GF_BUNSEKI_A-JUCHU - GF_BUNSEKI_A-SHUKKA.
*   出荷可能数量の設定
GF_WRITE_A-ZKANOU = GF_BUNSEKI_A-PICKUP - GF_BUNSEKI_A-SHUKKA.
*   区、受注単価、原価、各非表示項目の設定
PERFORM FRM_SET_INFO_1J.
* 2012/05/09 ADD START
*   原価(移動平均原価)の設定
PERFORM FRM_SET_INTO_ZVERPR.
* 2012/05/09 ADD END
*   発注番号、発注明細、発注残数、仕入先名の設定
*   原価(発注伝票)、発注通貨の設定
PERFORM FRM_SET_INFO_1K.
*   出荷指示備考の設定
PERFORM FRM_SET_INFO_1M.
*   自由使用欄の設定
PERFORM FRM_SET_INFO_ZSETC3.
*   備考の設定
PERFORM FRM_SET_INFO_ZSETC4.
*   受注残金額の設定
PERFORM FRM_SET_ORDER_ACOUNT.

*   帳票出力用(詳細)内部TBLレコード追加処理
APPEND GF_WRITE_A TO GT_WRITE_A.

ENDLOOP.

ENDFORM.                    " frm_make_zandaka
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1b
*&---------------------------------------------------------------------*
*       分析(受注残)内部TBL非加工項目の帳票出力用(詳細)内部TBLへの設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1B.

GF_WRITE_A-VKBUR    = GF_BUNSEKI_A-VKBUR.     "営業所コード
GF_WRITE_A-VKGRP    = GF_BUNSEKI_A-VKGRP.     "営業グループ
GF_WRITE_A-KUNNR    = GF_BUNSEKI_A-KUNNR.     "得意先コード
GF_WRITE_A-BSTNK    = GF_BUNSEKI_A-BSTNK.     "意先発注番号
GF_WRITE_A-MAKTX    = GF_BUNSEKI_A-MAKTX.     "品目
GF_WRITE_A-JUCHU    = GF_BUNSEKI_A-JUCHU.     "受注数
GF_WRITE_A-VBELN    = GF_BUNSEKI_A-VBELN.     "受注番号
GF_WRITE_A-POSNR    = GF_BUNSEKI_A-POSNR.     "受注明細
GF_WRITE_A-YUSOUTOU = GF_BUNSEKI_A-YUSOUTOU.  "輸送手段等
GF_WRITE_A-VRKME    = GF_BUNSEKI_A-VRKME.     "販売単位
GF_WRITE_A-AUART    = GF_BUNSEKI_A-AUART.     "伝票タイプ
GF_WRITE_A-MATNR    = GF_BUNSEKI_A-MATNR.     "品目コード
GF_WRITE_A-KBMENG   = GF_BUNSEKI_A-PICKUP.    "引当済数量
GF_WRITE_A-WAERS    = GF_BUNSEKI_A-WAERK.     "通貨コード
GF_WRITE_A-NETWR    = GF_BUNSEKI_A-JUCHUKG.   "受注金額
GF_WRITE_A-ZJUDAY   = GF_BUNSEKI_A-AUDAT.     "受注日付
GF_WRITE_A-ZKIBOU   = GF_BUNSEKI_A-NOUKI.     "希望納期

ENDFORM.                    " frm_set_info_1b
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1c
*&---------------------------------------------------------------------*
*       営業所テキストの設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1C.

CLEAR:
GF_EIGYOUSHO.

READ TABLE GT_EIGYOUSHO WITH KEY VKBUR = GF_BUNSEKI_A-VKBUR
INTO GF_EIGYOUSHO.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE_A-BUBZI = GF_EIGYOUSHO-BEZEI.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M01.
STOP.
ENDCASE.

ENDFORM.                    " frm_set_info_1c
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1d
*&---------------------------------------------------------------------*
*       営業グループ名の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1D.

CLEAR:
GF_EIGYOUGRP.

READ TABLE GT_EIGYOUGRP WITH KEY VKGRP = GF_BUNSEKI_A-VKGRP
INTO GF_EIGYOUGRP.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE_A-GRBZI = GF_EIGYOUGRP-BEZEI.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M03.
STOP.
ENDCASE.

ENDFORM.                    " frm_set_info_1d
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1e_step1
*&---------------------------------------------------------------------*
*       受注伝票の取引先機能及びビジネスデータ取得
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1E_STEP1.

DATA:
L_BSTDK_E TYPE VBKD-BSTDK_E.

CLEAR:
GF_VBPA_KD.

SELECT SINGLE *
INTO CORRESPONDING FIELDS OF GF_VBPA_KD
FROM VBPA AS A INNER JOIN VBKD AS B
ON A~VBELN = B~VBELN AND
A~POSNR = B~POSNR
WHERE A~VBELN = GF_BUNSEKI_A-VBELN
AND  A~PARVW = CNS_AG.

CASE SY-SUBRC.
WHEN 0.
*     換算レート
GF_WRITE_A-STCUR  = GF_VBPA_KD-KURSK.

*     得意先回答納期(明細を優先して取得)
SELECT SINGLE BSTDK_E
INTO L_BSTDK_E
FROM VBKD
WHERE VBELN = GF_BUNSEKI_A-VBELN
AND POSNR = GF_BUNSEKI_A-POSNR.

IF NOT L_BSTDK_E IS INITIAL.
GF_WRITE_A-ZKKAITOU = L_BSTDK_E.
ELSE.
GF_WRITE_A-ZKKAITOU = GF_VBPA_KD-BSTDK_E.
ENDIF.

WHEN 4.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_VBPA_VBKD SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_set_info_1e_step1
*&---------------------------------------------------------------------*
*&      Form  frm_when_eigyoin_check
*&---------------------------------------------------------------------*
*       営業員コードの設定
*----------------------------------------------------------------------*
FORM FRM_WHEN_EIGYOIN_CHECK.

CLEAR:
GF_VBPA.

SELECT SINGLE *
INTO CORRESPONDING FIELDS OF GF_VBPA
FROM VBPA AS A INNER JOIN VBKD AS B
ON A~VBELN = B~VBELN AND
A~POSNR = B~POSNR
WHERE A~VBELN = GF_BUNSEKI_A-VBELN
AND  A~PARVW = CNS_VE.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE_A-PERNR = GF_VBPA-PERNR.
WHEN 4.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_VBPA_VBKD SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_when_eigyoin_check
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1e_step2
*&---------------------------------------------------------------------*
*       営業員名の取得
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1E_STEP2.

CLEAR:
GF_KOJIN_INFO.

READ TABLE GT_KOJIN_INFO WITH KEY PERNR = GF_WRITE_A-PERNR
INTO GF_KOJIN_INFO.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE_A-NACHN = GF_KOJIN_INFO-NACHN.
ENDCASE.

ENDFORM.                    " frm_set_info_1e_step2
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1f
*&---------------------------------------------------------------------*
*       得意先名の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1F.

* 汎用モジュール'ADDR_GET'用構造
DATA: ADDRESS  LIKE ADDR1_SEL.         "アドレス番号設定用
DATA: LF_TNAME LIKE SADR.              "得意先名取得用

* 初期処理(アドレス番号の設定)
ADDRESS-ADDRNUMBER = GF_VBPA_KD-ADRNR.

* 得意先名取得(汎用モジュール呼び出し)
CALL FUNCTION 'ADDR_GET'
EXPORTING
ADDRESS_SELECTION = ADDRESS
IMPORTING
SADR              = LF_TNAME
EXCEPTIONS
PARAMETER_ERROR   = 1
ADDRESS_NOT_EXIST = 2
VERSION_NOT_EXIST = 3
INTERNAL_ERROR    = 4
OTHERS            = 5.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE_A-ZKNAME = LF_TNAME-NAME1.
WHEN OTHERS.
GF_WRITE_A-ZKNAME = ' '.
ENDCASE.

ENDFORM.                    " frm_set_info_1f

*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1j
*&---------------------------------------------------------------------*
*       区、受注単価、原価、各非表示項目の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1J.

DATA:
L_TANKA(15)   TYPE P DECIMALS 4,
L_GENKA(16)   TYPE P.

CLEAR:
GF_VBAP.

SELECT SINGLE KDMAT
WAVWR
* 2012/05/09 ADD START
WERKS
* 2012/05/09 ADD END
INTO CORRESPONDING FIELDS OF GF_VBAP
FROM VBAP
WHERE VBELN = GF_BUNSEKI_A-VBELN
AND POSNR = GF_BUNSEKI_A-POSNR.

CASE SY-SUBRC.
WHEN 0.
*     区の設定
IF GF_BUNSEKI_A-PSTYV = CNS_ZSEO.             "ZSEO
GF_WRITE_A-PSTYV = TEXT-007.
ELSEIF GF_BUNSEKI_A-PSTYV = CNS_ZSEK.         "ZSEK
GF_WRITE_A-PSTYV = TEXT-008.
ELSE.
**** START UPD 2014/09/26 ISID11 ****
*        GF_WRITE_A-PSTYV = '　'.
GF_WRITE_A-PSTYV = TEXT-010.
**** END UPD 2014/09/26 ISID11 ****
ENDIF.

*     受注単価の設定
*     販売単価の価格変換
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_A-WAERK
GF_BUNSEKI_A-JTANKA
CHANGING L_TANKA.

IF GF_BUNSEKI_A-TANITANKA = 0.
GF_WRITE_A-NETPR = 0.
ELSE.
GF_WRITE_A-NETPR = L_TANKA / GF_BUNSEKI_A-TANITANKA.
ENDIF.

*     受注単価取得
IF GF_BUNSEKI_A-TANITANKA = 0 OR
GF_VBPA_KD-KURSK = 0.
GF_WRITE_A-ZJNETPR = 0.
ELSE.
GF_WRITE_A-ZJNETPR = L_TANKA / GF_BUNSEKI_A-TANITANKA
* GF_VBPA_KD-KURSK.
ENDIF.

*     非表示用項目の設定
GF_WRITE_A-KDMAT  = GF_VBAP-KDMAT.

*     原価(ローカル)の設定
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_A-WAERK
GF_VBAP-WAVWR
CHANGING L_GENKA.

IF GF_BUNSEKI_A-PICKUP = 0 OR
GF_VBPA_KD-KURSK  = 0.
GF_WRITE_A-ZGYEN = 0.
ELSE.
GF_WRITE_A-ZGYEN = L_GENKA / GF_BUNSEKI_A-PICKUP
* GF_VBPA_KD-KURSK.
ENDIF.

WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M05.
STOP.

WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_VBAP SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_set_info_1j
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1k
*&---------------------------------------------------------------------*
*       発注番号、発注明細、発注残数、仕入先名の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1K.

CLEAR:
GF_VBEP_EKPO.

SELECT SINGLE C~EBELN
C~EBELP
C~MENGE
C~EVERS
D~LIFNR
* 2012/05/09 ADD START
C~NETPR
C~PEINH
D~WAERS
* 2012/05/09 ADD END
INTO CORRESPONDING FIELDS OF GF_VBEP_EKPO
FROM VBEP AS A
INNER JOIN EKET AS B
ON A~BANFN = B~BANFN
AND A~BNFPO = B~BNFPO
INNER JOIN EKPO AS C
ON B~EBELN = C~EBELN
AND B~EBELP = C~EBELP
INNER JOIN EKKO AS D
ON C~EBELN = D~EBELN
WHERE A~VBELN = GF_BUNSEKI_A-VBELN
AND   A~POSNR = GF_BUNSEKI_A-POSNR
AND   A~BANFN <> SPACE.

CASE SY-SUBRC.
WHEN 0.
*     購買伝票情報の設定
PERFORM FRM_SET_INFO_1K_STEP1.
WHEN 4.
GF_VBEP_EKPO-EBELN = ' '.    "購買発注伝票
GF_VBEP_EKPO-EBELP = ' '.    "購買発注明細
GF_VBEP_EKPO-MENGE = ' '.    "発注数量
* 2012/05/09 ADD START
GF_VBEP_EKPO-WAERS = ' '.    "通貨コード
GF_VBEP_EKPO-NETPR = ' '.    "正味価格
* 2012/05/09 ADD END
*     購買伝票情報の設定
PERFORM FRM_SET_INFO_1K_STEP1.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_VBEP_EKPO_EKKO SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_set_info_1k
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1k_step1
*&---------------------------------------------------------------------*
*       購買伝票情報の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1K_STEP1.

DATA:
* 2012/05/09 ADD START
L_NETPR(15) TYPE P DECIMALS 4,
* 2012/05/09 ADD END
L_WEMNG TYPE EKET-WEMNG,
L_NAME  TYPE LFA1-NAME1.

* 発注番号、発注明細の設定
GF_WRITE_A-EBELN = GF_VBEP_EKPO-EBELN.
GF_WRITE_A-EBELP = GF_VBEP_EKPO-EBELP.
GF_WRITE_A-EVERS = GF_VBEP_EKPO-EVERS.

* 2012/05/09 ADD START
* 原価(発注伝票)、発注通貨の設定
IF NOT GF_VBEP_EKPO-WAERS IS INITIAL.
*   価格変換
PERFORM FRM_KINGAKU_HENKAN USING    GF_VBEP_EKPO-WAERS
GF_VBEP_EKPO-NETPR
CHANGING L_NETPR.
GF_WRITE_A-ZNETPR = L_NETPR / GF_VBEP_EKPO-PEINH.
GF_WRITE_A-ZWAERS = GF_VBEP_EKPO-WAERS.

ENDIF.
* 2012/05/09 ADD END

* 発注明細テキストから、仕入先回答納期を取得
PERFORM GET_ZLKAITOU.

* 発注残数、発注数量(非表示)、入庫在庫(非表示)の設定
SELECT SUM( WEMNG )
INTO L_WEMNG
FROM EKET
WHERE EBELN = GF_WRITE_A-EBELN
AND   EBELP = GF_WRITE_A-EBELP.

CASE SY-SUBRC.
WHEN 0.
*     発注残数、発注数量、入庫数量の設定
PERFORM FRM_SET_INFO_1K_STEP2 USING L_WEMNG.
WHEN 4.
L_WEMNG = 0.
*     発注残数、発注数量、入庫数量の設定
PERFORM FRM_SET_INFO_1K_STEP2 USING L_WEMNG.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_EKET SY-SUBRC.
ENDCASE.

* 仕入先の設定
SELECT SINGLE NAME1
FROM LFA1
INTO L_NAME
WHERE LIFNR = GF_VBEP_EKPO-LIFNR.

CASE SY-SUBRC.
WHEN 0.
GF_WRITE_A-ZLNAME = L_NAME.
WHEN 4.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_LFA1 SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_set_info_1kstep1
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1k_step2
*&---------------------------------------------------------------------*
*       発注残数、発注数量、入庫数量の設定
*----------------------------------------------------------------------*
*       --> AI_WEMNG  入庫数量
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1K_STEP2 USING AI_WEMNG.

* 発注残数
GF_WRITE_A-HZNUM = GF_VBEP_EKPO-MENGE - AI_WEMNG.
* 発注数量
GF_WRITE_A-ZHMENGE = GF_VBEP_EKPO-MENGE.
* 入庫数量
GF_WRITE_A-ZHWEMNG = AI_WEMNG.
* 発注先コード
GF_WRITE_A-LIFNR = GF_VBEP_EKPO-LIFNR.

ENDFORM.                    " frm_set_info_1k_step2

*&---------------------------------------------------------------------*
*&      Form  GET_ZLKAITOU
*&---------------------------------------------------------------------*
*       仕入先回答納期取得
*----------------------------------------------------------------------*
FORM GET_ZLKAITOU.
***ローカルＤＡＴＡ
DATA: L_EBEELNEBELP1   LIKE  THEAD-TDNAME,
LT_TLINE         LIKE  TABLE  OF  TLINE WITH HEADER LINE.

CLEAR:L_EBEELNEBELP1.
REFRESH: LT_TLINE.

CONCATENATE GF_WRITE_A-EBELN GF_WRITE_A-EBELP
INTO L_EBEELNEBELP1.

***汎用モジュール
CALL FUNCTION 'READ_TEXT'
EXPORTING
ID       = 'F04'
**** START UPD 2014/09/25 ISID11 ****
*      LANGUAGE = 'J'
LANGUAGE = SY-LANGU
**** END UPD 2014/09/25 ISID11 ****
NAME     = L_EBEELNEBELP1
OBJECT   = 'EKPO'
TABLES
LINES    = LT_TLINE
EXCEPTIONS
OTHERS   = 1.
IF SY-SUBRC = 0.
READ TABLE LT_TLINE INDEX 1.
GF_WRITE_A-ZLKAITOU =  LT_TLINE-TDLINE.
ENDIF.

ENDFORM.                    " GET_ZLKAITOU
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_1m
*&---------------------------------------------------------------------*
*       出荷指示備考の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_1M.

* 出荷指示備考のテキスト格納用内部ＴＢＬ
DATA: LF_TEXT LIKE TLINE,
LT_TEXT LIKE TABLE OF LF_TEXT.
DATA: NAME  LIKE THEAD-TDNAME.

CONCATENATE GF_BUNSEKI_A-VBELN
GF_BUNSEKI_A-POSNR
INTO NAME.

CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = '9001'
**** START UPD 2014/09/25 ISID11 ****
*      LANGUAGE                = 'J'
LANGUAGE                = SY-LANGU
**** END UPD 2014/09/25 ISID11 ****
NAME                    = NAME
OBJECT                  = 'VBBP'
TABLES
LINES                   = LT_TEXT
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TEXT INTO LF_TEXT INDEX 1.
GF_WRITE_A-ZSETC = LF_TEXT-TDLINE+0(40).
WHEN 4.
WHEN OTHERS.
MESSAGE E001(Z1) WITH CNS_READTXT SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_set_info_1m
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_INFO_ZSETC3
*&---------------------------------------------------------------------*
*       自由使用欄の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_ZSETC3.

* 自由使用欄のテキスト格納用内部ＴＢＬ
DATA: LF_TEXT LIKE TLINE,
LT_TEXT LIKE TABLE OF LF_TEXT.
DATA: NAME  LIKE THEAD-TDNAME.

DATA: L_MSG(120) TYPE C .

NAME = GF_BUNSEKI_A-VBELN.

CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = 'Z009'
**** START UPD 2014/09/25 ISID11 ****
*      LANGUAGE                = 'J'
LANGUAGE                = SY-LANGU
**** END UPD 2014/09/25 ISID11 ****
NAME                    = NAME
OBJECT                  = 'VBBK'
TABLES
LINES                   = LT_TEXT
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TEXT INTO LF_TEXT INDEX 1.
GF_WRITE_A-ZSETC3 = LF_TEXT-TDLINE+0(40).
WHEN 4.
WHEN 6.
**** START UPD 2014/09/25 ISID11 ****
*      CONCATENATE '受注'
*                  GF_BUNSEKI_A-VBELN
*                  'の自由使用欄がありません。'
*             INTO L_MSG .
*      MESSAGE I400(Z1) WITH L_MSG.
MESSAGE I075(Z3) WITH GF_BUNSEKI_A-VBELN.
**** END UPD 2014/09/25 ISID11 ****
WHEN OTHERS.
MESSAGE E001(Z1) WITH CNS_READTXT SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_INFO_ZSETC3
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_INFO_ZSETC4
*&---------------------------------------------------------------------*
*       備考の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_ZSETC4.

* 備考のテキスト格納用内部ＴＢＬ
DATA: LF_TEXT LIKE TLINE,
LT_TEXT LIKE TABLE OF LF_TEXT.
DATA: NAME  LIKE THEAD-TDNAME.

DATA: L_MSG(120) TYPE C .

NAME = GF_BUNSEKI_A-VBELN.

CALL FUNCTION 'READ_TEXT'
EXPORTING
ID                      = 'Z010'
**** START UPD 2014/09/25 ISID11 ****
*      LANGUAGE                = 'J'
LANGUAGE                = SY-LANGU
**** END UPD 2014/09/25 ISID11 ****
NAME                    = NAME
OBJECT                  = 'VBBK'
TABLES
LINES                   = LT_TEXT
EXCEPTIONS
ID                      = 1
LANGUAGE                = 2
NAME                    = 3
NOT_FOUND               = 4
OBJECT                  = 5
REFERENCE_CHECK         = 6
WRONG_ACCESS_TO_ARCHIVE = 7
OTHERS                  = 8.

CASE SY-SUBRC.
WHEN 0.
READ TABLE LT_TEXT INTO LF_TEXT INDEX 1.
GF_WRITE_A-ZSETC4 = LF_TEXT-TDLINE+0(40).
WHEN 4.
WHEN 6.
**** START UPD 2014/09/25 ISID11 ****
*      CONCATENATE '受注'
*                  GF_BUNSEKI_A-VBELN
*                  'の備考がありません。'
*             INTO L_MSG .
*      MESSAGE I400(Z1) WITH L_MSG.
MESSAGE I076(Z3) WITH GF_BUNSEKI_A-VBELN.
**** END UPD 2014/09/25 ISID11 ****

WHEN OTHERS.
MESSAGE E001(Z1) WITH CNS_READTXT SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_INFO_ZSETC4
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_ORDER_ACOUNT
*&---------------------------------------------------------------------*
*       追加：受注残金額の設定
*----------------------------------------------------------------------*
FORM FRM_SET_ORDER_ACOUNT.

DATA:
L_JUCHUKG(15)  TYPE P DECIMALS 4,  "受注金額
L_SHUKKAKG(15) TYPE P DECIMALS 4,  "出荷済金額
L_SHUKKOKG(15) TYPE P DECIMALS 4,  "出庫済金額
L_SEIKYUKG(15) TYPE P DECIMALS 4,  "請求済金額
L_ZANKG1(15)   TYPE P DECIMALS 4,  "受注残金額(未出荷まで)
L_ZANKG2(15)   TYPE P DECIMALS 4,  "受注残金額(未出庫まで)
L_ZANKG3(15)   TYPE P DECIMALS 4.  "受注残金額(未請求まで)

* 各金額を価格変換
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_A-WAERK
GF_BUNSEKI_A-JUCHUKG
CHANGING L_JUCHUKG.
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_A-WAERK
GF_BUNSEKI_A-SHUKKAKG
CHANGING L_SHUKKAKG.
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_A-WAERK
GF_BUNSEKI_A-SHUKKOKG
CHANGING L_SHUKKOKG.
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_A-WAERK
GF_BUNSEKI_A-SEIKYUKG
CHANGING L_SEIKYUKG.

* 受注残金額(未出荷まで)
L_ZANKG1 = L_JUCHUKG - L_SHUKKAKG.
* 受注残金額(未出庫まで)
L_ZANKG2 = L_JUCHUKG - L_SHUKKOKG.
* 受注残金額(未請求まで)
L_ZANKG3 = L_JUCHUKG - L_SEIKYUKG.

* 伝票タイプが'RE''ZRE''KR'のときはマイナス１をかける
IF  ( GF_BUNSEKI_A-AUART = CNS_RE
OR GF_BUNSEKI_A-AUART = CNS_KR
OR GF_BUNSEKI_A-AUART = CNS_ZRE ).
L_ZANKG1 = L_ZANKG1 * -1 .
L_ZANKG2 = L_ZANKG2 * -1 .
L_ZANKG3 = L_ZANKG3 * -1 .
ENDIF.

* 受注金額の設定
GF_WRITE_A-NETWR = L_JUCHUKG.
* 受注金額(ローカル)の設定
GF_WRITE_A-ZNETWR = L_JUCHUKG * GF_VBPA_KD-KURSK.
* 受注残金額(未出荷まで)の設定
GF_WRITE_A-ZGOUKEI1 = L_ZANKG1.
* 受注残金額(未出庫まで)の設定
GF_WRITE_A-ZGOUKEI2 = L_ZANKG2.
* 受注残金額(未請求まで)の設定
GF_WRITE_A-ZGOUKEI3 = L_ZANKG3.

ENDFORM.                    " frm_set_info_2dのコピー
*&---------------------------------------------------------------------*
*&      Form  FRM_KINGAKU_HENKAN
*&---------------------------------------------------------------------*
*       金額変換処理
*----------------------------------------------------------------------*
*      -->P_TSUKACD  通貨コード
*      -->P_KINGAKU  変換前金額
*      <--P_HENKAN   変換後金額
*----------------------------------------------------------------------*
FORM FRM_KINGAKU_HENKAN USING    P_TSUKACD
P_KINGAKU
CHANGING P_HENKAN.
DATA : L_AMOUNT_DIS TYPE WMTO_S-AMOUNT,
L_AMOUNT_INT TYPE WMTO_S-AMOUNT.
L_AMOUNT_INT = P_KINGAKU.
*--- 汎用モジュール金額変換モジュール
CALL FUNCTION 'CURRENCY_AMOUNT_SAP_TO_DISPLAY'
EXPORTING
CURRENCY        = P_TSUKACD
AMOUNT_INTERNAL = L_AMOUNT_INT
IMPORTING
AMOUNT_DISPLAY  = L_AMOUNT_DIS
EXCEPTIONS
INTERNAL_ERROR  = 1
OTHERS          = 2.
IF SY-SUBRC <> 1.
P_HENKAN = L_AMOUNT_DIS.
ENDIF.

ENDFORM.                    " FRM_KINGAKU_HENKAN
*&---------------------------------------------------------------------*
*&      Form  frm_write_ichiran_a
*&---------------------------------------------------------------------*
*       帳票(詳細)出力処理
*----------------------------------------------------------------------*
FORM FRM_WRITE_ICHIRAN_A.

* ＡＬＶ改ページ関連処理
PERFORM FRM_ALV_PAGE_NEXT.

* 初期設定
GF_REPID = SY-REPID.

* ページ切り替え設定
**** START UPD 2014/09/25 ISID11 ****
*  GF_LAYOUT-GROUP_CHANGE_EDIT = CNS_JA.
GF_LAYOUT-GROUP_CHANGE_EDIT = SY-LANGU.
**** END UPD 2014/09/25 ISID11 ****
CASE CNS_X.
WHEN R_EIGYOG.
GF_VARIANT-VARIANT = '/ZS010810_01'.          "営業グループ選択時
WHEN R_EIGYOI.
GF_VARIANT-VARIANT = '/ZS010810_02'.                "営業員選択時
ENDCASE.

* 内部テーブル変換処理
GT_ALV_A[] = GT_WRITE_A[].

**** START UPD 2014/09/25 ISID11 ****
*  GF_LAYOUT-TOTALS_TEXT = '合計'.
GF_LAYOUT-TOTALS_TEXT = TEXT-009.
**** END UPD 2014/09/25 ISID11 ****

* ALVステータス印刷拒否設定---*
GF_PRINT-NO_PRINT_LISTINFOS = CNS_X.

* 帳票の出力
CALL FUNCTION 'REUSE_ALV_LIST_DISPLAY'
EXPORTING
I_CALLBACK_PROGRAM = GF_REPID              "レポートID
I_STRUCTURE_NAME   = 'ZSLIST_V08_07'             "構造
IS_LAYOUT          = GF_LAYOUT         "レイアウト設定
I_SAVE             = 'A'               "レイアウト保存
IS_VARIANT         = GF_VARIANT
IT_EVENTS          = GT_EVENT[]          "イベント設定
IS_PRINT           = GF_PRINT                "印刷設定
TABLES
T_OUTTAB           = GT_ALV_A                   "TABLE
EXCEPTIONS
PROGRAM_ERROR      = 1
OTHERS             = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.
ENDFORM.                    " frm_write_ichiran_a
*&---------------------------------------------------------------------*
*&      Form  FRM_ALV_PAGE_NEXT
*&---------------------------------------------------------------------*
*       改ページ関連処理
*----------------------------------------------------------------------*
FORM FRM_ALV_PAGE_NEXT.

* 使用可能イベントのチェック
CALL FUNCTION 'REUSE_ALV_EVENTS_GET'
EXPORTING
I_LIST_TYPE     = 0
IMPORTING
ET_EVENTS       = GT_EVENT  "使用可能なイベント取得
EXCEPTIONS
LIST_TYPE_WRONG = 1
OTHERS          = 2.

* 使用イベントに実行するサブルーチン名を設定
LOOP AT GT_EVENT INTO GF_EVENT.
CASE GF_EVENT-NAME.
WHEN 'TOP_OF_PAGE'.
GF_EVENT-FORM = 'FRM_TOP_OF_PAGE'.
MODIFY GT_EVENT FROM GF_EVENT.
WHEN 'CALLER_EXIT'.
GF_EVENT-FORM = 'FRM_CALLER_EXIT'.
MODIFY GT_EVENT FROM GF_EVENT.
ENDCASE.
ENDLOOP.

ENDFORM.                    " FRM_ALV_PAGE_NEXT
*&---------------------------------------------------------------------*
*&      Form  FRM_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*       帳票ヘッダ書き出し処理
*----------------------------------------------------------------------*
FORM FRM_TOP_OF_PAGE.

DATA: L_SY-TABIX TYPE P.

L_SY-TABIX = SY-TABIX.

* 帳票出力マスタからヘッダ情報取得
IF R_BALANC = CNS_X AND R_EIGYOG = CNS_X.
*   1ページ目
IF SY-PAGNO = 1.
READ TABLE GT_ALV_A INTO GF_HEADER_A INDEX 1.
WRITE: 42 TEXT-A01.
SKIP.
WRITE: / TEXT-A04,':',GT_ALV_A-VKBUR,'/',GT_ALV_A-BUBZI,
TEXT-A05,':',GT_ALV_A-VKGRP,'/',GT_ALV_A-GRBZI.

*   2ページ目以降
ELSEIF SY-PAGNO >= 2.
READ TABLE GT_ALV_A INTO GF_HEADER_A INDEX L_SY-TABIX.
WRITE: 42 TEXT-A01.
SKIP.
WRITE: / TEXT-A04,':',GT_ALV_A-VKBUR,'/',GT_ALV_A-BUBZI,
TEXT-A05,':',GT_ALV_A-VKGRP,'/',GT_ALV_A-GRBZI.
ENDIF.

ELSEIF R_BALANC = CNS_X AND R_EIGYOI = CNS_X.
*   1ページ目
IF SY-PAGNO = 1.
READ TABLE GT_ALV_A INTO GF_HEADER_A INDEX 1.
WRITE: 42 TEXT-A01.
SKIP.
WRITE: / TEXT-A04,':',GT_ALV_A-VKBUR,'/',GT_ALV_A-BUBZI,
TEXT-A06,':',GT_ALV_A-PERNR,'/',GT_ALV_A-NACHN.
*   2ページ目以降
ELSEIF SY-PAGNO >= 2.
READ TABLE GT_ALV_A INTO GF_HEADER_A INDEX L_SY-TABIX.
WRITE: 42 TEXT-A01.
SKIP.
WRITE: / TEXT-A04,':',GT_ALV_A-VKBUR,'/',GT_ALV_A-BUBZI,
TEXT-A06,':',GT_ALV_A-PERNR,'/',GT_ALV_A-NACHN.
ENDIF.

ELSEIF R_ZENSHA = CNS_X.
WRITE: 42 TEXT-A02.
SKIP.

ELSEIF R_EIGYOS = CNS_X.
*   1ページ目
IF SY-PAGNO = 1.
READ TABLE GT_ALV_B INTO GF_HEADER_B INDEX 1.
WRITE :42 TEXT-A03.
SKIP.
WRITE: / TEXT-A04,':',GT_ALV_B-VKBUR,'/',GT_ALV_B-BUBZI.
*   2ページ目以降
ELSEIF SY-PAGNO >= 2.
READ TABLE GT_ALV_B INTO GF_HEADER_B INDEX L_SY-TABIX.
WRITE :42 TEXT-A03.
SKIP.
WRITE: / TEXT-A04,':',GT_ALV_B-VKBUR,'/',GT_ALV_B-BUBZI.
ENDIF.

ENDIF.

**** START ADD 2014/11/13 ISID11 ****
WRITE: 95 TEXT-A07 RIGHT-JUSTIFIED, 111 GF_WAERS.
**** END ADD 2014/11/13 ISID11 ****

*     ページ番号付加
WRITE: 120 'PAGE:',SY-PAGNO.
ENDFORM.                    "FRM_TOP_OF_PAGE
*&---------------------------------------------------------------------*
*&      FRM_CALLER_EXIT
*&---------------------------------------------------------------------*
*       ALV CALLER_EXIT
*----------------------------------------------------------------------*
FORM FRM_CALLER_EXIT USING RS_DATA TYPE SLIS_DATA_CALLER_EXIT.
RS_DATA-CALLBACK_HEADER_TRANSPORT = 'FILITEXTS_TEXT_TRANSPORT'.
ENDFORM.                    "FRM_CALLER_EXIT
*&---------------------------------------------------------------------*
*&      Form  frm_sel_kingakuichiran
*&---------------------------------------------------------------------*
*       全社・営業所選択時
*----------------------------------------------------------------------*
FORM FRM_SEL_KINGAKUICHIRAN.

* 初期処理(全社選択時－営業所パラメータブランク設定)
IF R_ZENSHA = CNS_X.
CLEAR   S_VKBUR.
REFRESH S_VKBUR.
ENDIF.

* 営業所抽出処理
PERFORM FRM_SEL_EIGYOUSHO_B.

* 営業グループ選択処理(営業所選択時)
IF R_EIGYOS = CNS_X.
PERFORM FRM_SEL_EIGYOUGRP_B.
ENDIF.

* 受注残分析情報抽出処理
PERFORM FRM_SEL_BUNSEKI_B.

* レポートコード抽出処理
IF R_ZENSHA = CNS_X.
PERFORM FRM_SEL_ZS0030.
ENDIF.

ENDFORM.                    " frm_sel_kingakuichiran
*&---------------------------------------------------------------------*
*&      Form  frm_sel_eigyousho_b
*&---------------------------------------------------------------------*
*       全社・営業所抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_EIGYOUSHO_B.

SELECT * FROM TVKBT
INTO CORRESPONDING FIELDS OF TABLE GT_EIGYOUSHO
WHERE
**** START UPD 2014/09/25 ISID11 ****
*    SPRAS = CNS_JA
*     AND  VKBUR IN S_VKBUR.
SPRAS = SY-LANGU
AND  VKBUR IN GF_RNG_VKBUR.
**** END UPD 2014/09/25 ISID11 ****

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M01.
STOP.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_TVKBT SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_eigyousho_b
*&---------------------------------------------------------------------*
*&      Form  frm_sel_eigyougrp_b
*&---------------------------------------------------------------------*
*       営業グループ抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_EIGYOUGRP_B.

SELECT *
FROM TVGRT
INTO CORRESPONDING FIELDS OF TABLE GT_EIGYOUGRP
WHERE
**** START UPD 2014/09/25 ISID11 ****
*     SPRAS = CNS_JA.
SPRAS = SY-LANGU.
**** END UPD 2014/09/25 ISID11 ****

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-M03.
STOP.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_TVGRT SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_eigyougrp_b
*&---------------------------------------------------------------------*
*&      Form  frm_sel_bunseki_b
*&---------------------------------------------------------------------*
*       受注残分析情報抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_BUNSEKI_B.

SELECT *
INTO CORRESPONDING FIELDS OF TABLE GT_BUNSEKI_B
FROM ZS0040
WHERE
**** START UPD 2014/09/25 ISID11 ****
*     VKBUR IN S_VKBUR.
VKBUR IN GF_RNG_VKBUR.
**** END UPD 2014/09/25 ISID11 ****

CASE SY-SUBRC.
WHEN 0.
WHEN 4.
MESSAGE S600(Z1) WITH TEXT-023.
STOP.
WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_ZS0040 SY-SUBRC.
ENDCASE.

ENDFORM.                    " frm_sel_bunseki_b
*&---------------------------------------------------------------------*
*&      Form  FRM_SEL_ZS0030
*&---------------------------------------------------------------------*
*       レポートコード抽出処理
*----------------------------------------------------------------------*
FORM FRM_SEL_ZS0030.

CHECK NOT GT_EIGYOUSHO IS INITIAL.

SELECT ZKEY    "キー
REPCD   "レポートコード
INTO TABLE GT_ZS0030
FROM ZS0030
FOR ALL ENTRIES IN GT_EIGYOUSHO
WHERE ZKEY = GT_EIGYOUSHO-VKBUR.

CASE SY-SUBRC.
WHEN 0 OR 4.
WHEN OTHERS.
*     システムエラー
MESSAGE A603(Z1) WITH SY-REPID CNS_ZS0030 SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SEL_ZS0030
*&---------------------------------------------------------------------*
*&      Form  frm_make_kingakuichiran
*&---------------------------------------------------------------------*
*       全社選択時
*----------------------------------------------------------------------*
FORM FRM_MAKE_KINGAKUICHIRAN.

DATA:
L_KURSK TYPE VBKD-KURSK,
L_EDATU TYPE VBEP-EDATU.

* ループ処理開始
LOOP AT GT_BUNSEKI_B INTO GF_BUNSEKI_B.

CLEAR:
GF_WRITE_B,
L_KURSK,
L_EDATU.

* 帳票ＩＤの設定
PERFORM FRM_SET_INFO_2A.
* 営業所コード、営業所名の設定
PERFORM FRM_SET_INFO_2B.
* 営業グループ名の設定
CASE CNS_X.
WHEN R_EIGYOS.
PERFORM FRM_SET_INFO_2C.
ENDCASE.

* 換算レート取得
PERFORM FRM_GET_KURSK CHANGING L_KURSK.

* 納入日程日付取得
PERFORM FRM_GET_EDATU CHANGING L_EDATU.

* 受注残金額の設定
PERFORM FRM_SET_INFO_2D USING L_KURSK
L_EDATU.

* レポートコードの設定
IF R_ZENSHA = CNS_X.
PERFORM FRM_SET_REPCD.
ENDIF.

* 帳票出力用(会社・営業所)内部ＴＢＬの設定
PERFORM FRM_SET_INFO_2E.

ENDLOOP.

ENDFORM.                    " frm_make_kingakuichiran
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_2a
*&---------------------------------------------------------------------*
*       帳票ＩＤの設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_2A.

CASE CNS_X.
WHEN R_ZENSHA.
GF_WRITE_B-ZLISTID = '2'.                            "帳票ＩＤ
WHEN R_EIGYOS.
GF_WRITE_B-ZLISTID = '3'.                            "帳票ＩＤ
ENDCASE.

ENDFORM.                    " frm_set_info_2a
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_2b
*&---------------------------------------------------------------------*
*       営業所コード・営業所名の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_2B.

CLEAR:
GF_EIGYOUSHO.

READ TABLE GT_EIGYOUSHO WITH KEY VKBUR = GF_BUNSEKI_B-VKBUR
INTO GF_EIGYOUSHO.

IF SY-SUBRC = 0.
GF_WRITE_B-VKBUR = GF_EIGYOUSHO-VKBUR.          "営業所コード
GF_WRITE_B-BUBZI = GF_EIGYOUSHO-BEZEI.          "営業所名
ENDIF.

ENDFORM.                    " frm_set_info_2b
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_2c
*&---------------------------------------------------------------------*
*       営業グループ名の設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_2C.

CLEAR:
GF_EIGYOUGRP.

READ TABLE GT_EIGYOUGRP WITH KEY VKGRP = GF_BUNSEKI_B-VKGRP
INTO GF_EIGYOUGRP.

IF SY-SUBRC = 0.
*   営業グループ
GF_WRITE_B-VKGRP = GF_EIGYOUGRP-VKGRP.
*   営業グループテキスト
GF_WRITE_B-GRBZI = GF_EIGYOUGRP-BEZEI.
ENDIF.

ENDFORM.                    " frm_set_info_2c
*&---------------------------------------------------------------------*
*&      Form  frm_get_kursk
*&---------------------------------------------------------------------*
*       帳票ＩＤの設定
*----------------------------------------------------------------------*
*       --> AO_KURSK  換算レート
*----------------------------------------------------------------------*
FORM FRM_GET_KURSK CHANGING AO_KURSK.

SELECT SINGLE KURSK
FROM VBKD
INTO AO_KURSK
WHERE VBELN = GF_BUNSEKI_B-VBELN.

ENDFORM.                    " frm_get_kursk
*&---------------------------------------------------------------------*
*&      Form  frm_get_edatu
*&---------------------------------------------------------------------*
*       納入日程日付の取得
*----------------------------------------------------------------------*
*       --> AO_EDATU  納入日程日付
*----------------------------------------------------------------------*
FORM FRM_GET_EDATU CHANGING AO_EDATU.

SELECT SINGLE BSTDK_E
FROM VBKD
INTO AO_EDATU
WHERE VBELN = GF_BUNSEKI_B-VBELN
AND  POSNR = GF_BUNSEKI_B-POSNR.

CHECK AO_EDATU IS INITIAL.

SELECT SINGLE BSTDK_E
FROM VBKD
INTO AO_EDATU
WHERE VBELN = GF_BUNSEKI_B-VBELN
AND  POSNR = '000000'.

CHECK AO_EDATU IS INITIAL.

SELECT EDATU
INTO AO_EDATU
FROM VBEP
UP TO 1 ROWS
WHERE VBELN = GF_BUNSEKI_B-VBELN
AND POSNR = GF_BUNSEKI_B-POSNR
ORDER BY EDATU.
ENDSELECT.

ENDFORM.                    " frm_get_edatu
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_2d
*&---------------------------------------------------------------------*
*       受注残金額の設定
*----------------------------------------------------------------------*
*       --> AI_KURSK  換算レート
*       --> AI_EDATU  納入日程日付
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_2D USING AI_KURSK
AI_EDATU.

DATA:
L_JUCHUKG(15)   TYPE P DECIMALS 4,
L_SEIKYUKG(15)  TYPE P DECIMALS 4,
L_JZANKG(15)    TYPE P DECIMALS 4,
L_CNT           TYPE I VALUE 1.

CLEAR:
LM_ZANKIN,
TM_ZANKIN,
N1M_ZANKIN,
N2M_ZANKIN,
N3M_ZANKIN,
N4M_ZANKIN.

* 金額変換
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_B-WAERK
GF_BUNSEKI_B-JUCHUKG
CHANGING L_JUCHUKG.
PERFORM FRM_KINGAKU_HENKAN USING    GF_BUNSEKI_B-WAERK
GF_BUNSEKI_B-SEIKYUKG
CHANGING L_SEIKYUKG.

* 受注残金額の取得
L_JZANKG = ( L_JUCHUKG - L_SEIKYUKG ) * AI_KURSK.

* 伝票タイプが'RE''ZRE''KR'のときはマイナス１をかける
IF  ( GF_BUNSEKI_B-AUART = CNS_RE
OR GF_BUNSEKI_B-AUART = CNS_KR
OR GF_BUNSEKI_B-AUART = CNS_ZRE ).
L_JZANKG = L_JZANKG * -1 .
ENDIF.

*--- (エ) 受注残金額対象月の設定
* 対象月の設定(１)
YEARS = SY-DATUM.  "GF_BUNSEKI_B-EDATU."+6(2).

DO.
CASE L_CNT.
WHEN 1.
YEARS+6(2) = 1.
YEARS_1 = YEARS + 31.
WHEN 2.
YEARS_1+6(2) = 1.
YEARS_2 = YEARS_1 + 31.
WHEN 3.
YEARS_2+6(2) = 1.
YEARS_3 = YEARS_2 + 31.
ENDCASE.

L_CNT = L_CNT + 1.

IF L_CNT = 4.
EXIT.
ENDIF.

ENDDO.

* 受注残金額(邦貨)の設定
IF AI_EDATU+0(6) < SY-DATUM+0(6).             "前月以前
LM_ZANKIN = L_JZANKG.
ELSEIF AI_EDATU+0(6) = SY-DATUM+0(6).             "当月
TM_ZANKIN = L_JZANKG.
ELSEIF AI_EDATU+0(6) = YEARS_1+0(6).              "翌月
N1M_ZANKIN = L_JZANKG.
ELSEIF AI_EDATU+0(6) = YEARS_2+0(6).            "翌々月
N2M_ZANKIN = L_JZANKG.
ELSEIF AI_EDATU+0(6) = YEARS_3+0(6).          "翌々翌月
N3M_ZANKIN = L_JZANKG.
ELSEIF AI_EDATU+0(6) > YEARS_3+0(6).      "翌々翌月以降
N4M_ZANKIN = L_JZANKG.
ENDIF.

*--- (オ) 合計の設計
GF_WRITE_B-ZGOUKEI = L_JZANKG.               "合計

ENDFORM.                    " frm_set_info_2d
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_REPCD
*&---------------------------------------------------------------------*
*       レポートコード
*----------------------------------------------------------------------*
FORM FRM_SET_REPCD.

CLEAR GF_ZS0030.

READ TABLE GT_ZS0030 INTO GF_ZS0030
WITH TABLE KEY ZKEY = GF_EIGYOUSHO-VKBUR.

IF SY-SUBRC = 0.
GF_WRITE_B-ZREPCD = GF_ZS0030-REPCD.
ENDIF.

ENDFORM.                    " FRM_SET_REPCD
*&---------------------------------------------------------------------*
*&      Form  frm_set_info_2e
*&---------------------------------------------------------------------*
*       帳票出力用(会社・営業所)内部ＴＢＬの設定
*----------------------------------------------------------------------*
FORM FRM_SET_INFO_2E.

* 帳票(会社・営業所)データ格納用ローカルオブジェクト
DATA: LF_WRITE_B LIKE GF_WRITE_B.

* 初期化処理
CLEAR: LF_WRITE_B-ZZENIZEN,
LF_WRITE_B-ZTOUGETU,
LF_WRITE_B-ZYOKGETU,
LF_WRITE_B-ZYYKGETU,
LF_WRITE_B-ZYYYGETU,
LF_WRITE_B-ZYYYIKOU.

CASE CNS_X.
WHEN R_ZENSHA.      "全社選択時
READ TABLE GT_WRITE_B WITH KEY VKBUR = GF_BUNSEKI_B-VKBUR
INTO LF_WRITE_B.
WHEN R_EIGYOS.      "営業所選択時
READ TABLE GT_WRITE_B WITH KEY
VKBUR = GF_BUNSEKI_B-VKBUR
VKGRP = GF_BUNSEKI_B-VKGRP INTO LF_WRITE_B.
ENDCASE.

CASE SY-SUBRC.
*--- (イ) データあり

WHEN 0.
GF_WRITE_B-ZZENIZEN  = LM_ZANKIN + LF_WRITE_B-ZZENIZEN.
GF_WRITE_B-ZTOUGETU  = TM_ZANKIN + LF_WRITE_B-ZTOUGETU.
GF_WRITE_B-ZYOKGETU = N1M_ZANKIN + LF_WRITE_B-ZYOKGETU.
GF_WRITE_B-ZYYKGETU = N2M_ZANKIN + LF_WRITE_B-ZYYKGETU.
GF_WRITE_B-ZYYYGETU = N3M_ZANKIN + LF_WRITE_B-ZYYYGETU.
GF_WRITE_B-ZYYYIKOU = N4M_ZANKIN + LF_WRITE_B-ZYYYIKOU.
GF_WRITE_B-ZGOUKEI  = GF_WRITE_B-ZGOUKEI + LF_WRITE_B-ZGOUKEI.

MODIFY TABLE GT_WRITE_B FROM GF_WRITE_B.
*--- (ア) データ無し
WHEN 4.
GF_WRITE_B-ZZENIZEN  = LM_ZANKIN.
GF_WRITE_B-ZTOUGETU  = TM_ZANKIN.
GF_WRITE_B-ZYOKGETU = N1M_ZANKIN.
GF_WRITE_B-ZYYKGETU = N2M_ZANKIN.
GF_WRITE_B-ZYYYGETU = N3M_ZANKIN.
GF_WRITE_B-ZYYYIKOU = N4M_ZANKIN.

APPEND GF_WRITE_B TO GT_WRITE_B.
ENDCASE.

ENDFORM.                    " frm_set_info_2e
*&---------------------------------------------------------------------*
*&      Form  frm_write_ichiran_b
*&---------------------------------------------------------------------*
*       帳票(会社・営業所)出力処理
*----------------------------------------------------------------------*
FORM FRM_WRITE_ICHIRAN_B.

* ＡＬＶ改ページ関連処理
PERFORM FRM_ALV_PAGE_NEXT.

* 初期設定
GF_REPID = SY-REPID.

* ページ切り替え設定
**** START UPD 2014/09/25 ISID11 ****
*  GF_LAYOUT-GROUP_CHANGE_EDIT = CNS_JA.
GF_LAYOUT-GROUP_CHANGE_EDIT = SY-LANGU.
**** END UPD 2014/09/25 ISID11 ****

IF R_ZENSHA = CNS_X.
GF_VARIANT-VARIANT = '/ZS010810_03'.             "全社選択時
ELSEIF R_EIGYOS = CNS_X.
GF_VARIANT-VARIANT = '/ZS010810_04'.           "営業所選択時
ENDIF.

* 内部テーブル変換処理
GT_ALV_B[] = GT_WRITE_B[].

**** START UPD 2014/09/25 ISID11 ****
*  GF_LAYOUT-TOTALS_TEXT = '合計'.
GF_LAYOUT-TOTALS_TEXT = TEXT-009..
**** END UPD 2014/09/25 ISID11 ****

* 帳票の出力
CALL FUNCTION 'REUSE_ALV_LIST_DISPLAY'
EXPORTING
I_CALLBACK_PROGRAM = GF_REPID              "レポートID
I_STRUCTURE_NAME   = 'ZSLIST_V08_06'             "構造
IS_LAYOUT          = GF_LAYOUT         "レイアウト設定
I_SAVE             = 'A'               "レイアウト保存
IS_VARIANT         = GF_VARIANT
IT_EVENTS          = GT_EVENT[]          "イベント設定
TABLES
T_OUTTAB           = GT_ALV_B                   "TABLE
EXCEPTIONS
PROGRAM_ERROR      = 1
OTHERS             = 2.

IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " frm_write_ichiran_b
* 2012/05/09 ADD START
*&---------------------------------------------------------------------*
*&      Form  FRM_SET_INTO_ZVERPR
*&---------------------------------------------------------------------*
*       原価(移動平均原価)を設定
*----------------------------------------------------------------------*
FORM FRM_SET_INTO_ZVERPR.

DATA:
L_VERPR      TYPE MBEW-VERPR,
L_PEINH      TYPE MBEW-PEINH,
L_ZVERPR(15) TYPE P DECIMALS 4.

CHECK NOT GF_VBAP-WERKS IS INITIAL.

SELECT SINGLE VERPR
PEINH
INTO (L_VERPR, L_PEINH)
FROM MBEW
WHERE MATNR = GF_BUNSEKI_A-MATNR
AND BWKEY = GF_VBAP-WERKS
AND BWTAR = SPACE.

CASE SY-SUBRC.
WHEN 0.
*     価格変換
PERFORM FRM_KINGAKU_HENKAN USING
**** START UPD 2014/09/25 ISID11 ****
*                                          'JPY'
GF_WAERS
**** END UPD 2014/09/25 ISID11 ****
L_VERPR
CHANGING L_ZVERPR.

GF_WRITE_A-ZVERPR = L_ZVERPR / L_PEINH.

WHEN 8.
MESSAGE A603(Z1) WITH SY-REPID CNS_MBEW SY-SUBRC.
ENDCASE.

ENDFORM.                    " FRM_SET_INTO_ZVERPR
* 2012/05/09 ADD END
**** START ADD 2014/09/25 ISID11 ****
*&---------------------------------------------------------------------*
*&      Form  FRM_CHECK_BUKRS
*&---------------------------------------------------------------------*
*       入力チェック：会社コード
*----------------------------------------------------------------------*
*      -->AI_BUKRS     会社コード
*      -->AI_VKBUR     営業所
*      -->AI_SO_VKBUR  営業所
*----------------------------------------------------------------------*
FORM FRM_CHECK_BUKRS  USING    AI_BUKRS    TYPE T001-BUKRS
AI_VKBUR    TYPE TVKBT-VKBUR
AI_SO_VKBUR.
DATA:
L_VKORG      TYPE TVKBZ-VKORG,                    "販売組織
L_T_VKBUR    TYPE STANDARD TABLE OF TVKBZ-VKBUR,  "営業所
L_VKBUR      TYPE TVKBZ-VKBUR,
L_RNG_VKBUR  TYPE RANGE OF TVKBT-VKBUR,           "営業所
L_S_VKBUR     LIKE LINE OF GF_RNG_VKBUR.
CLEAR GF_WAERS.
* 選択画面の会社コードの存在チェックを行う
SELECT SINGLE WAERS
INTO GF_WAERS
FROM T001
WHERE BUKRS = AI_BUKRS.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_BUKRS'.
MESSAGE E016(Z3) WITH AI_BUKRS.
*   会社コード & が存在しません
ENDIF.

* 選択画面の会社コードの権限チェックを行う
AUTHORITY-CHECK OBJECT 'F_BKPF_BUK'
ID 'BUKRS' FIELD AI_BUKRS          "対象会社コード
ID 'ACTVT' FIELD '03'.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_BUKRS'.
MESSAGE E015(Z3) WITH AI_BUKRS.
*   会社コード & では実行する権限がありません。
ENDIF.

* 営業所と会社コードの関連チェック
CASE CNS_X.
WHEN R_BALANC.
CLEAR L_VKORG.
SELECT TVKBZ~VKORG
INTO L_VKORG
FROM TVKO
INNER JOIN TVKBZ
ON TVKO~VKORG = TVKBZ~VKORG
UP TO 1 ROWS
WHERE TVKO~BUKRS = AI_BUKRS
AND TVKBZ~VKBUR = AI_VKBUR.
ENDSELECT.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_BUKRS'.
MESSAGE E140(Z3) WITH AI_BUKRS  AI_VKBUR.
*       会社コード&1と営業所&2の組合せチェックが失敗しました
ENDIF.
WHEN R_EIGYOS OR R_ZENSHA.
L_RNG_VKBUR = AI_SO_VKBUR.
IF R_ZENSHA = CNS_X.
CLEAR L_RNG_VKBUR.
ENDIF.
CLEAR L_T_VKBUR.
SELECT TVKBZ~VKBUR
INTO TABLE L_T_VKBUR
FROM TVKO
INNER JOIN TVKBZ
ON TVKO~VKORG = TVKBZ~VKORG
WHERE TVKO~BUKRS = AI_BUKRS
AND TVKBZ~VKBUR IN L_RNG_VKBUR.

IF SY-SUBRC <> 0.
SET CURSOR FIELD 'P_BUKRS'.
MESSAGE E140(Z3) WITH AI_BUKRS  SPACE.
*       会社コード&1と営業所&2の組合せチェックが失敗しました
ENDIF.

CLEAR GF_RNG_VKBUR.
LOOP AT L_T_VKBUR INTO L_VKBUR.
CLEAR L_S_VKBUR.
L_S_VKBUR-SIGN = 'I'.
L_S_VKBUR-OPTION = 'EQ'.
L_S_VKBUR-LOW = L_VKBUR.
APPEND L_S_VKBUR TO GF_RNG_VKBUR.
ENDLOOP.
ENDCASE.
ENDFORM.                    " FRM_CHECK_BUKRS
**** END ADD 2014/09/25 ISID11 ****
*Text symbol text・
*001:OpOrd List
*002:OpOrd List(WholeCo.)
*003:OpOrd List(Sal.Office)
*004:Se.Cond.
*005:Sales Group
*006:Personal No.
*007:P.
*008:S.
*009:Sum
*010:　
*011:Layout
*023:ZS0040
*A01:**OnOrd List**
*A02:**OnOrd Amt List(Who.)**
*A03:**OnOrd Amt List(Sal.Off.)**
*A04:SalOff
*A05:Sales Group
*A06:Person
*A07:Local Currency:
*M01:SalOff
*M02:Sales Office
*M03:Sales Group
*M04:OnOrder analy.data Table
*M05:SalesDoc
*M06:Mat.Val.
*Selection text・
*P_BUKRS:        Company Code
*P_LAYOUT:        Layout
*P_VKBUR:D       .
*S_DATUM:        Requested Delivery Date
*S_KUNNR:D       .
*S_PERNR:D       .
*S_VKBUR:D       .
*S_VKGRP:D       .
