*&---------------------------------------------------------------------*
*&  REPORT ZN040100                                                    *
*&         支払通知書IF(移行期間用)                                    *
*&---------------------------------------------------------------------*
*&  機能     :当月仕入高を出力する速報（検収明細書）と                 *
*&            当月照合額を出力する確報（支払通知書）の                 *
*&            IFファイルを出力する。                                   *
*&                                                                     *
*&  作成日   : 2012/01/18                                              *
*&  作成者   : H.KOMIYAMA(SOLFIS)                                      *
*&  変更履歴 : 2012/01/24 H.YAMASHITA                                  *
*&  変更内容 : 注文番号の加工時に、明細の前０を除去する。              *
*&  変更履歴 :                                                         *
*&  変更内容 :                                                         *
*&---------------------------------------------------------------------*
report zn040100
no standard page heading
line-size   170
line-count  58
message-id  yn01.

*----------------------------------------------------------------------*
*   宣言部
*----------------------------------------------------------------------*
*** 参照テーブル
tables: lfb1.

*** 構造
*-- 仕入先コード取得用
data: begin of w_lfm1,
lifnr like lfm1-lifnr,              " 仕入先コード
zterm like lfm1-zterm,              " 支払条件キー
waers like lfm1-waers,              " 通貨コード
end   of w_lfm1,
*-- 支払条件取得用
begin of w_t052,
zterm like t052-zterm,              " 支払条件キー
ztagg like t052-ztagg,              " 期限
end   of w_t052,
*-- 出力対象データ取得用
begin of w_yk230,
BELNR    like yk230-belnr,
BUZEI    like yk230-buzei,
lifnr    like yk230-lifnr,          " 仕入先or債権者の勘定コード
werkst   like yk230-werkst,         " 取引プラント
ebeln    like yk230-ebeln,          " 購買伝票番号
ebelp    like yk230-ebelp,          " 購買伝票の明細番号
maktx    like yk230-maktx,          " 品目テキスト
matnr    like yk230-matnr,          " 品目コード
budat    like yk230-budat,          " 伝票の転記日付
knquan   like yk230-knquan,         " 数量
knuntprc like yk230-knuntprc,       " 単価
knitxamt like yk230-knitxamt,       " 税抜金額
kntaxamt like yk230-kntaxamt,       " 消費税額
knetxamt like yk230-knetxamt,       " 税込金額
end   of w_yk230,
*-- 仕入先マスタ一括取得用
begin of w_lfx1,
lifnr like lfb1-lifnr,              " 仕入先コード(請求先)
pstlz like lfa1-pstlz,              " 仕入先郵便番号
adrnr like lfa1-adrnr,              " 住所
tlfxs like lfb1-tlfxs,              " ファックス番号
end   of w_lfx1,
*-- アドレス情報一括取得用
begin of w_adrc,
addrnumber like adrc-addrnumber,    " アドレス番号
name2      like adrc-name2,         " 名前 2
city1      like adrc-city1,         " 市区町村
street     like adrc-street,        " 都道府県名
bezei      like t005u-bezei,        " 地域 (都道府県）
end   of w_adrc,
*-- プラント一括取得用
begin of w_t001w,
werks      like t001w-werks,        " プラント
name1      like t001w-name1,        " 名称
end   of w_t001w,
*-- IFファイル編集用
begin of w_data,
years   type string,                " 計上年月
tname   type string,                " 帳票名称
lifnr   type string,                " 仕入先コード
seqno   type string,                " SEQ
odate   type string,                " 発行日
name2   type string,                " 仕入先名
pstlz   type string,                " 仕入先郵便番号
bezei   type string,                " 地域
stree   type string,                " 都道府県
city1   type string,                " 市区町村
telfx   type string,                " ファックス番号
total   type string,                " 総額
waers   type string,                " 通貨コード
zlsc1   type string,                " 金種1-文言
wrbt1   type string,                " 金種1-金額
zfbd1   type string,                " 金種1-期日
zlsc2   type string,                " 金種2-文言
wrbt2   type string,                " 金種2-金額
zfbd2   type string,                " 金種2-期日
zlsc3   type string,                " 金種3-文言
wrbt3   type string,                " 金種3-金額
zfbd3   type string,                " 金種3-期日
zlsc4   type string,                " 金種4-文言
wrbt4   type string,                " 金種4-金額
zfbd4   type string,                " 金種4-期日
dvson   type string,                " プラントコード
name1   type string,                " プラント名
taxam   type string,                " 消費税額
itxam   type string,                " 税抜金額
etxam   type string,                " 税込金額
ldate   type string,                " 入庫日
list2   type string,                " 注文番号
list5   type string,                " 品目コード
list6   type string,                " 品名
knunt   type string,                " 単価
knqua   type string,                " 数量
knitx   type string,                " 税抜金額
kntax   type string,                " 税額
knetx   type string,                " 税込金額
end   of w_data,
*-- エラーログ出力用
begin of tbl_errlog occurs 0,
lifnr(10) type c,                   " 得意先コード
err(128)  type c,                   " ERR
end of tbl_errlog.

*** 内部テーブル
data: i_lfm1     like standard table of w_lfm1,
i_t052     like sorted   table of w_t052
with unique key zterm ztagg,
i_yk230    like standard table of w_yk230,
i_lfx1     like hashed   table of w_lfx1
with unique key lifnr,
i_adrc     like sorted table of w_adrc
with non-unique key addrnumber,
i_t001w    like standard table of w_t001w,
i_data     like standard table of w_data.

*** グローバル変数
data: rc_code_lock type sy-subrc,
g_cnt_upd    type i,               " 更新件数
g_cnt_out    type i,               " 出力件数
g_cnt_err    type i,               " エラー件数
g_cnt_seq(6) type n,               " SEQカウンタ
g_zfbdt      type datum,           " 照合締日
g_sum_total  like yn220-knetxamt,  " 総額計算用
g_sum_taxam  like yn220-kntaxamt,  " 消費税額計算用
g_sum_itxam  like yn220-knitxamt,  " 税抜金額計算用
g_sum_etxam  like yn220-knetxamt.  " 税込金額計算用

*** 定数
constants: c_flg_on(1)     type c value 'X',
c_sokuho(10)    type c value '検収明細書',
c_kakuho(10)    type c value '支払通知書',
*** 2012/01/24 MOD START ***
c_mark(1)       type c value 'Y'.           "支払通知発行対象
*** 2012/01/24 MOD END ***

*&---------------------------------------------------------------------*
*&   画面項目定義
*&---------------------------------------------------------------------*
*-- 速報/確報区分
selection-screen begin of block bk1 with frame title text-s01.
selection-screen begin of line.
*-- 速報（検収明細書）
parameters: r_sokuho radiobutton group ra01 default 'X'.
selection-screen comment 04(18) text-s02.
*-- 確報（支払通知書）
parameters: r_kakuho radiobutton group ra01.
selection-screen comment 26(18) text-s03.
selection-screen end of line.
selection-screen end of block bk1.

*-- データ選択
selection-screen begin of block bk2 with frame title text-s04.
*-- 会社コード
parameters: p_bukrs    like t001-bukrs obligatory memory id buk,
*-- 購買組織
p_ekorg    like lfm1-ekorg obligatory memory id eko,
*-- 出力年月
p_years(6) type n,
*-- 出力締日
p_cdate(2) type n          obligatory.
*-- 仕入先コード(請求先)
select-options s_lifnr for lfb1-lifnr.
selection-screen end of block bk2.

*-- 出力オプション
selection-screen begin of block bk3 with frame title text-s05.
*-- ディレクトリ名
parameters: p_dname like rlgrap-filename obligatory,
*-- ファイル名
p_fname like rlgrap-filename obligatory,
*-- 起動用ファイル名
p_sname like rlgrap-filename obligatory.
selection-screen end of block bk3.

skip 1.

*-- 取引先機能
parameters: p_parvw like wyt3-parvw obligatory.

************************************************************************
initialization.
************************************************************************

************************************************************************
at selection-screen on value-request for p_dname.
************************************************************************
*-- ディレクトリ名の検索ヘルプ
perform f_f4help_p_dname.

************************************************************************
at selection-screen.
************************************************************************
*-- 選択画面処理
perform f_selection_screen_proc.

************************************************************************
start-of-selection.
************************************************************************
perform f_init_sec.                       " 初期処理
perform f_main_sec.                       " メイン処理

************************************************************************
end-of-selection.
************************************************************************

*&---------------------------------------------------------------------*
*&      Form F_F4HELP_P_DNAME
*&---------------------------------------------------------------------*
*       ディレクトリ名のヘルプ出力
*----------------------------------------------------------------------*
form f_f4help_p_dname.

data: l_path          like dxfields-longpath,
l_abend_flg     like dxfields-abendflag,
l_stripped_name like rlgrap-filename.

*-- ファイルパスの取得
call function 'F4_DXFILENAME_TOPRECURSION'
exporting
i_location_flag = 'A'
i_server        = ''
i_path          = ''
filemask        = '*.*'
fileoperation   = 'R'
importing
o_path          = l_path
abend_flag      = l_abend_flg
exceptions
others          = 0.

if l_abend_flg <> c_flg_on.
p_dname = l_path.
*-- ディレクトリ名とファイル名の分割
call function 'SO_SPLIT_FILE_AND_PATH'
exporting
full_name     = p_dname
importing
stripped_name = l_stripped_name
file_path     = p_dname
exceptions
others        = 0.
endif.

endform.                    " F_F4HELP_P_DNAME
*&---------------------------------------------------------------------*
*&      Form  F_SELECTION_SCREEN_PROC
*&---------------------------------------------------------------------*
*       選択画面処理
*----------------------------------------------------------------------*
form f_selection_screen_proc.

*-- 会社コードと購買組織の存在チェック
perform f_check_p_bukrs_and_p_ekorg.

*-- 出力締日チェック
perform f_check_p_cdate.

*-- 出力年月初期値設定
if p_years is initial.
perform f_set_p_years.
endif.

*-- 出力年月チェック
perform f_check_p_years.

*-- 照合締日の取得
perform f_get_zfbdt.

*-- ファイル出力チェック
perform f_check_output_file.

endform.                    " F_SELECTION_SCREEN_PROC
*&---------------------------------------------------------------------
*&      Form  F_CHECK_P_BUKRS_AND_P_EKORG
*&---------------------------------------------------------------------
*       会社コードと購買組織の存在チェック
*----------------------------------------------------------------------
form f_check_p_bukrs_and_p_ekorg.

data: l_ekorg like t024e-ekorg.

select single ekorg             " 購買組織
from t024e
into l_ekorg
where ekorg = p_ekorg          " 購買組織
and bukrs = p_bukrs.         " 会社コード

if sy-subrc <> 0.
*-- 対象データがありません
message e762.
endif.

endform.                    " F_CHECK_P_BUKRS_AND_P_EKORG
*&---------------------------------------------------------------------
*&      Form  F_CHECK_P_CDATE
*&---------------------------------------------------------------------
*       出力締日チェック
*----------------------------------------------------------------------
form f_check_p_cdate.

if not (  p_cdate =  5
or p_cdate = 10
or p_cdate = 15
or p_cdate = 20
or p_cdate = 25
or p_cdate = 31 ).
*-- 入力された締日が、五十日、末日ではありません
message e913.
endif.

endform.                    " F_CHECK_P_CDATE
*&---------------------------------------------------------------------
*&      Form  F_SET_P_YEARS
*&---------------------------------------------------------------------
*       出力年月初期値設定
*----------------------------------------------------------------------
form f_set_p_years.

data: l_endda like pskey-endda.

if p_cdate =  5
or p_cdate = 10
or p_cdate = 15
or p_cdate = 20
or p_cdate = 25.

*-- システム日付の先頭６桁を設定
p_years = sy-datum(6).

else.

*-- システム日付の前月を取得する
call function 'HRWPC_BL_DATES_MONTH_INTERVAL'
exporting
datum          = sy-datum
month_pst      = 1
month_ftr      = -1
importing
endda          = l_endda
exceptions
others         = 0.

*-- システム日付の前月の先頭６桁を設定
p_years = l_endda(6).

endif.

endform.                    " F_SET_P_YEARS
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_P_YEARS
*&---------------------------------------------------------------------*
*       出力年月チェック
*----------------------------------------------------------------------*
form f_check_p_years.

if p_years+4(2) < 01
or p_years+4(2) > 12.
*-- 入力された出力年月が不正です。
message e914.
endif.

endform.                    " F_CHECK_P_YEARS
*&---------------------------------------------------------------------*
*&      Form  F_GET_ZFBDT
*&---------------------------------------------------------------------*
*       照合締日の算出
*----------------------------------------------------------------------*
form f_get_zfbdt.

clear: g_zfbdt.

if p_cdate =  5
or p_cdate = 10
or p_cdate = 15
or p_cdate = 20
or p_cdate = 25.

*-- 出力年月(YYYYMM)＋出力締日(DD)
concatenate p_years
p_cdate
into g_zfbdt.

else.

*-- 出力年月(YYYYMM)＋[01]
concatenate p_years
'01'
into g_zfbdt.

*-- 月末日へ変換
call function 'LAST_DAY_OF_MONTHS'
exporting
day_in                  = g_zfbdt
importing
last_day_of_month       = g_zfbdt
exceptions
others                  = 0.

endif.

endform.                    " F_GET_ZFBDT
*&---------------------------------------------------------------------*
*&      Form  F_CHECK_OUTPUT_FILE
*&---------------------------------------------------------------------*
*       ファイル出力チェック
*----------------------------------------------------------------------*
form f_check_output_file.

data: l_directory like btch0000-text80,
l_filename  like btch0000-text80.

*-- ファイル名の重複チェック
if p_fname = p_sname.
*-- 出力ファイル名と起動用ファイル名が重複しています
message e922.
endif.

*-- 起動用ファイルの存在チェック
l_directory = p_dname.                        " ディレクトリ名
l_filename  = p_sname.                        " 起動用ファイル名

call function 'PFL_CHECK_DIRECTORY'
exporting
directory                         = l_directory
filname                           = l_filename
exceptions
pfl_dir_not_exist                 = 1
pfl_permission_denied             = 2
pfl_cant_build_dataset_name       = 3
pfl_file_not_exist                = 4
others                            = 5.

if sy-subrc = 0.
*-- 起動用ファイルが存在しています
message e923.
endif.

endform.                    " F_CHECK_OUTPUT_FILE
*&---------------------------------------------------------------------*
*&      Form  F_INIT_SEC
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
form f_init_sec.

*-- 変数の初期化
clear: w_lfm1,
w_t052,
w_yk230,
w_lfx1,
w_adrc,
w_t001w,
w_data,
rc_code_lock,
g_cnt_upd,
g_cnt_out,
g_cnt_err,
g_cnt_seq,
g_sum_total,
g_sum_taxam,
g_sum_itxam,
g_sum_etxam.

refresh: i_lfm1,
i_t052,
i_yk230,
i_lfx1,
i_adrc,
i_t001w,
i_data.

endform.                    " F_INIT_SEC
*&---------------------------------------------------------------------*
*&      Form  F_MAIN_SEC
*&---------------------------------------------------------------------*
*       メイン処理
*----------------------------------------------------------------------*
form f_main_sec.

*-- 対象仕入先取得
perform f_get_target_supplier.
*-- テーブルロック設定(出力時)
perform f_set_table_lock.
*-- 出力対象データの取得
perform f_get_output_data.
*-- 補足情報取得
perform f_get_supplement_data.
*-- ファイル編集処理
perform f_edit_file_data.
*-- ファイル出力
perform f_output_file.
*-- テーブルロック解除
perform f_release_table_lock.
*-- コミット処理
commit work.
*-- 出力ログ表示
perform f_display_output_log.

endform.                    " F_MAIN_SEC
*&---------------------------------------------------------------------*
*&      Form  F_GET_TARGET_SUPPLIER
*&---------------------------------------------------------------------*
*       対象仕入先取得
*----------------------------------------------------------------------*
form f_get_target_supplier.

*-- 対象の仕入先コード取得
perform f_select_lfm1.

*-- 購買データの支払条件を一括取得
perform f_select_t052.

*-- 仕入先データ絞込み
perform f_refine_lfm1.

endform.                    " F_GET_TARGET_SUPPLIER
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_LFM1
*&---------------------------------------------------------------------*
*       対象の仕入先コード取得
*----------------------------------------------------------------------*
form f_select_lfm1.

refresh: i_lfm1.
*-- 仕入先コード取得
select lifnr                         " 仕入先コード
zterm                         " 支払条件キー
waers                         " 通貨コード
from lfm1
into corresponding fields of table i_lfm1
where lifnr in s_lifnr              " 仕入先コード
and ekorg =  p_ekorg.             " 購買組織

endform.                    " F_SELECT_LFM1
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_T052
*&---------------------------------------------------------------------*
*       購買データの支払条件を一括取得
*----------------------------------------------------------------------*
form f_select_t052.

data: li_lfm1 like i_lfm1.

*-- 支払条件キーをユニークにする
li_lfm1 = i_lfm1.
sort li_lfm1 ascending by zterm.          " 仕入先コード
delete adjacent  duplicates from li_lfm1
comparing zterm.

check not li_lfm1[] is initial.

refresh: i_t052.
*-- 支払条件取得
select zterm                              " 支払条件キー
ztagg                              " 期限
from t052
into corresponding fields of table i_t052
for all entries in li_lfm1
where zterm = li_lfm1-zterm.             " 支払条件キー

*-- 期日を若番1つに絞り込む
delete adjacent  duplicates from i_t052
comparing zterm.                   " 支払条件キー

endform.                    " F_SELECT_T052
*&---------------------------------------------------------------------*
*&      Form  F_REFINE_LFM1
*&---------------------------------------------------------------------*
*       仕入先データ絞込み
*----------------------------------------------------------------------*
form f_refine_lfm1.

data: l_name   type thead-tdname,
lw_tline type tline,
li_tline like standard table of lw_tline.

loop at i_lfm1 into w_lfm1.

*-- 支払条件の読込み
clear: w_t052.
read table i_t052 into w_t052
with key zterm = w_lfm1-zterm   " 支払条件キー
binary search.

*-- 締日<>期日の場合、処理対象外とする
if w_t052-ztagg <> p_cdate.
delete i_lfm1.
continue.
endif.

*-- READ_TEXT用NAMEの作成 (仕入先コード＋会社コード)
clear: l_name.
concatenate w_lfm1-lifnr                " 仕入先コード
p_bukrs                     " 会社コード
into l_name.

*-- 仕入先マスタテキストの読込み
refresh: li_tline.
call function 'READ_TEXT'
exporting
client                        = sy-mandt
id                            = 'YN01'
language                      = sy-langu
name                          = l_name
object                        = 'LFB1'
tables
lines                         = li_tline
exceptions
others                        = 0.

*-- 「Y」以外の場合、処理対象外とする
read table li_tline into lw_tline
*** 2012/01/24 MOD START ***
*                        WITH KEY TDLINE = 'Y'.
with key tdline = c_mark.
*** 2012/01/24 MOD END ***
if sy-subrc <> 0.
delete i_lfm1.
continue.
endif.

endloop.

*-- 該当仕入先が0件の場合、メッセージを出力して終了
if i_lfm1[] is initial.
message s915 with p_cdate.
leave list-processing.
endif.

free: i_t052.

endform.                    " F_REFINE_LFM1
*&---------------------------------------------------------------------*
*&      Form  F_SET_TABLE_LOCK
*&---------------------------------------------------------------------*
*       テーブルロック設定
*----------------------------------------------------------------------*
form f_set_table_lock.

data: l_user type sy-msgv1.

*-- 仕入れデータ(YK230)ロック
perform f_table_lock_yk230.

l_user = sy-msgv1.
if rc_code_lock <> 0.
*-- エラーメッセージ出力
message i756 with text-m01 l_user.
leave list-processing.
endif.

endform.                    " F_SET_TABLE_LOCK
*&---------------------------------------------------------------------*
*&      Form  TABLE_LOCK_YK230
*&---------------------------------------------------------------------*
*       自社/外部データロック処理
*----------------------------------------------------------------------*
form f_table_lock_yk230.

call function 'ENQUEUE_EY_YK230'
exporting
mode_yk230           = 'E'
mandt                = sy-mandt
exceptions
foreign_lock         = 1
system_failure       = 2
others               = 3.

if sy-subrc <> 0.
rc_code_lock = '1'.
exit.
endif.

endform.                    " F_TABLE_LOCK_YK230
*&---------------------------------------------------------------------*
*&      Form  F_GET_OUTPUT_DATA
*&---------------------------------------------------------------------*
*       出力対象データの取得
*----------------------------------------------------------------------*
form f_get_output_data.

if r_sokuho = c_flg_on.              " 速報（検収明細書）
perform f_select_yk230_s.
else.                                " 確報（支払通知書）
perform f_select_yk230_k.
endif.

*-- 出力仕入先が0件の場合、メッセージを出力して終了
if i_yk230[] is initial.
message s915 with p_cdate.
leave list-processing.
endif.

endform.                    " F_GET_OUTPUT_DATA
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_YK230_S
*&---------------------------------------------------------------------*
*       速報（検収明細書）の出力対象データ取得
*----------------------------------------------------------------------*
form f_select_yk230_s.

check not i_lfm1[] is initial.

refresh: i_yk230[].

select belnr
buzei
lifnr                         " 仕入先または債権者の勘定コード
werkst                        " 取引プラント
ebeln                         " 購買伝票番号
ebelp                         " 購買伝票の明細番号
maktx                         " 品目テキスト
matnr                         " 品目コード
budat                         " 伝票の転記日付
knquan                        " 数量
knuntprc                      " 単価
knitxamt                      " 税抜金額
kntaxamt                      " 消費税額
knetxamt                      " 税込金額
from yk230
into corresponding fields of table i_yk230
for all entries in i_lfm1
where lifnr      = i_lfm1-lifnr     " 仕入先
and ekorg      = p_ekorg          " 購買組織
and bukrs      = p_bukrs          " 会社コード
*** 2012/01/25 MOD START ***
*     and zfbdt     <= g_zfbdt          " 締日
and zfbdt      = g_zfbdt          " 締日
and KEKKBN     NE '5'.            " 照合結果区分 部分照合以外
*     and (  zfbdt2  = '00000000'       " 照合締日
*         or zfbdt2  = g_zfbdt ).       " 照合締日
*** 2012/01/25 MOD END ***

endform.                    " F_SELECT_YK230_S
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_YK230_K
*&---------------------------------------------------------------------*
*       確報（支払通知書）の出力対象データ取得
*----------------------------------------------------------------------*
form f_select_yk230_k.

check not i_lfm1[] is initial.

refresh: i_yk230[].

select lifnr                         " 仕入先または債権者の勘定コード
werkst                        " 取引プラント
ebeln                         " 購買伝票番号
ebelp                         " 購買伝票の明細番号
maktx                         " 品目テキスト
matnr                         " 品目コード
budat                         " 伝票の転記日付
knquan                        " 数量
knuntprc                      " 単価
knitxamt                      " 税抜金額
kntaxamt                      " 消費税額
knetxamt                      " 税込金額
from yk230
into corresponding fields of table i_yk230
for all entries in i_lfm1
where lifnr  = i_lfm1-lifnr         " 仕入先
and ekorg  = p_ekorg              " 購買組織
and bukrs  = p_bukrs              " 会社コード
*** 2012/01/25 INSERT START ***
and KEKKBN NE '5'                 " 照合結果区分　部分照合以外
*** 2012/01/25 INSERT END ***
and zfbdt2 = g_zfbdt.             " 照合締日

endform.                    " F_SELECT_YK230_K
*&---------------------------------------------------------------------*
*&      Form  F_GET_SUPPLEMENT_DATA
*&---------------------------------------------------------------------*
*       補足情報取得
*----------------------------------------------------------------------*
form f_get_supplement_data.

*-- 仕入先マスタの一括取得
perform f_select_lfa1_lfb1.

*-- アドレス情報の一括取得
perform f_select_adrc.

*-- プラントの一括取得
perform f_select_t001w.

endform.                    " F_GET_SUPPLEMENT_DATA
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_LFA1_LFB1
*&---------------------------------------------------------------------*
*       仕入先マスタの一括取得
*----------------------------------------------------------------------*
form f_select_lfa1_lfb1.

check not i_lfm1[] is initial.

refresh: i_lfx1.

select lfb1~lifnr                    " 仕入先コード
lfa1~pstlz                    " 仕入先郵便番号
lfa1~adrnr                    " 住所
lfb1~tlfxs                    " ファックス番号
from lfa1 inner join lfb1
on lfa1~lifnr = lfb1~lifnr
into corresponding fields of table i_lfx1
for all entries in i_lfm1
where lfb1~bukrs = p_bukrs          " 会社コード
and lfb1~lifnr = i_lfm1-lifnr.    " 仕入先コード

endform.                    " F_SELECT_LFA1_LFB1
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_ADRC
*&---------------------------------------------------------------------*
*       アドレス情報の一括取得
*----------------------------------------------------------------------*
form f_select_adrc.

check not i_lfx1[] is initial.

refresh: i_adrc.

select adrc~addrnumber                    " アドレス番号
adrc~name2                         " 名前 2
adrc~city1                         " 市区町村
adrc~street                        " 都道府県名
t005u~bezei                        " 地域 (都道府県）
from adrc inner join t005u
on adrc~region = t005u~bland
into corresponding fields of table i_adrc
for all entries in i_lfx1
where addrnumber = i_lfx1-adrnr          " 住所
and spras      = 'JA'                  " 言語
and land1      = 'JP'.                 " 国

endform.                    " F_SELECT_ADRC
*&---------------------------------------------------------------------*
*&      Form  F_SELECT_T001W
*&---------------------------------------------------------------------*
*       プラントの一括取得
*----------------------------------------------------------------------*
form f_select_t001w.

check not i_yk230[] is initial.

refresh: i_t001w.

select werks                         " プラント
name1                         " 名称
from t001w
into corresponding fields of table i_t001w
for all entries in i_yk230
where werks = i_yk230-werkst.        " プラント

endform.                    " F_SELECT_T001W
*&---------------------------------------------------------------------*
*&      Form  F_EDIT_FILE_DATA
*&---------------------------------------------------------------------*
*       ファイル編集処理
*----------------------------------------------------------------------*
form f_edit_file_data.

data: l_flg_break_lifnr type xfeld,
l_flg_break_werks type xfeld.

*-- ソート(仕入先コード/プラント/入庫日/注文番号/明細)
sort i_yk230 ascending by lifnr
werkst
budat
ebeln
ebelp.

clear: g_cnt_seq.

loop at i_yk230 into w_yk230.

at new lifnr.
l_flg_break_lifnr = c_flg_on.
endat.

if l_flg_break_lifnr = c_flg_on.
clear: l_flg_break_lifnr,
g_cnt_seq,
g_sum_total.
*-- ヘッダデータ(仕入先)の編集
perform f_edit_header_data_lifnr.
endif.

at new werkst.
l_flg_break_werks = c_flg_on.
endat.

if l_flg_break_werks = c_flg_on.
clear: l_flg_break_werks,
g_sum_taxam,
g_sum_itxam,
g_sum_etxam.
*-- ヘッダデータ(プラント)の編集
perform f_edit_header_data_werks.
endif.

*-- 明細データの編集
perform f_edit_detail_data.

*-- その他個別編集
perform f_edit_others.

append w_data to i_data.

at end of werkst.
l_flg_break_werks = c_flg_on.
endat.

if l_flg_break_werks = c_flg_on.
clear: l_flg_break_werks.
*-- プラント金額の更新
perform f_modify_werks_wrbtr.
endif.

at end of lifnr.
l_flg_break_lifnr = c_flg_on.
endat.

if l_flg_break_lifnr = c_flg_on.
clear: l_flg_break_lifnr.
*-- 総額の更新
perform f_modify_total_wrbtr.
endif.

endloop.

free: i_lfm1[],
i_lfx1[],
i_adrc[],
i_t001w[].

endform.                    " F_EDIT_FILE_DATA
*&---------------------------------------------------------------------*
*&      Form  F_CURRENCY_CONV_TO_EXTERNAL
*&---------------------------------------------------------------------*
*       内部⇒外部書式への変換
*----------------------------------------------------------------------*
*      -->AI_WEARS  通貨コード
*      -->AI_WRBTR  内部書式金額
*      <--AO_WRBTR  外部書式金額
*----------------------------------------------------------------------*
form f_currency_conv_to_external using value(ai_waers) type any
value(ai_wrbtr) type any
changing value(ao_wrbtr) type any.

data: l_wrbtr_e type bapicurr-bapicurr,
l_wrbtr_r type p decimals 2.

call function 'BAPI_CURRENCY_CONV_TO_EXTERNAL'
exporting
currency              = ai_waers
amount_internal       = ai_wrbtr
importing
amount_external       = l_wrbtr_e.

*-- 小数２桁に変換
call function 'ROUND'
exporting
decimals            = 2
input               = l_wrbtr_e
sign                = 'X'
importing
output              = l_wrbtr_r
exceptions
others              = 0.

ao_wrbtr = l_wrbtr_r.

endform.                    " F_CURRENCY_CONV_TO_EXTERNAL
*&---------------------------------------------------------------------*
*&      Form  F_EDIT_HEADER_DATA_LIFNR
*&---------------------------------------------------------------------*
*       ヘッダデータ(仕入先)の編集
*----------------------------------------------------------------------*
form f_edit_header_data_lifnr.

data: l_count_line type i.
*** 2012/01/24 DEL START ***
*        L_WRBTR      LIKE ZN002-PWRBTR.
*** 2012/01/24 DEL END ***

clear: l_count_line,
*** 2012/01/24 DEL START ***
*         L_WRBTR,
*** 2012/01/24 DEL END ***
w_data,
w_lfx1,
w_adrc,
w_lfm1.

*-- 補足情報の読込み
read table i_lfx1 into w_lfx1
with table key lifnr = w_yk230-lifnr. " 仕入先コード
read table i_adrc into w_adrc
with key addrnumber  = w_lfx1-adrnr   " 住所
binary search.
read table i_lfm1 into w_lfm1
with key lifnr       = w_yk230-lifnr. " 仕入先コード

*-- 計上年月
concatenate p_years+0(4)
'/'
p_years+4(2)
into w_data-years.
*-- 帳票名称
if r_sokuho = c_flg_on.
w_data-tname = c_sokuho.
else.
w_data-tname = c_kakuho.
endif.
*-- 仕入先コード
w_data-lifnr = w_lfx1-lifnr.
*-- 発行日
perform f_conv_exit_pdate_output using sy-datum
changing w_data-odate.
*-- 仕入先名
*  w_data-name2 = w_adrc-name2.
concatenate w_adrc-name2 space into w_data-name2.
*-- 仕入先郵便番号
w_data-pstlz = w_lfx1-pstlz.
*-- 地域
w_data-bezei = w_adrc-bezei.
*-- 都道府県
w_data-stree = w_adrc-street.
*-- 市区町村
w_data-city1 = w_adrc-city1.
*-- ファックス番号
w_data-telfx = w_lfx1-tlfxs.
*-- 通貨コード
w_data-waers = w_lfm1-waers.

endform.                    " F_EDIT_HEADER_DATA_LIFNR
*&---------------------------------------------------------------------*
*&      Form  F_CLOI_PUT_SIGN_IN_FRONT
*&---------------------------------------------------------------------*
*       金額符号の前置換
*----------------------------------------------------------------------*
*      -->AI_WRBTR  符号後付金額
*      <--AO_WRBTR  符号前付金額
*----------------------------------------------------------------------*
form f_cloi_put_sign_in_front using value(ai_wrbtr) type any
changing value(ao_wrbtr) type any.

call function 'CLOI_PUT_SIGN_IN_FRONT'
changing
value         =  ai_wrbtr.

ao_wrbtr = ai_wrbtr.

endform.                    " F_CLOI_PUT_SIGN_IN_FRONT
*&---------------------------------------------------------------------*
*&      Form  F_CONV_EXIT_PDATE_OUTPUT
*&---------------------------------------------------------------------*
*       日付書式の変換（内部⇒外部）
*----------------------------------------------------------------------*
*      -->AI_DATE  内部書式日付
*      <--AO_DATE  外部書式日付
*----------------------------------------------------------------------*
form f_conv_exit_pdate_output using value(ai_date) type any
changing value(ao_date) type any.

data: l_date(10) type c.

check not ai_date = space.

call function 'CONVERSION_EXIT_PDATE_OUTPUT'
exporting
input  = ai_date
importing
output = l_date.

ao_date = l_date.

endform.                    " F_CONV_EXIT_PDATE_OUTPUT
*&---------------------------------------------------------------------*
*&      Form  F_EDIT_HEADER_DATA_WERKS
*&---------------------------------------------------------------------*
*       ヘッダデータ(プラント)の編集
*----------------------------------------------------------------------*
form f_edit_header_data_werks.

*-- 補足情報の読込み
read table i_t001w into w_t001w
with key werks = w_yk230-werkst. " プラントコード
*-- プラントコード
w_data-dvson = w_yk230-werkst.
*-- プラント名
w_data-name1 = w_t001w-name1.

endform.                    " F_EDIT_HEADER_DATA_WERKS
*&---------------------------------------------------------------------*
*&      Form  F_EDIT_DETAIL_DATA
*&---------------------------------------------------------------------*
*       明細データの編集
*----------------------------------------------------------------------*
form f_edit_detail_data.

data: l_knuntprc type p decimals 4,    " 単価(小数４桁)
l_knquan   type p decimals 2,    " 数量(小数２桁)
*** 2012/01/24 INSERT START ***
l_ebelp    type char4.           " 作業用の発注明細番号の定義

clear l_ebelp.
*** 2012/01/24 INSERT END ***

*-- 入庫日
perform f_conv_exit_pdate_output using w_yk230-budat
changing w_data-ldate.
*-- 注文番号
*** 2012/01/24 INSERT START ***
*** W_YK230-EBELPの前０を除去する。
call function 'CONVERSION_EXIT_ALPHA_OUTPUT'
exporting
input         = w_yk230-ebelp+0(4)
importing
output        = l_ebelp
.
*** 2012/01/24 INSERT END ***

concatenate w_yk230-werkst+1(2)
'-'
w_yk230-ebeln
'-'
*** 2012/01/24 MOD START ***
*              W_YK230-EBELP
l_ebelp
*** 2012/01/24 MOD END ***
into w_data-list2.
*-- 品目コード
w_data-list5 = w_yk230-matnr.
*-- 品名
w_data-list6 = w_yk230-maktx.
*-- 単価
w_data-knunt = l_knuntprc = w_yk230-knuntprc.
perform f_cloi_put_sign_in_front using w_data-knunt
changing w_data-knunt.
*-- 数量
w_data-knqua = l_knquan   = w_yk230-knquan.
perform f_cloi_put_sign_in_front using w_data-knqua
changing w_data-knqua.
*-- 税抜金額
perform f_currency_conv_to_external using w_lfm1-waers
w_yk230-knitxamt
changing w_data-knitx.
perform f_cloi_put_sign_in_front using w_data-knitx
changing w_data-knitx.
*-- 税額
perform f_currency_conv_to_external using w_lfm1-waers
w_yk230-kntaxamt
changing w_data-kntax.
perform f_cloi_put_sign_in_front using w_data-kntax
changing w_data-kntax.
*-- 税込金額
perform f_currency_conv_to_external using w_lfm1-waers
w_yk230-knetxamt
changing w_data-knetx.
perform f_cloi_put_sign_in_front using w_data-knetx
changing w_data-knetx.

endform.                    " F_EDIT_DETAIL_DATA
*&---------------------------------------------------------------------*
*&      Form  F_EDIT_OTHERS
*&---------------------------------------------------------------------*
*       その他個別編集(金額計算)
*----------------------------------------------------------------------*
form f_edit_others.

*-- SEQ(ヘッダ)
g_cnt_seq    = g_cnt_seq + 1.
w_data-seqno = g_cnt_seq.

*-- 総額計算
g_sum_total = g_sum_total + w_yk230-knetxamt.
*-- 消費税額計算
g_sum_taxam = g_sum_taxam + w_yk230-kntaxamt.
*-- 税抜金額計算
g_sum_itxam = g_sum_itxam + w_yk230-knitxamt.
*-- 税込金額計算
g_sum_etxam = g_sum_etxam + w_yk230-knetxamt.

endform.                    " F_EDIT_OTHERS
*&---------------------------------------------------------------------*
*&      Form  F_MODIFY_WERKS_WRBTR
*&---------------------------------------------------------------------*
*       プラント金額の更新
*----------------------------------------------------------------------*
form f_modify_werks_wrbtr.

*-- プラント税抜金額
perform f_currency_conv_to_external using w_lfm1-waers
g_sum_itxam
changing w_data-itxam.
perform f_cloi_put_sign_in_front using w_data-itxam
changing w_data-itxam.

*-- プラント消費税額
perform f_currency_conv_to_external using w_lfm1-waers
g_sum_taxam
changing w_data-taxam.
perform f_cloi_put_sign_in_front using w_data-taxam
changing w_data-taxam.

*-- プラント税込金額
perform f_currency_conv_to_external using w_lfm1-waers
g_sum_etxam
changing w_data-etxam.
perform f_cloi_put_sign_in_front using w_data-etxam
changing w_data-etxam.

modify i_data from w_data
transporting taxam itxam etxam
where lifnr = w_yk230-lifnr
and dvson = w_yk230-werkst.

endform.                    " F_MODIFY_WERKS_WRBTR
*&---------------------------------------------------------------------*
*&      Form  F_MODIFY_TOTAL_WRBTR
*&---------------------------------------------------------------------*
*       総額の更新
*----------------------------------------------------------------------*
form f_modify_total_wrbtr.

*-- 総額
perform f_currency_conv_to_external using w_lfm1-waers
g_sum_total
changing w_data-total.
perform f_cloi_put_sign_in_front using w_data-total
changing w_data-total.

modify i_data from w_data transporting total
where lifnr = w_yk230-lifnr.

endform.                    " F_MODIFY_TOTAL_WRBTR
*&---------------------------------------------------------------------*
*&      Form  F_OUTPUT_FILE
*&---------------------------------------------------------------------*
*       ファイル出力
*----------------------------------------------------------------------*
form f_output_file.

*-- IFファイル出力
perform f_output_file_i.

*-- 起動用ファイル出力
perform f_output_file_s.

endform.                    " F_OUTPUT_FILE
*&---------------------------------------------------------------------*
*&      Form  F_OUTPUT_FILE_I
*&---------------------------------------------------------------------*
*       IFファイル出力
*----------------------------------------------------------------------*
form f_output_file_i.

data: l_fname type rlgrap-filename,
l_data  type string.

concatenate p_dname
p_fname
into l_fname.

open dataset l_fname for output in text mode.
if sy-subrc <> 0.
rollback work.
*-- ファイルオープンエラー
message i766 with text-m02.
leave list-processing.
endif.

loop at i_data into w_data.
*-- カンマ区切りファイル出力データ作成
concatenate w_data-years                " 計上年月
w_data-tname                " 帳票名称
w_data-lifnr                " 仕入先コード
w_data-seqno                " SEQ
w_data-odate                " 発行日
w_data-name2                " 仕入先名
w_data-pstlz                " 仕入先郵便番号
w_data-bezei                " 地域
w_data-stree                " 都道府県
w_data-city1                " 市区町村
w_data-telfx                " ファックス番号
w_data-total                " 総額
w_data-waers                " 通貨コード
w_data-zlsc1                " 金種1-文言
w_data-wrbt1                " 金種1-金額
w_data-zfbd1                " 金種1-期日
w_data-zlsc2                " 金種2-文言
w_data-wrbt2                " 金種2-金額
w_data-zfbd2                " 金種2-期日
w_data-zlsc3                " 金種3-文言
w_data-wrbt3                " 金種3-金額
w_data-zfbd3                " 金種3-期日
w_data-zlsc4                " 金種4-文言
w_data-wrbt4                " 金種4-金額
w_data-zfbd4                " 金種4-期日
w_data-dvson                " プラントコード
w_data-name1                " プラント名
w_data-itxam                " 税抜金額
w_data-taxam                " 消費税額
w_data-etxam                " 税込金額
w_data-ldate                " 入庫日
w_data-list2                " 注文番号
w_data-list5                " 品目コード
w_data-list6                " 品名
w_data-knunt                " 単価
w_data-knqua                " 数量
w_data-knitx                " 税抜金額
w_data-kntax                " 税額
w_data-knetx                " 税込金額
into l_data
separated by '","'.
concatenate '"'
l_data
'"'
into l_data.
transfer l_data to l_fname.
if sy-subrc <> 0.
rollback work.
*-- ファイル出力エラー
message i789 with text-m02.
leave list-processing.
endif.
*-- 出力件数カウント
g_cnt_out = g_cnt_out + 1.
endloop.

close dataset l_fname.
if sy-subrc <> 0.
rollback work.
*-- ファイル出力エラー
message i789 with text-m02.
leave list-processing.
endif.

free: i_data.

endform.                    " F_OUTPUT_FILE_I
*&---------------------------------------------------------------------*
*&      Form  F_OUTPUT_FILE_S
*&---------------------------------------------------------------------*
*       起動用ファイル出力
*----------------------------------------------------------------------*
form f_output_file_s.

data: l_fname type rlgrap-filename.

concatenate p_dname
p_sname
into l_fname.

open dataset l_fname for output.
if sy-subrc <> 0.
rollback work.
*-- ファイルオープンエラー
message i766 with text-m02.
leave list-processing.
endif.

endform.                    " F_OUTPUT_FILE_S
*&---------------------------------------------------------------------*
*&      Form  F_RELEASE_TABLE_LOCK
*&---------------------------------------------------------------------*
*       テーブルロック解除
*----------------------------------------------------------------------*
form f_release_table_lock.

*-- 自社/外部データ（仕入）ロック解除
perform f_table_unlock_yk230.

endform.                    " F_RELEASE_TABLE_LOCK_O
*&---------------------------------------------------------------------*
*&      Form  F_TABLE_UNLOCK_YK230
*&---------------------------------------------------------------------*
*       自社/外部データ（仕入）テーブルロック解除
*----------------------------------------------------------------------*
form f_table_unlock_yk230.

call function 'DEQUEUE_EY_YK230'
exporting
mode_yk230       = 'E'
mandt            = sy-mandt.

endform.                    " F_TABLE_UNLOCK_YK230
*&---------------------------------------------------------------------*
*&      Form  F_DISPLAY_OUTPUT_LOG
*&---------------------------------------------------------------------*
*       出力ログ表示
*----------------------------------------------------------------------*
form f_display_output_log.

data: l_line type i.

write: / text-l01.
uline.

if g_cnt_err > 0.
*-- 仕入先コード/エラー内容
write: 04(012) text-l02,
26(128) text-l03.
uline.
endif.

loop at tbl_errlog.
write:/04(012) tbl_errlog-lifnr,
26(128) tbl_errlog-err.
l_line = sy-tabix mod 36.
if l_line = 0 and sy-tabix >= 36.
new-page.
endif.
endloop.

if g_cnt_err > 0.
skip.
skip.
endif.
skip.

*-- 更新件数:  件
write: /04    text-l04,
29(8) g_cnt_upd,
text-l05.
*-- 出力件数:  件
write: /04    text-l06,
29(8) g_cnt_out,
text-l05.
*-- エラー件数:  件
write: /04    text-l07,
29(8) g_cnt_err,
text-l05.

if g_cnt_err > 0.
*-- エラーがあります。
message i759.
endif.

endform.                    " F_DISPLAY_OUTPUT_LOG
