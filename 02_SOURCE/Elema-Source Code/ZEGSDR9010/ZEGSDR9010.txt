*&---------------------------------------------------------------------*
*& プログラムID : ZEGSDR9010
*& 作成者       : iSiD Xiao
*& 作成日       : 2015/03/16
*& 処理概要     : Sales Orderの一括アップロードを行う。
*&---------------------------------------------------------------------*
*& 改定履歴
*& No   DATE       MODIFYED BY   SUMMARY
*& 1    2015/05/04 ISID18        BAPI変更
*& 2    2015/05/14 ISID18        OrderUnit書式変更
*& 3    2015/05/15 ISID18        通貨チェック変更
*　　　　　　　　　　　　　　　　ファイルレイアウトチェック変更
*& 4    2015/05/26 ISID18        数値チェック変更
*& 5    2015/05/27 ISID REN      小数部と通貨のチェック汎用化
*& 6    2015/06/05 ISID18        通貨コードとテキスト設定変更
*& 7    2015/06/18 ISID18        エラーファイル重複レコードバグ対応
*&                               エラーファイルにヘッダ行を追加
*& 8    2015/06/29 ISID18        ロングテキスト言語キー変更
*&---------------------------------------------------------------------*
**** start upd 2015/05/04 isid18 ****
*REPORT  zegsdr9010_test.
REPORT  ZEGSDR9010.
**** end upd 2015/05/04 isid18 ****

*&----------------------------------------------------------------------
* 定数の宣言
*&----------------------------------------------------------------------
CONSTANTS:
CNS_SLASH       TYPE C VALUE '\',          "File path split
CNS_RFILE(4)    TYPE C VALUE 'RST_',       "Result file
CNS_EFILE(4)    TYPE C VALUE 'ERR_',       "Error file
CNS_TAB         TYPE C VALUE CL_ABAP_CHAR_UTILITIES=>HORIZONTAL_TAB,
CNS_FTYPE(10)   TYPE C VALUE 'ASC',        "File type
CNS_TCD1(4)     TYPE C VALUE 'VA01',
CNS_TCD2(4)     TYPE C VALUE 'VA02',
CNS_PARNR_AG    TYPE PARVW  VALUE 'AG',    "取引先機能
CNS_PARNR_WE    TYPE PARVW  VALUE 'WE',    "取引先機能
CNS_PARNR_RE    TYPE PARVW  VALUE 'RE',    "取引先機能
CNS_PARNR_RG    TYPE PARVW  VALUE 'RG',    "取引先機能
CNS_PARNR_VE    TYPE PARVW  VALUE 'VE',    "取引先機能
CNS_PARNR_ZE    TYPE PARVW  VALUE 'ZE',    "取引先機能
CNS_PARNR_ZJ    TYPE PARVW  VALUE 'ZJ',    "取引先機能
CNS_PARNR_ZP    TYPE PARVW  VALUE 'ZP',    "取引先機能
CNS_POSNR_00    TYPE POSNR  VALUE '000000',"明細番号
CNS_TDID_0001   TYPE TDID   VALUE '0001',  "テキスト ID
CNS_TDID_0002   TYPE TDID   VALUE '0002',  "テキスト ID
CNS_TDID_Z010   TYPE TDID   VALUE 'Z010',  "テキスト ID
CNS_TDID_9001   TYPE TDID   VALUE '9001',  "テキスト ID
**** start add 2015/05/04 isid18 ****
CNS_TDID_Z910   TYPE TDID   VALUE 'Z910',  "テキスト ID
CNS_DATE_TYPE   TYPE CHAR1  VALUE '1',     "日付タイプ (日、週、月、期間)
CNS_VBTYP_C     TYPE VBTYP  VALUE 'C',
CNS_VBTYP_H     TYPE VBTYP  VALUE 'H',
CNS_VBTYP_K     TYPE VBTYP  VALUE 'K',
CNS_VBTYP_L     TYPE VBTYP  VALUE 'L',
CNS_AUART_CR    TYPE AUART  VALUE 'CR',
CNS_AUART_DR    TYPE AUART  VALUE 'DR',
CNS_AUART_ZCR   TYPE AUART  VALUE 'ZCR',
CNS_AUART_ZDR   TYPE AUART  VALUE 'ZDR',
**** end add 2015/05/04 isid18 ****
CNS_FORMAT      TYPE TDFORMAT VALUE '*',   "タグ列
CNS_SCHED       TYPE ETENR  VALUE '0001',  "納入日程行
CNS_HTYPE       TYPE DATATYPE_D VALUE 'NUMC',"Number type
CNS_UPDATE      TYPE CHAR1  VALUE 'U',     "更新区分
CNS_INSERT      TYPE CHAR1  VALUE 'I',     "更新区分
CNS_MSG_A       TYPE C VALUE 'A',            "Message type
CNS_MSG_S       TYPE C VALUE 'S',
CNS_MSG_W       TYPE C VALUE 'W',
CNS_MSG_E       TYPE C VALUE 'E'.

*&----------------------------------------------------------------------
* 型定義
*&----------------------------------------------------------------------
TYPES:
* File field for server file
BEGIN OF TYP_SFILE,
FIELD TYPE STRING,
END OF TYP_SFILE,
TYP_TD_SFILE TYPE STANDARD TABLE OF TYP_SFILE,

* File field for Local file
BEGIN OF TYP_FILE,
TCD        TYPE CHAR4,          "TCD
GFLAG(1)   TYPE C,              "GroupFlag
AUART      TYPE VBAK-AUART,     "DocType
VKORG      TYPE VBAK-VKORG,     "SalesOrg
VTWEG      TYPE VBAK-VTWEG,     "DistChannel
SPART      TYPE VBAK-SPART,     "Division
VKBUR      TYPE VBAK-VKBUR,     "SalesOffice
VKGRP      TYPE VBAK-VKGRP,     "SalesGrp
VBELN      TYPE VBAK-VBELN,     "SONo
BSTKD      TYPE VBKD-BSTKD,     "CustPurchNo
BSTDK      TYPE VBKD-BSTDK,     "CustPurchDate
AUDAT      TYPE VBAK-AUDAT,     "DocDate
PRSDT      TYPE VBKD-PRSDT,     "PriceDate
LIFSK      TYPE VBAK-LIFSK,     "ShipBlock
AUGRU      TYPE VBAK-AUGRU,     "OrderReason
WAERK      TYPE VBAK-WAERK,     "NetPriceCurrency
SUBMI      TYPE VBAK-SUBMI,     "CollectNo
**** start add 2015/05/04 isid18 ****
BNAME      TYPE VBAK-BNAME,     "OrderName
**** end add 2015/05/04 isid18 ****
SOLDTO     TYPE KUNNR,          "SoldTo
SHIPTO     TYPE KUNNR,          "ShipTo
SHIP_NAME  TYPE NAME1_GP,       "ShipToName1
SHIP_NAME2 TYPE NAME2_GP,       "ShipToName2
SHIP_NAME3 TYPE NAME3_GP,       "ShipToName3
COUNTR_ISO TYPE LAND1_ISO,      "ShipToCountryCode
POSTL_CODE TYPE PSTLZ,          "ShipToPostalCode
STREET     TYPE STRAS_GP,       "ShipToAddress1
CITY       TYPE ORT01_GP,       "ShipToAddress2
TELEPHONE  TYPE TELF1,          "ShipToTel
FAX_NUMBER TYPE TELFX,          "ShipToFax
BILLTO     TYPE KUNNR,          "BillTo
PAYER      TYPE KUNNR,          "Payer
SAEMP      TYPE KUNNR,          "SalesEmployee
EDUPRI     TYPE KUNNR,          "EndUserPrice
EDUEXP     TYPE KUNNR,          "EndUserExport
SAASSIS    TYPE KUNNR,          "SalesAssistant
**** start upd 2015/05/04 isid18 ****
*    langu_iso  TYPE laiso,          "TextLanguage
ZTERM      TYPE VBKD-ZTERM,     "PaymentTerms
**** end upd 2015/05/04 isid18 ****
INBREM     TYPE TDLINE,         "TextHdrInboundRemarks
TABREM     TYPE TDLINE,         "TextHdrDNRemarks
SOREM      TYPE TDLINE,         "TextHdrSORemarks
**** start upd 2015/05/04 isid18 ****
*    itm_number TYPE posnr_va,       "Item
ITM_NUMBER TYPE CHAR6,          "Item
PSTYV      TYPE VBAP-PSTYV,     "Item category
**** end upd 2015/05/04 isid18 ****
MATERIAL   TYPE MATNR,          "Material
SHORT_TEXT TYPE ARKTX,          "MaterialText
PLANT      TYPE WERKS_D,        "Plant
STORE_LOC  TYPE LGORT_D,        "SLoc
REQ_DATE   TYPE EDATU,          "DeliveryDate
REQ_QTY    TYPE CHAR17,         "SOQty
**** start upd 2015/05/04 isid18 ****
*    cond_unit  TYPE kmein,          "OrderUnit
COND_UNIT  TYPE CHAR3,          "OrderUnit
BSTKD_ITEM TYPE VBKD-BSTKD,     "CustomerPONoItm
BSTDK_ITEM TYPE VBKD-BSTDK,     "CustomerPODateItm
REASON_REJ TYPE ABGRU,          "RejectReason
**** end upd 2015/05/04 isid18 ****
COND_TYPE  TYPE KSCHA,          "CondType
COND_VALUE TYPE CHAR17,         "NetPrice
COND_P_UNT TYPE CHAR5,          "PriceUnit
ITEMREM    TYPE TDLINE,         "TextItmShipRemarks
**** start add 2015/05/04 isid18 ****
TRANSREM   TYPE TDLINE,         "TextItmTransportMeans
**** end add 2015/05/04 isid18 ****
END OF TYP_FILE,
TYP_TD_FILE TYPE STANDARD TABLE OF TYP_FILE,

**** START ADD 2015/06/18 ISID18 ****
BEGIN OF TYP_FILE_STR,
TCD        TYPE STRING,         "TCD
GFLAG      TYPE STRING,         "GroupFlag
AUART      TYPE STRING,         "DocType
VKORG      TYPE STRING,         "SalesOrg
VTWEG      TYPE STRING,         "DistChannel
SPART      TYPE STRING,         "Division
VKBUR      TYPE STRING,         "SalesOffice
VKGRP      TYPE STRING,         "SalesGrp
VBELN      TYPE STRING,         "SONo
BSTKD      TYPE STRING,         "CustPurchNo
BSTDK      TYPE STRING,         "CustPurchDate
AUDAT      TYPE STRING,         "DocDate
PRSDT      TYPE STRING,         "PriceDate
LIFSK      TYPE STRING,         "ShipBlock
AUGRU      TYPE STRING,         "OrderReason
WAERK      TYPE STRING,         "NetPriceCurrency
SUBMI      TYPE STRING,         "CollectNo
BNAME      TYPE STRING,         "OrderName
SOLDTO     TYPE STRING,         "SoldTo
SHIPTO     TYPE STRING,         "ShipTo
SHIP_NAME  TYPE STRING,         "ShipToName1
SHIP_NAME2 TYPE STRING,         "ShipToName2
SHIP_NAME3 TYPE STRING,         "ShipToName3
COUNTR_ISO TYPE STRING,         "ShipToCountryCode
POSTL_CODE TYPE STRING,         "ShipToPostalCode
STREET     TYPE STRING,         "ShipToAddress1
CITY       TYPE STRING,         "ShipToAddress2
TELEPHONE  TYPE STRING,         "ShipToTel
FAX_NUMBER TYPE STRING,         "ShipToFax
BILLTO     TYPE STRING,         "BillTo
PAYER      TYPE STRING,         "Payer
SAEMP      TYPE STRING,         "SalesEmployee
EDUPRI     TYPE STRING,         "EndUserPrice
EDUEXP     TYPE STRING,         "EndUserExport
SAASSIS    TYPE STRING,         "SalesAssistant
ZTERM      TYPE STRING,         "PaymentTerms
INBREM     TYPE STRING,         "TextHdrInboundRemarks
TABREM     TYPE STRING,         "TextHdrDNRemarks
SOREM      TYPE STRING,         "TextHdrSORemarks
ITM_NUMBER TYPE STRING,         "Item
PSTYV      TYPE STRING,         "Item category
MATERIAL   TYPE STRING,         "Material
SHORT_TEXT TYPE STRING,         "MaterialText
PLANT      TYPE STRING,         "Plant
STORE_LOC  TYPE STRING,         "SLoc
REQ_DATE   TYPE STRING,         "DeliveryDate
REQ_QTY    TYPE STRING,         "SOQty
COND_UNIT  TYPE STRING,         "OrderUnit
BSTKD_ITEM TYPE STRING,         "CustomerPONoItm
BSTDK_ITEM TYPE STRING,         "CustomerPODateItm
REASON_REJ TYPE STRING,         "RejectReason
COND_TYPE  TYPE STRING,         "CondType
COND_VALUE TYPE STRING,         "NetPrice
COND_P_UNT TYPE STRING,         "PriceUnit
ITEMREM    TYPE STRING,         "TextItmShipRemarks
TRANSREM   TYPE STRING,         "TextItmTransportMeans
END OF TYP_FILE_STR,
TYP_TD_FILE_STR TYPE STANDARD TABLE OF TYP_FILE_STR,
**** END ADD 2015/06/18 ISID18 ****

* Field for message
BEGIN OF TYP_MSG,
COL1 TYPE STRING,
COL2 TYPE STRING,
COL3 TYPE STRING,
**** start add 2015/05/04 isid18 ****
COL4 TYPE STRING,
**** end add 2015/05/04 isid18 ****
END OF TYP_MSG,
TYP_TD_MSG TYPE STANDARD TABLE OF TYP_MSG,

* File field for result file
BEGIN OF TYP_RFILE,
COL1 TYPE STRING,
COL2 TYPE STRING,
COL3 TYPE STRING,
**** start add 2015/05/04 isid18 ****
COL4 TYPE STRING,
**** end add 2015/05/04 isid18 ****
END OF TYP_RFILE,
TYP_TD_RFILE TYPE STANDARD TABLE OF TYP_RFILE,

* Type for BAPI parameter
TYP_TD_SOITEM         TYPE STANDARD TABLE OF BAPISDITM,
"Item Data
TYP_TD_SOITEMX        TYPE STANDARD TABLE OF BAPISDITMX,
"Item Data Checkbox
TYP_TD_PARNR          TYPE STANDARD TABLE OF BAPIPARNR,
"Document Partner
TYP_TD_PARNRC         TYPE STANDARD TABLE OF BAPIPARNRC,
"Document Partner Change
TYP_TD_PARNRAD        TYPE STANDARD TABLE OF BAPIADDR1,
"Document Partner Address
TYP_TD_SOSCHEDULE     TYPE STANDARD TABLE OF BAPISCHDL,
"Schedule Line Data
TYP_TD_SOSCHEDULEX    TYPE STANDARD TABLE OF BAPISCHDLX,
"Checkbox Schedule Line Data
TYP_TD_SOCONDITION    TYPE STANDARD TABLE OF BAPICOND,
"Conditions
TYP_TD_SOCONDITIONX   TYPE STANDARD TABLE OF BAPICONDX,
"Conditions Checkbox
TYP_TD_SOTEXT         TYPE STANDARD TABLE OF BAPISDTEXT.     "Texts

*&----------------------------------------------------------------------
* 内部テーブル定義
*&----------------------------------------------------------------------
DATA:
W_CODEPAGE  TYPE ABAP_ENCODING,"Codepage
W_FLGUTF8   TYPE FLAG,         "UTF-8
W_TNUM      TYPE I,            "Total number
W_SNUM      TYPE I,            "Success number
W_ENUM      TYPE I,            "Error number
TD_FILE     TYPE TYP_TD_FILE,  "Input file
**** START UPD 2015/06/18 ISID18 ****
*  TD_EFILE    TYPE TYP_TD_FILE,  "Error file
TD_EFILE    TYPE TYP_TD_FILE_STR,  "Error file
ST_FILE_STR TYPE TYP_FILE_STR,
**** END UPD 2015/06/18 ISID18 ****
TD_MSG      TYPE TYP_TD_MSG.   "msg table

*&----------------------------------------------------------------------
* 変数の定義
*&----------------------------------------------------------------------
DATA:
W_WERKS TYPE WERKS_D.

*&----------------------------------------------------------------------
* 選択画面定義(1000)
*&----------------------------------------------------------------------
SELECTION-SCREEN BEGIN OF BLOCK BL1 WITH FRAME TITLE TEXT-001.

SELECTION-SCREEN BEGIN OF LINE.
* サーバ
SELECTION-SCREEN POSITION 33.
PARAMETERS:P_SERVE RADIOBUTTON GROUP RB1 DEFAULT 'X'.
SELECTION-SCREEN: COMMENT 36(8) TEXT-002.
* ローカル
SELECTION-SCREEN POSITION 46.
PARAMETERS:P_LOCAL RADIOBUTTON GROUP RB1.
SELECTION-SCREEN: COMMENT 49(6) TEXT-003.
SELECTION-SCREEN END OF LINE.

SELECTION-SCREEN BEGIN OF LINE.
* テスト実行
SELECTION-SCREEN POSITION 33.
PARAMETERS: P_TSTCK AS CHECKBOX DEFAULT 'X'.
SELECTION-SCREEN: COMMENT 36(8) TEXT-004.

SELECTION-SCREEN END OF LINE.
SELECTION-SCREEN END OF BLOCK BL1.

SELECTION-SCREEN BEGIN OF BLOCK BL2 WITH FRAME TITLE TEXT-005.

* Input file
PARAMETERS: P_IFILE   TYPE RLGRAP-FILENAME OBLIGATORY.
* Result file
PARAMETERS: P_RFILE   TYPE RLGRAP-FILENAME.
* Error file
PARAMETERS: P_EFILE   TYPE RLGRAP-FILENAME.

SELECTION-SCREEN END OF BLOCK BL2.

SELECTION-SCREEN BEGIN OF BLOCK BL3 WITH FRAME TITLE TEXT-006.
* Plant
SELECT-OPTIONS: S_WERKS FOR W_WERKS OBLIGATORY.
SELECTION-SCREEN END OF BLOCK BL3.

*----------------------------------------------------------------------*
* INITIALIZATION
*----------------------------------------------------------------------*
INITIALIZATION.
* 初期処理
PERFORM INIT_DATA.

*----------------------------------------------------------------------*
* AT SELETION-SCREEN
*----------------------------------------------------------------------*
AT SELECTION-SCREEN.
* 入力チェック
PERFORM CHECK_INPUT.

AT SELECTION-SCREEN OUTPUT.
* Modify screen
PERFORM MODIFY_SCREEN.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR P_IFILE.
* 検索ヘルプ
PERFORM F4_FOR_FILE.

*----------------------------------------------------------------------*
* START-OF-SELECTION
*----------------------------------------------------------------------*
START-OF-SELECTION.
* 主処理
PERFORM MAIN_PROCESS.

*---------------------------------------------------------------------
* TOP-OF-PAGE
*---------------------------------------------------------------------
TOP-OF-PAGE.
* ヘッダ出力
PERFORM OUTPUT_HEAD.

*&---------------------------------------------------------------------*
*&      Form  INIT_DATA
*&---------------------------------------------------------------------*
*       初期処理
*----------------------------------------------------------------------*
FORM INIT_DATA .

* Modify screen
PERFORM MODIFY_SCREEN.

ENDFORM.                    " INIT_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_INPUT
*&---------------------------------------------------------------------*
*       入力チェック
*----------------------------------------------------------------------*
FORM CHECK_INPUT .

TYPES: BEGIN OF LTYP_WERKS,
WERKS TYPE T001W-WERKS,
END OF LTYP_WERKS.

DATA: LTD_WERKS   TYPE STANDARD TABLE OF LTYP_WERKS,
LST_WERKS   TYPE LTYP_WERKS.

* A-1-1．入力チェック
* プラントコード存在チェック
SELECT WERKS
INTO TABLE LTD_WERKS
FROM T001W
WHERE WERKS IN S_WERKS.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
*   プラント ( &1 ) は存在しません
MESSAGE E004(ZMEGSD01) WITH S_WERKS-LOW.
ENDIF.

* A-1-2．権限チェック
LOOP AT LTD_WERKS INTO LST_WERKS.
AUTHORITY-CHECK OBJECT 'M_MSEG_WMB'
ID 'WERKS' FIELD LST_WERKS-WERKS
ID 'ACTVT' FIELD '01'.
IF SY-SUBRC <> 0.
SET CURSOR FIELD 'S_WERKS-LOW'.
*     プラントに対する実行権限がありません
MESSAGE E003(ZMEGSD01).

ENDIF.
ENDLOOP.

* Result & Error ファイル名取得
PERFORM SET_RFILE.

ENDFORM.                    " CHECK_INPUT

*&---------------------------------------------------------------------*
*&      Form  F4_FOR_FILE
*&---------------------------------------------------------------------*
*       ファイル名取得
*----------------------------------------------------------------------*
FORM F4_FOR_FILE .

DATA:LT_FILE           TYPE FILETABLE,   "ファイル名一覧格納テーブル
LV_FILENAME(1024) TYPE C,           "ヘッダ
LV_RC             TYPE I.           "結果

CALL METHOD CL_GUI_FRONTEND_SERVICES=>FILE_OPEN_DIALOG
CHANGING
FILE_TABLE              = LT_FILE    "ファイル名一覧格納テーブル
RC                      = LV_RC      "結果
EXCEPTIONS
FILE_OPEN_DIALOG_FAILED = 1
CNTL_ERROR              = 2
ERROR_NO_GUI            = 3
NOT_SUPPORTED_BY_GUI    = 4
OTHERS                  = 5.

IF  SY-SUBRC = 0
AND LV_RC  >= 0.                             " 結果
READ TABLE LT_FILE INTO LV_FILENAME INDEX 1.
IF SY-SUBRC = 0.
*     ファイル名を選択画面にセット
P_IFILE = LV_FILENAME.

*     Result & Error ファイル名取得
PERFORM SET_RFILE.

ENDIF.
ELSE.
*   エラーの場合
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDFORM.                    " F4_FOR_FILE

*&---------------------------------------------------------------------*
*&      Form  MODIFY_SCREEN
*&---------------------------------------------------------------------*
*       Modify screen
*----------------------------------------------------------------------*
FORM MODIFY_SCREEN .
* Modify screen
LOOP AT SCREEN.
IF SCREEN-NAME = 'P_RFILE' OR
SCREEN-NAME = 'P_EFILE'.
SCREEN-INPUT = '0'.
MODIFY SCREEN.
ENDIF.
ENDLOOP.
ENDFORM.                    " MODIFY_SCREEN

*&---------------------------------------------------------------------*
*&      Form  SET_RFILE
*&---------------------------------------------------------------------*
*       Result & Error ファイル名取得
*----------------------------------------------------------------------*
FORM SET_RFILE .

DATA:
LW_SHIFTN   TYPE I,
LW_PATH     TYPE RLGRAP-FILENAME,
LW_FULLNAME TYPE RLGRAP-FILENAME,
LW_FILENAME TYPE RLGRAP-FILENAME,
LW_RFILE    TYPE RLGRAP-FILENAME,
LW_EFILE    TYPE RLGRAP-FILENAME.

IF P_IFILE IS NOT INITIAL.
LW_FULLNAME = P_IFILE.
* search for '\'
DO.
SEARCH LW_FULLNAME FOR CNS_SLASH.
IF SY-SUBRC > 0.
LW_FILENAME = LW_FULLNAME.
EXIT.
ENDIF.
LW_SHIFTN = SY-FDPOS + 1.
SHIFT LW_FULLNAME BY LW_SHIFTN PLACES LEFT.
ENDDO.
ENDIF.


IF LW_FILENAME IS NOT INITIAL.
LW_FULLNAME = P_IFILE.
*   Get path
SEARCH LW_FULLNAME FOR LW_FILENAME.
LW_PATH = LW_FULLNAME(SY-FDPOS).
CONDENSE LW_FULLNAME.

*   Get result file
CONCATENATE LW_PATH CNS_RFILE LW_FILENAME INTO LW_RFILE.
P_RFILE = LW_RFILE.

*   Get error file
CONCATENATE LW_PATH CNS_EFILE LW_FILENAME INTO LW_EFILE.
P_EFILE = LW_EFILE.
ENDIF.

ENDFORM.                    " SET_RFILE

*&---------------------------------------------------------------------*
*&      Form  MAIN_PROCESS
*&---------------------------------------------------------------------*
*       主処理
*----------------------------------------------------------------------*
FORM MAIN_PROCESS .

* A-2. ファイル取込
PERFORM GET_DATA CHANGING TD_FILE.

* A-3&A-4．データ処理
PERFORM PROCESS_DATA CHANGING TD_FILE
TD_EFILE
TD_MSG.

* A-5．画面出力・ファイル出力
PERFORM PROCESS_RESULT USING TD_EFILE
TD_MSG.

ENDFORM.                    " MAIN_PROCESS

*&---------------------------------------------------------------------*
*&      Form  GET_DATA
*&---------------------------------------------------------------------*
*       ファイル取込
*----------------------------------------------------------------------*
FORM GET_DATA CHANGING O_TD_FILE TYPE TYP_TD_FILE.

IF P_SERVE = ABAP_ON.
*   A-2-1．ファイル取込（Server）
PERFORM GET_DATA_SERVE CHANGING O_TD_FILE.
ELSE.
*   A-2-2．ファイル取込（Local）
PERFORM GET_DATA_LOCAL CHANGING O_TD_FILE.
ENDIF.

ENDFORM.                    " GET_DATA

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_SERVE
*&---------------------------------------------------------------------*
*       A-2-1．ファイル取込（Server）
*----------------------------------------------------------------------*
*      <--O_TD_FILE   File data
*----------------------------------------------------------------------*
FORM GET_DATA_SERVE  CHANGING O_TD_FILE TYPE TYP_TD_FILE.

DATA:
LW_Z_OUTPUT_CP     TYPE ZTEGZZM001-Z_OUTPUT_CP,
LW_SAPCODEPAGE     TYPE STRING,
LST_SFILE          TYPE TYP_SFILE,
LTD_SFILE          TYPE TYP_TD_SFILE.

* A-2-1-1．文字コードの取得
CALL FUNCTION 'ZEG_ZZ_GLOBAL_PGM_CONFIG_GET'
EXPORTING
IMPPGM      = SY-REPID
IMPBUKRS    = SPACE
IMPORTING
EXPCODEPAGE = LW_Z_OUTPUT_CP
EXPFLGUTF8  = W_FLGUTF8.
IF LW_Z_OUTPUT_CP IS INITIAL.
*  データが存在しない場合
MESSAGE S051(ZMEGSD01) WITH TEXT-E01 SY-REPID
DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.
LW_SAPCODEPAGE = LW_Z_OUTPUT_CP.

IF LW_SAPCODEPAGE IS NOT INITIAL.
W_CODEPAGE = CL_ABAP_CODEPAGE=>SAP_CODEPAGE( LW_SAPCODEPAGE ).
ENDIF.

* A-2-1-2．アップロードデータの取込
IF W_FLGUTF8 IS INITIAL.
TRY.
OPEN DATASET P_IFILE FOR INPUT
IN LEGACY TEXT MODE CODE PAGE W_CODEPAGE
IGNORING CONVERSION ERRORS.
CATCH  CX_SY_CODEPAGE_CONVERTER_INIT.
SY-SUBRC = 8.
ENDTRY.
ELSE.
OPEN DATASET P_IFILE FOR INPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS
SKIPPING BYTE-ORDER MARK.
ENDIF.
IF SY-SUBRC <> 0.
*   エラーが発生した場合
MESSAGE S035(ZMEGSD01) WITH P_IFILE DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.

* 読込み
DO.
CLEAR LST_SFILE.
READ DATASET P_IFILE INTO LST_SFILE-FIELD.
IF SY-SUBRC <> 0.
EXIT.
ELSE.
APPEND LST_SFILE TO LTD_SFILE.
ENDIF.
ENDDO.

* ファイルクローズ
CLOSE DATASET P_IFILE.

IF LTD_SFILE IS NOT INITIAL.
*   タブで区切って編集
PERFORM SPLIT_FILE USING    LTD_SFILE
CHANGING O_TD_FILE.
ENDIF.

ENDFORM.                    " GET_DATA_SERVE

*&---------------------------------------------------------------------*
*&      Form  SPLIT_FILE
*&---------------------------------------------------------------------*
*       入力ファイルをタブで区切る
*----------------------------------------------------------------------*
*      -->I_TD_SFILE  Server File data
*      <--O_TD_FILE   File data
*----------------------------------------------------------------------*
FORM SPLIT_FILE  USING    I_TD_SFILE TYPE TYP_TD_SFILE
CHANGING O_TD_FILE  TYPE TYP_TD_FILE.

DATA:
**** start add 2015/05/15 isid18 ****
LST_FILE_BAK       TYPE TYP_SFILE,
LW_TYP             TYPE C,
LW_COL             TYPE I,
LW_COL_H           TYPE I,
**** end add 2015/05/15 isid18  ****
LST_SFILE  TYPE TYP_SFILE,
LST_FILE   TYPE TYP_FILE,
LW_ITEM(6) TYPE C.

**** START ADD 2015/06/18 ISID18 ****
READ TABLE I_TD_SFILE INTO LST_SFILE INDEX 1.
PERFORM GET_FILE_TITLE
USING    LST_SFILE
CHANGING ST_FILE_STR.
**** END ADD 2015/06/18 ISID18 ****

LOOP AT I_TD_SFILE INTO LST_SFILE.
CLEAR LST_FILE.

**** start add 2015/05/15 isid18 ****
IF SY-TABIX = 1.
LST_FILE_BAK = LST_SFILE.
FIND ALL OCCURRENCES OF CNS_TAB
IN LST_FILE_BAK-FIELD
MATCH COUNT LW_COL_H.
DESCRIBE FIELD LST_FILE
TYPE LW_TYP
COMPONENTS LW_COL.
LW_COL = LW_COL - 1.
IF LW_COL <> LW_COL_H.
MESSAGE S089(ZMEGSD01) DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.
ENDIF.
**** end add 2015/05/15 isid18 ****
SPLIT LST_SFILE-FIELD
AT CNS_TAB
INTO LST_FILE-TCD            "TCD
LST_FILE-GFLAG          "GroupFlag
LST_FILE-AUART          "DocType
LST_FILE-VKORG          "SalesOrg
LST_FILE-VTWEG          "DistChannel
LST_FILE-SPART          "Division
LST_FILE-VKBUR          "SalesOffice
LST_FILE-VKGRP          "SalesGrp
LST_FILE-VBELN          "SONo
LST_FILE-BSTKD          "CustPurchNo
LST_FILE-BSTDK          "CustPurchDate
LST_FILE-AUDAT          "DocDate
LST_FILE-PRSDT          "PriceDate
LST_FILE-LIFSK          "ShipBlock
LST_FILE-AUGRU          "OrderReason
LST_FILE-WAERK          "NetPriceCurrency
LST_FILE-SUBMI          "CollectNo
**** start add 2015/05/04 isid18 ****
LST_FILE-BNAME          "OrderName
**** end add 2015/05/04 isid18 ****
LST_FILE-SOLDTO         "SoldTo
LST_FILE-SHIPTO         "ShipTo
LST_FILE-SHIP_NAME      "ShipToName1
LST_FILE-SHIP_NAME2     "ShipToName2
LST_FILE-SHIP_NAME3     "ShipToName3
LST_FILE-COUNTR_ISO     "ShipToCountryCode
LST_FILE-POSTL_CODE     "ShipToPostalCode
LST_FILE-STREET         "ShipToAddress1
LST_FILE-CITY           "ShipToAddress2
LST_FILE-TELEPHONE      "ShipToTel
LST_FILE-FAX_NUMBER     "ShipToFax
LST_FILE-BILLTO         "BillTo
LST_FILE-PAYER          "Payer
LST_FILE-SAEMP          "SalesEmployee
LST_FILE-EDUPRI         "EndUserPrice
LST_FILE-EDUEXP         "EndUserExport
LST_FILE-SAASSIS        "SalesAssistant
**** start upd 2015/05/04 isid18 ****
*          lst_file-langu_iso      "TextLanguage
LST_FILE-ZTERM          "PaymentTerms
**** end upd 2015/05/04 isid18 ****
LST_FILE-INBREM         "TextHdrInboundRemarks
LST_FILE-TABREM         "TextHdrDNRemarks
LST_FILE-SOREM          "TextHdrSORemarks
LW_ITEM                 "Item
**** start add 2015/05/04 isid18 ****
LST_FILE-PSTYV          "Itemcategory
**** end add 2015/05/04 isid18 ****
LST_FILE-MATERIAL       "Material
LST_FILE-SHORT_TEXT     "MaterialText
LST_FILE-PLANT          "Plant
LST_FILE-STORE_LOC      "SLoc
LST_FILE-REQ_DATE       "DeliveryDate
LST_FILE-REQ_QTY        "SOQty
LST_FILE-COND_UNIT      "OrderUnit
**** start add 2015/05/04 isid18 ****
LST_FILE-BSTKD_ITEM     "CustomerPONoItm
LST_FILE-BSTDK_ITEM     "CustomerPODateItm
LST_FILE-REASON_REJ     "RejectReason
**** end add 2015/05/04 isid18 ****
LST_FILE-COND_TYPE      "CondType
LST_FILE-COND_VALUE     "NetPrice
LST_FILE-COND_P_UNT     "PriceUnit
LST_FILE-ITEMREM        "TextItmShipRemarks
**** start add 2015/05/04 isid18 ****
LST_FILE-TRANSREM.      "TextItmTransportMeans
**** end add 2015/05/04 isid18 ****
LST_FILE-ITM_NUMBER = LW_ITEM.    "Item
APPEND LST_FILE TO O_TD_FILE.
ENDLOOP.

ENDFORM.                    " SPLIT_FILE

*&---------------------------------------------------------------------*
*&      Form  GET_DATA_LOCAL
*&---------------------------------------------------------------------*
*       A-2-2．ファイル取込（Local）
*----------------------------------------------------------------------*
*      <--O_TD_FILE   File data
*----------------------------------------------------------------------*
FORM GET_DATA_LOCAL CHANGING O_TD_FILE TYPE TYP_TD_FILE.

DATA:
**** start add 2015/05/15 isid18 ****
LTD_SFILE   TYPE TYP_TD_SFILE,
**** end add 2015/05/15 isid18 ****
LW_ENCODING TYPE ABAP_ENCODING,
LW_RC       TYPE I,
LV_FILENAME TYPE STRING.

* A-2-2-1．文字コードの取得
CALL METHOD CL_GUI_FRONTEND_SERVICES=>GET_SAPLOGON_ENCODING
CHANGING
FILE_ENCODING                 = LW_ENCODING
RC                            = LW_RC
EXCEPTIONS
CNTL_ERROR                    = 1
ERROR_NO_GUI                  = 2
NOT_SUPPORTED_BY_GUI          = 3
CANNOT_INITIALIZE_GLOBALSTATE = 4
OTHERS                        = 5.

* A-2-2-2．アップロードデータの取込
LV_FILENAME = P_IFILE.
CALL FUNCTION 'GUI_UPLOAD'
EXPORTING
FILENAME                = LV_FILENAME
FILETYPE                = CNS_FTYPE
**** start upd 2015/05/15 isid18 ****
*      has_field_separator     = cns_tab
HAS_FIELD_SEPARATOR     = SPACE
**** end upd 2015/05/15 isid18 ****
CODEPAGE                = LW_ENCODING
TABLES
**** start upd 2015/05/15 isid18 ****
*      data_tab                = o_td_file
DATA_TAB                = LTD_SFILE
**** end upd 2015/05/15 isid18 ****
EXCEPTIONS
FILE_OPEN_ERROR         = 1
FILE_READ_ERROR         = 2
NO_BATCH                = 3
GUI_REFUSE_FILETRANSFER = 4
INVALID_TYPE            = 5
NO_AUTHORITY            = 6
UNKNOWN_ERROR           = 7
BAD_DATA_FORMAT         = 8
HEADER_NOT_ALLOWED      = 9
SEPARATOR_NOT_ALLOWED   = 10
HEADER_TOO_LONG         = 11
UNKNOWN_DP_ERROR        = 12
ACCESS_DENIED           = 13
DP_OUT_OF_MEMORY        = 14
DISK_FULL               = 15
DP_TIMEOUT              = 16
OTHERS                  = 17.
* エラーが発生した場合
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
**** start add 2015/05/15 isid18 ****
ELSE.
IF LTD_SFILE[] IS NOT INITIAL.
*     タブで区切って編集
PERFORM SPLIT_FILE USING    LTD_SFILE
CHANGING O_TD_FILE.
ENDIF.
**** end add 2015/05/15 isid18 ****
ENDIF.

ENDFORM.                    " GET_DATA_LOCAL

*&---------------------------------------------------------------------*
*&      Form  PROCESS_DATA
*&---------------------------------------------------------------------*
*       データ処理
*----------------------------------------------------------------------*
*      <--O_TD_FILE   File data
*      <--O_TD_EFILE  Error File data
*      <--O_TD_MSG    Error message table
*----------------------------------------------------------------------*
FORM PROCESS_DATA CHANGING O_TD_FILE  TYPE TYP_TD_FILE
**** START UPD 2015/06/18 ISID18 ****
*                           O_TD_EFILE TYPE TYP_TD_FILE
O_TD_EFILE TYPE TYP_TD_FILE_STR
**** END UPD 2015/06/18 ISID18 ****
O_TD_MSG   TYPE TYP_TD_MSG.

DATA:
LW_INDEX           TYPE SY-INDEX,       "Line row
LW_INDEX_SO        TYPE SY-INDEX,       "SO header row
LW_EFLG            TYPE C,              "Every row check flag
LW_EFLG_BAPI       TYPE C,              "BAPI executive flag
LW_EFLG_G          TYPE C,              "Group error check
LW_TCD(4)          TYPE C,
LST_FILE           TYPE TYP_FILE,
**** START UPD 2015/06/18 ISID18 ****
*    LTD_EFILE          TYPE TYP_TD_FILE,
LTD_EFILE          TYPE TYP_TD_FILE_STR,
**** END UPD 2015/06/18 ISID18 ****
**** start del 2015/05/15 isid18 ****
*    lw_col             TYPE i,
*    lw_typ             TYPE c,
**** end del 2015/05/15 isid18 ****
LW_VBELN           TYPE VBELN,          "SO No
LW_BSTKD           TYPE VBKD-BSTKD,     "CustPurchNo
LW_BSTDK           TYPE VBKD-BSTDK,     "CustPurchDate
LW_WAERS           TYPE VBAK-WAERK,     "NetPriceCurrency
LW_SPRAS           TYPE LAISO,          "TextLanguage
**** start add 2015/05/04 isid18 ****
**** START ADD 2015/06/29 ISID18 ****
LW_KUNNR           TYPE VBAK-KUNNR,
**** END ADD 2015/06/29 ISID18 ****
LW_BUS_TYPE        TYPE BAPIUSW01-OBJTYPE,
LW_AUART           TYPE CHAR4,
**** START UPD 2015/06/18 ISID18 ****
*    LST_FILE_BAK       TYPE TYP_FILE,
LST_FILE_BAK       TYPE TYP_FILE_STR,
**** END UPD 2015/06/18 ISID18 ****
**** end add 2015/05/04 isid18 ****
LST_SOHEADER       TYPE BAPISDHD1,      "Order Header
LST_SOHEADERX      TYPE BAPISDHD1X,     "Sales Order Check List
LTD_SOITEM         TYPE STANDARD TABLE OF BAPISDITM,      "Item Data
LTD_SOITEMX        TYPE STANDARD TABLE OF BAPISDITMX,
"Item Data Checkbox
LTD_PARNR          TYPE STANDARD TABLE OF BAPIPARNR,
"Document Partner
LTD_PARNRC         TYPE STANDARD TABLE OF BAPIPARNRC,
"Document Partner Change
LTD_PARNRAD        TYPE STANDARD TABLE OF BAPIADDR1,
"Document Partner Address
LTD_SOSCHEDULE     TYPE STANDARD TABLE OF BAPISCHDL,
"Schedule Line Data
LTD_SOSCHEDULEX    TYPE STANDARD TABLE OF BAPISCHDLX,
"Checkbox Schedule Line Data
LTD_SOCONDITION    TYPE STANDARD TABLE OF BAPICOND,
"Conditions
LTD_SOCONDITIONX   TYPE STANDARD TABLE OF BAPICONDX,
"Conditions Checkbox
LTD_SOTEXT         TYPE STANDARD TABLE OF BAPISDTEXT,     "Texts\
**** start upd 2015/05/04 isid18 ****
*    lst_soheader_c     TYPE bapisdh1,      "Order Header
*    lst_soheaderx_c    TYPE bapisdh1x.     "Sales Order Check List
LST_SOHEADER_C     TYPE BAPISDHD1,      "Order Header
LST_SOHEADERX_C    TYPE BAPISDHD1X.     "Sales Order Check List
**** end upd 2015/05/04 isid18 ****

* A-3-1．ファイル形式チェック
**** start del 2015/05/15 isid18 ****
*  READ TABLE o_td_file INTO lst_file INDEX 1.
*  DESCRIBE FIELD lst_file TYPE lw_typ COMPONENTS lw_col.
***** start upd 2015/05/04 isid18 ****
**  IF lw_col <> 50.
*  IF lw_col <> 56.
***** end upd 2015/05/04 isid18 ****
*    MESSAGE s089(zmegsd01) DISPLAY LIKE cns_msg_e.
*    LEAVE LIST-PROCESSING.
*  ENDIF.
**** start del 2015/05/15 isid18 ****

**** start add 2015/05/04 isid18 ****
* ヘッダ行削除
DELETE O_TD_FILE INDEX 1.
**** end add 2015/05/04 isid18 ****

LOOP AT O_TD_FILE INTO LST_FILE.
**** start add 2015/05/04 isid18 ****
CLEAR LST_FILE_BAK.
**** end add 2015/05/04 isid18 ****
**** START ADD 2015/06/18 ISID18 ****
MOVE-CORRESPONDING LST_FILE TO LST_FILE_BAK.
**** END ADD 2015/06/18 ISID18 ****
LW_INDEX = SY-TABIX.

IF LST_FILE-TCD IS NOT INITIAL AND
LST_FILE-GFLAG IS NOT INITIAL.
*     A-4-1-2．BAPIの実行
IF LW_TCD = CNS_TCD1.
IF LW_EFLG_G <> ABAP_ON.
PERFORM SO_CREATE_EXECUTE USING LW_INDEX_SO
**** start add 2015/05/04 isid18 ****
LW_BUS_TYPE
**** end add 2015/05/04 isid18 ****
LST_SOHEADER
LST_SOHEADERX
LTD_SOITEM
LTD_SOITEMX
LTD_PARNR
LTD_SOSCHEDULE
LTD_SOSCHEDULEX
LTD_SOCONDITION
LTD_SOCONDITIONX
LTD_SOTEXT
CHANGING  LW_EFLG_BAPI
O_TD_MSG.
**** start add 2015/05/04 isid18 ****
ELSE.
W_ENUM = W_ENUM + 1.
**** START ADD 2015/06/18 ISID18 ****
APPEND LINES OF LTD_EFILE TO O_TD_EFILE.
REFRESH LTD_EFILE.
**** END ADD 2015/06/18 ISID18 ****
**** end add 2015/05/04 isid18 ****
ENDIF.
CLEAR LW_EFLG_G.
ELSEIF LW_TCD = CNS_TCD2.
**** START UPD 2015/06/18 ISID18 ****
*        IF LW_EFLG <> ABAP_ON.
IF LW_EFLG_G <> ABAP_ON.
**** END UPD 2015/06/18 ISID18 ****
PERFORM SO_CHANGE_EXECUTE USING LW_INDEX_SO
LW_VBELN
**** start add 2015/05/04 isid18 ****
LW_BUS_TYPE
**** end add 2015/05/04 isid18 ****
LST_SOHEADER_C
LST_SOHEADERX_C
LTD_SOITEM
LTD_SOITEMX
LTD_PARNRC
LTD_PARNRAD
LTD_SOSCHEDULE
LTD_SOSCHEDULEX
LTD_SOCONDITION
LTD_SOCONDITIONX
LTD_SOTEXT
CHANGING  LW_EFLG_BAPI
O_TD_MSG.
**** start add 2015/05/04 isid18 ****
ELSE.
W_ENUM = W_ENUM + 1.
**** START ADD 2015/06/18 ISID18 ****
APPEND LINES OF LTD_EFILE TO O_TD_EFILE.
REFRESH LTD_EFILE.
**** END ADD 2015/06/18 ISID18 ****
**** end add 2015/05/04 isid18 ****
ENDIF.
CLEAR LW_EFLG_G.
**** START ADD 2015/06/18 ISID18 ****
ELSE.
IF LW_EFLG_G = ABAP_ON.
W_ENUM = W_ENUM + 1.
APPEND LINES OF LTD_EFILE TO O_TD_EFILE.
REFRESH LTD_EFILE.
ENDIF.
CLEAR LW_EFLG_G.
**** END ADD 2015/06/18 ISID18 ****
ENDIF.
*     Edit error file data
IF LW_EFLG_BAPI = ABAP_ON.
APPEND LINES OF LTD_EFILE TO O_TD_EFILE.
CLEAR LW_EFLG_BAPI.
**** START ADD 2015/06/18 ISID18 ****
REFRESH LTD_EFILE.
**** END ADD 2015/06/18 ISID18 ****
ELSE.
REFRESH LTD_EFILE.
ENDIF.

CLEAR:
LW_TCD,
LW_INDEX_SO,
LW_BSTKD,
LW_BSTDK,
LW_WAERS,
LW_SPRAS,
LW_VBELN,
**** start add 2015/05/04 isid18 ****
LW_BUS_TYPE,
LW_EFLG_G,
LW_AUART,
**** end add 2015/05/04 isid18 ****
**** START ADD 2015/06/29 ISID18 ****
LW_KUNNR,
**** END ADD 2015/06/29 ISID18 ****
LST_SOHEADER,
LST_SOHEADERX,
LST_SOHEADER_C,
LST_SOHEADERX_C.
REFRESH:
LTD_SOITEM,
LTD_SOITEMX,
LTD_PARNR,
LTD_PARNRC,
LTD_PARNRAD,
LTD_SOSCHEDULE,
LTD_SOSCHEDULEX,
LTD_SOCONDITION,
LTD_SOCONDITIONX,
LTD_SOTEXT.

**** start add 2015/05/04 isid18 ****
PERFORM GET_OBJECT_TYPE
USING    LST_FILE-AUART
CHANGING LW_BUS_TYPE.
**** end add 2015/05/04 isid18 ****

LW_TCD      = LST_FILE-TCD.    "Tcode
LW_INDEX_SO = LW_INDEX.        "PO row id
*     For relation data check
LW_VBELN    = LST_FILE-VBELN.     "SO No
LW_BSTKD    = LST_FILE-BSTKD.     "CustPurchNo
LW_BSTDK    = LST_FILE-BSTDK.     "CustPurchDate
LW_WAERS    = LST_FILE-WAERK.     "NetPriceCurrency
**** start del 2015/05/04 isid18 ****
*      lw_spras    = lst_file-langu_iso. "TextLanguage
**** end del 2015/05/04 isid18 ****
**** START ADD 2015/06/29 ISID18 ****
LW_KUNNR    = LST_FILE-SOLDTO.
**** END ADD 2015/06/29 ISID18 ****
ELSE.
**** start upd 2015/05/04 isid18 ****
*      lst_file-vbeln     = lw_vbeln.    "SO No
*      lst_file-bstkd     = lw_bstkd.    "CustPurchNo
*      lst_file-bstdk     = lw_bstdk.    "CustPurchDate
*      lst_file-waerk     = lw_waers.    "NetPriceCurrency
*      lst_file-langu_iso = lw_spras.    "TextLanguage
IF LST_FILE-VBELN IS INITIAL.
LST_FILE-VBELN     = LW_VBELN.    "SO No
ENDIF.
IF LST_FILE-BSTKD IS INITIAL.
LST_FILE-BSTKD     = LW_BSTKD.    "CustPurchNo
ENDIF.
IF LST_FILE-BSTDK IS INITIAL
**** start add 2015/05/15 isid18 ****
OR LST_FILE-BSTDK = SPACE.
**** end add 2015/05/15 isid18 ****
LST_FILE-BSTDK     = LW_BSTDK.    "CustPurchDate
ENDIF.
IF LST_FILE-WAERK IS INITIAL.
LST_FILE-WAERK     = LW_WAERS.    "NetPriceCurrency
ENDIF.
**** end upd 2015/05/04 isid18 ****
**** START ADD 2015/06/29 ISID18 ****
IF LST_FILE-SOLDTO IS INITIAL.
LST_FILE-SOLDTO = LW_KUNNR.
ENDIF.
**** END ADD 2015/06/29 ISID18 ****
ENDIF.

*   A-3-2．データチェック
CLEAR LW_EFLG.
PERFORM CHECK_DATA USING    LW_INDEX
CHANGING LST_FILE
LW_EFLG
O_TD_MSG.
IF LW_EFLG = ABAP_ON.
**** start upd 2015/05/04 isid18 ****
*      APPEND lst_file TO o_td_efile.
**** START DEL 2015/06/18 ISID18 ****
*      LST_FILE_BAK = LST_FILE.
*      CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
*        EXPORTING
*          INPUT  = LST_FILE_BAK-AUART
*        IMPORTING
*          OUTPUT = LST_FILE_BAK-AUART.
**** END DEL 2015/06/18 ISID18 ****
APPEND LST_FILE_BAK TO O_TD_EFILE.
**** end upd 2015/05/04 isid18 ****
LW_EFLG_G = ABAP_ON.
CONTINUE.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*    APPEND lst_file TO ltd_efile.
**** START DEL 2015/06/18 ISID18 ****
*    LST_FILE_BAK = LST_FILE.
*    CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
*      EXPORTING
*        INPUT  = LST_FILE_BAK-AUART
*      IMPORTING
*        OUTPUT = LST_FILE_BAK-AUART.
**** END DEL 2015/06/18 ISID18 ****
APPEND LST_FILE_BAK TO LTD_EFILE.
**** end upd 2015/05/04 isid18 ****

IF LW_TCD = CNS_TCD1.
*     A-4-1-1．BAPIのパラメータ設定
PERFORM SO_CREATE_EDIT USING    LST_FILE
CHANGING LST_SOHEADER
LST_SOHEADERX
LTD_SOITEM
LTD_SOITEMX
LTD_PARNR
LTD_SOSCHEDULE
LTD_SOSCHEDULEX
LTD_SOCONDITION
LTD_SOCONDITIONX
LTD_SOTEXT.
ELSEIF LW_TCD = CNS_TCD2.
*     A-4-2-1．bapiのパラメータ設定
PERFORM SO_CHANGE_EDIT USING    LST_FILE
CHANGING LW_VBELN
**** start add 2015/05/04 isid18 ****
LW_AUART
**** end add 2015/05/04 isid18 ****
LST_SOHEADER_C
LST_SOHEADERX_C
LTD_SOITEM
LTD_SOITEMX
LTD_PARNRC
LTD_PARNRAD
LTD_SOSCHEDULE
LTD_SOSCHEDULEX
LTD_SOCONDITION
LTD_SOCONDITIONX
LTD_SOTEXT.
ENDIF.

ENDLOOP.

* Last transaction
IF LW_EFLG_G <> ABAP_ON.
IF LW_TCD = CNS_TCD1.
PERFORM SO_CREATE_EXECUTE USING LW_INDEX_SO
**** start add 2015/05/04 isid18 ****
LW_BUS_TYPE
**** end add 2015/05/04 isid18 ****
LST_SOHEADER
LST_SOHEADERX
LTD_SOITEM
LTD_SOITEMX
LTD_PARNR
LTD_SOSCHEDULE
LTD_SOSCHEDULEX
LTD_SOCONDITION
LTD_SOCONDITIONX
LTD_SOTEXT
CHANGING  LW_EFLG_BAPI
O_TD_MSG.
ELSEIF LW_TCD = CNS_TCD2.
PERFORM SO_CHANGE_EXECUTE USING LW_INDEX_SO
LW_VBELN
**** start add 2015/05/04 isid18 ****
LW_BUS_TYPE
**** end add 2015/05/04 isid18 ****
LST_SOHEADER_C
LST_SOHEADERX_C
LTD_SOITEM
LTD_SOITEMX
LTD_PARNRC
LTD_PARNRAD
LTD_SOSCHEDULE
LTD_SOSCHEDULEX
LTD_SOCONDITION
LTD_SOCONDITIONX
LTD_SOTEXT
CHANGING  LW_EFLG_BAPI
O_TD_MSG.

ENDIF.

IF LW_EFLG_BAPI = ABAP_ON.
APPEND LINES OF LTD_EFILE TO O_TD_EFILE.
**** START ADD 2015/06/18 ISID18 ****
REFRESH LTD_EFILE.
**** END ADD 2015/06/18 ISID18 ****
ELSE.
REFRESH LTD_EFILE.
ENDIF.
**** start add 2015/05/04 isid18 ****
ELSE.
W_ENUM = W_ENUM + 1.
**** START ADD 2015/06/18 ISID18 ****
APPEND LINES OF LTD_EFILE TO O_TD_EFILE.
REFRESH LTD_EFILE.
**** END ADD 2015/06/18 ISID18 ****
**** end add 2015/05/04 isid18 ****
ENDIF.

**** START ADD 2015/06/18 ISID18 ****
IF O_TD_EFILE IS NOT INITIAL.
INSERT ST_FILE_STR INTO O_TD_EFILE INDEX 1.
ENDIF.
**** END ADD 2015/06/18 ISID18 ****

ENDFORM.                    " PROCESS_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_DATA
*&---------------------------------------------------------------------*
*       A-3.データチェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      <--I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM CHECK_DATA USING    I_W_INDEX   TYPE SY-INDEX
CHANGING I_ST_FILE   TYPE TYP_FILE
O_W_EFLG    TYPE C
O_TD_MSG    TYPE TYP_TD_MSG.

**** start add 2015/05/04 isid18 ****
PERFORM CHECK_GFLAG USING I_W_INDEX
I_ST_FILE.
**** end add 2015/05/04 isid18 ****

* A-3-2-1．TCDのチェック
IF I_ST_FILE-TCD IS NOT INITIAL AND
I_ST_FILE-GFLAG IS NOT INITIAL.
**** start upd 2015/05/04 isid18 ****
*    PERFORM check_tcd USING i_st_file
PERFORM CHECK_TCD USING    I_W_INDEX
I_ST_FILE
**** end upd 2015/05/04 isid18 ****
CHANGING O_W_EFLG
O_TD_MSG.
IF O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.

* A-3-2-3．データ変換処理
**** start upd 2015/05/14 isid18 ****
*  PERFORM data_conversion CHANGING i_st_file.
PERFORM DATA_CONVERSION USING    I_W_INDEX
CHANGING I_ST_FILE
O_W_EFLG
O_TD_MSG.
IF O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
**** end upd 2015/05/14 isid18 ****

* A-3-2-2．プラントチェック
PERFORM CHECK_WERKS USING    I_W_INDEX
I_ST_FILE
CHANGING O_W_EFLG
O_TD_MSG.
IF O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

* A-3-2-4．日付形式チェック
PERFORM CHECK_DATE USING    I_W_INDEX
I_ST_FILE
CHANGING O_W_EFLG
O_TD_MSG.
IF O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

* A-3-2-5．数値形式チェック
PERFORM CHECK_NUMBER USING    I_W_INDEX
I_ST_FILE
CHANGING O_W_EFLG
O_TD_MSG.
IF O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

* A-3-2-6．相関チェック①
PERFORM CHECK_RELATION1 USING    I_W_INDEX
I_ST_FILE
CHANGING O_W_EFLG
O_TD_MSG.
IF O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

* A-3-2-7．相関チェック②
**** start del 2015/05/04 isid18 ***
*  PERFORM check_relation2 USING    i_w_index
*                                   i_st_file
*                          CHANGING o_w_eflg
*                                   o_td_msg.
*  IF o_w_eflg = abap_on.
*    RETURN.
*  ENDIF.
**** end del 2015/05/04 isid18 ****

ENDFORM.                    " CHECK_DATA

*&---------------------------------------------------------------------*
*&      Form  CHECK_TCD
*&---------------------------------------------------------------------*
*       TCDのチェック
*----------------------------------------------------------------------*
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
**** start upd 2015/05/04 isid18 ****
*FORM check_tcd  USING    i_st_file TYPE typ_file
FORM CHECK_TCD  USING    I_W_INDEX   TYPE SY-INDEX
I_ST_FILE TYPE TYP_FILE
**** end upd 2015/05/04 isid18 ****
CHANGING O_W_EFLG  TYPE C
O_TD_MSG  TYPE TYP_TD_MSG.

DATA:
LW_MSG   TYPE STRING,
LST_MSG  TYPE TYP_MSG.

**** start add 2015/05/04 isid18 ****
DATA: LW_RMSG  TYPE STRING,
LW_ROW   TYPE STRING.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
CONCATENATE TEXT-033 LW_ROW TEXT-034
TEXT-035 I_ST_FILE-ITM_NUMBER
INTO LW_RMSG SEPARATED BY SPACE.
**** end add 2015/05/04 isid18 ****

IF I_ST_FILE-TCD <> CNS_TCD1 AND
I_ST_FILE-TCD <> CNS_TCD2.
MESSAGE S090(ZMEGSD01) WITH I_ST_FILE-TCD INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
ENDIF.

ENDFORM.                    " CHECK_TCD

*&---------------------------------------------------------------------*
*&      Form  CHECK_WERKS
*&---------------------------------------------------------------------*
*       プラントチェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM CHECK_WERKS  USING    I_W_INDEX   TYPE SY-INDEX
I_ST_FILE   TYPE TYP_FILE
CHANGING O_W_EFLG    TYPE C
O_TD_MSG  TYPE TYP_TD_MSG.

DATA:
LW_MSG   TYPE STRING,
LST_MSG  TYPE TYP_MSG.

**** start add 2015/05/04 isid18 ****
DATA: LW_RMSG  TYPE STRING,
LW_ROW   TYPE STRING.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
CONCATENATE TEXT-033 LW_ROW TEXT-034
TEXT-035 I_ST_FILE-ITM_NUMBER
INTO LW_RMSG SEPARATED BY SPACE.
**** end add 2015/05/04 isid18 ****

IF I_ST_FILE-PLANT NOT IN S_WERKS.
MESSAGE S091(ZMEGSD01) WITH I_W_INDEX I_ST_FILE-PLANT
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
ENDIF.

ENDFORM.                    " CHECK_WERKS

*&---------------------------------------------------------------------*
*&      Form  DATA_CONVERSION
*&---------------------------------------------------------------------*
*       データ変換処理
*----------------------------------------------------------------------*
*      <--O_ST_FILE  ファイル データ
*----------------------------------------------------------------------*
**** start upd 2015/05/14 isid18 ****
*FORM data_conversion  CHANGING o_st_file TYPE typ_file.
FORM DATA_CONVERSION  USING    I_W_INDEX TYPE SY-INDEX
CHANGING O_ST_FILE TYPE TYP_FILE
O_W_EFLG  TYPE C
O_TD_MSG  TYPE TYP_TD_MSG.

DATA:
LW_MSG   TYPE STRING,
LST_MSG  TYPE TYP_MSG,
LW_RMSG  TYPE STRING,
LW_ROW   TYPE STRING.

LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
CONCATENATE TEXT-033 LW_ROW TEXT-034
TEXT-035 O_ST_FILE-ITM_NUMBER
INTO LW_RMSG SEPARATED BY SPACE.
**** end upd 2015/05/14 isid18 ****

* DocType
* * 大文字変換
TRANSLATE O_ST_FILE-AUART TO UPPER CASE.
*
CALL FUNCTION 'CONVERSION_EXIT_AUART_INPUT'
EXPORTING
INPUT  = O_ST_FILE-AUART
IMPORTING
OUTPUT = O_ST_FILE-AUART.

* SalesOrg
TRANSLATE O_ST_FILE-VKORG TO UPPER CASE.

* DistChannel
TRANSLATE O_ST_FILE-VTWEG TO UPPER CASE.

* Division
TRANSLATE O_ST_FILE-SPART TO UPPER CASE.

* SalesOffice
TRANSLATE O_ST_FILE-VKBUR TO UPPER CASE.

* SalesGrp
TRANSLATE O_ST_FILE-VKGRP TO UPPER CASE.

* SONo
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-VBELN
IMPORTING
OUTPUT = O_ST_FILE-VBELN.

* ShipBlock
TRANSLATE O_ST_FILE-LIFSK TO UPPER CASE.

* OrderReason
TRANSLATE O_ST_FILE-AUGRU TO UPPER CASE.

* SoldTo
TRANSLATE O_ST_FILE-SOLDTO TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-SOLDTO
IMPORTING
OUTPUT = O_ST_FILE-SOLDTO.

* ShipTo
TRANSLATE O_ST_FILE-SHIPTO TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-SHIPTO
IMPORTING
OUTPUT = O_ST_FILE-SHIPTO.

* ShipToCountryCode
TRANSLATE O_ST_FILE-COUNTR_ISO TO UPPER CASE.

* BillTo
TRANSLATE O_ST_FILE-BILLTO TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-BILLTO
IMPORTING
OUTPUT = O_ST_FILE-BILLTO.

* Payer
TRANSLATE O_ST_FILE-PAYER TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-PAYER
IMPORTING
OUTPUT = O_ST_FILE-PAYER.

* SalesEmployee
TRANSLATE O_ST_FILE-SAEMP TO UPPER CASE.

* EndUserPrice
TRANSLATE O_ST_FILE-EDUPRI TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-EDUPRI
IMPORTING
OUTPUT = O_ST_FILE-EDUPRI.

* EndUserExport
TRANSLATE O_ST_FILE-EDUEXP TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
EXPORTING
INPUT  = O_ST_FILE-EDUEXP
IMPORTING
OUTPUT = O_ST_FILE-EDUEXP.

* SalesAssistant
TRANSLATE O_ST_FILE-SAASSIS TO UPPER CASE.

**** start add 2015/05/04 isid18 ****
* PaymentTerms
TRANSLATE O_ST_FILE-ZTERM TO UPPER CASE.
* ItemCategory
TRANSLATE O_ST_FILE-PSTYV TO UPPER CASE.
**** end add 2015/05/04 isid18 ****

* Material
TRANSLATE O_ST_FILE-MATERIAL TO UPPER CASE.
CALL FUNCTION 'CONVERSION_EXIT_MATN1_INPUT'
EXPORTING
INPUT        = O_ST_FILE-MATERIAL
IMPORTING
OUTPUT       = O_ST_FILE-MATERIAL
EXCEPTIONS
**** start upd 2015/05/14 isid18 ****
*      length_error = 0
*      OTHERS       = 0.
LENGTH_ERROR = 1
OTHERS       = 2.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
**** end upd 2015/05/14 isid18 ****

* Plant
TRANSLATE O_ST_FILE-PLANT TO UPPER CASE.

* SLoc
TRANSLATE O_ST_FILE-STORE_LOC TO UPPER CASE.

* CondType
TRANSLATE O_ST_FILE-COND_TYPE TO UPPER CASE.

**** start add 2015/05/14 isid18 ****
* OrderUnit
CALL FUNCTION 'CONVERSION_EXIT_CUNIT_INPUT'
EXPORTING
INPUT          = O_ST_FILE-COND_UNIT
IMPORTING
OUTPUT         = O_ST_FILE-COND_UNIT
EXCEPTIONS
UNIT_NOT_FOUND = 1
OTHERS         = 2.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
**** end add 2015/05/14 isid18 ****

**** start add 2015/05/04 isid18 ****
* RejectReason
TRANSLATE O_ST_FILE-REASON_REJ TO UPPER CASE.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " DATA_CONVERSION

*&---------------------------------------------------------------------*
*&      Form  CHECK_DATE
*&---------------------------------------------------------------------*
*       日付形式チェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM CHECK_DATE  USING    I_W_INDEX   TYPE SY-INDEX
I_ST_FILE   TYPE TYP_FILE
CHANGING O_W_EFLG    TYPE C
O_TD_MSG    TYPE TYP_TD_MSG.
DATA:
LW_MSG   TYPE STRING,
LST_MSG  TYPE TYP_MSG,
LW_DATE  TYPE SY-DATUM.

**** start add 2015/05/04 isid18 ****
DATA: LW_RMSG  TYPE STRING,
LW_ROW   TYPE STRING.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
CONCATENATE TEXT-033 LW_ROW TEXT-034
TEXT-035 I_ST_FILE-ITM_NUMBER
INTO LW_RMSG SEPARATED BY SPACE.
**** end add 2015/05/04 isid18 ****

* CustPurchDate
IF I_ST_FILE-BSTDK IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND I_ST_FILE-BSTDK <> SPACE.
**** end add 2015/05/15 isid18 ****
LW_DATE = I_ST_FILE-BSTDK.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
DATE                      = LW_DATE
EXCEPTIONS
PLAUSIBILITY_CHECK_FAILED = 1
OTHERS                    = 2.
IF SY-SUBRC <> 0.
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S092(ZMEGSD01) WITH I_W_INDEX TEXT-E02
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.

* DocDate
IF I_ST_FILE-AUDAT IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND I_ST_FILE-AUDAT <> SPACE.
**** end add 2015/05/15 isid18 ****
LW_DATE = I_ST_FILE-AUDAT.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
DATE                      = LW_DATE
EXCEPTIONS
PLAUSIBILITY_CHECK_FAILED = 1
OTHERS                    = 2.
IF SY-SUBRC <> 0.
MESSAGE S092(ZMEGSD01) WITH I_W_INDEX TEXT-E03
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.

* PriceDate
IF I_ST_FILE-PRSDT IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND I_ST_FILE-PRSDT <> SPACE.
**** end add 2015/05/15 isid18 ****
LW_DATE = I_ST_FILE-PRSDT.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
DATE                      = LW_DATE
EXCEPTIONS
PLAUSIBILITY_CHECK_FAILED = 1
OTHERS                    = 2.

IF SY-SUBRC <> 0.
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S092(ZMEGSD01) WITH I_W_INDEX TEXT-E04
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.

**** start add 2015/05/04 isid18 ****
IF I_ST_FILE-REQ_DATE IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND I_ST_FILE-REQ_DATE <> SPACE.
**** end add 2015/05/15 isid18 ****
LW_DATE = I_ST_FILE-REQ_DATE.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
DATE                      = LW_DATE
EXCEPTIONS
PLAUSIBILITY_CHECK_FAILED = 1
OTHERS                    = 2.
IF SY-SUBRC <> 0.
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S092(ZMEGSD01) WITH I_W_INDEX TEXT-E09
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.

IF I_ST_FILE-BSTDK_ITEM IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND I_ST_FILE-BSTDK_ITEM <> SPACE.
**** end add 2015/05/15 isid18 ****
LW_DATE = I_ST_FILE-BSTDK_ITEM.
CALL FUNCTION 'DATE_CHECK_PLAUSIBILITY'
EXPORTING
DATE                      = LW_DATE
EXCEPTIONS
PLAUSIBILITY_CHECK_FAILED = 1
OTHERS                    = 2.
IF SY-SUBRC <> 0.
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S092(ZMEGSD01) WITH I_W_INDEX TEXT-E08
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.
ENDIF.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " CHECK_DATE

*&---------------------------------------------------------------------*
*&      Form  CHECK_NUMBER
*&---------------------------------------------------------------------*
*       数値形式チェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM CHECK_NUMBER  USING    I_W_INDEX   TYPE SY-INDEX
I_ST_FILE   TYPE TYP_FILE
CHANGING O_W_EFLG    TYPE C
O_TD_MSG    TYPE TYP_TD_MSG.

DATA:
LW_MSG   TYPE STRING,
LST_MSG  TYPE TYP_MSG,
**** START ADD BY ISID REN 2015/05/27 ****
LW_S     TYPE STRING,
**** END ADD BY ISID REN 2015/05/27 ****
LW_HTYPE TYPE DD01V-DATATYPE.

**** start add 2015/05/04 isid18 ****
DATA: LW_RMSG  TYPE STRING,
LW_ROW   TYPE STRING.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
CONCATENATE TEXT-033 LW_ROW TEXT-034
TEXT-035 I_ST_FILE-ITM_NUMBER
INTO LW_RMSG SEPARATED BY SPACE.
**** end add 2015/05/04 isid18 ****

* SOQty
**** start upd 2015/05/26 isid18 ****
*  CALL FUNCTION 'NUMERIC_CHECK'
*    EXPORTING
*      string_in = i_st_file-req_qty
*    IMPORTING
*      htype     = lw_htype.
*  IF lw_htype <> cns_htype.
CALL FUNCTION 'ZEG_ZZ_NUMERIC_CHECK'
EXPORTING
IMPNUMERIC = I_ST_FILE-REQ_QTY
EXCEPTIONS
NOTNUMERIC = 1
OTHERS     = 2.
IF SY-SUBRC <> 0.
**** end upd 2015/05/26 isid18 ****
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S093(ZMEGSD01) WITH I_W_INDEX TEXT-E05
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

* NetPrice
**** start upd 2015/05/26 isid18 ****
*  CALL FUNCTION 'NUMERIC_CHECK'
*    EXPORTING
*      string_in = i_st_file-cond_value
*    IMPORTING
*      htype     = lw_htype.
*  IF lw_htype <> cns_htype.
CALL FUNCTION 'ZEG_ZZ_NUMERIC_CHECK'
EXPORTING
IMPNUMERIC = I_ST_FILE-COND_VALUE
EXCEPTIONS
NOTNUMERIC = 1
OTHERS     = 2.
IF SY-SUBRC <> 0.
**** end upd 2015/05/26 isid18 ****
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S093(ZMEGSD01) WITH I_W_INDEX TEXT-E06
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
**** start add 2015/05/26 isid18 ****
ELSE.
**** START UPD BY ISID REN 2015/05/27 ****
*   PERFORM CHECK_DECIMALS
*      USING    I_ST_FILE-WAERK
*               I_ST_FILE-COND_VALUE
*      CHANGING O_W_EFLG.
*
*    IF O_W_EFLG IS NOT INITIAL.
*      CLEAR: LW_MSG,
*             LST_MSG.
*      MESSAGE S011(00) INTO LW_MSG.
*    CONCATENATE LW_MSG TEXT-E10 INTO LW_MSG.
*    LST_MSG-COL1 = TEXT-007.
*    LST_MSG-COL2 = TEXT-008.
*    LST_MSG-COL3 = LW_RMSG.
*    LST_MSG-COL4 = LW_MSG.
*    APPEND LST_MSG TO O_TD_MSG.
*    RETURN.
CLEAR: LW_MSG,
LST_MSG.
LW_S = I_ST_FILE-COND_VALUE.
CALL FUNCTION 'ZEG_ZZ_CURRENCY_DECIMALS_CHK'
EXPORTING
IMPWAERS = I_ST_FILE-WAERK
IMPVALUE = LW_S
EXCEPTIONS
ERROR    = 1
OTHERS   = 2.

IF SY-SUBRC <> 0.
MESSAGE ID   SY-MSGID
TYPE   SY-MSGTY
NUMBER SY-MSGNO
WITH   SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
INTO   LW_MSG.
CONCATENATE LW_MSG TEXT-E10 INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
**** END UPD BY ISID REN 2015/05/27 ****
ENDIF.
**** end add 2015/05/26 isid18 ****
ENDIF.

* PriceUnit
CALL FUNCTION 'NUMERIC_CHECK'
EXPORTING
STRING_IN = I_ST_FILE-COND_P_UNT
IMPORTING
HTYPE     = LW_HTYPE.
IF LW_HTYPE <> CNS_HTYPE.
CLEAR: LW_MSG,
LST_MSG.
MESSAGE S093(ZMEGSD01) WITH I_W_INDEX TEXT-E07
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*    lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

ENDFORM.                    " CHECK_NUMBER
*&---------------------------------------------------------------------*
*&      Form  CHECK_RELATION1
*&---------------------------------------------------------------------*
*       相関チェック①
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
FORM CHECK_RELATION1  USING    I_W_INDEX   TYPE SY-INDEX
I_ST_FILE   TYPE TYP_FILE
CHANGING O_W_EFLG    TYPE C
O_TD_MSG    TYPE TYP_TD_MSG.

DATA:
LW_MSG   TYPE STRING,
LST_MSG  TYPE TYP_MSG.

**** start add 2015/05/04 isid18 ****
DATA: LW_RMSG  TYPE STRING,
LW_ROW   TYPE STRING.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
CONCATENATE TEXT-033 LW_ROW TEXT-034
TEXT-035 I_ST_FILE-ITM_NUMBER
INTO LW_RMSG SEPARATED BY SPACE.
**** end add 2015/05/04 isid18 ****

* NetPriceCurrency, NetPrice,PriceUnit check
**** start upd 2015/05/15 isid18 ****
*  IF i_st_file-waerk IS NOT INITIAL OR
*     i_st_file-cond_value IS NOT INITIAL OR
*     i_st_file-cond_p_unt IS NOT INITIAL.
*
*    IF i_st_file-waerk IS INITIAL OR
*     i_st_file-cond_value IS INITIAL OR
*     i_st_file-cond_p_unt IS INITIAL.
IF I_ST_FILE-COND_VALUE IS NOT INITIAL OR
I_ST_FILE-COND_P_UNT IS NOT INITIAL.
IF I_ST_FILE-WAERK IS INITIAL.
**** end upd 2015/05/15 isid18 ****
MESSAGE S094(ZMEGSD01) WITH I_W_INDEX
INTO LW_MSG.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-008.
**** start upd 2015/05/04 isid18 ****
*      lst_msg-col3 = lw_msg.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
**** end upd 2015/05/04 isid18 ****
APPEND LST_MSG TO O_TD_MSG.
O_W_EFLG = ABAP_ON.
RETURN.
ENDIF.

ENDIF.

ENDFORM.                    " CHECK_RELATION1

*&---------------------------------------------------------------------*
*&      Form  CHECK_RELATION2
*&---------------------------------------------------------------------*
*       相関チェック②
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*      <--O_W_EFLG   Error Flag
*      <--O_TD_MSG   Error message table
*----------------------------------------------------------------------*
**** start del 2015/05/04 isid18 ****
*FORM check_relation2  USING    i_w_index   TYPE sy-index
*                               i_st_file   TYPE typ_file
*                      CHANGING o_w_eflg    TYPE c
*                               o_td_msg    TYPE typ_td_msg.
*
*  DATA:
*    lw_msg   TYPE string,
*    lst_msg  TYPE typ_msg.
*
** TextLanguage check
*  IF i_st_file-inbrem  IS NOT INITIAL OR
*     i_st_file-tabrem  IS NOT INITIAL OR
*     i_st_file-sorem   IS NOT INITIAL OR
*     i_st_file-itemrem IS NOT INITIAL.
*
*    IF i_st_file-langu_iso IS INITIAL.
*      MESSAGE s095(zmegsd01) WITH i_w_index
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-008.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*      o_w_eflg = abap_on.
*      RETURN.
*    ENDIF.
*
*  ENDIF.
*
*ENDFORM.                    " CHECK_RELATION2
**** end del 2015/05/04 isid18 ****
*&---------------------------------------------------------------------*
*&      Form  SO_CREATE_EDIT
*&---------------------------------------------------------------------*
*       A-4-1-1．BAPIのパラメータ設定
*----------------------------------------------------------------------*
*      -->I_ST_FILE
*      <--o_st_soheader
*      <--o_st_soheaderx
*      <--o_td_soitem
*      <--o_td_soitemx
*      <--o_td_parnr
*      <--o_td_soschedule
*      <--o_td_soschedulex
*      <--o_td_socondition
*      <--o_td_soconditionx
*      <--o_td_sotext
*----------------------------------------------------------------------*
FORM SO_CREATE_EDIT  USING    I_ST_FILE  TYPE TYP_FILE
CHANGING O_ST_SOHEADER     TYPE BAPISDHD1
O_ST_SOHEADERX    TYPE BAPISDHD1X
O_TD_SOITEM       TYPE TYP_TD_SOITEM
O_TD_SOITEMX      TYPE TYP_TD_SOITEMX
O_TD_PARNR        TYPE TYP_TD_PARNR
O_TD_SOSCHEDULE   TYPE TYP_TD_SOSCHEDULE
O_TD_SOSCHEDULEX  TYPE TYP_TD_SOSCHEDULEX
O_TD_SOCONDITION  TYPE TYP_TD_SOCONDITION
O_TD_SOCONDITIONX TYPE TYP_TD_SOCONDITIONX
O_TD_SOTEXT       TYPE TYP_TD_SOTEXT.

DATA:
**** START ADD 2015/06/29 ISID18 ****
LW_SPRAS         TYPE KNA1-SPRAS,
**** END ADD 2015/06/29 ISID18 ****
LST_SOITEM       TYPE BAPISDITM,      "Item Data
LST_SOITEMX      TYPE BAPISDITMX,     "Item Data Checkbox
LST_PARNR        TYPE BAPIPARNR,      "Document Partner
LST_SOSCHEDULE   TYPE BAPISCHDL,      "Schedule Line Data
LST_SOSCHEDULEX  TYPE BAPISCHDLX,     "Checkbox Schedule Line Data
LST_SOCONDITION  TYPE BAPICOND,       "Conditions
LST_SOCONDITIONX TYPE BAPICONDX,      "Conditions Checkbox
LST_SOTEXT       TYPE BAPISDTEXT.     "Texts

**** START ADD 2015/06/29 ISID18 ****
* 得意先コード言語キー取得
SELECT SINGLE SPRAS
INTO LW_SPRAS
FROM KNA1
WHERE KUNNR = I_ST_FILE-SOLDTO.
**** END ADD 2015/06/29 ISID18 ****

* A-4-1-1．BAPIのパラメータ設定
IF O_ST_SOHEADER IS INITIAL.
*   Order Header
O_ST_SOHEADER-DOC_TYPE   = I_ST_FILE-AUART.   "販売伝票タイプ
O_ST_SOHEADER-COLLECT_NO = I_ST_FILE-SUBMI.   "一括番号 (見積依頼/見積書)
O_ST_SOHEADER-SALES_ORG  = I_ST_FILE-VKORG.   "販売組織
O_ST_SOHEADER-DISTR_CHAN = I_ST_FILE-VTWEG.   "流通チャネル
O_ST_SOHEADER-DIVISION   = I_ST_FILE-SPART.   "製品部門
O_ST_SOHEADER-SALES_GRP  = I_ST_FILE-VKGRP.   "営業グループ
O_ST_SOHEADER-SALES_OFF  = I_ST_FILE-VKBUR.   "営業所
O_ST_SOHEADER-PURCH_DATE = I_ST_FILE-BSTDK.   "得意先発注日付
**** start add 2015/05/04 isid18 ****
O_ST_SOHEADER-NAME       = I_ST_FILE-BNAME.   "発注者名称
O_ST_SOHEADER-PMNTTRMS   = I_ST_FILE-ZTERM.   "支払条件キー
**** end add 2015/05/04 isid18 ****
O_ST_SOHEADER-DLV_BLOCK  = I_ST_FILE-LIFSK.   "出荷ブロック (伝票ヘッダ)
O_ST_SOHEADER-ORD_REASON = I_ST_FILE-AUGRU.   "受注理由 (取引理由)
O_ST_SOHEADER-PRICE_DATE = I_ST_FILE-PRSDT.   "価格設定/換算レートの実施日付
O_ST_SOHEADER-PURCH_NO_C = I_ST_FILE-BSTKD.   "得意先発注番号
O_ST_SOHEADER-DOC_DATE   = I_ST_FILE-AUDAT.   "伝票日付 (受信日/送信日)

**** START ADD 2015/06/05 ISID18 ****
IF I_ST_FILE-WAERK IS NOT INITIAL.
O_ST_SOHEADER-CURRENCY = I_ST_FILE-WAERK.   "通貨コード
ENDIF.
**** END ADD 2015/06/05 ISID18 ****

O_ST_SOHEADERX-DOC_TYPE   = ABAP_ON.          "販売伝票タイプ
IF O_ST_SOHEADER-COLLECT_NO IS NOT INITIAL.
O_ST_SOHEADERX-COLLECT_NO = ABAP_ON.          "一括番号 (見積依頼/見積書)
ENDIF.
O_ST_SOHEADERX-SALES_ORG  = ABAP_ON.          "販売組織
O_ST_SOHEADERX-DISTR_CHAN = ABAP_ON.          "流通チャネル
O_ST_SOHEADERX-DIVISION   = ABAP_ON.          "製品部門
O_ST_SOHEADERX-SALES_GRP  = ABAP_ON.          "営業グループ
O_ST_SOHEADERX-SALES_OFF  = ABAP_ON.          "営業所
O_ST_SOHEADERX-PURCH_DATE = ABAP_ON.          "得意先発注日付
**** start add 2015/05/04 isid18 ****
IF O_ST_SOHEADER-NAME IS NOT INITIAL.
O_ST_SOHEADERX-NAME = ABAP_ON.              "発注者名称
ENDIF.
O_ST_SOHEADERX-PMNTTRMS = ABAP_ON.            "支払条件キー
**** end add 2015/05/04 isid18 ****
IF O_ST_SOHEADER-DLV_BLOCK IS NOT INITIAL.
O_ST_SOHEADERX-DLV_BLOCK  = ABAP_ON.          "出荷ブロック (伝票ヘッダ)
ENDIF.
IF O_ST_SOHEADER-ORD_REASON IS NOT INITIAL.
O_ST_SOHEADERX-ORD_REASON = ABAP_ON.          "受注理由 (取引理由)
ENDIF.
O_ST_SOHEADERX-PRICE_DATE = ABAP_ON.          "価格設定/換算レートの実施日付
O_ST_SOHEADERX-PURCH_NO_C = ABAP_ON.          "得意先発注番号
O_ST_SOHEADERX-DOC_DATE   = ABAP_ON.          "伝票日付 (受信日/送信日)
**** START ADD 2015/06/05 ISID18 ****
IF O_ST_SOHEADER-CURRENCY IS NOT INITIAL.
O_ST_SOHEADERX-CURRENCY   = ABAP_ON.
ENDIF.
**** END ADD 2015/06/05 ISID18 ****

*   Document Partner
**** start add 2015/05/04 isid18 ****
IF I_ST_FILE-SOLDTO IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_AG.          "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-SOLDTO.      "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-SHIPTO IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_WE.          "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-SHIPTO.      "得意先コード
LST_PARNR-NAME       = I_ST_FILE-SHIP_NAME.   "名称 1
LST_PARNR-NAME_2     = I_ST_FILE-SHIP_NAME2.  "名称 2
LST_PARNR-NAME_3     = I_ST_FILE-SHIP_NAME3.  "名称 3
LST_PARNR-STREET     = I_ST_FILE-STREET.      "地名/番地-号
LST_PARNR-COUNTR_ISO = I_ST_FILE-COUNTR_ISO.  "国キー (ISO コード)
LST_PARNR-POSTL_CODE = I_ST_FILE-POSTL_CODE.  "郵便番号
LST_PARNR-CITY       = I_ST_FILE-CITY.        "市区町村
LST_PARNR-TELEPHONE  = I_ST_FILE-TELEPHONE.   "電話番号 1
LST_PARNR-FAX_NUMBER = I_ST_FILE-FAX_NUMBER.  "FAX 番号
APPEND LST_PARNR TO O_TD_PARNR.
CLEAR LST_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-BILLTO IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_RE.          "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-BILLTO.      "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-PAYER IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_RG.          "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-PAYER.      "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-SAEMP IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_VE.         "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-SAEMP.      "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-EDUPRI IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_ZE.         "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-EDUPRI.     "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-EDUEXP IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_ZJ.         "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-EDUEXP.     "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.

**** start add 2015/05/04 isid18 ****
ENDIF.
IF I_ST_FILE-SAASSIS IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****
LST_PARNR-PARTN_ROLE = CNS_PARNR_ZP.         "取引先機能
LST_PARNR-PARTN_NUMB = I_ST_FILE-SAASSIS.    "得意先コード
APPEND LST_PARNR TO O_TD_PARNR.
**** start add 2015/05/04 isid18 ****
ENDIF.
**** end add 2015/05/04 isid18 ****

*   Texts
IF I_ST_FILE-INBREM IS NOT INITIAL.
CLEAR LST_SOTEXT-ITM_NUMBER.                 "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_0001.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*      LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.          "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-INBREM.    "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*    IF i_st_file-inbrem IS NOT INITIAL.
IF I_ST_FILE-TABREM IS NOT INITIAL.
**** end upd 2015/05/04 isid18 ****
CLEAR LST_SOTEXT-ITM_NUMBER.                 "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_0002.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*      LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.          "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-TABREM.    "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*    IF i_st_file-inbrem IS NOT INITIAL.
IF I_ST_FILE-SOREM IS NOT INITIAL.
**** end upd 2015/05/04 isid18 ****
CLEAR LST_SOTEXT-ITM_NUMBER.                 "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_Z010.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*      LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.          "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-SOREM.     "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.
ENDIF.

* Item Data
LST_SOITEM-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.   "販売伝票明細
LST_SOITEM-MATERIAL   = I_ST_FILE-MATERIAL.     "品目コード
**** start add 2015/05/04 isid18 ****
LST_SOITEM-REASON_REJ = I_ST_FILE-REASON_REJ.   "拒否理由
**** end add 2015/05/04 isid18 ****
LST_SOITEM-PLANT      = I_ST_FILE-PLANT.        "プラント
LST_SOITEM-STORE_LOC  = I_ST_FILE-STORE_LOC.    "保管場所
**** start add 2015/05/04 isid18 ****
LST_SOITEM-ITEM_CATEG = I_ST_FILE-PSTYV.        "明細カテゴリ
**** end add 2015/05/04 isid18 ****
LST_SOITEM-SHORT_TEXT = I_ST_FILE-SHORT_TEXT.   "受注明細のテキスト (短)
**** start upd 2015/05/04 isid18 ****
*  lst_soitem-purch_no_c = i_st_file-bstkd.        "得意先発注番号
*  lst_soitem-purch_date = i_st_file-bstdk.        "得意先発注日付
LST_SOITEM-PURCH_NO_C = I_ST_FILE-BSTKD_ITEM.   "得意先発注番号
LST_SOITEM-PURCH_DATE = I_ST_FILE-BSTDK_ITEM.   "得意先発注日付
LST_SOITEM-TARGET_QTY = I_ST_FILE-REQ_QTY.      "目標数量
**** end upd 2015/05/04 isid18 ****
APPEND LST_SOITEM TO O_TD_SOITEM.

LST_SOITEMX-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.   "販売伝票明細
LST_SOITEMX-MATERIAL   = ABAP_ON.               "品目コード
**** start add 2015/05/04 isid18 ****
IF LST_SOITEM-REASON_REJ IS NOT INITIAL.
LST_SOITEMX-REASON_REJ = ABAP_ON.             "拒否理由
ENDIF.
**** end add 2015/05/04 isid18 ****
LST_SOITEMX-PLANT      = ABAP_ON.               "プラント
IF LST_SOITEM-STORE_LOC IS NOT INITIAL.
LST_SOITEMX-STORE_LOC  = ABAP_ON.               "保管場所
ENDIF.
**** start add 2015/05/04 isid18 ****
IF LST_SOITEM-ITEM_CATEG IS NOT INITIAL.
LST_SOITEMX-ITEM_CATEG = ABAP_ON.               "明細カテゴリ
ENDIF.
**** end add 2015/05/04 isid18 ****
IF LST_SOITEM-SHORT_TEXT IS NOT INITIAL.
LST_SOITEMX-SHORT_TEXT = ABAP_ON.               "受注明細のテキスト (短)
ENDIF.
**** start upd 2015/05/04 isid18 ****
*  lst_soitemx-purch_no_c = abap_on.               "得意先発注番号
*  lst_soitemx-purch_date = abap_on.               "得意先発注日付
IF LST_SOITEM-PURCH_NO_C IS NOT INITIAL.
LST_SOITEMX-PURCH_NO_C = ABAP_ON.
ENDIF.
IF LST_SOITEM-PURCH_DATE IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND LST_SOITEM-PURCH_DATE <> SPACE.
**** end add 2015/05/15 isid18 ****
LST_SOITEMX-PURCH_DATE = ABAP_ON.              "得意先発注日付
ENDIF.
IF LST_SOITEM-TARGET_QTY IS NOT INITIAL.
LST_SOITEMX-TARGET_QTY = ABAP_ON.              "目標数量
ENDIF.
**** end upd 2015/05/04 isid18 ****
APPEND LST_SOITEMX TO O_TD_SOITEMX.

* Schedule Line Data
LST_SOSCHEDULE-ITM_NUMBER = I_ST_FILE-ITM_NUMBER. "購買伝票の明細番号
LST_SOSCHEDULE-SCHED_LINE = CNS_SCHED.            "納入日程行
LST_SOSCHEDULE-REQ_DATE   = I_ST_FILE-REQ_DATE.   "納入日付
**** start add 2015/05/04 isid18 ****
LST_SOSCHEDULE-DATE_TYPE  = CNS_DATE_TYPE.        "日付タイプ
**** end add 2015/05/04 isid18 ****
LST_SOSCHEDULE-REQ_QTY    = I_ST_FILE-REQ_QTY.    "計画数量
APPEND LST_SOSCHEDULE TO O_TD_SOSCHEDULE.

LST_SOSCHEDULEX-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.  "購買伝票の明細番号
LST_SOSCHEDULEX-SCHED_LINE = ABAP_ON.               "納入日程行
LST_SOSCHEDULEX-REQ_DATE   = ABAP_ON.               "納入期日カテゴリ
**** start add 2015/05/04 isid18 ****
LST_SOSCHEDULEX-DATE_TYPE  = ABAP_ON.               "日付タイプ
**** end add 2015/05/04 isid18 ****
LST_SOSCHEDULEX-REQ_QTY    = ABAP_ON.               "計画数量
APPEND LST_SOSCHEDULEX TO O_TD_SOSCHEDULEX.

* Conditions
LST_SOCONDITION-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.  "販売伝票明細
LST_SOCONDITION-COND_TYPE  = I_ST_FILE-COND_TYPE.   "条件タイプ
LST_SOCONDITION-COND_VALUE = I_ST_FILE-COND_VALUE.  "条件レート
LST_SOCONDITION-CURRENCY   = I_ST_FILE-WAERK.       "通貨コード
LST_SOCONDITION-COND_UNIT  = I_ST_FILE-COND_UNIT.   "条件単位
LST_SOCONDITION-COND_P_UNT = I_ST_FILE-COND_P_UNT.  "価格条件単位
APPEND LST_SOCONDITION TO O_TD_SOCONDITION.

LST_SOCONDITIONX-ITM_NUMBER = I_ST_FILE-ITM_NUMBER. "販売伝票明細
IF LST_SOCONDITION-COND_TYPE IS NOT INITIAL.
LST_SOCONDITIONX-COND_TYPE  = ABAP_ON.              "条件タイプ
ENDIF.
IF LST_SOCONDITION-COND_VALUE IS NOT INITIAL.
LST_SOCONDITIONX-COND_VALUE = ABAP_ON.              "条件レート
ENDIF.
IF LST_SOCONDITION-CURRENCY IS NOT INITIAL.
LST_SOCONDITIONX-CURRENCY   = ABAP_ON.              "通貨コード
ENDIF.
LST_SOCONDITIONX-COND_UNIT  = ABAP_ON.              "条件単位
IF LST_SOCONDITION-COND_P_UNT IS NOT INITIAL.
LST_SOCONDITIONX-COND_P_UNT = ABAP_ON.              "価格条件単位
ENDIF.
APPEND LST_SOCONDITIONX TO O_TD_SOCONDITIONX.

* Texts
IF I_ST_FILE-ITEMREM IS NOT INITIAL.
LST_SOTEXT-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.       "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_9001.              "テキスト ID
**** start upd 2015/05/04 isid18 ****
*    lst_sotext-langu_iso  = i_st_file-langu_iso.        "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*    LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.                 "タグ列
LST_SOTEXT-TEXT_LINE = I_ST_FILE-ITEMREM.           "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.

**** start of add 2015/05/04 isid18 ****
* Texts
IF I_ST_FILE-TRANSREM IS NOT INITIAL.
LST_SOTEXT-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.        "販売伝票明細
**** START UPD 2015/06/05 ISID18 ****
*    LST_SOTEXT-TEXT_ID = CNS_TDID_Z910.                  "テキスト ID
LST_SOTEXT-TEXT_ID = CNS_TDID_0002.                  "テキスト ID
**** END UPD 2015/06/05 ISID18 ****
**** START UPD 2015/06/29 ISID18 ****
*    LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.                  "タグ列
LST_SOTEXT-TEXT_LINE = I_ST_FILE-TRANSREM.           "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.
**** end of add 2015/05/04 isid18 ****

ENDFORM.                    " SO_CREATE_EDIT

*&---------------------------------------------------------------------*
*&      Form  SO_CREATE_EXECUTE
*&---------------------------------------------------------------------*
*       BAPIの実行
*----------------------------------------------------------------------*
*      -->I_w_INTEX           Index
*      -->i_st_soheader       Order Header
*      -->i_st_soheaderx      Sales Order Check List
*      -->i_td_soitem         Item Data
*      -->i_td_soitemx        Item Data Checkbox
*      -->i_td_parnr          Document Partner
*      -->i_td_soschedule     Schedule Line Data
*      -->i_td_soschedulex    Checkbox Schedule Line Data
*      -->i_td_socondition    Conditions
*      -->i_td_soconditionx   Conditions Checkbox
*      -->i_td_sotext         Texts
*      <--O_W_EFLG            Error Flag
*      <--O_TD_MSG            Error message table
*----------------------------------------------------------------------*
FORM SO_CREATE_EXECUTE  USING
I_W_INDEX            TYPE SY-INDEX
**** start upd 2015/05/04 isid18 ****
*                        i_st_soheader        TYPE bapisdhd1
*                        i_st_soheaderx       TYPE bapisdhd1x
I_W_BUSTYPE          TYPE BAPIUSW01-OBJTYPE
VALUE(I_ST_SOHEADER) TYPE BAPISDHD1
VALUE(I_ST_SOHEADERX) TYPE BAPISDHD1X
**** end upd 2015/05/04 isid18 ****
I_TD_SOITEM          TYPE TYP_TD_SOITEM
I_TD_SOITEMX         TYPE TYP_TD_SOITEMX
I_TD_PARNR           TYPE TYP_TD_PARNR
I_TD_SOSCHEDULE      TYPE TYP_TD_SOSCHEDULE
I_TD_SOSCHEDULEX     TYPE TYP_TD_SOSCHEDULEX
I_TD_SOCONDITION     TYPE TYP_TD_SOCONDITION
I_TD_SOCONDITIONX    TYPE TYP_TD_SOCONDITIONX
I_TD_SOTEXT          TYPE TYP_TD_SOTEXT
CHANGING O_W_EFLG    TYPE C
O_TD_MSG    TYPE TYP_TD_MSG.
DATA:
LW_TRUN     TYPE BAPIFLAG-BAPIFLAG,
LW_SO       TYPE BAPIVBELN-VBELN,
LTD_RETURN  TYPE TABLE OF BAPIRET2,
LST_RETURN  TYPE BAPIRET2,
LW_MSG      TYPE STRING,
**** start add 2015/05/04 isid18 ****
LW_RMSG     TYPE STRING,
LW_INDEX    TYPE INT4,
LW_ITEM     TYPE CHAR6,
LST_SOITEM  TYPE BAPISDITM,
LTD_SCHED   TYPE TYP_TD_SOSCHEDULE,
LTH_SCHED   TYPE BAPISCHDL,
**** end add 2015/05/04 isid18 ****
LW_ROW      TYPE STRING,
LST_MSG     TYPE TYP_MSG.

IF P_TSTCK = ABAP_ON.
LW_TRUN = ABAP_ON.
ENDIF.

**** start upd 2015/05/04 isid18 ****
*  CALL FUNCTION 'BAPI_SALESORDER_CREATEFROMDAT2'
*    EXPORTING
*      order_header_in      = i_st_soheader
*      order_header_inx     = i_st_soheaderx
*      testrun              = lw_trun
*    IMPORTING
*      salesdocument        = lw_so
*    TABLES
*      return               = ltd_return
*      order_items_in       = i_td_soitem
*      order_items_inx      = i_td_soitemx
*      order_partners       = i_td_parnr
*      order_schedules_in   = i_td_soschedule
*      order_schedules_inx  = i_td_soschedulex
*      order_conditions_in  = i_td_socondition
*      order_conditions_inx = i_td_soconditionx
*      order_text           = i_td_sotext.
* Delivery Date
LTD_SCHED[] = I_TD_SOSCHEDULE.
SORT LTD_SCHED BY REQ_DATE DESCENDING.
READ TABLE LTD_SCHED INTO LTH_SCHED INDEX 1.
I_ST_SOHEADER-REQ_DATE_H = LTH_SCHED-REQ_DATE.
I_ST_SOHEADERX-REQ_DATE_H = ABAP_ON.
CALL FUNCTION 'SD_SALESDOCUMENT_CREATE'
EXPORTING
SALES_HEADER_IN      = I_ST_SOHEADER
SALES_HEADER_INX     = I_ST_SOHEADERX
BUSINESS_OBJECT      = I_W_BUSTYPE
TESTRUN              = LW_TRUN
IMPORTING
SALESDOCUMENT_EX     = LW_SO
TABLES
RETURN               = LTD_RETURN
SALES_ITEMS_IN       = I_TD_SOITEM
SALES_ITEMS_INX      = I_TD_SOITEMX
SALES_PARTNERS       = I_TD_PARNR
SALES_SCHEDULES_IN   = I_TD_SOSCHEDULE
SALES_SCHEDULES_INX  = I_TD_SOSCHEDULEX
SALES_CONDITIONS_IN  = I_TD_SOCONDITION
SALES_CONDITIONS_INX = I_TD_SOCONDITIONX
SALES_TEXT           = I_TD_SOTEXT.
**** end upd 2015/05/04 isid18 ****

**** start del 2015/05/04 isid18 ****
*  w_tnum = w_tnum + 1.      "Total number
*  lw_row = i_w_index.
**** end del 2015/05/04 isid18 ****

* Test mode
**** start upd 2015/05/04 isid18 ****
*  IF p_tstck = abap_on.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return.
*      IF lst_return-type = cns_msg_e OR
*         lst_return-type = cns_msg_a.
*        o_w_eflg = abap_on.
*      ENDIF.
**     Output check message
*      IF lst_return-id IS NOT INITIAL AND
*         lst_return-type IS NOT INITIAL AND
*         lst_return-number IS NOT INITIAL.
*        MESSAGE ID lst_return-id TYPE lst_return-type
*          NUMBER lst_return-number
*          WITH lst_return-message_v1
*               lst_return-message_v2
*               lst_return-message_v3
*               lst_return-message_v4
*           INTO lw_msg.
*        CONDENSE lw_row.
*        CONCATENATE lw_msg text-031 lw_row text-032  INTO lw_msg.
*
*        CASE sy-msgty.
*          WHEN cns_msg_e OR
*                cns_msg_a.
*            lst_msg-col2 = text-008.
*          WHEN cns_msg_w.
*            lst_msg-col2 = text-030.
*          WHEN OTHERS.
*            lst_msg-col2 = text-009.
*        ENDCASE.
*        lst_msg-col1 = text-007.
*        lst_msg-col3 = lw_msg.
*        APPEND lst_msg TO o_td_msg.
*      ENDIF.
*    ENDLOOP.
*    IF o_w_eflg = abap_on.
*      w_enum = w_enum + 1.            "Error number
*    ELSE.
*      w_snum = w_snum + 1.            "Sucessful number
*    ENDIF.
*  ELSE.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return
*        WHERE type = cns_msg_e OR
*              type = cns_msg_a.
**     データ更新に失敗しました。(ROW = &1 / MSG = &2 )
*      MESSAGE s098(zmegsd01) WITH i_w_index lst_return-message
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-008.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*      o_w_eflg = abap_on.
*      w_enum = w_enum + 1.            "Error number
*
*      CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*      EXIT.
*    ENDLOOP.
*
**   BAPIから返した「RETURN」にエラーメッセージ存在しない場合
*    IF o_w_eflg <> abap_on.
*      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*        EXPORTING
*          wait = abap_on.
*
*      w_snum = w_snum + 1.            "Sucessful number
**     データ登録が正常終了しました。(ROW = &1 / SO= &2)
*      MESSAGE s103(zmegsd01) WITH i_w_index lw_so
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-009.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*    ENDIF.
*  ENDIF.
LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E OR
TYPE = CNS_MSG_A.
O_W_EFLG = ABAP_ON.
EXIT.
ENDLOOP.

* エラーなし場合
IF O_W_EFLG IS INITIAL.
W_SNUM = W_SNUM + 1.
*   データ登録が正常終了しました。(ROW = &1 / SO= &2)
MESSAGE S103(ZMEGSD01) WITH I_W_INDEX LW_SO
INTO LW_MSG.
CLEAR LW_ROW.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.

CLEAR LST_SOITEM.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX 1.
WRITE LST_SOITEM-ITM_NUMBER TO LW_ITEM NO-ZERO.
CONDENSE LW_ITEM.

CLEAR LW_RMSG.
CONCATENATE TEXT-033 LW_ROW TEXT-034 TEXT-035
LW_ITEM
INTO LW_RMSG SEPARATED BY SPACE.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-009.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
*  Output check message
LOOP AT LTD_RETURN INTO LST_RETURN.
IF LST_RETURN-ID IS NOT INITIAL AND
LST_RETURN-TYPE IS NOT INITIAL AND
LST_RETURN-NUMBER IS NOT INITIAL.
MESSAGE ID LST_RETURN-ID TYPE LST_RETURN-TYPE
NUMBER LST_RETURN-NUMBER
WITH LST_RETURN-MESSAGE_V1
LST_RETURN-MESSAGE_V2
LST_RETURN-MESSAGE_V3
LST_RETURN-MESSAGE_V4
INTO LW_MSG.
CLEAR LW_INDEX.
CLEAR LST_SOITEM.
IF LST_RETURN-ROW > 0.
LW_INDEX = I_W_INDEX + LST_RETURN-ROW - 1.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX LST_RETURN-ROW.
ELSE.
LW_INDEX = I_W_INDEX.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX 1.
ENDIF.
CLEAR LW_ROW.
LW_ROW = LW_INDEX.
CONDENSE LW_ROW.
CLEAR LW_ITEM.
WRITE LST_SOITEM-ITM_NUMBER TO LW_ITEM NO-ZERO.
CONDENSE LW_ITEM.
CLEAR LW_RMSG.
CONCATENATE TEXT-033 LW_ROW TEXT-034 TEXT-035
LW_ITEM
INTO LW_RMSG SEPARATED BY SPACE.

CASE LST_RETURN-TYPE.
WHEN CNS_MSG_E OR
CNS_MSG_A.
LST_MSG-COL2 = TEXT-008.
WHEN CNS_MSG_W.
LST_MSG-COL2 = TEXT-030.
WHEN OTHERS.
LST_MSG-COL2 = TEXT-009.
ENDCASE.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
ENDIF.
ENDLOOP.
IF P_TSTCK <> ABAP_ON.
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
WAIT = ABAP_ON.
ENDIF.

* エラーあり
ELSE.
W_ENUM = W_ENUM + 1.
LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E OR
TYPE = CNS_MSG_A.
*     Output check message
IF LST_RETURN-ID IS NOT INITIAL AND
LST_RETURN-TYPE IS NOT INITIAL AND
LST_RETURN-NUMBER IS NOT INITIAL.
MESSAGE ID LST_RETURN-ID TYPE LST_RETURN-TYPE
NUMBER LST_RETURN-NUMBER
WITH LST_RETURN-MESSAGE_V1
LST_RETURN-MESSAGE_V2
LST_RETURN-MESSAGE_V3
LST_RETURN-MESSAGE_V4
INTO LW_MSG.
*       データ更新に失敗しました。(MSG = &1 )
MESSAGE S098(ZMEGSD01) WITH I_W_INDEX LW_MSG
INTO LW_MSG.

CLEAR LW_INDEX.
CLEAR LST_SOITEM.
IF LST_RETURN-ROW > 0.
LW_INDEX = I_W_INDEX + LST_RETURN-ROW - 1.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX LST_RETURN-ROW.
ELSE.
LW_INDEX = I_W_INDEX.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX 1.
ENDIF.
CLEAR LW_ROW.
LW_ROW = LW_INDEX.
CONDENSE LW_ROW.

CLEAR LW_ITEM.
WRITE LST_SOITEM-ITM_NUMBER TO LW_ITEM NO-ZERO.
CONDENSE LW_ITEM.

CLEAR LW_RMSG.
CONCATENATE TEXT-033 LW_ROW TEXT-034 TEXT-035
LW_ITEM
INTO LW_RMSG SEPARATED BY SPACE.

CASE LST_RETURN-TYPE.
WHEN CNS_MSG_E OR
CNS_MSG_A.
LST_MSG-COL2 = TEXT-008.
WHEN CNS_MSG_W.
LST_MSG-COL2 = TEXT-030.
WHEN OTHERS.
LST_MSG-COL2 = TEXT-009.
ENDCASE.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
ENDIF.
ENDLOOP.
IF P_TSTCK <> ABAP_ON.
CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
ENDIF.
ENDIF.
**** end upd 2015/05/04 isid18 ****

ENDFORM.                    " SO_CREATE_EXECUTE

*&---------------------------------------------------------------------*
*&      Form  SO_CHANGE_EDIT
*&---------------------------------------------------------------------*
*       A-4-1-1．BAPIのパラメータ設定
*----------------------------------------------------------------------*
*      -->I_ST_FILE  text
*      <--o_w_vbeln
*      <--o_st_soheader
*      <--o_st_soheaderx
*      <--o_td_soitem
*      <--o_td_soitemx
*      <--o_td_parnrc
*      <--o_td_parnrad
*      <--o_td_soschedule
*      <--o_td_soschedulex
*      <--o_td_socondition
*      <--o_td_soconditionx
*      <--o_td_sotext
*----------------------------------------------------------------------*
FORM SO_CHANGE_EDIT  USING    I_ST_FILE  TYPE TYP_FILE
CHANGING O_W_VBELN         TYPE BAPIVBELN-VBELN
**** start upd 2015/05/04 isid18 ****
*                     o_st_soheader     TYPE bapisdh1
*                     o_st_soheaderx    TYPE bapisdh1x
O_W_AUART         TYPE CHAR4
O_ST_SOHEADER     TYPE BAPISDHD1
O_ST_SOHEADERX    TYPE BAPISDHD1X
**** end upd 2015/05/04 isid18 ****
O_TD_SOITEM       TYPE TYP_TD_SOITEM
O_TD_SOITEMX      TYPE TYP_TD_SOITEMX
O_TD_PARNRC       TYPE TYP_TD_PARNRC
O_TD_PARNRAD      TYPE TYP_TD_PARNRAD
O_TD_SOSCHEDULE   TYPE TYP_TD_SOSCHEDULE
O_TD_SOSCHEDULEX  TYPE TYP_TD_SOSCHEDULEX
O_TD_SOCONDITION  TYPE TYP_TD_SOCONDITION
O_TD_SOCONDITIONX TYPE TYP_TD_SOCONDITIONX
O_TD_SOTEXT       TYPE TYP_TD_SOTEXT.

DATA:
**** start add 2015/05/04 isid18 ****
LW_ITEM_NUM      TYPE POSNR,          "ItemNumber
**** end add 2015/05/04 isid18 ****
**** START ADD 2015/06/29 ISID18 ****
LW_SPRAS         TYPE KNA1-SPRAS,
**** END ADD 2015/06/29 ISID18 ****
LST_SOITEM       TYPE BAPISDITM,      "Item Data
LST_SOITEMX      TYPE BAPISDITMX,     "Item Data Checkbox
LST_PARNRC       TYPE BAPIPARNRC,     "Document Partner Change
LST_PARNRAD      TYPE BAPIADDR1,      "Partner Address
LST_SOSCHEDULE   TYPE BAPISCHDL,      "Schedule Line Data
LST_SOSCHEDULEX  TYPE BAPISCHDLX,     "Checkbox Schedule Line Data
LST_SOCONDITION  TYPE BAPICOND,       "Conditions
LST_SOCONDITIONX TYPE BAPICONDX,      "Conditions Checkbox
LST_SOTEXT       TYPE BAPISDTEXT.     "Texts

**** START ADD 2015/06/29 ISID18 ****
* 言語キー取得
SELECT SINGLE SPRAS
INTO LW_SPRAS
FROM KNA1 AS KNA1
INNER JOIN VBAK AS VBAK
ON KNA1~KUNNR = VBAK~KUNNR
WHERE VBAK~VBELN = I_ST_FILE-VBELN.
**** END ADD 2015/06/29 ISID18 ****

* A-4-2-1．BAPIのパラメータ設定
IF O_ST_SOHEADER IS INITIAL.
*   SONo
O_W_VBELN = I_ST_FILE-VBELN.
**** start add 2015/05/04 isid18 ****
O_W_AUART = I_ST_FILE-AUART.
IF O_W_AUART IS INITIAL.
SELECT SINGLE AUART
FROM VBAK
INTO O_W_AUART
WHERE VBELN = O_W_VBELN.
ENDIF.
CALL FUNCTION 'CONVERSION_EXIT_AUART_OUTPUT'
EXPORTING
INPUT  = O_W_AUART
IMPORTING
OUTPUT = O_W_AUART.
**** end add 2015/05/04 isid18 ****
*   Order Header
O_ST_SOHEADER-COLLECT_NO = I_ST_FILE-SUBMI.   "一括番号 (見積依頼/見積書)
O_ST_SOHEADER-PURCH_DATE = I_ST_FILE-BSTDK.   "得意先発注日付
O_ST_SOHEADER-DLV_BLOCK  = I_ST_FILE-LIFSK.   "出荷ブロック (伝票ヘッダ)
O_ST_SOHEADER-ORD_REASON = I_ST_FILE-AUGRU.   "受注理由 (取引理由)
O_ST_SOHEADER-PRICE_DATE = I_ST_FILE-PRSDT.   "価格設定/換算レートの実施日付
O_ST_SOHEADER-PURCH_NO_C = I_ST_FILE-BSTKD.   "得意先発注番号
O_ST_SOHEADER-DOC_DATE   = I_ST_FILE-AUDAT.   "伝票日付 (受信日/送信日)
**** start add 2015/05/04 isid18 ****
O_ST_SOHEADER-SALES_GRP  = I_ST_FILE-VKGRP.   "営業グループ
O_ST_SOHEADER-SALES_OFF  = I_ST_FILE-VKBUR.   "営業所
O_ST_SOHEADER-NAME       = I_ST_FILE-BNAME.   "発注者名称
O_ST_SOHEADER-PMNTTRMS   = I_ST_FILE-ZTERM.   "支払条件キー
**** end add 2015/05/04 isid18 ****
**** START ADD 2015/06/05 ISID18 ****
IF I_ST_FILE-WAERK IS NOT INITIAL.
O_ST_SOHEADER-CURRENCY = I_ST_FILE-WAERK.
ENDIF.
**** END ADD 2015/06/05 ISID18 ****

O_ST_SOHEADERX-UPDATEFLAG = CNS_UPDATE.       "更新区分
IF O_ST_SOHEADER-COLLECT_NO IS NOT INITIAL.
O_ST_SOHEADERX-COLLECT_NO = ABAP_ON.        "一括番号 (見積依頼/見積書)
ENDIF.
IF O_ST_SOHEADER-PURCH_DATE IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND O_ST_SOHEADER-PURCH_DATE <> SPACE.
**** end add 2015/05/15 isid18 ****
O_ST_SOHEADERX-PURCH_DATE = ABAP_ON.        "得意先発注日付
ENDIF.
IF O_ST_SOHEADER-DLV_BLOCK IS NOT INITIAL.
O_ST_SOHEADERX-DLV_BLOCK  = ABAP_ON.        "出荷ブロック (伝票ヘッダ)
ENDIF.
IF O_ST_SOHEADER-ORD_REASON IS NOT INITIAL.
O_ST_SOHEADERX-ORD_REASON = ABAP_ON.        "受注理由 (取引理由)
ENDIF.
IF O_ST_SOHEADER-PRICE_DATE IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND O_ST_SOHEADER-PRICE_DATE <> SPACE.
**** end add 2015/05/15 isid18 ****
O_ST_SOHEADERX-PRICE_DATE = ABAP_ON.        "価格設定/換算レートの実施日付
ENDIF.
IF O_ST_SOHEADER-PURCH_NO_C IS NOT INITIAL.
O_ST_SOHEADERX-PURCH_NO_C = ABAP_ON.        "得意先発注番号
ENDIF.
IF O_ST_SOHEADER-DOC_DATE IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND O_ST_SOHEADER-DOC_DATE <> SPACE.
**** end add 2015/05/15 isid18 ****
O_ST_SOHEADERX-DOC_DATE   = ABAP_ON.        "伝票日付 (受信日/送信日)
ENDIF.
**** start add 2015/05/04 isid18 ****
IF O_ST_SOHEADER-SALES_GRP IS NOT INITIAL.
O_ST_SOHEADERX-SALES_GRP  = ABAP_ON.   "営業グループ
ENDIF.
IF O_ST_SOHEADER-SALES_OFF IS NOT INITIAL.
O_ST_SOHEADERX-SALES_OFF  = ABAP_ON.   "営業所
ENDIF.
IF O_ST_SOHEADER-NAME IS NOT INITIAL.
O_ST_SOHEADERX-NAME       = ABAP_ON.   "発注者名称
ENDIF.
IF O_ST_SOHEADER-PMNTTRMS IS NOT INITIAL.
O_ST_SOHEADERX-PMNTTRMS   = ABAP_ON.   "支払条件キー
ENDIF.
**** end add 2015/05/04 isid18 ****
**** START ADD 2015/06/05 ISID18 ****
IF O_ST_SOHEADER-CURRENCY IS NOT INITIAL.
O_ST_SOHEADERX-CURRENCY = ABAP_ON.
ENDIF.
**** END ADD 2015/06/05 ISID18 ****

*   Document Partner
IF I_ST_FILE-SHIPTO IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE = CNS_PARNR_WE.         "取引先機能
LST_PARNRC-P_NUMB_NEW = I_ST_FILE-SHIPTO.     "得意先コード
PERFORM GET_ADDNO USING I_ST_FILE-VBELN
CHANGING LST_PARNRC-ADDR_LINK
LST_PARNRAD.
APPEND LST_PARNRC TO O_TD_PARNRC.
IF I_ST_FILE-SHIP_NAME IS NOT INITIAL.
LST_PARNRAD-NAME       = I_ST_FILE-SHIP_NAME.   "名称 1
ENDIF.
IF I_ST_FILE-SHIP_NAME2 IS NOT INITIAL.
LST_PARNRAD-NAME_2     = I_ST_FILE-SHIP_NAME2.  "名称 2
ENDIF.
IF I_ST_FILE-SHIP_NAME3 IS NOT INITIAL.
LST_PARNRAD-NAME_3     = I_ST_FILE-SHIP_NAME3.  "名称 3
ENDIF.
IF I_ST_FILE-STREET IS NOT INITIAL.
LST_PARNRAD-STREET     = I_ST_FILE-STREET.      "地名/番地-号
ENDIF.
IF I_ST_FILE-CITY IS NOT INITIAL.
LST_PARNRAD-CITY       = I_ST_FILE-CITY.        "市区町村
ENDIF.
IF I_ST_FILE-COUNTR_ISO IS NOT INITIAL.
LST_PARNRAD-COUNTRY    = I_ST_FILE-COUNTR_ISO.  "国キー (ISO コード)
ENDIF.
IF I_ST_FILE-POSTL_CODE IS NOT INITIAL.
LST_PARNRAD-POSTL_COD1 = I_ST_FILE-POSTL_CODE.  "郵便番号
ENDIF.
IF I_ST_FILE-TELEPHONE IS NOT INITIAL.
LST_PARNRAD-TEL1_NUMBR = I_ST_FILE-TELEPHONE.   "電話番号 1
ENDIF.
IF I_ST_FILE-FAX_NUMBER IS NOT INITIAL.
LST_PARNRAD-FAX_NUMBER = I_ST_FILE-FAX_NUMBER.  "FAX 番号
ENDIF.
APPEND LST_PARNRAD TO O_TD_PARNRAD.
CLEAR: LST_PARNRC,
LST_PARNRAD.
ENDIF.

IF I_ST_FILE-BILLTO IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE = CNS_PARNR_RE.         "取引先機能
LST_PARNRC-P_NUMB_NEW = I_ST_FILE-BILLTO.     "得意先コード
APPEND LST_PARNRC TO O_TD_PARNRC.
ENDIF.

IF I_ST_FILE-PAYER IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE = CNS_PARNR_RG.         "取引先機能
LST_PARNRC-P_NUMB_NEW = I_ST_FILE-PAYER.      "得意先コード
APPEND LST_PARNRC TO O_TD_PARNRC.
ENDIF.

IF I_ST_FILE-SAEMP IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE  = CNS_PARNR_VE.        "取引先機能
LST_PARNRC-P_NUMB_NEW  = I_ST_FILE-SAEMP.     "得意先コード
APPEND LST_PARNRC TO O_TD_PARNRC.
ENDIF.

IF I_ST_FILE-EDUPRI IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE = CNS_PARNR_ZE.         "取引先機能
LST_PARNRC-P_NUMB_NEW = I_ST_FILE-EDUPRI.     "得意先コード
APPEND LST_PARNRC TO O_TD_PARNRC.
ENDIF.

IF I_ST_FILE-EDUEXP IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE = CNS_PARNR_ZJ.         "取引先機能
LST_PARNRC-P_NUMB_NEW = I_ST_FILE-EDUEXP.     "得意先コード
APPEND LST_PARNRC TO O_TD_PARNRC.
ENDIF.

IF I_ST_FILE-SAASSIS IS NOT INITIAL.
LST_PARNRC-DOCUMENT   = I_ST_FILE-VBELN.      "販売管理伝票番号
LST_PARNRC-UPDATEFLAG = CNS_UPDATE.           "更新区分
LST_PARNRC-PARTN_ROLE = CNS_PARNR_ZP.         "取引先機能
LST_PARNRC-P_NUMB_NEW = I_ST_FILE-SAASSIS.   	"得意先コード
APPEND LST_PARNRC TO O_TD_PARNRC.
ENDIF.

*   Texts
IF I_ST_FILE-INBREM IS NOT INITIAL.
CLEAR LST_SOTEXT-ITM_NUMBER.                 "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_0001.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*      LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
*      lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.          "タグ列
LST_SOTEXT-TEXT_LINE = I_ST_FILE-INBREM.     "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.

IF I_ST_FILE-TABREM IS NOT INITIAL.
CLEAR LST_SOTEXT-ITM_NUMBER.                 "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_0002.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*      LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
*      lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.          "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-TABREM.    "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.

IF I_ST_FILE-SOREM IS NOT INITIAL.
CLEAR LST_SOTEXT-ITM_NUMBER.                 "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_Z010.       "テキスト ID
**** start upd 2015/05/04 isid18 ****
*      lst_sotext-langu_iso  = i_st_file-langu_iso. "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*      LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
*      lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.          "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-SOREM.     "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.
ENDIF.

* Item Data
LST_SOITEM-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.   "販売伝票明細
LST_SOITEM-MATERIAL   = I_ST_FILE-MATERIAL.     "品目コード
LST_SOITEM-PLANT      = I_ST_FILE-PLANT.        "プラント
LST_SOITEM-STORE_LOC  = I_ST_FILE-STORE_LOC.    "保管場所
LST_SOITEM-SHORT_TEXT = I_ST_FILE-SHORT_TEXT.   "受注明細のテキスト (短)
**** start upd 2015/05/04 isid18 ****
*  lst_soitem-purch_no_c = i_st_file-bstkd.        "得意先発注番号
*  lst_soitem-purch_date = i_st_file-bstdk.        "得意先発注日付
LST_SOITEM-REASON_REJ = I_ST_FILE-REASON_REJ.   "拒否理由
LST_SOITEM-ITEM_CATEG = I_ST_FILE-PSTYV.        "明細カテゴリ
LST_SOITEM-PURCH_NO_C = I_ST_FILE-BSTKD_ITEM.   "得意先発注番号
LST_SOITEM-PURCH_DATE = I_ST_FILE-BSTDK_ITEM.   "得意先発注日付
LST_SOITEM-TARGET_QTY = I_ST_FILE-REQ_QTY.      "目標数量
**** end upd 2015/05/04 isid18 ****
APPEND LST_SOITEM TO O_TD_SOITEM.

**** start upd 2015/05/04 isid18 ****
*  PERFORM item_update_check USING i_st_file-vbeln
*                                  i_st_file-itm_number
CLEAR LW_ITEM_NUM.
LW_ITEM_NUM = I_ST_FILE-ITM_NUMBER.
PERFORM ITEM_UPDATE_CHECK USING I_ST_FILE-VBELN
LW_ITEM_NUM
**** end upd 2015/05/04 isid18 ****
CHANGING LST_SOITEMX-UPDATEFLAG.

LST_SOITEMX-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.   "販売伝票明細
IF LST_SOITEM-MATERIAL IS NOT INITIAL.
LST_SOITEMX-MATERIAL   = ABAP_ON.               "品目コード
ENDIF.
IF LST_SOITEM-PLANT IS NOT INITIAL.
LST_SOITEMX-PLANT      = ABAP_ON.               "プラント
ENDIF.
IF LST_SOITEM-STORE_LOC IS NOT INITIAL.
LST_SOITEMX-STORE_LOC  = ABAP_ON.               "保管場所
ENDIF.
IF LST_SOITEM-SHORT_TEXT IS NOT INITIAL.
LST_SOITEMX-SHORT_TEXT = ABAP_ON.               "受注明細のテキスト (短)
ENDIF.
IF LST_SOITEM-PURCH_NO_C IS NOT INITIAL.
LST_SOITEMX-PURCH_NO_C = ABAP_ON.               "得意先発注番号
ENDIF.
IF LST_SOITEM-PURCH_DATE IS NOT INITIAL.
LST_SOITEMX-PURCH_DATE = ABAP_ON.               "得意先発注日付
ENDIF.
**** start add 2015/05/04 isid18 ****
IF LST_SOITEM-REASON_REJ IS NOT INITIAL.
LST_SOITEMX-REASON_REJ = ABAP_ON.               "拒否理由
ENDIF.
IF LST_SOITEM-ITEM_CATEG IS NOT INITIAL.
LST_SOITEMX-ITEM_CATEG = ABAP_ON.               "明細カテゴリ
ENDIF.
IF LST_SOITEM-TARGET_QTY IS NOT INITIAL.
LST_SOITEMX-TARGET_QTY = ABAP_ON.
ENDIF.
**** end add 2015/05/04 isid18 ****
APPEND LST_SOITEMX TO O_TD_SOITEMX.

* Schedule Line Data
**** start add 2015/05/04 isid18 ****
IF O_W_AUART <> CNS_AUART_CR  AND
O_W_AUART <> CNS_AUART_DR  AND
O_W_AUART <> CNS_AUART_ZCR AND
O_W_AUART <> CNS_AUART_ZDR.
**** end add 2015/05/04 isid18 ****
LST_SOSCHEDULE-ITM_NUMBER = I_ST_FILE-ITM_NUMBER. "購買伝票の明細番号
LST_SOSCHEDULE-SCHED_LINE = CNS_SCHED.            "納入日程行
LST_SOSCHEDULE-REQ_DATE   = I_ST_FILE-REQ_DATE.   "納入日付
**** start add 2015/05/04 isid18 ****
LST_SOSCHEDULE-DATE_TYPE  = CNS_DATE_TYPE.        "日付タイプ
**** end add 2015/05/04 isid18 ****
LST_SOSCHEDULE-REQ_QTY    = I_ST_FILE-REQ_QTY.    "計画数量
APPEND LST_SOSCHEDULE TO O_TD_SOSCHEDULE.

PERFORM SCHEDULE_UPDATE_CHECK USING I_ST_FILE-VBELN
**** start upd 2015/05/04 isid18 ****
*                                      i_st_file-itm_number
LW_ITEM_NUM
**** start upd 2015/05/04 isid18 ****
CHANGING LST_SOSCHEDULEX-UPDATEFLAG.

LST_SOSCHEDULEX-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.  "購買伝票の明細番号
LST_SOSCHEDULEX-SCHED_LINE = CNS_SCHED.             "納入日程行
**** start add 2015/05/04 isid18 ****
LST_SOSCHEDULEX-DATE_TYPE  = ABAP_ON.               "日付タイプ
**** end add 2015/05/04 isid18 ****
IF LST_SOSCHEDULE-REQ_DATE IS NOT INITIAL
**** start add 2015/05/15 isid18 ****
AND LST_SOSCHEDULE-REQ_DATE <> SPACE.
**** end add 2015/05/15 isid18 ****
LST_SOSCHEDULEX-REQ_DATE   = ABAP_ON.             "納入日付
ENDIF.
IF LST_SOSCHEDULE-REQ_QTY IS NOT INITIAL.
LST_SOSCHEDULEX-REQ_QTY    = ABAP_ON.             "計画数量
ENDIF.
APPEND LST_SOSCHEDULEX TO O_TD_SOSCHEDULEX.
**** start add 2015/05/04 isid18 ****
ENDIF.
**** end add 2015/05/04 isid18 ****

* Conditions
PERFORM GET_COND_KEY USING I_ST_FILE-VBELN
**** start upd 2015/05/04 isid18 ****
*                                 i_st_file-itm_number
LW_ITEM_NUM
**** start upd 2015/05/04 isid18 ****
I_ST_FILE-COND_TYPE
CHANGING LST_SOCONDITION-COND_ST_NO
**** start add 2015/05/04 isid18 ****
LST_SOCONDITIONX-UPDATEFLAG.
IF LST_SOCONDITIONX-UPDATEFLAG IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****

LST_SOCONDITION-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.  "販売伝票明細
LST_SOCONDITION-COND_TYPE  = I_ST_FILE-COND_TYPE.   "条件タイプ

LST_SOCONDITION-COND_VALUE = I_ST_FILE-COND_VALUE.  "条件レート
LST_SOCONDITION-CURRENCY   = I_ST_FILE-WAERK.       "通貨コード
LST_SOCONDITION-COND_UNIT  = I_ST_FILE-COND_UNIT.   "条件単位
LST_SOCONDITION-COND_P_UNT = I_ST_FILE-COND_P_UNT.  "価格条件単位
APPEND LST_SOCONDITION TO O_TD_SOCONDITION.

**** start upd 2015/05/04 isid18 ****
*    lst_soconditionx-updateflag = cns_update.           "更新区分
*    lst_soconditionx-itm_number = i_st_file-itm_number. "販売伝票明細
*    lst_soconditionx-cond_st_no = lst_socondition-cond_st_no. "ステップ番号
LST_SOCONDITIONX-ITM_NUMBER = I_ST_FILE-ITM_NUMBER. "販売伝票明細
IF LST_SOCONDITIONX-UPDATEFLAG = CNS_UPDATE.
LST_SOCONDITIONX-COND_ST_NO = LST_SOCONDITION-COND_ST_NO. "ステップ番号
ENDIF.
**** end upd 2015/05/04 isid18 ****
IF LST_SOCONDITION-COND_TYPE IS NOT INITIAL.
LST_SOCONDITIONX-COND_TYPE  = ABAP_ON.              "条件タイプ
ENDIF.
IF LST_SOCONDITION-COND_VALUE IS NOT INITIAL.
LST_SOCONDITIONX-COND_VALUE = ABAP_ON.              "条件レート
ENDIF.
IF LST_SOCONDITION-CURRENCY IS NOT INITIAL.
LST_SOCONDITIONX-CURRENCY   = ABAP_ON.              "通貨コード
ENDIF.
IF LST_SOCONDITION-COND_UNIT IS NOT INITIAL.
LST_SOCONDITIONX-COND_UNIT  = ABAP_ON.              "条件単位
ENDIF.
IF LST_SOCONDITION-COND_P_UNT IS NOT INITIAL.
LST_SOCONDITIONX-COND_P_UNT = ABAP_ON.              "価格条件単位
ENDIF.
APPEND LST_SOCONDITIONX TO O_TD_SOCONDITIONX.
**** start add 2015/05/04 isid18 ****
ENDIF.
**** end add 2015/05/04 isid18 ****

* Texts
IF I_ST_FILE-ITEMREM IS NOT INITIAL.
LST_SOTEXT-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.       "販売伝票明細
LST_SOTEXT-TEXT_ID    = CNS_TDID_9001.              "テキスト ID
**** start upd 2015/05/04 isid18 ****
*    lst_sotext-langu_iso  = i_st_file-langu_iso.        "ISO 639 準拠の言語
**** START UPD 2015/06/29 ISID18 ****
*    LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
*    lst_sotext-doc_number = o_w_vbeln.
**** end upd 2015/05/04 isid18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.                 "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-ITEMREM.          "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.

**** start add 2015/05/04 isid18 ****
* Texts
IF I_ST_FILE-TRANSREM IS NOT INITIAL.
LST_SOTEXT-ITM_NUMBER = I_ST_FILE-ITM_NUMBER.       "販売伝票明細
**** START UPD 2015/06/05 ISID18 ****
*    LST_SOTEXT-TEXT_ID    = CNS_TDID_Z910.              "テキスト ID
LST_SOTEXT-TEXT_ID    = CNS_TDID_0002.              "テキスト ID
**** END UPD 2015/06/05 ISID18 ****
**** START UPD 2015/06/29 ISID18 ****
*    LST_SOTEXT-LANGU      = SY-LANGU.
LST_SOTEXT-LANGU      = LW_SPRAS.
**** END UPD 2015/06/29 ISID18 ****
LST_SOTEXT-FORMAT_COL = CNS_FORMAT.                 "タグ列
LST_SOTEXT-TEXT_LINE  = I_ST_FILE-TRANSREM.         "テキスト行
APPEND LST_SOTEXT TO O_TD_SOTEXT.
ENDIF.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " SO_CHANGE_EDIT

*&---------------------------------------------------------------------*
*&      Form  ITEM_UPDATE_CHECK
*&---------------------------------------------------------------------*
*       Set Item Update Flag
*----------------------------------------------------------------------*
*      -->I_W_VBELN  SO No
*      -->I_W_ITEM   Item
*      <--O_W_UPD    UPDATEFLAG
*----------------------------------------------------------------------*
FORM ITEM_UPDATE_CHECK  USING    I_W_VBELN  TYPE VBELN
I_W_ITEM   TYPE POSNR
CHANGING O_W_UPD    TYPE C.

DATA LW_VBELN TYPE VBELN.

SELECT SINGLE VBELN
FROM VBAP
INTO LW_VBELN
WHERE VBELN = I_W_VBELN
AND POSNR = I_W_ITEM.

IF LW_VBELN IS INITIAL.
O_W_UPD = CNS_INSERT.             "更新区分
ELSE.
O_W_UPD = CNS_UPDATE.             "更新区分
ENDIF.

ENDFORM.                    " ITEM_UPDATE_CHECK

*&---------------------------------------------------------------------*
*&      Form  SCHEDULE_UPDATE_CHECK
*&---------------------------------------------------------------------*
*       Set Schedule Update Flag
*----------------------------------------------------------------------*
*      -->I_W_VBELN  SO No
*      -->I_W_ITEM   Item
*      <--O_W_UPD    UPDATEFLAG
*----------------------------------------------------------------------*
FORM SCHEDULE_UPDATE_CHECK  USING    I_W_VBELN  TYPE VBELN
I_W_ITEM   TYPE POSNR
CHANGING O_W_UPD    TYPE C.

DATA LW_VBELN TYPE VBELN.

SELECT SINGLE VBELN
FROM VBEP
INTO LW_VBELN
WHERE VBELN = I_W_VBELN
AND POSNR = I_W_ITEM
AND ETENR = CNS_SCHED.

IF LW_VBELN IS INITIAL.
O_W_UPD = CNS_INSERT.             "更新区分
ELSE.
O_W_UPD = CNS_UPDATE.             "更新区分
ENDIF.

ENDFORM.                    " SCHEDULE_UPDATE_CHECK

*&---------------------------------------------------------------------*
*&      Form  GET_ADDNO
*&---------------------------------------------------------------------*
*       Get Address number
*----------------------------------------------------------------------*
*      -->i_vbeln  So No
*      <--o_addno  Address number
*----------------------------------------------------------------------*
FORM GET_ADDNO  USING    I_VBELN  TYPE VBELN
CHANGING O_ADDNO  TYPE ADRNR
O_PARAD  TYPE BAPIADDR1.

CLEAR: O_ADDNO,
O_PARAD.

SELECT SINGLE ADRNR
FROM VBPA
INTO O_ADDNO
WHERE VBELN = I_VBELN
AND POSNR = CNS_POSNR_00
AND PARVW = CNS_PARNR_WE.

CHECK O_ADDNO IS NOT INITIAL.

SELECT ADDRNUMBER
NAME1
NAME2
NAME3
STREET
CITY1
COUNTRY
POST_CODE1
TEL_NUMBER
FAX_NUMBER UP TO 1 ROWS
FROM ADRC
INTO (O_PARAD-ADDR_NO,     "アドレス番号
O_PARAD-NAME,        "名称 1
O_PARAD-NAME_2,      "名称 2
O_PARAD-NAME_3,      "名称 3
O_PARAD-STREET,      "地名/番地-号
O_PARAD-CITY,        "市区町村
O_PARAD-COUNTRY,     "国キー (ISO コード)
O_PARAD-POSTL_COD1,  "郵便番号
O_PARAD-TEL1_NUMBR,  "電話番号 1
O_PARAD-FAX_NUMBER)  "FAX 番号
WHERE ADDRNUMBER = O_ADDNO.
ENDSELECT.

ENDFORM.                    " GET_ADDNO

*&---------------------------------------------------------------------*
*&      Form  FRM_GET_COND_KEY
*&---------------------------------------------------------------------*
*       Get Conditon Key
*----------------------------------------------------------------------*
*      -->I_ST_FILE_VBELN  SO No
*      -->I_ST_FILE_ITM_NUMBER  item number
*      -->I_ST_FILE_COND_TYPE  condition type
*      <--o_cond_st_no   condition number
*----------------------------------------------------------------------*
FORM GET_COND_KEY  USING I_VBELN        TYPE VBELN
I_POSNR        TYPE POSNR
I_COND_TYPE    TYPE KSCHA
CHANGING O_COND_ST_NO   TYPE STUNR
**** start add 2015/05/04 isid18 ****
O_UPDATEFLAG   TYPE UPDKZ_D.

DATA LW_STUNR TYPE KONV-STUNR.
**** end add 2015/05/04 isid18 ****

DATA LW_KNUMV TYPE VBAK-KNUMV.    "condition num

CLEAR: O_COND_ST_NO.

SELECT SINGLE KNUMV
FROM VBAK
INTO LW_KNUMV
WHERE VBELN = I_VBELN.

**** start add 2015/05/04 isid18 ****
CLEAR O_UPDATEFLAG.
SELECT STUNR UP TO 1 ROWS
FROM KONV
INTO LW_STUNR
WHERE KNUMV = LW_KNUMV
AND KPOSN = I_POSNR.
ENDSELECT.
IF SY-SUBRC <> 0.
O_UPDATEFLAG = CNS_INSERT.
IF I_COND_TYPE IS INITIAL.
CLEAR O_UPDATEFLAG.
ENDIF.
ELSE.
IF I_COND_TYPE IS NOT INITIAL.
**** end add 2015/05/04 isid18 ****

SELECT STUNR UP TO 1 ROWS
FROM KONV
INTO O_COND_ST_NO
WHERE KNUMV = LW_KNUMV
AND KPOSN = I_POSNR
AND KSCHL = I_COND_TYPE.
ENDSELECT.

**** start add 2015/05/04 isid18 ****
IF SY-SUBRC = 0.
O_UPDATEFLAG = CNS_UPDATE.
ELSE.
O_UPDATEFLAG = CNS_INSERT.
ENDIF.
ELSE.
CLEAR O_UPDATEFLAG.
ENDIF.
ENDIF.
**** end add 2015/05/04 isid18 ****

ENDFORM.                    " GET_COND_KEY
*&---------------------------------------------------------------------*
*&      Form  SO_change_EXECUTE
*&---------------------------------------------------------------------*
*       BAPIの実行
*----------------------------------------------------------------------*
*      -->I_W_INTEX           Index
*      -->i_w_vbeln           SO nO
*      -->i_st_soheader       Header
*      -->i_st_soheaderx      Header check
*      -->i_td_soitem         Item
*      -->i_td_soitemx        Item check
*      -->i_td_parnrc         Partner change
*      -->i_td_parnrad        partner address
*      -->i_td_soschedule     schedule line
*      -->i_td_soschedulex    schedule line check
*      -->i_td_socondition    condition
*      -->i_td_soconditionx   condition check
*      -->i_td_sotext         text
*      <--O_W_EFLG            Error Flag
*      <--O_TD_MSG            Error message table
*----------------------------------------------------------------------*
FORM SO_CHANGE_EXECUTE  USING
I_W_INDEX            TYPE SY-INDEX
I_W_VBELN            TYPE BAPIVBELN-VBELN
**** start upd 2015/05/04 isid18 ****
*                        i_st_soheader        TYPE bapisdh1
*                        i_st_soheaderx       TYPE bapisdh1x
I_W_BUSTYPE          TYPE BAPIUSW01-OBJTYPE
VALUE(I_ST_SOHEADER)       TYPE BAPISDHD1
VALUE(I_ST_SOHEADERX)      TYPE BAPISDHD1X
**** end upd 2015/05/04 isid18 ****
I_TD_SOITEM          TYPE TYP_TD_SOITEM
I_TD_SOITEMX         TYPE TYP_TD_SOITEMX
I_TD_PARNRC          TYPE TYP_TD_PARNRC
I_TD_PARNRAD         TYPE TYP_TD_PARNRAD
I_TD_SOSCHEDULE      TYPE TYP_TD_SOSCHEDULE
I_TD_SOSCHEDULEX     TYPE TYP_TD_SOSCHEDULEX
I_TD_SOCONDITION     TYPE TYP_TD_SOCONDITION
I_TD_SOCONDITIONX    TYPE TYP_TD_SOCONDITIONX
I_TD_SOTEXT          TYPE TYP_TD_SOTEXT
CHANGING O_W_EFLG    TYPE C
O_TD_MSG    TYPE TYP_TD_MSG.
DATA:
LW_SDLS     TYPE BAPISDLS,
LW_TRUN     TYPE BAPIFLAG-BAPIFLAG,
LW_SO       TYPE BAPIVBELN-VBELN,
LTD_RETURN  TYPE TABLE OF BAPIRET2,
LST_RETURN  TYPE BAPIRET2,
LW_ROW      TYPE STRING,
LW_MSG      TYPE STRING,
**** start add 2015/05/04 isid18 ****
LW_RMSG     TYPE STRING,
LW_INDEX    TYPE INT4,
LW_ITEM     TYPE CHAR6,
LST_SOITEM  TYPE BAPISDITM,
LTD_SCHED   TYPE TYP_TD_SOSCHEDULE,
LTH_SCHED   TYPE BAPISCHDL,
LW_VDATU    TYPE VBAK-VDATU,
**** end add 2015/05/04 isid18 ****
LST_MSG     TYPE TYP_MSG.

IF P_TSTCK = ABAP_ON.
LW_TRUN = ABAP_ON.
ENDIF.

LW_SDLS-COND_HANDL = ABAP_ON.

LW_SO = I_W_VBELN.

**** start upd 2015/05/04 isid18 ****
*  CALL FUNCTION 'BAPI_SALESORDER_CHANGE'
*    EXPORTING
*      salesdocument    = lw_so
*      order_header_in  = i_st_soheader
*      order_header_inx = i_st_soheaderx
*      simulation       = lw_trun
*      logic_switch     = lw_sdls
*    TABLES
*      return           = ltd_return
*      order_item_in    = i_td_soitem
*      order_item_inx   = i_td_soitemx
*      partnerchanges   = i_td_parnrc
*      partneraddresses = i_td_parnrad
*      schedule_lines   = i_td_soschedule
*      schedule_linesx  = i_td_soschedulex
*      conditions_in    = i_td_socondition
*      conditions_inx   = i_td_soconditionx
*      order_text       = i_td_sotext.
IF I_TD_SOSCHEDULE[] IS NOT INITIAL.
SELECT SINGLE VDATU
FROM VBAK
INTO LW_VDATU
WHERE VBELN = LW_SO.
LTD_SCHED[] = I_TD_SOSCHEDULE[].
SORT LTD_SCHED BY REQ_DATE DESCENDING.
READ TABLE LTD_SCHED INTO LTH_SCHED INDEX 1.
IF LW_VDATU < LTH_SCHED-REQ_DATE.
I_ST_SOHEADER-REQ_DATE_H = LTH_SCHED-REQ_DATE.
I_ST_SOHEADERX-REQ_DATE_H = ABAP_ON.
ENDIF.
ENDIF.
CALL FUNCTION 'SD_SALESDOCUMENT_CHANGE'
EXPORTING
SALESDOCUMENT    = LW_SO
ORDER_HEADER_IN  = I_ST_SOHEADER
ORDER_HEADER_INX = I_ST_SOHEADERX
SIMULATION       = LW_TRUN
BUSINESS_OBJECT  = I_W_BUSTYPE
CALL_FROM_BAPI   = ABAP_ON
LOGIC_SWITCH     = LW_SDLS
TABLES
RETURN           = LTD_RETURN
ITEM_IN          = I_TD_SOITEM
ITEM_INX         = I_TD_SOITEMX
PARTNERCHANGES   = I_TD_PARNRC
PARTNERADDRESSES = I_TD_PARNRAD
SCHEDULE_IN      = I_TD_SOSCHEDULE
SCHEDULE_INX     = I_TD_SOSCHEDULEX
CONDITIONS_IN    = I_TD_SOCONDITION
CONDITIONS_INX   = I_TD_SOCONDITIONX
SALES_TEXT       = I_TD_SOTEXT.
**** end upd 2015/05/04 isid18 ****

**** start upd 2015/05/04 isid18 ****
*  w_tnum = w_tnum + 1.                    "Total number
*  lw_row = i_w_index.

** Test mode
*  IF p_tstck = abap_on.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return.
*      IF lst_return-type = cns_msg_e OR
*         lst_return-type = cns_msg_a.
*        o_w_eflg = abap_on.
*      ENDIF.
*      IF lst_return-id IS NOT INITIAL AND
*         lst_return-type IS NOT INITIAL AND
*         lst_return-number IS NOT INITIAL.
*        MESSAGE ID lst_return-id TYPE lst_return-type
*          NUMBER lst_return-number
*          WITH lst_return-message_v1
*               lst_return-message_v2
*               lst_return-message_v3
*               lst_return-message_v4
*           INTO lw_msg.
*        CONDENSE lw_row.
*        CONCATENATE lw_msg text-031 lw_row text-032  INTO lw_msg.
*        CASE sy-msgty.
*          WHEN cns_msg_e OR
*                cns_msg_a.
*            lst_msg-col2 = text-008.
*          WHEN cns_msg_w.
*            lst_msg-col2 = text-030.
*          WHEN OTHERS.
*            lst_msg-col2 = text-009.
*        ENDCASE.
*        lst_msg-col1 = text-007.
*        lst_msg-col3 = lw_msg.
*        APPEND lst_msg TO o_td_msg.
*      ENDIF.
*    ENDLOOP.
*    IF o_w_eflg = abap_on.
*      w_enum = w_enum + 1.                "Error number
*    ELSE.
*      w_snum = w_snum + 1.                "Sucessful number
*    ENDIF.
*  ELSE.
**   BAPIから返した「RETURN」にエラーメッセージ存在する場合
*    LOOP AT ltd_return INTO lst_return
*        WHERE type = cns_msg_e OR
*              type = cns_msg_a.
**     データ更新に失敗しました。(ROW = &1 / MSG = &2 )
*      MESSAGE s098(zmegsd01) WITH i_w_index lst_return-message
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-008.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*      o_w_eflg = abap_on.
*      w_enum = w_enum + 1.                 "Error number
*
*      CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
*
*      EXIT.
*    ENDLOOP.
*
**   BAPIから返した「RETURN」にエラーメッセージ存在しない場合
*    IF o_w_eflg <> abap_on.
*      CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
*        EXPORTING
*          wait = abap_on.
*
*      w_snum = w_snum + 1.                "Sucessful number
**     データ更新が正常終了しました。(ROW = &1 / SO= &2)
*      MESSAGE s104(zmegsd01) WITH i_w_index lw_so
*        INTO lw_msg.
*      lst_msg-col1 = text-007.
*      lst_msg-col2 = text-009.
*      lst_msg-col3 = lw_msg.
*      APPEND lst_msg TO o_td_msg.
*    ENDIF.
*  ENDIF.

LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E OR
TYPE = CNS_MSG_A.
O_W_EFLG = ABAP_ON.
EXIT.
ENDLOOP.

* エラーなし場合
IF O_W_EFLG IS INITIAL.
W_SNUM = W_SNUM + 1.
*  データ更新が正常終了しました。(ROW = &1 / SO= &2)
MESSAGE S104(ZMEGSD01) WITH I_W_INDEX LW_SO
INTO LW_MSG.
CLEAR LST_SOITEM.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX 1.
CLEAR LW_ROW.
LW_ROW = I_W_INDEX.
CONDENSE LW_ROW.
WRITE LST_SOITEM-ITM_NUMBER TO LW_ITEM NO-ZERO.
CONDENSE LW_ITEM.
CLEAR LW_RMSG.
CONCATENATE TEXT-033 LW_ROW TEXT-034 TEXT-035
LW_ITEM
INTO LW_RMSG SEPARATED BY SPACE.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL2 = TEXT-009.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
*   Output check message
LOOP AT LTD_RETURN INTO LST_RETURN.
IF LST_RETURN-ID IS NOT INITIAL AND
LST_RETURN-TYPE IS NOT INITIAL AND
LST_RETURN-NUMBER IS NOT INITIAL.
MESSAGE ID LST_RETURN-ID TYPE LST_RETURN-TYPE
NUMBER LST_RETURN-NUMBER
WITH LST_RETURN-MESSAGE_V1
LST_RETURN-MESSAGE_V2
LST_RETURN-MESSAGE_V3
LST_RETURN-MESSAGE_V4
INTO LW_MSG.

*       row,item
CLEAR: LW_INDEX, LW_ROW, LST_SOITEM.
IF LST_RETURN-ROW > 0.
LW_INDEX = I_W_INDEX + LST_RETURN-ROW - 1.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX LST_RETURN-ROW.
ELSE.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX 1.
LW_INDEX = I_W_INDEX.
ENDIF.
LW_ROW = LW_INDEX.
CONDENSE LW_ROW.

CLEAR LW_ITEM.
WRITE LST_SOITEM-ITM_NUMBER TO LW_ITEM NO-ZERO.
CONDENSE LW_ITEM.
CLEAR LW_RMSG.
CONCATENATE TEXT-033 LW_ROW TEXT-034 TEXT-035
LW_ITEM
INTO LW_RMSG SEPARATED BY SPACE.

CASE LST_RETURN-TYPE.
WHEN CNS_MSG_E OR
CNS_MSG_A.
LST_MSG-COL2 = TEXT-008.
WHEN CNS_MSG_W.
LST_MSG-COL2 = TEXT-030.
WHEN OTHERS.
LST_MSG-COL2 = TEXT-009.
ENDCASE.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
ENDIF.
ENDLOOP.
IF P_TSTCK <> ABAP_ON.
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
WAIT = ABAP_ON.
ENDIF.

* エラーあり
ELSE.
W_ENUM = W_ENUM + 1.
LOOP AT LTD_RETURN INTO LST_RETURN
WHERE TYPE = CNS_MSG_E OR
TYPE = CNS_MSG_A.
*     Output check message
IF LST_RETURN-ID IS NOT INITIAL AND
LST_RETURN-TYPE IS NOT INITIAL AND
LST_RETURN-NUMBER IS NOT INITIAL.
MESSAGE ID LST_RETURN-ID TYPE LST_RETURN-TYPE
NUMBER LST_RETURN-NUMBER
WITH LST_RETURN-MESSAGE_V1
LST_RETURN-MESSAGE_V2
LST_RETURN-MESSAGE_V3
LST_RETURN-MESSAGE_V4
INTO LW_MSG.
*       データ更新に失敗しました。(MSG = &1 )
MESSAGE S098(ZMEGSD01) WITH I_W_INDEX LW_MSG
INTO LW_MSG.

*       row,item
CLEAR: LW_INDEX, LW_ROW, LST_SOITEM.
IF LST_RETURN-ROW > 0.
LW_INDEX = I_W_INDEX + LST_RETURN-ROW - 1.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX LST_RETURN-ROW.
ELSE.
LW_INDEX = I_W_INDEX.
READ TABLE I_TD_SOITEM INTO LST_SOITEM INDEX 1.
ENDIF.
LW_ROW = LW_INDEX.
CONDENSE LW_ROW.

CLEAR LW_ITEM.
WRITE LST_SOITEM-ITM_NUMBER TO LW_ITEM NO-ZERO.
CONDENSE LW_ITEM.

CLEAR LW_RMSG.
CONCATENATE TEXT-033 LW_ROW TEXT-034 TEXT-035
LW_ITEM
INTO LW_RMSG SEPARATED BY SPACE.

CASE LST_RETURN-TYPE.
WHEN CNS_MSG_E OR
CNS_MSG_A.
LST_MSG-COL2 = TEXT-008.
WHEN CNS_MSG_W.
LST_MSG-COL2 = TEXT-030.
WHEN OTHERS.
LST_MSG-COL2 = TEXT-009.
ENDCASE.
LST_MSG-COL1 = TEXT-007.
LST_MSG-COL3 = LW_RMSG.
LST_MSG-COL4 = LW_MSG.
APPEND LST_MSG TO O_TD_MSG.
ENDIF.
ENDLOOP.
IF P_TSTCK <> ABAP_ON..
CALL FUNCTION 'BAPI_TRANSACTION_ROLLBACK'.
ENDIF.
ENDIF.
**** end upd 2015/05/04 isid18 ****

ENDFORM.                    " SO_change_EXECUTE

*&---------------------------------------------------------------------*
*&      Form  PROCESS_RESULT
*&---------------------------------------------------------------------*
*       A-5．画面出力・ファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_EFILE  Error file table
*      -->I_TD_MSG    Error message table
*----------------------------------------------------------------------*
**** START UPD 2015/06/18 ISID18 ****
*FORM PROCESS_RESULT USING I_TD_EFILE TYPE TYP_TD_FILE
FORM PROCESS_RESULT USING I_TD_EFILE TYPE TYP_TD_FILE_STR
**** END UPD 2015/06/18 ISID18 ****
I_TD_MSG   TYPE TYP_TD_MSG.

DATA:
LTD_RFILE TYPE TYP_TD_RFILE.

* A-5-1．結果画面の画面出力
PERFORM WRITE_RESULT USING I_TD_MSG
CHANGING LTD_RFILE.

* A-5-2．RESULTファイルのファイル出力
* A-5-3．ERRORファイルのファイル出力
PERFORM OUTPUT_FILE USING LTD_RFILE
I_TD_EFILE.

ENDFORM.                    " PROCESS_RESULT

*&---------------------------------------------------------------------*
*&      Form  WRITE_RESULT
*&---------------------------------------------------------------------*
*       A-5-1．結果画面の画面出力
*----------------------------------------------------------------------*
*      -->I_TD_MSG    Error File data
*      <--O_TD_rfile  Result file table
*----------------------------------------------------------------------*
FORM WRITE_RESULT USING    I_TD_MSG   TYPE TYP_TD_MSG
CHANGING O_TD_RFILE TYPE TYP_TD_RFILE.
DATA:
LW_MODE      TYPE STRING,
LRH_WERKS    LIKE LINE OF S_WERKS,
LW_WERKS     TYPE STRING,
LW_SIGN      TYPE STRING,
LW_OPTION    TYPE STRING,
LW_LOW       TYPE STRING,
LW_HIGH      TYPE STRING,
LW_NO        TYPE I,
LST_MSG      TYPE TYP_MSG,
LST_RFILE    TYPE TYP_RFILE.

IF P_SERVE = ABAP_ON.
LW_MODE = TEXT-002.
ELSE.
LW_MODE = TEXT-003.
ENDIF.

**** start add 2015/05/04 isid18 ****
W_TNUM = W_ENUM + W_SNUM.
**** end add 2015/05/04 isid18 ****

* Plant: SI:X OP:XX LO:XX HI:XX
LOOP AT S_WERKS INTO LRH_WERKS.
CLEAR: LW_SIGN,
LW_OPTION,
LW_LOW,
LW_HIGH.
LW_NO = LW_NO + 1.
CONCATENATE 'SI:'
LRH_WERKS-SIGN
INTO LW_SIGN.
CONCATENATE 'OP:'
LRH_WERKS-OPTION
INTO LW_OPTION.
CONCATENATE 'LO:'
LRH_WERKS-LOW
INTO LW_LOW.
CONCATENATE 'HI:'
LRH_WERKS-HIGH
INTO LW_HIGH.
IF LW_NO = 1.
CONCATENATE LW_SIGN
LW_OPTION
LW_LOW
LW_HIGH
INTO LW_WERKS
SEPARATED BY SPACE.
ELSEIF LW_NO > 1
AND LW_NO <= 5.
CONCATENATE LW_WERKS
'/'
LW_SIGN
LW_OPTION
LW_LOW
LW_HIGH
INTO LW_WERKS
SEPARATED BY SPACE.
ELSE.
CONCATENATE LW_WERKS
'/...'
INTO LW_WERKS
SEPARATED BY SPACE.
ENDIF.
ENDLOOP.

SKIP.
WRITE: TEXT-016.                        "<Paramenter>
WRITE:/2 TEXT-017, 24 ':', LW_MODE.     "Mode
WRITE:/2 TEXT-018, 24 ':', P_TSTCK.     "Test Run
WRITE:/2 TEXT-019, 24 ':', LW_WERKS.    "Plant
WRITE:/2 TEXT-020, 24 ':', P_IFILE.     "File Name(Input)
WRITE:/2 TEXT-021, 24 ':', P_RFILE.     "File Name(Result)
WRITE:/2 TEXT-022, 24 ':', P_EFILE.     "File Name(Error)

SKIP.
WRITE: TEXT-023.                        "<Result>
WRITE:/2 TEXT-024, 24 ':', W_TNUM.      "Number of Transcations
WRITE:/2 TEXT-025, 24 ':', W_SNUM.      "Number of Normal
WRITE:/2 TEXT-026, 24 ':', W_ENUM.      "Number of Errors

SKIP.
WRITE: TEXT-027.                        "<Message>
LOOP AT I_TD_MSG INTO LST_MSG.
WRITE:/3 LST_MSG-COL1,
24 LST_MSG-COL2,
40 LST_MSG-COL3,
**** start add 2015/05/04 isid18 ****
60 LST_MSG-COL4.
**** end add 2015/05/04 isid18 ****
ENDLOOP.

* RESULTファイルのファイル設定
* Output header
CONCATENATE TEXT-010 ':' SY-MANDT INTO LST_RFILE-COL1. "CLIENT
CONCATENATE TEXT-013 ':' SY-DATUM INTO LST_RFILE-COL3. "Date
APPEND LST_RFILE TO O_TD_RFILE.

CLEAR LST_RFILE.
CONCATENATE TEXT-011 ':' SY-CPROG INTO LST_RFILE-COL1. "PROGRAM
CONCATENATE TEXT-014 ':' SY-UZEIT INTO LST_RFILE-COL3. "Time
APPEND LST_RFILE TO O_TD_RFILE.

CLEAR LST_RFILE.
CONCATENATE TEXT-012 ':' SY-UNAME INTO LST_RFILE-COL1. "USER
LST_RFILE-COL2 = TEXT-015.                             "Title
APPEND LST_RFILE TO O_TD_RFILE.

CLEAR LST_RFILE.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-016.    "<Paramenter>
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-017.    "Mode
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = LW_MODE.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-018.    "Test Run
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = P_TSTCK.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-019.    "Plant
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = LW_WERKS.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-020.    "File Name(Input)
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = P_IFILE.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-021.    "File Name(Result)
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = P_RFILE.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-022.    "File Name(Error)
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = P_EFILE.
APPEND LST_RFILE TO O_TD_RFILE.

CLEAR LST_RFILE.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-023.    "<Result>
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-024.    "Number of Transcations
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = W_TNUM.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-025.    "Number of Normal
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = W_SNUM.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-026.    "Number of Errors
LST_RFILE-COL2 = ':'.
LST_RFILE-COL3 = W_ENUM.
APPEND LST_RFILE TO O_TD_RFILE.

CLEAR LST_RFILE.
APPEND LST_RFILE TO O_TD_RFILE.

LST_RFILE-COL1 = TEXT-027.    "<Message>
APPEND LST_RFILE TO O_TD_RFILE.

LOOP AT I_TD_MSG INTO LST_MSG.
LST_RFILE-COL1 = LST_MSG-COL1.
LST_RFILE-COL2 = LST_MSG-COL2.
LST_RFILE-COL3 = LST_MSG-COL3.
**** start add 2015/05/04 isid18 ****
LST_RFILE-COL4 = LST_MSG-COL4.
**** end add 2015/05/04 isid18 ****
APPEND LST_RFILE TO O_TD_RFILE.
ENDLOOP.

ENDFORM.                    " WRITE_RESULT

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_HEAD
*&---------------------------------------------------------------------*
*       ヘッダ出力
*----------------------------------------------------------------------*
FORM OUTPUT_HEAD.

*  SET TITLEBAR 'GUI_TITLE_RESULT'.

WRITE: /2 TEXT-010, 15 ':', 17 SY-MANDT,      "CLIENT
130 TEXT-013, 135 ':', 137 SY-DATUM,  "Date
/2 TEXT-011, 15 ':', 17 SY-CPROG,      "PROGRAM
130 TEXT-014, 135 ':', 137 SY-UZEIT,  "Time
/2 TEXT-012, 15 ':', 17 SY-UNAME,      "USER
66 TEXT-015.                          "Title

ENDFORM.                    " OUTPUT_HEAD

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_FILE
*&---------------------------------------------------------------------*
*       ファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_RFILE  Result file table
*      -->I_TD_EFILE  Error file table
*----------------------------------------------------------------------*
FORM OUTPUT_FILE  USING I_TD_RFILE TYPE TYP_TD_RFILE
**** START UPD 2015/06/18 ISID18 ****
*                        I_TD_EFILE TYPE TYP_TD_FILE.
I_TD_EFILE TYPE TYP_TD_FILE_STR.
**** END UPD 2015/06/18 ISID18 ****

IF P_SERVE = ABAP_ON.
*   サーバファイル出力
PERFORM OUTPUT_SERVE USING I_TD_RFILE
I_TD_EFILE.
ELSE.
*   ローカルファイル出力
PERFORM OUTPUT_LOCAL USING I_TD_RFILE
I_TD_EFILE.
ENDIF.

ENDFORM.                    " OUTPUT_FILE

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_SERVE
*&---------------------------------------------------------------------*
*       サーバファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_RFILE  Result file table
*      -->I_TD_EFILE  Error file table
*----------------------------------------------------------------------*
FORM OUTPUT_SERVE USING I_TD_RFILE TYPE TYP_TD_RFILE
**** START UPD 2015/06/18 ISID18 ****
*                        I_TD_EFILE TYPE TYP_TD_FILE.
I_TD_EFILE TYPE TYP_TD_FILE_STR.
**** END UPD 2015/06/18 ISID18 ****

DATA:
LST_RFILE TYPE TYP_RFILE,
**** START UPD 2015/06/18 ISID18 ****
*    LST_FILE  TYPE TYP_FILE,
LST_FILE  TYPE TYP_FILE_STR,
**** END UPD 2015/06/18 ISID18 ****
LW_FILE   TYPE STRING.

* A-5-2．RESULTファイルのファイル出力
IF W_FLGUTF8 IS INITIAL.
TRY.
OPEN DATASET P_RFILE FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE W_CODEPAGE
IGNORING CONVERSION ERRORS.
CATCH  CX_SY_CODEPAGE_CONVERTER_INIT.
SY-SUBRC = 8.
ENDTRY.
ELSE.
OPEN DATASET P_RFILE FOR OUTPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ENDIF.
IF SY-SUBRC <> 0.
MESSAGE S035(ZMEGSD01) WITH P_RFILE DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.

LOOP AT I_TD_RFILE INTO LST_RFILE.
CLEAR LW_FILE.
CONCATENATE LST_RFILE-COL1 LST_RFILE-COL2 LST_RFILE-COL3
INTO LW_FILE SEPARATED BY CNS_TAB.
TRANSFER LW_FILE TO P_RFILE.
ENDLOOP.

* ファイルクローズ
CLOSE DATASET P_RFILE.

* A-5-3．ERRORファイルのファイル出力
CHECK I_TD_EFILE IS NOT INITIAL.
IF W_FLGUTF8 IS INITIAL.
TRY.
OPEN DATASET P_EFILE FOR OUTPUT
IN LEGACY TEXT MODE CODE PAGE W_CODEPAGE
IGNORING CONVERSION ERRORS.
CATCH  CX_SY_CODEPAGE_CONVERTER_INIT.
SY-SUBRC = 8.
ENDTRY.
ELSE.
OPEN DATASET P_EFILE FOR OUTPUT
IN TEXT MODE ENCODING UTF-8
IGNORING CONVERSION ERRORS.
ENDIF.
IF SY-SUBRC <> 0.
MESSAGE S035(ZMEGSD01) WITH P_EFILE DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.

LOOP AT I_TD_EFILE INTO LST_FILE.
CLEAR LW_FILE.
CONCATENATE
LST_FILE-TCD        "TCD
LST_FILE-GFLAG      "GroupFlag
LST_FILE-AUART      "DocType
LST_FILE-VKORG      "SalesOrg
LST_FILE-VTWEG      "DistChannel
LST_FILE-SPART      "Division
LST_FILE-VKBUR      "SalesOffice
LST_FILE-VKGRP      "SalesGrp
LST_FILE-VBELN      "SONo
LST_FILE-BSTKD      "CustPurchNo
LST_FILE-BSTDK      "CustPurchDate
LST_FILE-AUDAT      "DocDate
LST_FILE-PRSDT      "PriceDate
LST_FILE-LIFSK      "ShipBlock
LST_FILE-AUGRU      "OrderReason
LST_FILE-WAERK      "NetPriceCurrency
LST_FILE-SUBMI      "CollectNo
**** start add 2015/05/04 isid18 ****
LST_FILE-BNAME      "OrderName
**** end add 2015/05/04 isid18 ****
LST_FILE-SOLDTO     "SoldTo
LST_FILE-SHIPTO     "ShipTo
LST_FILE-SHIP_NAME  "ShipToName1
LST_FILE-SHIP_NAME2 "ShipToName2
LST_FILE-SHIP_NAME3 "ShipToName3
LST_FILE-COUNTR_ISO "ShipToCountryCode
LST_FILE-POSTL_CODE "ShipToPostalCode
LST_FILE-STREET     "ShipToAddress1
LST_FILE-CITY       "ShipToAddress2
LST_FILE-TELEPHONE  "ShipToTel
LST_FILE-FAX_NUMBER "ShipToFax
LST_FILE-BILLTO     "BillTo
LST_FILE-PAYER      "Payer
LST_FILE-SAEMP      "SalesEmployee
LST_FILE-EDUPRI     "EndUserPrice
LST_FILE-EDUEXP     "EndUserExport
LST_FILE-SAASSIS    "SalesAssistant
**** start upd 2015/05/04 isid18 ****
*      lst_file-langu_iso  "TextLanguage
LST_FILE-ZTERM      "PaymentTerms
**** end upd 2015/05/04 isid18 ****
LST_FILE-INBREM     "TextHdrInboundRemarks
LST_FILE-TABREM     "TextHdrDNRemarks
LST_FILE-SOREM      "TextHdrSORemarks
LST_FILE-ITM_NUMBER "Item
**** start add 2015/05/04 isid18 ****
LST_FILE-PSTYV      "Itemcategory
**** end add 2015/05/04 isid18 ****
LST_FILE-MATERIAL   "Material
LST_FILE-SHORT_TEXT "MaterialText
LST_FILE-PLANT      "Plant
LST_FILE-STORE_LOC  "SLoc
LST_FILE-REQ_DATE   "DeliveryDate
LST_FILE-REQ_QTY    "SOQty
LST_FILE-COND_UNIT  "OrderUnit
**** start add 2015/05/04 isid18 ****
LST_FILE-BSTKD_ITEM "CustomerPONoItm
LST_FILE-BSTDK_ITEM "CustomerPODateItm
LST_FILE-REASON_REJ "RejectReason
**** end add 2015/05/04 isid18 ****
LST_FILE-COND_TYPE  "CondType
LST_FILE-COND_VALUE "NetPrice
LST_FILE-COND_P_UNT "PriceUnit
LST_FILE-ITEMREM    "TextItmShipRemarks
**** start add 2015/05/04 isid18 ****
LST_FILE-TRANSREM   "TextItmTransportMeans
**** end add 2015/05/04 isid18 ****
INTO LW_FILE  SEPARATED BY CNS_TAB.
TRANSFER LW_FILE TO P_EFILE.
ENDLOOP.

* ファイルクローズ
CLOSE DATASET P_EFILE.

ENDFORM.                    " OUTPUT_SERVE

*&---------------------------------------------------------------------*
*&      Form  OUTPUT_LOCAL
*&---------------------------------------------------------------------*
*       ローカルファイル出力
*----------------------------------------------------------------------*
*      -->I_TD_RFILE  Result file table
*      -->I_TD_EFILE  Error file table
*----------------------------------------------------------------------*
FORM OUTPUT_LOCAL USING I_TD_RFILE TYPE TYP_TD_RFILE
**** START UPD 2015/06/18 ISID18 ****
*                        I_TD_EFILE TYPE TYP_TD_FILE.
I_TD_EFILE TYPE TYP_TD_FILE_STR.
**** END UPD 2015/06/18 ISID18 ****

DATA:
LW_FILENAME TYPE STRING.

* A-5-2．RESULTファイルのファイル出力
LW_FILENAME = P_RFILE.
CALL FUNCTION 'GUI_DOWNLOAD'
EXPORTING
FILENAME                = LW_FILENAME
FILETYPE                = CNS_FTYPE
WRITE_FIELD_SEPARATOR   = CNS_TAB
TABLES
DATA_TAB                = I_TD_RFILE
EXCEPTIONS
FILE_WRITE_ERROR        = 1
NO_BATCH                = 2
GUI_REFUSE_FILETRANSFER = 3
INVALID_TYPE            = 4
NO_AUTHORITY            = 5
UNKNOWN_ERROR           = 6
HEADER_NOT_ALLOWED      = 7
SEPARATOR_NOT_ALLOWED   = 8
FILESIZE_NOT_ALLOWED    = 9
HEADER_TOO_LONG         = 10
DP_ERROR_CREATE         = 11
DP_ERROR_SEND           = 12
DP_ERROR_WRITE          = 13
UNKNOWN_DP_ERROR        = 14
ACCESS_DENIED           = 15
DP_OUT_OF_MEMORY        = 16
DISK_FULL               = 17
DP_TIMEOUT              = 18
FILE_NOT_FOUND          = 19
DATAPROVIDER_EXCEPTION  = 20
CONTROL_FLUSH_ERROR     = 21
OTHERS                  = 22.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.

* A-5-3．ERRORファイルのファイル出力
CHECK I_TD_EFILE IS NOT INITIAL.
LW_FILENAME = P_EFILE.
CALL FUNCTION 'GUI_DOWNLOAD'
EXPORTING
FILENAME                = LW_FILENAME
FILETYPE                = CNS_FTYPE
WRITE_FIELD_SEPARATOR   = CNS_TAB
CODEPAGE                = W_CODEPAGE
TABLES
DATA_TAB                = I_TD_EFILE
EXCEPTIONS
FILE_WRITE_ERROR        = 1
NO_BATCH                = 2
GUI_REFUSE_FILETRANSFER = 3
INVALID_TYPE            = 4
NO_AUTHORITY            = 5
UNKNOWN_ERROR           = 6
HEADER_NOT_ALLOWED      = 7
SEPARATOR_NOT_ALLOWED   = 8
FILESIZE_NOT_ALLOWED    = 9
HEADER_TOO_LONG         = 10
DP_ERROR_CREATE         = 11
DP_ERROR_SEND           = 12
DP_ERROR_WRITE          = 13
UNKNOWN_DP_ERROR        = 14
ACCESS_DENIED           = 15
DP_OUT_OF_MEMORY        = 16
DISK_FULL               = 17
DP_TIMEOUT              = 18
FILE_NOT_FOUND          = 19
DATAPROVIDER_EXCEPTION  = 20
CONTROL_FLUSH_ERROR     = 21
OTHERS                  = 22.
IF SY-SUBRC <> 0.
MESSAGE ID SY-MSGID TYPE CNS_MSG_S NUMBER SY-MSGNO
WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4
DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    " OUTPUT_LOCAL
**** start add 2015/05/04 isid18 ****
*&---------------------------------------------------------------------*
*&      Form  get_object_type
*&---------------------------------------------------------------------*
*       ビジネスオブジェクトタイプ
*----------------------------------------------------------------------*
*      -->o_td_busobj  ビジネスオブジェクトタイプ
*----------------------------------------------------------------------*
FORM GET_OBJECT_TYPE
USING    I_DOC_TYPE TYPE VBAK-AUART
CHANGING O_BUS_TYPE TYPE NAST-OBJTYPE.

DATA LW_DOC_TYPE TYPE VBAK-VBTYP.
CLEAR LW_DOC_TYPE.
CASE I_DOC_TYPE.
WHEN 'OR'
OR 'ZOR'
OR 'KA'
OR 'KB'
OR 'KE'.
LW_DOC_TYPE = CNS_VBTYP_C.
WHEN 'RE'
OR 'ZRE'.
LW_DOC_TYPE = CNS_VBTYP_H.
WHEN 'CR'
OR 'ZCR'.
LW_DOC_TYPE = CNS_VBTYP_K.
WHEN 'DR'
OR 'ZDR'.
LW_DOC_TYPE = CNS_VBTYP_L.
WHEN OTHERS.
ENDCASE.

CALL FUNCTION 'SD_OBJECT_TYPE_DETERMINE'
EXPORTING
I_DOCUMENT_TYPE   = LW_DOC_TYPE
IMPORTING
E_BUSINESS_OBJECT = O_BUS_TYPE.

ENDFORM.                    " get_object_type
*&---------------------------------------------------------------------*
*&      Form  CHECK_GFLAG
*&---------------------------------------------------------------------*
*       グループフラグチェック
*----------------------------------------------------------------------*
*      -->I_W_INDEX  行ID
*      -->I_ST_FILE  ファイル データ
*----------------------------------------------------------------------*
FORM CHECK_GFLAG  USING I_W_INDEX   TYPE SY-INDEX
I_ST_FILE   TYPE TYP_FILE.

* group flag check
IF I_ST_FILE-GFLAG <> ABAP_ON AND
I_W_INDEX = 1.
MESSAGE S113(ZMEGSD01) DISPLAY LIKE CNS_MSG_E.
LEAVE LIST-PROCESSING.
ENDIF.

ENDFORM.                    " CHECK_GFLAG
**** end add 2015/05/04 isid18 ****
**** start add 2015/05/26 isid18 ****
**** START DEL BY ISID REN 2015/05/27 ****
*&---------------------------------------------------------------------*
*&      Form  CHECK_DECIMALS
*&---------------------------------------------------------------------*
*       小数部チェック
*----------------------------------------------------------------------*
*      -->I_WAERS  通貨コード
*      -->I_VALUE  数値
*      <--O_MSG    メッセージ
*----------------------------------------------------------------------*
*FORM CHECK_DECIMALS
*  USING    I_WAERS  TYPE VBAK-WAERK
*           I_VALUE  TYPE CHAR17
*  CHANGING O_ERRFLG TYPE CHAR01.
*
*  DATA: LW_DECIS LIKE TCURX-CURRDEC,
*        LW_NUMC  TYPE STRING,
*        LW_DEC   TYPE STRING,
*        LW_LEN   TYPE I.
*
*  CLEAR O_ERRFLG.
*  CALL FUNCTION 'FWOS_CURRENCY_DECIMALS_READ'
*    EXPORTING
*      I_CURRENCY         = I_WAERS
*    IMPORTING
*      E_DECIMALS         = LW_DECIS
*    EXCEPTIONS
*      I_CURRENCY_INITIAL = 1
*      OTHERS             = 2.
*
*  SPLIT I_VALUE AT '.' INTO LW_NUMC LW_DEC.
*  LW_LEN = STRLEN( LW_DEC ).
*  IF LW_LEN > LW_DECIS.
*    O_ERRFLG = ABAP_ON.
*  ENDIF.
*
*ENDFORM.                    " CHECK_DECIMALS
**** END DEL BY ISID REN 2015/05/27 ****
**** end add 2015/05/26 isid18 ****
**** START ADD 2015/06/18 ISID18 ****
*&---------------------------------------------------------------------*
*&      Form  GET_FILE_TITLE
*&---------------------------------------------------------------------*
*       タイトル行取得
*----------------------------------------------------------------------*
*      -->I_ST_SFILE        FILEDATA
*      <--O_ST_FILE_STR    タイトル行
*----------------------------------------------------------------------*
FORM GET_FILE_TITLE
USING    I_ST_SFILE    TYPE TYP_SFILE
CHANGING O_ST_FILE_STR TYPE TYP_FILE_STR.

SPLIT I_ST_SFILE-FIELD
AT CNS_TAB
INTO O_ST_FILE_STR-TCD            "TCD
O_ST_FILE_STR-GFLAG          "GroupFlag
O_ST_FILE_STR-AUART          "DocType
O_ST_FILE_STR-VKORG          "SalesOrg
O_ST_FILE_STR-VTWEG          "DistChannel
O_ST_FILE_STR-SPART          "Division
O_ST_FILE_STR-VKBUR          "SalesOffice
O_ST_FILE_STR-VKGRP          "SalesGrp
O_ST_FILE_STR-VBELN          "SONo
O_ST_FILE_STR-BSTKD          "CustPurchNo
O_ST_FILE_STR-BSTDK          "CustPurchDate
O_ST_FILE_STR-AUDAT          "DocDate
O_ST_FILE_STR-PRSDT          "PriceDate
O_ST_FILE_STR-LIFSK          "ShipBlock
O_ST_FILE_STR-AUGRU          "OrderReason
O_ST_FILE_STR-WAERK          "NetPriceCurrency
O_ST_FILE_STR-SUBMI          "CollectNo
O_ST_FILE_STR-BNAME          "OrderName
O_ST_FILE_STR-SOLDTO         "SoldTo
O_ST_FILE_STR-SHIPTO         "ShipTo
O_ST_FILE_STR-SHIP_NAME      "ShipToName1
O_ST_FILE_STR-SHIP_NAME2     "ShipToName2
O_ST_FILE_STR-SHIP_NAME3     "ShipToName3
O_ST_FILE_STR-COUNTR_ISO     "ShipToCountryCode
O_ST_FILE_STR-POSTL_CODE     "ShipToPostalCode
O_ST_FILE_STR-STREET         "ShipToAddress1
O_ST_FILE_STR-CITY           "ShipToAddress2
O_ST_FILE_STR-TELEPHONE      "ShipToTel
O_ST_FILE_STR-FAX_NUMBER     "ShipToFax
O_ST_FILE_STR-BILLTO         "BillTo
O_ST_FILE_STR-PAYER          "Payer
O_ST_FILE_STR-SAEMP          "SalesEmployee
O_ST_FILE_STR-EDUPRI         "EndUserPrice
O_ST_FILE_STR-EDUEXP         "EndUserExport
O_ST_FILE_STR-SAASSIS        "SalesAssistant
O_ST_FILE_STR-ZTERM          "PaymentTerms
O_ST_FILE_STR-INBREM         "TextHdrInboundRemarks
O_ST_FILE_STR-TABREM         "TextHdrDNRemarks
O_ST_FILE_STR-SOREM          "TextHdrSORemarks
O_ST_FILE_STR-ITM_NUMBER     "Item
O_ST_FILE_STR-PSTYV          "Itemcategory
O_ST_FILE_STR-MATERIAL       "Material
O_ST_FILE_STR-SHORT_TEXT     "MaterialText
O_ST_FILE_STR-PLANT          "Plant
O_ST_FILE_STR-STORE_LOC      "SLoc
O_ST_FILE_STR-REQ_DATE       "DeliveryDate
O_ST_FILE_STR-REQ_QTY        "SOQty
O_ST_FILE_STR-COND_UNIT      "OrderUnit
O_ST_FILE_STR-BSTKD_ITEM     "CustomerPONoItm
O_ST_FILE_STR-BSTDK_ITEM     "CustomerPODateItm
O_ST_FILE_STR-REASON_REJ     "RejectReason
O_ST_FILE_STR-COND_TYPE      "CondType
O_ST_FILE_STR-COND_VALUE     "NetPrice
O_ST_FILE_STR-COND_P_UNT     "PriceUnit
O_ST_FILE_STR-ITEMREM        "TextItmShipRemarks
O_ST_FILE_STR-TRANSREM.      "TextItmTransportMeans

ENDFORM.                    " GET_FILE_TITLE
**** END ADD 2015/06/18 ISID18 ****
*Text symbol text・
*001:Mode
*002:Server
*003:Local
*004:Test Run
*005:File Option
*006:General Option
*007:(Sales Order)
*008:[Error]
*009:[Information]
*010:CLIENT
*011:PROGRAM
*012:USER
*013:Date
*014:Time
*015:<<<Sales Order Upload>>>
*016:<Parameters>
*017:Mode
*018:Test Run
*019:Plant
*020:File Name(Input)
*021:File Name(Result)
*022:File Name(Error)
*023:<Result>
*024:Number of Transcations
*025:Number of Normal
*026:Number of Errors
*027:<Message>
*030:[Warning]
*031:(Row=
*032:)
*033:Row:
*034:/
*035:Item:
*E01:ZTEGZZM001
*E02:CustSalesDate
*E03:DocDate
*E04:PriceDate
*E05:SOQty
*E06:NetPrice
*E07:PriceUnit
*E08:CustomerPODateItm
*E09:DeliveryDate

*Selection text・
*P_EFILE:        File Path(Error)
*P_IFILE:        File Path(Input)
*P_LOCAL:        Local
*P_RFILE:        File Path(Result)
*P_SERVE:        Server
*P_TSTCK:        Test Run
*S_WERKS:        Plant
