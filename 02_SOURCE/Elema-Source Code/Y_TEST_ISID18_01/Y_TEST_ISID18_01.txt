*&---------------------------------------------------------------------*
*& Report  Y_TEST_ISID18_01
*&
*&---------------------------------------------------------------------*
*&
*&
*&---------------------------------------------------------------------*

REPORT  Y_TEST_ISID18_01.

PARAMETERS:
RB_INT AS CHECKBOX,    "通常処理
RB_DEL AS CHECKBOX.                "再作成

PARAMETERS:
P_VBELN TYPE VBELN_VL,
P_BVBELN TYPE BAPIVBELN-VBELN.

PARAMETERS: P_ANJIAN TYPE CHAR7 ,

P_INPO TYPE   POSNR_VA ,
P_DELPO TYPE   POSNR_VA .

DATA:
I_HEADER_VL  TYPE BAPIOBDLVHDRCHG,
LTH_CONTROL   TYPE BAPIOBDLVHDRCTRLCHG,
LTH_DELIVERY  TYPE BAPIOBDLVHDRCHG-DELIV_NUMB,
I_T_ITEM_VL  TYPE STANDARD TABLE OF BAPIOBDLVITEMCHG,
I_H_ITEM_VL  TYPE BAPIOBDLVITEMCHG,
I_T_CTRL_VL  TYPE STANDARD TABLE OF BAPIOBDLVITEMCTRLCHG,
I_H_CTRL_VL  TYPE BAPIOBDLVITEMCTRLCHG,
LTD_RETURN    TYPE BAPIRET2_T,

I_SALESDOC   TYPE BAPIVBELN-VBELN,
I_HEADER_VAX TYPE BAPISDHD1X,
I_T_ITEM_VA  TYPE STANDARD TABLE OF BAPISDITM,
I_H_ITEM_VA  TYPE BAPISDITM,
I_T_ITEM_VAX TYPE STANDARD TABLE OF BAPISDITMX,
I_H_ITEM_VAX TYPE BAPISDITMX,

I_HEADER_IN  TYPE BAPISDHD1,
I_HEADER_INX TYPE BAPISDHD1X,
LW_VBELN     TYPE BAPIVBELN-VBELN,
I_T_ITEMS_IN       TYPE STANDARD TABLE OF BAPISDITM,
I_H_ITEMS_IN       TYPE BAPISDITM,
I_T_ITEMS_INX      TYPE STANDARD TABLE OF BAPISDITMX,
I_H_ITEMS_INX      TYPE BAPISDITMX,
I_T_PARTNERS       TYPE STANDARD TABLE OF BAPIPARNR,
I_H_PARTNERS       TYPE BAPIPARNR,
I_T_SCHEDULES_IN   TYPE STANDARD TABLE OF BAPISCHDL,
I_H_SCHEDULES_IN   TYPE BAPISCHDL,
I_T_SCHEDULES_INX  TYPE STANDARD TABLE OF BAPISCHDLX,
I_H_SCHEDULES_INX  TYPE BAPISCHDLX,
I_T_CONDITIONS_IN  TYPE STANDARD TABLE OF BAPICOND,
I_H_CONDITIONS_IN  TYPE BAPICOND,
I_T_CONDITIONS_INX TYPE STANDARD TABLE OF BAPICONDX,
I_H_CONDITIONS_INX TYPE BAPICONDX,
I_T_EXTENSIONIN    TYPE STANDARD TABLE OF BAPIPAREX,
I_H_EXTENSIONIN    TYPE BAPIPAREX.



IF  RB_DEL IS NOT INITIAL.
I_HEADER_VL-DELIV_NUMB = P_VBELN.

I_H_ITEM_VL-DELIV_NUMB = P_VBELN.
I_H_ITEM_VL-DELIV_ITEM = P_DELPO.
I_H_ITEM_VL-FACT_UNIT_NOM = '1'.
I_H_ITEM_VL-FACT_UNIT_DENOM = '1'.
APPEND I_H_ITEM_VL TO I_T_ITEM_VL.

I_H_CTRL_VL-DELIV_NUMB = P_VBELN.
I_H_CTRL_VL-DELIV_ITEM = P_DELPO.
I_H_CTRL_VL-DEL_ITEM = 'X'.
APPEND I_H_CTRL_VL TO I_T_CTRL_VL.

* 出荷伝票取消
*  CALL FUNCTION 'Y_BAPI_OUTB_DELIVERY_CHANGE'
CALL FUNCTION 'BAPI_OUTB_DELIVERY_CHANGE'
EXPORTING
HEADER_DATA    = I_HEADER_VL
HEADER_CONTROL = LTH_CONTROL
DELIVERY       = LTH_DELIVERY
TABLES
ITEM_DATA      = I_T_ITEM_VL
ITEM_CONTROL   = I_T_CTRL_VL
RETURN         = LTD_RETURN.

*   コミット
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
WAIT = ABAP_TRUE.

*    COMMIT WORK AND WAIT.

I_SALESDOC = P_BVBELN.
I_HEADER_VAX-UPDATEFLAG = 'U'.

I_H_ITEM_VA-ITM_NUMBER = P_DELPO.
I_H_ITEM_VA-REASON_REJ = '01'.
APPEND I_H_ITEM_VA TO I_T_ITEM_VA.

I_H_ITEM_VAX-ITM_NUMBER = P_DELPO.
I_H_ITEM_VAX-UPDATEFLAG = 'U'.
I_H_ITEM_VAX-REASON_REJ = 'X'.
APPEND I_H_ITEM_VAX TO I_T_ITEM_VAX.

* 受注伝票拒否
*  CALL FUNCTION 'Y_SD_SALESDOCUMENT_CHANGE'
CALL FUNCTION 'SD_SALESDOCUMENT_CHANGE'
EXPORTING
SALESDOCUMENT    = I_SALESDOC
ORDER_HEADER_INX = I_HEADER_VAX
TABLES
RETURN           = LTD_RETURN
ITEM_IN          = I_T_ITEM_VA
ITEM_INX         = I_T_ITEM_VAX.

*   コミット
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
WAIT = ABAP_TRUE.

*    COMMIT WORK AND WAIT.
ENDIF.

IF RB_INT IS NOT INITIAL.
CLEAR:
I_HEADER_IN,
I_HEADER_INX,
LW_VBELN.
FREE:
I_T_ITEMS_IN,
I_T_ITEMS_INX,
I_T_PARTNERS,
I_T_SCHEDULES_IN,
I_T_SCHEDULES_INX,
I_T_CONDITIONS_IN,
I_T_CONDITIONS_INX,
I_T_EXTENSIONIN,
LTD_RETURN.

I_HEADER_IN-DOC_TYPE   = 'TA'.
I_HEADER_IN-SALES_ORG  = 'HK01'.
I_HEADER_IN-DISTR_CHAN = '10'.
I_HEADER_IN-DIVISION   = '10'.
I_HEADER_IN-REQ_DATE_H = '20160825'.

I_HEADER_INX-DOC_TYPE   = 'X'.
I_HEADER_INX-SALES_ORG  = 'X'.
I_HEADER_INX-DISTR_CHAN = 'X'.
I_HEADER_INX-DIVISION   = 'X'.
I_HEADER_INX-REQ_DATE_H = 'X'.

I_H_ITEMS_IN-ITM_NUMBER = P_INPO.
I_H_ITEMS_IN-MATERIAL = 'ALA-ITEM-01'.
I_H_ITEMS_IN-PLANT = 'HK01'.
I_H_ITEMS_IN-STORE_LOC = 'H000'.
I_H_ITEMS_IN-TARGET_QTY = '1'.
I_H_ITEMS_IN-PURCH_NO_C = '12'.
APPEND I_H_ITEMS_IN TO I_T_ITEMS_IN.
*  I_H_ITEMS_IN-ITM_NUMBER = '000020'.
*  I_H_ITEMS_IN-MATERIAL = 'ZSD1010920-09'.
*  I_H_ITEMS_IN-PLANT = '5000'.
*  I_H_ITEMS_IN-STORE_LOC = '0150'.
*  I_H_ITEMS_IN-TARGET_QTY = '100.000'.
*  I_H_ITEMS_IN-PURCH_NO_C = '123000000000'.
*  APPEND I_H_ITEMS_IN TO I_T_ITEMS_IN.

I_H_ITEMS_INX-ITM_NUMBER = P_INPO.
I_H_ITEMS_INX-MATERIAL = 'X'.
I_H_ITEMS_INX-PLANT = 'X'.
I_H_ITEMS_INX-STORE_LOC = 'X'.
*  I_H_ITEMS_INX-TARGET_QTY = '100.000'.
I_H_ITEMS_INX-PURCH_NO_C = 'X'.
I_H_ITEMS_INX-ROUTE = 'X'.
I_H_ITEMS_INX-MAT_PR_GRP = 'X'.
APPEND I_H_ITEMS_INX TO I_T_ITEMS_INX.

*  I_H_ITEMS_INX-ITM_NUMBER = '000020'.
*  I_H_ITEMS_INX-MATERIAL = 'X'.
*  I_H_ITEMS_INX-PLANT = 'X'.
*  I_H_ITEMS_INX-STORE_LOC = 'X'.
**  I_H_ITEMS_INX-TARGET_QTY = '100.000'.
*  I_H_ITEMS_INX-PURCH_NO_C = 'X'.
*  I_H_ITEMS_INX-ROUTE = 'X'.
*  I_H_ITEMS_INX-MAT_PR_GRP = 'X'.
*  APPEND I_H_ITEMS_INX TO I_T_ITEMS_INX.

I_H_PARTNERS-PARTN_ROLE = 'AG'.
I_H_PARTNERS-PARTN_NUMB = 'HK100700U'.
APPEND I_H_PARTNERS TO I_T_PARTNERS.
I_H_PARTNERS-PARTN_ROLE = 'WE'.
I_H_PARTNERS-PARTN_NUMB = 'HK100700U'.
APPEND I_H_PARTNERS TO I_T_PARTNERS.
*  I_H_PARTNERS-PARTN_ROLE = 'VE'.
*  I_H_PARTNERS-PARTN_NUMB = '00005226'.
*  APPEND I_H_PARTNERS TO I_T_PARTNERS.

I_H_SCHEDULES_IN-ITM_NUMBER = P_INPO.
I_H_SCHEDULES_IN-SCHED_LINE = '0001'.
I_H_SCHEDULES_IN-REQ_DATE = '20160825'.
I_H_SCHEDULES_IN-REQ_QTY = '1'.
APPEND I_H_SCHEDULES_IN TO I_T_SCHEDULES_IN.
*  I_H_SCHEDULES_IN-ITM_NUMBER = '000020'.
*  I_H_SCHEDULES_IN-SCHED_LINE = '0001'.
*  I_H_SCHEDULES_IN-REQ_DATE = '20160825'.
*  I_H_SCHEDULES_IN-REQ_QTY = '100.000'.
*  APPEND I_H_SCHEDULES_IN TO I_T_SCHEDULES_IN.

I_H_SCHEDULES_INX-ITM_NUMBER = P_INPO.
I_H_SCHEDULES_INX-SCHED_LINE = '0001'.
I_H_SCHEDULES_INX-REQ_DATE = 'X'.
I_H_SCHEDULES_INX-REQ_QTY = 'X'.
APPEND I_H_SCHEDULES_INX TO I_T_SCHEDULES_INX.
*  I_H_SCHEDULES_INX-ITM_NUMBER = '000020'.
*  I_H_SCHEDULES_INX-SCHED_LINE = '0001'.
*  I_H_SCHEDULES_INX-REQ_DATE = 'X'.
*  I_H_SCHEDULES_INX-REQ_QTY = 'X'.
*  APPEND I_H_SCHEDULES_INX TO I_T_SCHEDULES_INX.

*  I_H_EXTENSIONIN-STRUCTURE = 'BAPE_VBAK'.
*  I_H_EXTENSIONIN-VALUEPART1 = '                    test123            test12345te'
*                             & 'st123456                           000000000000000'
*                             & '0'.
*
*  I_H_EXTENSIONIN-VALUEPART2 = '                        1                 '
*                             & '                                                  '
*                             & '    00000000COME123456789012345678901234'.
*
*
*  CONCATENATE I_H_EXTENSIONIN-VALUEPART1
*              P_ANJIAN
*              I_H_EXTENSIONIN-VALUEPART2
*         INTO I_H_EXTENSIONIN-VALUEPART1.
*
*
*
*  I_H_EXTENSIONIN-VALUEPART2 = '56789A'.
*  APPEND I_H_EXTENSIONIN TO I_T_EXTENSIONIN.

*  CALL FUNCTION 'Y_SD_SALESDOCUMENT_CREATE'
CALL FUNCTION 'SD_SALESDOCUMENT_CREATE'
EXPORTING
SALES_HEADER_IN       = I_HEADER_IN
SALES_HEADER_INX      = I_HEADER_INX
*      STATUS_BUFFER_REFRESH = SPACE
IMPORTING
SALESDOCUMENT_EX     = LW_VBELN
TABLES
RETURN               = LTD_RETURN
SALES_ITEMS_IN       = I_T_ITEMS_IN
SALES_ITEMS_INX      = I_T_ITEMS_INX
SALES_PARTNERS       = I_T_PARTNERS
SALES_SCHEDULES_IN   = I_T_SCHEDULES_IN
SALES_SCHEDULES_INX  = I_T_SCHEDULES_INX
SALES_CONDITIONS_IN  = I_T_CONDITIONS_IN
SALES_CONDITIONS_INX = I_T_CONDITIONS_INX.
*      EXTENSIONIN          = I_T_EXTENSIONIN.

*   コミット
CALL FUNCTION 'BAPI_TRANSACTION_COMMIT'
EXPORTING
WAIT = ABAP_TRUE.

WRITE / LW_VBELN .

ENDIF.
