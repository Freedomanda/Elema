************************************************************************
*             Z_Z_KIKAN:会計期間
*             Z_NEN1:年度
* 追加:2011/07/22 バリアント変数の追加 SOLFIS
*                 Z_KIKAN2
*&     2012/08/21 ISID ES-UP
* 追加:2013/06/11 バリアント変数の追加 GSL
*                 Z_KIKAN3
*                 Z_NEN3
************************************************************************
REPORT yb020600_test MESSAGE-ID y1.

tables: tvarvc,
t001.

DATA: w_nendo(4) TYPE n,
w_z_kikan(3) TYPE n,
w_nen(4) TYPE n,
w_tuki(2) TYPE n,
w_date LIKE sy-datum,
w_lmdate LIKE sy-datum,
w_lmnen(4) TYPE n,
w_nen1(4) TYPE n,
w_time LIKE sy-uzeit,
w_date_t LIKE sy-datum,
w_datum LIKE sy-datum,
w_datum2 LIKE tvarv-low,
w_ndate LIKE sy-datum,
z_kikan(3) TYPE n,
z_kikan2(3) TYPE n,
z_kikan3(3) TYPE n,
z_nen1(4) TYPE n,
z_nen2(4) TYPE n,
z_nen3(4) TYPE n,
z_tsuki(2) TYPE n,
w_fdate LIKE sy-datum,
mesline(200) TYPE c .
* グローバル変数
DATA w_low LIKE tvarv-low.
DATA w_name LIKE tvarv-name.
DATA i_tvarv_s LIKE STANDARD TABLE OF tvarvc WITH HEADER LINE.
DATA i_tvarv_u LIKE STANDARD TABLE OF tvarvc WITH HEADER LINE.
DATA w_p_datum LIKE sy-datum.
DATA w_p_name(4) TYPE c.
DATA w_p_mandt LIKE sy-mandt.
DATA w_p_name01 LIKE tvarv-name.
DATA w_p_name02 LIKE tvarv-name.
DATA w_p_name03 LIKE tvarv-name.

PARAMETERS: p_bukrs LIKE t001-bukrs OBLIGATORY,
p_fcal(2) TYPE c,
p_fcal2(2) TYPE c,
p_date LIKE sy-datum,
p_time LIKE sy-uzeit,
p_param AS CHECKBOX.

PARAMETERS:p_times(2) TYPE n.

AT SELECTION-SCREEN.
* 会社情報の取得
SELECT SINGLE * FROM  t001
WHERE  bukrs       = p_bukrs        .
IF sy-subrc <> 0.
MESSAGE e308 WITH '会社コード' p_bukrs.
ENDIF.
*
START-OF-SELECTION.
DO p_times TIMES.
CALL FUNCTION 'RZL_SLEEP'
EXPORTING
seconds        = 1
EXCEPTIONS
argument_error = 1
OTHERS         = 2.
IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDDO.
* 日次処理年月日の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDSYMD'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYMD'.
ENDIF.
** システム日時の取得
IF p_param = space.
MOVE: sy-datum TO w_date,
sy-uzeit TO w_time.
ELSE.
MOVE: p_date TO w_date,
p_time TO w_time.
ENDIF.
** 時刻による判定
IF w_time >= '000000' AND
w_time <= '070000'.
w_date = w_date - 1.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_date TO tvarv-low.
*  UPDATE tvarv.
MOVE w_date TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYMD'.
ENDIF.
***2002.04.16 ADD >>>
CLEAR:z_nen1.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_NEN1'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN1'.
ENDIF.
*
CALL FUNCTION 'DATE_TO_PERIOD_CONVERT'
EXPORTING
i_date               = w_date
*   I_MONMIT             = 00
i_periv              = 'V3'
IMPORTING
*   E_BUPER              =
e_gjahr              = w_nen1
EXCEPTIONS
input_false          = 1
t009_notfound        = 2
t009b_notfound       = 3
OTHERS               = 4
.
IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

*  MOVE w_date TO tvarv-low.
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = w_nen1.
*  UPDATE tvarv.
tvarvc-low = w_nen1.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN1'.
ENDIF.
*
* SY-DATUM+1 稼働日判断なし
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM'.
ENDIF.
w_ndate = w_date + 1.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_ndate TO tvarv-low.
*  UPDATE tvarv.
MOVE w_ndate TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM'.
ENDIF.

****会計期間
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_KIKAN'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN'.
ENDIF.

*
IF     w_ndate+4(2) = '05'.
z_kikan = '002'.
ELSEIF w_ndate+4(2) = '06'.
z_kikan = '003'.
ELSEIF w_ndate+4(2) = '07'.
z_kikan = '004'.
ELSEIF w_ndate+4(2) = '08'.
z_kikan = '005'.
ELSEIF w_ndate+4(2) = '09'.
z_kikan = '006'.
ELSEIF w_ndate+4(2) = '10'.
z_kikan = '007'.
ELSEIF w_ndate+4(2) = '11'.
z_kikan = '008'.
ELSEIF w_ndate+4(2) = '12'.
z_kikan = '009'.
ELSEIF w_ndate+4(2) = '01'.
z_kikan = '010'.
ELSEIF w_ndate+4(2) = '02'.
z_kikan = '011'.
ELSEIF w_ndate+4(2) = '03'.
z_kikan = '012'.
ELSEIF w_ndate+4(2) = '04'.
z_kikan = '001'.
ENDIF.
*
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = z_kikan.
*  UPDATE tvarv.
tvarvc-low = z_kikan.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN'.
ENDIF.

***2002.04.16 ADD <<<

* ADD 2011/07/21 >>> バリアント変数を追加
* 会計期間２
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_KIKAN2'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN2'.
ENDIF.

*
IF     w_date+4(2) = '05'.
z_kikan2 = '002'.
ELSEIF w_date+4(2) = '06'.
z_kikan2 = '003'.
ELSEIF w_date+4(2) = '07'.
z_kikan2 = '004'.
ELSEIF w_date+4(2) = '08'.
z_kikan2 = '005'.
ELSEIF w_date+4(2) = '09'.
z_kikan2 = '006'.
ELSEIF w_date+4(2) = '10'.
z_kikan2 = '007'.
ELSEIF w_date+4(2) = '11'.
z_kikan2 = '008'.
ELSEIF w_date+4(2) = '12'.
z_kikan2 = '009'.
ELSEIF w_date+4(2) = '01'.
z_kikan2 = '010'.
ELSEIF w_date+4(2) = '02'.
z_kikan2 = '011'.
ELSEIF w_date+4(2) = '03'.
z_kikan2 = '012'.
ELSEIF w_date+4(2) = '04'.
z_kikan2 = '001'.
ENDIF.
*
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = z_kikan2.
*  UPDATE tvarv.
tvarvc-low = z_kikan2.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN2'.
ENDIF.
* ADD 2011/07/21 <<< バリアント変数を追加

* ADD 2013/06/11 >>> バリアント変数を追加
* 当日の前期の会計年度・会計期間を取得する
* 会計期間３
SELECT SINGLE * FROM  tvarvc
WHERE  name        = 'Z_KIKAN3'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN3'.
ENDIF.
*前月を取得
CALL FUNCTION 'BKK_ADD_MONTH_TO_DATE'
EXPORTING
MONTHS        = -1
OLDDATE       = w_date
IMPORTING
NEWDATE       = w_lmdate
.
*
IF     w_lmdate+4(2) = '05'.
z_kikan3 = '002'.
ELSEIF w_lmdate+4(2) = '06'.
z_kikan3 = '003'.
ELSEIF w_lmdate+4(2) = '07'.
z_kikan3 = '004'.
ELSEIF w_lmdate+4(2) = '08'.
z_kikan3 = '005'.
ELSEIF w_lmdate+4(2) = '09'.
z_kikan3 = '006'.
ELSEIF w_lmdate+4(2) = '10'.
z_kikan3 = '007'.
ELSEIF w_lmdate+4(2) = '11'.
z_kikan3 = '008'.
ELSEIF w_lmdate+4(2) = '12'.
z_kikan3 = '009'.
ELSEIF w_lmdate+4(2) = '01'.
z_kikan3 = '010'.
ELSEIF w_lmdate+4(2) = '02'.
z_kikan3 = '011'.
ELSEIF w_lmdate+4(2) = '03'.
z_kikan3 = '012'.
ELSEIF w_lmdate+4(2) = '04'.
z_kikan3 = '001'.
ENDIF.

tvarvc-low = z_kikan3.
UPDATE tvarvc.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN3'.
ENDIF.

* 会計年度３
* 前期の会計年度を設定する
SELECT SINGLE * FROM  tvarvc
WHERE  name        = 'Z_NEN3'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN3'.
ENDIF.

CALL FUNCTION 'FI_PERIOD_DETERMINE'
EXPORTING
i_budat        = w_lmdate
i_bukrs        = p_bukrs
IMPORTING
e_gjahr        = z_nen3
EXCEPTIONS
fiscal_year    = 1
period         = 2
period_version = 3
posting_period = 4
special_period = 5
version        = 6
posting_date   = 7
OTHERS         = 8.

tvarvc-low = z_nen3.
UPDATE tvarvc.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN3'.
ENDIF.


* ADD 2013/06/11 <<< バリアント変数を追加

***2002.07.24 ADD >>>
* SY-DATUM+1 稼働日判断なし
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_NEN2'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN2'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = w_date+0(4).
*  UPDATE tvarv.
tvarvc-low = w_date+0(4).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN2'.
ENDIF.
***
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_TSUKI'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_TSUKI'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = w_date+4(2).
*  UPDATE tvarv.
tvarvc-low = w_date+4(2).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_TSUKI'.
ENDIF.

***2002.07.24 ADD<<<

* ADD 2011/03/23 >>> バリアント変数を追加
* 処理年(範囲)
PERFORM set_current_year_for_range.
* 処理月(範囲)
PERFORM set_current_month_for_range.
* ADD 2011/03/23 <<<

***2002.04.12 ADD >>>
*
CLEAR:w_datum.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM2'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM2'.
ENDIF.
CLEAR:w_datum2.
* Mod ES-UP 2012/09/03 -->
*  SELECT SINGLE low INTO w_datum2 FROM  tvarv
SELECT SINGLE low INTO w_datum2 FROM  tvarvc
* Mod ES-UP 2012/09/03 <--
WHERE  name        = 'Z_DATUM'
AND    type        = 'P'
AND    numb        = 0000           .
IF w_datum2 >= sy-datum.
w_datum = w_date.    "YPDSYMDをわたす"
ELSEIF w_datum2 < sy-datum.
w_datum = w_datum2.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_datum TO tvarv-low.
*  MOVE w_date TO tvarv-high.   "YPDSYMDをわたす"
****2002.07.24 >>>
*  MOVE 'BT' TO tvarv-opti.
****2002.07.24 <<<
*  UPDATE tvarv.
MOVE w_datum TO tvarvc-low.
MOVE w_date TO tvarvc-high.   "YPDSYMDをわたす"
MOVE 'BT' TO tvarvc-opti.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM2'.
ENDIF.
*
CLEAR:w_datum.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM3'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM3'.
ENDIF.
CLEAR:w_datum2.
* Mod ES-UP 2012/09/03 -->
*  SELECT SINGLE low INTO w_datum2 FROM  tvarv
SELECT SINGLE low INTO w_datum2 FROM  tvarvc
* Mod ES-UP 2012/09/03 <--
WHERE  name        = 'Z_DATUM'
AND    type        = 'P'
AND    numb        = 0000           .
IF w_datum2 >= sy-datum.
w_datum = w_date.    "YPDSYMDをわたす"
ELSEIF w_datum2 < sy-datum.
w_datum = w_datum2.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_datum TO tvarv-low.
*  UPDATE tvarv.
MOVE w_datum TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM3'.
ENDIF.
*
***2002.08.02 add >>>
CLEAR:w_datum.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM4'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM4'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_ndate TO tvarv-low.
****2002.07.24 >>>
*  MOVE 'EQ' TO tvarv-opti.
****2002.07.24 <<<
*  UPDATE tvarv.
MOVE w_ndate TO tvarvc-low.
MOVE 'EQ' TO tvarvc-opti.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM4'.
ENDIF.
***2002.08.02 add <<<
***2002.04.12 add <<<
* ＭＲＰ処理年月日の更新
CLEAR:w_ndate.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDMRP'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDMRP'.
ENDIF.
w_ndate = w_date + 1.
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
correct_option               = '+'
date                         = w_ndate
factory_calendar_id          = p_fcal
IMPORTING
date                         = w_fdate
*         FACTORYDATE                  =
*         WORKINGDAY_INDICATOR         =
EXCEPTIONS
calendar_buffer_not_loadable = 1
correct_option_invalid       = 2
date_after_range             = 3
date_before_range            = 4
date_invalid                 = 5
factory_calendar_not_found   = 6
OTHERS                       = 7.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'DATE_CONVERT_TO_FACTORYDATE' sy-subrc.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_fdate TO tvarv-low.
*  UPDATE tvarv.
MOVE w_fdate TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDMRP'.
ENDIF.
* YPDGESHO 前稼働日による更新 2001.09.27
DATA: w_date_pre LIKE w_date.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDGESHO'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDGESHO'.
ENDIF.
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
factory_calendar_id          = p_fcal2
correct_option               = '-'
date                         = w_date
IMPORTING
date                         = w_date_pre
*         FACTORYDATE                  =
*         WORKINGDAY_INDICATOR         =
EXCEPTIONS
calendar_buffer_not_loadable = 1
correct_option_invalid       = 2
date_after_range             = 3
date_before_range            = 4
date_invalid                 = 5
factory_calendar_not_found   = 6
OTHERS                       = 7.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'DATE_CONVERT_TO_FACTORYDATE' sy-subrc.
ELSE.
* Mod ES-UP 2012/08/21 -->
*    MOVE w_date_pre TO tvarv-low.
*    UPDATE tvarv.
MOVE w_date_pre TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDGESHO'.
ENDIF.
ENDIF.
*>>>>>月次のみLIS関連日付更新 20011105
IF w_date_pre = w_date.
PERFORM getuji.
ENDIF.
*<<<<<月次のみLIS関連日付更新 20011105
*2002/08/01 ADD START
PERFORM yk_edit. "YK02,YK03,Yk04 の更新
*2002/08/01 ADD END
MESSAGE i402 WITH '更新を終了しました'.

*2002/08/23 Add Start
COMMIT WORK .
* Mod ES-UP 2012/08/21 -->
*  SELECT * FROM tvarv .
SELECT * FROM tvarvc .
* Mod ES-UP 2012/08/21 <--
* Mod ES-UP 2012/08/21 -->
*    CONCATENATE tvarv-type
*                tvarv-numb
*                tvarv-sign
*                tvarv-opti
*                tvarv-low
*                tvarv-high
CONCATENATE tvarvc-type
tvarvc-numb
tvarvc-sign
tvarvc-opti
tvarvc-low
tvarvc-high
* Mod ES-UP 2012/08/21 <--
INTO  mesline
SEPARATED BY ' | ' .
* Mod ES-UP 2012/08/21 -->
*    MESSAGE s402 WITH tvarv-name '=' mesline .
MESSAGE s402 WITH tvarvc-name '=' mesline .
* Mod ES-UP 2012/08/21 <--
ENDSELECT .
*2002/08/23 Add End

* Add 2004/05/20 >>>
PERFORM set_printlistdate .
* Add 2004/05/20 <<<

* ADD 2004/10/26 >>>  バリアント変数を追加
PERFORM set_archive_bari.
* ADD 2004/10/26 <<<

* ADD 2005/06/10 >>>  バリアント変数を追加
PERFORM set_dal_date_bari USING sy-datum.
* ADD 2005/06/10 <<<

* ADD 2010/07/28 >>> バリアント変数を追加
PERFORM set_archive_vari_for_fico.
* ADD 2010/07/28 <<<

*&---------------------------------------------------------------------*
*&      Form  GETUJI
*&---------------------------------------------------------------------*
*       月次のみLIS関連日付更新 20011105 TAKI
*       （随時更新していた機能をフォームに集約して
*         月次のみ実行される様にした）
*----------------------------------------------------------------------*
FORM getuji.
*** 1999/01/27追加START
* 日次処理年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDSYM'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYM'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_date(6) TO tvarv-low.
*  UPDATE tvarv.
MOVE w_date(6) TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYM'.
ENDIF.
*** 1999/01/27追加END
* 期初年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDKISHO'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKISHO'.
ENDIF.
IF w_date+4(4) >= '0401' AND
w_date+4(4) <= '0930'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '04' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'04' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSEIF w_date+4(4) >= '1001' AND
w_date+4(4) <= '1231'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '10' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'10' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSE.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen - 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '10' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'10' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  UPDATE tvarv.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKISHO'.
ENDIF.
* 期末年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDKIMATU'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKIMATU'.
ENDIF.
IF w_date+4(4) >= '0401' AND
w_date+4(4) <= '0930'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '09' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'09' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSEIF w_date+4(4) >= '1001' AND
w_date+4(4) <= '1231'.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen + 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '03' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'03' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSE.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '03' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'03' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  UPDATE tvarv.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKIMATU'.
ENDIF.
* 前期期初年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDZKISHO'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDZKISHO'.
ENDIF.
IF w_date+4(4) >= '0401' AND
w_date+4(4) <= '0930'.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen - 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '10' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'10' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSEIF w_date+4(4) >= '1001' AND
w_date+4(4) <= '1231'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '04' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'04' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSE.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen - 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '04' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'04' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  UPDATE tvarv.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDZKISHO'.
ENDIF.
* 日次処理年月日（範囲）の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YSDSYMDH'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDSYMDH'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE: w_date(6) TO tvarv-low,
*        '01' TO tvarv-low+6(2).
MOVE: w_date(6) TO tvarvc-low,
'01' TO tvarvc-low+6(2).
* Mod ES-UP 2012/08/21 <--
CALL FUNCTION 'FI_PERIOD_DETERMINE'
EXPORTING
i_budat        = w_date
i_bukrs        = p_bukrs
IMPORTING
e_gjahr        = w_nendo
e_poper        = w_z_kikan
EXCEPTIONS
fiscal_year    = 1
period         = 2
period_version = 3
posting_period = 4
special_period = 5
version        = 6
posting_date   = 7
OTHERS         = 8.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'FI_PERIOD_DETERMINE' sy-subrc.
ENDIF.
* 月末日の取得
CALL FUNCTION 'LAST_DAY_IN_PERIOD_GET'
EXPORTING
i_gjahr        = w_nendo
i_periv        = t001-periv
i_poper        = w_z_kikan
IMPORTING
e_date         = w_date_t
EXCEPTIONS
input_false    = 1
t009_notfound  = 2
t009b_notfound = 3
OTHERS         = 4.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'LAST_DAY_IN_PERIOD_GET' sy-subrc.
ENDIF.
* Add 2004/07/13 --->
PERFORM getsumatsuset USING w_date_t .
* Add 2004/07/13 <---
* Mod ES-UP 2012/08/21 -->
*  MOVE w_date_t TO tvarv-high.
*  UPDATE tvarv.
MOVE w_date_t TO tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDSYMDH'.
ENDIF.
* 受注残出力対象年月日の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YSDJYMD'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDJYMD'.
ENDIF.
MOVE: w_date(4) TO w_nen,
w_date+4(2) TO w_tuki.
IF w_date+4(2) <= 06.
w_nen = w_nen - 1.
w_tuki = w_tuki + 6.
ELSE.
w_tuki = w_tuki - 6.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE: w_nen TO tvarv-low(4),
*        w_tuki TO tvarv-low+4(2),
*        '01' TO tvarv-low+6(2),
*        '99991231' TO tvarv-high.
*  UPDATE tvarv.
MOVE: w_nen      TO tvarvc-low(4),
w_tuki     TO tvarvc-low+4(2),
'01'       TO tvarvc-low+6(2),
'99991231' TO tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDJYMD'.
ENDIF.
ENDFORM.                    " GETUJI
*&---------------------------------------------------------------------*
*&      Form  YK_EDIT
*&---------------------------------------------------------------------*
*  YK02,YK03,Yk04 の更新
*----------------------------------------------------------------------*
FORM yk_edit.

* 初期値
IF p_param = space.
w_p_datum = sy-datum.
ELSE.
w_p_datum = p_date.
ENDIF.
**
w_p_name = 'YK01'.
w_p_mandt = sy-mandt.
w_p_name01 = 'YK02'.
w_p_name02 = 'YK03'.
w_p_name03 = 'YK04'.
CONCATENATE w_p_name '_' w_p_mandt '_%' INTO w_name.
w_low = w_p_datum.
SELECT        *
* Mod ES-UP 2012/08/24 -->
*         FROM   tvarv
FROM   tvarvc
* Mod ES-UP 2012/08/24 <--
INTO   TABLE i_tvarv_s
WHERE  name  LIKE w_name
AND    low   =    w_low.
* 更新データ作成
i_tvarv_u-type = 'P'.
i_tvarv_u-numb = '0000'.
i_tvarv_u-sign = 'I'.
i_tvarv_u-opti = 'EQ'.
i_tvarv_u-high = ''.
LOOP AT i_tvarv_s.
CASE i_tvarv_s-name+18(2).
WHEN '01'.
i_tvarv_u-name = w_p_name01.
i_tvarv_u-low = i_tvarv_s-name+9(8).
APPEND i_tvarv_u.
WHEN '02'.
i_tvarv_u-name = w_p_name02.
i_tvarv_u-low = i_tvarv_s-name+9(8).
APPEND i_tvarv_u.
WHEN '03'.
i_tvarv_u-name = w_p_name03.
i_tvarv_u-low = i_tvarv_s-name+9(8).
APPEND i_tvarv_u.
ENDCASE.
ENDLOOP.
* 更新
PERFORM f_update.

ENDFORM.                    " YK_EDIT
*&---------------------------------------------------------------------*
*&      Form  f_update
*&---------------------------------------------------------------------*
*       ADD 2002/08/01
*----------------------------------------------------------------------*
FORM f_update.
* ローカル変数
DATA w_updcnt LIKE sy-dbcnt.
DATA w_errcnt LIKE sy-dbcnt.
CLEAR: w_updcnt, w_errcnt.
* データ登録
LOOP AT i_tvarv_u.
*   ロック
* Mod ES-UP 2012/08/24 -->
*   CALL FUNCTION 'ENQUEUE_ESVARV'
*         EXPORTING
*              name           = i_tvarv_u-name
*              type           = i_tvarv_u-type
*              numb           = i_tvarv_u-numb
*         EXCEPTIONS
*              foreign_lock   = 1
*              system_failure = 2
*              OTHERS         = 3.
CALL FUNCTION 'ENQUEUE_ESVARVC'
EXPORTING
*       MODE_TVARVC          = 'E'
*       MANDT                = SY-MANDT
NAME                 = i_tvarv_u-name
TYPE                 = i_tvarv_u-type
NUMB                 = i_tvarv_u-numb
*       X_NAME               = ' '
*       X_TYPE               = ' '
*       X_NUMB               = ' '
*       _SCOPE               = '2'
*       _WAIT                = ' '
*       _COLLECT             = ' '
EXCEPTIONS
FOREIGN_LOCK         = 1
SYSTEM_FAILURE       = 2
OTHERS               = 3.
* Mod ES-UP 2012/08/24 <--
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
ENDIF.
*   登録
* Mod ES-UP 2012/08/24 -->
*    UPDATE tvarv FROM i_tvarv_u.
UPDATE tvarvc FROM i_tvarv_u.
* Mod ES-UP 2012/08/24 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDJYMD'.
ENDIF.
*   アンロック
* Mod ES-UP 2012/08/24 -->
*    CALL FUNCTION 'DEQUEUE_ESVARV'
*         EXPORTING
*              name = i_tvarv_u-name
*              type = i_tvarv_u-type
*              numb = i_tvarv_u-numb.
CALL FUNCTION 'DEQUEUE_ESVARVC'
EXPORTING
*       MODE_TVARVC       = 'E'
*       MANDT             = SY-MANDT
NAME              = i_tvarv_u-name
TYPE              = i_tvarv_u-type
NUMB              = i_tvarv_u-numb
*       X_NAME            = ' '
*       X_TYPE            = ' '
*       X_NUMB            = ' '
*       _SCOPE            = '3'
*       _SYNCHRON         = ' '
*       _COLLECT          = ' '
EXCEPTIONS
OTHERS               = 1.
* Mod ES-UP 2012/08/24 <--
ENDLOOP.


ENDFORM.                    " f_update
* Add 2004/05/20 >>>>>
FORM set_printlistdate .
*- MOD 2004/11/25
*  ZPRINTLISTDATE1:前々月末を設定(単一指定に変更20041126)
*  ZPRINTLISTDATE2:前々月１ヶ月を設定
DATA : l_pldat TYPE d .
*--- ZPLINTLISTDATE1
* Mod ES-UP 2012/08/21 -->
** 2004/11/25 MOD>>
*  CLEAR tvarv.
** 2004/11/25 MOD<<
CLEAR tvarvc.
* Mod ES-UP 2012/08/21 <--
MOVE : sy-datum TO l_pldat ,
'01'     TO l_pldat+6(2) .
SUBTRACT : 1 FROM l_pldat  .
* 2004/11/25 MOD>>
MOVE : '01'     TO l_pldat+6(2) .
SUBTRACT : 1 FROM l_pldat  .                    "前々月末取得
* 2004/11/25 MOD<<
* Mod ES-UP 2012/08/21 -->
*  MOVE : l_pldat TO tvarv-low ,
*         'P'     TO tvarv-type ,                  "2004/11/26 MOD>>
*         'I'     TO tvarv-sign ,                  "2004/11/25 MOD>>
*         'ZPRINTLISTDATE1' TO tvarv-name .
*  UPDATE : tvarv .
MOVE : l_pldat TO tvarvc-low ,
'P'     TO tvarvc-type ,                  "2004/11/26 MOD>>
'I'     TO tvarvc-sign ,                  "2004/11/25 MOD>>
'ZPRINTLISTDATE1' TO tvarvc-name .
UPDATE : tvarvc .
* Mod ES-UP 2012/08/21 <--
*--- ZPLINTLISTDATE2
* 2004/11/25 MOD>>
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'ZPRINTLISTDATE2'
AND type = 'S'
AND numb =  0000 .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'ZPRINTLISTDATE2'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE : l_pldat TO tvarv-high .                  "前々月末日セット
MOVE : l_pldat TO tvarvc-high .                  "前々月末日セット
* Mod ES-UP 2012/08/21 <--
* 2004/11/25 MOD<<

MOVE : '01'     TO l_pldat+6(2) .

*  subtract : 1 from l_pldat  .                   "2004/11/25 del.
* Mod ES-UP 2012/08/21 -->
*  MOVE : l_pldat TO tvarv-low ,
*         'S'     TO tvarv-type ,
*         'I'     TO tvarv-sign ,                  "2004/11/25 MOD>>
*         'BT'    TO tvarv-opti ,                  "2004/11/25 MOD<<
*         'ZPRINTLISTDATE2' TO tvarv-name .
*  UPDATE : tvarv .
MOVE : l_pldat TO tvarvc-low ,
'S'     TO tvarvc-type ,
'I'     TO tvarvc-sign ,                  "2004/11/25 MOD>>
'BT'    TO tvarvc-opti ,                  "2004/11/25 MOD<<
'ZPRINTLISTDATE2' TO tvarvc-name .
UPDATE : tvarvc .
* Mod ES-UP 2012/08/21 <--
ENDFORM .

* Add 2004/05/20 <<<<<


FORM getsumatsuset USING f_date .
* Mod ES-UP 2012/08/24 -->
*  DATA : l_tvarv TYPE TABLE OF tvarv WITH HEADER LINE .
DATA : l_tvarv TYPE TABLE OF tvarvc WITH HEADER LINE .
* Mod ES-UP 2012/08/24 <--
MOVE : f_date        TO l_tvarv-low ,
'P'           TO l_tvarv-type ,
'I'           TO l_tvarv-sign ,
'ZGETSUMATSU' TO l_tvarv-name .
APPEND : l_tvarv .
* Mod ES-UP 2012/08/24 -->
*  UPDATE tvarv FROM TABLE l_tvarv .
UPDATE tvarvc FROM TABLE l_tvarv .
* Mod ES-UP 2012/08/24 <--
ENDFORM .
*&---------------------------------------------------------------------*
*&      Form  set_archive_bari
*&---------------------------------------------------------------------*
* 1.Z_ZENDATE : from(20020801)固定 to(一年前の前月末)
* 2.Z_ZENEBAN : from(スペース) to(一年前前月末の最終購買依頼伝票番号)
* 3.Z_ZENLAST : from(20020801)固定 to(前月末)
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_archive_bari.

DATA  : lw_zendate TYPE sy-datum,           "前年の前月末
lw_nen(4)  TYPE n,
lw_banfn   TYPE eban-banfn.         "購買依頼番号
CLEAR : lw_zendate,lw_nen.

* 1.の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZENDATE'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZENDATE'.
ENDIF.
* 前年の前月末
lw_zendate      = sy-datum.             "ｼｽﾃﾑ日付
lw_zendate+6(2) = '01'.                                   "今月1日
* Del 2008.03.06 --->
*  LW_ZENDATE      = LW_ZENDATE - 1.       "前月末
* Del 2008.03.06 <---
lw_nen          = lw_zendate+0(4).
lw_nen          = lw_nen - 1.           "前年
CONCATENATE lw_nen
lw_zendate+4(4)
INTO lw_zendate.                 "一年前の当月1日
* Add 2008.03.06 --->
lw_zendate      = lw_zendate - 1.       "一年前の前月末
* Add 2008.03.06 <---
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '20020801'.
*  tvarv-high = lw_zendate.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '20020801'.
tvarvc-high = lw_zendate.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
* 2.の更新
* Mod ES-UP 2012/08/21 -->
*  CLEAR tvarv.
*  SELECT SINGLE * FROM tvarv
CLEAR tvarvc.
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZENEBAN'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZENEBAN'.
ENDIF.
* 一年前の前月末の最終購買依頼番号を抽出
SELECT SINGLE MAX( banfn )
INTO lw_banfn
FROM eban
WHERE badat = lw_zendate.
IF lw_banfn IS INITIAL.
SELECT SINGLE MAX( banfn )
INTO lw_banfn
FROM eban
WHERE badat =< lw_zendate.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = space.
*  tvarv-high = lw_banfn.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = space.
tvarvc-high = lw_banfn.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
* 3.の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZENLAST'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZENLAST'.
ENDIF.

* 前年の前月末
CLEAR lw_zendate.
lw_zendate      = sy-datum.             "ｼｽﾃﾑ日付
lw_zendate+6(2) = '01'.                                   "今月1日
lw_zendate      = lw_zendate - 1.       "前月末
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '20020801'.
*  tvarv-high = lw_zendate.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '20020801'.
tvarvc-high = lw_zendate.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
ENDFORM.                    " set_archive_bari

*&---------------------------------------------------------------------*
*&      Form  set_dal_date_bari
*&---------------------------------------------------------------------*
* 検収データ削除期間指定用バリアントの更新
* 1.Z_DEL_KIKAN：期間(システム日付7ヶ月前１日〜末日)
* 2.Z_DEL_DATE ：〆日(システム日付7ヶ月前末日)
*----------------------------------------------------------------------*
FORM set_dal_date_bari USING value(pw_date)  TYPE sy-datum.

DATA: lw_date_low     TYPE sy-datum.
DATA: lw_date_high    TYPE sy-datum.
DATA: lw_month(02)    TYPE n.

* 削除期間の更新
* バリアント変数存在確認
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_DEL_KIKAN'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DEL_KIKAN'.
ENDIF.

* 終了日付の設定
lw_date_high = pw_date.
IF lw_date_high+4(02) => 7.
lw_date_high+6(02) = '01'.
lw_date_high+4(02) = lw_date_high+4(02) - 6.
lw_date_high       = lw_date_high - 1.
ELSE.
lw_month = lw_date_high+4(02) + 12.
lw_month = lw_month - 6.
lw_date_high+6(02) = '01'.
lw_date_high+4(02) = lw_month.
lw_date_high(04)   = lw_date_high(04) - 1.
lw_date_high = lw_date_high - 1.
ENDIF.

* 開始日付の設定
lw_date_low = lw_date_high.
lw_date_low+6(02) = '01'.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = lw_date_low.
*  tvarv-high = lw_date_high.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = lw_date_low.
tvarvc-high = lw_date_high.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
* 削除日付の更新
* バリアント変数存在確認
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_DEL_DATE'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DEL_DATE'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'EQ'.
*  tvarv-low  = lw_date_high.
*  tvarv-high = space.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'EQ'.
tvarvc-low  = lw_date_high.
tvarvc-high = space.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
ENDFORM.                    " set_dal_date_bari
*&---------------------------------------------------------------------*
*&      Form  SET_ARCHIVE_VARI_FOR_FICO
*&---------------------------------------------------------------------*
*       FI-COアーカイブバリアント変数設定のため
*----------------------------------------------------------------------*
FORM set_archive_vari_for_fico.

* ローカル変数宣言
DATA: lw_nendo(4) TYPE n,
lw_kikan(3) TYPE n,
lw_num(3)   TYPE n.

* システム日付での会計年度と会計期間を取得
CALL FUNCTION 'FI_PERIOD_DETERMINE'
EXPORTING
i_budat        = sy-datum
i_bukrs        = p_bukrs
IMPORTING
e_gjahr        = lw_nendo
e_poper        = lw_kikan
EXCEPTIONS
fiscal_year    = 1
period         = 2
period_version = 3
posting_period = 4
special_period = 5
version        = 6
posting_date   = 7
OTHERS         = 8.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'FI_PERIOD_DETERMINE' sy-subrc.
ENDIF.

* Z_BEFORE_3NEN
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_BEFORE_3NEN'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_3NEN'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '2000'.
*  tvarv-high = lw_nendo - 3.
*  CONDENSE tvarv-high.
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '2000'.
tvarvc-high = lw_nendo - 3.
CONDENSE tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_3NEN'.
ENDIF.

* Z_BEFORE_4NEN
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_BEFORE_4NEN'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_4NEN'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '2000'.
*  tvarv-high = lw_nendo - 4.
*  CONDENSE tvarv-high.
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '2000'.
tvarvc-high = lw_nendo - 4.
CONDENSE tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_4NEN'.
ENDIF.

* Z_ZEN_KIKAN
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZEN_KIKAN'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZEN_KIKAN'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '001'.
*  IF lw_kikan = 1.
*    tvarv-high = '016'.
*  ELSE.
*    lw_num = lw_kikan - 1.
*    tvarv-high = lw_num.
*    CONDENSE tvarv-high.
*  ENDIF.
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '001'.
IF lw_kikan = 1.
tvarvc-high = '016'.
ELSE.
lw_num = lw_kikan - 1.
tvarvc-high = lw_num.
CONDENSE tvarvc-high.
ENDIF.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZEN_KIKAN'.
ENDIF.

ENDFORM.                    " SET_ARCHIVE_VARI_FOR_FICO
*&---------------------------------------------------------------------*
*&      Form  set_current_year_for_range
*&---------------------------------------------------------------------*
*       処理日付の年(範囲)
*----------------------------------------------------------------------*
FORM set_current_year_for_range.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_YEAR_RANGE'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_YEAR_RANGE'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'EQ'.
*  tvarv-low = w_date+0(4).
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'EQ'.
tvarvc-low = w_date+0(4).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_YEAR_RANGE'.
ENDIF.

ENDFORM.                    " set_current_year_for_range
*&---------------------------------------------------------------------*
*&      Form  set_current_month_for_range
*&---------------------------------------------------------------------*
*       処理日付の月(範囲)
*----------------------------------------------------------------------*
FORM set_current_month_for_range.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_MONTH_RANGE'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_MONTH_RANGE'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'EQ'.
*  tvarv-low = w_date+4(2).
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'EQ'.
tvarvc-low = w_date+4(2).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_MONTH_RANGE'.
ENDIF.

ENDFORM.                    " set_current_month_for_range
*Text symbol text・

*Selection text・
*P_BUKRS:        Company code
*P_DATE:        Date (test)
*P_FCAL:        Work day calendar
*P_FCAL2:        Work day calendar 2
*P_PARAM:        Using the parameter date
*P_TIME:        The moment (test)
************************************************************************
*             Z_Z_KIKAN:会計期間
*             Z_NEN1:年度
* 追加:2011/07/22 バリアント変数の追加 SOLFIS
*                 Z_KIKAN2
*&     2012/08/21 ISID ES-UP
* 追加:2013/06/11 バリアント変数の追加 GSL
*                 Z_KIKAN3
*                 Z_NEN3
************************************************************************
REPORT yb020600_test MESSAGE-ID y1.

tables: tvarvc,
t001.

DATA: w_nendo(4) TYPE n,
w_z_kikan(3) TYPE n,
w_nen(4) TYPE n,
w_tuki(2) TYPE n,
w_date LIKE sy-datum,
w_lmdate LIKE sy-datum,
w_lmnen(4) TYPE n,
w_nen1(4) TYPE n,
w_time LIKE sy-uzeit,
w_date_t LIKE sy-datum,
w_datum LIKE sy-datum,
w_datum2 LIKE tvarv-low,
w_ndate LIKE sy-datum,
z_kikan(3) TYPE n,
z_kikan2(3) TYPE n,
z_kikan3(3) TYPE n,
z_nen1(4) TYPE n,
z_nen2(4) TYPE n,
z_nen3(4) TYPE n,
z_tsuki(2) TYPE n,
w_fdate LIKE sy-datum,
mesline(200) TYPE c .
* グローバル変数
DATA w_low LIKE tvarv-low.
DATA w_name LIKE tvarv-name.
DATA i_tvarv_s LIKE STANDARD TABLE OF tvarvc WITH HEADER LINE.
DATA i_tvarv_u LIKE STANDARD TABLE OF tvarvc WITH HEADER LINE.
DATA w_p_datum LIKE sy-datum.
DATA w_p_name(4) TYPE c.
DATA w_p_mandt LIKE sy-mandt.
DATA w_p_name01 LIKE tvarv-name.
DATA w_p_name02 LIKE tvarv-name.
DATA w_p_name03 LIKE tvarv-name.

PARAMETERS: p_bukrs LIKE t001-bukrs OBLIGATORY,
p_fcal(2) TYPE c,
p_fcal2(2) TYPE c,
p_date LIKE sy-datum,
p_time LIKE sy-uzeit,
p_param AS CHECKBOX.

PARAMETERS:p_times(2) TYPE n.

AT SELECTION-SCREEN.
* 会社情報の取得
SELECT SINGLE * FROM  t001
WHERE  bukrs       = p_bukrs        .
IF sy-subrc <> 0.
MESSAGE e308 WITH '会社コード' p_bukrs.
ENDIF.
*
START-OF-SELECTION.
DO p_times TIMES.
CALL FUNCTION 'RZL_SLEEP'
EXPORTING
seconds        = 1
EXCEPTIONS
argument_error = 1
OTHERS         = 2.
IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

ENDDO.
* 日次処理年月日の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDSYMD'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYMD'.
ENDIF.
** システム日時の取得
IF p_param = space.
MOVE: sy-datum TO w_date,
sy-uzeit TO w_time.
ELSE.
MOVE: p_date TO w_date,
p_time TO w_time.
ENDIF.
** 時刻による判定
IF w_time >= '000000' AND
w_time <= '070000'.
w_date = w_date - 1.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_date TO tvarv-low.
*  UPDATE tvarv.
MOVE w_date TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYMD'.
ENDIF.
***2002.04.16 ADD >>>
CLEAR:z_nen1.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_NEN1'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN1'.
ENDIF.
*
CALL FUNCTION 'DATE_TO_PERIOD_CONVERT'
EXPORTING
i_date               = w_date
*   I_MONMIT             = 00
i_periv              = 'V3'
IMPORTING
*   E_BUPER              =
e_gjahr              = w_nen1
EXCEPTIONS
input_false          = 1
t009_notfound        = 2
t009b_notfound       = 3
OTHERS               = 4
.
IF sy-subrc <> 0.
* MESSAGE ID SY-MSGID TYPE SY-MSGTY NUMBER SY-MSGNO
*         WITH SY-MSGV1 SY-MSGV2 SY-MSGV3 SY-MSGV4.
ENDIF.

*  MOVE w_date TO tvarv-low.
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = w_nen1.
*  UPDATE tvarv.
tvarvc-low = w_nen1.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN1'.
ENDIF.
*
* SY-DATUM+1 稼働日判断なし
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM'.
ENDIF.
w_ndate = w_date + 1.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_ndate TO tvarv-low.
*  UPDATE tvarv.
MOVE w_ndate TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM'.
ENDIF.

****会計期間
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_KIKAN'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN'.
ENDIF.

*
IF     w_ndate+4(2) = '05'.
z_kikan = '002'.
ELSEIF w_ndate+4(2) = '06'.
z_kikan = '003'.
ELSEIF w_ndate+4(2) = '07'.
z_kikan = '004'.
ELSEIF w_ndate+4(2) = '08'.
z_kikan = '005'.
ELSEIF w_ndate+4(2) = '09'.
z_kikan = '006'.
ELSEIF w_ndate+4(2) = '10'.
z_kikan = '007'.
ELSEIF w_ndate+4(2) = '11'.
z_kikan = '008'.
ELSEIF w_ndate+4(2) = '12'.
z_kikan = '009'.
ELSEIF w_ndate+4(2) = '01'.
z_kikan = '010'.
ELSEIF w_ndate+4(2) = '02'.
z_kikan = '011'.
ELSEIF w_ndate+4(2) = '03'.
z_kikan = '012'.
ELSEIF w_ndate+4(2) = '04'.
z_kikan = '001'.
ENDIF.
*
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = z_kikan.
*  UPDATE tvarv.
tvarvc-low = z_kikan.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN'.
ENDIF.

***2002.04.16 ADD <<<

* ADD 2011/07/21 >>> バリアント変数を追加
* 会計期間２
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_KIKAN2'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN2'.
ENDIF.

*
IF     w_date+4(2) = '05'.
z_kikan2 = '002'.
ELSEIF w_date+4(2) = '06'.
z_kikan2 = '003'.
ELSEIF w_date+4(2) = '07'.
z_kikan2 = '004'.
ELSEIF w_date+4(2) = '08'.
z_kikan2 = '005'.
ELSEIF w_date+4(2) = '09'.
z_kikan2 = '006'.
ELSEIF w_date+4(2) = '10'.
z_kikan2 = '007'.
ELSEIF w_date+4(2) = '11'.
z_kikan2 = '008'.
ELSEIF w_date+4(2) = '12'.
z_kikan2 = '009'.
ELSEIF w_date+4(2) = '01'.
z_kikan2 = '010'.
ELSEIF w_date+4(2) = '02'.
z_kikan2 = '011'.
ELSEIF w_date+4(2) = '03'.
z_kikan2 = '012'.
ELSEIF w_date+4(2) = '04'.
z_kikan2 = '001'.
ENDIF.
*
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = z_kikan2.
*  UPDATE tvarv.
tvarvc-low = z_kikan2.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN2'.
ENDIF.
* ADD 2011/07/21 <<< バリアント変数を追加

* ADD 2013/06/11 >>> バリアント変数を追加
* 当日の前期の会計年度・会計期間を取得する
* 会計期間３
SELECT SINGLE * FROM  tvarvc
WHERE  name        = 'Z_KIKAN3'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN3'.
ENDIF.
*前月を取得
CALL FUNCTION 'BKK_ADD_MONTH_TO_DATE'
EXPORTING
MONTHS        = -1
OLDDATE       = w_date
IMPORTING
NEWDATE       = w_lmdate
.
*
IF     w_lmdate+4(2) = '05'.
z_kikan3 = '002'.
ELSEIF w_lmdate+4(2) = '06'.
z_kikan3 = '003'.
ELSEIF w_lmdate+4(2) = '07'.
z_kikan3 = '004'.
ELSEIF w_lmdate+4(2) = '08'.
z_kikan3 = '005'.
ELSEIF w_lmdate+4(2) = '09'.
z_kikan3 = '006'.
ELSEIF w_lmdate+4(2) = '10'.
z_kikan3 = '007'.
ELSEIF w_lmdate+4(2) = '11'.
z_kikan3 = '008'.
ELSEIF w_lmdate+4(2) = '12'.
z_kikan3 = '009'.
ELSEIF w_lmdate+4(2) = '01'.
z_kikan3 = '010'.
ELSEIF w_lmdate+4(2) = '02'.
z_kikan3 = '011'.
ELSEIF w_lmdate+4(2) = '03'.
z_kikan3 = '012'.
ELSEIF w_lmdate+4(2) = '04'.
z_kikan3 = '001'.
ENDIF.

tvarvc-low = z_kikan3.
UPDATE tvarvc.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_KIKAN3'.
ENDIF.

* 会計年度３
* 前期の会計年度を設定する
SELECT SINGLE * FROM  tvarvc
WHERE  name        = 'Z_NEN3'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN3'.
ENDIF.

CALL FUNCTION 'FI_PERIOD_DETERMINE'
EXPORTING
i_budat        = w_lmdate
i_bukrs        = p_bukrs
IMPORTING
e_gjahr        = z_nen3
EXCEPTIONS
fiscal_year    = 1
period         = 2
period_version = 3
posting_period = 4
special_period = 5
version        = 6
posting_date   = 7
OTHERS         = 8.

tvarvc-low = z_nen3.
UPDATE tvarvc.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN3'.
ENDIF.


* ADD 2013/06/11 <<< バリアント変数を追加

***2002.07.24 ADD >>>
* SY-DATUM+1 稼働日判断なし
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_NEN2'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN2'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = w_date+0(4).
*  UPDATE tvarv.
tvarvc-low = w_date+0(4).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_NEN2'.
ENDIF.
***
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_TSUKI'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_TSUKI'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-low = w_date+4(2).
*  UPDATE tvarv.
tvarvc-low = w_date+4(2).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_TSUKI'.
ENDIF.

***2002.07.24 ADD<<<

* ADD 2011/03/23 >>> バリアント変数を追加
* 処理年(範囲)
PERFORM set_current_year_for_range.
* 処理月(範囲)
PERFORM set_current_month_for_range.
* ADD 2011/03/23 <<<

***2002.04.12 ADD >>>
*
CLEAR:w_datum.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM2'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM2'.
ENDIF.
CLEAR:w_datum2.
* Mod ES-UP 2012/09/03 -->
*  SELECT SINGLE low INTO w_datum2 FROM  tvarv
SELECT SINGLE low INTO w_datum2 FROM  tvarvc
* Mod ES-UP 2012/09/03 <--
WHERE  name        = 'Z_DATUM'
AND    type        = 'P'
AND    numb        = 0000           .
IF w_datum2 >= sy-datum.
w_datum = w_date.    "YPDSYMDをわたす"
ELSEIF w_datum2 < sy-datum.
w_datum = w_datum2.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_datum TO tvarv-low.
*  MOVE w_date TO tvarv-high.   "YPDSYMDをわたす"
****2002.07.24 >>>
*  MOVE 'BT' TO tvarv-opti.
****2002.07.24 <<<
*  UPDATE tvarv.
MOVE w_datum TO tvarvc-low.
MOVE w_date TO tvarvc-high.   "YPDSYMDをわたす"
MOVE 'BT' TO tvarvc-opti.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM2'.
ENDIF.
*
CLEAR:w_datum.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM3'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM3'.
ENDIF.
CLEAR:w_datum2.
* Mod ES-UP 2012/09/03 -->
*  SELECT SINGLE low INTO w_datum2 FROM  tvarv
SELECT SINGLE low INTO w_datum2 FROM  tvarvc
* Mod ES-UP 2012/09/03 <--
WHERE  name        = 'Z_DATUM'
AND    type        = 'P'
AND    numb        = 0000           .
IF w_datum2 >= sy-datum.
w_datum = w_date.    "YPDSYMDをわたす"
ELSEIF w_datum2 < sy-datum.
w_datum = w_datum2.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_datum TO tvarv-low.
*  UPDATE tvarv.
MOVE w_datum TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM3'.
ENDIF.
*
***2002.08.02 add >>>
CLEAR:w_datum.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'Z_DATUM4'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM4'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_ndate TO tvarv-low.
****2002.07.24 >>>
*  MOVE 'EQ' TO tvarv-opti.
****2002.07.24 <<<
*  UPDATE tvarv.
MOVE w_ndate TO tvarvc-low.
MOVE 'EQ' TO tvarvc-opti.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DATUM4'.
ENDIF.
***2002.08.02 add <<<
***2002.04.12 add <<<
* ＭＲＰ処理年月日の更新
CLEAR:w_ndate.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDMRP'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDMRP'.
ENDIF.
w_ndate = w_date + 1.
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
correct_option               = '+'
date                         = w_ndate
factory_calendar_id          = p_fcal
IMPORTING
date                         = w_fdate
*         FACTORYDATE                  =
*         WORKINGDAY_INDICATOR         =
EXCEPTIONS
calendar_buffer_not_loadable = 1
correct_option_invalid       = 2
date_after_range             = 3
date_before_range            = 4
date_invalid                 = 5
factory_calendar_not_found   = 6
OTHERS                       = 7.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'DATE_CONVERT_TO_FACTORYDATE' sy-subrc.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_fdate TO tvarv-low.
*  UPDATE tvarv.
MOVE w_fdate TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDMRP'.
ENDIF.
* YPDGESHO 前稼働日による更新 2001.09.27
DATA: w_date_pre LIKE w_date.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDGESHO'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDGESHO'.
ENDIF.
CALL FUNCTION 'DATE_CONVERT_TO_FACTORYDATE'
EXPORTING
factory_calendar_id          = p_fcal2
correct_option               = '-'
date                         = w_date
IMPORTING
date                         = w_date_pre
*         FACTORYDATE                  =
*         WORKINGDAY_INDICATOR         =
EXCEPTIONS
calendar_buffer_not_loadable = 1
correct_option_invalid       = 2
date_after_range             = 3
date_before_range            = 4
date_invalid                 = 5
factory_calendar_not_found   = 6
OTHERS                       = 7.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'DATE_CONVERT_TO_FACTORYDATE' sy-subrc.
ELSE.
* Mod ES-UP 2012/08/21 -->
*    MOVE w_date_pre TO tvarv-low.
*    UPDATE tvarv.
MOVE w_date_pre TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDGESHO'.
ENDIF.
ENDIF.
*>>>>>月次のみLIS関連日付更新 20011105
IF w_date_pre = w_date.
PERFORM getuji.
ENDIF.
*<<<<<月次のみLIS関連日付更新 20011105
*2002/08/01 ADD START
PERFORM yk_edit. "YK02,YK03,Yk04 の更新
*2002/08/01 ADD END
MESSAGE i402 WITH '更新を終了しました'.

*2002/08/23 Add Start
COMMIT WORK .
* Mod ES-UP 2012/08/21 -->
*  SELECT * FROM tvarv .
SELECT * FROM tvarvc .
* Mod ES-UP 2012/08/21 <--
* Mod ES-UP 2012/08/21 -->
*    CONCATENATE tvarv-type
*                tvarv-numb
*                tvarv-sign
*                tvarv-opti
*                tvarv-low
*                tvarv-high
CONCATENATE tvarvc-type
tvarvc-numb
tvarvc-sign
tvarvc-opti
tvarvc-low
tvarvc-high
* Mod ES-UP 2012/08/21 <--
INTO  mesline
SEPARATED BY ' | ' .
* Mod ES-UP 2012/08/21 -->
*    MESSAGE s402 WITH tvarv-name '=' mesline .
MESSAGE s402 WITH tvarvc-name '=' mesline .
* Mod ES-UP 2012/08/21 <--
ENDSELECT .
*2002/08/23 Add End

* Add 2004/05/20 >>>
PERFORM set_printlistdate .
* Add 2004/05/20 <<<

* ADD 2004/10/26 >>>  バリアント変数を追加
PERFORM set_archive_bari.
* ADD 2004/10/26 <<<

* ADD 2005/06/10 >>>  バリアント変数を追加
PERFORM set_dal_date_bari USING sy-datum.
* ADD 2005/06/10 <<<

* ADD 2010/07/28 >>> バリアント変数を追加
PERFORM set_archive_vari_for_fico.
* ADD 2010/07/28 <<<

*&---------------------------------------------------------------------*
*&      Form  GETUJI
*&---------------------------------------------------------------------*
*       月次のみLIS関連日付更新 20011105 TAKI
*       （随時更新していた機能をフォームに集約して
*         月次のみ実行される様にした）
*----------------------------------------------------------------------*
FORM getuji.
*** 1999/01/27追加START
* 日次処理年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDSYM'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYM'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE w_date(6) TO tvarv-low.
*  UPDATE tvarv.
MOVE w_date(6) TO tvarvc-low.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDSYM'.
ENDIF.
*** 1999/01/27追加END
* 期初年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDKISHO'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKISHO'.
ENDIF.
IF w_date+4(4) >= '0401' AND
w_date+4(4) <= '0930'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '04' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'04' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSEIF w_date+4(4) >= '1001' AND
w_date+4(4) <= '1231'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '10' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'10' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSE.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen - 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '10' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'10' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  UPDATE tvarv.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKISHO'.
ENDIF.
* 期末年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDKIMATU'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKIMATU'.
ENDIF.
IF w_date+4(4) >= '0401' AND
w_date+4(4) <= '0930'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '09' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'09' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSEIF w_date+4(4) >= '1001' AND
w_date+4(4) <= '1231'.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen + 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '03' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'03' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSE.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '03' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'03' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  UPDATE tvarv.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDKIMATU'.
ENDIF.
* 前期期初年月の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YPDZKISHO'
AND    type        = 'P'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDZKISHO'.
ENDIF.
IF w_date+4(4) >= '0401' AND
w_date+4(4) <= '0930'.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen - 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '10' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'10' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSEIF w_date+4(4) >= '1001' AND
w_date+4(4) <= '1231'.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_date(4) TO tvarv-low,
*          '04' TO tvarv-low+4(2).
MOVE: w_date(4) TO tvarvc-low,
'04' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ELSE.
MOVE: w_date(4) TO w_nen.
w_nen = w_nen - 1.
* Mod ES-UP 2012/08/21 -->
*    MOVE: w_nen TO tvarv-low,
*          '04' TO tvarv-low+4(2).
MOVE: w_nen TO tvarvc-low,
'04' TO tvarvc-low+4(2).
* Mod ES-UP 2012/08/21 <--
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  UPDATE tvarv.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YPDZKISHO'.
ENDIF.
* 日次処理年月日（範囲）の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YSDSYMDH'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDSYMDH'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE: w_date(6) TO tvarv-low,
*        '01' TO tvarv-low+6(2).
MOVE: w_date(6) TO tvarvc-low,
'01' TO tvarvc-low+6(2).
* Mod ES-UP 2012/08/21 <--
CALL FUNCTION 'FI_PERIOD_DETERMINE'
EXPORTING
i_budat        = w_date
i_bukrs        = p_bukrs
IMPORTING
e_gjahr        = w_nendo
e_poper        = w_z_kikan
EXCEPTIONS
fiscal_year    = 1
period         = 2
period_version = 3
posting_period = 4
special_period = 5
version        = 6
posting_date   = 7
OTHERS         = 8.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'FI_PERIOD_DETERMINE' sy-subrc.
ENDIF.
* 月末日の取得
CALL FUNCTION 'LAST_DAY_IN_PERIOD_GET'
EXPORTING
i_gjahr        = w_nendo
i_periv        = t001-periv
i_poper        = w_z_kikan
IMPORTING
e_date         = w_date_t
EXCEPTIONS
input_false    = 1
t009_notfound  = 2
t009b_notfound = 3
OTHERS         = 4.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'LAST_DAY_IN_PERIOD_GET' sy-subrc.
ENDIF.
* Add 2004/07/13 --->
PERFORM getsumatsuset USING w_date_t .
* Add 2004/07/13 <---
* Mod ES-UP 2012/08/21 -->
*  MOVE w_date_t TO tvarv-high.
*  UPDATE tvarv.
MOVE w_date_t TO tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDSYMDH'.
ENDIF.
* 受注残出力対象年月日の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE  name        = 'YSDJYMD'
AND    type        = 'S'
AND    numb        = 0000           .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDJYMD'.
ENDIF.
MOVE: w_date(4) TO w_nen,
w_date+4(2) TO w_tuki.
IF w_date+4(2) <= 06.
w_nen = w_nen - 1.
w_tuki = w_tuki + 6.
ELSE.
w_tuki = w_tuki - 6.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE: w_nen TO tvarv-low(4),
*        w_tuki TO tvarv-low+4(2),
*        '01' TO tvarv-low+6(2),
*        '99991231' TO tvarv-high.
*  UPDATE tvarv.
MOVE: w_nen      TO tvarvc-low(4),
w_tuki     TO tvarvc-low+4(2),
'01'       TO tvarvc-low+6(2),
'99991231' TO tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDJYMD'.
ENDIF.
ENDFORM.                    " GETUJI
*&---------------------------------------------------------------------*
*&      Form  YK_EDIT
*&---------------------------------------------------------------------*
*  YK02,YK03,Yk04 の更新
*----------------------------------------------------------------------*
FORM yk_edit.

* 初期値
IF p_param = space.
w_p_datum = sy-datum.
ELSE.
w_p_datum = p_date.
ENDIF.
**
w_p_name = 'YK01'.
w_p_mandt = sy-mandt.
w_p_name01 = 'YK02'.
w_p_name02 = 'YK03'.
w_p_name03 = 'YK04'.
CONCATENATE w_p_name '_' w_p_mandt '_%' INTO w_name.
w_low = w_p_datum.
SELECT        *
* Mod ES-UP 2012/08/24 -->
*         FROM   tvarv
FROM   tvarvc
* Mod ES-UP 2012/08/24 <--
INTO   TABLE i_tvarv_s
WHERE  name  LIKE w_name
AND    low   =    w_low.
* 更新データ作成
i_tvarv_u-type = 'P'.
i_tvarv_u-numb = '0000'.
i_tvarv_u-sign = 'I'.
i_tvarv_u-opti = 'EQ'.
i_tvarv_u-high = ''.
LOOP AT i_tvarv_s.
CASE i_tvarv_s-name+18(2).
WHEN '01'.
i_tvarv_u-name = w_p_name01.
i_tvarv_u-low = i_tvarv_s-name+9(8).
APPEND i_tvarv_u.
WHEN '02'.
i_tvarv_u-name = w_p_name02.
i_tvarv_u-low = i_tvarv_s-name+9(8).
APPEND i_tvarv_u.
WHEN '03'.
i_tvarv_u-name = w_p_name03.
i_tvarv_u-low = i_tvarv_s-name+9(8).
APPEND i_tvarv_u.
ENDCASE.
ENDLOOP.
* 更新
PERFORM f_update.

ENDFORM.                    " YK_EDIT
*&---------------------------------------------------------------------*
*&      Form  f_update
*&---------------------------------------------------------------------*
*       ADD 2002/08/01
*----------------------------------------------------------------------*
FORM f_update.
* ローカル変数
DATA w_updcnt LIKE sy-dbcnt.
DATA w_errcnt LIKE sy-dbcnt.
CLEAR: w_updcnt, w_errcnt.
* データ登録
LOOP AT i_tvarv_u.
*   ロック
* Mod ES-UP 2012/08/24 -->
*   CALL FUNCTION 'ENQUEUE_ESVARV'
*         EXPORTING
*              name           = i_tvarv_u-name
*              type           = i_tvarv_u-type
*              numb           = i_tvarv_u-numb
*         EXCEPTIONS
*              foreign_lock   = 1
*              system_failure = 2
*              OTHERS         = 3.
CALL FUNCTION 'ENQUEUE_ESVARVC'
EXPORTING
*       MODE_TVARVC          = 'E'
*       MANDT                = SY-MANDT
NAME                 = i_tvarv_u-name
TYPE                 = i_tvarv_u-type
NUMB                 = i_tvarv_u-numb
*       X_NAME               = ' '
*       X_TYPE               = ' '
*       X_NUMB               = ' '
*       _SCOPE               = '2'
*       _WAIT                = ' '
*       _COLLECT             = ' '
EXCEPTIONS
FOREIGN_LOCK         = 1
SYSTEM_FAILURE       = 2
OTHERS               = 3.
* Mod ES-UP 2012/08/24 <--
IF sy-subrc <> 0.
MESSAGE ID sy-msgid TYPE sy-msgty NUMBER sy-msgno
WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
ENDIF.
*   登録
* Mod ES-UP 2012/08/24 -->
*    UPDATE tvarv FROM i_tvarv_u.
UPDATE tvarvc FROM i_tvarv_u.
* Mod ES-UP 2012/08/24 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'YSDJYMD'.
ENDIF.
*   アンロック
* Mod ES-UP 2012/08/24 -->
*    CALL FUNCTION 'DEQUEUE_ESVARV'
*         EXPORTING
*              name = i_tvarv_u-name
*              type = i_tvarv_u-type
*              numb = i_tvarv_u-numb.
CALL FUNCTION 'DEQUEUE_ESVARVC'
EXPORTING
*       MODE_TVARVC       = 'E'
*       MANDT             = SY-MANDT
NAME              = i_tvarv_u-name
TYPE              = i_tvarv_u-type
NUMB              = i_tvarv_u-numb
*       X_NAME            = ' '
*       X_TYPE            = ' '
*       X_NUMB            = ' '
*       _SCOPE            = '3'
*       _SYNCHRON         = ' '
*       _COLLECT          = ' '
EXCEPTIONS
OTHERS               = 1.
* Mod ES-UP 2012/08/24 <--
ENDLOOP.


ENDFORM.                    " f_update
* Add 2004/05/20 >>>>>
FORM set_printlistdate .
*- MOD 2004/11/25
*  ZPRINTLISTDATE1:前々月末を設定(単一指定に変更20041126)
*  ZPRINTLISTDATE2:前々月１ヶ月を設定
DATA : l_pldat TYPE d .
*--- ZPLINTLISTDATE1
* Mod ES-UP 2012/08/21 -->
** 2004/11/25 MOD>>
*  CLEAR tvarv.
** 2004/11/25 MOD<<
CLEAR tvarvc.
* Mod ES-UP 2012/08/21 <--
MOVE : sy-datum TO l_pldat ,
'01'     TO l_pldat+6(2) .
SUBTRACT : 1 FROM l_pldat  .
* 2004/11/25 MOD>>
MOVE : '01'     TO l_pldat+6(2) .
SUBTRACT : 1 FROM l_pldat  .                    "前々月末取得
* 2004/11/25 MOD<<
* Mod ES-UP 2012/08/21 -->
*  MOVE : l_pldat TO tvarv-low ,
*         'P'     TO tvarv-type ,                  "2004/11/26 MOD>>
*         'I'     TO tvarv-sign ,                  "2004/11/25 MOD>>
*         'ZPRINTLISTDATE1' TO tvarv-name .
*  UPDATE : tvarv .
MOVE : l_pldat TO tvarvc-low ,
'P'     TO tvarvc-type ,                  "2004/11/26 MOD>>
'I'     TO tvarvc-sign ,                  "2004/11/25 MOD>>
'ZPRINTLISTDATE1' TO tvarvc-name .
UPDATE : tvarvc .
* Mod ES-UP 2012/08/21 <--
*--- ZPLINTLISTDATE2
* 2004/11/25 MOD>>
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'ZPRINTLISTDATE2'
AND type = 'S'
AND numb =  0000 .
IF sy-subrc <> 0.
MESSAGE a012 WITH 'ZPRINTLISTDATE2'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  MOVE : l_pldat TO tvarv-high .                  "前々月末日セット
MOVE : l_pldat TO tvarvc-high .                  "前々月末日セット
* Mod ES-UP 2012/08/21 <--
* 2004/11/25 MOD<<

MOVE : '01'     TO l_pldat+6(2) .

*  subtract : 1 from l_pldat  .                   "2004/11/25 del.
* Mod ES-UP 2012/08/21 -->
*  MOVE : l_pldat TO tvarv-low ,
*         'S'     TO tvarv-type ,
*         'I'     TO tvarv-sign ,                  "2004/11/25 MOD>>
*         'BT'    TO tvarv-opti ,                  "2004/11/25 MOD<<
*         'ZPRINTLISTDATE2' TO tvarv-name .
*  UPDATE : tvarv .
MOVE : l_pldat TO tvarvc-low ,
'S'     TO tvarvc-type ,
'I'     TO tvarvc-sign ,                  "2004/11/25 MOD>>
'BT'    TO tvarvc-opti ,                  "2004/11/25 MOD<<
'ZPRINTLISTDATE2' TO tvarvc-name .
UPDATE : tvarvc .
* Mod ES-UP 2012/08/21 <--
ENDFORM .

* Add 2004/05/20 <<<<<


FORM getsumatsuset USING f_date .
* Mod ES-UP 2012/08/24 -->
*  DATA : l_tvarv TYPE TABLE OF tvarv WITH HEADER LINE .
DATA : l_tvarv TYPE TABLE OF tvarvc WITH HEADER LINE .
* Mod ES-UP 2012/08/24 <--
MOVE : f_date        TO l_tvarv-low ,
'P'           TO l_tvarv-type ,
'I'           TO l_tvarv-sign ,
'ZGETSUMATSU' TO l_tvarv-name .
APPEND : l_tvarv .
* Mod ES-UP 2012/08/24 -->
*  UPDATE tvarv FROM TABLE l_tvarv .
UPDATE tvarvc FROM TABLE l_tvarv .
* Mod ES-UP 2012/08/24 <--
ENDFORM .
*&---------------------------------------------------------------------*
*&      Form  set_archive_bari
*&---------------------------------------------------------------------*
* 1.Z_ZENDATE : from(20020801)固定 to(一年前の前月末)
* 2.Z_ZENEBAN : from(スペース) to(一年前前月末の最終購買依頼伝票番号)
* 3.Z_ZENLAST : from(20020801)固定 to(前月末)
*----------------------------------------------------------------------*
*  -->  p1        text
*  <--  p2        text
*----------------------------------------------------------------------*
FORM set_archive_bari.

DATA  : lw_zendate TYPE sy-datum,           "前年の前月末
lw_nen(4)  TYPE n,
lw_banfn   TYPE eban-banfn.         "購買依頼番号
CLEAR : lw_zendate,lw_nen.

* 1.の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZENDATE'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZENDATE'.
ENDIF.
* 前年の前月末
lw_zendate      = sy-datum.             "ｼｽﾃﾑ日付
lw_zendate+6(2) = '01'.                                   "今月1日
* Del 2008.03.06 --->
*  LW_ZENDATE      = LW_ZENDATE - 1.       "前月末
* Del 2008.03.06 <---
lw_nen          = lw_zendate+0(4).
lw_nen          = lw_nen - 1.           "前年
CONCATENATE lw_nen
lw_zendate+4(4)
INTO lw_zendate.                 "一年前の当月1日
* Add 2008.03.06 --->
lw_zendate      = lw_zendate - 1.       "一年前の前月末
* Add 2008.03.06 <---
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '20020801'.
*  tvarv-high = lw_zendate.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '20020801'.
tvarvc-high = lw_zendate.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
* 2.の更新
* Mod ES-UP 2012/08/21 -->
*  CLEAR tvarv.
*  SELECT SINGLE * FROM tvarv
CLEAR tvarvc.
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZENEBAN'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZENEBAN'.
ENDIF.
* 一年前の前月末の最終購買依頼番号を抽出
SELECT SINGLE MAX( banfn )
INTO lw_banfn
FROM eban
WHERE badat = lw_zendate.
IF lw_banfn IS INITIAL.
SELECT SINGLE MAX( banfn )
INTO lw_banfn
FROM eban
WHERE badat =< lw_zendate.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = space.
*  tvarv-high = lw_banfn.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = space.
tvarvc-high = lw_banfn.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
* 3.の更新
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZENLAST'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZENLAST'.
ENDIF.

* 前年の前月末
CLEAR lw_zendate.
lw_zendate      = sy-datum.             "ｼｽﾃﾑ日付
lw_zendate+6(2) = '01'.                                   "今月1日
lw_zendate      = lw_zendate - 1.       "前月末
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '20020801'.
*  tvarv-high = lw_zendate.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '20020801'.
tvarvc-high = lw_zendate.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
ENDFORM.                    " set_archive_bari

*&---------------------------------------------------------------------*
*&      Form  set_dal_date_bari
*&---------------------------------------------------------------------*
* 検収データ削除期間指定用バリアントの更新
* 1.Z_DEL_KIKAN：期間(システム日付7ヶ月前１日〜末日)
* 2.Z_DEL_DATE ：〆日(システム日付7ヶ月前末日)
*----------------------------------------------------------------------*
FORM set_dal_date_bari USING value(pw_date)  TYPE sy-datum.

DATA: lw_date_low     TYPE sy-datum.
DATA: lw_date_high    TYPE sy-datum.
DATA: lw_month(02)    TYPE n.

* 削除期間の更新
* バリアント変数存在確認
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_DEL_KIKAN'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DEL_KIKAN'.
ENDIF.

* 終了日付の設定
lw_date_high = pw_date.
IF lw_date_high+4(02) => 7.
lw_date_high+6(02) = '01'.
lw_date_high+4(02) = lw_date_high+4(02) - 6.
lw_date_high       = lw_date_high - 1.
ELSE.
lw_month = lw_date_high+4(02) + 12.
lw_month = lw_month - 6.
lw_date_high+6(02) = '01'.
lw_date_high+4(02) = lw_month.
lw_date_high(04)   = lw_date_high(04) - 1.
lw_date_high = lw_date_high - 1.
ENDIF.

* 開始日付の設定
lw_date_low = lw_date_high.
lw_date_low+6(02) = '01'.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = lw_date_low.
*  tvarv-high = lw_date_high.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = lw_date_low.
tvarvc-high = lw_date_high.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
* 削除日付の更新
* バリアント変数存在確認
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM tvarv
SELECT SINGLE * FROM tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_DEL_DATE'
AND type = 'S'
AND numb =  0000 .

IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_DEL_DATE'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'EQ'.
*  tvarv-low  = lw_date_high.
*  tvarv-high = space.
*  UPDATE :  tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'EQ'.
tvarvc-low  = lw_date_high.
tvarvc-high = space.
UPDATE :  tvarvc.
* Mod ES-UP 2012/08/21 <--
ENDFORM.                    " set_dal_date_bari
*&---------------------------------------------------------------------*
*&      Form  SET_ARCHIVE_VARI_FOR_FICO
*&---------------------------------------------------------------------*
*       FI-COアーカイブバリアント変数設定のため
*----------------------------------------------------------------------*
FORM set_archive_vari_for_fico.

* ローカル変数宣言
DATA: lw_nendo(4) TYPE n,
lw_kikan(3) TYPE n,
lw_num(3)   TYPE n.

* システム日付での会計年度と会計期間を取得
CALL FUNCTION 'FI_PERIOD_DETERMINE'
EXPORTING
i_budat        = sy-datum
i_bukrs        = p_bukrs
IMPORTING
e_gjahr        = lw_nendo
e_poper        = lw_kikan
EXCEPTIONS
fiscal_year    = 1
period         = 2
period_version = 3
posting_period = 4
special_period = 5
version        = 6
posting_date   = 7
OTHERS         = 8.
IF sy-subrc <> 0.
MESSAGE a001 WITH 'FI_PERIOD_DETERMINE' sy-subrc.
ENDIF.

* Z_BEFORE_3NEN
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_BEFORE_3NEN'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_3NEN'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '2000'.
*  tvarv-high = lw_nendo - 3.
*  CONDENSE tvarv-high.
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '2000'.
tvarvc-high = lw_nendo - 3.
CONDENSE tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_3NEN'.
ENDIF.

* Z_BEFORE_4NEN
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_BEFORE_4NEN'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_4NEN'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '2000'.
*  tvarv-high = lw_nendo - 4.
*  CONDENSE tvarv-high.
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '2000'.
tvarvc-high = lw_nendo - 4.
CONDENSE tvarvc-high.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_BEFORE_4NEN'.
ENDIF.

* Z_ZEN_KIKAN
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_ZEN_KIKAN'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZEN_KIKAN'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'BT'.
*  tvarv-low  = '001'.
*  IF lw_kikan = 1.
*    tvarv-high = '016'.
*  ELSE.
*    lw_num = lw_kikan - 1.
*    tvarv-high = lw_num.
*    CONDENSE tvarv-high.
*  ENDIF.
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'BT'.
tvarvc-low  = '001'.
IF lw_kikan = 1.
tvarvc-high = '016'.
ELSE.
lw_num = lw_kikan - 1.
tvarvc-high = lw_num.
CONDENSE tvarvc-high.
ENDIF.
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_ZEN_KIKAN'.
ENDIF.

ENDFORM.                    " SET_ARCHIVE_VARI_FOR_FICO
*&---------------------------------------------------------------------*
*&      Form  set_current_year_for_range
*&---------------------------------------------------------------------*
*       処理日付の年(範囲)
*----------------------------------------------------------------------*
FORM set_current_year_for_range.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_YEAR_RANGE'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_YEAR_RANGE'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'EQ'.
*  tvarv-low = w_date+0(4).
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'EQ'.
tvarvc-low = w_date+0(4).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_YEAR_RANGE'.
ENDIF.

ENDFORM.                    " set_current_year_for_range
*&---------------------------------------------------------------------*
*&      Form  set_current_month_for_range
*&---------------------------------------------------------------------*
*       処理日付の月(範囲)
*----------------------------------------------------------------------*
FORM set_current_month_for_range.
* Mod ES-UP 2012/08/21 -->
*  SELECT SINGLE * FROM  tvarv
SELECT SINGLE * FROM  tvarvc
* Mod ES-UP 2012/08/21 <--
WHERE name = 'Z_MONTH_RANGE'
AND type = 'S'
AND numb = 0000.
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_MONTH_RANGE'.
ENDIF.
* Mod ES-UP 2012/08/21 -->
*  tvarv-sign = 'I'.
*  tvarv-opti = 'EQ'.
*  tvarv-low = w_date+4(2).
*  UPDATE tvarv.
tvarvc-sign = 'I'.
tvarvc-opti = 'EQ'.
tvarvc-low = w_date+4(2).
UPDATE tvarvc.
* Mod ES-UP 2012/08/21 <--
IF sy-subrc <> 0.
MESSAGE a012 WITH 'Z_MONTH_RANGE'.
ENDIF.

ENDFORM.                    " set_current_month_for_range
*Text symbol text・

*Selection text・
*P_BUKRS:        Company code
*P_DATE:        Date (test)
*P_FCAL:        Work day calendar
*P_FCAL2:        Work day calendar 2
*P_PARAM:        Using the parameter date
*P_TIME:        The moment (test)
